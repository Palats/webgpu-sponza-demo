var Eb=Object.defineProperty;var Mb=(cr,ot,lr)=>ot in cr?Eb(cr,ot,{enumerable:!0,configurable:!0,writable:!0,value:lr}):cr[ot]=lr;var ce=(cr,ot,lr)=>Mb(cr,typeof ot!="symbol"?ot+"":ot,lr);(async()=>{var El;(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();function cr(t){if(!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}}function ot(t,e){var r=t.__state.conversionName.toString(),s=Math.round(t.r),n=Math.round(t.g),i=Math.round(t.b),o=t.a,a=Math.round(t.h),c=t.s.toFixed(1),m=t.v.toFixed(1);if(e||r==="THREE_CHAR_HEX"||r==="SIX_CHAR_HEX"){for(var _=t.hex.toString(16);_.length<6;)_="0"+_;return"#"+_}else{if(r==="CSS_RGB")return"rgb("+s+","+n+","+i+")";if(r==="CSS_RGBA")return"rgba("+s+","+n+","+i+","+o+")";if(r==="HEX")return"0x"+t.hex.toString(16);if(r==="RGB_ARRAY")return"["+s+","+n+","+i+"]";if(r==="RGBA_ARRAY")return"["+s+","+n+","+i+","+o+"]";if(r==="RGB_OBJ")return"{r:"+s+",g:"+n+",b:"+i+"}";if(r==="RGBA_OBJ")return"{r:"+s+",g:"+n+",b:"+i+",a:"+o+"}";if(r==="HSV_OBJ")return"{h:"+a+",s:"+c+",v:"+m+"}";if(r==="HSVA_OBJ")return"{h:"+a+",s:"+c+",v:"+m+",a:"+o+"}"}return"unknown format"}var lr=Array.prototype.forEach,ts=Array.prototype.slice,J={BREAK:{},extend:function(t){return this.each(ts.call(arguments,1),function(e){var r=this.isObject(e)?Object.keys(e):[];r.forEach((function(s){this.isUndefined(e[s])||(t[s]=e[s])}).bind(this))},this),t},defaults:function(t){return this.each(ts.call(arguments,1),function(e){var r=this.isObject(e)?Object.keys(e):[];r.forEach((function(s){this.isUndefined(t[s])&&(t[s]=e[s])}).bind(this))},this),t},compose:function(){var t=ts.call(arguments);return function(){for(var e=ts.call(arguments),r=t.length-1;r>=0;r--)e=[t[r].apply(this,e)];return e[0]}},each:function(t,e,r){if(t){if(lr&&t.forEach&&t.forEach===lr)t.forEach(e,r);else if(t.length===t.length+0){var s=void 0,n=void 0;for(s=0,n=t.length;s<n;s++)if(s in t&&e.call(r,t[s],s)===this.BREAK)return}else for(var i in t)if(e.call(r,t[i],i)===this.BREAK)return}},defer:function(t){setTimeout(t,0)},debounce:function(t,e,r){var s=void 0;return function(){var n=this,i=arguments;function o(){s=null,r||t.apply(n,i)}var a=r||!s;clearTimeout(s),s=setTimeout(o,e),a&&t.apply(n,i)}},toArray:function(t){return t.toArray?t.toArray():ts.call(t)},isUndefined:function(t){return t===void 0},isNull:function(t){return t===null},isNaN:function(t){function e(r){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){return isNaN(t)}),isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(t){return t===Object(t)},isNumber:function(t){return t===t+0},isString:function(t){return t===t+""},isBoolean:function(t){return t===!1||t===!0},isFunction:function(t){return t instanceof Function}},Ll=[{litmus:J.isString,conversions:{THREE_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return e===null?!1:{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString(),0)}},write:ot},SIX_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9]{6})$/i);return e===null?!1:{space:"HEX",hex:parseInt("0x"+e[1].toString(),0)}},write:ot},CSS_RGB:{read:function(t){var e=t.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e===null?!1:{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:ot},CSS_RGBA:{read:function(t){var e=t.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e===null?!1:{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:ot}}},{litmus:J.isNumber,conversions:{HEX:{read:function(t){return{space:"HEX",hex:t,conversionName:"HEX"}},write:function(t){return t.hex}}}},{litmus:J.isArray,conversions:{RGB_ARRAY:{read:function(t){return t.length!==3?!1:{space:"RGB",r:t[0],g:t[1],b:t[2]}},write:function(t){return[t.r,t.g,t.b]}},RGBA_ARRAY:{read:function(t){return t.length!==4?!1:{space:"RGB",r:t[0],g:t[1],b:t[2],a:t[3]}},write:function(t){return[t.r,t.g,t.b,t.a]}}}},{litmus:J.isObject,conversions:{RGBA_OBJ:{read:function(t){return J.isNumber(t.r)&&J.isNumber(t.g)&&J.isNumber(t.b)&&J.isNumber(t.a)?{space:"RGB",r:t.r,g:t.g,b:t.b,a:t.a}:!1},write:function(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}},RGB_OBJ:{read:function(t){return J.isNumber(t.r)&&J.isNumber(t.g)&&J.isNumber(t.b)?{space:"RGB",r:t.r,g:t.g,b:t.b}:!1},write:function(t){return{r:t.r,g:t.g,b:t.b}}},HSVA_OBJ:{read:function(t){return J.isNumber(t.h)&&J.isNumber(t.s)&&J.isNumber(t.v)&&J.isNumber(t.a)?{space:"HSV",h:t.h,s:t.s,v:t.v,a:t.a}:!1},write:function(t){return{h:t.h,s:t.s,v:t.v,a:t.a}}},HSV_OBJ:{read:function(t){return J.isNumber(t.h)&&J.isNumber(t.s)&&J.isNumber(t.v)?{space:"HSV",h:t.h,s:t.s,v:t.v}:!1},write:function(t){return{h:t.h,s:t.s,v:t.v}}}}}],rs=void 0,Ls=void 0,si=function(){Ls=!1;var t=arguments.length>1?J.toArray(arguments):arguments[0];return J.each(Ll,function(e){if(e.litmus(t))return J.each(e.conversions,function(r,s){if(rs=r.read(t),Ls===!1&&rs!==!1)return Ls=rs,rs.conversionName=s,rs.conversion=r,J.BREAK}),J.BREAK}),Ls},Zo=void 0,Os={hsv_to_rgb:function(t,e,r){var s=Math.floor(t/60)%6,n=t/60-Math.floor(t/60),i=r*(1-e),o=r*(1-n*e),a=r*(1-(1-n)*e),c=[[r,a,i],[o,r,i],[i,r,a],[i,o,r],[a,i,r],[r,i,o]][s];return{r:c[0]*255,g:c[1]*255,b:c[2]*255}},rgb_to_hsv:function(t,e,r){var s=Math.min(t,e,r),n=Math.max(t,e,r),i=n-s,o=void 0,a=void 0;if(n!==0)a=i/n;else return{h:NaN,s:0,v:0};return t===n?o=(e-r)/i:e===n?o=2+(r-t)/i:o=4+(t-e)/i,o/=6,o<0&&(o+=1),{h:o*360,s:a,v:n/255}},rgb_to_hex:function(t,e,r){var s=this.hex_with_component(0,2,t);return s=this.hex_with_component(s,1,e),s=this.hex_with_component(s,0,r),s},component_from_hex:function(t,e){return t>>e*8&255},hex_with_component:function(t,e,r){return r<<(Zo=e*8)|t&~(255<<Zo)}},Ol=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ct=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},Tt=function(){function t(e,r){for(var s=0;s<r.length;s++){var n=r[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,r,s){return r&&t(e.prototype,r),s&&t(e,s),e}}(),Wt=function t(e,r,s){e===null&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,r);if(n===void 0){var i=Object.getPrototypeOf(e);return i===null?void 0:t(i,r,s)}else{if("value"in n)return n.value;var o=n.get;return o===void 0?void 0:o.call(s)}},Yt=function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},$t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t},Ue=function(){function t(){if(Ct(this,t),this.__state=si.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return Tt(t,[{key:"toString",value:function(){return ot(this)}},{key:"toHexString",value:function(){return ot(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),t}();function ni(t,e,r){Object.defineProperty(t,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(Ue.recalculateRGB(this,e,r),this.__state[e])},set:function(s){this.__state.space!=="RGB"&&(Ue.recalculateRGB(this,e,r),this.__state.space="RGB"),this.__state[e]=s}})}function ii(t,e){Object.defineProperty(t,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(Ue.recalculateHSV(this),this.__state[e])},set:function(r){this.__state.space!=="HSV"&&(Ue.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=r}})}Ue.recalculateRGB=function(t,e,r){if(t.__state.space==="HEX")t.__state[e]=Os.component_from_hex(t.__state.hex,r);else if(t.__state.space==="HSV")J.extend(t.__state,Os.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v));else throw new Error("Corrupted color state")},Ue.recalculateHSV=function(t){var e=Os.rgb_to_hsv(t.r,t.g,t.b);J.extend(t.__state,{s:e.s,v:e.v}),J.isNaN(e.h)?J.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=e.h},Ue.COMPONENTS=["r","g","b","h","s","v","hex","a"],ni(Ue.prototype,"r",2),ni(Ue.prototype,"g",1),ni(Ue.prototype,"b",0),ii(Ue.prototype,"h"),ii(Ue.prototype,"s"),ii(Ue.prototype,"v"),Object.defineProperty(Ue.prototype,"a",{get:function(){return this.__state.a},set:function(t){this.__state.a=t}}),Object.defineProperty(Ue.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=Os.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(t){this.__state.space="HEX",this.__state.hex=t}});var dr=function(){function t(e,r){Ct(this,t),this.initialValue=e[r],this.domElement=document.createElement("div"),this.object=e,this.property=r,this.__onChange=void 0,this.__onFinishChange=void 0}return Tt(t,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),t}(),Dl={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},ea={};J.each(Dl,function(t,e){J.each(t,function(r){ea[r]=e})});var Il=/(\d+(\.\d+)?)px/;function Rt(t){if(t==="0"||J.isUndefined(t))return 0;var e=t.match(Il);return J.isNull(e)?0:parseFloat(e[1])}var I={makeSelectable:function(t,e){t===void 0||t.style===void 0||(t.onselectstart=e?function(){return!1}:function(){},t.style.MozUserSelect=e?"auto":"none",t.style.KhtmlUserSelect=e?"auto":"none",t.unselectable=e?"on":"off")},makeFullscreen:function(t,e,r){var s=r,n=e;J.isUndefined(n)&&(n=!0),J.isUndefined(s)&&(s=!0),t.style.position="absolute",n&&(t.style.left=0,t.style.right=0),s&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,e,r,s){var n=r||{},i=ea[e];if(!i)throw new Error("Event type "+e+" not supported.");var o=document.createEvent(i);switch(i){case"MouseEvents":{var a=n.x||n.clientX||0,c=n.y||n.clientY||0;o.initMouseEvent(e,n.bubbles||!1,n.cancelable||!0,window,n.clickCount||1,0,0,a,c,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var m=o.initKeyboardEvent||o.initKeyEvent;J.defaults(n,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),m(e,n.bubbles||!1,n.cancelable,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode);break}default:{o.initEvent(e,n.bubbles||!1,n.cancelable||!0);break}}J.defaults(o,s),t.dispatchEvent(o)},bind:function(t,e,r,s){var n=s||!1;return t.addEventListener?t.addEventListener(e,r,n):t.attachEvent&&t.attachEvent("on"+e,r),I},unbind:function(t,e,r,s){var n=s||!1;return t.removeEventListener?t.removeEventListener(e,r,n):t.detachEvent&&t.detachEvent("on"+e,r),I},addClass:function(t,e){if(t.className===void 0)t.className=e;else if(t.className!==e){var r=t.className.split(/ +/);r.indexOf(e)===-1&&(r.push(e),t.className=r.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return I},removeClass:function(t,e){if(e)if(t.className===e)t.removeAttribute("class");else{var r=t.className.split(/ +/),s=r.indexOf(e);s!==-1&&(r.splice(s,1),t.className=r.join(" "))}else t.className=void 0;return I},hasClass:function(t,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(t.className)||!1},getWidth:function(t){var e=getComputedStyle(t);return Rt(e["border-left-width"])+Rt(e["border-right-width"])+Rt(e["padding-left"])+Rt(e["padding-right"])+Rt(e.width)},getHeight:function(t){var e=getComputedStyle(t);return Rt(e["border-top-width"])+Rt(e["border-bottom-width"])+Rt(e["padding-top"])+Rt(e["padding-bottom"])+Rt(e.height)},getOffset:function(t){var e=t,r={left:0,top:0};if(e.offsetParent)do r.left+=e.offsetLeft,r.top+=e.offsetTop,e=e.offsetParent;while(e);return r},isActive:function(t){return t===document.activeElement&&(t.type||t.href)}},ta=function(t){Yt(e,t);function e(r,s){Ct(this,e);var n=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s)),i=n;n.__prev=n.getValue(),n.__checkbox=document.createElement("input"),n.__checkbox.setAttribute("type","checkbox");function o(){i.setValue(!i.__prev)}return I.bind(n.__checkbox,"change",o,!1),n.domElement.appendChild(n.__checkbox),n.updateDisplay(),n}return Tt(e,[{key:"setValue",value:function(r){var s=Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),s}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(dr),Fl=function(t){Yt(e,t);function e(r,s,n){Ct(this,e);var i=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s)),o=n,a=i;if(i.__select=document.createElement("select"),J.isArray(o)){var c={};J.each(o,function(m){c[m]=m}),o=c}return J.each(o,function(m,_){var v=document.createElement("option");v.innerHTML=_,v.setAttribute("value",m),a.__select.appendChild(v)}),i.updateDisplay(),I.bind(i.__select,"change",function(){var m=this.options[this.selectedIndex].value;a.setValue(m)}),i.domElement.appendChild(i.__select),i}return Tt(e,[{key:"setValue",value:function(r){var s=Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),s}},{key:"updateDisplay",value:function(){return I.isActive(this.__select)?this:(this.__select.value=this.getValue(),Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(dr),Ul=function(t){Yt(e,t);function e(r,s){Ct(this,e);var n=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s)),i=n;function o(){i.setValue(i.__input.value)}function a(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),I.bind(n.__input,"keyup",o),I.bind(n.__input,"change",o),I.bind(n.__input,"blur",a),I.bind(n.__input,"keydown",function(c){c.keyCode===13&&this.blur()}),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return Tt(e,[{key:"updateDisplay",value:function(){return I.isActive(this.__input)||(this.__input.value=this.getValue()),Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(dr);function ra(t){var e=t.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var sa=function(t){Yt(e,t);function e(r,s,n){Ct(this,e);var i=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s)),o=n||{};return i.__min=o.min,i.__max=o.max,i.__step=o.step,J.isUndefined(i.__step)?i.initialValue===0?i.__impliedStep=1:i.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(i.initialValue))/Math.LN10))/10:i.__impliedStep=i.__step,i.__precision=ra(i.__impliedStep),i}return Tt(e,[{key:"setValue",value:function(r){var s=r;return this.__min!==void 0&&s<this.__min?s=this.__min:this.__max!==void 0&&s>this.__max&&(s=this.__max),this.__step!==void 0&&s%this.__step!==0&&(s=Math.round(s/this.__step)*this.__step),Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,s)}},{key:"min",value:function(r){return this.__min=r,this}},{key:"max",value:function(r){return this.__max=r,this}},{key:"step",value:function(r){return this.__step=r,this.__impliedStep=r,this.__precision=ra(r),this}}]),e}(dr);function kl(t,e){var r=Math.pow(10,e);return Math.round(t*r)/r}var Ds=function(t){Yt(e,t);function e(r,s,n){Ct(this,e);var i=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s,n));i.__truncationSuspended=!1;var o=i,a=void 0;function c(){var D=parseFloat(o.__input.value);J.isNaN(D)||o.setValue(D)}function m(){o.__onFinishChange&&o.__onFinishChange.call(o,o.getValue())}function _(){m()}function v(D){var U=a-D.clientY;o.setValue(o.getValue()+U*o.__impliedStep),a=D.clientY}function P(){I.unbind(window,"mousemove",v),I.unbind(window,"mouseup",P),m()}function O(D){I.bind(window,"mousemove",v),I.bind(window,"mouseup",P),a=D.clientY}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),I.bind(i.__input,"change",c),I.bind(i.__input,"blur",_),I.bind(i.__input,"mousedown",O),I.bind(i.__input,"keydown",function(D){D.keyCode===13&&(o.__truncationSuspended=!0,this.blur(),o.__truncationSuspended=!1,m())}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return Tt(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():kl(this.getValue(),this.__precision),Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(sa);function na(t,e,r,s,n){return s+(n-s)*((t-e)/(r-e))}var oi=function(t){Yt(e,t);function e(r,s,n,i,o){Ct(this,e);var a=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s,{min:n,max:i,step:o})),c=a;a.__background=document.createElement("div"),a.__foreground=document.createElement("div"),I.bind(a.__background,"mousedown",m),I.bind(a.__background,"touchstart",P),I.addClass(a.__background,"slider"),I.addClass(a.__foreground,"slider-fg");function m(U){document.activeElement.blur(),I.bind(window,"mousemove",_),I.bind(window,"mouseup",v),_(U)}function _(U){U.preventDefault();var X=c.__background.getBoundingClientRect();return c.setValue(na(U.clientX,X.left,X.right,c.__min,c.__max)),!1}function v(){I.unbind(window,"mousemove",_),I.unbind(window,"mouseup",v),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}function P(U){U.touches.length===1&&(I.bind(window,"touchmove",O),I.bind(window,"touchend",D),O(U))}function O(U){var X=U.touches[0].clientX,Y=c.__background.getBoundingClientRect();c.setValue(na(X,Y.left,Y.right,c.__min,c.__max))}function D(){I.unbind(window,"touchmove",O),I.unbind(window,"touchend",D),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}return a.updateDisplay(),a.__background.appendChild(a.__foreground),a.domElement.appendChild(a.__background),a}return Tt(e,[{key:"updateDisplay",value:function(){var r=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=r*100+"%",Wt(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(sa),ia=function(t){Yt(e,t);function e(r,s,n){Ct(this,e);var i=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s)),o=i;return i.__button=document.createElement("div"),i.__button.innerHTML=n===void 0?"Fire":n,I.bind(i.__button,"click",function(a){return a.preventDefault(),o.fire(),!1}),I.addClass(i.__button,"button"),i.domElement.appendChild(i.__button),i}return Tt(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(dr),ai=function(t){Yt(e,t);function e(r,s){Ct(this,e);var n=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,r,s));n.__color=new Ue(n.getValue()),n.__temp=new Ue(0);var i=n;n.domElement=document.createElement("div"),I.makeSelectable(n.domElement,!1),n.__selector=document.createElement("div"),n.__selector.className="selector",n.__saturation_field=document.createElement("div"),n.__saturation_field.className="saturation-field",n.__field_knob=document.createElement("div"),n.__field_knob.className="field-knob",n.__field_knob_border="2px solid ",n.__hue_knob=document.createElement("div"),n.__hue_knob.className="hue-knob",n.__hue_field=document.createElement("div"),n.__hue_field.className="hue-field",n.__input=document.createElement("input"),n.__input.type="text",n.__input_textShadow="0 1px 1px ",I.bind(n.__input,"keydown",function(U){U.keyCode===13&&v.call(this)}),I.bind(n.__input,"blur",v),I.bind(n.__selector,"mousedown",function(){I.addClass(this,"drag").bind(window,"mouseup",function(){I.removeClass(i.__selector,"drag")})}),I.bind(n.__selector,"touchstart",function(){I.addClass(this,"drag").bind(window,"touchend",function(){I.removeClass(i.__selector,"drag")})});var o=document.createElement("div");J.extend(n.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),J.extend(n.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:n.__field_knob_border+(n.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),J.extend(n.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),J.extend(n.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),J.extend(o.style,{width:"100%",height:"100%",background:"none"}),oa(o,"top","rgba(0,0,0,0)","#000"),J.extend(n.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),Vl(n.__hue_field),J.extend(n.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:n.__input_textShadow+"rgba(0,0,0,0.7)"}),I.bind(n.__saturation_field,"mousedown",a),I.bind(n.__saturation_field,"touchstart",a),I.bind(n.__field_knob,"mousedown",a),I.bind(n.__field_knob,"touchstart",a),I.bind(n.__hue_field,"mousedown",c),I.bind(n.__hue_field,"touchstart",c);function a(U){O(U),I.bind(window,"mousemove",O),I.bind(window,"touchmove",O),I.bind(window,"mouseup",m),I.bind(window,"touchend",m)}function c(U){D(U),I.bind(window,"mousemove",D),I.bind(window,"touchmove",D),I.bind(window,"mouseup",_),I.bind(window,"touchend",_)}function m(){I.unbind(window,"mousemove",O),I.unbind(window,"touchmove",O),I.unbind(window,"mouseup",m),I.unbind(window,"touchend",m),P()}function _(){I.unbind(window,"mousemove",D),I.unbind(window,"touchmove",D),I.unbind(window,"mouseup",_),I.unbind(window,"touchend",_),P()}function v(){var U=si(this.value);U!==!1?(i.__color.__state=U,i.setValue(i.__color.toOriginal())):this.value=i.__color.toString()}function P(){i.__onFinishChange&&i.__onFinishChange.call(i,i.__color.toOriginal())}n.__saturation_field.appendChild(o),n.__selector.appendChild(n.__field_knob),n.__selector.appendChild(n.__saturation_field),n.__selector.appendChild(n.__hue_field),n.__hue_field.appendChild(n.__hue_knob),n.domElement.appendChild(n.__input),n.domElement.appendChild(n.__selector),n.updateDisplay();function O(U){U.type.indexOf("touch")===-1&&U.preventDefault();var X=i.__saturation_field.getBoundingClientRect(),Y=U.touches&&U.touches[0]||U,Q=Y.clientX,q=Y.clientY,j=(Q-X.left)/(X.right-X.left),W=1-(q-X.top)/(X.bottom-X.top);return W>1?W=1:W<0&&(W=0),j>1?j=1:j<0&&(j=0),i.__color.v=W,i.__color.s=j,i.setValue(i.__color.toOriginal()),!1}function D(U){U.type.indexOf("touch")===-1&&U.preventDefault();var X=i.__hue_field.getBoundingClientRect(),Y=U.touches&&U.touches[0]||U,Q=Y.clientY,q=1-(Q-X.top)/(X.bottom-X.top);return q>1?q=1:q<0&&(q=0),i.__color.h=q*360,i.setValue(i.__color.toOriginal()),!1}return n}return Tt(e,[{key:"updateDisplay",value:function(){var r=si(this.getValue());if(r!==!1){var s=!1;J.each(Ue.COMPONENTS,function(o){if(!J.isUndefined(r[o])&&!J.isUndefined(this.__color.__state[o])&&r[o]!==this.__color.__state[o])return s=!0,{}},this),s&&J.extend(this.__color.__state,r)}J.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var n=this.__color.v<.5||this.__color.s>.5?255:0,i=255-n;J.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+n+","+n+","+n+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,oa(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),J.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+n+","+n+","+n+")",textShadow:this.__input_textShadow+"rgba("+i+","+i+","+i+",.7)"})}}]),e}(dr),Nl=["-moz-","-o-","-webkit-","-ms-",""];function oa(t,e,r,s){t.style.background="",J.each(Nl,function(n){t.style.cssText+="background: "+n+"linear-gradient("+e+", "+r+" 0%, "+s+" 100%); "})}function Vl(t){t.style.background="",t.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",t.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var Hl={load:function(t,e){var r=e||document,s=r.createElement("link");s.type="text/css",s.rel="stylesheet",s.href=t,r.getElementsByTagName("head")[0].appendChild(s)},inject:function(t,e){var r=e||document,s=document.createElement("style");s.type="text/css",s.innerHTML=t;var n=r.getElementsByTagName("head")[0];try{n.appendChild(s)}catch{}}},jl=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,zl=function(t,e){var r=t[e];return J.isArray(arguments[2])||J.isObject(arguments[2])?new Fl(t,e,arguments[2]):J.isNumber(r)?J.isNumber(arguments[2])&&J.isNumber(arguments[3])?J.isNumber(arguments[4])?new oi(t,e,arguments[2],arguments[3],arguments[4]):new oi(t,e,arguments[2],arguments[3]):J.isNumber(arguments[4])?new Ds(t,e,{min:arguments[2],max:arguments[3],step:arguments[4]}):new Ds(t,e,{min:arguments[2],max:arguments[3]}):J.isString(r)?new Ul(t,e):J.isFunction(r)?new ia(t,e,""):J.isBoolean(r)?new ta(t,e):null};function Jl(t){setTimeout(t,1e3/60)}var Kl=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Jl,Xl=function(){function t(){Ct(this,t),this.backgroundElement=document.createElement("div"),J.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),I.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),J.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;I.bind(this.backgroundElement,"click",function(){e.hide()})}return Tt(t,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),J.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var e=this,r=function s(){e.domElement.style.display="none",e.backgroundElement.style.display="none",I.unbind(e.domElement,"webkitTransitionEnd",s),I.unbind(e.domElement,"transitionend",s),I.unbind(e.domElement,"oTransitionEnd",s)};I.bind(this.domElement,"webkitTransitionEnd",r),I.bind(this.domElement,"transitionend",r),I.bind(this.domElement,"oTransitionEnd",r),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-I.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-I.getHeight(this.domElement)/2+"px"}}]),t}(),Wl=cr(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);Hl.inject(Wl);var aa="dg",ua=72,ca=20,ss="Default",ns=function(){try{return!!window.localStorage}catch{return!1}}(),is=void 0,la=!0,Gr=void 0,ui=!1,da=[],Se=function t(e){var r=this,s=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),I.addClass(this.domElement,aa),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],s=J.defaults(s,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),s=J.defaults(s,{resizable:s.autoPlace,hideable:s.autoPlace}),J.isUndefined(s.load)?s.load={preset:ss}:s.preset&&(s.load.preset=s.preset),J.isUndefined(s.parent)&&s.hideable&&da.push(this),s.resizable=J.isUndefined(s.parent)&&s.resizable,s.autoPlace&&J.isUndefined(s.scrollable)&&(s.scrollable=!0);var n=ns&&localStorage.getItem(Lr(this,"isLocal"))==="true",i=void 0,o=void 0;if(Object.defineProperties(this,{parent:{get:function(){return s.parent}},scrollable:{get:function(){return s.scrollable}},autoPlace:{get:function(){return s.autoPlace}},closeOnTop:{get:function(){return s.closeOnTop}},preset:{get:function(){return r.parent?r.getRoot().preset:s.load.preset},set:function(v){r.parent?r.getRoot().preset=v:s.load.preset=v,ql(this),r.revert()}},width:{get:function(){return s.width},set:function(v){s.width=v,hi(r,v)}},name:{get:function(){return s.name},set:function(v){s.name=v,o&&(o.innerHTML=s.name)}},closed:{get:function(){return s.closed},set:function(v){s.closed=v,s.closed?I.addClass(r.__ul,t.CLASS_CLOSED):I.removeClass(r.__ul,t.CLASS_CLOSED),this.onResize(),r.__closeButton&&(r.__closeButton.innerHTML=v?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return s.load}},useLocalStorage:{get:function(){return n},set:function(v){ns&&(n=v,v?I.bind(window,"unload",i):I.unbind(window,"unload",i),localStorage.setItem(Lr(r,"isLocal"),v))}}}),J.isUndefined(s.parent)){if(this.closed=s.closed||!1,I.addClass(this.domElement,t.CLASS_MAIN),I.makeSelectable(this.domElement,!1),ns&&n){r.useLocalStorage=!0;var a=localStorage.getItem(Lr(this,"gui"));a&&(s.load=JSON.parse(a))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,I.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),s.closeOnTop?(I.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(I.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),I.bind(this.__closeButton,"click",function(){r.closed=!r.closed})}else{s.closed===void 0&&(s.closed=!0);var c=document.createTextNode(s.name);I.addClass(c,"controller-name"),o=ci(r,c);var m=function(v){return v.preventDefault(),r.closed=!r.closed,!1};I.addClass(this.__ul,t.CLASS_CLOSED),I.addClass(o,"title"),I.bind(o,"click",m),s.closed||(this.closed=!1)}s.autoPlace&&(J.isUndefined(s.parent)&&(la&&(Gr=document.createElement("div"),I.addClass(Gr,aa),I.addClass(Gr,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(Gr),la=!1),Gr.appendChild(this.domElement),I.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||hi(r,s.width)),this.__resizeHandler=function(){r.onResizeDebounced()},I.bind(window,"resize",this.__resizeHandler),I.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),I.bind(this.__ul,"transitionend",this.__resizeHandler),I.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),s.resizable&&Ql(this),i=function(){ns&&localStorage.getItem(Lr(r,"isLocal"))==="true"&&localStorage.setItem(Lr(r,"gui"),JSON.stringify(r.getSaveObject()))},this.saveToLocalStorageIfPossible=i;function _(){var v=r.getRoot();v.width+=1,J.defer(function(){v.width-=1})}s.parent||_()};Se.toggleHide=function(){ui=!ui,J.each(da,function(t){t.domElement.style.display=ui?"none":""})},Se.CLASS_AUTO_PLACE="a",Se.CLASS_AUTO_PLACE_CONTAINER="ac",Se.CLASS_MAIN="main",Se.CLASS_CONTROLLER_ROW="cr",Se.CLASS_TOO_TALL="taller-than-window",Se.CLASS_CLOSED="closed",Se.CLASS_CLOSE_BUTTON="close-button",Se.CLASS_CLOSE_TOP="close-top",Se.CLASS_CLOSE_BOTTOM="close-bottom",Se.CLASS_DRAG="drag",Se.DEFAULT_WIDTH=245,Se.TEXT_CLOSED="Close Controls",Se.TEXT_OPEN="Open Controls",Se._keydownHandler=function(t){document.activeElement.type!=="text"&&(t.which===ua||t.keyCode===ua)&&Se.toggleHide()},I.bind(window,"keydown",Se._keydownHandler,!1),J.extend(Se.prototype,{add:function(t,e){return os(this,t,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(t,e){return os(this,t,e,{color:!0})},remove:function(t){this.__ul.removeChild(t.__li),this.__controllers.splice(this.__controllers.indexOf(t),1);var e=this;J.defer(function(){e.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&Gr.removeChild(this.domElement);var t=this;J.each(this.__folders,function(e){t.removeFolder(e)}),I.unbind(window,"keydown",Se._keydownHandler,!1),ha(this)},addFolder:function(t){if(this.__folders[t]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+t+'"');var e={name:t,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[t]&&(e.closed=this.load.folders[t].closed,e.load=this.load.folders[t]);var r=new Se(e);this.__folders[t]=r;var s=ci(this,r.domElement);return I.addClass(s,"folder"),r},removeFolder:function(t){this.__ul.removeChild(t.domElement.parentElement),delete this.__folders[t.name],this.load&&this.load.folders&&this.load.folders[t.name]&&delete this.load.folders[t.name],ha(t);var e=this;J.each(t.__folders,function(r){t.removeFolder(r)}),J.defer(function(){e.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var t=this.getRoot();if(t.scrollable){var e=I.getOffset(t.__ul).top,r=0;J.each(t.__ul.childNodes,function(s){t.autoPlace&&s===t.__save_row||(r+=I.getHeight(s))}),window.innerHeight-e-ca<r?(I.addClass(t.domElement,Se.CLASS_TOO_TALL),t.__ul.style.height=window.innerHeight-e-ca+"px"):(I.removeClass(t.domElement,Se.CLASS_TOO_TALL),t.__ul.style.height="auto")}t.__resize_handle&&J.defer(function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"}),t.__closeButton&&(t.__closeButton.style.width=t.width+"px")},onResizeDebounced:J.debounce(function(){this.onResize()},50),remember:function(){if(J.isUndefined(is)&&(is=new Xl,is.domElement.innerHTML=jl),this.parent)throw new Error("You can only call remember on a top level GUI.");var t=this;J.each(Array.prototype.slice.call(arguments),function(e){t.__rememberedObjects.length===0&&$l(t),t.__rememberedObjects.indexOf(e)===-1&&t.__rememberedObjects.push(e)}),this.autoPlace&&hi(this,this.width)},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},getSaveObject:function(){var t=this.load;return t.closed=this.closed,this.__rememberedObjects.length>0&&(t.preset=this.preset,t.remembered||(t.remembered={}),t.remembered[this.preset]=Is(this)),t.folders={},J.each(this.__folders,function(e,r){t.folders[r]=e.getSaveObject()}),t},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=Is(this),li(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(t){this.load.remembered||(this.load.remembered={},this.load.remembered[ss]=Is(this,!0)),this.load.remembered[t]=Is(this),this.preset=t,di(this,t,!0),this.saveToLocalStorageIfPossible()},revert:function(t){J.each(this.__controllers,function(e){this.getRoot().load.remembered?fa(t||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())},this),J.each(this.__folders,function(e){e.revert(e)}),t||li(this.getRoot(),!1)},listen:function(t){var e=this.__listening.length===0;this.__listening.push(t),e&&ma(this.__listening)},updateDisplay:function(){J.each(this.__controllers,function(t){t.updateDisplay()}),J.each(this.__folders,function(t){t.updateDisplay()})}});function ci(t,e,r){var s=document.createElement("li");return e&&s.appendChild(e),r?t.__ul.insertBefore(s,r):t.__ul.appendChild(s),t.onResize(),s}function ha(t){I.unbind(window,"resize",t.__resizeHandler),t.saveToLocalStorageIfPossible&&I.unbind(window,"unload",t.saveToLocalStorageIfPossible)}function li(t,e){var r=t.__preset_select[t.__preset_select.selectedIndex];e?r.innerHTML=r.value+"*":r.innerHTML=r.value}function Yl(t,e,r){if(r.__li=e,r.__gui=t,J.extend(r,{options:function(i){if(arguments.length>1){var o=r.__li.nextElementSibling;return r.remove(),os(t,r.object,r.property,{before:o,factoryArgs:[J.toArray(arguments)]})}if(J.isArray(i)||J.isObject(i)){var a=r.__li.nextElementSibling;return r.remove(),os(t,r.object,r.property,{before:a,factoryArgs:[i]})}},name:function(i){return r.__li.firstElementChild.firstElementChild.innerHTML=i,r},listen:function(){return r.__gui.listen(r),r},remove:function(){return r.__gui.remove(r),r}}),r instanceof oi){var s=new Ds(r.object,r.property,{min:r.__min,max:r.__max,step:r.__step});J.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(i){var o=r[i],a=s[i];r[i]=s[i]=function(){var c=Array.prototype.slice.call(arguments);return a.apply(s,c),o.apply(r,c)}}),I.addClass(e,"has-slider"),r.domElement.insertBefore(s.domElement,r.domElement.firstElementChild)}else if(r instanceof Ds){var n=function(i){if(J.isNumber(r.__min)&&J.isNumber(r.__max)){var o=r.__li.firstElementChild.firstElementChild.innerHTML,a=r.__gui.__listening.indexOf(r)>-1;r.remove();var c=os(t,r.object,r.property,{before:r.__li.nextElementSibling,factoryArgs:[r.__min,r.__max,r.__step]});return c.name(o),a&&c.listen(),c}return i};r.min=J.compose(n,r.min),r.max=J.compose(n,r.max)}else r instanceof ta?(I.bind(e,"click",function(){I.fakeEvent(r.__checkbox,"click")}),I.bind(r.__checkbox,"click",function(i){i.stopPropagation()})):r instanceof ia?(I.bind(e,"click",function(){I.fakeEvent(r.__button,"click")}),I.bind(e,"mouseover",function(){I.addClass(r.__button,"hover")}),I.bind(e,"mouseout",function(){I.removeClass(r.__button,"hover")})):r instanceof ai&&(I.addClass(e,"color"),r.updateDisplay=J.compose(function(i){return e.style.borderLeftColor=r.__color.toString(),i},r.updateDisplay),r.updateDisplay());r.setValue=J.compose(function(i){return t.getRoot().__preset_select&&r.isModified()&&li(t.getRoot(),!0),i},r.setValue)}function fa(t,e){var r=t.getRoot(),s=r.__rememberedObjects.indexOf(e.object);if(s!==-1){var n=r.__rememberedObjectIndecesToControllers[s];if(n===void 0&&(n={},r.__rememberedObjectIndecesToControllers[s]=n),n[e.property]=e,r.load&&r.load.remembered){var i=r.load.remembered,o=void 0;if(i[t.preset])o=i[t.preset];else if(i[ss])o=i[ss];else return;if(o[s]&&o[s][e.property]!==void 0){var a=o[s][e.property];e.initialValue=a,e.setValue(a)}}}}function os(t,e,r,s){if(e[r]===void 0)throw new Error('Object "'+e+'" has no property "'+r+'"');var n=void 0;if(s.color)n=new ai(e,r);else{var i=[e,r].concat(s.factoryArgs);n=zl.apply(t,i)}s.before instanceof dr&&(s.before=s.before.__li),fa(t,n),I.addClass(n.domElement,"c");var o=document.createElement("span");I.addClass(o,"property-name"),o.innerHTML=n.property;var a=document.createElement("div");a.appendChild(o),a.appendChild(n.domElement);var c=ci(t,a,s.before);return I.addClass(c,Se.CLASS_CONTROLLER_ROW),n instanceof ai?I.addClass(c,"color"):I.addClass(c,Ol(n.getValue())),Yl(t,c,n),t.__controllers.push(n),n}function Lr(t,e){return document.location.href+"."+e}function di(t,e,r){var s=document.createElement("option");s.innerHTML=e,s.value=e,t.__preset_select.appendChild(s),r&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function pa(t,e){e.style.display=t.useLocalStorage?"block":"none"}function $l(t){var e=t.__save_row=document.createElement("li");I.addClass(t.domElement,"has-save"),t.__ul.insertBefore(e,t.__ul.firstChild),I.addClass(e,"save-row");var r=document.createElement("span");r.innerHTML="&nbsp;",I.addClass(r,"button gears");var s=document.createElement("span");s.innerHTML="Save",I.addClass(s,"button"),I.addClass(s,"save");var n=document.createElement("span");n.innerHTML="New",I.addClass(n,"button"),I.addClass(n,"save-as");var i=document.createElement("span");i.innerHTML="Revert",I.addClass(i,"button"),I.addClass(i,"revert");var o=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?J.each(t.load.remembered,function(v,P){di(t,P,P===t.preset)}):di(t,ss,!1),I.bind(o,"change",function(){for(var v=0;v<t.__preset_select.length;v++)t.__preset_select[v].innerHTML=t.__preset_select[v].value;t.preset=this.value}),e.appendChild(o),e.appendChild(r),e.appendChild(s),e.appendChild(n),e.appendChild(i),ns){var a=document.getElementById("dg-local-explain"),c=document.getElementById("dg-local-storage"),m=document.getElementById("dg-save-locally");m.style.display="block",localStorage.getItem(Lr(t,"isLocal"))==="true"&&c.setAttribute("checked","checked"),pa(t,a),I.bind(c,"change",function(){t.useLocalStorage=!t.useLocalStorage,pa(t,a)})}var _=document.getElementById("dg-new-constructor");I.bind(_,"keydown",function(v){v.metaKey&&(v.which===67||v.keyCode===67)&&is.hide()}),I.bind(r,"click",function(){_.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),is.show(),_.focus(),_.select()}),I.bind(s,"click",function(){t.save()}),I.bind(n,"click",function(){var v=prompt("Enter a new preset name.");v&&t.saveAs(v)}),I.bind(i,"click",function(){t.revert()})}function Ql(t){var e=void 0;t.__resize_handle=document.createElement("div"),J.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function r(i){return i.preventDefault(),t.width+=e-i.clientX,t.onResize(),e=i.clientX,!1}function s(){I.removeClass(t.__closeButton,Se.CLASS_DRAG),I.unbind(window,"mousemove",r),I.unbind(window,"mouseup",s)}function n(i){return i.preventDefault(),e=i.clientX,I.addClass(t.__closeButton,Se.CLASS_DRAG),I.bind(window,"mousemove",r),I.bind(window,"mouseup",s),!1}I.bind(t.__resize_handle,"mousedown",n),I.bind(t.__closeButton,"mousedown",n),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function hi(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function Is(t,e){var r={};return J.each(t.__rememberedObjects,function(s,n){var i={},o=t.__rememberedObjectIndecesToControllers[n];J.each(o,function(a,c){i[c]=e?a.initialValue:a.getValue()}),r[n]=i}),r}function ql(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value===t.preset&&(t.__preset_select.selectedIndex=e)}function ma(t){t.length!==0&&Kl.call(window,function(){ma(t)}),J.each(t,function(e){e.updateDisplay()})}var Zl=Se;function ed(t,e){return class extends t{constructor(...r){super(...r),e(this)}}}const td=ed(Array,t=>t.fill(0));let fe=1e-6;function rd(t){function e(u=0,g=0){const l=new t(2);return u!==void 0&&(l[0]=u,g!==void 0&&(l[1]=g)),l}const r=e;function s(u,g,l){const h=l??new t(2);return h[0]=u,h[1]=g,h}function n(u,g){const l=g??new t(2);return l[0]=Math.ceil(u[0]),l[1]=Math.ceil(u[1]),l}function i(u,g){const l=g??new t(2);return l[0]=Math.floor(u[0]),l[1]=Math.floor(u[1]),l}function o(u,g){const l=g??new t(2);return l[0]=Math.round(u[0]),l[1]=Math.round(u[1]),l}function a(u,g=0,l=1,h){const A=h??new t(2);return A[0]=Math.min(l,Math.max(g,u[0])),A[1]=Math.min(l,Math.max(g,u[1])),A}function c(u,g,l){const h=l??new t(2);return h[0]=u[0]+g[0],h[1]=u[1]+g[1],h}function m(u,g,l,h){const A=h??new t(2);return A[0]=u[0]+g[0]*l,A[1]=u[1]+g[1]*l,A}function _(u,g){const l=u[0],h=u[1],A=g[0],E=g[1],N=Math.sqrt(l*l+h*h),y=Math.sqrt(A*A+E*E),B=N*y,S=B&&ye(u,g)/B;return Math.acos(S)}function v(u,g,l){const h=l??new t(2);return h[0]=u[0]-g[0],h[1]=u[1]-g[1],h}const P=v;function O(u,g){return Math.abs(u[0]-g[0])<fe&&Math.abs(u[1]-g[1])<fe}function D(u,g){return u[0]===g[0]&&u[1]===g[1]}function U(u,g,l,h){const A=h??new t(2);return A[0]=u[0]+l*(g[0]-u[0]),A[1]=u[1]+l*(g[1]-u[1]),A}function X(u,g,l,h){const A=h??new t(2);return A[0]=u[0]+l[0]*(g[0]-u[0]),A[1]=u[1]+l[1]*(g[1]-u[1]),A}function Y(u,g,l){const h=l??new t(2);return h[0]=Math.max(u[0],g[0]),h[1]=Math.max(u[1],g[1]),h}function Q(u,g,l){const h=l??new t(2);return h[0]=Math.min(u[0],g[0]),h[1]=Math.min(u[1],g[1]),h}function q(u,g,l){const h=l??new t(2);return h[0]=u[0]*g,h[1]=u[1]*g,h}const j=q;function W(u,g,l){const h=l??new t(2);return h[0]=u[0]/g,h[1]=u[1]/g,h}function Z(u,g){const l=g??new t(2);return l[0]=1/u[0],l[1]=1/u[1],l}const ue=Z;function me(u,g,l){const h=l??new t(3),A=u[0]*g[1]-u[1]*g[0];return h[0]=0,h[1]=0,h[2]=A,h}function ye(u,g){return u[0]*g[0]+u[1]*g[1]}function ve(u){const g=u[0],l=u[1];return Math.sqrt(g*g+l*l)}const Ve=ve;function oe(u){const g=u[0],l=u[1];return g*g+l*l}const xe=oe;function he(u,g){const l=u[0]-g[0],h=u[1]-g[1];return Math.sqrt(l*l+h*h)}const Ge=he;function we(u,g){const l=u[0]-g[0],h=u[1]-g[1];return l*l+h*h}const Le=we;function Ce(u,g){const l=g??new t(2),h=u[0],A=u[1],E=Math.sqrt(h*h+A*A);return E>1e-5?(l[0]=h/E,l[1]=A/E):(l[0]=0,l[1]=0),l}function Ee(u,g){const l=g??new t(2);return l[0]=-u[0],l[1]=-u[1],l}function be(u,g){const l=g??new t(2);return l[0]=u[0],l[1]=u[1],l}const Pe=be;function He(u,g,l){const h=l??new t(2);return h[0]=u[0]*g[0],h[1]=u[1]*g[1],h}const et=He;function Xe(u,g,l){const h=l??new t(2);return h[0]=u[0]/g[0],h[1]=u[1]/g[1],h}const lt=Xe;function tt(u=1,g){const l=g??new t(2),h=Math.random()*2*Math.PI;return l[0]=Math.cos(h)*u,l[1]=Math.sin(h)*u,l}function f(u){const g=u??new t(2);return g[0]=0,g[1]=0,g}function C(u,g,l){const h=l??new t(2),A=u[0],E=u[1];return h[0]=A*g[0]+E*g[4]+g[12],h[1]=A*g[1]+E*g[5]+g[13],h}function d(u,g,l){const h=l??new t(2),A=u[0],E=u[1];return h[0]=g[0]*A+g[4]*E+g[8],h[1]=g[1]*A+g[5]*E+g[9],h}function p(u,g,l,h){const A=h??new t(2),E=u[0]-g[0],N=u[1]-g[1],y=Math.sin(l),B=Math.cos(l);return A[0]=E*B-N*y+g[0],A[1]=E*y+N*B+g[1],A}function w(u,g,l){const h=l??new t(2);return Ce(u,h),q(h,g,h)}function T(u,g,l){const h=l??new t(2);return ve(u)>g?w(u,g,h):be(u,h)}function k(u,g,l){const h=l??new t(2);return U(u,g,.5,h)}return{create:e,fromValues:r,set:s,ceil:n,floor:i,round:o,clamp:a,add:c,addScaled:m,angle:_,subtract:v,sub:P,equalsApproximately:O,equals:D,lerp:U,lerpV:X,max:Y,min:Q,mulScalar:q,scale:j,divScalar:W,inverse:Z,invert:ue,cross:me,dot:ye,length:ve,len:Ve,lengthSq:oe,lenSq:xe,distance:he,dist:Ge,distanceSq:we,distSq:Le,normalize:Ce,negate:Ee,copy:be,clone:Pe,multiply:He,mul:et,divide:Xe,div:lt,random:tt,zero:f,transformMat4:C,transformMat3:d,rotate:p,setLength:w,truncate:T,midpoint:k}}const ga=new Map;function ya(t){let e=ga.get(t);return e||(e=rd(t),ga.set(t,e)),e}function sd(t){function e(y,B,S){const M=new t(3);return y!==void 0&&(M[0]=y,B!==void 0&&(M[1]=B,S!==void 0&&(M[2]=S))),M}const r=e;function s(y,B,S,M){const F=M??new t(3);return F[0]=y,F[1]=B,F[2]=S,F}function n(y,B){const S=B??new t(3);return S[0]=Math.ceil(y[0]),S[1]=Math.ceil(y[1]),S[2]=Math.ceil(y[2]),S}function i(y,B){const S=B??new t(3);return S[0]=Math.floor(y[0]),S[1]=Math.floor(y[1]),S[2]=Math.floor(y[2]),S}function o(y,B){const S=B??new t(3);return S[0]=Math.round(y[0]),S[1]=Math.round(y[1]),S[2]=Math.round(y[2]),S}function a(y,B=0,S=1,M){const F=M??new t(3);return F[0]=Math.min(S,Math.max(B,y[0])),F[1]=Math.min(S,Math.max(B,y[1])),F[2]=Math.min(S,Math.max(B,y[2])),F}function c(y,B,S){const M=S??new t(3);return M[0]=y[0]+B[0],M[1]=y[1]+B[1],M[2]=y[2]+B[2],M}function m(y,B,S,M){const F=M??new t(3);return F[0]=y[0]+B[0]*S,F[1]=y[1]+B[1]*S,F[2]=y[2]+B[2]*S,F}function _(y,B){const S=y[0],M=y[1],F=y[2],V=B[0],z=B[1],ne=B[2],le=Math.sqrt(S*S+M*M+F*F),se=Math.sqrt(V*V+z*z+ne*ne),ie=le*se,pe=ie&&ye(y,B)/ie;return Math.acos(pe)}function v(y,B,S){const M=S??new t(3);return M[0]=y[0]-B[0],M[1]=y[1]-B[1],M[2]=y[2]-B[2],M}const P=v;function O(y,B){return Math.abs(y[0]-B[0])<fe&&Math.abs(y[1]-B[1])<fe&&Math.abs(y[2]-B[2])<fe}function D(y,B){return y[0]===B[0]&&y[1]===B[1]&&y[2]===B[2]}function U(y,B,S,M){const F=M??new t(3);return F[0]=y[0]+S*(B[0]-y[0]),F[1]=y[1]+S*(B[1]-y[1]),F[2]=y[2]+S*(B[2]-y[2]),F}function X(y,B,S,M){const F=M??new t(3);return F[0]=y[0]+S[0]*(B[0]-y[0]),F[1]=y[1]+S[1]*(B[1]-y[1]),F[2]=y[2]+S[2]*(B[2]-y[2]),F}function Y(y,B,S){const M=S??new t(3);return M[0]=Math.max(y[0],B[0]),M[1]=Math.max(y[1],B[1]),M[2]=Math.max(y[2],B[2]),M}function Q(y,B,S){const M=S??new t(3);return M[0]=Math.min(y[0],B[0]),M[1]=Math.min(y[1],B[1]),M[2]=Math.min(y[2],B[2]),M}function q(y,B,S){const M=S??new t(3);return M[0]=y[0]*B,M[1]=y[1]*B,M[2]=y[2]*B,M}const j=q;function W(y,B,S){const M=S??new t(3);return M[0]=y[0]/B,M[1]=y[1]/B,M[2]=y[2]/B,M}function Z(y,B){const S=B??new t(3);return S[0]=1/y[0],S[1]=1/y[1],S[2]=1/y[2],S}const ue=Z;function me(y,B,S){const M=S??new t(3),F=y[2]*B[0]-y[0]*B[2],V=y[0]*B[1]-y[1]*B[0];return M[0]=y[1]*B[2]-y[2]*B[1],M[1]=F,M[2]=V,M}function ye(y,B){return y[0]*B[0]+y[1]*B[1]+y[2]*B[2]}function ve(y){const B=y[0],S=y[1],M=y[2];return Math.sqrt(B*B+S*S+M*M)}const Ve=ve;function oe(y){const B=y[0],S=y[1],M=y[2];return B*B+S*S+M*M}const xe=oe;function he(y,B){const S=y[0]-B[0],M=y[1]-B[1],F=y[2]-B[2];return Math.sqrt(S*S+M*M+F*F)}const Ge=he;function we(y,B){const S=y[0]-B[0],M=y[1]-B[1],F=y[2]-B[2];return S*S+M*M+F*F}const Le=we;function Ce(y,B){const S=B??new t(3),M=y[0],F=y[1],V=y[2],z=Math.sqrt(M*M+F*F+V*V);return z>1e-5?(S[0]=M/z,S[1]=F/z,S[2]=V/z):(S[0]=0,S[1]=0,S[2]=0),S}function Ee(y,B){const S=B??new t(3);return S[0]=-y[0],S[1]=-y[1],S[2]=-y[2],S}function be(y,B){const S=B??new t(3);return S[0]=y[0],S[1]=y[1],S[2]=y[2],S}const Pe=be;function He(y,B,S){const M=S??new t(3);return M[0]=y[0]*B[0],M[1]=y[1]*B[1],M[2]=y[2]*B[2],M}const et=He;function Xe(y,B,S){const M=S??new t(3);return M[0]=y[0]/B[0],M[1]=y[1]/B[1],M[2]=y[2]/B[2],M}const lt=Xe;function tt(y=1,B){const S=B??new t(3),M=Math.random()*2*Math.PI,F=Math.random()*2-1,V=Math.sqrt(1-F*F)*y;return S[0]=Math.cos(M)*V,S[1]=Math.sin(M)*V,S[2]=F*y,S}function f(y){const B=y??new t(3);return B[0]=0,B[1]=0,B[2]=0,B}function C(y,B,S){const M=S??new t(3),F=y[0],V=y[1],z=y[2],ne=B[3]*F+B[7]*V+B[11]*z+B[15]||1;return M[0]=(B[0]*F+B[4]*V+B[8]*z+B[12])/ne,M[1]=(B[1]*F+B[5]*V+B[9]*z+B[13])/ne,M[2]=(B[2]*F+B[6]*V+B[10]*z+B[14])/ne,M}function d(y,B,S){const M=S??new t(3),F=y[0],V=y[1],z=y[2];return M[0]=F*B[0*4+0]+V*B[1*4+0]+z*B[2*4+0],M[1]=F*B[0*4+1]+V*B[1*4+1]+z*B[2*4+1],M[2]=F*B[0*4+2]+V*B[1*4+2]+z*B[2*4+2],M}function p(y,B,S){const M=S??new t(3),F=y[0],V=y[1],z=y[2];return M[0]=F*B[0]+V*B[4]+z*B[8],M[1]=F*B[1]+V*B[5]+z*B[9],M[2]=F*B[2]+V*B[6]+z*B[10],M}function w(y,B,S){const M=S??new t(3),F=B[0],V=B[1],z=B[2],ne=B[3]*2,le=y[0],se=y[1],ie=y[2],pe=V*ie-z*se,ge=z*le-F*ie,Re=F*se-V*le;return M[0]=le+pe*ne+(V*Re-z*ge)*2,M[1]=se+ge*ne+(z*pe-F*Re)*2,M[2]=ie+Re*ne+(F*ge-V*pe)*2,M}function T(y,B){const S=B??new t(3);return S[0]=y[12],S[1]=y[13],S[2]=y[14],S}function k(y,B,S){const M=S??new t(3),F=B*4;return M[0]=y[F+0],M[1]=y[F+1],M[2]=y[F+2],M}function u(y,B){const S=B??new t(3),M=y[0],F=y[1],V=y[2],z=y[4],ne=y[5],le=y[6],se=y[8],ie=y[9],pe=y[10];return S[0]=Math.sqrt(M*M+F*F+V*V),S[1]=Math.sqrt(z*z+ne*ne+le*le),S[2]=Math.sqrt(se*se+ie*ie+pe*pe),S}function g(y,B,S,M){const F=M??new t(3),V=[],z=[];return V[0]=y[0]-B[0],V[1]=y[1]-B[1],V[2]=y[2]-B[2],z[0]=V[0],z[1]=V[1]*Math.cos(S)-V[2]*Math.sin(S),z[2]=V[1]*Math.sin(S)+V[2]*Math.cos(S),F[0]=z[0]+B[0],F[1]=z[1]+B[1],F[2]=z[2]+B[2],F}function l(y,B,S,M){const F=M??new t(3),V=[],z=[];return V[0]=y[0]-B[0],V[1]=y[1]-B[1],V[2]=y[2]-B[2],z[0]=V[2]*Math.sin(S)+V[0]*Math.cos(S),z[1]=V[1],z[2]=V[2]*Math.cos(S)-V[0]*Math.sin(S),F[0]=z[0]+B[0],F[1]=z[1]+B[1],F[2]=z[2]+B[2],F}function h(y,B,S,M){const F=M??new t(3),V=[],z=[];return V[0]=y[0]-B[0],V[1]=y[1]-B[1],V[2]=y[2]-B[2],z[0]=V[0]*Math.cos(S)-V[1]*Math.sin(S),z[1]=V[0]*Math.sin(S)+V[1]*Math.cos(S),z[2]=V[2],F[0]=z[0]+B[0],F[1]=z[1]+B[1],F[2]=z[2]+B[2],F}function A(y,B,S){const M=S??new t(3);return Ce(y,M),q(M,B,M)}function E(y,B,S){const M=S??new t(3);return ve(y)>B?A(y,B,M):be(y,M)}function N(y,B,S){const M=S??new t(3);return U(y,B,.5,M)}return{create:e,fromValues:r,set:s,ceil:n,floor:i,round:o,clamp:a,add:c,addScaled:m,angle:_,subtract:v,sub:P,equalsApproximately:O,equals:D,lerp:U,lerpV:X,max:Y,min:Q,mulScalar:q,scale:j,divScalar:W,inverse:Z,invert:ue,cross:me,dot:ye,length:ve,len:Ve,lengthSq:oe,lenSq:xe,distance:he,dist:Ge,distanceSq:we,distSq:Le,normalize:Ce,negate:Ee,copy:be,clone:Pe,multiply:He,mul:et,divide:Xe,div:lt,random:tt,zero:f,transformMat4:C,transformMat4Upper3x3:d,transformMat3:p,transformQuat:w,getTranslation:T,getAxis:k,getScaling:u,rotateX:g,rotateY:l,rotateZ:h,setLength:A,truncate:E,midpoint:N}}const _a=new Map;function Fs(t){let e=_a.get(t);return e||(e=sd(t),_a.set(t,e)),e}function nd(t){const e=ya(t),r=Fs(t);function s(f,C,d,p,w,T,k,u,g){const l=new t(12);return l[3]=0,l[7]=0,l[11]=0,f!==void 0&&(l[0]=f,C!==void 0&&(l[1]=C,d!==void 0&&(l[2]=d,p!==void 0&&(l[4]=p,w!==void 0&&(l[5]=w,T!==void 0&&(l[6]=T,k!==void 0&&(l[8]=k,u!==void 0&&(l[9]=u,g!==void 0&&(l[10]=g))))))))),l}function n(f,C,d,p,w,T,k,u,g,l){const h=l??new t(12);return h[0]=f,h[1]=C,h[2]=d,h[3]=0,h[4]=p,h[5]=w,h[6]=T,h[7]=0,h[8]=k,h[9]=u,h[10]=g,h[11]=0,h}function i(f,C){const d=C??new t(12);return d[0]=f[0],d[1]=f[1],d[2]=f[2],d[3]=0,d[4]=f[4],d[5]=f[5],d[6]=f[6],d[7]=0,d[8]=f[8],d[9]=f[9],d[10]=f[10],d[11]=0,d}function o(f,C){const d=C??new t(12),p=f[0],w=f[1],T=f[2],k=f[3],u=p+p,g=w+w,l=T+T,h=p*u,A=w*u,E=w*g,N=T*u,y=T*g,B=T*l,S=k*u,M=k*g,F=k*l;return d[0]=1-E-B,d[1]=A+F,d[2]=N-M,d[3]=0,d[4]=A-F,d[5]=1-h-B,d[6]=y+S,d[7]=0,d[8]=N+M,d[9]=y-S,d[10]=1-h-E,d[11]=0,d}function a(f,C){const d=C??new t(12);return d[0]=-f[0],d[1]=-f[1],d[2]=-f[2],d[4]=-f[4],d[5]=-f[5],d[6]=-f[6],d[8]=-f[8],d[9]=-f[9],d[10]=-f[10],d}function c(f,C){const d=C??new t(12);return d[0]=f[0],d[1]=f[1],d[2]=f[2],d[4]=f[4],d[5]=f[5],d[6]=f[6],d[8]=f[8],d[9]=f[9],d[10]=f[10],d}const m=c;function _(f,C){return Math.abs(f[0]-C[0])<fe&&Math.abs(f[1]-C[1])<fe&&Math.abs(f[2]-C[2])<fe&&Math.abs(f[4]-C[4])<fe&&Math.abs(f[5]-C[5])<fe&&Math.abs(f[6]-C[6])<fe&&Math.abs(f[8]-C[8])<fe&&Math.abs(f[9]-C[9])<fe&&Math.abs(f[10]-C[10])<fe}function v(f,C){return f[0]===C[0]&&f[1]===C[1]&&f[2]===C[2]&&f[4]===C[4]&&f[5]===C[5]&&f[6]===C[6]&&f[8]===C[8]&&f[9]===C[9]&&f[10]===C[10]}function P(f){const C=f??new t(12);return C[0]=1,C[1]=0,C[2]=0,C[4]=0,C[5]=1,C[6]=0,C[8]=0,C[9]=0,C[10]=1,C}function O(f,C){const d=C??new t(12);if(d===f){let E;return E=f[1],f[1]=f[4],f[4]=E,E=f[2],f[2]=f[8],f[8]=E,E=f[6],f[6]=f[9],f[9]=E,d}const p=f[0*4+0],w=f[0*4+1],T=f[0*4+2],k=f[1*4+0],u=f[1*4+1],g=f[1*4+2],l=f[2*4+0],h=f[2*4+1],A=f[2*4+2];return d[0]=p,d[1]=k,d[2]=l,d[4]=w,d[5]=u,d[6]=h,d[8]=T,d[9]=g,d[10]=A,d}function D(f,C){const d=C??new t(12),p=f[0*4+0],w=f[0*4+1],T=f[0*4+2],k=f[1*4+0],u=f[1*4+1],g=f[1*4+2],l=f[2*4+0],h=f[2*4+1],A=f[2*4+2],E=A*u-g*h,N=-A*k+g*l,y=h*k-u*l,B=1/(p*E+w*N+T*y);return d[0]=E*B,d[1]=(-A*w+T*h)*B,d[2]=(g*w-T*u)*B,d[4]=N*B,d[5]=(A*p-T*l)*B,d[6]=(-g*p+T*k)*B,d[8]=y*B,d[9]=(-h*p+w*l)*B,d[10]=(u*p-w*k)*B,d}function U(f){const C=f[0],d=f[0*4+1],p=f[0*4+2],w=f[1*4+0],T=f[1*4+1],k=f[1*4+2],u=f[2*4+0],g=f[2*4+1],l=f[2*4+2];return C*(T*l-g*k)-w*(d*l-g*p)+u*(d*k-T*p)}const X=D;function Y(f,C,d){const p=d??new t(12),w=f[0],T=f[1],k=f[2],u=f[4],g=f[5],l=f[6],h=f[8],A=f[9],E=f[10],N=C[0],y=C[1],B=C[2],S=C[4],M=C[5],F=C[6],V=C[8],z=C[9],ne=C[10];return p[0]=w*N+u*y+h*B,p[1]=T*N+g*y+A*B,p[2]=k*N+l*y+E*B,p[4]=w*S+u*M+h*F,p[5]=T*S+g*M+A*F,p[6]=k*S+l*M+E*F,p[8]=w*V+u*z+h*ne,p[9]=T*V+g*z+A*ne,p[10]=k*V+l*z+E*ne,p}const Q=Y;function q(f,C,d){const p=d??P();return f!==p&&(p[0]=f[0],p[1]=f[1],p[2]=f[2],p[4]=f[4],p[5]=f[5],p[6]=f[6]),p[8]=C[0],p[9]=C[1],p[10]=1,p}function j(f,C){const d=C??e.create();return d[0]=f[8],d[1]=f[9],d}function W(f,C,d){const p=d??e.create(),w=C*4;return p[0]=f[w+0],p[1]=f[w+1],p}function Z(f,C,d,p){const w=p===f?f:c(f,p),T=d*4;return w[T+0]=C[0],w[T+1]=C[1],w}function ue(f,C){const d=C??e.create(),p=f[0],w=f[1],T=f[4],k=f[5];return d[0]=Math.sqrt(p*p+w*w),d[1]=Math.sqrt(T*T+k*k),d}function me(f,C){const d=C??r.create(),p=f[0],w=f[1],T=f[2],k=f[4],u=f[5],g=f[6],l=f[8],h=f[9],A=f[10];return d[0]=Math.sqrt(p*p+w*w+T*T),d[1]=Math.sqrt(k*k+u*u+g*g),d[2]=Math.sqrt(l*l+h*h+A*A),d}function ye(f,C){const d=C??new t(12);return d[0]=1,d[1]=0,d[2]=0,d[4]=0,d[5]=1,d[6]=0,d[8]=f[0],d[9]=f[1],d[10]=1,d}function ve(f,C,d){const p=d??new t(12),w=C[0],T=C[1],k=f[0],u=f[1],g=f[2],l=f[1*4+0],h=f[1*4+1],A=f[1*4+2],E=f[2*4+0],N=f[2*4+1],y=f[2*4+2];return f!==p&&(p[0]=k,p[1]=u,p[2]=g,p[4]=l,p[5]=h,p[6]=A),p[8]=k*w+l*T+E,p[9]=u*w+h*T+N,p[10]=g*w+A*T+y,p}function Ve(f,C){const d=C??new t(12),p=Math.cos(f),w=Math.sin(f);return d[0]=p,d[1]=w,d[2]=0,d[4]=-w,d[5]=p,d[6]=0,d[8]=0,d[9]=0,d[10]=1,d}function oe(f,C,d){const p=d??new t(12),w=f[0*4+0],T=f[0*4+1],k=f[0*4+2],u=f[1*4+0],g=f[1*4+1],l=f[1*4+2],h=Math.cos(C),A=Math.sin(C);return p[0]=h*w+A*u,p[1]=h*T+A*g,p[2]=h*k+A*l,p[4]=h*u-A*w,p[5]=h*g-A*T,p[6]=h*l-A*k,f!==p&&(p[8]=f[8],p[9]=f[9],p[10]=f[10]),p}function xe(f,C){const d=C??new t(12),p=Math.cos(f),w=Math.sin(f);return d[0]=1,d[1]=0,d[2]=0,d[4]=0,d[5]=p,d[6]=w,d[8]=0,d[9]=-w,d[10]=p,d}function he(f,C,d){const p=d??new t(12),w=f[4],T=f[5],k=f[6],u=f[8],g=f[9],l=f[10],h=Math.cos(C),A=Math.sin(C);return p[4]=h*w+A*u,p[5]=h*T+A*g,p[6]=h*k+A*l,p[8]=h*u-A*w,p[9]=h*g-A*T,p[10]=h*l-A*k,f!==p&&(p[0]=f[0],p[1]=f[1],p[2]=f[2]),p}function Ge(f,C){const d=C??new t(12),p=Math.cos(f),w=Math.sin(f);return d[0]=p,d[1]=0,d[2]=-w,d[4]=0,d[5]=1,d[6]=0,d[8]=w,d[9]=0,d[10]=p,d}function we(f,C,d){const p=d??new t(12),w=f[0*4+0],T=f[0*4+1],k=f[0*4+2],u=f[2*4+0],g=f[2*4+1],l=f[2*4+2],h=Math.cos(C),A=Math.sin(C);return p[0]=h*w-A*u,p[1]=h*T-A*g,p[2]=h*k-A*l,p[8]=h*u+A*w,p[9]=h*g+A*T,p[10]=h*l+A*k,f!==p&&(p[4]=f[4],p[5]=f[5],p[6]=f[6]),p}const Le=Ve,Ce=oe;function Ee(f,C){const d=C??new t(12);return d[0]=f[0],d[1]=0,d[2]=0,d[4]=0,d[5]=f[1],d[6]=0,d[8]=0,d[9]=0,d[10]=1,d}function be(f,C,d){const p=d??new t(12),w=C[0],T=C[1];return p[0]=w*f[0*4+0],p[1]=w*f[0*4+1],p[2]=w*f[0*4+2],p[4]=T*f[1*4+0],p[5]=T*f[1*4+1],p[6]=T*f[1*4+2],f!==p&&(p[8]=f[8],p[9]=f[9],p[10]=f[10]),p}function Pe(f,C){const d=C??new t(12);return d[0]=f[0],d[1]=0,d[2]=0,d[4]=0,d[5]=f[1],d[6]=0,d[8]=0,d[9]=0,d[10]=f[2],d}function He(f,C,d){const p=d??new t(12),w=C[0],T=C[1],k=C[2];return p[0]=w*f[0*4+0],p[1]=w*f[0*4+1],p[2]=w*f[0*4+2],p[4]=T*f[1*4+0],p[5]=T*f[1*4+1],p[6]=T*f[1*4+2],p[8]=k*f[2*4+0],p[9]=k*f[2*4+1],p[10]=k*f[2*4+2],p}function et(f,C){const d=C??new t(12);return d[0]=f,d[1]=0,d[2]=0,d[4]=0,d[5]=f,d[6]=0,d[8]=0,d[9]=0,d[10]=1,d}function Xe(f,C,d){const p=d??new t(12);return p[0]=C*f[0*4+0],p[1]=C*f[0*4+1],p[2]=C*f[0*4+2],p[4]=C*f[1*4+0],p[5]=C*f[1*4+1],p[6]=C*f[1*4+2],f!==p&&(p[8]=f[8],p[9]=f[9],p[10]=f[10]),p}function lt(f,C){const d=C??new t(12);return d[0]=f,d[1]=0,d[2]=0,d[4]=0,d[5]=f,d[6]=0,d[8]=0,d[9]=0,d[10]=f,d}function tt(f,C,d){const p=d??new t(12);return p[0]=C*f[0*4+0],p[1]=C*f[0*4+1],p[2]=C*f[0*4+2],p[4]=C*f[1*4+0],p[5]=C*f[1*4+1],p[6]=C*f[1*4+2],p[8]=C*f[2*4+0],p[9]=C*f[2*4+1],p[10]=C*f[2*4+2],p}return{clone:m,create:s,set:n,fromMat4:i,fromQuat:o,negate:a,copy:c,equalsApproximately:_,equals:v,identity:P,transpose:O,inverse:D,invert:X,determinant:U,mul:Q,multiply:Y,setTranslation:q,getTranslation:j,getAxis:W,setAxis:Z,getScaling:ue,get3DScaling:me,translation:ye,translate:ve,rotation:Ve,rotate:oe,rotationX:xe,rotateX:he,rotationY:Ge,rotateY:we,rotationZ:Le,rotateZ:Ce,scaling:Ee,scale:be,uniformScaling:et,uniformScale:Xe,scaling3D:Pe,scale3D:He,uniformScaling3D:lt,uniformScale3D:tt}}const ba=new Map;function id(t){let e=ba.get(t);return e||(e=nd(t),ba.set(t,e)),e}function od(t){const e=Fs(t);function r(u,g,l,h,A,E,N,y,B,S,M,F,V,z,ne,le){const se=new t(16);return u!==void 0&&(se[0]=u,g!==void 0&&(se[1]=g,l!==void 0&&(se[2]=l,h!==void 0&&(se[3]=h,A!==void 0&&(se[4]=A,E!==void 0&&(se[5]=E,N!==void 0&&(se[6]=N,y!==void 0&&(se[7]=y,B!==void 0&&(se[8]=B,S!==void 0&&(se[9]=S,M!==void 0&&(se[10]=M,F!==void 0&&(se[11]=F,V!==void 0&&(se[12]=V,z!==void 0&&(se[13]=z,ne!==void 0&&(se[14]=ne,le!==void 0&&(se[15]=le)))))))))))))))),se}function s(u,g,l,h,A,E,N,y,B,S,M,F,V,z,ne,le,se){const ie=se??new t(16);return ie[0]=u,ie[1]=g,ie[2]=l,ie[3]=h,ie[4]=A,ie[5]=E,ie[6]=N,ie[7]=y,ie[8]=B,ie[9]=S,ie[10]=M,ie[11]=F,ie[12]=V,ie[13]=z,ie[14]=ne,ie[15]=le,ie}function n(u,g){const l=g??new t(16);return l[0]=u[0],l[1]=u[1],l[2]=u[2],l[3]=0,l[4]=u[4],l[5]=u[5],l[6]=u[6],l[7]=0,l[8]=u[8],l[9]=u[9],l[10]=u[10],l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function i(u,g){const l=g??new t(16),h=u[0],A=u[1],E=u[2],N=u[3],y=h+h,B=A+A,S=E+E,M=h*y,F=A*y,V=A*B,z=E*y,ne=E*B,le=E*S,se=N*y,ie=N*B,pe=N*S;return l[0]=1-V-le,l[1]=F+pe,l[2]=z-ie,l[3]=0,l[4]=F-pe,l[5]=1-M-le,l[6]=ne+se,l[7]=0,l[8]=z+ie,l[9]=ne-se,l[10]=1-M-V,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function o(u,g){const l=g??new t(16);return l[0]=-u[0],l[1]=-u[1],l[2]=-u[2],l[3]=-u[3],l[4]=-u[4],l[5]=-u[5],l[6]=-u[6],l[7]=-u[7],l[8]=-u[8],l[9]=-u[9],l[10]=-u[10],l[11]=-u[11],l[12]=-u[12],l[13]=-u[13],l[14]=-u[14],l[15]=-u[15],l}function a(u,g){const l=g??new t(16);return l[0]=u[0],l[1]=u[1],l[2]=u[2],l[3]=u[3],l[4]=u[4],l[5]=u[5],l[6]=u[6],l[7]=u[7],l[8]=u[8],l[9]=u[9],l[10]=u[10],l[11]=u[11],l[12]=u[12],l[13]=u[13],l[14]=u[14],l[15]=u[15],l}const c=a;function m(u,g){return Math.abs(u[0]-g[0])<fe&&Math.abs(u[1]-g[1])<fe&&Math.abs(u[2]-g[2])<fe&&Math.abs(u[3]-g[3])<fe&&Math.abs(u[4]-g[4])<fe&&Math.abs(u[5]-g[5])<fe&&Math.abs(u[6]-g[6])<fe&&Math.abs(u[7]-g[7])<fe&&Math.abs(u[8]-g[8])<fe&&Math.abs(u[9]-g[9])<fe&&Math.abs(u[10]-g[10])<fe&&Math.abs(u[11]-g[11])<fe&&Math.abs(u[12]-g[12])<fe&&Math.abs(u[13]-g[13])<fe&&Math.abs(u[14]-g[14])<fe&&Math.abs(u[15]-g[15])<fe}function _(u,g){return u[0]===g[0]&&u[1]===g[1]&&u[2]===g[2]&&u[3]===g[3]&&u[4]===g[4]&&u[5]===g[5]&&u[6]===g[6]&&u[7]===g[7]&&u[8]===g[8]&&u[9]===g[9]&&u[10]===g[10]&&u[11]===g[11]&&u[12]===g[12]&&u[13]===g[13]&&u[14]===g[14]&&u[15]===g[15]}function v(u){const g=u??new t(16);return g[0]=1,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=1,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=1,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g}function P(u,g){const l=g??new t(16);if(l===u){let ge;return ge=u[1],u[1]=u[4],u[4]=ge,ge=u[2],u[2]=u[8],u[8]=ge,ge=u[3],u[3]=u[12],u[12]=ge,ge=u[6],u[6]=u[9],u[9]=ge,ge=u[7],u[7]=u[13],u[13]=ge,ge=u[11],u[11]=u[14],u[14]=ge,l}const h=u[0*4+0],A=u[0*4+1],E=u[0*4+2],N=u[0*4+3],y=u[1*4+0],B=u[1*4+1],S=u[1*4+2],M=u[1*4+3],F=u[2*4+0],V=u[2*4+1],z=u[2*4+2],ne=u[2*4+3],le=u[3*4+0],se=u[3*4+1],ie=u[3*4+2],pe=u[3*4+3];return l[0]=h,l[1]=y,l[2]=F,l[3]=le,l[4]=A,l[5]=B,l[6]=V,l[7]=se,l[8]=E,l[9]=S,l[10]=z,l[11]=ie,l[12]=N,l[13]=M,l[14]=ne,l[15]=pe,l}function O(u,g){const l=g??new t(16),h=u[0*4+0],A=u[0*4+1],E=u[0*4+2],N=u[0*4+3],y=u[1*4+0],B=u[1*4+1],S=u[1*4+2],M=u[1*4+3],F=u[2*4+0],V=u[2*4+1],z=u[2*4+2],ne=u[2*4+3],le=u[3*4+0],se=u[3*4+1],ie=u[3*4+2],pe=u[3*4+3],ge=z*pe,Re=ie*ne,Ie=S*pe,Fe=ie*M,je=S*ne,We=z*M,Ye=E*pe,$e=ie*N,Qe=E*ne,qe=z*N,rt=E*M,st=S*N,nt=F*se,it=le*V,yt=y*se,_t=le*B,bt=y*V,$n=F*B,Qn=h*se,qn=le*A,Zn=h*V,ei=F*A,ti=h*B,ri=y*A,Ml=ge*B+Fe*V+je*se-(Re*B+Ie*V+We*se),Pl=Re*A+Ye*V+qe*se-(ge*A+$e*V+Qe*se),Rl=Ie*A+$e*B+rt*se-(Fe*A+Ye*B+st*se),Gl=We*A+Qe*B+st*V-(je*A+qe*B+rt*V),Ze=1/(h*Ml+y*Pl+F*Rl+le*Gl);return l[0]=Ze*Ml,l[1]=Ze*Pl,l[2]=Ze*Rl,l[3]=Ze*Gl,l[4]=Ze*(Re*y+Ie*F+We*le-(ge*y+Fe*F+je*le)),l[5]=Ze*(ge*h+$e*F+Qe*le-(Re*h+Ye*F+qe*le)),l[6]=Ze*(Fe*h+Ye*y+st*le-(Ie*h+$e*y+rt*le)),l[7]=Ze*(je*h+qe*y+rt*F-(We*h+Qe*y+st*F)),l[8]=Ze*(nt*M+_t*ne+bt*pe-(it*M+yt*ne+$n*pe)),l[9]=Ze*(it*N+Qn*ne+ei*pe-(nt*N+qn*ne+Zn*pe)),l[10]=Ze*(yt*N+qn*M+ti*pe-(_t*N+Qn*M+ri*pe)),l[11]=Ze*($n*N+Zn*M+ri*ne-(bt*N+ei*M+ti*ne)),l[12]=Ze*(yt*z+$n*ie+it*S-(bt*ie+nt*S+_t*z)),l[13]=Ze*(Zn*ie+nt*E+qn*z-(Qn*z+ei*ie+it*E)),l[14]=Ze*(Qn*S+ri*ie+_t*E-(ti*ie+yt*E+qn*S)),l[15]=Ze*(ti*z+bt*E+ei*S-(Zn*S+ri*z+$n*E)),l}function D(u){const g=u[0],l=u[0*4+1],h=u[0*4+2],A=u[0*4+3],E=u[1*4+0],N=u[1*4+1],y=u[1*4+2],B=u[1*4+3],S=u[2*4+0],M=u[2*4+1],F=u[2*4+2],V=u[2*4+3],z=u[3*4+0],ne=u[3*4+1],le=u[3*4+2],se=u[3*4+3],ie=F*se,pe=le*V,ge=y*se,Re=le*B,Ie=y*V,Fe=F*B,je=h*se,We=le*A,Ye=h*V,$e=F*A,Qe=h*B,qe=y*A,rt=ie*N+Re*M+Ie*ne-(pe*N+ge*M+Fe*ne),st=pe*l+je*M+$e*ne-(ie*l+We*M+Ye*ne),nt=ge*l+We*N+Qe*ne-(Re*l+je*N+qe*ne),it=Fe*l+Ye*N+qe*M-(Ie*l+$e*N+Qe*M);return g*rt+E*st+S*nt+z*it}const U=O;function X(u,g,l){const h=l??new t(16),A=u[0],E=u[1],N=u[2],y=u[3],B=u[4],S=u[5],M=u[6],F=u[7],V=u[8],z=u[9],ne=u[10],le=u[11],se=u[12],ie=u[13],pe=u[14],ge=u[15],Re=g[0],Ie=g[1],Fe=g[2],je=g[3],We=g[4],Ye=g[5],$e=g[6],Qe=g[7],qe=g[8],rt=g[9],st=g[10],nt=g[11],it=g[12],yt=g[13],_t=g[14],bt=g[15];return h[0]=A*Re+B*Ie+V*Fe+se*je,h[1]=E*Re+S*Ie+z*Fe+ie*je,h[2]=N*Re+M*Ie+ne*Fe+pe*je,h[3]=y*Re+F*Ie+le*Fe+ge*je,h[4]=A*We+B*Ye+V*$e+se*Qe,h[5]=E*We+S*Ye+z*$e+ie*Qe,h[6]=N*We+M*Ye+ne*$e+pe*Qe,h[7]=y*We+F*Ye+le*$e+ge*Qe,h[8]=A*qe+B*rt+V*st+se*nt,h[9]=E*qe+S*rt+z*st+ie*nt,h[10]=N*qe+M*rt+ne*st+pe*nt,h[11]=y*qe+F*rt+le*st+ge*nt,h[12]=A*it+B*yt+V*_t+se*bt,h[13]=E*it+S*yt+z*_t+ie*bt,h[14]=N*it+M*yt+ne*_t+pe*bt,h[15]=y*it+F*yt+le*_t+ge*bt,h}const Y=X;function Q(u,g,l){const h=l??v();return u!==h&&(h[0]=u[0],h[1]=u[1],h[2]=u[2],h[3]=u[3],h[4]=u[4],h[5]=u[5],h[6]=u[6],h[7]=u[7],h[8]=u[8],h[9]=u[9],h[10]=u[10],h[11]=u[11]),h[12]=g[0],h[13]=g[1],h[14]=g[2],h[15]=1,h}function q(u,g){const l=g??e.create();return l[0]=u[12],l[1]=u[13],l[2]=u[14],l}function j(u,g,l){const h=l??e.create(),A=g*4;return h[0]=u[A+0],h[1]=u[A+1],h[2]=u[A+2],h}function W(u,g,l,h){const A=h===u?h:a(u,h),E=l*4;return A[E+0]=g[0],A[E+1]=g[1],A[E+2]=g[2],A}function Z(u,g){const l=g??e.create(),h=u[0],A=u[1],E=u[2],N=u[4],y=u[5],B=u[6],S=u[8],M=u[9],F=u[10];return l[0]=Math.sqrt(h*h+A*A+E*E),l[1]=Math.sqrt(N*N+y*y+B*B),l[2]=Math.sqrt(S*S+M*M+F*F),l}function ue(u,g,l,h,A){const E=A??new t(16),N=Math.tan(Math.PI*.5-.5*u);if(E[0]=N/g,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=N,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[11]=-1,E[12]=0,E[13]=0,E[15]=0,Number.isFinite(h)){const y=1/(l-h);E[10]=h*y,E[14]=h*l*y}else E[10]=-1,E[14]=-l;return E}function me(u,g,l,h=1/0,A){const E=A??new t(16),N=1/Math.tan(u*.5);if(E[0]=N/g,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=N,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[11]=-1,E[12]=0,E[13]=0,E[15]=0,h===1/0)E[10]=0,E[14]=l;else{const y=1/(h-l);E[10]=l*y,E[14]=h*l*y}return E}function ye(u,g,l,h,A,E,N){const y=N??new t(16);return y[0]=2/(g-u),y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=2/(h-l),y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[10]=1/(A-E),y[11]=0,y[12]=(g+u)/(u-g),y[13]=(h+l)/(l-h),y[14]=A/(A-E),y[15]=1,y}function ve(u,g,l,h,A,E,N){const y=N??new t(16),B=g-u,S=h-l,M=A-E;return y[0]=2*A/B,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=2*A/S,y[6]=0,y[7]=0,y[8]=(u+g)/B,y[9]=(h+l)/S,y[10]=E/M,y[11]=-1,y[12]=0,y[13]=0,y[14]=A*E/M,y[15]=0,y}function Ve(u,g,l,h,A,E=1/0,N){const y=N??new t(16),B=g-u,S=h-l;if(y[0]=2*A/B,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=2*A/S,y[6]=0,y[7]=0,y[8]=(u+g)/B,y[9]=(h+l)/S,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,E===1/0)y[10]=0,y[14]=A;else{const M=1/(E-A);y[10]=A*M,y[14]=E*A*M}return y}const oe=e.create(),xe=e.create(),he=e.create();function Ge(u,g,l,h){const A=h??new t(16);return e.normalize(e.subtract(g,u,he),he),e.normalize(e.cross(l,he,oe),oe),e.normalize(e.cross(he,oe,xe),xe),A[0]=oe[0],A[1]=oe[1],A[2]=oe[2],A[3]=0,A[4]=xe[0],A[5]=xe[1],A[6]=xe[2],A[7]=0,A[8]=he[0],A[9]=he[1],A[10]=he[2],A[11]=0,A[12]=u[0],A[13]=u[1],A[14]=u[2],A[15]=1,A}function we(u,g,l,h){const A=h??new t(16);return e.normalize(e.subtract(u,g,he),he),e.normalize(e.cross(l,he,oe),oe),e.normalize(e.cross(he,oe,xe),xe),A[0]=oe[0],A[1]=oe[1],A[2]=oe[2],A[3]=0,A[4]=xe[0],A[5]=xe[1],A[6]=xe[2],A[7]=0,A[8]=he[0],A[9]=he[1],A[10]=he[2],A[11]=0,A[12]=u[0],A[13]=u[1],A[14]=u[2],A[15]=1,A}function Le(u,g,l,h){const A=h??new t(16);return e.normalize(e.subtract(u,g,he),he),e.normalize(e.cross(l,he,oe),oe),e.normalize(e.cross(he,oe,xe),xe),A[0]=oe[0],A[1]=xe[0],A[2]=he[0],A[3]=0,A[4]=oe[1],A[5]=xe[1],A[6]=he[1],A[7]=0,A[8]=oe[2],A[9]=xe[2],A[10]=he[2],A[11]=0,A[12]=-(oe[0]*u[0]+oe[1]*u[1]+oe[2]*u[2]),A[13]=-(xe[0]*u[0]+xe[1]*u[1]+xe[2]*u[2]),A[14]=-(he[0]*u[0]+he[1]*u[1]+he[2]*u[2]),A[15]=1,A}function Ce(u,g){const l=g??new t(16);return l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=u[0],l[13]=u[1],l[14]=u[2],l[15]=1,l}function Ee(u,g,l){const h=l??new t(16),A=g[0],E=g[1],N=g[2],y=u[0],B=u[1],S=u[2],M=u[3],F=u[1*4+0],V=u[1*4+1],z=u[1*4+2],ne=u[1*4+3],le=u[2*4+0],se=u[2*4+1],ie=u[2*4+2],pe=u[2*4+3],ge=u[3*4+0],Re=u[3*4+1],Ie=u[3*4+2],Fe=u[3*4+3];return u!==h&&(h[0]=y,h[1]=B,h[2]=S,h[3]=M,h[4]=F,h[5]=V,h[6]=z,h[7]=ne,h[8]=le,h[9]=se,h[10]=ie,h[11]=pe),h[12]=y*A+F*E+le*N+ge,h[13]=B*A+V*E+se*N+Re,h[14]=S*A+z*E+ie*N+Ie,h[15]=M*A+ne*E+pe*N+Fe,h}function be(u,g){const l=g??new t(16),h=Math.cos(u),A=Math.sin(u);return l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=h,l[6]=A,l[7]=0,l[8]=0,l[9]=-A,l[10]=h,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function Pe(u,g,l){const h=l??new t(16),A=u[4],E=u[5],N=u[6],y=u[7],B=u[8],S=u[9],M=u[10],F=u[11],V=Math.cos(g),z=Math.sin(g);return h[4]=V*A+z*B,h[5]=V*E+z*S,h[6]=V*N+z*M,h[7]=V*y+z*F,h[8]=V*B-z*A,h[9]=V*S-z*E,h[10]=V*M-z*N,h[11]=V*F-z*y,u!==h&&(h[0]=u[0],h[1]=u[1],h[2]=u[2],h[3]=u[3],h[12]=u[12],h[13]=u[13],h[14]=u[14],h[15]=u[15]),h}function He(u,g){const l=g??new t(16),h=Math.cos(u),A=Math.sin(u);return l[0]=h,l[1]=0,l[2]=-A,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=A,l[9]=0,l[10]=h,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function et(u,g,l){const h=l??new t(16),A=u[0*4+0],E=u[0*4+1],N=u[0*4+2],y=u[0*4+3],B=u[2*4+0],S=u[2*4+1],M=u[2*4+2],F=u[2*4+3],V=Math.cos(g),z=Math.sin(g);return h[0]=V*A-z*B,h[1]=V*E-z*S,h[2]=V*N-z*M,h[3]=V*y-z*F,h[8]=V*B+z*A,h[9]=V*S+z*E,h[10]=V*M+z*N,h[11]=V*F+z*y,u!==h&&(h[4]=u[4],h[5]=u[5],h[6]=u[6],h[7]=u[7],h[12]=u[12],h[13]=u[13],h[14]=u[14],h[15]=u[15]),h}function Xe(u,g){const l=g??new t(16),h=Math.cos(u),A=Math.sin(u);return l[0]=h,l[1]=A,l[2]=0,l[3]=0,l[4]=-A,l[5]=h,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function lt(u,g,l){const h=l??new t(16),A=u[0*4+0],E=u[0*4+1],N=u[0*4+2],y=u[0*4+3],B=u[1*4+0],S=u[1*4+1],M=u[1*4+2],F=u[1*4+3],V=Math.cos(g),z=Math.sin(g);return h[0]=V*A+z*B,h[1]=V*E+z*S,h[2]=V*N+z*M,h[3]=V*y+z*F,h[4]=V*B-z*A,h[5]=V*S-z*E,h[6]=V*M-z*N,h[7]=V*F-z*y,u!==h&&(h[8]=u[8],h[9]=u[9],h[10]=u[10],h[11]=u[11],h[12]=u[12],h[13]=u[13],h[14]=u[14],h[15]=u[15]),h}function tt(u,g,l){const h=l??new t(16);let A=u[0],E=u[1],N=u[2];const y=Math.sqrt(A*A+E*E+N*N);A/=y,E/=y,N/=y;const B=A*A,S=E*E,M=N*N,F=Math.cos(g),V=Math.sin(g),z=1-F;return h[0]=B+(1-B)*F,h[1]=A*E*z+N*V,h[2]=A*N*z-E*V,h[3]=0,h[4]=A*E*z-N*V,h[5]=S+(1-S)*F,h[6]=E*N*z+A*V,h[7]=0,h[8]=A*N*z+E*V,h[9]=E*N*z-A*V,h[10]=M+(1-M)*F,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,h}const f=tt;function C(u,g,l,h){const A=h??new t(16);let E=g[0],N=g[1],y=g[2];const B=Math.sqrt(E*E+N*N+y*y);E/=B,N/=B,y/=B;const S=E*E,M=N*N,F=y*y,V=Math.cos(l),z=Math.sin(l),ne=1-V,le=S+(1-S)*V,se=E*N*ne+y*z,ie=E*y*ne-N*z,pe=E*N*ne-y*z,ge=M+(1-M)*V,Re=N*y*ne+E*z,Ie=E*y*ne+N*z,Fe=N*y*ne-E*z,je=F+(1-F)*V,We=u[0],Ye=u[1],$e=u[2],Qe=u[3],qe=u[4],rt=u[5],st=u[6],nt=u[7],it=u[8],yt=u[9],_t=u[10],bt=u[11];return A[0]=le*We+se*qe+ie*it,A[1]=le*Ye+se*rt+ie*yt,A[2]=le*$e+se*st+ie*_t,A[3]=le*Qe+se*nt+ie*bt,A[4]=pe*We+ge*qe+Re*it,A[5]=pe*Ye+ge*rt+Re*yt,A[6]=pe*$e+ge*st+Re*_t,A[7]=pe*Qe+ge*nt+Re*bt,A[8]=Ie*We+Fe*qe+je*it,A[9]=Ie*Ye+Fe*rt+je*yt,A[10]=Ie*$e+Fe*st+je*_t,A[11]=Ie*Qe+Fe*nt+je*bt,u!==A&&(A[12]=u[12],A[13]=u[13],A[14]=u[14],A[15]=u[15]),A}const d=C;function p(u,g){const l=g??new t(16);return l[0]=u[0],l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=u[1],l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=u[2],l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function w(u,g,l){const h=l??new t(16),A=g[0],E=g[1],N=g[2];return h[0]=A*u[0*4+0],h[1]=A*u[0*4+1],h[2]=A*u[0*4+2],h[3]=A*u[0*4+3],h[4]=E*u[1*4+0],h[5]=E*u[1*4+1],h[6]=E*u[1*4+2],h[7]=E*u[1*4+3],h[8]=N*u[2*4+0],h[9]=N*u[2*4+1],h[10]=N*u[2*4+2],h[11]=N*u[2*4+3],u!==h&&(h[12]=u[12],h[13]=u[13],h[14]=u[14],h[15]=u[15]),h}function T(u,g){const l=g??new t(16);return l[0]=u,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=u,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=u,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l}function k(u,g,l){const h=l??new t(16);return h[0]=g*u[0*4+0],h[1]=g*u[0*4+1],h[2]=g*u[0*4+2],h[3]=g*u[0*4+3],h[4]=g*u[1*4+0],h[5]=g*u[1*4+1],h[6]=g*u[1*4+2],h[7]=g*u[1*4+3],h[8]=g*u[2*4+0],h[9]=g*u[2*4+1],h[10]=g*u[2*4+2],h[11]=g*u[2*4+3],u!==h&&(h[12]=u[12],h[13]=u[13],h[14]=u[14],h[15]=u[15]),h}return{create:r,set:s,fromMat3:n,fromQuat:i,negate:o,copy:a,clone:c,equalsApproximately:m,equals:_,identity:v,transpose:P,inverse:O,determinant:D,invert:U,multiply:X,mul:Y,setTranslation:Q,getTranslation:q,getAxis:j,setAxis:W,getScaling:Z,perspective:ue,perspectiveReverseZ:me,ortho:ye,frustum:ve,frustumReverseZ:Ve,aim:Ge,cameraAim:we,lookAt:Le,translation:Ce,translate:Ee,rotationX:be,rotateX:Pe,rotationY:He,rotateY:et,rotationZ:Xe,rotateZ:lt,axisRotation:tt,rotation:f,axisRotate:C,rotate:d,scaling:p,scale:w,uniformScaling:T,uniformScale:k}}const xa=new Map;function ad(t){let e=xa.get(t);return e||(e=od(t),xa.set(t,e)),e}function ud(t){const e=Fs(t);function r(f,C,d,p){const w=new t(4);return f!==void 0&&(w[0]=f,C!==void 0&&(w[1]=C,d!==void 0&&(w[2]=d,p!==void 0&&(w[3]=p)))),w}const s=r;function n(f,C,d,p,w){const T=w??new t(4);return T[0]=f,T[1]=C,T[2]=d,T[3]=p,T}function i(f,C,d){const p=d??new t(4),w=C*.5,T=Math.sin(w);return p[0]=T*f[0],p[1]=T*f[1],p[2]=T*f[2],p[3]=Math.cos(w),p}function o(f,C){const d=C??e.create(3),p=Math.acos(f[3])*2,w=Math.sin(p*.5);return w>fe?(d[0]=f[0]/w,d[1]=f[1]/w,d[2]=f[2]/w):(d[0]=1,d[1]=0,d[2]=0),{angle:p,axis:d}}function a(f,C){const d=ve(f,C);return Math.acos(2*d*d-1)}function c(f,C,d){const p=d??new t(4),w=f[0],T=f[1],k=f[2],u=f[3],g=C[0],l=C[1],h=C[2],A=C[3];return p[0]=w*A+u*g+T*h-k*l,p[1]=T*A+u*l+k*g-w*h,p[2]=k*A+u*h+w*l-T*g,p[3]=u*A-w*g-T*l-k*h,p}const m=c;function _(f,C,d){const p=d??new t(4),w=C*.5,T=f[0],k=f[1],u=f[2],g=f[3],l=Math.sin(w),h=Math.cos(w);return p[0]=T*h+g*l,p[1]=k*h+u*l,p[2]=u*h-k*l,p[3]=g*h-T*l,p}function v(f,C,d){const p=d??new t(4),w=C*.5,T=f[0],k=f[1],u=f[2],g=f[3],l=Math.sin(w),h=Math.cos(w);return p[0]=T*h-u*l,p[1]=k*h+g*l,p[2]=u*h+T*l,p[3]=g*h-k*l,p}function P(f,C,d){const p=d??new t(4),w=C*.5,T=f[0],k=f[1],u=f[2],g=f[3],l=Math.sin(w),h=Math.cos(w);return p[0]=T*h+k*l,p[1]=k*h-T*l,p[2]=u*h+g*l,p[3]=g*h-u*l,p}function O(f,C,d,p){const w=p??new t(4),T=f[0],k=f[1],u=f[2],g=f[3];let l=C[0],h=C[1],A=C[2],E=C[3],N=T*l+k*h+u*A+g*E;N<0&&(N=-N,l=-l,h=-h,A=-A,E=-E);let y,B;if(1-N>fe){const S=Math.acos(N),M=Math.sin(S);y=Math.sin((1-d)*S)/M,B=Math.sin(d*S)/M}else y=1-d,B=d;return w[0]=y*T+B*l,w[1]=y*k+B*h,w[2]=y*u+B*A,w[3]=y*g+B*E,w}function D(f,C){const d=C??new t(4),p=f[0],w=f[1],T=f[2],k=f[3],u=p*p+w*w+T*T+k*k,g=u?1/u:0;return d[0]=-p*g,d[1]=-w*g,d[2]=-T*g,d[3]=k*g,d}function U(f,C){const d=C??new t(4);return d[0]=-f[0],d[1]=-f[1],d[2]=-f[2],d[3]=f[3],d}function X(f,C){const d=C??new t(4),p=f[0]+f[5]+f[10];if(p>0){const w=Math.sqrt(p+1);d[3]=.5*w;const T=.5/w;d[0]=(f[6]-f[9])*T,d[1]=(f[8]-f[2])*T,d[2]=(f[1]-f[4])*T}else{let w=0;f[5]>f[0]&&(w=1),f[10]>f[w*4+w]&&(w=2);const T=(w+1)%3,k=(w+2)%3,u=Math.sqrt(f[w*4+w]-f[T*4+T]-f[k*4+k]+1);d[w]=.5*u;const g=.5/u;d[3]=(f[T*4+k]-f[k*4+T])*g,d[T]=(f[T*4+w]+f[w*4+T])*g,d[k]=(f[k*4+w]+f[w*4+k])*g}return d}function Y(f,C,d,p,w){const T=w??new t(4),k=f*.5,u=C*.5,g=d*.5,l=Math.sin(k),h=Math.cos(k),A=Math.sin(u),E=Math.cos(u),N=Math.sin(g),y=Math.cos(g);switch(p){case"xyz":T[0]=l*E*y+h*A*N,T[1]=h*A*y-l*E*N,T[2]=h*E*N+l*A*y,T[3]=h*E*y-l*A*N;break;case"xzy":T[0]=l*E*y-h*A*N,T[1]=h*A*y-l*E*N,T[2]=h*E*N+l*A*y,T[3]=h*E*y+l*A*N;break;case"yxz":T[0]=l*E*y+h*A*N,T[1]=h*A*y-l*E*N,T[2]=h*E*N-l*A*y,T[3]=h*E*y+l*A*N;break;case"yzx":T[0]=l*E*y+h*A*N,T[1]=h*A*y+l*E*N,T[2]=h*E*N-l*A*y,T[3]=h*E*y-l*A*N;break;case"zxy":T[0]=l*E*y-h*A*N,T[1]=h*A*y+l*E*N,T[2]=h*E*N+l*A*y,T[3]=h*E*y-l*A*N;break;case"zyx":T[0]=l*E*y-h*A*N,T[1]=h*A*y+l*E*N,T[2]=h*E*N-l*A*y,T[3]=h*E*y+l*A*N;break;default:throw new Error(`Unknown rotation order: ${p}`)}return T}function Q(f,C){const d=C??new t(4);return d[0]=f[0],d[1]=f[1],d[2]=f[2],d[3]=f[3],d}const q=Q;function j(f,C,d){const p=d??new t(4);return p[0]=f[0]+C[0],p[1]=f[1]+C[1],p[2]=f[2]+C[2],p[3]=f[3]+C[3],p}function W(f,C,d){const p=d??new t(4);return p[0]=f[0]-C[0],p[1]=f[1]-C[1],p[2]=f[2]-C[2],p[3]=f[3]-C[3],p}const Z=W;function ue(f,C,d){const p=d??new t(4);return p[0]=f[0]*C,p[1]=f[1]*C,p[2]=f[2]*C,p[3]=f[3]*C,p}const me=ue;function ye(f,C,d){const p=d??new t(4);return p[0]=f[0]/C,p[1]=f[1]/C,p[2]=f[2]/C,p[3]=f[3]/C,p}function ve(f,C){return f[0]*C[0]+f[1]*C[1]+f[2]*C[2]+f[3]*C[3]}function Ve(f,C,d,p){const w=p??new t(4);return w[0]=f[0]+d*(C[0]-f[0]),w[1]=f[1]+d*(C[1]-f[1]),w[2]=f[2]+d*(C[2]-f[2]),w[3]=f[3]+d*(C[3]-f[3]),w}function oe(f){const C=f[0],d=f[1],p=f[2],w=f[3];return Math.sqrt(C*C+d*d+p*p+w*w)}const xe=oe;function he(f){const C=f[0],d=f[1],p=f[2],w=f[3];return C*C+d*d+p*p+w*w}const Ge=he;function we(f,C){const d=C??new t(4),p=f[0],w=f[1],T=f[2],k=f[3],u=Math.sqrt(p*p+w*w+T*T+k*k);return u>1e-5?(d[0]=p/u,d[1]=w/u,d[2]=T/u,d[3]=k/u):(d[0]=0,d[1]=0,d[2]=0,d[3]=1),d}function Le(f,C){return Math.abs(f[0]-C[0])<fe&&Math.abs(f[1]-C[1])<fe&&Math.abs(f[2]-C[2])<fe&&Math.abs(f[3]-C[3])<fe}function Ce(f,C){return f[0]===C[0]&&f[1]===C[1]&&f[2]===C[2]&&f[3]===C[3]}function Ee(f){const C=f??new t(4);return C[0]=0,C[1]=0,C[2]=0,C[3]=1,C}const be=e.create(),Pe=e.create(),He=e.create();function et(f,C,d){const p=d??new t(4),w=e.dot(f,C);return w<-.999999?(e.cross(Pe,f,be),e.len(be)<1e-6&&e.cross(He,f,be),e.normalize(be,be),i(be,Math.PI,p),p):w>.999999?(p[0]=0,p[1]=0,p[2]=0,p[3]=1,p):(e.cross(f,C,be),p[0]=be[0],p[1]=be[1],p[2]=be[2],p[3]=1+w,we(p,p))}const Xe=new t(4),lt=new t(4);function tt(f,C,d,p,w,T){const k=T??new t(4);return O(f,p,w,Xe),O(C,d,w,lt),O(Xe,lt,2*w*(1-w),k),k}return{create:r,fromValues:s,set:n,fromAxisAngle:i,toAxisAngle:o,angle:a,multiply:c,mul:m,rotateX:_,rotateY:v,rotateZ:P,slerp:O,inverse:D,conjugate:U,fromMat:X,fromEuler:Y,copy:Q,clone:q,add:j,subtract:W,sub:Z,mulScalar:ue,scale:me,divScalar:ye,dot:ve,lerp:Ve,length:oe,len:xe,lengthSq:he,lenSq:Ge,normalize:we,equalsApproximately:Le,equals:Ce,identity:Ee,rotationTo:et,sqlerp:tt}}const Aa=new Map;function cd(t){let e=Aa.get(t);return e||(e=ud(t),Aa.set(t,e)),e}function ld(t){function e(d,p,w,T){const k=new t(4);return d!==void 0&&(k[0]=d,p!==void 0&&(k[1]=p,w!==void 0&&(k[2]=w,T!==void 0&&(k[3]=T)))),k}const r=e;function s(d,p,w,T,k){const u=k??new t(4);return u[0]=d,u[1]=p,u[2]=w,u[3]=T,u}function n(d,p){const w=p??new t(4);return w[0]=Math.ceil(d[0]),w[1]=Math.ceil(d[1]),w[2]=Math.ceil(d[2]),w[3]=Math.ceil(d[3]),w}function i(d,p){const w=p??new t(4);return w[0]=Math.floor(d[0]),w[1]=Math.floor(d[1]),w[2]=Math.floor(d[2]),w[3]=Math.floor(d[3]),w}function o(d,p){const w=p??new t(4);return w[0]=Math.round(d[0]),w[1]=Math.round(d[1]),w[2]=Math.round(d[2]),w[3]=Math.round(d[3]),w}function a(d,p=0,w=1,T){const k=T??new t(4);return k[0]=Math.min(w,Math.max(p,d[0])),k[1]=Math.min(w,Math.max(p,d[1])),k[2]=Math.min(w,Math.max(p,d[2])),k[3]=Math.min(w,Math.max(p,d[3])),k}function c(d,p,w){const T=w??new t(4);return T[0]=d[0]+p[0],T[1]=d[1]+p[1],T[2]=d[2]+p[2],T[3]=d[3]+p[3],T}function m(d,p,w,T){const k=T??new t(4);return k[0]=d[0]+p[0]*w,k[1]=d[1]+p[1]*w,k[2]=d[2]+p[2]*w,k[3]=d[3]+p[3]*w,k}function _(d,p,w){const T=w??new t(4);return T[0]=d[0]-p[0],T[1]=d[1]-p[1],T[2]=d[2]-p[2],T[3]=d[3]-p[3],T}const v=_;function P(d,p){return Math.abs(d[0]-p[0])<fe&&Math.abs(d[1]-p[1])<fe&&Math.abs(d[2]-p[2])<fe&&Math.abs(d[3]-p[3])<fe}function O(d,p){return d[0]===p[0]&&d[1]===p[1]&&d[2]===p[2]&&d[3]===p[3]}function D(d,p,w,T){const k=T??new t(4);return k[0]=d[0]+w*(p[0]-d[0]),k[1]=d[1]+w*(p[1]-d[1]),k[2]=d[2]+w*(p[2]-d[2]),k[3]=d[3]+w*(p[3]-d[3]),k}function U(d,p,w,T){const k=T??new t(4);return k[0]=d[0]+w[0]*(p[0]-d[0]),k[1]=d[1]+w[1]*(p[1]-d[1]),k[2]=d[2]+w[2]*(p[2]-d[2]),k[3]=d[3]+w[3]*(p[3]-d[3]),k}function X(d,p,w){const T=w??new t(4);return T[0]=Math.max(d[0],p[0]),T[1]=Math.max(d[1],p[1]),T[2]=Math.max(d[2],p[2]),T[3]=Math.max(d[3],p[3]),T}function Y(d,p,w){const T=w??new t(4);return T[0]=Math.min(d[0],p[0]),T[1]=Math.min(d[1],p[1]),T[2]=Math.min(d[2],p[2]),T[3]=Math.min(d[3],p[3]),T}function Q(d,p,w){const T=w??new t(4);return T[0]=d[0]*p,T[1]=d[1]*p,T[2]=d[2]*p,T[3]=d[3]*p,T}const q=Q;function j(d,p,w){const T=w??new t(4);return T[0]=d[0]/p,T[1]=d[1]/p,T[2]=d[2]/p,T[3]=d[3]/p,T}function W(d,p){const w=p??new t(4);return w[0]=1/d[0],w[1]=1/d[1],w[2]=1/d[2],w[3]=1/d[3],w}const Z=W;function ue(d,p){return d[0]*p[0]+d[1]*p[1]+d[2]*p[2]+d[3]*p[3]}function me(d){const p=d[0],w=d[1],T=d[2],k=d[3];return Math.sqrt(p*p+w*w+T*T+k*k)}const ye=me;function ve(d){const p=d[0],w=d[1],T=d[2],k=d[3];return p*p+w*w+T*T+k*k}const Ve=ve;function oe(d,p){const w=d[0]-p[0],T=d[1]-p[1],k=d[2]-p[2],u=d[3]-p[3];return Math.sqrt(w*w+T*T+k*k+u*u)}const xe=oe;function he(d,p){const w=d[0]-p[0],T=d[1]-p[1],k=d[2]-p[2],u=d[3]-p[3];return w*w+T*T+k*k+u*u}const Ge=he;function we(d,p){const w=p??new t(4),T=d[0],k=d[1],u=d[2],g=d[3],l=Math.sqrt(T*T+k*k+u*u+g*g);return l>1e-5?(w[0]=T/l,w[1]=k/l,w[2]=u/l,w[3]=g/l):(w[0]=0,w[1]=0,w[2]=0,w[3]=0),w}function Le(d,p){const w=p??new t(4);return w[0]=-d[0],w[1]=-d[1],w[2]=-d[2],w[3]=-d[3],w}function Ce(d,p){const w=p??new t(4);return w[0]=d[0],w[1]=d[1],w[2]=d[2],w[3]=d[3],w}const Ee=Ce;function be(d,p,w){const T=w??new t(4);return T[0]=d[0]*p[0],T[1]=d[1]*p[1],T[2]=d[2]*p[2],T[3]=d[3]*p[3],T}const Pe=be;function He(d,p,w){const T=w??new t(4);return T[0]=d[0]/p[0],T[1]=d[1]/p[1],T[2]=d[2]/p[2],T[3]=d[3]/p[3],T}const et=He;function Xe(d){const p=d??new t(4);return p[0]=0,p[1]=0,p[2]=0,p[3]=0,p}function lt(d,p,w){const T=w??new t(4),k=d[0],u=d[1],g=d[2],l=d[3];return T[0]=p[0]*k+p[4]*u+p[8]*g+p[12]*l,T[1]=p[1]*k+p[5]*u+p[9]*g+p[13]*l,T[2]=p[2]*k+p[6]*u+p[10]*g+p[14]*l,T[3]=p[3]*k+p[7]*u+p[11]*g+p[15]*l,T}function tt(d,p,w){const T=w??new t(4);return we(d,T),Q(T,p,T)}function f(d,p,w){const T=w??new t(4);return me(d)>p?tt(d,p,T):Ce(d,T)}function C(d,p,w){const T=w??new t(4);return D(d,p,.5,T)}return{create:e,fromValues:r,set:s,ceil:n,floor:i,round:o,clamp:a,add:c,addScaled:m,subtract:_,sub:v,equalsApproximately:P,equals:O,lerp:D,lerpV:U,max:X,min:Y,mulScalar:Q,scale:q,divScalar:j,inverse:W,invert:Z,dot:ue,length:me,len:ye,lengthSq:ve,lenSq:Ve,distance:oe,dist:xe,distanceSq:he,distSq:Ge,normalize:we,negate:Le,copy:Ce,clone:Ee,multiply:be,mul:Pe,divide:He,div:et,zero:Xe,transformMat4:lt,setLength:tt,truncate:f,midpoint:C}}const Ba=new Map;function dd(t){let e=Ba.get(t);return e||(e=ld(t),Ba.set(t,e)),e}function fi(t,e,r,s,n,i){return{mat3:id(t),mat4:ad(e),quat:cd(r),vec2:ya(s),vec3:Fs(n),vec4:dd(i)}}const{mat3:Us,mat4:ae,quat:ks,vec2:dt,vec3:H,vec4:as}=fi(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array);fi(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),fi(td,Array,Array,Array,Array,Array);const hd=(t,e,r)=>t+r*(e-t),fd=t=>t*Math.PI/180,hr=(t,e)=>{const r=Math.max(t,e);return 1+Math.log2(r)|0},pd=ae.identity(),md="xyz",gd=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],yd=[[0,1,0],[0,1,0],[0,0,-1],[0,0,1],[0,1,0],[0,1,0]],pi=(t,e)=>((t+e-1)/e|0)*e;function _d(t){return Object.keys(t)}function bd(t,e){return new Array(t).fill(0).map((r,s)=>e(s))}const wa=t=>t&&typeof t.length=="number"&&t.buffer instanceof ArrayBuffer&&typeof t.byteLength=="number",va=t=>t,_e=va({i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array},bool:{numElements:0,align:1,size:0,type:"bool",View:Uint32Array}}),Or=va({..._e,"atomic<i32>":_e.i32,"atomic<u32>":_e.u32,"vec2<i32>":_e.vec2i,"vec2<u32>":_e.vec2u,"vec2<f32>":_e.vec2f,"vec2<f16>":_e.vec2h,"vec3<i32>":_e.vec3i,"vec3<u32>":_e.vec3u,"vec3<f32>":_e.vec3f,"vec3<f16>":_e.vec3h,"vec4<i32>":_e.vec4i,"vec4<u32>":_e.vec4u,"vec4<f32>":_e.vec4f,"vec4<f16>":_e.vec4h,"mat2x2<f32>":_e.mat2x2f,"mat2x2<f16>":_e.mat2x2h,"mat3x2<f32>":_e.mat3x2f,"mat3x2<f16>":_e.mat3x2h,"mat4x2<f32>":_e.mat4x2f,"mat4x2<f16>":_e.mat4x2h,"mat2x3<f32>":_e.mat2x3f,"mat2x3<f16>":_e.mat2x3h,"mat3x3<f32>":_e.mat3x3f,"mat3x3<f16>":_e.mat3x3h,"mat4x3<f32>":_e.mat4x3f,"mat4x3<f16>":_e.mat4x3h,"mat2x4<f32>":_e.mat2x4f,"mat2x4<f16>":_e.mat2x4h,"mat3x4<f32>":_e.mat3x4f,"mat3x4<f16>":_e.mat3x4h,"mat4x4<f32>":_e.mat4x4f,"mat4x4<f16>":_e.mat4x4h}),xd=_d(Or);function Ad(t=[],e){const r=new Set;for(const s of xd){const n=Or[s];r.has(n)||(r.add(n),n.flatten=t.includes(s)?e:!e)}}Ad();function Bd(t){const e=t;if(e.elementType)return e.size;{const r=t,s=e.numElements||1;if(r.fields)return t.size*s;{const n=t,{align:i}=Or[n.type];return s>1?pi(t.size,i)*s:t.size}}}function Ca(t,e,r,s){const{size:n,type:i}=t;try{const{View:o,align:a}=Or[i],c=s!==void 0,m=c?pi(n,a):n,_=m/o.BYTES_PER_ELEMENT,v=c?s===0?(e.byteLength-r)/m:s:1;return new o(e,r,_*v)}catch{throw new Error(`unknown type: ${i}`)}}function wd(t){return!t.fields&&!t.elementType}function vd(t,e,r){const s=r||0,n=new ArrayBuffer(Bd(t)),i=(o,a)=>{const c=o,m=c.elementType;if(m){if(wd(m)&&Or[m.type].flatten)return Ca(m,n,a,c.numElements);{const{size:_}=Ta(o),v=c.numElements===0?(n.byteLength-a)/_:c.numElements;return bd(v,P=>i(m,a+_*P))}}else{if(typeof o=="string")throw Error("unreachable");{const _=o.fields;if(_){const v={};for(const[P,{type:O,offset:D}]of Object.entries(_))v[P]=i(O,a+D);return v}else return Ca(o,n,a)}}};return{views:i(t,s),arrayBuffer:n}}function mi(t,e){if(t!==void 0)if(wa(e)){const r=e;if(r.length===1&&typeof t=="number")r[0]=t;else if(Array.isArray(t[0])||wa(t[0])){const s=t[0].length,n=s===3?4:s;for(let i=0;i<t.length;++i){const o=i*n;r.set(t[i],o)}}else r.set(t)}else if(Array.isArray(e)){const r=e;t.forEach((s,n)=>{mi(s,r[n])})}else{const r=e;for(const[s,n]of Object.entries(t)){const i=r[s];i&&mi(n,i)}}}function Qt(t,e,r=0){const s=t,n=s.group===void 0?t:s.typeDefinition,i=vd(n,e,r);return{...i,set(o){mi(o,i.views)}}}function gi(t){const e=t.elementType;if(e)return gi(e);const r=t.fields;if(r)return Object.values(r).reduce((i,{type:o})=>Math.max(i,gi(o)),0);const{type:s}=t,{align:n}=Or[s];return n}function Ta(t){const e=t.elementType;if(e){const s=e.size,n=gi(e);return{unalignedSize:s,align:n,size:pi(s,n)}}const r=t.fields;if(r){const s=Object.values(r).pop();if(s.type.size===0)return Ta(s.type)}return{size:0,unalignedSize:0,align:1}}class Cd{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}let Ut=class{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(t){throw new Error("Cannot evaluate node")}evaluateString(t){return this.evaluate(t).toString()}search(t){}searchBlock(t,e){if(t){e(Ns.instance);for(const r of t)r instanceof Array?this.searchBlock(r,e):r.search(e);e(Vs.instance)}}};class Ns extends Ut{}Ns.instance=new Ns;class Vs extends Ut{}Vs.instance=new Vs;class Me extends Ut{constructor(){super()}}let yi=class extends Me{constructor(t,e,r,s,n,i){super(),this.calls=new Set,this.name=t,this.args=e,this.returnType=r,this.body=s,this.startLine=n,this.endLine=i}get astNodeType(){return"function"}search(t){this.searchBlock(this.body,t)}};class Td extends Me{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Sd extends Me{constructor(e,r){super(),this.condition=e,this.body=r}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Ed extends Me{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Md extends Me{constructor(e,r,s,n){super(),this.init=e,this.condition=r,this.increment=s,this.body=n}get astNodeType(){return"for"}search(e){var r,s,n;(r=this.init)===null||r===void 0||r.search(e),(s=this.condition)===null||s===void 0||s.search(e),(n=this.increment)===null||n===void 0||n.search(e),this.searchBlock(this.body,e)}}class fr extends Me{constructor(e,r,s,n,i){super(),this.name=e,this.type=r,this.storage=s,this.access=n,this.value=i}get astNodeType(){return"var"}search(e){var r;e(this),(r=this.value)===null||r===void 0||r.search(e)}}class Sa extends Me{constructor(e,r,s){super(),this.name=e,this.type=r,this.value=s}get astNodeType(){return"override"}search(e){var r;(r=this.value)===null||r===void 0||r.search(e)}}class _i extends Me{constructor(e,r,s,n,i){super(),this.name=e,this.type=r,this.storage=s,this.access=n,this.value=i}get astNodeType(){return"let"}search(e){var r;e(this),(r=this.value)===null||r===void 0||r.search(e)}}class Ea extends Me{constructor(e,r,s,n,i){super(),this.name=e,this.type=r,this.storage=s,this.access=n,this.value=i}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var r;e(this),(r=this.value)===null||r===void 0||r.search(e)}}var Dr;(function(t){t.increment="++",t.decrement="--"})(Dr||(Dr={})),function(t){function e(r){const s=r;if(s=="parse")throw new Error("Invalid value for IncrementOperator");return t[s]}t.parse=e}(Dr||(Dr={}));class Pd extends Me{constructor(e,r){super(),this.operator=e,this.variable=r}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}var us;(function(t){t.assign="=",t.addAssign="+=",t.subtractAssin="-=",t.multiplyAssign="*=",t.divideAssign="/=",t.moduloAssign="%=",t.andAssign="&=",t.orAssign="|=",t.xorAssign="^=",t.shiftLeftAssign="<<=",t.shiftRightAssign=">>="})(us||(us={})),function(t){function e(r){const s=r;if(s=="parse")throw new Error("Invalid value for AssignOperator");return s}t.parse=e}(us||(us={}));class Rd extends Me{constructor(e,r,s){super(),this.operator=e,this.variable=r,this.value=s}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Ma extends Me{constructor(e,r){super(),this.name=e,this.args=r}get astNodeType(){return"call"}search(e){for(const r of this.args)r.search(e);e(this)}}class Gd extends Me{constructor(e,r){super(),this.body=e,this.continuing=r}get astNodeType(){return"loop"}}class Ld extends Me{constructor(e,r){super(),this.condition=e,this.body=r}get astNodeType(){return"body"}}class Od extends Me{constructor(e,r,s,n){super(),this.condition=e,this.body=r,this.elseif=s,this.else=n}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Dd extends Me{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var r;(r=this.value)===null||r===void 0||r.search(e)}}class Id extends Me{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Fd extends Me{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Ud extends Me{constructor(e,r){super(),this.severity=e,this.rule=r}get astNodeType(){return"diagnostic"}}class Pa extends Me{constructor(e,r){super(),this.name=e,this.type=r}get astNodeType(){return"alias"}}class kd extends Me{constructor(){super()}get astNodeType(){return"discard"}}class Nd extends Me{constructor(){super()}get astNodeType(){return"break"}}class Vd extends Me{constructor(){super()}get astNodeType(){return"continue"}}class pr extends Me{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class mr extends pr{constructor(e,r,s,n){super(e),this.members=r,this.startLine=s,this.endLine=n}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let r=0;r<this.members.length;r++)if(this.members[r].name==e)return r;return-1}}class Ra extends pr{constructor(e,r,s){super(e),this.format=r,this.access=s}get astNodeType(){return"template"}}class Hd extends pr{constructor(e,r,s,n){super(e),this.storage=r,this.type=s,this.access=n}get astNodeType(){return"pointer"}}class Ga extends pr{constructor(e,r,s,n){super(e),this.attributes=r,this.format=s,this.count=n}get astNodeType(){return"array"}get isArray(){return!0}}class cs extends pr{constructor(e,r,s){super(e),this.format=r,this.access=s}get astNodeType(){return"sampler"}}class St extends Ut{constructor(){super()}}class La extends St{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class Ir extends St{constructor(e,r){super(),this.type=e,this.args=r}get astNodeType(){return"createExpr"}search(e){e(this);for(const r of this.args)r.search(e)}}class Oa extends St{constructor(e,r){super(),this.name=e,this.args=r}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return this.args[0].evaluate(e)*180/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}search(e){for(const r of this.args)r.search(e);e(this)}}class bi extends St{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}evaluate(e){const r=e.constants.get(this.name);if(!r)throw new Error("Cannot evaluate node");return r.evaluate(e)}}class Da extends St{constructor(e,r){super(),this.name=e,this.initializer=r}get astNodeType(){return"constExpr"}evaluate(e){var r,s;if(this.initializer instanceof Ir){const n=(r=this.postfix)===null||r===void 0?void 0:r.evaluateString(e),i=(s=this.initializer.type)===null||s===void 0?void 0:s.name,o=e.structs.get(i),a=o==null?void 0:o.getMemberIndex(n);if(a!=-1)return this.initializer.args[a].evaluate(e);console.log(a)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class Ia extends St{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class jd extends St{constructor(e,r){super(),this.type=e,this.value=r}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class zd extends St{constructor(e,r){super(),this.type=e,this.args=r}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}search(e){this.searchBlock(this.args,e)}}class Fa extends St{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class Jd extends St{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Ua extends St{constructor(){super()}}class Kd extends Ua{constructor(e,r){super(),this.operator=e,this.right=r}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class Gt extends Ua{constructor(e,r,s){super(),this.operator=e,this.left=r,this.right=s}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class ka extends Ut{constructor(){super()}}class Xd extends ka{constructor(e,r){super(),this.selector=e,this.body=r}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class Wd extends ka{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Yd extends Ut{constructor(e,r,s){super(),this.name=e,this.type=r,this.attributes=s}get astNodeType(){return"argument"}}class $d extends Ut{constructor(e,r){super(),this.condition=e,this.body=r}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Qd extends Ut{constructor(e,r,s){super(),this.name=e,this.type=r,this.attributes=s}get astNodeType(){return"member"}}class Na extends Ut{constructor(e,r){super(),this.name=e,this.value=r}get astNodeType(){return"attribute"}}var L,R;(function(t){t[t.token=0]="token",t[t.keyword=1]="keyword",t[t.reserved=2]="reserved"})(R||(R={}));class G{constructor(e,r,s){this.name=e,this.type=r,this.rule=s}toString(){return this.name}}class b{}L=b,b.none=new G("",R.reserved,""),b.eof=new G("EOF",R.token,""),b.reserved={asm:new G("asm",R.reserved,"asm"),bf16:new G("bf16",R.reserved,"bf16"),do:new G("do",R.reserved,"do"),enum:new G("enum",R.reserved,"enum"),f16:new G("f16",R.reserved,"f16"),f64:new G("f64",R.reserved,"f64"),handle:new G("handle",R.reserved,"handle"),i8:new G("i8",R.reserved,"i8"),i16:new G("i16",R.reserved,"i16"),i64:new G("i64",R.reserved,"i64"),mat:new G("mat",R.reserved,"mat"),premerge:new G("premerge",R.reserved,"premerge"),regardless:new G("regardless",R.reserved,"regardless"),typedef:new G("typedef",R.reserved,"typedef"),u8:new G("u8",R.reserved,"u8"),u16:new G("u16",R.reserved,"u16"),u64:new G("u64",R.reserved,"u64"),unless:new G("unless",R.reserved,"unless"),using:new G("using",R.reserved,"using"),vec:new G("vec",R.reserved,"vec"),void:new G("void",R.reserved,"void")},b.keywords={array:new G("array",R.keyword,"array"),atomic:new G("atomic",R.keyword,"atomic"),bool:new G("bool",R.keyword,"bool"),f32:new G("f32",R.keyword,"f32"),i32:new G("i32",R.keyword,"i32"),mat2x2:new G("mat2x2",R.keyword,"mat2x2"),mat2x3:new G("mat2x3",R.keyword,"mat2x3"),mat2x4:new G("mat2x4",R.keyword,"mat2x4"),mat3x2:new G("mat3x2",R.keyword,"mat3x2"),mat3x3:new G("mat3x3",R.keyword,"mat3x3"),mat3x4:new G("mat3x4",R.keyword,"mat3x4"),mat4x2:new G("mat4x2",R.keyword,"mat4x2"),mat4x3:new G("mat4x3",R.keyword,"mat4x3"),mat4x4:new G("mat4x4",R.keyword,"mat4x4"),ptr:new G("ptr",R.keyword,"ptr"),sampler:new G("sampler",R.keyword,"sampler"),sampler_comparison:new G("sampler_comparison",R.keyword,"sampler_comparison"),struct:new G("struct",R.keyword,"struct"),texture_1d:new G("texture_1d",R.keyword,"texture_1d"),texture_2d:new G("texture_2d",R.keyword,"texture_2d"),texture_2d_array:new G("texture_2d_array",R.keyword,"texture_2d_array"),texture_3d:new G("texture_3d",R.keyword,"texture_3d"),texture_cube:new G("texture_cube",R.keyword,"texture_cube"),texture_cube_array:new G("texture_cube_array",R.keyword,"texture_cube_array"),texture_multisampled_2d:new G("texture_multisampled_2d",R.keyword,"texture_multisampled_2d"),texture_storage_1d:new G("texture_storage_1d",R.keyword,"texture_storage_1d"),texture_storage_2d:new G("texture_storage_2d",R.keyword,"texture_storage_2d"),texture_storage_2d_array:new G("texture_storage_2d_array",R.keyword,"texture_storage_2d_array"),texture_storage_3d:new G("texture_storage_3d",R.keyword,"texture_storage_3d"),texture_depth_2d:new G("texture_depth_2d",R.keyword,"texture_depth_2d"),texture_depth_2d_array:new G("texture_depth_2d_array",R.keyword,"texture_depth_2d_array"),texture_depth_cube:new G("texture_depth_cube",R.keyword,"texture_depth_cube"),texture_depth_cube_array:new G("texture_depth_cube_array",R.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new G("texture_depth_multisampled_2d",R.keyword,"texture_depth_multisampled_2d"),texture_external:new G("texture_external",R.keyword,"texture_external"),u32:new G("u32",R.keyword,"u32"),vec2:new G("vec2",R.keyword,"vec2"),vec3:new G("vec3",R.keyword,"vec3"),vec4:new G("vec4",R.keyword,"vec4"),bitcast:new G("bitcast",R.keyword,"bitcast"),block:new G("block",R.keyword,"block"),break:new G("break",R.keyword,"break"),case:new G("case",R.keyword,"case"),continue:new G("continue",R.keyword,"continue"),continuing:new G("continuing",R.keyword,"continuing"),default:new G("default",R.keyword,"default"),diagnostic:new G("diagnostic",R.keyword,"diagnostic"),discard:new G("discard",R.keyword,"discard"),else:new G("else",R.keyword,"else"),enable:new G("enable",R.keyword,"enable"),fallthrough:new G("fallthrough",R.keyword,"fallthrough"),false:new G("false",R.keyword,"false"),fn:new G("fn",R.keyword,"fn"),for:new G("for",R.keyword,"for"),function:new G("function",R.keyword,"function"),if:new G("if",R.keyword,"if"),let:new G("let",R.keyword,"let"),const:new G("const",R.keyword,"const"),loop:new G("loop",R.keyword,"loop"),while:new G("while",R.keyword,"while"),private:new G("private",R.keyword,"private"),read:new G("read",R.keyword,"read"),read_write:new G("read_write",R.keyword,"read_write"),return:new G("return",R.keyword,"return"),requires:new G("requires",R.keyword,"requires"),storage:new G("storage",R.keyword,"storage"),switch:new G("switch",R.keyword,"switch"),true:new G("true",R.keyword,"true"),alias:new G("alias",R.keyword,"alias"),type:new G("type",R.keyword,"type"),uniform:new G("uniform",R.keyword,"uniform"),var:new G("var",R.keyword,"var"),override:new G("override",R.keyword,"override"),workgroup:new G("workgroup",R.keyword,"workgroup"),write:new G("write",R.keyword,"write"),r8unorm:new G("r8unorm",R.keyword,"r8unorm"),r8snorm:new G("r8snorm",R.keyword,"r8snorm"),r8uint:new G("r8uint",R.keyword,"r8uint"),r8sint:new G("r8sint",R.keyword,"r8sint"),r16uint:new G("r16uint",R.keyword,"r16uint"),r16sint:new G("r16sint",R.keyword,"r16sint"),r16float:new G("r16float",R.keyword,"r16float"),rg8unorm:new G("rg8unorm",R.keyword,"rg8unorm"),rg8snorm:new G("rg8snorm",R.keyword,"rg8snorm"),rg8uint:new G("rg8uint",R.keyword,"rg8uint"),rg8sint:new G("rg8sint",R.keyword,"rg8sint"),r32uint:new G("r32uint",R.keyword,"r32uint"),r32sint:new G("r32sint",R.keyword,"r32sint"),r32float:new G("r32float",R.keyword,"r32float"),rg16uint:new G("rg16uint",R.keyword,"rg16uint"),rg16sint:new G("rg16sint",R.keyword,"rg16sint"),rg16float:new G("rg16float",R.keyword,"rg16float"),rgba8unorm:new G("rgba8unorm",R.keyword,"rgba8unorm"),rgba8unorm_srgb:new G("rgba8unorm_srgb",R.keyword,"rgba8unorm_srgb"),rgba8snorm:new G("rgba8snorm",R.keyword,"rgba8snorm"),rgba8uint:new G("rgba8uint",R.keyword,"rgba8uint"),rgba8sint:new G("rgba8sint",R.keyword,"rgba8sint"),bgra8unorm:new G("bgra8unorm",R.keyword,"bgra8unorm"),bgra8unorm_srgb:new G("bgra8unorm_srgb",R.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new G("rgb10a2unorm",R.keyword,"rgb10a2unorm"),rg11b10float:new G("rg11b10float",R.keyword,"rg11b10float"),rg32uint:new G("rg32uint",R.keyword,"rg32uint"),rg32sint:new G("rg32sint",R.keyword,"rg32sint"),rg32float:new G("rg32float",R.keyword,"rg32float"),rgba16uint:new G("rgba16uint",R.keyword,"rgba16uint"),rgba16sint:new G("rgba16sint",R.keyword,"rgba16sint"),rgba16float:new G("rgba16float",R.keyword,"rgba16float"),rgba32uint:new G("rgba32uint",R.keyword,"rgba32uint"),rgba32sint:new G("rgba32sint",R.keyword,"rgba32sint"),rgba32float:new G("rgba32float",R.keyword,"rgba32float"),static_assert:new G("static_assert",R.keyword,"static_assert")},b.tokens={decimal_float_literal:new G("decimal_float_literal",R.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new G("hex_float_literal",R.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new G("int_literal",R.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new G("uint_literal",R.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new G("ident",R.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new G("and",R.token,"&"),and_and:new G("and_and",R.token,"&&"),arrow:new G("arrow ",R.token,"->"),attr:new G("attr",R.token,"@"),attr_left:new G("attr_left",R.token,"[["),attr_right:new G("attr_right",R.token,"]]"),forward_slash:new G("forward_slash",R.token,"/"),bang:new G("bang",R.token,"!"),bracket_left:new G("bracket_left",R.token,"["),bracket_right:new G("bracket_right",R.token,"]"),brace_left:new G("brace_left",R.token,"{"),brace_right:new G("brace_right",R.token,"}"),colon:new G("colon",R.token,":"),comma:new G("comma",R.token,","),equal:new G("equal",R.token,"="),equal_equal:new G("equal_equal",R.token,"=="),not_equal:new G("not_equal",R.token,"!="),greater_than:new G("greater_than",R.token,">"),greater_than_equal:new G("greater_than_equal",R.token,">="),shift_right:new G("shift_right",R.token,">>"),less_than:new G("less_than",R.token,"<"),less_than_equal:new G("less_than_equal",R.token,"<="),shift_left:new G("shift_left",R.token,"<<"),modulo:new G("modulo",R.token,"%"),minus:new G("minus",R.token,"-"),minus_minus:new G("minus_minus",R.token,"--"),period:new G("period",R.token,"."),plus:new G("plus",R.token,"+"),plus_plus:new G("plus_plus",R.token,"++"),or:new G("or",R.token,"|"),or_or:new G("or_or",R.token,"||"),paren_left:new G("paren_left",R.token,"("),paren_right:new G("paren_right",R.token,")"),semicolon:new G("semicolon",R.token,";"),star:new G("star",R.token,"*"),tilde:new G("tilde",R.token,"~"),underscore:new G("underscore",R.token,"_"),xor:new G("xor",R.token,"^"),plus_equal:new G("plus_equal",R.token,"+="),minus_equal:new G("minus_equal",R.token,"-="),times_equal:new G("times_equal",R.token,"*="),division_equal:new G("division_equal",R.token,"/="),modulo_equal:new G("modulo_equal",R.token,"%="),and_equal:new G("and_equal",R.token,"&="),or_equal:new G("or_equal",R.token,"|="),xor_equal:new G("xor_equal",R.token,"^="),shift_right_equal:new G("shift_right_equal",R.token,">>="),shift_left_equal:new G("shift_left_equal",R.token,"<<=")},b.simpleTokens={"@":L.tokens.attr,"{":L.tokens.brace_left,"}":L.tokens.brace_right,":":L.tokens.colon,",":L.tokens.comma,"(":L.tokens.paren_left,")":L.tokens.paren_right,";":L.tokens.semicolon},b.literalTokens={"&":L.tokens.and,"&&":L.tokens.and_and,"->":L.tokens.arrow,"[[":L.tokens.attr_left,"]]":L.tokens.attr_right,"/":L.tokens.forward_slash,"!":L.tokens.bang,"[":L.tokens.bracket_left,"]":L.tokens.bracket_right,"=":L.tokens.equal,"==":L.tokens.equal_equal,"!=":L.tokens.not_equal,">":L.tokens.greater_than,">=":L.tokens.greater_than_equal,">>":L.tokens.shift_right,"<":L.tokens.less_than,"<=":L.tokens.less_than_equal,"<<":L.tokens.shift_left,"%":L.tokens.modulo,"-":L.tokens.minus,"--":L.tokens.minus_minus,".":L.tokens.period,"+":L.tokens.plus,"++":L.tokens.plus_plus,"|":L.tokens.or,"||":L.tokens.or_or,"*":L.tokens.star,"~":L.tokens.tilde,_:L.tokens.underscore,"^":L.tokens.xor,"+=":L.tokens.plus_equal,"-=":L.tokens.minus_equal,"*=":L.tokens.times_equal,"/=":L.tokens.division_equal,"%=":L.tokens.modulo_equal,"&=":L.tokens.and_equal,"|=":L.tokens.or_equal,"^=":L.tokens.xor_equal,">>=":L.tokens.shift_right_equal,"<<=":L.tokens.shift_left_equal},b.regexTokens={decimal_float_literal:L.tokens.decimal_float_literal,hex_float_literal:L.tokens.hex_float_literal,int_literal:L.tokens.int_literal,uint_literal:L.tokens.uint_literal,ident:L.tokens.ident},b.storage_class=[L.keywords.function,L.keywords.private,L.keywords.workgroup,L.keywords.uniform,L.keywords.storage],b.access_mode=[L.keywords.read,L.keywords.write,L.keywords.read_write],b.sampler_type=[L.keywords.sampler,L.keywords.sampler_comparison],b.sampled_texture_type=[L.keywords.texture_1d,L.keywords.texture_2d,L.keywords.texture_2d_array,L.keywords.texture_3d,L.keywords.texture_cube,L.keywords.texture_cube_array],b.multisampled_texture_type=[L.keywords.texture_multisampled_2d],b.storage_texture_type=[L.keywords.texture_storage_1d,L.keywords.texture_storage_2d,L.keywords.texture_storage_2d_array,L.keywords.texture_storage_3d],b.depth_texture_type=[L.keywords.texture_depth_2d,L.keywords.texture_depth_2d_array,L.keywords.texture_depth_cube,L.keywords.texture_depth_cube_array,L.keywords.texture_depth_multisampled_2d],b.texture_external_type=[L.keywords.texture_external],b.any_texture_type=[...L.sampled_texture_type,...L.multisampled_texture_type,...L.storage_texture_type,...L.depth_texture_type,...L.texture_external_type],b.texel_format=[L.keywords.r8unorm,L.keywords.r8snorm,L.keywords.r8uint,L.keywords.r8sint,L.keywords.r16uint,L.keywords.r16sint,L.keywords.r16float,L.keywords.rg8unorm,L.keywords.rg8snorm,L.keywords.rg8uint,L.keywords.rg8sint,L.keywords.r32uint,L.keywords.r32sint,L.keywords.r32float,L.keywords.rg16uint,L.keywords.rg16sint,L.keywords.rg16float,L.keywords.rgba8unorm,L.keywords.rgba8unorm_srgb,L.keywords.rgba8snorm,L.keywords.rgba8uint,L.keywords.rgba8sint,L.keywords.bgra8unorm,L.keywords.bgra8unorm_srgb,L.keywords.rgb10a2unorm,L.keywords.rg11b10float,L.keywords.rg32uint,L.keywords.rg32sint,L.keywords.rg32float,L.keywords.rgba16uint,L.keywords.rgba16sint,L.keywords.rgba16float,L.keywords.rgba32uint,L.keywords.rgba32sint,L.keywords.rgba32float],b.const_literal=[L.tokens.int_literal,L.tokens.uint_literal,L.tokens.decimal_float_literal,L.tokens.hex_float_literal,L.keywords.true,L.keywords.false],b.literal_or_ident=[L.tokens.ident,L.tokens.int_literal,L.tokens.uint_literal,L.tokens.decimal_float_literal,L.tokens.hex_float_literal],b.element_count_expression=[L.tokens.int_literal,L.tokens.uint_literal,L.tokens.ident],b.template_types=[L.keywords.vec2,L.keywords.vec3,L.keywords.vec4,L.keywords.mat2x2,L.keywords.mat2x3,L.keywords.mat2x4,L.keywords.mat3x2,L.keywords.mat3x3,L.keywords.mat3x4,L.keywords.mat4x2,L.keywords.mat4x3,L.keywords.mat4x4,L.keywords.atomic,L.keywords.bitcast,...L.any_texture_type],b.attribute_name=[L.tokens.ident,L.keywords.block,L.keywords.diagnostic],b.assignment_operators=[L.tokens.equal,L.tokens.plus_equal,L.tokens.minus_equal,L.tokens.times_equal,L.tokens.division_equal,L.tokens.modulo_equal,L.tokens.and_equal,L.tokens.or_equal,L.tokens.xor_equal,L.tokens.shift_right_equal,L.tokens.shift_left_equal],b.increment_operators=[L.tokens.plus_plus,L.tokens.minus_minus];class Va{constructor(e,r,s){this.type=e,this.lexeme=r,this.line=s}toString(){return this.lexeme}isTemplateType(){return b.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==b.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class qd{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Va(b.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}else if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const r=b.simpleTokens[e];if(r)return this._addToken(r),!0;let s=b.none;const n=this._isAlpha(e),i=e==="_";if(this._isAlphaNumeric(e)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)e+=this._advance(),o=this._peekAhead()}if(n){const o=b.keywords[e];if(o)return this._addToken(o),!0}if(n||i)return this._addToken(b.tokens.ident),!0;for(;;){let o=this._findType(e);const a=this._peekAhead();if(e==">"&&(a==">"||a=="=")){let c=!1,m=this._tokens.length-1;for(let _=0;_<5&&m>=0;++_,--m)if(this._tokens[m].type===b.tokens.less_than){m>0&&this._tokens[m-1].isArrayOrTemplateType()&&(c=!0);break}if(c)return this._addToken(o),!0}if(o===b.none){let c=e,m=0;const _=2;for(let v=0;v<_;++v)if(c+=this._peekAhead(v),o=this._findType(c),o!==b.none){m=v;break}if(o===b.none)return s===b.none?!1:(this._current--,this._addToken(s),!0);e=c,this._current+=m+1}if(s=o,this._isAtEnd())break;e+=this._advance()}return s===b.none?!1:(this._addToken(s),!0)}_findType(e){for(const s in b.regexTokens){const n=b.regexTokens[s];if(this._match(e,n.rule))return n}return b.literalTokens[e]||b.none}_match(e,r){const s=r.exec(e);return s&&s.index==0&&s[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e=="_"||e>="0"&&e<="9"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let r=this._source[this._current];return e=e||0,e++,this._current+=e,r}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const r=this._source.substring(this._start,this._current);this._tokens.push(new Va(e,r,this._line))}}class Zd{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new Cd,this._deferArrayCountEval=[]}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const r=[];for(;!this._isAtEnd();){const s=this._global_decl_or_directive();if(!s)break;r.push(s)}if(this._deferArrayCountEval.length>0){for(const s of this._deferArrayCountEval){const n=s.arrayType,i=s.countNode;if(i instanceof bi){const o=i.name,a=this._context.constants.get(o);if(a)try{const c=a.evaluate(this._context);n.count=c}catch{}}}this._deferArrayCountEval.length=0}return r}_initialize(e){if(e)if(typeof e=="string"){const r=new qd(e);this._tokens=r.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,r){return{token:e,message:r,toString:function(){return`${r}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==b.eof}_match(e){if(e instanceof G)return this._check(e)?(this._advance(),!0):!1;for(let r=0,s=e.length;r<s;++r){const n=e[r];if(this._check(n))return this._advance(),!0}return!1}_consume(e,r){if(this._check(e))return this._advance();throw this._error(this._peek(),r)}_check(e){if(this._isAtEnd())return!1;const r=this._peek();if(e instanceof Array){const s=r.type;return e.indexOf(s)!=-1}return r.type==e}_advance(){var e,r;return this._currentLine=(r=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&r!==void 0?r:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(b.tokens.semicolon)&&!this._isAtEnd(););if(this._match(b.keywords.alias)){const r=this._type_alias();return this._consume(b.tokens.semicolon,"Expected ';'"),r}if(this._match(b.keywords.diagnostic)){const r=this._diagnostic();return this._consume(b.tokens.semicolon,"Expected ';'"),r}if(this._match(b.keywords.requires)){const r=this._requires_directive();return this._consume(b.tokens.semicolon,"Expected ';'"),r}if(this._match(b.keywords.enable)){const r=this._enable_directive();return this._consume(b.tokens.semicolon,"Expected ';'"),r}const e=this._attribute();if(this._check(b.keywords.var)){const r=this._global_variable_decl();return r!=null&&(r.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),r}if(this._check(b.keywords.override)){const r=this._override_variable_decl();return r!=null&&(r.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),r}if(this._check(b.keywords.let)){const r=this._global_let_decl();return r!=null&&(r.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),r}if(this._check(b.keywords.const)){const r=this._global_const_decl();return r!=null&&(r.attributes=e),this._consume(b.tokens.semicolon,"Expected ';'."),r}if(this._check(b.keywords.struct)){const r=this._struct_decl();return r!=null&&(r.attributes=e),r}if(this._check(b.keywords.fn)){const r=this._function_decl();return r!=null&&(r.attributes=e),r}return null}_function_decl(){if(!this._match(b.keywords.fn))return null;const e=this._currentLine,r=this._consume(b.tokens.ident,"Expected function name.").toString();this._consume(b.tokens.paren_left,"Expected '(' for function arguments.");const s=[];if(!this._check(b.tokens.paren_right))do{if(this._check(b.tokens.paren_right))break;const a=this._attribute(),c=this._consume(b.tokens.ident,"Expected argument name.").toString();this._consume(b.tokens.colon,"Expected ':' for argument type.");const m=this._attribute(),_=this._type_decl();_!=null&&(_.attributes=m,s.push(new Yd(c,_,a)))}while(this._match(b.tokens.comma));this._consume(b.tokens.paren_right,"Expected ')' after function arguments.");let n=null;if(this._match(b.tokens.arrow)){const a=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=a)}const i=this._compound_statement(),o=this._currentLine;return new yi(r,s,n,i,e,o)}_compound_statement(){const e=[];for(this._consume(b.tokens.brace_left,"Expected '{' for block.");!this._check(b.tokens.brace_right);){const r=this._statement();r!==null&&e.push(r)}return this._consume(b.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(b.tokens.semicolon)&&!this._isAtEnd(););if(this._check(b.tokens.attr)&&this._attribute(),this._check(b.keywords.if))return this._if_statement();if(this._check(b.keywords.switch))return this._switch_statement();if(this._check(b.keywords.loop))return this._loop_statement();if(this._check(b.keywords.for))return this._for_statement();if(this._check(b.keywords.while))return this._while_statement();if(this._check(b.keywords.continuing))return this._continuing_statement();if(this._check(b.keywords.static_assert))return this._static_assert_statement();if(this._check(b.tokens.brace_left))return this._compound_statement();let e=null;return this._check(b.keywords.return)?e=this._return_statement():this._check([b.keywords.var,b.keywords.let,b.keywords.const])?e=this._variable_statement():this._match(b.keywords.discard)?e=new kd:this._match(b.keywords.break)?e=new Nd:this._match(b.keywords.continue)?e=new Vd:e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),e!=null&&this._consume(b.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(b.keywords.static_assert))return null;const e=this._optional_paren_expression();return new Td(e)}_while_statement(){if(!this._match(b.keywords.while))return null;const e=this._optional_paren_expression();this._check(b.tokens.attr)&&this._attribute();const r=this._compound_statement();return new Sd(e,r)}_continuing_statement(){if(!this._match(b.keywords.continuing))return null;const e=this._compound_statement();return new Ed(e)}_for_statement(){if(!this._match(b.keywords.for))return null;this._consume(b.tokens.paren_left,"Expected '('.");const e=this._check(b.tokens.semicolon)?null:this._for_init();this._consume(b.tokens.semicolon,"Expected ';'.");const r=this._check(b.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(b.tokens.semicolon,"Expected ';'.");const s=this._check(b.tokens.paren_right)?null:this._for_increment();this._consume(b.tokens.paren_right,"Expected ')'."),this._check(b.tokens.attr)&&this._attribute();const n=this._compound_statement();return new Md(e,r,s,n)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(b.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let r=null;return this._match(b.tokens.equal)&&(r=this._short_circuit_or_expression()),new fr(e.name,e.type,e.storage,e.access,r)}if(this._match(b.keywords.let)){const e=this._consume(b.tokens.ident,"Expected name for let.").toString();let r=null;if(this._match(b.tokens.colon)){const n=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=n)}this._consume(b.tokens.equal,"Expected '=' for let.");const s=this._short_circuit_or_expression();return new _i(e,r,null,null,s)}if(this._match(b.keywords.const)){const e=this._consume(b.tokens.ident,"Expected name for const.").toString();let r=null;if(this._match(b.tokens.colon)){const n=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=n)}this._consume(b.tokens.equal,"Expected '=' for const.");const s=this._short_circuit_or_expression();return new Ea(e,r,null,null,s)}return null}_increment_decrement_statement(){const e=this._current,r=this._unary_expression();if(r==null)return null;if(!this._check(b.increment_operators))return this._current=e,null;const s=this._consume(b.increment_operators,"Expected increment operator");return new Pd(s.type===b.tokens.plus_plus?Dr.increment:Dr.decrement,r)}_assignment_statement(){let e=null;if(this._check(b.tokens.brace_right))return null;let r=this._match(b.tokens.underscore);if(r||(e=this._unary_expression()),!r&&e==null)return null;const s=this._consume(b.assignment_operators,"Expected assignment operator."),n=this._short_circuit_or_expression();return new Rd(us.parse(s.lexeme),e,n)}_func_call_statement(){if(!this._check(b.tokens.ident))return null;const e=this._current,r=this._consume(b.tokens.ident,"Expected function name."),s=this._argument_expression_list();return s===null?(this._current=e,null):new Ma(r.lexeme,s)}_loop_statement(){if(!this._match(b.keywords.loop))return null;this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Expected '{' for loop.");const e=[];let r=this._statement();for(;r!==null;){if(Array.isArray(r))for(let n of r)e.push(n);else e.push(r);r=this._statement()}let s=null;return this._match(b.keywords.continuing)&&(s=this._compound_statement()),this._consume(b.tokens.brace_right,"Expected '}' for loop."),new Gd(e,s)}_switch_statement(){if(!this._match(b.keywords.switch))return null;const e=this._optional_paren_expression();this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Expected '{' for switch.");const r=this._switch_body();if(r==null||r.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(b.tokens.brace_right,"Expected '}' for switch."),new Ld(e,r)}_switch_body(){const e=[];if(this._match(b.keywords.case)){const r=this._case_selectors();this._match(b.tokens.colon),this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Exected '{' for switch case.");const s=this._case_body();this._consume(b.tokens.brace_right,"Exected '}' for switch case."),e.push(new Xd(r,s))}if(this._match(b.keywords.default)){this._match(b.tokens.colon),this._check(b.tokens.attr)&&this._attribute(),this._consume(b.tokens.brace_left,"Exected '{' for switch default.");const r=this._case_body();this._consume(b.tokens.brace_right,"Exected '}' for switch default."),e.push(new Wd(r))}if(this._check([b.keywords.default,b.keywords.case])){const r=this._switch_body();e.push(r[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(b.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(b.keywords.fallthrough))return this._consume(b.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const r=this._case_body();return r.length==0?e:[...e,r[0]]}_if_statement(){if(!this._match(b.keywords.if))return null;const e=this._optional_paren_expression();this._check(b.tokens.attr)&&this._attribute();const r=this._compound_statement();let s=[];this._match_elseif()&&(this._check(b.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let n=null;return this._match(b.keywords.else)&&(this._check(b.tokens.attr)&&this._attribute(),n=this._compound_statement()),new Od(e,r,s,n)}_match_elseif(){return this._tokens[this._current].type===b.keywords.else&&this._tokens[this._current+1].type===b.keywords.if?(this._advance(),this._advance(),!0):!1}_elseif_statement(e=[]){const r=this._optional_paren_expression(),s=this._compound_statement();return e.push(new $d(r,s)),this._match_elseif()&&(this._check(b.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(b.keywords.return))return null;const e=this._short_circuit_or_expression();return new Dd(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(b.tokens.or_or);)e=new Gt(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(b.tokens.and_and);)e=new Gt(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(b.tokens.or);)e=new Gt(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(b.tokens.xor);)e=new Gt(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(b.tokens.and);)e=new Gt(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([b.tokens.equal_equal,b.tokens.not_equal])?new Gt(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([b.tokens.less_than,b.tokens.greater_than,b.tokens.less_than_equal,b.tokens.greater_than_equal]);)e=new Gt(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([b.tokens.shift_left,b.tokens.shift_right]);)e=new Gt(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([b.tokens.plus,b.tokens.minus]);)e=new Gt(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([b.tokens.star,b.tokens.forward_slash,b.tokens.modulo]);)e=new Gt(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([b.tokens.minus,b.tokens.bang,b.tokens.tilde,b.tokens.star,b.tokens.and])?new Kd(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),r=this._postfix_expression();return r&&(e.postfix=r),e}_postfix_expression(){if(this._match(b.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(b.tokens.bracket_right,"Expected ']'.");const r=new Jd(e),s=this._postfix_expression();return s&&(r.postfix=s),r}if(this._match(b.tokens.period)){const e=this._consume(b.tokens.ident,"Expected member name."),r=this._postfix_expression(),s=new La(e.lexeme);return r&&(s.postfix=r),s}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(b.tokens.ident)){const s=this._previous().toString();if(this._check(b.tokens.paren_left)){const n=this._argument_expression_list(),i=this._getStruct(s);return i!=null?new Ir(i,n):new Oa(s,n)}if(this._context.constants.has(s)){const n=this._context.constants.get(s);return new Da(s,n.value)}return new bi(s)}if(this._match(b.const_literal))return new Ia(parseFloat(this._previous().toString()));if(this._check(b.tokens.paren_left))return this._paren_expression();if(this._match(b.keywords.bitcast)){this._consume(b.tokens.less_than,"Expected '<'.");const s=this._type_decl();this._consume(b.tokens.greater_than,"Expected '>'.");const n=this._paren_expression();return new jd(s,n)}const e=this._type_decl(),r=this._argument_expression_list();return new zd(e,r)}_argument_expression_list(){if(!this._match(b.tokens.paren_left))return null;const e=[];do{if(this._check(b.tokens.paren_right))break;const r=this._short_circuit_or_expression();e.push(r)}while(this._match(b.tokens.comma));return this._consume(b.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(b.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(b.tokens.paren_right),new Fa([e])}_paren_expression(){this._consume(b.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(b.tokens.paren_right,"Expected ')'."),new Fa([e])}_struct_decl(){if(!this._match(b.keywords.struct))return null;const e=this._currentLine,r=this._consume(b.tokens.ident,"Expected name for struct.").toString();this._consume(b.tokens.brace_left,"Expected '{' for struct body.");const s=[];for(;!this._check(b.tokens.brace_right);){const o=this._attribute(),a=this._consume(b.tokens.ident,"Expected variable name.").toString();this._consume(b.tokens.colon,"Expected ':' for struct member type.");const c=this._attribute(),m=this._type_decl();m!=null&&(m.attributes=c),this._check(b.tokens.brace_right)?this._match(b.tokens.comma):this._consume(b.tokens.comma,"Expected ',' for struct member."),s.push(new Qd(a,m,o))}this._consume(b.tokens.brace_right,"Expected '}' after struct body.");const n=this._currentLine,i=new mr(r,s,e,n);return this._context.structs.set(r,i),i}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(b.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(b.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(b.keywords.const))return null;const e=this._consume(b.tokens.ident,"Expected variable name");let r=null;if(this._match(b.tokens.colon)){const i=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=i)}let s=null;if(this._match(b.tokens.equal)){const i=this._short_circuit_or_expression();if(i instanceof Ir)s=i;else if(i instanceof Da&&i.initializer instanceof Ir)s=i.initializer;else try{const o=i.evaluate(this._context);s=new Ia(o)}catch{s=i}}const n=new Ea(e.toString(),r,"","",s);return this._context.constants.set(n.name,n),n}_global_let_decl(){if(!this._match(b.keywords.let))return null;const e=this._consume(b.tokens.ident,"Expected variable name");let r=null;if(this._match(b.tokens.colon)){const n=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=n)}let s=null;return this._match(b.tokens.equal)&&(s=this._const_expression()),new _i(e.toString(),r,"","",s)}_const_expression(){if(this._match(b.const_literal))return new La(this._previous().toString());const e=this._type_decl();this._consume(b.tokens.paren_left,"Expected '('.");let r=[];for(;!this._check(b.tokens.paren_right)&&(r.push(this._const_expression()),!!this._check(b.tokens.comma));)this._advance();return this._consume(b.tokens.paren_right,"Expected ')'."),new Ir(e,r)}_variable_decl(){if(!this._match(b.keywords.var))return null;let e="",r="";this._match(b.tokens.less_than)&&(e=this._consume(b.storage_class,"Expected storage_class.").toString(),this._match(b.tokens.comma)&&(r=this._consume(b.access_mode,"Expected access_mode.").toString()),this._consume(b.tokens.greater_than,"Expected '>'."));const s=this._consume(b.tokens.ident,"Expected variable name");let n=null;if(this._match(b.tokens.colon)){const i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}return new fr(s.toString(),n,e,r,null)}_override_decl(){if(!this._match(b.keywords.override))return null;const e=this._consume(b.tokens.ident,"Expected variable name");let r=null;if(this._match(b.tokens.colon)){const s=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=s)}return new Sa(e.toString(),r,null)}_diagnostic(){this._consume(b.tokens.paren_left,"Expected '('");const e=this._consume(b.tokens.ident,"Expected severity control name.");this._consume(b.tokens.comma,"Expected ','");const r=this._consume(b.tokens.ident,"Expected diagnostic rule name.");return this._consume(b.tokens.paren_right,"Expected ')'"),new Ud(e.toString(),r.toString())}_enable_directive(){const e=this._consume(b.tokens.ident,"identity expected.");return new Id(e.toString())}_requires_directive(){const e=[this._consume(b.tokens.ident,"identity expected.").toString()];for(;this._match(b.tokens.comma);){const r=this._consume(b.tokens.ident,"identity expected.");e.push(r.toString())}return new Fd(e)}_type_alias(){const e=this._consume(b.tokens.ident,"identity expected.");this._consume(b.tokens.equal,"Expected '=' for type alias.");let r=this._type_decl();if(r===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);const s=new Pa(e.toString(),r);return this._context.aliases.set(s.name,s),s}_type_decl(){if(this._check([b.tokens.ident,...b.texel_format,b.keywords.bool,b.keywords.f32,b.keywords.i32,b.keywords.u32])){const s=this._advance(),n=s.toString();return this._context.structs.has(n)?this._context.structs.get(n):this._context.aliases.has(n)?this._context.aliases.get(n).type:new pr(s.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(b.template_types)){let s=this._advance().toString(),n=null,i=null;return this._match(b.tokens.less_than)&&(n=this._type_decl(),i=null,this._match(b.tokens.comma)&&(i=this._consume(b.access_mode,"Expected access_mode for pointer").toString()),this._consume(b.tokens.greater_than,"Expected '>' for type.")),new Ra(s,n,i)}if(this._match(b.keywords.ptr)){let s=this._previous().toString();this._consume(b.tokens.less_than,"Expected '<' for pointer.");const n=this._consume(b.storage_class,"Expected storage_class for pointer");this._consume(b.tokens.comma,"Expected ',' for pointer.");const i=this._type_decl();let o=null;return this._match(b.tokens.comma)&&(o=this._consume(b.access_mode,"Expected access_mode for pointer").toString()),this._consume(b.tokens.greater_than,"Expected '>' for pointer."),new Hd(s,n.toString(),i,o)}const r=this._attribute();if(this._match(b.keywords.array)){let s=null,n=-1;const i=this._previous();let o=null;if(this._match(b.tokens.less_than)){s=this._type_decl(),this._context.aliases.has(s.name)&&(s=this._context.aliases.get(s.name).type);let c="";if(this._match(b.tokens.comma)){o=this._shift_expression();try{c=o.evaluate(this._context).toString(),o=null}catch{c="1"}}this._consume(b.tokens.greater_than,"Expected '>' for array."),n=c?parseInt(c):0}const a=new Ga(i.toString(),r,s,n);return o&&this._deferArrayCountEval.push({arrayType:a,countNode:o}),a}return null}_texture_sampler_types(){if(this._match(b.sampler_type))return new cs(this._previous().toString(),null,null);if(this._match(b.depth_texture_type))return new cs(this._previous().toString(),null,null);if(this._match(b.sampled_texture_type)||this._match(b.multisampled_texture_type)){const e=this._previous();this._consume(b.tokens.less_than,"Expected '<' for sampler type.");const r=this._type_decl();return this._consume(b.tokens.greater_than,"Expected '>' for sampler type."),new cs(e.toString(),r,null)}if(this._match(b.storage_texture_type)){const e=this._previous();this._consume(b.tokens.less_than,"Expected '<' for sampler type.");const r=this._consume(b.texel_format,"Invalid texel format.").toString();this._consume(b.tokens.comma,"Expected ',' after texel format.");const s=this._consume(b.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(b.tokens.greater_than,"Expected '>' for sampler type."),new cs(e.toString(),r,s)}return null}_attribute(){let e=[];for(;this._match(b.tokens.attr);){const r=this._consume(b.attribute_name,"Expected attribute name"),s=new Na(r.toString(),null);if(this._match(b.tokens.paren_left)){if(s.value=this._consume(b.literal_or_ident,"Expected attribute value").toString(),this._check(b.tokens.comma)){this._advance();do{const n=this._consume(b.literal_or_ident,"Expected attribute value").toString();s.value instanceof Array||(s.value=[s.value]),s.value.push(n)}while(this._match(b.tokens.comma))}this._consume(b.tokens.paren_right,"Expected ')'")}e.push(s)}for(;this._match(b.tokens.attr_left);){if(!this._check(b.tokens.attr_right))do{const r=this._consume(b.attribute_name,"Expected attribute name"),s=new Na(r.toString(),null);if(this._match(b.tokens.paren_left)){if(s.value=[this._consume(b.literal_or_ident,"Expected attribute value").toString()],this._check(b.tokens.comma)){this._advance();do{const n=this._consume(b.literal_or_ident,"Expected attribute value").toString();s.value.push(n)}while(this._match(b.tokens.comma))}this._consume(b.tokens.paren_right,"Expected ')'")}e.push(s)}while(this._match(b.tokens.comma));this._consume(b.tokens.attr_right,"Expected ']]' after attribute declarations")}return e.length==0?null:e}}class Fr{constructor(e,r){this.name=e,this.attributes=r,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class Ha{constructor(e,r,s){this.name=e,this.type=r,this.attributes=s,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Hs extends Fr{constructor(e,r){super(e,r),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class xi extends Fr{constructor(e,r){super(e,r),this.count=0,this.stride=0}get isArray(){return!0}}class ja extends Fr{constructor(e,r,s,n){super(e,s),this.format=r,this.access=n}get isTemplate(){return!0}}var ke;(function(t){t[t.Uniform=0]="Uniform",t[t.Storage=1]="Storage",t[t.Texture=2]="Texture",t[t.Sampler=3]="Sampler",t[t.StorageTexture=4]="StorageTexture"})(ke||(ke={}));class js{constructor(e,r,s,n,i,o,a){this.name=e,this.type=r,this.group=s,this.binding=n,this.attributes=i,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class eh{constructor(e,r){this.name=e,this.type=r}}class zs{constructor(e,r){this.align=e,this.size=r}}class th{constructor(e,r,s,n){this.name=e,this.type=r,this.locationType=s,this.location=n,this.interpolation=null}}class za{constructor(e,r,s,n){this.name=e,this.type=r,this.locationType=s,this.location=n}}class rh{constructor(e,r=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=r}}class sh{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class nh{constructor(e,r,s,n){this.name=e,this.type=r,this.attributes=s,this.id=n}}class ih{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class kt{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new sh,this.functions=[],this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}update(e){const r=new Zd().parse(e);for(const s of r)s instanceof yi&&this._functions.set(s.name,new ih(s));for(const s of r)if(s instanceof mr){const n=this._getTypeInfo(s,null);n instanceof Hs&&this.structs.push(n)}for(const s of r){if(s instanceof Pa){this.aliases.push(this._getAliasInfo(s));continue}if(s instanceof Sa){const n=s,i=this._getAttributeNum(n.attributes,"id",0),o=n.type!=null?this._getTypeInfo(n.type,n.attributes):null;this.overrides.push(new nh(n.name,o,n.attributes,i));continue}if(this._isUniformVar(s)){const n=s,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),a=this._getTypeInfo(n.type,n.attributes),c=new js(n.name,a,i,o,n.attributes,ke.Uniform,n.access);this.uniforms.push(c);continue}if(this._isStorageVar(s)){const n=s,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),a=this._getTypeInfo(n.type,n.attributes),c=this._isStorageTexture(a),m=new js(n.name,a,i,o,n.attributes,c?ke.StorageTexture:ke.Storage,n.access);this.storage.push(m);continue}if(this._isTextureVar(s)){const n=s,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),a=this._getTypeInfo(n.type,n.attributes),c=this._isStorageTexture(a),m=new js(n.name,a,i,o,n.attributes,c?ke.StorageTexture:ke.Texture,n.access);c?this.storage.push(m):this.textures.push(m);continue}if(this._isSamplerVar(s)){const n=s,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),a=this._getTypeInfo(n.type,n.attributes),c=new js(n.name,a,i,o,n.attributes,ke.Sampler,n.access);this.samplers.push(c);continue}if(s instanceof yi){const n=this._getAttribute(s,"vertex"),i=this._getAttribute(s,"fragment"),o=this._getAttribute(s,"compute"),a=n||i||o,c=new rh(s.name,a==null?void 0:a.name);c.startLine=s.startLine,c.endLine=s.endLine,this.functions.push(c),this._functions.get(s.name).info=c,a&&(this._functions.get(s.name).inUse=!0,c.inUse=!0,c.resources=this._findResources(s,!!a),c.inputs=this._getInputs(s.args),c.outputs=this._getOutputs(s.returnType),this.entry[a.name].push(c));continue}}for(const s of this._functions.values())s.info&&(s.info.inUse=s.inUse,this._addCalls(s.node,s.info.calls));for(const s of this.uniforms)this._markStructsInUse(s.type);for(const s of this.storage)this._markStructsInUse(s.type)}_markStructsInUse(e){if(e.isStruct){e.inUse=!0;for(const r of e.members)this._markStructsInUse(r.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)this._markStructsInUse(e.format);else{const r=this._getAlias(e.name);r&&this._markStructsInUse(r)}}_addCalls(e,r){var s;for(const n of e.calls){const i=(s=this._functions.get(n.name))===null||s===void 0?void 0:s.info;i&&r.add(i)}}findResource(e,r){for(const s of this.uniforms)if(s.group==e&&s.binding==r)return s;for(const s of this.storage)if(s.group==e&&s.binding==r)return s;for(const s of this.textures)if(s.group==e&&s.binding==r)return s;for(const s of this.samplers)if(s.group==e&&s.binding==r)return s;return null}_findResource(e){for(const r of this.uniforms)if(r.name==e)return r;for(const r of this.storage)if(r.name==e)return r;for(const r of this.textures)if(r.name==e)return r;for(const r of this.samplers)if(r.name==e)return r;return null}_markStructsFromAST(e){const r=this._getTypeInfo(e,null);this._markStructsInUse(r)}_findResources(e,r){const s=[],n=this,i=[];return e.search(o=>{if(o instanceof Ns)i.push({});else if(o instanceof Vs)i.pop();else if(o instanceof fr){const a=o;r&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof Ir){const a=o;r&&a.type!==null&&this._markStructsFromAST(a.type)}else if(o instanceof _i){const a=o;r&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof bi){const a=o;if(i.length>0&&i[i.length-1][a.name])return;const c=n._findResource(a.name);c&&s.push(c)}else if(o instanceof Oa){const a=o,c=n._functions.get(a.name);c&&(r&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=n._findResources(c.node,r)),s.push(...c.resources))}else if(o instanceof Ma){const a=o,c=n._functions.get(a.name);c&&(r&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=n._findResources(c.node,r)),s.push(...c.resources))}}),[...new Map(s.map(o=>[o.name,o])).values()]}getBindGroups(){const e=[];function r(s,n){s>=e.length&&(e.length=s+1),e[s]===void 0&&(e[s]=[]),n>=e[s].length&&(e[s].length=n+1)}for(const s of this.uniforms){r(s.group,s.binding);const n=e[s.group];n[s.binding]=s}for(const s of this.storage){r(s.group,s.binding);const n=e[s.group];n[s.binding]=s}for(const s of this.textures){r(s.group,s.binding);const n=e[s.group];n[s.binding]=s}for(const s of this.samplers){r(s.group,s.binding);const n=e[s.group];n[s.binding]=s}return e}_getOutputs(e,r=void 0){if(r===void 0&&(r=[]),e instanceof mr)this._getStructOutputs(e,r);else{const s=this._getOutputInfo(e);s!==null&&r.push(s)}return r}_getStructOutputs(e,r){for(const s of e.members)if(s.type instanceof mr)this._getStructOutputs(s.type,r);else{const n=this._getAttribute(s,"location")||this._getAttribute(s,"builtin");if(n!==null){const i=this._getTypeInfo(s.type,s.type.attributes),o=this._parseInt(n.value),a=new za(s.name,i,n.name,o);r.push(a)}}}_getOutputInfo(e){const r=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(r!==null){const s=this._getTypeInfo(e,e.attributes),n=this._parseInt(r.value);return new za("",s,r.name,n)}return null}_getInputs(e,r=void 0){r===void 0&&(r=[]);for(const s of e)if(s.type instanceof mr)this._getStructInputs(s.type,r);else{const n=this._getInputInfo(s);n!==null&&r.push(n)}return r}_getStructInputs(e,r){for(const s of e.members)if(s.type instanceof mr)this._getStructInputs(s.type,r);else{const n=this._getInputInfo(s);n!==null&&r.push(n)}}_getInputInfo(e){const r=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(r!==null){const s=this._getAttribute(e,"interpolation"),n=this._getTypeInfo(e.type,e.attributes),i=this._parseInt(r.value),o=new th(e.name,n,r.name,i);return s!==null&&(o.interpolation=this._parseString(s.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const r=parseInt(e);return isNaN(r)?e:r}_getAlias(e){for(const r of this.aliases)if(r.name==e)return r.type;return null}_getAliasInfo(e){return new eh(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,r){if(this._types.has(e))return this._types.get(e);if(e instanceof Ga){const n=e,i=this._getTypeInfo(n.format,n.attributes),o=new xi(n.name,r);return o.format=i,o.count=n.count,this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof mr){const n=e,i=new Hs(n.name,r);i.startLine=n.startLine,i.endLine=n.endLine;for(const o of n.members){const a=this._getTypeInfo(o.type,o.attributes);i.members.push(new Ha(o.name,a,o.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof cs){const n=e,i=n.format instanceof pr,o=n.format?i?this._getTypeInfo(n.format,null):new Fr(n.format,null):null,a=new ja(n.name,o,r,n.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof Ra){const n=e,i=n.format?this._getTypeInfo(n.format,null):null,o=new ja(n.name,i,r,n.access);return this._types.set(e,o),this._updateTypeInfo(o),o}const s=new Fr(e.name,r);return this._types.set(e,s),this._updateTypeInfo(s),s}_updateTypeInfo(e){var r,s;const n=this._getTypeSize(e);if(e.size=(r=n==null?void 0:n.size)!==null&&r!==void 0?r:0,e instanceof xi){const i=this._getTypeSize(e.format);e.stride=(s=i==null?void 0:i.size)!==null&&s!==void 0?s:0,this._updateTypeInfo(e.format)}e instanceof Hs&&this._updateStructInfo(e)}_updateStructInfo(e){var r;let s=0,n=0,i=0,o=0;for(let a=0,c=e.members.length;a<c;++a){const m=e.members[a],_=this._getTypeSize(m);if(!_)continue;(r=this._getAlias(m.type.name))!==null&&r!==void 0||m.type;const v=_.align,P=_.size;s=this._roundUp(v,s+n),n=P,i=s,o=Math.max(o,v),m.offset=s,m.size=P,this._updateTypeInfo(m.type)}e.size=this._roundUp(o,i+n),e.align=o}_getTypeSize(e){var r;if(e==null)return null;const s=this._getAttributeNum(e.attributes,"size",0),n=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Ha&&(e=e.type),e instanceof Fr){const i=this._getAlias(e.name);i!==null&&(e=i)}{const i=kt._typeInfo[e.name];if(i!==void 0){const o=e.format==="f16"?2:1;return new zs(Math.max(n,i.align/o),Math.max(s,i.size/o))}}{const i=kt._typeInfo[e.name.substring(0,e.name.length-1)];if(i){const o=e.name[e.name.length-1]==="h"?2:1;return new zs(Math.max(n,i.align/o),Math.max(s,i.size/o))}}if(e instanceof xi){let i=e,o=8,a=8;const c=this._getTypeSize(i.format);c!==null&&(a=c.size,o=c.align);const m=i.count,_=this._getAttributeNum((r=e==null?void 0:e.attributes)!==null&&r!==void 0?r:null,"stride",this._roundUp(o,a));return a=m*_,s&&(a=s),new zs(Math.max(n,o),Math.max(s,a))}if(e instanceof Hs){let i=0,o=0,a=0,c=0,m=0;for(const _ of e.members){const v=this._getTypeSize(_.type);v!==null&&(i=Math.max(v.align,i),a=this._roundUp(v.align,a+c),c=v.size,m=a)}return o=this._roundUp(i,m+c),new zs(Math.max(n,i),Math.max(s,o))}return null}_isUniformVar(e){return e instanceof fr&&e.storage=="uniform"}_isStorageVar(e){return e instanceof fr&&e.storage=="storage"}_isTextureVar(e){return e instanceof fr&&e.type!==null&&kt._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof fr&&e.type!==null&&kt._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,r){const s=e;if(!s||!s.attributes)return null;const n=s.attributes;for(let i of n)if(i.name==r)return i;return null}_getAttributeNum(e,r,s){if(e===null)return s;for(let n of e)if(n.name==r){let i=n!==null&&n.value!==null?n.value:s;return i instanceof Array&&(i=i[0]),typeof i=="number"?i:typeof i=="string"?parseInt(i):s}return s}_roundUp(e,r){return Math.ceil(r/e)*e}}kt._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},kt._textureTypes=b.any_texture_type.map(t=>t.name),kt._samplerTypes=b.sampler_type.map(t=>t.name);function Ur(t,e){return Object.fromEntries(e.map(r=>{const s=lh(t,r,0);return[r.name,{typeDefinition:s,group:r.group,binding:r.binding,size:s.size}]}))}function Ja(t,e,r){return{fields:Object.fromEntries(e.members.map(s=>[s.name,{offset:s.offset,type:wi(t,s.type,0)}])),size:e.size,offset:r}}function oh(t){var e;if(t.name.includes("depth"))return"depth";switch((e=t.format)==null?void 0:e.name){case"f32":return"float";case"i32":return"sint";case"u32":return"uint";default:throw new Error("unknown texture sample type")}}function Ka(t){return t.name.includes("2d_array")?"2d-array":t.name.includes("cube_array")?"cube-array":t.name.includes("3d")?"3d":t.name.includes("1d")?"1d":t.name.includes("cube")?"cube":"2d"}function ah(t){switch(t.access){case"read":return"read-only";case"write":return"write-only";case"read_write":return"read-write";default:throw new Error("unknonw storage texture access")}}function uh(t){return t.name.endsWith("_comparison")?"comparison":"filtering"}function ch(t,e){const{binding:r,access:s,type:n}=t;switch(t.resourceType){case ke.Uniform:return{binding:r,visibility:e,buffer:{...t.size&&{minBindingSize:t.size}}};case ke.Storage:return{binding:r,visibility:e,buffer:{type:s===""||s==="read"?"read-only-storage":"storage",...t.size&&{minBindingSize:t.size}}};case ke.Texture:{if(n.name==="texture_external")return{binding:r,visibility:e,externalTexture:{}};const i=n.name.includes("multisampled");return{binding:r,visibility:e,texture:{sampleType:oh(n),viewDimension:Ka(n),multisampled:i}}}case ke.Sampler:return{binding:r,visibility:e,sampler:{type:uh(n)}};case ke.StorageTexture:return{binding:r,visibility:e,storageTexture:{access:ah(n),format:n.format.name,viewDimension:Ka(n)}};default:throw new Error("unknown resource type")}}function Ai(t,e){const r={};for(const s of t)r[s.name]={stage:e,resources:s.resources.map(n=>{const{name:i,group:o}=n;return{name:i,group:o,entry:ch(n,e)}})};return r}function gr(t){const e=new kt(t),r=Object.fromEntries(e.structs.map(_=>[_.name,Ja(e,_,0)])),s=Ur(e,e.uniforms),n=Ur(e,e.storage.filter(_=>_.resourceType===ke.Storage)),i=Ur(e,e.storage.filter(_=>_.resourceType===ke.StorageTexture)),o=Ur(e,e.textures.filter(_=>_.type.name!=="texture_external")),a=Ur(e,e.textures.filter(_=>_.type.name==="texture_external")),c=Ur(e,e.samplers),m={...Ai(e.entry.vertex,GPUShaderStage.VERTEX),...Ai(e.entry.fragment,GPUShaderStage.FRAGMENT),...Ai(e.entry.compute,GPUShaderStage.COMPUTE)};return{externalTextures:a,samplers:c,structs:r,storages:n,storageTextures:i,textures:o,uniforms:s,entryPoints:m}}function Bi(t,e=""){if(!t)throw new Error(e)}function lh(t,e,r){switch(e.resourceType){case ke.Uniform:case ke.Storage:case ke.StorageTexture:return wi(t,e.type,r);default:return{size:0,type:e.type.name}}}function wi(t,e,r){if(e.isArray){Bi(!e.isStruct,"struct array is invalid"),Bi(!e.isStruct,"template array is invalid");const s=e;return{size:s.size,elementType:wi(t,s.format,r),numElements:s.count}}else{if(e.isStruct)return Bi(!e.isTemplate,"template struct is invalid"),Ja(t,e,r);{const s=e,n=e.isTemplate?`${s.name}<${s.format.name}>`:e.name;return{size:e.size,type:n}}}}const dh=new Map([[Int8Array,{formats:["sint8","snorm8"],defaultForType:1}],[Uint8Array,{formats:["uint8","unorm8"],defaultForType:1}],[Int16Array,{formats:["sint16","snorm16"],defaultForType:1}],[Uint16Array,{formats:["uint16","unorm16"],defaultForType:1}],[Int32Array,{formats:["sint32","snorm32"],defaultForType:0}],[Uint32Array,{formats:["uint32","unorm32"],defaultForType:0}],[Float32Array,{formats:["float32","float32"],defaultForType:0}]]);new Map([...dh.entries()].map(([t,{formats:[e,r]}])=>[[e,t],[r,t]]).flat());const sr=class sr{static getActiveRenderPassType(){return this.activeRenderPassType}static setActiveRenderPass(e,r){this.activeRenderPassType=e,this.activeRenderPassEncoder=r,this.currentlyBoundRenderPSO=null}static bindRenderPSO(e){var r;e!==this.currentlyBoundRenderPSO&&(this.currentlyBoundRenderPSO=e,(r=this.activeRenderPassEncoder)==null||r.setPipeline(e))}};sr.ENABLE_DEBUG_GROUPS=!1,sr.elapsedTimeMs=0,sr.deltaTimeMs=0,sr.frameIndex=0,sr.depthStencilFormat="depth24plus-stencil8",sr.prevTimeMs=0;let x=sr;class hh{constructor(e,r){this.normal=e,this.d=r}normalize(){let e=H.len(this.normal);H.normalize(this.normal,this.normal),this.d/=e}checkIfBBoxIsInside(e){const r=this.normal[0]>=0?e.maxX:e.minX,s=this.normal[1]>=0?e.maxY:e.minY,n=this.normal[2]>=0?e.maxZ:e.minZ;return this.normal[0]*r+this.normal[1]*s+this.normal[2]*n+this.d>=0}}let Xa={};const Wa=new WeakMap,Ya={metric:[{from:0,to:1e3,unit:"B",long:"bytes"},{from:1e3,to:1e6,unit:"kB",long:"kilobytes"},{from:1e6,to:1e9,unit:"MB",long:"megabytes"},{from:1e9,to:1e12,unit:"GB",long:"gigabytes"},{from:1e12,to:1e15,unit:"TB",long:"terabytes"},{from:1e15,to:1e18,unit:"PB",long:"petabytes"},{from:1e18,to:1e21,unit:"EB",long:"exabytes"},{from:1e21,to:1e24,unit:"ZB",long:"zettabytes"},{from:1e24,to:1e27,unit:"YB",long:"yottabytes"}],metric_octet:[{from:0,to:1e3,unit:"o",long:"octets"},{from:1e3,to:1e6,unit:"ko",long:"kilooctets"},{from:1e6,to:1e9,unit:"Mo",long:"megaoctets"},{from:1e9,to:1e12,unit:"Go",long:"gigaoctets"},{from:1e12,to:1e15,unit:"To",long:"teraoctets"},{from:1e15,to:1e18,unit:"Po",long:"petaoctets"},{from:1e18,to:1e21,unit:"Eo",long:"exaoctets"},{from:1e21,to:1e24,unit:"Zo",long:"zettaoctets"},{from:1e24,to:1e27,unit:"Yo",long:"yottaoctets"}],iec:[{from:0,to:Math.pow(1024,1),unit:"B",long:"bytes"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"KiB",long:"kibibytes"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"MiB",long:"mebibytes"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"GiB",long:"gibibytes"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"TiB",long:"tebibytes"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"PiB",long:"pebibytes"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"EiB",long:"exbibytes"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"ZiB",long:"zebibytes"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"YiB",long:"yobibytes"}],iec_octet:[{from:0,to:Math.pow(1024,1),unit:"o",long:"octets"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"Kio",long:"kibioctets"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"Mio",long:"mebioctets"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"Gio",long:"gibioctets"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"Tio",long:"tebioctets"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"Pio",long:"pebioctets"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"Eio",long:"exbioctets"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"Zio",long:"zebioctets"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"Yio",long:"yobioctets"}]};class fh{constructor(e,r){r=Object.assign({units:"metric",precision:1,locale:void 0},Xa,r),Wa.set(this,r),Object.assign(Ya,r.customUnits);const s=e<0?"-":"";e=Math.abs(e);const n=Ya[r.units];if(n){const i=n.find(o=>e>=o.from&&e<o.to);if(i){const o=new Intl.NumberFormat(r.locale,{style:"decimal",maximumFractionDigits:r.precision}),a=i.from===0?s+o.format(e):s+o.format(e/i.from);this.value=a,this.unit=i.unit,this.long=i.long}else this.value=s+e,this.unit="",this.long=""}else throw new Error(`Invalid units specified: ${r.units}`)}toString(){const e=Wa.get(this);return e.toStringFn?e.toStringFn.bind(this)():`${this.value} ${this.unit}`}}function $a(t,e){return new fh(t,e)}$a.defaultOptions=function(t){Xa=t};class Nt{constructor(){throw new Error(`${this.constructor.name} is non-instantiable`)}}const Qa=new Map([["r16float",Uint16Array.BYTES_PER_ELEMENT],["rg16float",Uint16Array.BYTES_PER_ELEMENT*2],["rgba16float",Uint16Array.BYTES_PER_ELEMENT*4],["r32float",Float32Array.BYTES_PER_ELEMENT],["rg32float",Float32Array.BYTES_PER_ELEMENT*2],["rgba32float",Float32Array.BYTES_PER_ELEMENT*4],["bgra8unorm",Uint8Array.BYTES_PER_ELEMENT*4],["rgba8unorm",Uint8Array.BYTES_PER_ELEMENT*4],["depth24plus",3],["depth32float",Float32Array.BYTES_PER_ELEMENT],["depth24plus-stencil8",Float32Array.BYTES_PER_ELEMENT]]),Yo=class Yo extends Nt{static get formattedSize(){return this.getFormattedSize()}static getFormattedSize(){return $a(this.bytesAllocated).toString()}static addBytes(e){this.bytesAllocated+=e}static removeBytes(e){this.bytesAllocated-=e,this.bytesAllocated<0&&console.warn("Bytes allocated less than 0!")}static addBufferBytes(e){this.addBytes(e.size)}static removeBufferBytes(e){this.removeBytes(e.size)}static addTextureBytes(e){const r=Qa.get(e.format);if(!r){console.warn(`No byte size per pixel info for ${e.format}`);return}for(let s=0;s<e.depthOrArrayLayers;s++)for(let n=0;n<e.mipLevelCount;n++){const i=Math.ceil(e.width/Math.pow(2,n)),o=Math.ceil(e.height/Math.pow(2,n)),a=r*i*o;this.addBytes(a)}}static removeTextureBytes(e){const r=Qa.get(e.format);if(!r){console.warn(`No byte size per pixel info for ${e.format}`);return}for(let s=0;s<e.depthOrArrayLayers;s++)for(let n=0;n<e.mipLevelCount;n++){const i=Math.ceil(e.width/Math.pow(2,n)),o=Math.ceil(e.height/Math.pow(2,n)),a=r*i*o;this.removeBytes(a)}}};Yo.bytesAllocated=0;let ee=Yo;class kr{constructor(){this._position=H.fromValues(0,0,0),this._rotation=H.fromValues(0,0,0),this._scale=H.fromValues(1,1,1),this._worldPosition=H.create(),this.translateMatrix=ae.identity(),this.scaleMatrix=ae.identity(),this.rotationMatrix=ae.identity(),this.cachedMatrix=ae.create(),this.worldMatrix=ae.identity(),this.normalMatrix=Us.create(),this.quaternion=ks.create(),this.prevFrameModelMatrix=ae.create(),this.matrixNeedsUpdate=!0,this.id=crypto.randomUUID(),this.label="Object",this.children=[],this._visible=!0}get visible(){return this._visible}set visible(e){this.onVisibilityChange(e),this._visible=e}get modelMatrix(){return this.worldMatrix}setCustomMatrix(e){this._customMatrix=e,this.matrixNeedsUpdate=!0}setCustomMatrixFromTRS(e,r,s){const n=ae.scaling(s),i=ae.fromQuat(r),o=ae.translation(e);ae.mul(n,i,n),ae.mul(n,o),this.setCustomMatrix(n)}updateNormalMatrix(){Us.fromMat4(this.worldMatrix,this.normalMatrix),Us.inverse(this.normalMatrix,this.normalMatrix),Us.transpose(this.normalMatrix,this.normalMatrix)}updateWorldMatrix(){var r;const e=((r=this.parent)==null?void 0:r.worldMatrix)??pd;return this.matrixNeedsUpdate?(this._customMatrix?ae.copy(this._customMatrix,this.cachedMatrix):(ae.identity(this.scaleMatrix),ae.scale(this.scaleMatrix,this.scale,this.scaleMatrix),this.quaternion=ks.fromEuler(this.rotation[0],this.rotation[1],this.rotation[2],md),ae.fromQuat(this.quaternion,this.rotationMatrix),ae.identity(this.translateMatrix),ae.translate(this.translateMatrix,this.position,this.translateMatrix),ae.mul(this.scaleMatrix,this.rotationMatrix,this.cachedMatrix),ae.mul(this.translateMatrix,this.cachedMatrix,this.cachedMatrix)),ae.mul(e,this.cachedMatrix,this.worldMatrix),ae.copy(this.worldMatrix,this.prevFrameModelMatrix),this.updateNormalMatrix(),this.matrixNeedsUpdate=!1,!0):(ae.mul(e,this.cachedMatrix,this.worldMatrix),ae.copy(this.worldMatrix,this.prevFrameModelMatrix),this.updateNormalMatrix(),!1)}onVisibilityChange(e){}addChild(e){e.parent=this,this.children.push(e),e.updateWorldMatrix(),this.onChildAdd(e)}removeChild(e){this.children=this.children.filter(({id:r})=>r!=e.id),e.parent=null,this.onChildRemove(e)}onChildAdd(e){var r;(r=this.parent)==null||r.onChildAdd(e)}onChildRemove(e){var r;(r=this.parent)==null||r.onChildRemove(e)}traverse(e,r=!0){if(e(this),r)for(let s of this.children)s.traverse(e,r)}findChild(e){if(e(this))return this;for(let r of this.children)if(r.findChild(e))return r}findChildByLabel(e){return this.findChild(({label:r})=>e===r)}findChildById(e){return this.findChild(({id:r})=>e===r)}preRender(e){}onRender(e){}postRender(e){}render(e){this.visible&&(this.preRender(e),this.onRender(e),this.postRender(e))}get worldPosition(){return this.getWorldPosition()}getWorldPosition(){return this._worldPosition[0]=this.worldMatrix[12],this._worldPosition[1]=this.worldMatrix[13],this._worldPosition[2]=this.worldMatrix[14],this._worldPosition}setPositionAsVec3(e){return H.clone(e,this._position),this.matrixNeedsUpdate=!0,this}setPosition(e,r,s){return this._position[0]=e,this._position[1]=r,this._position[2]=s,this.matrixNeedsUpdate=!0,this}setPositionX(e){return this._position[0]=e,this.matrixNeedsUpdate=!0,this}setPositionY(e){return this._position[1]=e,this.matrixNeedsUpdate=!0,this}setPositionZ(e){return this._position[2]=e,this.matrixNeedsUpdate=!0,this}get position(){return this.getPosition()}getPosition(){return this._position}getPositionX(){return this._position[0]}getPositionY(){return this._position[1]}getPositionZ(){return this._position[2]}setRotation(e,r,s){return this._rotation[0]=e,this._rotation[1]=r,this._rotation[2]=s,this.matrixNeedsUpdate=!0,this}setRotationX(e){return this._rotation[0]=e,this.matrixNeedsUpdate=!0,this}setRotationY(e){return this._rotation[1]=e,this.matrixNeedsUpdate=!0,this}setRotationZ(e){return this._rotation[2]=e,this.matrixNeedsUpdate=!0,this}get rotation(){return this.getRotation()}getRotation(){return this._rotation}getRotationX(){return this._rotation[0]}getRotationY(){return this._rotation[1]}getRotationZ(){return this._rotation[2]}setScale(e,r,s){return this._scale[0]=e,this._scale[1]=r,this._scale[2]=s,this.matrixNeedsUpdate=!0,this}setScaleX(e){return this._scale[0]=e,this.matrixNeedsUpdate=!0,this}setScaleY(e){return this._scale[1]=e,this.matrixNeedsUpdate=!0,this}setScaleZ(e){return this._scale[2]=e,this.matrixNeedsUpdate=!0,this}get scale(){return this.getScale()}getScale(){return this._scale}getScaleX(){return this._scale[0]}getScaleY(){return this._scale[1]}getScaleZ(){return this._scale[2]}}const xt=Object.freeze({get Position(){return 0},get Normal(){return 1},get TexCoord(){return 2},get Tangent(){return 3}}),Be=Object.freeze({get CameraPlusOptionalLights(){return 0},get Model(){return 1},get PBRTextures(){return 2},get InstanceInputs(){return 3}}),Vt=Object.freeze({get NormalMetallicRoughness(){return 0},get ColorReflectance(){return 1},get Velocity(){return 2}}),Js=Object.freeze({get Default(){return 0}}),De=Object.freeze({get Albedo(){return 1},get Normal(){return 2},get MetallicRoughness(){return 3},get AO(){return 4}}),te=Object.freeze({get VertexInput(){return`

      struct VertexInput {
        @location(${xt.Position}) position: vec4f,
        @location(${xt.Normal}) normal: vec3f,
        @location(${xt.TexCoord}) uv: vec2f,
        @location(${xt.Tangent}) tangent: vec4f,
      };

    `},get VertexOutput(){return`
    
      struct VertexOutput {
        @builtin(position) position: vec4f,
        @location(0) worldPosition: vec3f,
        @location(1) viewNormal: vec3f,
        @location(2) uv: vec2f,
        @location(3) viewTangent: vec3f,
        @location(4) viewBitangent: vec3f,
        @location(5) currFrameClipPos: vec4f,
        @location(6) prevFrameClipPos: vec4f,
        @location(7) @interpolate(flat) instanceId: u32,
      };

    `},get InstanceInput(){return`
      struct InstanceInput {
        worldMatrix: mat4x4f,
        metallic: f32,
        roughness: f32,
      };
    `},get ModelUniform(){return`

      struct ModelUniform {
        worldMatrix: mat4x4f,
        prevFrameWorldMatrix: mat4x4f,
        normalMatrix: mat3x3f,
        baseColor: vec3f,
        isReflective: u32,
        metallic: f32,
        roughness: f32,
      };

    `},get Camera(){return`

      struct Camera {
        position: vec3f,
        projectionMatrix: mat4x4f,
        viewMatrix: mat4x4f,
        projectionViewMatrix: mat4x4f,
        inverseProjectionViewMatrix: mat4x4f,
        inverseViewMatrix: mat4x4f,
        inverseProjectionMatrix: mat4x4f,
        prevFrameProjectionViewMatrix: mat4x4f,
        viewportWidth: u32,
        viewportHeight: u32,
        jitterOffset: vec2f,
      };

      @must_use
      fn calcWorldPos(
        camera: Camera,
        coord: vec2f,
        depth: f32
      ) -> vec3f {
        let ndcX = coord.x / f32(camera.viewportWidth) * 2.0 - 1.0;
        let ndcY = (1.0 - coord.y / f32(camera.viewportHeight)) * 2.0 - 1.0;
        let clipPos = vec4f(ndcX, ndcY, depth, 1.0);

        let worldSpacePos = camera.inverseProjectionViewMatrix * clipPos;
        return worldSpacePos.xyz / worldSpacePos.w;
      }

      @must_use
      fn calcViewSpacePos(
        camera: Camera,
        coord: vec2f,
        depth: f32
      ) -> vec3f {
        let ndcX = coord.x / f32(camera.viewportWidth) * 2.0 - 1.0;
        let ndcY = (1.0 - coord.y / f32(camera.viewportHeight)) * 2.0 - 1.0;
        let clipPos = vec4f(ndcX, ndcY, depth, 1.0);

        let viewSpacePos = camera.inverseProjectionMatrix * clipPos;
        return viewSpacePos.xyz / viewSpacePos.w;
      }

    `},get GBufferOutput(){return`

      struct GBufferOutput {
        @location(${Vt.NormalMetallicRoughness}) normalMetallicRoughness: vec4f,
        @location(${Vt.ColorReflectance}) color: vec4f,
        @location(${Vt.Velocity}) velocity: vec4f,
      };
      
    `},get AABB(){return`
      struct AABB {
        min: vec3f,
        max: vec3f,
      };
    `},get Particle(){return`
      struct Particle {
        radius: f32,
        position: vec3f,
        origPosition: vec3f,
        velocity: vec3f,
        lifeSpeed: f32,
        life: f32
      };
    `},get Light(){return`

      struct Light {
        lightType: u32, // 0 - Directional Light, 1 - Point Light, 2 - Ambient Light
        intensity: f32,
        radius: f32,
        position: vec3f,
        color: vec3f,
      };

    `},get Material(){return`
    
      struct Material {
        metallic: f32,
        albedo: vec3f,
        roughness: f32,
        ambientOcclusion: f32,
      };

    `},get ShadowCascade(){return`
      struct ShadowCascade {
        projViewMatrix: mat4x4<f32>,
        distance: f32,
      };
    `},get CommonHelpers(){return`

      const WORLD_UP = vec3f(0.0, 1.0, 0.0);
      const WORLD_FORWARD = vec3f(0.0, 0.0, 1.0);
      const PI: f32 = 3.1415;
      const TWO_PI: f32 = 6.2831;
      const HALF_PI: f32 = 1.5707;
      const DELTA_PHI: f32 = 0.01745;
      const DELTA_THETA: f32 = 0.01745;
    
      const CUBE_NORMALS: array<vec3<f32>, 6> = array<vec3<f32>, 6>(
        vec3<f32>(1.0, 0.0, 0.0),
        vec3<f32>(-1.0, 0.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, -1.0, 0.0),
        vec3<f32>(0.0, 0.0, 1.0),
        vec3<f32>(0.0, 0.0, -1.0)
      );
      
      const CUBE_UPS: array<vec3<f32>, 6> = array<vec3<f32>, 6>(
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 0.0, -1.0),
        vec3<f32>(0.0, 0.0, 1.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0)
      );
      
      const CUBE_ROTATIONS: array<vec4<f32>, 6> = array<vec4<f32>, 6>(
        vec4<f32>(0.0, 1.0, 0.0, HALF_PI),
        vec4<f32>(0.0, 1.0, 0.0, -HALF_PI),
        vec4<f32>(1.0, 0.0, 0.0, -HALF_PI),
        vec4<f32>(1.0, 0.0, 0.0, HALF_PI),
        vec4<f32>(0.0, 0.0, 1.0, 0.0),
        vec4<f32>(0.0, 1.0, 0.0, PI)
      );
    `},get MathHelpers(){return`

      @must_use
      fn rotateAxisAngle(inAxis: vec3f, angle: f32) -> mat3x3f {
        let axis = normalize(inAxis);
        let s = sin(angle);
        let c = cos(angle);
        let oc = 1.0 - c;
    
        return mat3x3f(
          oc * axis.x * axis.x + c, oc * axis.x * axis.y - axis.z * s, oc * axis.z * axis.x + axis.y * s,
          oc * axis.x * axis.y + axis.z * s, oc * axis.y * axis.y + c, oc * axis.y * axis.z - axis.x * s,
          oc * axis.z * axis.x - axis.y * s, oc * axis.y * axis.z + axis.x * s, oc * axis.z * axis.z + c
        );
      }
      
    `}}),qa=[[.5,.333333],[.25,.666667],[.75,.111111],[.125,.444444],[.625,.777778],[.375,.222222],[.875,.555556],[.0625,.888889],[.5625,.037037],[.3125,.37037],[.8125,.703704],[.1875,.148148],[.6875,.481481],[.4375,.814815],[.9375,.259259],[.03125,.592593]],Hn=class Hn extends kr{constructor(){super(),this.lookAt=H.fromValues(0,0,0),this.hasChangedSinceLastFrame=!0,this.projectionMatrix=ae.create(),this.inverseProjectionMatrix=ae.create(),this.viewMatrix=ae.create(),this.inverseViewMatrix=ae.create(),this.projectionViewMatrix=ae.create(),this.inverseProjectionViewMatrix=ae.create(),this._shouldJitter=!1,this._shouldJitterChanged=!1,this.prevFrameProjectionViewMatrix=ae.create(),this.frameCounter=0,this.frustumPlanes=[],this.hamiltonSequence=new Array(16).fill([]).map(()=>new Array(2).fill(0));const e=gr(te.Camera);this.bufferUniformValues=Qt(e.structs.Camera),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,projectionMatrix:this.projectionMatrix,projectionViewMatrix:this.projectionViewMatrix}),this.gpuBuffer=x.device.createBuffer({size:this.bufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,label:"Camera GPUBuffer"}),ee.addBufferBytes(this.gpuBuffer);for(let r=0;r<6;r++)this.frustumPlanes.push(new hh(H.create(),0))}get shouldJitter(){return this._shouldJitter}set shouldJitter(e){this._shouldJitter=e,this._shouldJitterChanged=!0}set x(e){this.position[0]=e,this.bufferUniformValues.set({position:this.position})}get x(){return this.position[0]}set y(e){this.position[1]=e,this.bufferUniformValues.set({position:this.position})}get y(){return this.position[1]}set z(e){this.position[2]=e,this.bufferUniformValues.set({position:this.position})}get z(){return this.position[2]}get frustumCornersWorldSpace(){const e=this.inverseProjectionViewMatrix;let r=[];for(let s=0;s<2;s++)for(let n=0;n<2;n++)for(let i=0;i<2;i++){const o=2*s-1,a=2*n-1,c=i,m=as.create(o,a,c,1);as.transformMat4(m,e,m),m[0]/=m[3],m[1]/=m[3],m[2]/=m[3],r.push(m)}return r}cullMeshes(e,r){let s=0;for(let n=0;n<e.length;n++){const i=e[n].worldBoundingBox;let o=0;for(const a of this.frustumPlanes)a.checkIfBBoxIsInside(i)&&o++;o===6&&(r[s]=e[n],s++)}return s}setLookAt(e,r,s){this.lookAt[0]=e,this.lookAt[1]=r,this.lookAt[2]=s}setLookAtVec3(e){this.lookAt=e}updateViewMatrix(){return ae.lookAt(this.position,this.lookAt,Hn.UP_VECTOR,this.viewMatrix),ae.inverse(this.viewMatrix,this.inverseViewMatrix),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,inverseViewMatrix:this.inverseViewMatrix}),this.updateProjectionViewMatrix(),this}updateViewMatrixWithMat(e){return this.viewMatrix=e,ae.inverse(this.viewMatrix,this.inverseViewMatrix),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,inverseViewMatrix:this.inverseViewMatrix}),this.updateProjectionViewMatrix(),this}updateProjectionMatrix(){return ae.inverse(this.projectionMatrix,this.inverseProjectionMatrix),this.bufferUniformValues.set({projectionMatrix:this.projectionMatrix,inverseProjectionMatrix:this.inverseProjectionMatrix}),this.updateProjectionViewMatrix(),this}updateProjectionViewMatrix(){return ae.mul(this.projectionMatrix,this.viewMatrix,this.projectionViewMatrix),ae.inverse(this.projectionViewMatrix,this.inverseProjectionViewMatrix),this.bufferUniformValues.set({projectionViewMatrix:this.projectionViewMatrix,inverseProjectionViewMatrix:this.inverseProjectionViewMatrix,prevFrameProjectionViewMatrix:this.prevFrameProjectionViewMatrix}),this.updateFrustumPlanes(),this}onResize(e,r){this.viewportWidth=e,this.viewportHeight=r,this.bufferUniformValues.set({viewportWidth:e,viewportHeight:r});for(let s=0;s<16;s++)this.hamiltonSequence[s][0]=(qa[s][0]-.5)/this.viewportWidth*2,this.hamiltonSequence[s][1]=(qa[s][1]-.5)/this.viewportHeight*2}onFrameStart(){const e=this.hamiltonSequence[this.frameCounter%16];this._shouldJitterChanged&&(this._shouldJitter||this.bufferUniformValues.set({jitterOffset:[0,0]}),this._shouldJitterChanged=!1),this._shouldJitter&&this.bufferUniformValues.set({jitterOffset:e}),x.device.queue.writeBuffer(this.gpuBuffer,0,this.bufferUniformValues.arrayBuffer)}onFrameEnd(){ae.copy(this.projectionViewMatrix,this.prevFrameProjectionViewMatrix),this.frameCounter++,this.hasChangedSinceLastFrame=!1}updateFrustumPlanes(){const e=this.projectionViewMatrix;this.frustumPlanes[0].normal[0]=e[3]+e[0],this.frustumPlanes[0].normal[1]=e[7]+e[4],this.frustumPlanes[0].normal[2]=e[11]+e[8],this.frustumPlanes[0].d=e[15]+e[12],this.frustumPlanes[1].normal[0]=e[3]-e[0],this.frustumPlanes[1].normal[1]=e[7]-e[4],this.frustumPlanes[1].normal[2]=e[11]-e[8],this.frustumPlanes[1].d=e[15]-e[12],this.frustumPlanes[2].normal[0]=e[3]+e[1],this.frustumPlanes[2].normal[1]=e[7]+e[5],this.frustumPlanes[2].normal[2]=e[11]+e[9],this.frustumPlanes[2].d=e[15]+e[13],this.frustumPlanes[3].normal[0]=e[3]-e[1],this.frustumPlanes[3].normal[1]=e[7]-e[5],this.frustumPlanes[3].normal[2]=e[11]-e[9],this.frustumPlanes[3].d=e[15]-e[13],this.frustumPlanes[4].normal[0]=e[3]+e[2],this.frustumPlanes[4].normal[1]=e[7]+e[6],this.frustumPlanes[4].normal[2]=e[11]+e[10],this.frustumPlanes[4].d=e[15]+e[14],this.frustumPlanes[5].normal[0]=e[3]-e[2],this.frustumPlanes[5].normal[1]=e[7]-e[6],this.frustumPlanes[5].normal[2]=e[11]-e[10],this.frustumPlanes[5].d=e[15]-e[14];for(let r of this.frustumPlanes)r.normalize()}};Hn.UP_VECTOR=H.fromValues(0,1,0);let Ks=Hn;class vi extends Ks{constructor(e,r,s,n){super(),this.fieldOfView=e,this.aspect=r,this.fieldOfView=fd(e),this.aspect=r,this.near=s,this.far=n,this.updateProjectionMatrix()}onResize(e,r){super.onResize(e,r),this.aspect=e/r,this.updateProjectionMatrix()}updateProjectionMatrix(){return ae.perspective(this.fieldOfView,this.aspect,this.near,this.far,this.projectionMatrix),super.updateProjectionMatrix(),this.updateProjectionViewMatrix(),this}}const Za=.1,eu=100,Lt="normal+metallic+roughness texture",qt="albedo+reflectance texture",Xs="velocity texture",at="depth texture",ls="directional light depth texture",tu="ssao texture",Nr="ssao blur texture",Et="lighting texture",ds="taa resolve texture",Ws="hi-z depth texture",hs="computed reflections texture",fs="bloom downscale texture",yr=new Array(3);yr[Vt.NormalMetallicRoughness]={format:"rgba16float"},yr[Vt.ColorReflectance]={format:"bgra8unorm"},yr[Vt.Velocity]={format:"rg16float"};const ph=["/textures/px.hdr","/textures/nx.hdr","/textures/py.hdr","/textures/ny.hdr","/textures/pz.hdr","/textures/nz.hdr"],mh=[H.create(5.5,7.5,3.25),H.create(4,6.5,.5),H.create(2.5,6.5,3.25),H.create(1,7.5,.5),H.create(-.5,7.5,3.25),H.create(-2,6.5,.5),H.create(-3.5,6.5,3.25),H.create(-5,7.5,.5),H.create(-6.5,7.5,3.25),H.create(-7.75,6.5,.5),H.create(-10.5,7.5,-.125),H.create(-7.75,7.5,-1),H.create(-6.5,6.5,-4),H.create(-5,6.5,-1),H.create(-3.5,7.5,-4),H.create(-2,7.5,-1),H.create(-.5,6.5,-4),H.create(1,6.5,-1),H.create(2.5,7.5,-4),H.create(4,7.5,-1),H.create(5.5,6.5,-4),H.create(6.5,6.5,-1),H.create(9,6.5,-1),H.create(9.5,7.5,-.125),H.create(9,6.5,.7),H.create(6,6.5,1),H.create(6,7.5,3.25)],ht=H.create(),gh=87,yh=83,_h=65,bh=68,xh=69,Ah=81,Bh=38,wh=37,vh=39,Ch=40;class Th{constructor(e,r=document.body,s=r){this.camera=e,this.keyboardDomElement=r,this.mouseDomElement=s,this.angles=dt.create(0,-Math.PI*.5),this.viewMat=ae.create(),this.rotMat=ae.identity(),this.lastX=0,this.lastY=0,this.presedKeys=new Array(128),this.rafId=-1,this.speed=20,this.update=n=>{const i=this.speed*.001;H.set(0,0,0,ht),(this.presedKeys[gh]||this.presedKeys[Bh])&&(ht[2]-=i),(this.presedKeys[yh]||this.presedKeys[Ch])&&(ht[2]+=i),(this.presedKeys[_h]||this.presedKeys[wh])&&(ht[0]-=i),(this.presedKeys[bh]||this.presedKeys[vh])&&(ht[0]+=i),this.presedKeys[xh]&&(ht[1]+=i),this.presedKeys[Ah]&&(ht[1]-=i),(ht[0]!==0||ht[1]!==0||ht[2]!==0)&&(H.transformMat4(ht,this.rotMat,ht),H.add(this.position,ht,this.position));const o=this.viewMat;ae.identity(o),ae.rotateX(o,this.angles[0],o),ae.rotateY(o,this.angles[1],o),ae.translate(o,H.negate(this.position),o),this.camera.setPosition(this.position[0],this.position[1],this.position[2]),this.camera.updateViewMatrixWithMat(o),this.rafId=requestAnimationFrame(this.update)},this.onMouseDown=n=>{this.lastX=n.pageX,this.lastY=n.pageY,this.mouseDomElement.addEventListener("mousemove",this.onMouseMove)},this.onMouseUp=n=>{this.mouseDomElement.removeEventListener("mousemove",this.onMouseMove)},this.onMouseMove=n=>{const i=n.pageX-this.lastX,o=n.pageY-this.lastY;this.lastX=n.pageX,this.lastY=n.pageY,this.rotateView(i*.0075,o*.005)},this.onKeyDown=n=>{this.presedKeys[n.keyCode]=!0},this.onKeyUp=n=>{this.presedKeys[n.keyCode]=!1},this.position=e.position,r.addEventListener("keydown",this.onKeyDown),r.addEventListener("keyup",this.onKeyUp),s.addEventListener("mousedown",this.onMouseDown),s.addEventListener("mouseup",this.onMouseUp),this.rotateView(.0075,.005)}startTick(){this.rafId=requestAnimationFrame(this.update)}endTick(){cancelAnimationFrame(this.rafId)}rotateView(e,r){if(e||r){for(this.angles[1]+=e;this.angles[1]<0;)this.angles[1]+=Math.PI*2;for(;this.angles[1]>=Math.PI*2;)this.angles[1]-=Math.PI*2;this.angles[0]+=r,this.angles[0]<-Math.PI*.5&&(this.angles[0]=-Math.PI*.5),this.angles[0]>Math.PI*.5&&(this.angles[0]=Math.PI*.5),ae.identity(this.rotMat),ae.rotateY(this.rotMat,-this.angles[1],this.rotMat),ae.rotateX(this.rotMat,-this.angles[0],this.rotMat)}}}var K=(t=>(t[t.Deferred=0]="Deferred",t[t.DirectionalAmbientLighting=1]="DirectionalAmbientLighting",t[t.PointLightsNonCulledLighting=2]="PointLightsNonCulledLighting",t[t.PointLightsStencilMask=3]="PointLightsStencilMask",t[t.PointLightsLighting=4]="PointLightsLighting",t[t.SSAO=5]="SSAO",t[t.SSAOBlur=6]="SSAOBlur",t[t.Skybox=7]="Skybox",t[t.Transparent=8]="Transparent",t[t.Shadow=9]="Shadow",t[t.MomentsShadow=10]="MomentsShadow",t[t.BlurMomentsShadow=11]="BlurMomentsShadow",t[t.EnvironmentCube=12]="EnvironmentCube",t[t.TAAResolve=13]="TAAResolve",t[t.CopyDepthForHiZ=14]="CopyDepthForHiZ",t[t.HiZ=15]="HiZ",t[t.Reflection=16]="Reflection",t[t.BloomDownsample=17]="BloomDownsample",t[t.BloomUpsample=18]="BloomUpsample",t[t.DebugBounds=19]="DebugBounds",t[t.Blit=20]="Blit",t))(K||{}),de=(t=>(t[t.CPUTotal=0]="CPUTotal",t[t.GPUTotal=1]="GPUTotal",t[t.FPS=2]="FPS",t[t.VRAM=3]="VRAM",t[t.VisibleMeshes=4]="VisibleMeshes",t[t.LightsCount=5]="LightsCount",t[t.DeferredRenderPass=6]="DeferredRenderPass",t[t.DirectionalAmbientLightingRenderPass=7]="DirectionalAmbientLightingRenderPass",t[t.PointLightsStencilMask=8]="PointLightsStencilMask",t[t.PointLightsLighting=9]="PointLightsLighting",t[t.SSAORenderPass=10]="SSAORenderPass",t[t.TransparentRenderPass=11]="TransparentRenderPass",t[t.ShadowRenderPass=12]="ShadowRenderPass",t[t.TAAResolveRenderPass=13]="TAAResolveRenderPass",t[t.ReflectionRenderPass=14]="ReflectionRenderPass",t[t.BlitRenderPass=15]="BlitRenderPass",t))(de||{}),_r=(t=>(t[t.Directional=0]="Directional",t[t.Point=1]="Point",t[t.Ambient=2]="Ambient",t))(_r||{});const Sh=0,ru=1,Eh=2,Mh=new Map([[_r.Directional,Sh],[_r.Point,ru],[_r.Ambient,Eh]]);K.Deferred,K.DirectionalAmbientLighting,K.SSAO,K.Transparent,K.Shadow,K.TAAResolve,K.Reflection,K.Blit;const Ph=[de.CPUTotal,de.GPUTotal,de.FPS,de.VRAM,de.VisibleMeshes,de.LightsCount],ps=new Map([[K.Deferred,"G-Buffer Render Pass"],[K.DirectionalAmbientLighting,"Directional + Ambient Render Pass"],[K.PointLightsStencilMask,"Point Lights Stencil Mask Pass"],[K.PointLightsLighting,"Point Lights LightingSystem"],[K.SSAO,"SSAO Render Pass"],[K.SSAOBlur,"SSAO Blur Render Pass"],[K.Skybox,"Skybox Render Pass"],[K.Transparent,"Transparent Render Pass"],[K.Shadow,"Shadow Render Pass"],[K.EnvironmentCube,"Environment Cube Pass"],[K.TAAResolve,"TAA Resolve Render Pass"],[K.CopyDepthForHiZ,"Copy Depth for Hi-Z Render Pass"],[K.HiZ,"Hi-Z Depth Render Pass"],[K.Reflection,"SSR Render Pass"],[K.DebugBounds,"Debug Bounds Render Pass"],[K.Blit,"Blit Render Pass"]]);class Rh{constructor(){this.passes=[],this.textureCache=new Map}destroy(){for(const e of this.passes)e.destroy();this.textureCache.clear()}setScene(e){this.scene=e}addPass(e){if(this.passes.some(({type:r})=>r===e.type)){const r=ps.get(e.type);console.warn(`RenderPass ${r} has already been added`);return}return this.passes.push(e),this}removePass(e){this.passes=this.passes.filter(({type:r})=>r!==e)}getPass(e){return this.passes.find(({type:r})=>r===e)}setTexture(e,r){this.textureCache.set(e,r)}getTexture(e){return this.textureCache.get(e)}async render(e){for(const r of this.passes){if(!r.enabled)continue;const s=r.inputTextureNames.map(i=>this.textureCache.get(i)),n=r.render(e,this.scene,s);r.outputTextureNames.forEach((i,o)=>{this.textureCache.set(i,n[o])})}}onFrameEnd(){for(const e of this.passes)e.onFrameEnd()}}class Ci{constructor(){this.c0=0,this.c1=0,this.c2=0,this.c3=0}set(e,r,s,n){this.c0=e,this.c1=s,this.c2=-3*e+3*r-2*s-n,this.c3=2*e-2*r+s+n}initCatmullRom(e,r,s,n,i){this.set(r,s,i*(s-e),i*(n-r))}initNonuniformCatmullRom(e,r,s,n,i,o,a){let c=(r-e)/i-(s-e)/(i+o)+(s-r)/o,m=(s-r)/o-(n-r)/(o+a)+(n-s)/a;c*=o,m*=o,this.set(r,s,c,m)}calc(e){const r=e*e,s=r*e;return this.c0+this.c1*e+this.c2*r+this.c3*s}}const su=new Ci,nu=new Ci,iu=new Ci,Zt=H.create();class Gh{constructor(e=[],r=!1,s=.5){this.points=e,this.closed=r,this.tension=s}getPoint(e,r=H.create()){const s=r,n=this.points.length,i=(n-(this.closed?0:1))*e;let o=Math.floor(i),a=i-o;this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/n)+1)*n:a===0&&o===n-1&&(o=n-2,a=1);let c,m;this.closed||o>0?c=this.points[(o-1)%n]:(H.sub(this.points[0],this.points[1],Zt),H.add(Zt,this.points[0],Zt),c=Zt);const _=this.points[o%n],v=this.points[(o+1)%n];this.closed||o+2<n?m=this.points[(o+2)%n]:(H.sub(this.points[n-1],this.points[n-2],Zt),H.add(Zt,this.points[n-1],Zt),m=Zt);const P=.25;let O=Math.pow(H.distSq(c,_),P),D=Math.pow(H.distSq(_,v),P),U=Math.pow(H.distSq(v,m),P);return D<1e-4&&(D=1),O<1e-4&&(O=D),U<1e-4&&(U=D),su.initNonuniformCatmullRom(c[0],_[0],v[0],m[0],O,D,U),nu.initNonuniformCatmullRom(c[1],_[1],v[1],m[1],O,D,U),iu.initNonuniformCatmullRom(c[2],_[2],v[2],m[2],O,D,U),H.set(su.calc(a),nu.calc(a),iu.calc(a),s),s}getPoints(e=5){const r=[];for(let s=0;s<e;s++)r.push(this.getPoint(s/e));return r}}class Ys{constructor(e=200){this.numSamples=e,this.total=0,this.samples=[],this.cursor=0}addSample(e){this.total+=e-(this.samples[this.cursor]||0),this.samples[this.cursor]=e,this.cursor=(this.cursor+1)%this.numSamples}get(){return this.total/this.samples.length}}async function ou(t,e,r,s){return s._parse(t,e,r,s)}function Ht(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const $s=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),au=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);au&&parseFloat(au[1]);const Qs=globalThis,Vr=globalThis.process||{};function Lh(t){var r,s;if(typeof window<"u"&&((r=window.process)==null?void 0:r.type)==="renderer"||typeof process<"u"&&((s=process.versions)!=null&&s.electron))return!0;const e=typeof navigator<"u"&&navigator.userAgent;return!!(e&&e.indexOf("Electron")>=0)}function Ti(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||Lh()}const uu="4.0.7";function Oh(t){try{const e=window[t],r="__storage_test__";return e.setItem(r,r),e.removeItem(r),e}catch{return null}}class Dh{constructor(e,r,s="sessionStorage"){this.storage=Oh(s),this.id=e,this.config=r,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const r=JSON.stringify(this.config);this.storage.setItem(this.id,r)}}_loadConfiguration(){let e={};if(this.storage){const r=this.storage.getItem(this.id);e=r?JSON.parse(r):{}}return Object.assign(this.config,e),this}}function Ih(t){let e;return t<10?e=`${t.toFixed(2)}ms`:t<100?e=`${t.toFixed(1)}ms`:t<1e3?e=`${t.toFixed(0)}ms`:e=`${(t/1e3).toFixed(2)}s`,e}function Fh(t,e=8){const r=Math.max(e-t.length,0);return`${" ".repeat(r)}${t}`}var qs;(function(t){t[t.BLACK=30]="BLACK",t[t.RED=31]="RED",t[t.GREEN=32]="GREEN",t[t.YELLOW=33]="YELLOW",t[t.BLUE=34]="BLUE",t[t.MAGENTA=35]="MAGENTA",t[t.CYAN=36]="CYAN",t[t.WHITE=37]="WHITE",t[t.BRIGHT_BLACK=90]="BRIGHT_BLACK",t[t.BRIGHT_RED=91]="BRIGHT_RED",t[t.BRIGHT_GREEN=92]="BRIGHT_GREEN",t[t.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",t[t.BRIGHT_BLUE=94]="BRIGHT_BLUE",t[t.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",t[t.BRIGHT_CYAN=96]="BRIGHT_CYAN",t[t.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(qs||(qs={}));const Uh=10;function cu(t){return typeof t!="string"?t:(t=t.toUpperCase(),qs[t]||qs.WHITE)}function kh(t,e,r){return!Ti&&typeof t=="string"&&(e&&(t=`\x1B[${cu(e)}m${t}\x1B[39m`),r&&(t=`\x1B[${cu(r)+Uh}m${t}\x1B[49m`)),t}function Nh(t,e=["constructor"]){const r=Object.getPrototypeOf(t),s=Object.getOwnPropertyNames(r),n=t;for(const i of s){const o=n[i];typeof o=="function"&&(e.find(a=>i===a)||(n[i]=o.bind(t)))}}function Si(t,e){if(!t)throw new Error("Assertion failed")}function Hr(){var e,r,s;let t;if(Ti()&&Qs.performance)t=(r=(e=Qs==null?void 0:Qs.performance)==null?void 0:e.now)==null?void 0:r.call(e);else if("hrtime"in Vr){const n=(s=Vr==null?void 0:Vr.hrtime)==null?void 0:s.call(Vr);t=n[0]*1e3+n[1]/1e6}else t=Date.now();return t}const jr={debug:Ti()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Vh={enabled:!0,level:0};function zr(){}const lu={},du={once:!0};class Ei{constructor({id:e}={id:""}){this.VERSION=uu,this._startTs=Hr(),this._deltaTs=Hr(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new Dh(`__probe-${this.id}__`,Vh),this.timeStamp(`${this.id} started`),Nh(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Hr()-this._startTs).toPrecision(10))}getDelta(){return Number((Hr()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,r){this._storage.setConfiguration({[e]:r})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,r){if(!e)throw new Error(r||"Assertion failed")}warn(e){return this._getLogFunction(0,e,jr.warn,arguments,du)}error(e){return this._getLogFunction(0,e,jr.error,arguments)}deprecated(e,r){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${r}\` instead`)}removed(e,r){return this.error(`\`${e}\` has been removed. Use \`${r}\` instead`)}probe(e,r){return this._getLogFunction(e,r,jr.log,arguments,{time:!0,once:!0})}log(e,r){return this._getLogFunction(e,r,jr.debug,arguments)}info(e,r){return this._getLogFunction(e,r,console.info,arguments)}once(e,r){return this._getLogFunction(e,r,jr.debug||jr.info,arguments,du)}table(e,r,s){return r?this._getLogFunction(e,r,console.table||zr,s&&[s],{tag:jh(r)}):zr}time(e,r){return this._getLogFunction(e,r,console.time?console.time:console.info)}timeEnd(e,r){return this._getLogFunction(e,r,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,r){return this._getLogFunction(e,r,console.timeStamp||zr)}group(e,r,s={collapsed:!1}){const n=fu({logLevel:e,message:r,opts:s}),{collapsed:i}=s;return n.method=(i?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,r,s={}){return this.group(e,r,Object.assign({},s,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||zr)}withGroup(e,r,s){this.group(e,r)();try{s()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=hu(e)}_getLogFunction(e,r,s,n,i){if(this._shouldLog(e)){i=fu({logLevel:e,message:r,args:n,opts:i}),s=s||i.method,Si(s),i.total=this.getTotal(),i.delta=this.getDelta(),this._deltaTs=Hr();const o=i.tag||i.message;if(i.once&&o)if(!lu[o])lu[o]=Hr();else return zr;return r=Hh(this.id,i.message,i),s.bind(console,r,...i.args)}return zr}}Ei.VERSION=uu;function hu(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return Si(Number.isFinite(e)&&e>=0),e}function fu(t){const{logLevel:e,message:r}=t;t.logLevel=hu(e);const s=t.args?Array.from(t.args):[];for(;s.length&&s.shift()!==r;);switch(typeof e){case"string":case"function":r!==void 0&&s.unshift(r),t.message=e;break;case"object":Object.assign(t,e);break}typeof t.message=="function"&&(t.message=t.message());const n=typeof t.message;return Si(n==="string"||n==="object"),Object.assign(t,{args:s},t.opts)}function Hh(t,e,r){if(typeof e=="string"){const s=r.time?Fh(Ih(r.total)):"";e=r.time?`${t}: ${s}  ${e}`:`${t}: ${e}`,e=kh(e,r.color,r.background)}return e}function jh(t){for(const e in t)for(const r in t[e])return r||"untitled";return"empty"}const Mi="4.3.2",zh=Mi[0]>="0"&&Mi[0]<="9"?`v${Mi}`:"";function Jh(){const t=new Ei({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=t,globalThis.loaders.version=zh,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=t,t}const Kh=Jh();function Xh(t,e){return pu(t||{},e)}function pu(t,e,r=0){if(r>3)return e;const s={...t};for(const[n,i]of Object.entries(e))i&&typeof i=="object"&&!Array.isArray(i)?s[n]=pu(s[n]||{},e[n],r+1):s[n]=e[n];return s}function Wh(t){var e;globalThis.loaders||(globalThis.loaders={}),(e=globalThis.loaders).modules||(e.modules={}),Object.assign(globalThis.loaders.modules,t)}function Yh(t){var e,r;return((r=(e=globalThis.loaders)==null?void 0:e.modules)==null?void 0:r[t])||null}const $h="latest";function Qh(){var t;return(t=globalThis._loadersgl_)!=null&&t.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version}const mu=Qh();function jt(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const At=typeof process!="object"||String(process)!=="[object process]"||process.browser,Pi=typeof importScripts=="function",qh=typeof window<"u"&&typeof window.orientation<"u",gu=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);gu&&parseFloat(gu[1]);class Zh{constructor(e,r){ce(this,"name");ce(this,"workerThread");ce(this,"isRunning",!0);ce(this,"result");ce(this,"_resolve",()=>{});ce(this,"_reject",()=>{});this.name=e,this.workerThread=r,this.result=new Promise((s,n)=>{this._resolve=s,this._reject=n})}postMessage(e,r){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:r})}done(e){jt(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){jt(this.isRunning),this.isRunning=!1,this._reject(e)}}class Ri{terminate(){}}const Gi=new Map;function ef(t){jt(t.source&&!t.url||!t.source&&t.url);let e=Gi.get(t.source||t.url);return e||(t.url&&(e=tf(t.url),Gi.set(t.url,e)),t.source&&(e=yu(t.source),Gi.set(t.source,e))),jt(e),e}function tf(t){if(!t.startsWith("http"))return t;const e=rf(t);return yu(e)}function yu(t){const e=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(e)}function rf(t){return`try {
  importScripts('${t}');
} catch (error) {
  console.error(error);
  throw error;
}`}function _u(t,e=!0,r){const s=r||new Set;if(t){if(bu(t))s.add(t);else if(bu(t.buffer))s.add(t.buffer);else if(!ArrayBuffer.isView(t)&&e&&typeof t=="object")for(const n in t)_u(t[n],e,s)}return r===void 0?Array.from(s):[]}function bu(t){return t?t instanceof ArrayBuffer||typeof MessagePort<"u"&&t instanceof MessagePort||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas:!1}const Li=()=>{};class Oi{constructor(e){ce(this,"name");ce(this,"source");ce(this,"url");ce(this,"terminated",!1);ce(this,"worker");ce(this,"onMessage");ce(this,"onError");ce(this,"_loadableURL","");const{name:r,source:s,url:n}=e;jt(s||n),this.name=r,this.source=s,this.url=n,this.onMessage=Li,this.onError=i=>console.log(i),this.worker=At?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&At||typeof Ri<"u"&&!At}destroy(){this.onMessage=Li,this.onError=Li,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,r){r=r||_u(e),this.worker.postMessage(e,r)}_getErrorFromErrorEvent(e){let r="Failed to load ";return r+=`worker ${this.name} from ${this.url}. `,e.message&&(r+=`${e.message} in `),e.lineno&&(r+=`:${e.lineno}:${e.colno}`),new Error(r)}_createBrowserWorker(){this._loadableURL=ef({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=r=>{r.data?this.onMessage(r.data):this.onError(new Error("No data received"))},e.onerror=r=>{this.onError(this._getErrorFromErrorEvent(r)),this.terminated=!0},e.onmessageerror=r=>console.error(r),e}_createNodeWorker(){let e;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Ri(r,{eval:!1})}else if(this.source)e=new Ri(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",r=>{this.onMessage(r)}),e.on("error",r=>{this.onError(r)}),e.on("exit",r=>{}),e}}class sf{constructor(e){ce(this,"name","unnamed");ce(this,"source");ce(this,"url");ce(this,"maxConcurrency",1);ce(this,"maxMobileConcurrency",1);ce(this,"onDebug",()=>{});ce(this,"reuseWorkers",!0);ce(this,"props",{});ce(this,"jobQueue",[]);ce(this,"idleQueue",[]);ce(this,"count",0);ce(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return Oi.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,r=(n,i,o)=>n.done(o),s=(n,i)=>n.error(i)){const n=new Promise(i=>(this.jobQueue.push({name:e,onMessage:r,onError:s,onStart:i}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const r=this.jobQueue.shift();if(r){this.onDebug({message:"Starting job",name:r.name,workerThread:e,backlog:this.jobQueue.length});const s=new Zh(r.name,e);e.onMessage=n=>r.onMessage(s,n.type,n.payload),e.onError=n=>r.onError(s,n),r.onStart(s);try{await s.result}catch(n){console.error(`Worker exception: ${n}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!At||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Oi({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return qh?this.maxMobileConcurrency:this.maxConcurrency}}const nf={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},nr=class nr{constructor(e){ce(this,"props");ce(this,"workerPools",new Map);this.props={...nf},this.setProps(e),this.workerPools=new Map}static isSupported(){return Oi.isSupported()}static getWorkerFarm(e={}){return nr._workerFarm=nr._workerFarm||new nr({}),nr._workerFarm.setProps(e),nr._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const r of this.workerPools.values())r.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:r,source:s,url:n}=e;let i=this.workerPools.get(r);return i||(i=new sf({name:r,source:s,url:n}),i.setProps(this._getWorkerPoolProps()),this.workerPools.set(r,i)),i}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};ce(nr,"_workerFarm");let Zs=nr;function of(t,e={}){const r=e[t.id]||{},s=At?`${t.id}-worker.js`:`${t.id}-worker-node.js`;let n=r.workerUrl;if(!n&&t.id==="compression"&&(n=e.workerUrl),e._workerType==="test"&&(At?n=`modules/${t.module}/dist/${s}`:n=`modules/${t.module}/src/workers/${t.id}-worker-node.ts`),!n){let i=t.version;i==="latest"&&(i=$h);const o=i?`@${i}`:"";n=`https://unpkg.com/@loaders.gl/${t.module}${o}/dist/${s}`}return jt(n),n}function af(t,e=mu){jt(t,"no worker provided");const r=t.version;return!(!e||!r)}const Di={};async function br(t,e=null,r={},s=null){return e&&(t=uf(t,e,r,s)),Di[t]=Di[t]||cf(t),await Di[t]}function uf(t,e,r={},s=null){if(!r.useLocalLibraries&&t.startsWith("http"))return t;s=s||t;const n=r.modules||{};return n[s]?n[s]:At?r.CDN?(jt(r.CDN.startsWith("http")),`${r.CDN}/${e}@${mu}/dist/libs/${s}`):Pi?`../src/libs/${s}`:`modules/${e}/src/libs/${s}`:`modules/${e}/dist/libs/${s}`}async function cf(t){if(t.endsWith("wasm"))return await df(t);if(!At)try{const{requireFromFile:r}=globalThis.loaders||{};return await(r==null?void 0:r(t))}catch(r){return console.error(r),null}if(Pi)return importScripts(t);const e=await hf(t);return lf(e,t)}function lf(t,e){if(!At){const{requireFromString:s}=globalThis.loaders||{};return s==null?void 0:s(t,e)}if(Pi)return eval.call(globalThis,t),null;const r=document.createElement("script");r.id=e;try{r.appendChild(document.createTextNode(t))}catch{r.text=t}return document.body.appendChild(r),null}async function df(t){const{readFileAsArrayBuffer:e}=globalThis.loaders||{};return At||!e||t.startsWith("http")?await(await fetch(t)).arrayBuffer():await e(t)}async function hf(t){const{readFileAsText:e}=globalThis.loaders||{};return At||!e||t.startsWith("http")?await(await fetch(t)).text():await e(t)}function ff(t,e){return!Zs.isSupported()||!At&&!(e!=null&&e._nodeWorkers)?!1:t.worker&&(e==null?void 0:e.worker)}async function pf(t,e,r,s,n){const i=t.id,o=of(t,r),a=Zs.getWorkerFarm(r).getWorkerPool({name:i,url:o});r=JSON.parse(JSON.stringify(r)),s=JSON.parse(JSON.stringify(s||{}));const c=await a.startJob("process-on-worker",mf.bind(null,n));return c.postMessage("process",{input:e,options:r,context:s}),await(await c.result).result}async function mf(t,e,r,s){switch(r){case"done":e.done(s);break;case"error":e.error(new Error(s.error));break;case"process":const{id:n,input:i,options:o}=s;try{const a=await t(i,o);e.postMessage("done",{id:n,result:a})}catch(a){const c=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:n,error:c})}break;default:console.warn(`parse-with-worker unknown message ${r}`)}}function gf(t,e=5){return typeof t=="string"?t.slice(0,e):ArrayBuffer.isView(t)?xu(t.buffer,t.byteOffset,e):t instanceof ArrayBuffer?xu(t,0,e):""}function xu(t,e,r){if(t.byteLength<=e+r)return"";const s=new DataView(t);let n="";for(let i=0;i<r;i++)n+=String.fromCharCode(s.getUint8(e+i));return n}function yf(t){try{return JSON.parse(t)}catch{throw new Error(`Failed to parse JSON from data starting with "${gf(t)}"`)}}function _f(t,e,r){if(r=r||t.byteLength,t.byteLength<r||e.byteLength<r)return!1;const s=new Uint8Array(t),n=new Uint8Array(e);for(let i=0;i<s.length;++i)if(s[i]!==n[i])return!1;return!0}function bf(...t){return xf(t)}function xf(t){const e=t.map(i=>i instanceof ArrayBuffer?new Uint8Array(i):i),r=e.reduce((i,o)=>i+o.byteLength,0),s=new Uint8Array(r);let n=0;for(const i of e)s.set(i,n),n+=i.byteLength;return s.buffer}function Au(t,e,r){const s=r!==void 0?new Uint8Array(t).subarray(e,e+r):new Uint8Array(t).subarray(e);return new Uint8Array(s).buffer}function ms(t,e){return Ht(t>=0),Ht(e>0),t+(e-1)&~(e-1)}function Af(t,e,r){let s;if(t instanceof ArrayBuffer)s=new Uint8Array(t);else{const n=t.byteOffset,i=t.byteLength;s=new Uint8Array(t.buffer||t.arrayBuffer,n,i)}return e.set(s,r),r+ms(s.byteLength,4)}async function Bf(t){const e=[];for await(const r of t)e.push(r);return bf(...e)}let wf="";const Bu={};function vf(t){for(const e in Bu)if(t.startsWith(e)){const r=Bu[e];t=t.replace(e,r)}return!t.startsWith("http://")&&!t.startsWith("https://")&&(t=`${wf}${t}`),t}function Cf(t){return t&&typeof t=="object"&&t.isBuffer}function wu(t){if(Cf(t)||t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);if(typeof t=="string"){const e=t;return new TextEncoder().encode(e).buffer}if(t&&typeof t=="object"&&t._toArrayBuffer)return t._toArrayBuffer();throw new Error("toArrayBuffer")}function vu(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(e+1):""}function Tf(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(0,e):""}const Sf=t=>typeof t=="boolean",gs=t=>typeof t=="function",ys=t=>t!==null&&typeof t=="object",Cu=t=>ys(t)&&t.constructor==={}.constructor,Ef=t=>!!t&&typeof t[Symbol.iterator]=="function",Mf=t=>t&&typeof t[Symbol.asyncIterator]=="function",xr=t=>typeof Response<"u"&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json,Ar=t=>typeof Blob<"u"&&t instanceof Blob,Pf=t=>t&&typeof t=="object"&&t.isBuffer,Rf=t=>typeof ReadableStream<"u"&&t instanceof ReadableStream||ys(t)&&gs(t.tee)&&gs(t.cancel)&&gs(t.getReader),Gf=t=>ys(t)&&gs(t.read)&&gs(t.pipe)&&Sf(t.readable),Tu=t=>Rf(t)||Gf(t);class Lf extends Error{constructor(r,s){super(r);ce(this,"reason");ce(this,"url");ce(this,"response");this.reason=s.reason,this.url=s.url,this.response=s.response}}const Of=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Df=/^([-\w.]+\/[-\w.+]+)/;function Su(t,e){return t.toLowerCase()===e.toLowerCase()}function If(t){const e=Df.exec(t);return e?e[1]:t}function Eu(t){const e=Of.exec(t);return e?e[1]:""}const Mu=/\?.*/;function Ff(t){const e=t.match(Mu);return e&&e[0]}function Ii(t){return t.replace(Mu,"")}function Uf(t){if(t.length<50)return t;const e=t.slice(t.length-15);return`${t.substr(0,32)}...${e}`}function en(t){return xr(t)?t.url:Ar(t)?t.name||"":typeof t=="string"?t:""}function Fi(t){if(xr(t)){const e=t,r=e.headers.get("content-type")||"",s=Ii(e.url);return If(r)||Eu(s)}return Ar(t)?t.type||"":typeof t=="string"?Eu(t):""}function kf(t){return xr(t)?t.headers["content-length"]||-1:Ar(t)?t.size:typeof t=="string"?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}async function Pu(t){if(xr(t))return t;const e={},r=kf(t);r>=0&&(e["content-length"]=String(r));const s=en(t),n=Fi(t);n&&(e["content-type"]=n);const i=await Hf(t);i&&(e["x-first-bytes"]=i),typeof t=="string"&&(t=new TextEncoder().encode(t));const o=new Response(t,{headers:e});return Object.defineProperty(o,"url",{value:s}),o}async function Nf(t){if(!t.ok)throw await Vf(t)}async function Vf(t){const e=Uf(t.url);let r=`Failed to fetch resource (${t.status}) ${t.statusText}: ${e}`;r=r.length>100?`${r.slice(0,100)}...`:r;const s={reason:t.statusText,url:t.url,response:t};try{const n=t.headers.get("Content-Type");s.reason=!t.bodyUsed&&(n!=null&&n.includes("application/json"))?await t.json():await t.text()}catch{}return new Lf(r,s)}async function Hf(t){if(typeof t=="string")return`data:,${t.slice(0,5)}`;if(t instanceof Blob){const e=t.slice(0,5);return await new Promise(r=>{const s=new FileReader;s.onload=n=>{var i;return r((i=n==null?void 0:n.target)==null?void 0:i.result)},s.readAsDataURL(e)})}if(t instanceof ArrayBuffer){const e=t.slice(0,5);return`data:base64,${jf(e)}`}return null}function jf(t){let e="";const r=new Uint8Array(t);for(let s=0;s<r.byteLength;s++)e+=String.fromCharCode(r[s]);return btoa(e)}function zf(t){return!Jf(t)&&!Kf(t)}function Jf(t){return t.startsWith("http:")||t.startsWith("https:")}function Kf(t){return t.startsWith("data:")}async function Ru(t,e){var r,s;if(typeof t=="string"){const n=vf(t);return zf(n)&&((r=globalThis.loaders)!=null&&r.fetchNode)?(s=globalThis.loaders)==null?void 0:s.fetchNode(n,e):await fetch(n,e)}return await Pu(t)}const Gu=new Ei({id:"loaders.gl"});class Xf{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class Wf{constructor(){ce(this,"console");this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const Lu={fetch:null,mimeType:void 0,nothrow:!1,log:new Wf,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:$s,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},Yf={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Ou(){globalThis.loaders=globalThis.loaders||{};const{loaders:t}=globalThis;return t._state||(t._state={}),t._state}function Du(){const t=Ou();return t.globalOptions=t.globalOptions||{...Lu},t.globalOptions}function $f(t,e,r,s){return r=r||[],r=Array.isArray(r)?r:[r],Qf(t,r),Zf(e,t,s)}function Qf(t,e){Iu(t,null,Lu,Yf,e);for(const r of e){const s=t&&t[r.id]||{},n=r.options&&r.options[r.id]||{},i=r.deprecatedOptions&&r.deprecatedOptions[r.id]||{};Iu(s,r.id,n,i,e)}}function Iu(t,e,r,s,n){const i=e||"Top level",o=e?`${e}.`:"";for(const a in t){const c=!e&&ys(t[a]),m=a==="baseUri"&&!e,_=a==="workerUrl"&&e;if(!(a in r)&&!m&&!_){if(a in s)Gu.warn(`${i} loader option '${o}${a}' no longer supported, use '${s[a]}'`)();else if(!c){const v=qf(a,n);Gu.warn(`${i} loader option '${o}${a}' not recognized. ${v}`)()}}}}function qf(t,e){const r=t.toLowerCase();let s="";for(const n of e)for(const i in n.options){if(t===i)return`Did you mean '${n.id}.${i}'?`;const o=i.toLowerCase();(r.startsWith(o)||o.startsWith(r))&&(s=s||`Did you mean '${n.id}.${i}'?`)}return s}function Zf(t,e,r){const s={...t.options||{}};return ep(s,r),s.log===null&&(s.log=new Xf),Fu(s,Du()),Fu(s,e),s}function Fu(t,e){for(const r in e)if(r in e){const s=e[r];Cu(s)&&Cu(t[r])?t[r]={...t[r],...e[r]}:t[r]=e[r]}}function ep(t,e){e&&!("baseUri"in t)&&(t.baseUri=e)}function Ui(t){return t?(Array.isArray(t)&&(t=t[0]),Array.isArray(t==null?void 0:t.extensions)):!1}function Uu(t){Ht(t,"null loader"),Ht(Ui(t),"invalid loader");let e;return Array.isArray(t)&&(e=t[1],t=t[0],t={...t,options:{...t.options,...e}}),(t!=null&&t.parseTextSync||t!=null&&t.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}const tp=()=>{const t=Ou();return t.loaderRegistry=t.loaderRegistry||[],t.loaderRegistry};function rp(){return tp()}const sp=/\.([^.]+)$/;async function np(t,e=[],r,s){if(!Nu(t))return null;let n=ku(t,e,{...r,nothrow:!0},s);if(n)return n;if(Ar(t)&&(t=await t.slice(0,10).arrayBuffer(),n=ku(t,e,r,s)),!n&&!(r!=null&&r.nothrow))throw new Error(Vu(t));return n}function ku(t,e=[],r,s){if(!Nu(t))return null;if(e&&!Array.isArray(e))return Uu(e);let n=[];e&&(n=n.concat(e)),r!=null&&r.ignoreRegisteredLoaders||n.push(...rp()),op(n);const i=ip(t,n,r,s);if(!i&&!(r!=null&&r.nothrow))throw new Error(Vu(t));return i}function ip(t,e,r,s){const n=en(t),i=Fi(t),o=Ii(n)||(s==null?void 0:s.url);let a=null,c="";return r!=null&&r.mimeType&&(a=ki(e,r==null?void 0:r.mimeType),c=`match forced by supplied MIME type ${r==null?void 0:r.mimeType}`),a=a||ap(e,o),c=c||(a?`matched url ${o}`:""),a=a||ki(e,i),c=c||(a?`matched MIME type ${i}`:""),a=a||cp(e,t),c=c||(a?`matched initial data ${ju(t)}`:""),r!=null&&r.fallbackMimeType&&(a=a||ki(e,r==null?void 0:r.fallbackMimeType),c=c||(a?`matched fallback MIME type ${i}`:"")),c&&Kh.log(1,`selectLoader selected ${a==null?void 0:a.name}: ${c}.`),a}function Nu(t){return!(t instanceof Response&&t.status===204)}function Vu(t){const e=en(t),r=Fi(t);let s="No valid loader found (";s+=e?`${vu(e)}, `:"no url provided, ",s+=`MIME type: ${r?`"${r}"`:"not provided"}, `;const n=t?ju(t):"";return s+=n?` first bytes: "${n}"`:"first bytes: not available",s+=")",s}function op(t){for(const e of t)Uu(e)}function ap(t,e){const r=e&&sp.exec(e),s=r&&r[1];return s?up(t,s):null}function up(t,e){e=e.toLowerCase();for(const r of t)for(const s of r.extensions)if(s.toLowerCase()===e)return r;return null}function ki(t,e){var r;for(const s of t)if((r=s.mimeTypes)!=null&&r.some(n=>Su(e,n))||Su(e,`application/x.${s.id}`))return s;return null}function cp(t,e){if(!e)return null;for(const r of t)if(typeof e=="string"){if(lp(e,r))return r}else if(ArrayBuffer.isView(e)){if(Hu(e.buffer,e.byteOffset,r))return r}else if(e instanceof ArrayBuffer&&Hu(e,0,r))return r;return null}function lp(t,e){return e.testText?e.testText(t):(Array.isArray(e.tests)?e.tests:[e.tests]).some(r=>t.startsWith(r))}function Hu(t,e,r){return(Array.isArray(r.tests)?r.tests:[r.tests]).some(s=>dp(t,e,r,s))}function dp(t,e,r,s){if(s instanceof ArrayBuffer)return _f(s,t,s.byteLength);switch(typeof s){case"function":return s(t);case"string":const n=Ni(t,e,s.length);return s===n;default:return!1}}function ju(t,e=5){return typeof t=="string"?t.slice(0,e):ArrayBuffer.isView(t)?Ni(t.buffer,t.byteOffset,e):t instanceof ArrayBuffer?Ni(t,0,e):""}function Ni(t,e,r){if(t.byteLength<e+r)return"";const s=new DataView(t);let n="";for(let i=0;i<r;i++)n+=String.fromCharCode(s.getUint8(e+i));return n}const hp=256*1024;function*fp(t,e){const r=(e==null?void 0:e.chunkSize)||hp;let s=0;const n=new TextEncoder;for(;s<t.length;){const i=Math.min(t.length-s,r),o=t.slice(s,s+i);s+=i,yield n.encode(o)}}const pp=256*1024;function*mp(t,e={}){const{chunkSize:r=pp}=e;let s=0;for(;s<t.byteLength;){const n=Math.min(t.byteLength-s,r),i=new ArrayBuffer(n),o=new Uint8Array(t,s,n);new Uint8Array(i).set(o),s+=n,yield i}}const gp=1024*1024;async function*yp(t,e){const r=(e==null?void 0:e.chunkSize)||gp;let s=0;for(;s<t.size;){const n=s+r,i=await t.slice(s,n).arrayBuffer();s=n,yield i}}function zu(t,e){return $s?_p(t,e):bp(t)}async function*_p(t,e){const r=t.getReader();let s;try{for(;;){const n=s||r.read();e!=null&&e._streamReadAhead&&(s=r.read());const{done:i,value:o}=await n;if(i)return;yield wu(o)}}catch{r.releaseLock()}}async function*bp(t,e){for await(const r of t)yield wu(r)}function xp(t,e){if(typeof t=="string")return fp(t,e);if(t instanceof ArrayBuffer)return mp(t,e);if(Ar(t))return yp(t,e);if(Tu(t))return zu(t,e);if(xr(t))return zu(t.body,e);throw new Error("makeIterator")}const Ju="Cannot convert supplied data type";function Ap(t,e,r){if(e.text&&typeof t=="string")return t;if(Pf(t)&&(t=t.buffer),t instanceof ArrayBuffer){const s=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(s):s}if(ArrayBuffer.isView(t)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);let s=t.buffer;const n=t.byteLength||t.length;return(t.byteOffset!==0||n!==s.byteLength)&&(s=s.slice(t.byteOffset,t.byteOffset+n)),s}throw new Error(Ju)}async function Bp(t,e,r){const s=t instanceof ArrayBuffer||ArrayBuffer.isView(t);if(typeof t=="string"||s)return Ap(t,e);if(Ar(t)&&(t=await Pu(t)),xr(t)){const n=t;return await Nf(n),e.binary?await n.arrayBuffer():await n.text()}if(Tu(t)&&(t=xp(t,r)),Ef(t)||Mf(t))return Bf(t);throw new Error(Ju)}function Ku(t,e){const r=Du(),s=t||r;return typeof s.fetch=="function"?s.fetch:ys(s.fetch)?n=>Ru(n,s.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:Ru}function wp(t,e,r){if(r)return r;const s={fetch:Ku(e,t),...t};if(s.url){const n=Ii(s.url);s.baseUrl=n,s.queryString=Ff(s.url),s.filename=vu(n),s.baseUrl=Tf(n)}return Array.isArray(s.loaders)||(s.loaders=null),s}function vp(t,e){if(t&&!Array.isArray(t))return t;let r;if(t&&(r=Array.isArray(t)?t:[t]),e&&e.loaders){const s=Array.isArray(e.loaders)?e.loaders:[e.loaders];r=r?[...r,...s]:s}return r&&r.length?r:void 0}async function tn(t,e,r,s){e&&!Array.isArray(e)&&!Ui(e)&&(s=void 0,r=e,e=void 0),t=await t,r=r||{};const n=en(t),i=vp(e,s),o=await np(t,i,r);return o?(r=$f(r,o,i,n),s=wp({url:n,_parse:tn,loaders:i},r,s||null),await Cp(o,t,r,s)):null}async function Cp(t,e,r,s){if(af(t),r=Xh(t.options,r),xr(e)){const i=e,{ok:o,redirected:a,status:c,statusText:m,type:_,url:v}=i,P=Object.fromEntries(i.headers.entries());s.response={headers:P,ok:o,redirected:a,status:c,statusText:m,type:_,url:v}}e=await Bp(e,t,r);const n=t;if(n.parseTextSync&&typeof e=="string")return n.parseTextSync(e,r,s);if(ff(t,r))return await pf(t,e,r,s,tn);if(n.parseText&&typeof e=="string")return await n.parseText(e,r,s);if(n.parse)return await n.parse(e,r,s);throw jt(!n.parseSync),new Error(`${t.id} loader - no parser found and worker is disabled`)}function Tp(t){switch(t.constructor){case Int8Array:return"int8";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int16Array:return"int16";case Uint16Array:return"uint16";case Int32Array:return"int32";case Uint32Array:return"uint32";case Float32Array:return"float32";case Float64Array:return"float64";default:return"null"}}function Sp(t){let e=1/0,r=1/0,s=1/0,n=-1/0,i=-1/0,o=-1/0;const a=t.POSITION?t.POSITION.value:[],c=a&&a.length;for(let m=0;m<c;m+=3){const _=a[m],v=a[m+1],P=a[m+2];e=_<e?_:e,r=v<r?v:r,s=P<s?P:s,n=_>n?_:n,i=v>i?v:i,o=P>o?P:o}return[[e,r,s],[n,i,o]]}function Ep(t,e,r){const s=Tp(e.value),n=r||Mp(e);return{name:t,type:{type:"fixed-size-list",listSize:e.size,children:[{name:"value",type:s}]},nullable:!1,metadata:n}}function Mp(t){const e={};return"byteOffset"in t&&(e.byteOffset=t.byteOffset.toString(10)),"byteStride"in t&&(e.byteStride=t.byteStride.toString(10)),"normalized"in t&&(e.normalized=t.normalized.toString()),e}async function Pp(t,e,r,s){let n,i;!Array.isArray(e)&&!Ui(e)?(n=[],i=e):(n=e,i=r);const o=Ku(i);let a=t;return typeof t=="string"&&(a=await o(t)),Ar(t)&&(a=await o(t)),Array.isArray(n)?await tn(a,n,i):await tn(a,n,i)}const Rp="4.3.2",Gp=(El=globalThis.loaders)==null?void 0:El.parseImageNode,Vi=typeof Image<"u",Hi=typeof ImageBitmap<"u",Lp=!!Gp,ji=$s?!0:Lp;function Op(t){switch(t){case"auto":return Hi||Vi||ji;case"imagebitmap":return Hi;case"image":return Vi;case"data":return ji;default:throw new Error(`@loaders.gl/images: image ${t} not supported in this environment`)}}function Dp(){if(Hi)return"imagebitmap";if(Vi)return"image";if(ji)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function Ip(t){const e=Fp(t);if(!e)throw new Error("Not an image");return e}function Xu(t){switch(Ip(t)){case"data":return t;case"image":case"imagebitmap":const e=document.createElement("canvas"),r=e.getContext("2d");if(!r)throw new Error("getImageData");return e.width=t.width,e.height=t.height,r.drawImage(t,0,0),r.getImageData(0,0,t.width,t.height);default:throw new Error("getImageData")}}function Fp(t){return typeof ImageBitmap<"u"&&t instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&t instanceof Image?"image":t&&typeof t=="object"&&t.data&&t.width&&t.height?"data":null}const Up=/^data:image\/svg\+xml/,kp=/\.svg((\?|#).*)?$/;function zi(t){return t&&(Up.test(t)||kp.test(t))}function Np(t,e){if(zi(e)){let r=new TextDecoder().decode(t);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(s){throw new Error(s.message)}return`data:image/svg+xml;base64,${btoa(r)}`}return Wu(t,e)}function Wu(t,e){if(zi(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(t)])}async function Yu(t,e,r){const s=Np(t,r),n=self.URL||self.webkitURL,i=typeof s!="string"&&n.createObjectURL(s);try{return await Vp(i||s,e)}finally{i&&n.revokeObjectURL(i)}}async function Vp(t,e){const r=new Image;return r.src=t,e.image&&e.image.decode&&r.decode?(await r.decode(),r):await new Promise((s,n)=>{try{r.onload=()=>s(r),r.onerror=i=>{const o=i instanceof Error?i.message:"error";n(new Error(o))}}catch(i){n(i)}})}const Hp={};let $u=!0;async function jp(t,e,r){let s;zi(r)?s=await Yu(t,e,r):s=Wu(t,r);const n=e&&e.imagebitmap;return await zp(s,n)}async function zp(t,e=null){if((Jp(e)||!$u)&&(e=null),e)try{return await createImageBitmap(t,e)}catch(r){console.warn(r),$u=!1}return await createImageBitmap(t)}function Jp(t){for(const e in t||Hp)return!1;return!0}function Kp(t){return!$p(t,"ftyp",4)||!(t[8]&96)?null:Xp(t)}function Xp(t){switch(Wp(t,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function Wp(t,e,r){return String.fromCharCode(...t.slice(e,r))}function Yp(t){return[...t].map(e=>e.charCodeAt(0))}function $p(t,e,r=0){const s=Yp(e);for(let n=0;n<s.length;++n)if(s[n]!==t[n+r])return!1;return!0}const Ot=!1,_s=!0;function Ji(t){const e=bs(t);return qp(e)||tm(e)||Zp(e)||em(e)||Qp(e)}function Qp(t){const e=new Uint8Array(t instanceof DataView?t.buffer:t),r=Kp(e);return r?{mimeType:r.mimeType,width:0,height:0}:null}function qp(t){const e=bs(t);return e.byteLength>=24&&e.getUint32(0,Ot)===2303741511?{mimeType:"image/png",width:e.getUint32(16,Ot),height:e.getUint32(20,Ot)}:null}function Zp(t){const e=bs(t);return e.byteLength>=10&&e.getUint32(0,Ot)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,_s),height:e.getUint16(8,_s)}:null}function em(t){const e=bs(t);return e.byteLength>=14&&e.getUint16(0,Ot)===16973&&e.getUint32(2,_s)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,_s),height:e.getUint32(22,_s)}:null}function tm(t){const e=bs(t);if(!(e.byteLength>=3&&e.getUint16(0,Ot)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:s}=rm();let n=2;for(;n+9<e.byteLength;){const i=e.getUint16(n,Ot);if(s.has(i))return{mimeType:"image/jpeg",height:e.getUint16(n+5,Ot),width:e.getUint16(n+7,Ot)};if(!r.has(i))return null;n+=2,n+=e.getUint16(n,Ot)}return null}function rm(){const t=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)t.add(e);return{tableMarkers:t,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function bs(t){if(t instanceof DataView)return t;if(ArrayBuffer.isView(t))return new DataView(t.buffer);if(t instanceof ArrayBuffer)return new DataView(t);throw new Error("toDataView")}async function sm(t,e){var n;const{mimeType:r}=Ji(t)||{},s=(n=globalThis.loaders)==null?void 0:n.parseImageNode;return Ht(s),await s(t,r)}async function nm(t,e,r){e=e||{};const s=(e.image||{}).type||"auto",{url:n}=r||{},i=im(s);let o;switch(i){case"imagebitmap":o=await jp(t,e,n);break;case"image":o=await Yu(t,e,n);break;case"data":o=await sm(t);break;default:Ht(!1)}return s==="data"&&(o=Xu(o)),o}function im(t){switch(t){case"auto":case"data":return Dp();default:return Op(t),t}}const om=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],am=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],um={image:{type:"auto",decode:!0}},cm={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:Rp,mimeTypes:am,extensions:om,parse:nm,tests:[t=>!!Ji(new DataView(t))],options:um},Ki={};function lm(t){if(Ki[t]===void 0){const e=$s?hm(t):dm(t);Ki[t]=e}return Ki[t]}function dm(t){var s,n;const e=["image/png","image/jpeg","image/gif"],r=((s=globalThis.loaders)==null?void 0:s.imageFormatsNode)||e;return!!((n=globalThis.loaders)!=null&&n.parseImageNode)&&r.includes(t)}function hm(t){switch(t){case"image/avif":case"image/webp":return fm(t);default:return!0}}function fm(t){try{return document.createElement("canvas").toDataURL(t).indexOf(`data:${t}`)===0}catch{return!1}}function ft(t,e){if(!t)throw new Error(e||"assert failed: gltf")}const Qu={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},qu={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Zu=["SCALAR","VEC2","VEC3","VEC4"],pm=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],mm=new Map(pm),gm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ym={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},_m={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function ec(t){return Zu[t-1]||Zu[0]}function rn(t){const e=mm.get(t.constructor);if(!e)throw new Error("Illegal typed array");return e}function Xi(t,e){const r=_m[t.componentType],s=gm[t.type],n=ym[t.componentType],i=t.count*s,o=t.count*s*n;ft(o>=0&&o<=e.byteLength);const a=qu[t.componentType],c=Qu[t.type];return{ArrayType:r,length:i,byteLength:o,componentByteSize:a,numberOfComponentsInElement:c}}function bm(t,e,r){const s=t.bufferViews[r];ft(s);const n=s.buffer,i=e[n];ft(i);const o=(s.byteOffset||0)+i.byteOffset;return new Uint8Array(i.arrayBuffer,o,s.byteLength)}function xm(t,e,r){var U,X;const s=typeof r=="number"?(U=t.accessors)==null?void 0:U[r]:r;if(!s)throw new Error(`No gltf accessor ${JSON.stringify(r)}`);const n=(X=t.bufferViews)==null?void 0:X[s.bufferView||0];if(!n)throw new Error(`No gltf buffer view for accessor ${n}`);const{arrayBuffer:i,byteOffset:o}=e[n.buffer],a=(o||0)+(s.byteOffset||0)+(n.byteOffset||0),{ArrayType:c,length:m,componentByteSize:_,numberOfComponentsInElement:v}=Xi(s,n),P=_*v,O=n.byteStride||P;if(typeof n.byteStride>"u"||n.byteStride===P)return new c(i,a,m);const D=new c(m);for(let Y=0;Y<s.count;Y++){const Q=new c(i,a+Y*O,v);D.set(Q,Y*v)}return D}function Am(){return{asset:{version:"2.0",generator:"loaders.gl"},buffers:[],extensions:{},extensionsRequired:[],extensionsUsed:[]}}class Ne{constructor(e){ce(this,"gltf");ce(this,"sourceBuffers");ce(this,"byteLength");this.gltf={json:(e==null?void 0:e.json)||Am(),buffers:(e==null?void 0:e.buffers)||[],images:(e==null?void 0:e.images)||[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}hasExtension(e){const r=this.getUsedExtensions().find(n=>n===e),s=this.getRequiredExtensions().find(n=>n===e);return typeof r=="string"||typeof s=="string"}getExtension(e){const r=this.getUsedExtensions().find(n=>n===e),s=this.json.extensions||{};return r?s[e]:null}getRequiredExtension(e){return this.getRequiredExtensions().find(r=>r===e)?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(e,r){return(e.extensions||{})[r]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,r){if(typeof r=="object")return r;const s=this.json[e]&&this.json[e][r];if(!s)throw new Error(`glTF file error: Could not find ${e}[${r}]`);return s}getTypedArrayForBufferView(e){e=this.getBufferView(e);const r=e.buffer,s=this.gltf.buffers[r];ft(s);const n=(e.byteOffset||0)+s.byteOffset;return new Uint8Array(s.arrayBuffer,n,e.byteLength)}getTypedArrayForAccessor(e){const r=this.getAccessor(e);return xm(this.gltf.json,this.gltf.buffers,r)}getTypedArrayForImageData(e){e=this.getAccessor(e);const r=this.getBufferView(e.bufferView),s=this.getBuffer(r.buffer).data,n=r.byteOffset||0;return new Uint8Array(s,n,r.byteLength)}addApplicationData(e,r){return this.json[e]=r,this}addExtraData(e,r){return this.json.extras=this.json.extras||{},this.json.extras[e]=r,this}addObjectExtension(e,r,s){return e.extensions=e.extensions||{},e.extensions[r]=s,this.registerUsedExtension(r),this}setObjectExtension(e,r,s){const n=e.extensions||{};n[r]=s}removeObjectExtension(e,r){const s=(e==null?void 0:e.extensions)||{};if(s[r]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const n=this.json.extensionsRemoved;n.includes(r)||n.push(r)}delete s[r]}addExtension(e,r={}){return ft(r),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=r,this.registerUsedExtension(e),r}addRequiredExtension(e,r={}){return ft(r),this.addExtension(e,r),this.registerRequiredExtension(e),r}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find(r=>r===e)||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find(r=>r===e)||this.json.extensionsRequired.push(e)}removeExtension(e){var r;if((r=this.json.extensions)!=null&&r[e]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const s=this.json.extensionsRemoved;s.includes(e)||s.push(e)}this.json.extensions&&delete this.json.extensions[e],this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e)}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:r}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:r}),this.json.scenes.length-1}addNode(e){const{meshIndex:r,matrix:s}=e;this.json.nodes=this.json.nodes||[];const n={mesh:r};return s&&(n.matrix=s),this.json.nodes.push(n),this.json.nodes.length-1}addMesh(e){const{attributes:r,indices:s,material:n,mode:i=4}=e,o={primitives:[{attributes:this._addAttributes(r),mode:i}]};if(s){const a=this._addIndices(s);o.primitives[0].indices=a}return Number.isFinite(n)&&(o.primitives[0].material=n),this.json.meshes=this.json.meshes||[],this.json.meshes.push(o),this.json.meshes.length-1}addPointCloud(e){const r={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(r),this.json.meshes.length-1}addImage(e,r){const s=Ji(e),n=r||(s==null?void 0:s.mimeType),i={bufferView:this.addBufferView(e),mimeType:n};return this.json.images=this.json.images||[],this.json.images.push(i),this.json.images.length-1}addBufferView(e,r=0,s=this.byteLength){const n=e.byteLength;ft(Number.isFinite(n)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const i={buffer:r,byteOffset:s,byteLength:n};return this.byteLength+=ms(n,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(i),this.json.bufferViews.length-1}addAccessor(e,r){const s={bufferView:e,type:ec(r.size),componentType:r.componentType,count:r.count,max:r.max,min:r.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(s),this.json.accessors.length-1}addBinaryBuffer(e,r={size:3}){const s=this.addBufferView(e);let n={min:r.min,max:r.max};(!n.min||!n.max)&&(n=this._getAccessorMinMax(e,r.size));const i={size:r.size,componentType:rn(e),count:Math.round(e.length/r.size),min:n.min,max:n.max};return this.addAccessor(s,Object.assign(i,r))}addTexture(e){const{imageIndex:r}=e,s={source:r};return this.json.textures=this.json.textures||[],this.json.textures.push(s),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var i,o;const e=this.byteLength,r=new ArrayBuffer(e),s=new Uint8Array(r);let n=0;for(const a of this.sourceBuffers||[])n=Af(a,s,n);(o=(i=this.json)==null?void 0:i.buffers)!=null&&o[0]?this.json.buffers[0].byteLength=e:this.json.buffers=[{byteLength:e}],this.gltf.binary=r,this.sourceBuffers=[r],this.gltf.buffers=[{arrayBuffer:r,byteOffset:0,byteLength:r.byteLength}]}_removeStringFromArray(e,r){let s=!0;for(;s;){const n=e.indexOf(r);n>-1?e.splice(n,1):s=!1}}_addAttributes(e={}){const r={};for(const s in e){const n=e[s],i=this._getGltfAttributeName(s),o=this.addBinaryBuffer(n.value,n);r[i]=o}return r}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,r){const s={min:null,max:null};if(e.length<r)return s;s.min=[],s.max=[];const n=e.subarray(0,r);for(const i of n)s.min.push(i),s.max.push(i);for(let i=r;i<e.length;i+=r)for(let o=0;o<r;o++)s.min[0+o]=Math.min(s.min[0+o],e[i+o]),s.max[0+o]=Math.max(s.max[0+o],e[i+o]);return s}}function tc(t){return(t%1+1)%1}const rc={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16,BOOLEAN:1,STRING:1,ENUM:1},Bm={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:BigInt64Array,UINT64:BigUint64Array,FLOAT32:Float32Array,FLOAT64:Float64Array},sc={INT8:1,UINT8:1,INT16:2,UINT16:2,INT32:4,UINT32:4,INT64:8,UINT64:8,FLOAT32:4,FLOAT64:8};function Wi(t,e){return sc[e]*rc[t]}function sn(t,e,r,s){if(r!=="UINT8"&&r!=="UINT16"&&r!=="UINT32"&&r!=="UINT64")return null;const n=t.getTypedArrayForBufferView(e),i=nn(n,"SCALAR",r,s+1);return i instanceof BigInt64Array||i instanceof BigUint64Array?null:i}function nn(t,e,r,s=1){const n=rc[e],i=Bm[r],o=sc[r],a=s*n,c=a*o;let m=t.buffer,_=t.byteOffset;return _%o!==0&&(m=new Uint8Array(m).slice(_,_+c).buffer,_=0),new i(m,_,a)}function Yi(t,e,r){var m,_,v,P,O;const s=`TEXCOORD_${e.texCoord||0}`,n=r.attributes[s],i=t.getTypedArrayForAccessor(n),o=t.gltf.json,a=e.index,c=(_=(m=o.textures)==null?void 0:m[a])==null?void 0:_.source;if(typeof c<"u"){const D=(P=(v=o.images)==null?void 0:v[c])==null?void 0:P.mimeType,U=(O=t.gltf.images)==null?void 0:O[c];if(U&&typeof U.width<"u"){const X=[];for(let Y=0;Y<i.length;Y+=2){const Q=wm(U,D,i,Y,e.channels);X.push(Q)}return X}}return[]}function nc(t,e,r,s,n){if(!(r!=null&&r.length))return;const i=[];for(const _ of r){let v=s.findIndex(P=>P===_);v===-1&&(v=s.push(_)-1),i.push(v)}const o=new Uint32Array(i),a=t.gltf.buffers.push({arrayBuffer:o.buffer,byteOffset:o.byteOffset,byteLength:o.byteLength})-1,c=t.addBufferView(o,a,0),m=t.addAccessor(c,{size:1,componentType:rn(o),count:o.length});n.attributes[e]=m}function wm(t,e,r,s,n=[0]){const i={r:{offset:0,shift:0},g:{offset:1,shift:8},b:{offset:2,shift:16},a:{offset:3,shift:24}},o=r[s],a=r[s+1];let c=1;e&&(e.indexOf("image/jpeg")!==-1||e.indexOf("image/png")!==-1)&&(c=4);const m=vm(o,a,t,c);let _=0;for(const v of n){const P=typeof v=="number"?Object.values(i)[v]:i[v],O=m+P.offset,D=Xu(t);if(D.data.length<=O)throw new Error(`${D.data.length} <= ${O}`);const U=D.data[O];_|=U<<P.shift}return _}function vm(t,e,r,s=1){const n=r.width,i=tc(t)*(n-1),o=Math.round(i),a=r.height,c=tc(e)*(a-1),m=Math.round(c),_=r.components?r.components:s;return(m*n+o)*_}function ic(t,e,r,s,n){const i=[];for(let o=0;o<e;o++){const a=r[o],c=r[o+1]-r[o];if(c+a>s)break;const m=a/n,_=c/n;i.push(t.slice(m,m+_))}return i}function oc(t,e,r){const s=[];for(let n=0;n<e;n++){const i=n*r;s.push(t.slice(i,i+r))}return s}function ac(t,e,r,s){if(r)throw new Error("Not implemented - arrayOffsets for strings is specified");if(s){const n=[],i=new TextDecoder("utf8");let o=0;for(let a=0;a<t;a++){const c=s[a+1]-s[a];if(c+o<=e.length){const m=e.subarray(o,c+o),_=i.decode(m);n.push(_),o+=c}}return n}return[]}const Jr="EXT_mesh_features",Cm=Jr;async function Tm(t,e){const r=new Ne(t);Em(r,e)}function Sm(t,e){const r=new Ne(t);return Pm(r),r.createBinaryChunk(),r.gltf}function Em(t,e){const r=t.gltf.json;if(r.meshes)for(const s of r.meshes)for(const n of s.primitives)Mm(t,n,e)}function Mm(t,e,r){var n,i,o,a;if(!((n=r==null?void 0:r.gltf)!=null&&n.loadBuffers))return;const s=(o=(i=e.extensions)==null?void 0:i[Jr])==null?void 0:o.featureIds;if(s)for(const c of s){let m;if(typeof c.attribute<"u"){const _=`_FEATURE_ID_${c.attribute}`,v=e.attributes[_];m=t.getTypedArrayForAccessor(v)}else typeof c.texture<"u"&&((a=r==null?void 0:r.gltf)!=null&&a.loadImages)?m=Yi(t,c.texture,e):m=[];c.data=m}}function Pm(t,e){const r=t.gltf.json.meshes;if(r)for(const s of r)for(const n of s.primitives)Gm(t,n)}function Rm(t,e,r,s){e.extensions||(e.extensions={});let n=e.extensions[Jr];n||(n={featureIds:[]},e.extensions[Jr]=n);const{featureIds:i}=n,o={featureCount:r.length,propertyTable:s,data:r};i.push(o),t.addObjectExtension(e,Jr,n)}function Gm(t,e){var n;const r=(n=e.extensions)==null?void 0:n[Jr];if(!r)return;const s=r.featureIds;s.forEach((i,o)=>{if(i.data){const{accessorKey:a,index:c}=Lm(e.attributes),m=new Uint32Array(i.data);s[o]={featureCount:m.length,propertyTable:i.propertyTable,attribute:c},t.gltf.buffers.push({arrayBuffer:m.buffer,byteOffset:m.byteOffset,byteLength:m.byteLength});const _=t.addBufferView(m),v=t.addAccessor(_,{size:1,componentType:rn(m),count:m.length});e.attributes[a]=v}})}function Lm(t){const e="_FEATURE_ID_",r=Object.keys(t).filter(n=>n.indexOf(e)===0);let s=-1;for(const n of r){const i=Number(n.substring(e.length));i>s&&(s=i)}return s++,{accessorKey:`${e}${s}`,index:s}}const Om=Object.freeze(Object.defineProperty({__proto__:null,createExtMeshFeatures:Rm,decode:Tm,encode:Sm,name:Cm},Symbol.toStringTag,{value:"Module"})),Kr="EXT_structural_metadata",Dm=Kr;async function Im(t,e){const r=new Ne(t);Um(r,e)}function Fm(t,e){const r=new Ne(t);return eg(r),r.createBinaryChunk(),r.gltf}function Um(t,e){var s,n;if(!((s=e.gltf)!=null&&s.loadBuffers))return;const r=t.getExtension(Kr);r&&((n=e.gltf)!=null&&n.loadImages&&km(t,r),Nm(t,r))}function km(t,e){const r=e.propertyTextures,s=t.gltf.json;if(r&&s.meshes)for(const n of s.meshes)for(const i of n.primitives)Hm(t,r,i,e)}function Nm(t,e){const r=e.schema;if(!r)return;const s=r.classes,n=e.propertyTables;if(s&&n)for(const i in s){const o=Vm(n,i);o&&zm(t,r,o)}}function Vm(t,e){for(const r of t)if(r.class===e)return r;return null}function Hm(t,e,r,s){var i,o;if(!e)return;const n=(o=(i=r.extensions)==null?void 0:i[Kr])==null?void 0:o.propertyTextures;if(n)for(const a of n){const c=e[a];jm(t,c,r,s)}}function jm(t,e,r,s){var i;if(!e.properties)return;s.dataAttributeNames||(s.dataAttributeNames=[]);const n=e.class;for(const o in e.properties){const a=`${n}_${o}`,c=(i=e.properties)==null?void 0:i[o];if(!c)continue;c.data||(c.data=[]);const m=c.data,_=Yi(t,c,r);_!==null&&(nc(t,a,_,m,r),c.data=m,s.dataAttributeNames.push(a))}}function zm(t,e,r){var i,o;const s=(i=e.classes)==null?void 0:i[r.class];if(!s)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${r.class}`);const n=r.count;for(const a in s.properties){const c=s.properties[a],m=(o=r.properties)==null?void 0:o[a];if(m){const _=Jm(t,e,c,n,m);m.data=_}}}function Jm(t,e,r,s,n){let i=[];const o=n.values,a=t.getTypedArrayForBufferView(o),c=Km(t,r,n,s),m=Xm(t,n,s);switch(r.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":case"MAT2":case"MAT3":case"MAT4":{i=Wm(r,s,a,c);break}case"BOOLEAN":throw new Error(`Not implemented - classProperty.type=${r.type}`);case"STRING":{i=ac(s,a,c,m);break}case"ENUM":{i=Ym(e,r,s,a,c);break}default:throw new Error(`Unknown classProperty type ${r.type}`)}return i}function Km(t,e,r,s){return e.array&&typeof e.count>"u"&&typeof r.arrayOffsets<"u"?sn(t,r.arrayOffsets,r.arrayOffsetType||"UINT32",s):null}function Xm(t,e,r){return typeof e.stringOffsets<"u"?sn(t,e.stringOffsets,e.stringOffsetType||"UINT32",r):null}function Wm(t,e,r,s){const n=t.array,i=t.count,o=Wi(t.type,t.componentType),a=r.byteLength/o;let c;return t.componentType?c=nn(r,t.type,t.componentType,a):c=r,n?s?ic(c,e,s,r.length,o):i?oc(c,e,i):[]:c}function Ym(t,e,r,s,n){var v;const i=e.enumType;if(!i)throw new Error("Incorrect data in the EXT_structural_metadata extension: classProperty.enumType is not set for type ENUM");const o=(v=t.enums)==null?void 0:v[i];if(!o)throw new Error(`Incorrect data in the EXT_structural_metadata extension: schema.enums does't contain ${i}`);const a=o.valueType||"UINT16",c=Wi(e.type,a),m=s.byteLength/c;let _=nn(s,e.type,a,m);if(_||(_=s),e.array){if(n)return $m({valuesData:_,numberOfElements:r,arrayOffsets:n,valuesDataBytesLength:s.length,elementSize:c,enumEntry:o});const P=e.count;return P?Qm(_,r,P,o):[]}return $i(_,0,r,o)}function $m(t){const{valuesData:e,numberOfElements:r,arrayOffsets:s,valuesDataBytesLength:n,elementSize:i,enumEntry:o}=t,a=[];for(let c=0;c<r;c++){const m=s[c],_=s[c+1]-s[c];if(_+m>n)break;const v=m/i,P=_/i,O=$i(e,v,P,o);a.push(O)}return a}function Qm(t,e,r,s){const n=[];for(let i=0;i<e;i++){const o=r*i,a=$i(t,o,r,s);n.push(a)}return n}function $i(t,e,r,s){const n=[];for(let i=0;i<r;i++)if(t instanceof BigInt64Array||t instanceof BigUint64Array)n.push("");else{const o=t[e+i],a=qm(s,o);a?n.push(a.name):n.push("")}return n}function qm(t,e){for(const r of t.values)if(r.value===e)return r;return null}const Zm="schemaClassId";function eg(t,e){var s,n;const r=t.getExtension(Kr);if(r&&r.propertyTables)for(const i of r.propertyTables){const o=i.class,a=(n=(s=r.schema)==null?void 0:s.classes)==null?void 0:n[o];i.properties&&a&&tg(i,a,t)}}function tg(t,e,r){for(const s in t.properties){const n=t.properties[s].data;if(n){const i=e.properties[s];if(i){const o=ig(n,i,r);t.properties[s]=o}}}}function rg(t,e,r=Zm){let s=t.getExtension(Kr);s||(s=t.addExtension(Kr)),s.schema=sg(e,r,s.schema);const n=ng(e,r,s.schema);return s.propertyTables||(s.propertyTables=[]),s.propertyTables.push(n)-1}function sg(t,e,r){const s=r??{id:"schema_id"},n={properties:{}};for(const i of t){const o={type:i.elementType,componentType:i.componentType};n.properties[i.name]=o}return s.classes={},s.classes[e]=n,s}function ng(t,e,r){var o;const s={class:e,count:0};let n=0;const i=(o=r.classes)==null?void 0:o[e];for(const a of t){if(n===0&&(n=a.values.length),n!==a.values.length&&a.values.length)throw new Error("Illegal values in attributes");i!=null&&i.properties[a.name]&&(s.properties||(s.properties={}),s.properties[a.name]={values:0,data:a.values})}return s.count=n,s}function ig(t,e,r){const s={values:0};if(e.type==="STRING"){const{stringData:n,stringOffsets:i}=ug(t);s.stringOffsets=Qi(i,r),s.values=Qi(n,r)}else if(e.type==="SCALAR"&&e.componentType){const n=ag(t,e.componentType);s.values=Qi(n,r)}return s}const og={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:Int32Array,UINT64:Uint32Array,FLOAT32:Float32Array,FLOAT64:Float64Array};function ag(t,e){const r=[];for(const n of t)r.push(Number(n));const s=og[e];if(!s)throw new Error("Illegal component type");return new s(r)}function ug(t){const e=new TextEncoder,r=[];let s=0;for(const c of t){const m=e.encode(c);s+=m.length,r.push(m)}const n=new Uint8Array(s),i=[];let o=0;for(const c of r)n.set(c,o),i.push(o),o+=c.length;i.push(o);const a=new Uint32Array(i);return{stringData:n,stringOffsets:a}}function Qi(t,e){return e.gltf.buffers.push({arrayBuffer:t.buffer,byteOffset:t.byteOffset,byteLength:t.byteLength}),e.addBufferView(t)}const cg=Object.freeze(Object.defineProperty({__proto__:null,createExtStructuralMetadata:rg,decode:Im,encode:Fm,name:Dm},Symbol.toStringTag,{value:"Module"})),uc="EXT_feature_metadata",lg=uc;async function dg(t,e){const r=new Ne(t);hg(r,e)}function hg(t,e){var s,n;if(!((s=e.gltf)!=null&&s.loadBuffers))return;const r=t.getExtension(uc);r&&((n=e.gltf)!=null&&n.loadImages&&fg(t,r),pg(t,r))}function fg(t,e){const r=e.schema;if(!r)return;const s=r.classes,{featureTextures:n}=e;if(s&&n)for(const i in s){const o=s[i],a=gg(n,i);a&&_g(t,a,o)}}function pg(t,e){const r=e.schema;if(!r)return;const s=r.classes,n=e.featureTables;if(s&&n)for(const i in s){const o=mg(n,i);o&&yg(t,r,o)}}function mg(t,e){for(const r in t){const s=t[r];if(s.class===e)return s}return null}function gg(t,e){for(const r in t){const s=t[r];if(s.class===e)return s}return null}function yg(t,e,r){var i,o;if(!r.class)return;const s=(i=e.classes)==null?void 0:i[r.class];if(!s)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${r.class}`);const n=r.count;for(const a in s.properties){const c=s.properties[a],m=(o=r.properties)==null?void 0:o[a];if(m){const _=bg(t,e,c,n,m);m.data=_}}}function _g(t,e,r){var n;const s=e.class;for(const i in r.properties){const o=(n=e==null?void 0:e.properties)==null?void 0:n[i];if(o){const a=vg(t,o,s);o.data=a}}}function bg(t,e,r,s,n){let i=[];const o=n.bufferView,a=t.getTypedArrayForBufferView(o),c=xg(t,r,n,s),m=Ag(t,r,n,s);return r.type==="STRING"||r.componentType==="STRING"?i=ac(s,a,c,m):Bg(r)&&(i=wg(r,s,a,c)),i}function xg(t,e,r,s){return e.type==="ARRAY"&&typeof e.componentCount>"u"&&typeof r.arrayOffsetBufferView<"u"?sn(t,r.arrayOffsetBufferView,r.offsetType||"UINT32",s):null}function Ag(t,e,r,s){return typeof r.stringOffsetBufferView<"u"?sn(t,r.stringOffsetBufferView,r.offsetType||"UINT32",s):null}function Bg(t){const e=["UINT8","INT16","UINT16","INT32","UINT32","INT64","UINT64","FLOAT32","FLOAT64"];return e.includes(t.type)||typeof t.componentType<"u"&&e.includes(t.componentType)}function wg(t,e,r,s){const n=t.type==="ARRAY",i=t.componentCount,o="SCALAR",a=t.componentType||t.type,c=Wi(o,a),m=r.byteLength/c,_=nn(r,o,a,m);return n?s?ic(_,e,s,r.length,c):i?oc(_,e,i):[]:_}function vg(t,e,r){const s=t.gltf.json;if(!s.meshes)return[];const n=[];for(const i of s.meshes)for(const o of i.primitives)Cg(t,r,e,n,o);return n}function Cg(t,e,r,s,n){const i={channels:r.channels,...r.texture},o=Yi(t,i,n);o&&nc(t,e,o,s,n)}const Tg=Object.freeze(Object.defineProperty({__proto__:null,decode:dg,name:lg},Symbol.toStringTag,{value:"Module"})),Sg="4.3.2",Eg="4.3.2",on={TRANSCODER:"basis_transcoder.js",TRANSCODER_WASM:"basis_transcoder.wasm",ENCODER:"basis_encoder.js",ENCODER_WASM:"basis_encoder.wasm"};let cc;async function lc(t){return Wh(t.modules),Yh("basis")||(cc||(cc=Mg(t)),await cc)}async function Mg(t){let e=null,r=null;return[e,r]=await Promise.all([await br(on.TRANSCODER,"textures",t),await br(on.TRANSCODER_WASM,"textures",t)]),e=e||globalThis.BASIS,await Pg(e,r)}function Pg(t,e){const r={};return e&&(r.wasmBinary=e),new Promise(s=>{t(r).then(n=>{const{BasisFile:i,initializeBasis:o}=n;o(),s({BasisFile:i})})})}let qi;async function dc(t){const e=t.modules||{};return e.basisEncoder?e.basisEncoder:(qi=qi||Rg(t),await qi)}async function Rg(t){let e=null,r=null;return[e,r]=await Promise.all([await br(on.ENCODER,"textures",t),await br(on.ENCODER_WASM,"textures",t)]),e=e||globalThis.BASIS,await Gg(e,r)}function Gg(t,e){const r={};return e&&(r.wasmBinary=e),new Promise(s=>{t(r).then(n=>{const{BasisFile:i,KTX2File:o,initializeBasis:a,BasisEncoder:c}=n;a(),s({BasisFile:i,KTX2File:o,BasisEncoder:c})})})}const Xr={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35987,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,COMPRESSED_RGBA_ASTC_4X4_KHR:37808,COMPRESSED_RGBA_ASTC_5X4_KHR:37809,COMPRESSED_RGBA_ASTC_5X5_KHR:37810,COMPRESSED_RGBA_ASTC_6X5_KHR:37811,COMPRESSED_RGBA_ASTC_6X6_KHR:37812,COMPRESSED_RGBA_ASTC_8X5_KHR:37813,COMPRESSED_RGBA_ASTC_8X6_KHR:37814,COMPRESSED_RGBA_ASTC_8X8_KHR:37815,COMPRESSED_RGBA_ASTC_10X5_KHR:37816,COMPRESSED_RGBA_ASTC_10X6_KHR:37817,COMPRESSED_RGBA_ASTC_10X8_KHR:37818,COMPRESSED_RGBA_ASTC_10X10_KHR:37819,COMPRESSED_RGBA_ASTC_12X10_KHR:37820,COMPRESSED_RGBA_ASTC_12X12_KHR:37821,COMPRESSED_SRGB8_ALPHA8_ASTC_4X4_KHR:37840,COMPRESSED_SRGB8_ALPHA8_ASTC_5X4_KHR:37841,COMPRESSED_SRGB8_ALPHA8_ASTC_5X5_KHR:37842,COMPRESSED_SRGB8_ALPHA8_ASTC_6X5_KHR:37843,COMPRESSED_SRGB8_ALPHA8_ASTC_6X6_KHR:37844,COMPRESSED_SRGB8_ALPHA8_ASTC_8X5_KHR:37845,COMPRESSED_SRGB8_ALPHA8_ASTC_8X6_KHR:37846,COMPRESSED_SRGB8_ALPHA8_ASTC_8X8_KHR:37847,COMPRESSED_SRGB8_ALPHA8_ASTC_10X5_KHR:37848,COMPRESSED_SRGB8_ALPHA8_ASTC_10X6_KHR:37849,COMPRESSED_SRGB8_ALPHA8_ASTC_10X8_KHR:37850,COMPRESSED_SRGB8_ALPHA8_ASTC_10X10_KHR:37851,COMPRESSED_SRGB8_ALPHA8_ASTC_12X10_KHR:37852,COMPRESSED_SRGB8_ALPHA8_ASTC_12X12_KHR:37853,COMPRESSED_RED_RGTC1_EXT:36283,COMPRESSED_SIGNED_RED_RGTC1_EXT:36284,COMPRESSED_RED_GREEN_RGTC2_EXT:36285,COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT:36286,COMPRESSED_SRGB_S3TC_DXT1_EXT:35916,COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:35917,COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:35918,COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:35919},Lg=["","WEBKIT_","MOZ_"],hc={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let an=null;function Og(t){if(!an){t=t||Dg()||void 0,an=new Set;for(const e of Lg)for(const r in hc)if(t&&t.getExtension(`${e}${r}`)){const s=hc[r];an.add(s)}}return an}function Dg(){try{return document.createElement("canvas").getContext("webgl")}catch{return null}}const pt=[171,75,84,88,32,50,48,187,13,10,26,10];function Ig(t){const e=new Uint8Array(t);return!(e.byteLength<pt.length||e[0]!==pt[0]||e[1]!==pt[1]||e[2]!==pt[2]||e[3]!==pt[3]||e[4]!==pt[4]||e[5]!==pt[5]||e[6]!==pt[6]||e[7]!==pt[7]||e[8]!==pt[8]||e[9]!==pt[9]||e[10]!==pt[10]||e[11]!==pt[11])}const Fg={etc1:{basisFormat:0,compressed:!0,format:Xr.COMPRESSED_RGB_ETC1_WEBGL},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:Xr.COMPRESSED_RGB_S3TC_DXT1_EXT},bc3:{basisFormat:3,compressed:!0,format:Xr.COMPRESSED_RGBA_S3TC_DXT5_EXT},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:Xr.COMPRESSED_RGB_PVRTC_4BPPV1_IMG},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:Xr.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},"astc-4x4":{basisFormat:10,compressed:!0,format:Xr.COMPRESSED_RGBA_ASTC_4X4_KHR},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};async function Ug(t,e){if(e.basis.containerFormat==="auto"){if(Ig(t)){const s=await dc(e);return fc(s.KTX2File,t,e)}const{BasisFile:r}=await lc(e);return Zi(r,t,e)}switch(e.basis.module){case"encoder":const r=await dc(e);switch(e.basis.containerFormat){case"ktx2":return fc(r.KTX2File,t,e);case"basis":default:return Zi(r.BasisFile,t,e)}case"transcoder":default:const{BasisFile:s}=await lc(e);return Zi(s,t,e)}}function Zi(t,e,r){const s=new t(new Uint8Array(e));try{if(!s.startTranscoding())throw new Error("Failed to start basis transcoding");const n=s.getNumImages(),i=[];for(let o=0;o<n;o++){const a=s.getNumLevels(o),c=[];for(let m=0;m<a;m++)c.push(kg(s,o,m,r));i.push(c)}return i}finally{s.close(),s.delete()}}function kg(t,e,r,s){const n=t.getImageWidth(e,r),i=t.getImageHeight(e,r),o=t.getHasAlpha(),{compressed:a,format:c,basisFormat:m}=pc(s,o),_=t.getImageTranscodedSizeInBytes(e,r,m),v=new Uint8Array(_);if(!t.transcodeImage(v,e,r,m,0,0))throw new Error("failed to start Basis transcoding");return{width:n,height:i,data:v,compressed:a,format:c,hasAlpha:o}}function fc(t,e,r){const s=new t(new Uint8Array(e));try{if(!s.startTranscoding())throw new Error("failed to start KTX2 transcoding");const n=s.getLevels(),i=[];for(let o=0;o<n;o++)i.push(Ng(s,o,r));return[i]}finally{s.close(),s.delete()}}function Ng(t,e,r){const{alphaFlag:s,height:n,width:i}=t.getImageLevelInfo(e,0,0),{compressed:o,format:a,basisFormat:c}=pc(r,s),m=t.getImageTranscodedSizeInBytes(e,0,0,c),_=new Uint8Array(m);if(!t.transcodeImage(_,e,0,0,c,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:i,height:n,data:_,compressed:o,levelSize:m,hasAlpha:s,format:a}}function pc(t,e){let r=t&&t.basis&&t.basis.format;return r==="auto"&&(r=mc()),typeof r=="object"&&(r=e?r.alpha:r.noAlpha),r=r.toLowerCase(),Fg[r]}function mc(){const t=Og();return t.has("astc")?"astc-4x4":t.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:t.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:t.has("etc1")?"etc1":t.has("etc2")?"etc2":"rgb565"}const Vg={dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:Eg,worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},Hg={...Vg,parse:Ug},Wr=!0,gc=1735152710,eo=12,un=8,jg=1313821514,zg=5130562,Jg=0,Kg=0,Xg=1;function Wg(t,e=0){return`${String.fromCharCode(t.getUint8(e+0))}${String.fromCharCode(t.getUint8(e+1))}${String.fromCharCode(t.getUint8(e+2))}${String.fromCharCode(t.getUint8(e+3))}`}function Yg(t,e=0,r={}){const s=new DataView(t),{magic:n=gc}=r,i=s.getUint32(e,!1);return i===n||i===gc}function $g(t,e,r=0,s={}){const n=new DataView(e),i=Wg(n,r+0),o=n.getUint32(r+4,Wr),a=n.getUint32(r+8,Wr);switch(Object.assign(t,{header:{byteOffset:r,byteLength:a,hasBinChunk:!1},type:i,version:o,json:{},binChunks:[]}),r+=eo,t.version){case 1:return Qg(t,n,r);case 2:return qg(t,n,r,s={});default:throw new Error(`Invalid GLB version ${t.version}. Only supports version 1 and 2.`)}}function Qg(t,e,r){Ht(t.header.byteLength>eo+un);const s=e.getUint32(r+0,Wr),n=e.getUint32(r+4,Wr);return r+=un,Ht(n===Jg),to(t,e,r,s),r+=s,r+=ro(t,e,r,t.header.byteLength),r}function qg(t,e,r,s){return Ht(t.header.byteLength>eo+un),Zg(t,e,r,s),r+t.header.byteLength}function Zg(t,e,r,s){for(;r+8<=t.header.byteLength;){const n=e.getUint32(r+0,Wr),i=e.getUint32(r+4,Wr);switch(r+=un,i){case jg:to(t,e,r,n);break;case zg:ro(t,e,r,n);break;case Kg:s.strict||to(t,e,r,n);break;case Xg:s.strict||ro(t,e,r,n);break}r+=ms(n,4)}return r}function to(t,e,r,s){const n=new Uint8Array(e.buffer,r,s),i=new TextDecoder("utf8").decode(n);return t.json=JSON.parse(i),ms(s,4)}function ro(t,e,r,s){return t.header.hasBinChunk=!0,t.binChunks.push({byteOffset:r,byteLength:s,arrayBuffer:e.buffer}),ms(s,4)}function yc(t,e){if(t.startsWith("data:")||t.startsWith("http:")||t.startsWith("https:"))return t;const r=e.baseUri||e.uri;if(!r)throw new Error(`'baseUri' must be provided to resolve relative url ${t}`);return r.substr(0,r.lastIndexOf("/")+1)+t}const ey="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",ty="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",ry=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),sy=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),ny={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},iy={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function oy(t,e,r,s,n,i="NONE"){const o=await ay();ly(o,o.exports[iy[n]],t,e,r,s,o.exports[ny[i||"NONE"]])}let so;async function ay(){return so||(so=uy()),so}async function uy(){let t=ey;WebAssembly.validate(ry)&&(t=ty,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const e=await WebAssembly.instantiate(cy(t),{});return await e.instance.exports.__wasm_call_ctors(),e.instance}function cy(t){const e=new Uint8Array(t.length);for(let s=0;s<t.length;++s){const n=t.charCodeAt(s);e[s]=n>96?n-71:n>64?n-65:n>47?n+4:n>46?63:62}let r=0;for(let s=0;s<t.length;++s)e[r++]=e[s]<60?sy[e[s]]:(e[s]-60)*64+e[++s];return e.buffer.slice(0,r)}function ly(t,e,r,s,n,i,o){const a=t.exports.sbrk,c=s+3&-4,m=a(c*n),_=a(i.length),v=new Uint8Array(t.exports.memory.buffer);v.set(i,_);const P=e(m,s,n,_,i.length);if(P===0&&o&&o(m,c,n),r.set(v.subarray(m,m+s*n)),a(m-a(0)),P!==0)throw new Error(`Malformed buffer data: ${P}`)}const cn="EXT_meshopt_compression",dy=cn;async function hy(t,e){var n,i;const r=new Ne(t);if(!((n=e==null?void 0:e.gltf)!=null&&n.decompressMeshes)||!((i=e.gltf)!=null&&i.loadBuffers))return;const s=[];for(const o of t.json.bufferViews||[])s.push(fy(r,o));await Promise.all(s),r.removeExtension(cn)}async function fy(t,e){const r=t.getObjectExtension(e,cn);if(r){const{byteOffset:s=0,byteLength:n=0,byteStride:i,count:o,mode:a,filter:c="NONE",buffer:m}=r,_=t.gltf.buffers[m],v=new Uint8Array(_.arrayBuffer,_.byteOffset+s,n),P=new Uint8Array(t.gltf.buffers[e.buffer].arrayBuffer,e.byteOffset,e.byteLength);await oy(P,o,i,v,a,c),t.removeObjectExtension(e,cn)}}const py=Object.freeze(Object.defineProperty({__proto__:null,decode:hy,name:dy},Symbol.toStringTag,{value:"Module"})),Yr="EXT_texture_webp",my=Yr;function gy(t,e){const r=new Ne(t);if(!lm("image/webp")){if(r.getRequiredExtensions().includes(Yr))throw new Error(`gltf: Required extension ${Yr} not supported by browser`);return}const{json:s}=r;for(const n of s.textures||[]){const i=r.getObjectExtension(n,Yr);i&&(n.source=i.source),r.removeObjectExtension(n,Yr)}r.removeExtension(Yr)}const yy=Object.freeze(Object.defineProperty({__proto__:null,name:my,preprocess:gy},Symbol.toStringTag,{value:"Module"})),ln="KHR_texture_basisu",_y=ln;function by(t,e){const r=new Ne(t),{json:s}=r;for(const n of s.textures||[]){const i=r.getObjectExtension(n,ln);i&&(n.source=i.source,r.removeObjectExtension(n,ln))}r.removeExtension(ln)}const xy=Object.freeze(Object.defineProperty({__proto__:null,name:_y,preprocess:by},Symbol.toStringTag,{value:"Module"})),Ay="4.3.2",By={dataType:null,batchType:null,name:"Draco",id:"draco",module:"draco",version:Ay,worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:typeof WebAssembly=="object"?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};function wy(t,e,r){const s=bc(e.metadata),n=[],i=vy(e.attributes);for(const o in t){const a=t[o],c=_c(o,a,i[o]);n.push(c)}if(r){const o=_c("indices",r);n.push(o)}return{fields:n,metadata:s}}function vy(t){const e={};for(const r in t){const s=t[r];e[s.name||"undefined"]=s}return e}function _c(t,e,r){const s=r?bc(r.metadata):void 0;return Ep(t,e,s)}function bc(t){Object.entries(t);const e={};for(const r in t)e[`${r}.string`]=JSON.stringify(t[r]);return e}const xc={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},Cy={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},Ty=4;class Sy{constructor(e){ce(this,"draco");ce(this,"decoder");ce(this,"metadataQuerier");this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,r={}){const s=new this.draco.DecoderBuffer;s.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(r);const n=this.decoder.GetEncodedGeometryType(s),i=n===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let o;switch(n){case this.draco.TRIANGULAR_MESH:o=this.decoder.DecodeBufferToMesh(s,i);break;case this.draco.POINT_CLOUD:o=this.decoder.DecodeBufferToPointCloud(s,i);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!o.ok()||!i.ptr){const v=`DRACO decompression failed: ${o.error_msg()}`;throw new Error(v)}const a=this._getDracoLoaderData(i,n,r),c=this._getMeshData(i,a,r),m=Sp(c.attributes),_=wy(c.attributes,a,c.indices);return{loader:"draco",loaderData:a,header:{vertexCount:i.num_points(),boundingBox:m},...c,schema:_}}finally{this.draco.destroy(s),i&&this.draco.destroy(i)}}_getDracoLoaderData(e,r,s){const n=this._getTopLevelMetadata(e),i=this._getDracoAttributes(e,s);return{geometry_type:r,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:n,attributes:i}}_getDracoAttributes(e,r){const s={};for(let n=0;n<e.num_attributes();n++){const i=this.decoder.GetAttribute(e,n),o=this._getAttributeMetadata(e,n);s[i.unique_id()]={unique_id:i.unique_id(),attribute_type:i.attribute_type(),data_type:i.data_type(),num_components:i.num_components(),byte_offset:i.byte_offset(),byte_stride:i.byte_stride(),normalized:i.normalized(),attribute_index:n,metadata:o};const a=this._getQuantizationTransform(i,r);a&&(s[i.unique_id()].quantization_transform=a);const c=this._getOctahedronTransform(i,r);c&&(s[i.unique_id()].octahedron_transform=c)}return s}_getMeshData(e,r,s){const n=this._getMeshAttributes(r,e,s);if(!n.POSITION)throw new Error("DRACO: No position attribute found.");if(e instanceof this.draco.Mesh)switch(s.topology){case"triangle-strip":return{topology:"triangle-strip",mode:4,attributes:n,indices:{value:this._getTriangleStripIndices(e),size:1}};case"triangle-list":default:return{topology:"triangle-list",mode:5,attributes:n,indices:{value:this._getTriangleListIndices(e),size:1}}}return{topology:"point-list",mode:0,attributes:n}}_getMeshAttributes(e,r,s){const n={};for(const i of Object.values(e.attributes)){const o=this._deduceAttributeName(i,s);i.name=o;const a=this._getAttributeValues(r,i);if(a){const{value:c,size:m}=a;n[o]={value:c,size:m,byteOffset:i.byte_offset,byteStride:i.byte_stride,normalized:i.normalized}}}return n}_getTriangleListIndices(e){const r=e.num_faces()*3,s=r*Ty,n=this.draco._malloc(s);try{return this.decoder.GetTrianglesUInt32Array(e,s,n),new Uint32Array(this.draco.HEAPF32.buffer,n,r).slice()}finally{this.draco._free(n)}}_getTriangleStripIndices(e){const r=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,r),Py(r)}finally{this.draco.destroy(r)}}_getAttributeValues(e,r){const s=Cy[r.data_type];if(!s)return console.warn(`DRACO: Unsupported attribute type ${r.data_type}`),null;const n=r.num_components,i=e.num_points()*n,o=i*s.BYTES_PER_ELEMENT,a=Ey(this.draco,s);let c;const m=this.draco._malloc(o);try{const _=this.decoder.GetAttribute(e,r.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,_,a,o,m),c=new s(this.draco.HEAPF32.buffer,m,i).slice()}finally{this.draco._free(m)}return{value:c,size:n}}_deduceAttributeName(e,r){const s=e.unique_id;for(const[o,a]of Object.entries(r.extraAttributes||{}))if(a===s)return o;const n=e.attribute_type;for(const o in xc)if(this.draco[o]===n)return xc[o];const i=r.attributeNameEntry||"name";return e.metadata[i]?e.metadata[i].string:`CUSTOM_ATTRIBUTE_${s}`}_getTopLevelMetadata(e){const r=this.decoder.GetMetadata(e);return this._getDracoMetadata(r)}_getAttributeMetadata(e,r){const s=this.decoder.GetAttributeMetadata(e,r);return this._getDracoMetadata(s)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const r={},s=this.metadataQuerier.NumEntries(e);for(let n=0;n<s;n++){const i=this.metadataQuerier.GetEntryName(e,n);r[i]=this._getDracoMetadataField(e,i)}return r}_getDracoMetadataField(e,r){const s=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,r,s);const n=My(s);return{int:this.metadataQuerier.GetIntEntry(e,r),string:this.metadataQuerier.GetStringEntry(e,r),double:this.metadataQuerier.GetDoubleEntry(e,r),intArray:n}}finally{this.draco.destroy(s)}}_disableAttributeTransforms(e){const{quantizedAttributes:r=[],octahedronAttributes:s=[]}=e,n=[...r,...s];for(const i of n)this.decoder.SkipAttributeTransform(this.draco[i])}_getQuantizationTransform(e,r){const{quantizedAttributes:s=[]}=r,n=e.attribute_type();if(s.map(i=>this.decoder[i]).includes(n)){const i=new this.draco.AttributeQuantizationTransform;try{if(i.InitFromAttribute(e))return{quantization_bits:i.quantization_bits(),range:i.range(),min_values:new Float32Array([1,2,3]).map(o=>i.min_value(o))}}finally{this.draco.destroy(i)}}return null}_getOctahedronTransform(e,r){const{octahedronAttributes:s=[]}=r,n=e.attribute_type();if(s.map(i=>this.decoder[i]).includes(n)){const i=new this.draco.AttributeQuantizationTransform;try{if(i.InitFromAttribute(e))return{quantization_bits:i.quantization_bits()}}finally{this.draco.destroy(i)}}return null}}function Ey(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32;default:return t.DT_INVALID}}function My(t){const e=t.size(),r=new Int32Array(e);for(let s=0;s<e;s++)r[s]=t.GetValue(s);return r}function Py(t){const e=t.size(),r=new Int32Array(e);for(let s=0;s<e;s++)r[s]=t.GetValue(s);return r}const Ry="1.5.6",Gy="1.4.1",no=`https://www.gstatic.com/draco/versioned/decoders/${Ry}`,ut={DECODER:"draco_wasm_wrapper.js",DECODER_WASM:"draco_decoder.wasm",FALLBACK_DECODER:"draco_decoder.js",ENCODER:"draco_encoder.js"},io={[ut.DECODER]:`${no}/${ut.DECODER}`,[ut.DECODER_WASM]:`${no}/${ut.DECODER_WASM}`,[ut.FALLBACK_DECODER]:`${no}/${ut.FALLBACK_DECODER}`,[ut.ENCODER]:`https://raw.githubusercontent.com/google/draco/${Gy}/javascript/${ut.ENCODER}`};let oo;async function Ly(t){const e=t.modules||{};return e.draco3d?oo||(oo=e.draco3d.createDecoderModule({}).then(r=>({draco:r}))):oo||(oo=Oy(t)),await oo}async function Oy(t){let e,r;switch(t.draco&&t.draco.decoderType){case"js":e=await br(io[ut.FALLBACK_DECODER],"draco",t,ut.FALLBACK_DECODER);break;case"wasm":default:[e,r]=await Promise.all([await br(io[ut.DECODER],"draco",t,ut.DECODER),await br(io[ut.DECODER_WASM],"draco",t,ut.DECODER_WASM)])}return e=e||globalThis.DracoDecoderModule,await Dy(e,r)}function Dy(t,e){const r={};return e&&(r.wasmBinary=e),new Promise(s=>{t({...r,onModuleLoaded:n=>s({draco:n})})})}const Iy={...By,parse:Fy};async function Fy(t,e){const{draco:r}=await Ly(e),s=new Sy(r);try{return s.parseSync(t,e==null?void 0:e.draco)}finally{s.destroy()}}function Uy(t){const e={};for(const r in t){const s=t[r];if(r!=="indices"){const n=Ac(s);e[r]=n}}return e}function Ac(t){const{buffer:e,size:r,count:s}=ky(t);return{value:e,size:r,byteOffset:0,count:s,type:ec(r),componentType:rn(e)}}function ky(t){let e=t,r=1,s=0;return t&&t.value&&(e=t.value,r=t.size||1),e&&(ArrayBuffer.isView(e)||(e=Ny(e,Float32Array)),s=e.length/r),{buffer:e,size:r,count:s}}function Ny(t,e,r=!1){return t?Array.isArray(t)?new e(t):r&&!(t instanceof e)?new e(t):t:null}const Br="KHR_draco_mesh_compression",Vy=Br;function Hy(t,e,r){const s=new Ne(t);for(const n of Bc(s))s.getObjectExtension(n,Br)}async function jy(t,e,r){var i;if(!((i=e==null?void 0:e.gltf)!=null&&i.decompressMeshes))return;const s=new Ne(t),n=[];for(const o of Bc(s))s.getObjectExtension(o,Br)&&n.push(Jy(s,o,e,r));await Promise.all(n),s.removeExtension(Br)}function zy(t,e={}){const r=new Ne(t);for(const s of r.json.meshes||[])Ky(),r.addRequiredExtension(Br)}async function Jy(t,e,r,s){const n=t.getObjectExtension(e,Br);if(!n)return;const i=t.getTypedArrayForBufferView(n.bufferView),o=Au(i.buffer,i.byteOffset),a={...r};delete a["3d-tiles"];const c=await ou(o,Iy,a,s),m=Uy(c.attributes);for(const[_,v]of Object.entries(m))if(_ in e.attributes){const P=e.attributes[_],O=t.getAccessor(P);O!=null&&O.min&&(O!=null&&O.max)&&(v.min=O.min,v.max=O.max)}e.attributes=m,c.indices&&(e.indices=Ac(c.indices)),t.removeObjectExtension(e,Br),Xy(e)}function Ky(t,e,r=4,s,n){if(!s.DracoWriter)throw new Error("options.gltf.DracoWriter not provided")}function Xy(t){if(!t.attributes&&Object.keys(t.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}function*Bc(t){for(const e of t.json.meshes||[])for(const r of e.primitives)yield r}const Wy=Object.freeze(Object.defineProperty({__proto__:null,decode:jy,encode:zy,name:Vy,preprocess:Hy},Symbol.toStringTag,{value:"Module"})),Yy={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...Yy}};const Bt=globalThis.mathgl.config;function $y(t,{precision:e=Bt.precision}={}){return t=Qy(t),`${parseFloat(t.toPrecision(e))}`}function dn(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function wc(t,e,r){const s=Bt.EPSILON;try{if(t===e)return!0;if(dn(t)&&dn(e)){if(t.length!==e.length)return!1;for(let n=0;n<t.length;++n)if(!wc(t[n],e[n]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):typeof t=="number"&&typeof e=="number"?Math.abs(t-e)<=Bt.EPSILON*Math.max(1,Math.abs(t),Math.abs(e)):!1}finally{Bt.EPSILON=s}}function Qy(t){return Math.round(t/Bt.EPSILON)*Bt.EPSILON}class vc extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,r=0){for(let s=0;s<this.ELEMENTS;++s)this[s]=e[s+r];return this.check()}toArray(e=[],r=0){for(let s=0;s<this.ELEMENTS;++s)e[r+s]=this[s];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:dn(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Bt)}formatString(e){let r="";for(let s=0;s<this.ELEMENTS;++s)r+=(s>0?", ":"")+$y(this[s],e);return`${e.printTypes?this.constructor.name:""}[${r}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let r=0;r<this.ELEMENTS;++r)if(!wc(this[r],e[r]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let r=0;r<this.ELEMENTS;++r)if(this[r]!==e[r])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,r,s){if(s===void 0)return this.lerp(this,e,r);for(let n=0;n<this.ELEMENTS;++n){const i=e[n],o=typeof r=="number"?r:r[n];this[n]=i+s*(o-i)}return this.check()}min(e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(e[r],this[r]);return this.check()}max(e){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.max(e[r],this[r]);return this.check()}clamp(e,r){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.min(Math.max(this[s],e[s]),r[s]);return this.check()}add(...e){for(const r of e)for(let s=0;s<this.ELEMENTS;++s)this[s]+=r[s];return this.check()}subtract(...e){for(const r of e)for(let s=0;s<this.ELEMENTS;++s)this[s]-=r[s];return this.check()}scale(e){if(typeof e=="number")for(let r=0;r<this.ELEMENTS;++r)this[r]*=e;else for(let r=0;r<this.ELEMENTS&&r<e.length;++r)this[r]*=e[r];return this.check()}multiplyByScalar(e){for(let r=0;r<this.ELEMENTS;++r)this[r]*=e;return this.check()}check(){if(Bt.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let r=0;r<this.ELEMENTS;++r)e=e&&Number.isFinite(this[r]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let r=0;r<this.ELEMENTS;++r)this[r]=e;return this.check()}addScalar(e){for(let r=0;r<this.ELEMENTS;++r)this[r]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let r=0;r<this.ELEMENTS;++r)this[r]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,r){for(let s=0;s<this.ELEMENTS;++s)this[s]=Math.min(Math.max(this[s],e),r);return this.check()}get elements(){return this}}function qy(t,e){if(t.length!==e)return!1;for(let r=0;r<t.length;++r)if(!Number.isFinite(t[r]))return!1;return!0}function mt(t){if(!Number.isFinite(t))throw new Error(`Invalid number ${JSON.stringify(t)}`);return t}function Zy(t,e,r=""){if(Bt.debug&&!qy(t,e))throw new Error(`math.gl: ${r} some fields set to invalid numbers'`);return t}function Cc(t,e){if(!t)throw new Error(`math.gl assertion ${e}`)}class e0 extends vc{get x(){return this[0]}set x(e){this[0]=mt(e)}get y(){return this[1]}set y(e){this[1]=mt(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let r=0;r<this.ELEMENTS;++r)e+=this[r]*this[r];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let r=0;for(let s=0;s<this.ELEMENTS;++s){const n=this[s]-e[s];r+=n*n}return mt(r)}dot(e){let r=0;for(let s=0;s<this.ELEMENTS;++s)r+=this[s]*e[s];return mt(r)}normalize(){const e=this.magnitude();if(e!==0)for(let r=0;r<this.ELEMENTS;++r)this[r]/=e;return this.check()}multiply(...e){for(const r of e)for(let s=0;s<this.ELEMENTS;++s)this[s]*=r[s];return this.check()}divide(...e){for(const r of e)for(let s=0;s<this.ELEMENTS;++s)this[s]/=r[s];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Cc(e>=0&&e<this.ELEMENTS,"index is out of range"),mt(this[e])}setComponent(e,r){return Cc(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=r,this.check()}addVectors(e,r){return this.copy(e).add(r)}subVectors(e,r){return this.copy(e).subtract(r)}multiplyVectors(e,r){return this.copy(e).multiply(r)}addScaledVector(e,r){return this.add(new this.constructor(e).multiplyScalar(r))}}let hn=typeof Float32Array<"u"?Float32Array:Array;function t0(){const t=new hn(2);return hn!=Float32Array&&(t[0]=0,t[1]=0),t}function r0(t,e,r){const s=e[0],n=e[1];return t[0]=r[0]*s+r[3]*n+r[6],t[1]=r[1]*s+r[4]*n+r[7],t}(function(){const t=t0();return function(e,r,s,n,i,o){let a,c;for(r||(r=2),s||(s=0),n?c=Math.min(n*r+s,e.length):c=e.length,a=s;a<c;a+=r)t[0]=e[a],t[1]=e[a+1],i(t,t,o),e[a]=t[0],e[a+1]=t[1];return e}})();function s0(t,e,r){const s=e[0],n=e[1],i=e[2],o=r[3]*s+r[7]*n+r[11]*i||1;return t[0]=(r[0]*s+r[4]*n+r[8]*i)/o,t[1]=(r[1]*s+r[5]*n+r[9]*i)/o,t[2]=(r[2]*s+r[6]*n+r[10]*i)/o,t}function n0(t,e,r){const s=e[0],n=e[1];return t[0]=r[0]*s+r[2]*n,t[1]=r[1]*s+r[3]*n,t[2]=e[2],t}function i0(t,e,r){const s=e[0],n=e[1],i=e[2];return t[0]=r[0]*s+r[3]*n+r[6]*i,t[1]=r[1]*s+r[4]*n+r[7]*i,t[2]=r[2]*s+r[5]*n+r[8]*i,t[3]=e[3],t}function o0(){const t=new hn(3);return hn!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function a0(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function u0(t,e,r){const s=e[0],n=e[1],i=e[2],o=r[0],a=r[1],c=r[2];return t[0]=n*c-i*a,t[1]=i*o-s*c,t[2]=s*a-n*o,t}function c0(t,e,r){const s=e[0],n=e[1],i=e[2];let o=r[3]*s+r[7]*n+r[11]*i+r[15];return o=o||1,t[0]=(r[0]*s+r[4]*n+r[8]*i+r[12])/o,t[1]=(r[1]*s+r[5]*n+r[9]*i+r[13])/o,t[2]=(r[2]*s+r[6]*n+r[10]*i+r[14])/o,t}function Tc(t,e,r){const s=e[0],n=e[1],i=e[2];return t[0]=s*r[0]+n*r[3]+i*r[6],t[1]=s*r[1]+n*r[4]+i*r[7],t[2]=s*r[2]+n*r[5]+i*r[8],t}function l0(t,e,r){const s=r[0],n=r[1],i=r[2],o=r[3],a=e[0],c=e[1],m=e[2];let _=n*m-i*c,v=i*a-s*m,P=s*c-n*a,O=n*P-i*v,D=i*_-s*P,U=s*v-n*_;const X=o*2;return _*=X,v*=X,P*=X,O*=2,D*=2,U*=2,t[0]=a+_+O,t[1]=c+v+D,t[2]=m+P+U,t}function d0(t,e,r,s){const n=[],i=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],i[0]=n[0],i[1]=n[1]*Math.cos(s)-n[2]*Math.sin(s),i[2]=n[1]*Math.sin(s)+n[2]*Math.cos(s),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t}function h0(t,e,r,s){const n=[],i=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],i[0]=n[2]*Math.sin(s)+n[0]*Math.cos(s),i[1]=n[1],i[2]=n[2]*Math.cos(s)-n[0]*Math.sin(s),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t}function f0(t,e,r,s){const n=[],i=[];return n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],i[0]=n[0]*Math.cos(s)-n[1]*Math.sin(s),i[1]=n[0]*Math.sin(s)+n[1]*Math.cos(s),i[2]=n[2],t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2],t}function p0(t,e){const r=t[0],s=t[1],n=t[2],i=e[0],o=e[1],a=e[2],c=Math.sqrt((r*r+s*s+n*n)*(i*i+o*o+a*a)),m=c&&a0(t,e)/c;return Math.acos(Math.min(Math.max(m,-1),1))}(function(){const t=o0();return function(e,r,s,n,i,o){let a,c;for(r||(r=3),s||(s=0),n?c=Math.min(n*r+s,e.length):c=e.length,a=s;a<c;a+=r)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],i(t,t,o),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2];return e}})();const ao=[0,0,0];let fn;class uo extends e0{static get ZERO(){return fn||(fn=new uo(0,0,0),Object.freeze(fn)),fn}constructor(e=0,r=0,s=0){super(-0,-0,-0),arguments.length===1&&dn(e)?this.copy(e):(Bt.debug&&(mt(e),mt(r),mt(s)),this[0]=e,this[1]=r,this[2]=s)}set(e,r,s){return this[0]=e,this[1]=r,this[2]=s,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Bt.debug&&(mt(e.x),mt(e.y),mt(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=mt(e)}angle(e){return p0(this,e)}cross(e){return u0(this,this,e),this.check()}rotateX({radians:e,origin:r=ao}){return d0(this,this,r,e),this.check()}rotateY({radians:e,origin:r=ao}){return h0(this,this,r,e),this.check()}rotateZ({radians:e,origin:r=ao}){return f0(this,this,r,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return c0(this,this,e),this.check()}transformAsVector(e){return s0(this,this,e),this.check()}transformByMatrix3(e){return Tc(this,this,e),this.check()}transformByMatrix2(e){return n0(this,this,e),this.check()}transformByQuaternion(e){return l0(this,this,e),this.check()}}class m0 extends vc{toString(){let e="[";if(Bt.printRowMajor){e+="row-major:";for(let r=0;r<this.RANK;++r)for(let s=0;s<this.RANK;++s)e+=` ${this[s*this.RANK+r]}`}else{e+="column-major:";for(let r=0;r<this.ELEMENTS;++r)e+=` ${this[r]}`}return e+="]",e}getElementIndex(e,r){return r*this.RANK+e}getElement(e,r){return this[r*this.RANK+e]}setElement(e,r,s){return this[r*this.RANK+e]=mt(s),this}getColumn(e,r=new Array(this.RANK).fill(-0)){const s=e*this.RANK;for(let n=0;n<this.RANK;++n)r[n]=this[s+n];return r}setColumn(e,r){const s=e*this.RANK;for(let n=0;n<this.RANK;++n)this[s+n]=r[n];return this}}function g0(t,e){if(t===e){const r=e[1],s=e[2],n=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=s,t[7]=n}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function y0(t,e){const r=e[0],s=e[1],n=e[2],i=e[3],o=e[4],a=e[5],c=e[6],m=e[7],_=e[8],v=_*o-a*m,P=-_*i+a*c,O=m*i-o*c;let D=r*v+s*P+n*O;return D?(D=1/D,t[0]=v*D,t[1]=(-_*s+n*m)*D,t[2]=(a*s-n*o)*D,t[3]=P*D,t[4]=(_*r-n*c)*D,t[5]=(-a*r+n*i)*D,t[6]=O*D,t[7]=(-m*r+s*c)*D,t[8]=(o*r-s*i)*D,t):null}function _0(t){const e=t[0],r=t[1],s=t[2],n=t[3],i=t[4],o=t[5],a=t[6],c=t[7],m=t[8];return e*(m*i-o*c)+r*(-m*n+o*a)+s*(c*n-i*a)}function Sc(t,e,r){const s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],m=e[6],_=e[7],v=e[8],P=r[0],O=r[1],D=r[2],U=r[3],X=r[4],Y=r[5],Q=r[6],q=r[7],j=r[8];return t[0]=P*s+O*o+D*m,t[1]=P*n+O*a+D*_,t[2]=P*i+O*c+D*v,t[3]=U*s+X*o+Y*m,t[4]=U*n+X*a+Y*_,t[5]=U*i+X*c+Y*v,t[6]=Q*s+q*o+j*m,t[7]=Q*n+q*a+j*_,t[8]=Q*i+q*c+j*v,t}function b0(t,e,r){const s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],m=e[6],_=e[7],v=e[8],P=r[0],O=r[1];return t[0]=s,t[1]=n,t[2]=i,t[3]=o,t[4]=a,t[5]=c,t[6]=P*s+O*o+m,t[7]=P*n+O*a+_,t[8]=P*i+O*c+v,t}function x0(t,e,r){const s=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],m=e[6],_=e[7],v=e[8],P=Math.sin(r),O=Math.cos(r);return t[0]=O*s+P*o,t[1]=O*n+P*a,t[2]=O*i+P*c,t[3]=O*o-P*s,t[4]=O*a-P*n,t[5]=O*c-P*i,t[6]=m,t[7]=_,t[8]=v,t}function Ec(t,e,r){const s=r[0],n=r[1];return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=n*e[3],t[4]=n*e[4],t[5]=n*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function A0(t,e){const r=e[0],s=e[1],n=e[2],i=e[3],o=r+r,a=s+s,c=n+n,m=r*o,_=s*o,v=s*a,P=n*o,O=n*a,D=n*c,U=i*o,X=i*a,Y=i*c;return t[0]=1-v-D,t[3]=_-Y,t[6]=P+X,t[1]=_+Y,t[4]=1-m-D,t[7]=O-U,t[2]=P-X,t[5]=O+U,t[8]=1-m-v,t}var co;(function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL1ROW0=3]="COL1ROW0",t[t.COL1ROW1=4]="COL1ROW1",t[t.COL1ROW2=5]="COL1ROW2",t[t.COL2ROW0=6]="COL2ROW0",t[t.COL2ROW1=7]="COL2ROW1",t[t.COL2ROW2=8]="COL2ROW2"})(co||(co={}));const B0=Object.freeze([1,0,0,0,1,0,0,0,1]);class xs extends m0{static get IDENTITY(){return v0()}static get ZERO(){return w0()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return co}constructor(e,...r){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):r.length>0?this.copy([e,...r]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(B0)}fromObject(e){return this.check()}fromQuaternion(e){return A0(this,e),this.check()}set(e,r,s,n,i,o,a,c,m){return this[0]=e,this[1]=r,this[2]=s,this[3]=n,this[4]=i,this[5]=o,this[6]=a,this[7]=c,this[8]=m,this.check()}setRowMajor(e,r,s,n,i,o,a,c,m){return this[0]=e,this[1]=n,this[2]=a,this[3]=r,this[4]=i,this[5]=c,this[6]=s,this[7]=o,this[8]=m,this.check()}determinant(){return _0(this)}transpose(){return g0(this,this),this.check()}invert(){return y0(this,this),this.check()}multiplyLeft(e){return Sc(this,e,this),this.check()}multiplyRight(e){return Sc(this,this,e),this.check()}rotate(e){return x0(this,this,e),this.check()}scale(e){return Array.isArray(e)?Ec(this,this,e):Ec(this,this,[e,e]),this.check()}translate(e){return b0(this,this,e),this.check()}transform(e,r){let s;switch(e.length){case 2:s=r0(r||[-0,-0],e,this);break;case 3:s=Tc(r||[-0,-0,-0],e,this);break;case 4:s=i0(r||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Zy(s,e.length),s}transformVector(e,r){return this.transform(e,r)}transformVector2(e,r){return this.transform(e,r)}transformVector3(e,r){return this.transform(e,r)}}let pn,mn=null;function w0(){return pn||(pn=new xs([0,0,0,0,0,0,0,0,0]),Object.freeze(pn)),pn}function v0(){return mn||(mn=new xs,Object.freeze(mn)),mn}const gn="KHR_texture_transform",C0=gn,yn=new uo,T0=new xs,S0=new xs;async function E0(t,e){var s;if(!new Ne(t).hasExtension(gn)||!((s=e.gltf)!=null&&s.loadBuffers))return;const r=t.json.materials||[];for(let n=0;n<r.length;n++)M0(n,t)}function M0(t,e){var i,o,a,c;const r=(i=e.json.materials)==null?void 0:i[t],s=[(o=r==null?void 0:r.pbrMetallicRoughness)==null?void 0:o.baseColorTexture,r==null?void 0:r.emissiveTexture,r==null?void 0:r.normalTexture,r==null?void 0:r.occlusionTexture,(a=r==null?void 0:r.pbrMetallicRoughness)==null?void 0:a.metallicRoughnessTexture],n=[];for(const m of s)m&&((c=m==null?void 0:m.extensions)!=null&&c[gn])&&P0(e,t,m,n)}function P0(t,e,r,s){const n=R0(r,s);if(!n)return;const i=t.json.meshes||[];for(const o of i)for(const a of o.primitives){const c=a.material;Number.isFinite(c)&&e===c&&G0(t,a,n)}}function R0(t,e){var i;const r=(i=t.extensions)==null?void 0:i[gn],{texCoord:s=0}=t,{texCoord:n=s}=r;if(e.findIndex(([o,a])=>o===s&&a===n)===-1){const o=D0(r);return s!==n&&(t.texCoord=n),e.push([s,n]),{originalTexCoord:s,texCoord:n,matrix:o}}return null}function G0(t,e,r){var a,c;const{originalTexCoord:s,texCoord:n,matrix:i}=r,o=e.attributes[`TEXCOORD_${s}`];if(Number.isFinite(o)){const m=(a=t.json.accessors)==null?void 0:a[o];if(m&&m.bufferView){const _=(c=t.json.bufferViews)==null?void 0:c[m.bufferView];if(_){const{arrayBuffer:v,byteOffset:P}=t.buffers[_.buffer],O=(P||0)+(m.byteOffset||0)+(_.byteOffset||0),{ArrayType:D,length:U}=Xi(m,_),X=qu[m.componentType],Y=Qu[m.type],Q=_.byteStride||X*Y,q=new Float32Array(U);for(let j=0;j<m.count;j++){const W=new D(v,O+j*Q,2);yn.set(W[0],W[1],1),yn.transformByMatrix3(i),q.set([yn[0],yn[1]],j*Y)}s===n?L0(m,_,t.buffers,q):O0(n,m,e,t,q)}}}}function L0(t,e,r,s){t.componentType=5126,r.push({arrayBuffer:s.buffer,byteOffset:0,byteLength:s.buffer.byteLength}),e.buffer=r.length-1,e.byteLength=s.buffer.byteLength,e.byteOffset=0,delete e.byteStride}function O0(t,e,r,s,n){s.buffers.push({arrayBuffer:n.buffer,byteOffset:0,byteLength:n.buffer.byteLength});const i=s.json.bufferViews;if(!i)return;i.push({buffer:s.buffers.length-1,byteLength:n.buffer.byteLength,byteOffset:0});const o=s.json.accessors;o&&(o.push({bufferView:(i==null?void 0:i.length)-1,byteOffset:0,componentType:5126,count:e.count,type:"VEC2"}),r.attributes[`TEXCOORD_${t}`]=o.length-1)}function D0(t){const{offset:e=[0,0],rotation:r=0,scale:s=[1,1]}=t,n=new xs().set(1,0,0,0,1,0,e[0],e[1],1),i=T0.set(Math.cos(r),Math.sin(r),0,-Math.sin(r),Math.cos(r),0,0,0,1),o=S0.set(s[0],0,0,0,s[1],0,0,0,1);return n.multiplyRight(i).multiplyRight(o)}const I0=Object.freeze(Object.defineProperty({__proto__:null,decode:E0,name:C0},Symbol.toStringTag,{value:"Module"})),wr="KHR_lights_punctual",F0=wr;async function U0(t){const e=new Ne(t),{json:r}=e,s=e.getExtension(wr);s&&(e.json.lights=s.lights,e.removeExtension(wr));for(const n of r.nodes||[]){const i=e.getObjectExtension(n,wr);i&&(n.light=i.light),e.removeObjectExtension(n,wr)}}async function k0(t){const e=new Ne(t),{json:r}=e;if(r.lights){const s=e.addExtension(wr);ft(!s.lights),s.lights=r.lights,delete r.lights}if(e.json.lights){for(const s of e.json.lights){const n=s.node;e.addObjectExtension(n,wr,s)}delete e.json.lights}}const N0=Object.freeze(Object.defineProperty({__proto__:null,decode:U0,encode:k0,name:F0},Symbol.toStringTag,{value:"Module"})),As="KHR_materials_unlit",V0=As;async function H0(t){const e=new Ne(t),{json:r}=e;for(const s of r.materials||[])s.extensions&&s.extensions.KHR_materials_unlit&&(s.unlit=!0),e.removeObjectExtension(s,As);e.removeExtension(As)}function j0(t){const e=new Ne(t),{json:r}=e;if(e.materials)for(const s of r.materials||[])s.unlit&&(delete s.unlit,e.addObjectExtension(s,As,{}),e.addExtension(As))}const z0=Object.freeze(Object.defineProperty({__proto__:null,decode:H0,encode:j0,name:V0},Symbol.toStringTag,{value:"Module"})),Bs="KHR_techniques_webgl",J0=Bs;async function K0(t){const e=new Ne(t),{json:r}=e,s=e.getExtension(Bs);if(s){const n=W0(s,e);for(const i of r.materials||[]){const o=e.getObjectExtension(i,Bs);o&&(i.technique=Object.assign({},o,n[o.technique]),i.technique.values=Y0(i.technique,e)),e.removeObjectExtension(i,Bs)}e.removeExtension(Bs)}}async function X0(t,e){}function W0(t,e){const{programs:r=[],shaders:s=[],techniques:n=[]}=t,i=new TextDecoder;return s.forEach(o=>{if(Number.isFinite(o.bufferView))o.code=i.decode(e.getTypedArrayForBufferView(o.bufferView));else throw new Error("KHR_techniques_webgl: no shader code")}),r.forEach(o=>{o.fragmentShader=s[o.fragmentShader],o.vertexShader=s[o.vertexShader]}),n.forEach(o=>{o.program=r[o.program]}),n}function Y0(t,e){const r=Object.assign({},t.values);return Object.keys(t.uniforms||{}).forEach(s=>{t.uniforms[s].value&&!(s in r)&&(r[s]=t.uniforms[s].value)}),Object.keys(r).forEach(s=>{typeof r[s]=="object"&&r[s].index!==void 0&&(r[s].texture=e.getTexture(r[s].index))}),r}const $0=Object.freeze(Object.defineProperty({__proto__:null,decode:K0,encode:X0,name:J0},Symbol.toStringTag,{value:"Module"})),Mc=[cg,Om,py,yy,xy,Wy,N0,z0,$0,I0,Tg];function Q0(t,e={},r){var n;const s=Mc.filter(i=>Pc(i.name,e));for(const i of s)(n=i.preprocess)==null||n.call(i,t,e,r)}async function q0(t,e={},r){var n;const s=Mc.filter(i=>Pc(i.name,e));for(const i of s)await((n=i.decode)==null?void 0:n.call(i,t,e,r))}function Pc(t,e){var s;const r=((s=e==null?void 0:e.gltf)==null?void 0:s.excludeExtensions)||{};return!(t in r&&!r[t])}const lo="KHR_binary_glTF";function Z0(t){const e=new Ne(t),{json:r}=e;for(const s of r.images||[]){const n=e.getObjectExtension(s,lo);n&&Object.assign(s,n),e.removeObjectExtension(s,lo)}r.buffers&&r.buffers[0]&&delete r.buffers[0].uri,e.removeExtension(lo)}const Rc={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},e_={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class t_{constructor(){ce(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}});ce(this,"json")}normalize(e,r){this.json=e.json;const s=e.json;switch(s.asset&&s.asset.version){case"2.0":return;case void 0:case"1.0":break;default:console.warn(`glTF: Unknown version ${s.asset.version}`);return}if(!r.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(s),this._convertTopLevelObjectsToArrays(s),Z0(e),this._convertObjectIdsToArrayIndices(s),this._updateObjects(s),this._updateMaterial(s)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const r in Rc)this._convertTopLevelObjectToArray(e,r)}_convertTopLevelObjectToArray(e,r){const s=e[r];if(!(!s||Array.isArray(s))){e[r]=[];for(const n in s){const i=s[n];i.id=i.id||n;const o=e[r].length;e[r].push(i),this.idToIndexMap[r][n]=o}}}_convertObjectIdsToArrayIndices(e){for(const r in Rc)this._convertIdsToIndices(e,r);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const r of e.textures)this._convertTextureIds(r);for(const r of e.meshes)this._convertMeshIds(r);for(const r of e.nodes)this._convertNodeIds(r);for(const r of e.scenes)this._convertSceneIds(r)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const r of e.primitives){const{attributes:s,indices:n,material:i}=r;for(const o in s)s[o]=this._convertIdToIndex(s[o],"accessor");n&&(r.indices=this._convertIdToIndex(n,"accessor")),i&&(r.material=this._convertIdToIndex(i,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map(r=>this._convertIdToIndex(r,"node"))),e.meshes&&(e.meshes=e.meshes.map(r=>this._convertIdToIndex(r,"mesh")))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map(r=>this._convertIdToIndex(r,"node")))}_convertIdsToIndices(e,r){e[r]||(console.warn(`gltf v1: json doesn't contain attribute ${r}`),e[r]=[]);for(const s of e[r])for(const n in s){const i=s[n],o=this._convertIdToIndex(i,n);s[n]=o}}_convertIdToIndex(e,r){const s=e_[r];if(s in this.idToIndexMap){const n=this.idToIndexMap[s][e];if(!Number.isFinite(n))throw new Error(`gltf v1: failed to resolve ${r} with id ${e}`);return n}return e}_updateObjects(e){for(const r of this.json.buffers)delete r.type}_updateMaterial(e){var r,s,n;for(const i of e.materials){i.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const o=((r=i.values)==null?void 0:r.tex)||((s=i.values)==null?void 0:s.texture2d_0)||((n=i.values)==null?void 0:n.diffuseTex),a=e.textures.findIndex(c=>c.id===o);a!==-1&&(i.pbrMetallicRoughness.baseColorTexture={index:a})}}}function r_(t,e={}){return new t_().normalize(t,e)}async function s_(t,e,r=0,s,n){var i,o,a;return n_(t,e,r,s),r_(t,{normalize:(i=s==null?void 0:s.gltf)==null?void 0:i.normalize}),Q0(t,s,n),(o=s==null?void 0:s.gltf)!=null&&o.loadBuffers&&t.json.buffers&&await i_(t,s,n),(a=s==null?void 0:s.gltf)!=null&&a.loadImages&&await o_(t,s,n),await q0(t,s,n),t}function n_(t,e,r,s){if(s.uri&&(t.baseUri=s.uri),e instanceof ArrayBuffer&&!Yg(e,r,s)&&(e=new TextDecoder().decode(e)),typeof e=="string")t.json=yf(e);else if(e instanceof ArrayBuffer){const o={};r=$g(o,e,r,s.glb),ft(o.type==="glTF",`Invalid GLB magic string ${o.type}`),t._glb=o,t.json=o.json}else ft(!1,"GLTF: must be ArrayBuffer or string");const n=t.json.buffers||[];if(t.buffers=new Array(n.length).fill(null),t._glb&&t._glb.header.hasBinChunk){const{binChunks:o}=t._glb;t.buffers[0]={arrayBuffer:o[0].arrayBuffer,byteOffset:o[0].byteOffset,byteLength:o[0].byteLength}}const i=t.json.images||[];t.images=new Array(i.length).fill({})}async function i_(t,e,r){var n,i,o;const s=t.json.buffers||[];for(let a=0;a<s.length;++a){const c=s[a];if(c.uri){const{fetch:m}=r;ft(m);const _=yc(c.uri,e),v=await((o=(i=await((n=r==null?void 0:r.fetch)==null?void 0:n.call(r,_)))==null?void 0:i.arrayBuffer)==null?void 0:o.call(i));t.buffers[a]={arrayBuffer:v,byteOffset:0,byteLength:v.byteLength},delete c.uri}else t.buffers[a]===null&&(t.buffers[a]={arrayBuffer:new ArrayBuffer(c.byteLength),byteOffset:0,byteLength:c.byteLength})}}async function o_(t,e,r){const s=a_(t),n=t.json.images||[],i=[];for(const o of s)i.push(u_(t,n[o],o,e,r));return await Promise.all(i)}function a_(t){const e=new Set,r=t.json.textures||[];for(const s of r)s.source!==void 0&&e.add(s.source);return Array.from(e).sort()}async function u_(t,e,r,s,n){let i;if(e.uri&&!e.hasOwnProperty("bufferView")){const a=yc(e.uri,s),{fetch:c}=n;i=await(await c(a)).arrayBuffer(),e.bufferView={data:i}}if(Number.isFinite(e.bufferView)){const a=bm(t.json,t.buffers,e.bufferView);i=Au(a.buffer,a.byteOffset,a.byteLength)}ft(i,"glTF image has no data");let o=await ou(i,[cm,Hg],{...s,mimeType:e.mimeType,basis:s.basis||{format:mc()}},n);o&&o[0]&&(o={compressed:!0,mipmaps:!1,width:o[0].width,height:o[0].height,data:o[0]}),t.images=t.images||[],t.images[r]=o}const ho={dataType:null,batchType:null,name:"glTF",id:"gltf",module:"gltf",version:Sg,extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:c_,options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0},log:console}};async function c_(t,e={},r){e={...ho.options,...e},e.gltf={...ho.options.gltf,...e.gltf};const{byteOffset:s=0}=e;return await s_({},t,s,e,r)}const l_={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},d_={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},wt={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},h_={magFilter:wt.TEXTURE_MAG_FILTER,minFilter:wt.TEXTURE_MIN_FILTER,wrapS:wt.TEXTURE_WRAP_S,wrapT:wt.TEXTURE_WRAP_T},f_={[wt.TEXTURE_MAG_FILTER]:wt.LINEAR,[wt.TEXTURE_MIN_FILTER]:wt.NEAREST_MIPMAP_LINEAR,[wt.TEXTURE_WRAP_S]:wt.REPEAT,[wt.TEXTURE_WRAP_T]:wt.REPEAT};function p_(){return{id:"default-sampler",parameters:f_}}function m_(t){return d_[t]}function g_(t){return l_[t]}class y_{constructor(){ce(this,"baseUri","");ce(this,"jsonUnprocessed");ce(this,"json");ce(this,"buffers",[]);ce(this,"images",[])}postProcess(e,r={}){const{json:s,buffers:n=[],images:i=[]}=e,{baseUri:o=""}=e;return ft(s),this.baseUri=o,this.buffers=n,this.images=i,this.jsonUnprocessed=s,this.json=this._resolveTree(e.json,r),this.json}_resolveTree(e,r={}){const s={...e};return this.json=s,e.bufferViews&&(s.bufferViews=e.bufferViews.map((n,i)=>this._resolveBufferView(n,i))),e.images&&(s.images=e.images.map((n,i)=>this._resolveImage(n,i))),e.samplers&&(s.samplers=e.samplers.map((n,i)=>this._resolveSampler(n,i))),e.textures&&(s.textures=e.textures.map((n,i)=>this._resolveTexture(n,i))),e.accessors&&(s.accessors=e.accessors.map((n,i)=>this._resolveAccessor(n,i))),e.materials&&(s.materials=e.materials.map((n,i)=>this._resolveMaterial(n,i))),e.meshes&&(s.meshes=e.meshes.map((n,i)=>this._resolveMesh(n,i))),e.nodes&&(s.nodes=e.nodes.map((n,i)=>this._resolveNode(n,i)),s.nodes=s.nodes.map((n,i)=>this._resolveNodeChildren(n))),e.skins&&(s.skins=e.skins.map((n,i)=>this._resolveSkin(n,i))),e.scenes&&(s.scenes=e.scenes.map((n,i)=>this._resolveScene(n,i))),typeof this.json.scene=="number"&&s.scenes&&(s.scene=s.scenes[this.json.scene]),s}getScene(e){return this._get(this.json.scenes,e)}getNode(e){return this._get(this.json.nodes,e)}getSkin(e){return this._get(this.json.skins,e)}getMesh(e){return this._get(this.json.meshes,e)}getMaterial(e){return this._get(this.json.materials,e)}getAccessor(e){return this._get(this.json.accessors,e)}getCamera(e){return this._get(this.json.cameras,e)}getTexture(e){return this._get(this.json.textures,e)}getSampler(e){return this._get(this.json.samplers,e)}getImage(e){return this._get(this.json.images,e)}getBufferView(e){return this._get(this.json.bufferViews,e)}getBuffer(e){return this._get(this.json.buffers,e)}_get(e,r){if(typeof r=="object")return r;const s=e&&e[r];return s||console.warn(`glTF file error: Could not find ${e}[${r}]`),s}_resolveScene(e,r){return{...e,id:e.id||`scene-${r}`,nodes:(e.nodes||[]).map(s=>this.getNode(s))}}_resolveNode(e,r){const s={...e,id:(e==null?void 0:e.id)||`node-${r}`};return e.mesh!==void 0&&(s.mesh=this.getMesh(e.mesh)),e.camera!==void 0&&(s.camera=this.getCamera(e.camera)),e.skin!==void 0&&(s.skin=this.getSkin(e.skin)),e.meshes!==void 0&&e.meshes.length&&(s.mesh=e.meshes.reduce((n,i)=>{const o=this.getMesh(i);return n.id=o.id,n.primitives=n.primitives.concat(o.primitives),n},{primitives:[]})),s}_resolveNodeChildren(e){return e.children&&(e.children=e.children.map(r=>this.getNode(r))),e}_resolveSkin(e,r){const s=typeof e.inverseBindMatrices=="number"?this.getAccessor(e.inverseBindMatrices):void 0;return{...e,id:e.id||`skin-${r}`,inverseBindMatrices:s}}_resolveMesh(e,r){const s={...e,id:e.id||`mesh-${r}`,primitives:[]};return e.primitives&&(s.primitives=e.primitives.map(n=>{const i={...n,attributes:{},indices:void 0,material:void 0},o=n.attributes;for(const a in o)i.attributes[a]=this.getAccessor(o[a]);return n.indices!==void 0&&(i.indices=this.getAccessor(n.indices)),n.material!==void 0&&(i.material=this.getMaterial(n.material)),i})),s}_resolveMaterial(e,r){const s={...e,id:e.id||`material-${r}`};if(s.normalTexture&&(s.normalTexture={...s.normalTexture},s.normalTexture.texture=this.getTexture(s.normalTexture.index)),s.occlusionTexture&&(s.occlusionTexture={...s.occlusionTexture},s.occlusionTexture.texture=this.getTexture(s.occlusionTexture.index)),s.emissiveTexture&&(s.emissiveTexture={...s.emissiveTexture},s.emissiveTexture.texture=this.getTexture(s.emissiveTexture.index)),s.emissiveFactor||(s.emissiveFactor=s.emissiveTexture?[1,1,1]:[0,0,0]),s.pbrMetallicRoughness){s.pbrMetallicRoughness={...s.pbrMetallicRoughness};const n=s.pbrMetallicRoughness;n.baseColorTexture&&(n.baseColorTexture={...n.baseColorTexture},n.baseColorTexture.texture=this.getTexture(n.baseColorTexture.index)),n.metallicRoughnessTexture&&(n.metallicRoughnessTexture={...n.metallicRoughnessTexture},n.metallicRoughnessTexture.texture=this.getTexture(n.metallicRoughnessTexture.index))}return s}_resolveAccessor(e,r){const s=m_(e.componentType),n=g_(e.type),i=s*n,o={...e,id:e.id||`accessor-${r}`,bytesPerComponent:s,components:n,bytesPerElement:i,value:void 0,bufferView:void 0,sparse:void 0};if(e.bufferView!==void 0&&(o.bufferView=this.getBufferView(e.bufferView)),o.bufferView){const a=o.bufferView.buffer,{ArrayType:c,byteLength:m}=Xi(o,o.bufferView),_=(o.bufferView.byteOffset||0)+(o.byteOffset||0)+a.byteOffset;let v=a.arrayBuffer.slice(_,_+m);o.bufferView.byteStride&&(v=this._getValueFromInterleavedBuffer(a,_,o.bufferView.byteStride,o.bytesPerElement,o.count)),o.value=new c(v)}return o}_getValueFromInterleavedBuffer(e,r,s,n,i){const o=new Uint8Array(i*n);for(let a=0;a<i;a++){const c=r+a*s;o.set(new Uint8Array(e.arrayBuffer.slice(c,c+n)),a*n)}return o.buffer}_resolveTexture(e,r){return{...e,id:e.id||`texture-${r}`,sampler:typeof e.sampler=="number"?this.getSampler(e.sampler):p_(),source:typeof e.source=="number"?this.getImage(e.source):void 0}}_resolveSampler(e,r){const s={id:e.id||`sampler-${r}`,...e,parameters:{}};for(const n in s){const i=this._enumSamplerParameter(n);i!==void 0&&(s.parameters[i]=s[n])}return s}_enumSamplerParameter(e){return h_[e]}_resolveImage(e,r){const s={...e,id:e.id||`image-${r}`,image:null,bufferView:e.bufferView!==void 0?this.getBufferView(e.bufferView):void 0},n=this.images[r];return n&&(s.image=n),s}_resolveBufferView(e,r){const s=e.buffer,n=this.buffers[s].arrayBuffer;let i=this.buffers[s].byteOffset||0;return e.byteOffset&&(i+=e.byteOffset),{id:`bufferView-${r}`,...e,buffer:this.buffers[s],data:new Uint8Array(n,i,e.byteLength)}}_resolveCamera(e,r){const s={...e,id:e.id||`camera-${r}`};return s.perspective,s.orthographic,s}}function __(t,e){return new y_().postProcess(t,e)}let _n,bn;const jn=class jn extends Nt{static get defaultGLTFLayout(){if(bn)return bn;const e=[{shaderLocation:xt.Position,format:"float32x3",offset:0}],r=[{shaderLocation:xt.Normal,format:"float32x3",offset:0}],s=[{shaderLocation:xt.TexCoord,format:"float32x2",offset:0}],n=[{shaderLocation:xt.Tangent,format:"float32x4",offset:0}];return bn=[{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:e},{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:r},{arrayStride:2*Float32Array.BYTES_PER_ELEMENT,attributes:s},{arrayStride:4*Float32Array.BYTES_PER_ELEMENT,attributes:n}],bn}static get defaultLayout(){if(_n)return _n;const e=[{shaderLocation:xt.Position,offset:0,format:"float32x3"},{shaderLocation:xt.Normal,offset:3*Float32Array.BYTES_PER_ELEMENT,format:"float32x3"},{shaderLocation:xt.TexCoord,offset:6*Float32Array.BYTES_PER_ELEMENT,format:"float32x2"},{shaderLocation:xt.Tangent,offset:8*Float32Array.BYTES_PER_ELEMENT,format:"float32x4"}];return _n=[{arrayStride:jn.itemsPerVertexDefaultLayout*Float32Array.BYTES_PER_ELEMENT,attributes:e}],_n}};jn.itemsPerVertexDefaultLayout=12;let ze=jn;class Gc{constructor(){this.min=H.create(),this.max=H.create(),this._temp=H.create()}get minX(){return this.min[0]}get minY(){return this.min[1]}get minZ(){return this.min[2]}get maxX(){return this.max[0]}get maxY(){return this.max[1]}get maxZ(){return this.max[2]}getArea(){const e=this.max[0]-this.min[0],r=this.max[1]-this.min[1],s=this.max[2]-this.min[2];return 2*(e*e+r*r+s*s)}setMinAABB(e,r,s){this.min[0]=e,this.min[1]=r,this.min[2]=s}setMinAABBfromGLTF(e){this.setMinAABB(e[0],e[1],e[2])}setMaxAABB(e,r,s){this.max[0]=e,this.max[1]=r,this.max[2]=s}setMaxAABBfromGLTF(e){this.setMaxAABB(e[0],e[1],e[2])}get boundingBoxCenter(){return this.getBoundingBoxCenter()}getBoundingBoxCenter(){return this._temp[0]=this.max[0]-this.min[0],this._temp[1]=this.max[1]-this.min[1],this._temp[2]=this.max[2]-this.min[2],this._temp}}class xn{constructor(){this.faces=[],this.boundingBox=new Gc,this.vertexBuffers=[],this.indexCount=0,this.vertexBufferOffsets=new Map,this.indexBufferOffsets=[0,0]}createBuffersWithTangentsManually(e,r,s,n,i){this.indexCount=e;const o=H.create(),a=H.create(),c=new Float32Array(ze.itemsPerVertexDefaultLayout*e),m=new Array(r.length).fill(null).map(j=>H.create()),_=new Array(r.length).fill(null).map(j=>H.create());for(const j of this.faces)Q(j);let v=Number.POSITIVE_INFINITY,P=Number.POSITIVE_INFINITY,O=Number.POSITIVE_INFINITY,D=Number.NEGATIVE_INFINITY,U=Number.NEGATIVE_INFINITY,X=Number.NEGATIVE_INFINITY;for(let j=0;j<i.length;j+=3){const W=i[j+0],Z=i[j+1],ue=i[j+2];Y(W),Y(Z),Y(ue)}this.boundingBox.setMinAABB(v,P,O),this.boundingBox.setMaxAABB(D,U,X);function Y(j){const W=s[j],Z=r[j],ue=n[j],me=m[j];v=Math.min(v,Z[0]),P=Math.min(P,Z[1]),O=Math.min(O,Z[2]),D=Math.max(D,Z[0]),U=Math.max(U,Z[1]),X=Math.max(X,Z[2]);const ye=H.normalize(H.sub(me,H.mulScalar(W,H.dot(W,me)))),ve=H.normalize(H.cross(W,me)),Ve=H.dot(ve,_[j])<0?-1:1,oe=j*ze.itemsPerVertexDefaultLayout;c[oe+0]=Z[0],c[oe+1]=Z[1],c[oe+2]=Z[2],c[oe+3]=W[0],c[oe+4]=W[1],c[oe+5]=W[2],c[oe+6]=ue[0],c[oe+7]=ue[1],c[oe+8]=ye[0],c[oe+9]=ye[1],c[oe+10]=ye[2],c[oe+11]=Ve}function Q(j){const W=H.sub(j.p1,j.p0),Z=H.sub(j.p2,j.p0),ue=dt.sub(j.texCoord1,j.texCoord0),me=dt.sub(j.texCoord2,j.texCoord0),ye=1/(ue[0]*me[1]-me[0]*ue[1]);o[0]=ye*(me[1]*W[0]-ue[1]*Z[0]),o[1]=ye*(me[1]*W[1]-ue[1]*Z[1]),o[2]=ye*(me[1]*W[2]-ue[1]*Z[2]),a[0]=ye*(-me[0]*W[0]+ue[0]*Z[0]),a[1]=ye*(-me[0]*W[1]+ue[0]*Z[1]),a[2]=ye*(-me[0]*W[2]+ue[0]*Z[2]),H.normalize(o,o),H.normalize(a,a),H.add(m[j.indexV0],o,m[j.indexV0]),H.add(m[j.indexV1],o,m[j.indexV1]),H.add(m[j.indexV2],o,_[j.indexV2]),H.add(_[j.indexV0],a,_[j.indexV0]),H.add(_[j.indexV1],a,_[j.indexV1]),H.add(_[j.indexV2],a,_[j.indexV2])}const q=x.device.createBuffer({mappedAtCreation:!0,size:e*ze.itemsPerVertexDefaultLayout*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX,label:"Mesh Interleaved Vertex GPUBuffer"});ee.addBufferBytes(q),new Float32Array(q.getMappedRange()).set(c,0),q.unmap(),this.vertexBuffers.push(q),this.vertexBufferOffsets.set(q,[0,0]),this.indexBuffer=x.device.createBuffer({mappedAtCreation:!0,size:Uint16Array.BYTES_PER_ELEMENT*i.length,usage:GPUBufferUsage.INDEX,label:"Mesh Index GPUBuffer"}),ee.addBufferBytes(this.indexBuffer),new Uint16Array(this.indexBuffer.getMappedRange()).set(i),this.indexBuffer.unmap(),this.indexBufferOffsets=[0,0]}}class b_ extends xn{constructor(e,r){super(),this.gpuBuffers=r,this.firstIndex=0;const s=e.attributes.POSITION,n=e.attributes.NORMAL,i=e.attributes.TEXCOORD_0,o=e.attributes.TANGENT;if(!s)throw new Error("GLTF Mesh needs to have vertices array");[s,n,i,o].forEach((m,_)=>{if(!m){const O=x.device.createBuffer({label:"Vertex Buffer Placeholder",size:1,usage:GPUBufferUsage.VERTEX});this.vertexBufferOffsets.set(O,[0,1]),ee.addBufferBytes(O),this.vertexBuffers.push(O);return}const v=m.bufferView,P=this.gpuBuffers.get(v.id);this.vertexBuffers.push(P),this.vertexBufferOffsets.set(P,[0,0])});const a=e.indices.bufferView,c=this.gpuBuffers.get(a.id);this.indexBufferOffsets[0]=e.indices.byteOffset,this.indexBufferOffsets[1]=e.indices.count*e.indices.bytesPerElement,this.indexCount=e.indices.count,this.indexBuffer=c}}let fo,po;const Lc=new Map,vr=WebGLRenderingContext;class vt extends Nt{static get defaultNearestSampler(){return fo||(fo=this.createSampler({minFilter:"nearest",magFilter:"nearest"}),fo)}static get defaultSampler(){return po||(po=this.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear",maxAnisotropy:4}),po)}static createSampler(e){const r=structuredClone(e);r.label&&delete r.label;const s=JSON.stringify(r);let n;return(n=Lc.get(s))||(n=x.device.createSampler(e),Lc.set(s,n)),n}static getSamplerFromGltfSamplerDef(e){function r(n){switch(n){case vr.CLAMP_TO_EDGE:return"clamp-to-edge";case vr.MIRRORED_REPEAT:return"mirror-repeat";default:return"repeat"}}const s={addressModeU:r(e.wrapS),addressModeV:r(e.wrapT)};switch((!e.magFilter||e.magFilter==vr.LINEAR)&&(s.magFilter="linear"),e.minFilter){case vr.LINEAR:case vr.LINEAR_MIPMAP_NEAREST:s.minFilter="linear";break;case vr.NEAREST_MIPMAP_LINEAR:s.mipmapFilter="linear";break;case vr.LINEAR_MIPMAP_LINEAR:default:s.minFilter="linear",s.mipmapFilter="linear";break}return s.maxAnisotropy=16,this.createSampler(s)}}function x_(t){t=Number(t);var e={f:t,e:0};if(t!==0&&Number.isFinite(t)){for(var r=Math.abs(t),s=Math.log2||function(o){return Math.log(o)*Math.LOG2E},n=Math.max(-1023,Math.floor(s(r))+1),i=r*Math.pow(2,-n);i>=1;)i*=.5,n++;for(;i<.5;)i*=2,n--;t<0&&(i=-i),e.f=i,e.e=n}return e}function A_(t,e){return t*Math.pow(2,e)}function mo(t,e){if(t[3]!==0){var r=A_(1,t[3]-136);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}else e[0]=e[1]=e[2]=0}function go(t,e){var r=t[0],s=t[1],n=t[2],i=Math.max(r,Math.max(s,n));if(i<9999999999999999e-48)e[0]=e[1]=e[2]=e[3]=0;else{var o=x_(i),a=o.f,c=o.e,m=a/i*256;e[0]=r*m,e[1]=s*m,e[2]=n*m,e[3]=c+128}}function Oc(t,e,r){var s=[],n=3;return B_(s,t,e,n,r),new Uint8Array(s)}function B_(t,e,r,s,n){if(!(r<=0||e<=0||!n)){var i=`#?RADIANCE
# Written by hdr.js
FORMAT=32-bit_rle_rgbe
EXPOSURE=1.0

-Y `+r+" +X "+e+`
`;i.split("").forEach(function(c){var m=c.charCodeAt(0);t.push(m)});for(var o=new Uint8Array(e*4),a=0;a<r;a++)w_(t,e,s,o,n.subarray(s*e*a))}}function w_(t,e,r,s,n){var i=new Uint8Array([2,2,0,0]),o=new Uint8Array(4),a=new Float32Array(3),c;if(i[2]=(e&65280)>>8,i[3]=e&255,e<8||e>=32768)for(c=0;c<e;c++){switch(r){case 4:case 3:a[2]=n[c*r+2],a[1]=n[c*r+1],a[0]=n[c*r+0];break;default:a[0]=a[1]=a[2]=n[c*r+0];break}go(a,o),t.push(o[0],o[1],o[2],o[3])}else{var m=void 0,_=void 0;for(c=0;c<e;c++){switch(r){case 4:case 3:a[2]=n[c*r+2],a[1]=n[c*r+1],a[0]=n[c*r+0];break;default:a[0]=a[1]=a[2]=n[c*r+0];break}go(a,o),s[c+e*0]=o[0],s[c+e*1]=o[1],s[c+e*2]=o[2],s[c+e*3]=o[3]}for(t.push(i[0],i[1],i[2],i[3]),m=0;m<4;m++){var v=s.subarray(e*m);for(c=0;c<e;){for(_=c;_+2<e&&!(v[_]===v[_+1]&&v[_]===v[_+2]);)++_;for(_+2>=e&&(_=e);c<_;){var P=_-c;P>128&&(P=128),v_(t,P,v.subarray(c)),c+=P}if(_+2<e){for(;_<e&&v[_]==v[c];)++_;for(;c<_;){var P=_-c;P>127&&(P=127),C_(t,P,v[c]),c+=P}}}}}}function v_(t,e,r){var s=e&255;if(!(e<=128))throw new Error("length is greater than 128");t.push(s);for(var n=0;n<e;n++)t.push(r[n])}function C_(t,e,r){var s=e+128&255;if(!(e+128<=255))throw new Error("length is greater than 128");t.push(s,r)}function T_(t){return new Promise(function(e,r){typeof XMLHttpRequest>"u"&&r("XMLHttpRequest is undefined, use HDRjs.read instead.");var s=new XMLHttpRequest;s.responseType="arraybuffer",s.onload=function(){if(s.status>=400)return r("Load successfully, but HTTP status code >= 400, status: "+s.status);var n=Fc(new Uint8Array(s.response));typeof n=="string"?r(n):e(n)},s.onerror=function(n){r("Failed to load: "+t)},s.open("GET",t,!0),s.send()})}function S_(t,e,r,s){if(!(document!=null&&document.createElement)||!(URL!=null&&URL.createObjectURL))return console.warn("NO document.createElement or URL.createObjectURL"),!1;var n=Oc(e,r,t),i=URL.createObjectURL(new Blob([n])),o=document.createElement("a");return o.href=i,o.download=s+".hdr",o.rel="noopener",setTimeout(function(){URL.revokeObjectURL(o.href)},4e4),setTimeout(function(){E_(o)},0),!0}function E_(t){try{t.dispatchEvent(new MouseEvent("click"))}catch{var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}function Dc(t,e){for(var r=e.length,s=0;s<r;s++)if(t[s]!==e.charCodeAt(s))return!1;return!0}function M_(t){var e=Dc(t,`#?RADIANCE
`);return e||(e=Dc(t,`#?RGBE
`)),e}var P_=1024*10,Ic=1<<24;function Fc(t){var e="",r=0;if(!M_(t))return"Corrupt HDR image.";for(;!e.match(/\n\n[^\n]+\n/g)&&r<P_;)e+=String.fromCharCode(t[r++]);var s=e.match(/FORMAT=(.*)$/m)[1];if(s!=="32-bit_rle_rgbe")return"Unsupported HDR format: "+s;var n=e.split(/\n/).reverse()[1].split(" ");if(n[0]!=="-Y"||n[2]!=="+X")return"Unsupported HDR format";var i=Number.parseFloat(n[3]),o=Number.parseFloat(n[1]);if(i>Ic||o>Ic)return"Very large image (corrupt?)";var a,c,m=t[r],_=t[r+1],v=t[r+2],P=m!==2||_!==2||!!(v&128),O=new Float32Array(i*o*3);if(i<8||i>=32768||P)for(c=0;c<o;++c)for(a=0;a<i;++a){var D=t.subarray(r,r+4);r+=4;var U=(c*i+a)*3;mo(D,O.subarray(U,U+3))}else for(var X=void 0,Y,Q,q,j=0;j<o;j++){if(Y=t[r++],Q=t[r++],q=t[r++],Y!==2||Q!==2||q&128)return"Invalid scanline";if(q=q<<8,q|=t[r++],q!==i)return"invalid decoded scanline length";X||(X=new Uint8Array(i*4));for(var W=void 0,Z=void 0,ue=0;ue<4;ue++){var me=void 0;for(a=0;(me=i-a)>0;)if(W=t[r++],W>128){if(Z=t[r++],W-=128,W>me)return"bad RLE data in HDR";for(var ye=0;ye<W;ye++)X[a++*4+ue]=Z}else{if(W>me)return"bad RLE data in HDR";for(var ye=0;ye<W;ye++)X[a++*4+ue]=t[r++]}}for(var ve=0;ve<i;ve++)mo(X.subarray(ve*4),O.subarray((j*i+ve)*3))}return{rgbFloat:O,width:i,height:o}}var R_=Object.freeze({load:T_,save:S_,read:Fc,write:Oc,float2rgbe:go,rgbe2float:mo});const Uc="vertexMain",kc="fragmentMain",Nc=`
  ${te.VertexInput}
  ${te.VertexOutput}

  @group(0) @binding(0) var<uniform> projViewMatrix: mat4x4f;
  @group(0) @binding(1) var inTexture: texture_2d<f32>;
  @group(0) @binding(2) var inSampler: sampler;

  const invAtan = vec2(0.1591, 0.3183);
  fn SampleSphericalMap(v: vec3f) -> vec2f {
    var uv = vec2f(atan(v.z / v.x), asin(v.y));
    uv *= invAtan;
    uv += 0.5;
    return uv;
  }


  @vertex
  fn ${Uc}(in: VertexInput) -> VertexOutput {
    var out: VertexOutput;
    out.position = projViewMatrix * in.position;
    // hijack
    out.viewNormal = in.position.xyz;
    return out;
  }

  @fragment
  fn ${kc}(in: VertexOutput) -> @location(0) vec4f {
    let uv = SampleSphericalMap(normalize(in.normal.rgb)); // make sure to normalize localPos
    let color = textureSample(inTexture, inSampler, uv).rgb;
    return vec4f(color, 1);
  }
`;let An,Bn,wn,vn,Cn;const yo=new Map([]),$={get defaultCameraPlusLightsBindGroupLayout(){if(Bn)return Bn;const t=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}];return Bn=x.device.createBindGroupLayout({label:"Camera + Lights GPUBindGroupLayout",entries:t}),Bn},get defaultCameraBindGroupLayout(){if(An)return An;const t=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return An=x.device.createBindGroupLayout({label:"Camera GPUBindGroupLayout",entries:t}),An},get defaultModelBindGroupLayout(){if(wn)return wn;const t=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return wn=x.device.createBindGroupLayout({label:"Model GPUBindGroupLayout",entries:t}),wn},get defaultModelMaterialBindGroupLayout(){if(vn)return vn;const t=[{binding:Js.Default,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:De.Albedo,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:De.Normal,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:De.MetallicRoughness,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}];return vn=x.device.createBindGroupLayout({label:"Model Textures GPUBindGroupLayout",entries:t}),vn},get instancesBindGroupLayout(){if(Cn)return Cn;const t=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}];return Cn=x.device.createBindGroupLayout({label:"Instance Models GPUBindGroupLayout",entries:t}),Cn},createShaderModule:(t,e=`Shader Module #${yo.size}`)=>{let r;return(r=yo.get(t))||(r=x.device.createShaderModule({label:e,code:t}),yo.set(t,r)),r},createRenderPipeline:t=>{let e;return e=x.device.createRenderPipeline(t),e},createComputePipeline:t=>x.device.createComputePipeline(t)};class $r{constructor(e,r,s,n,i,o,a,c,m,_,v,P){this.indexV0=e,this.indexV1=r,this.indexV2=s,this.p0=n,this.p1=i,this.p2=o,this.n0=a,this.n1=c,this.v2=m,this.texCoord0=_,this.texCoord1=v,this.texCoord2=P,this.centroid=H.create(),this.computeCetroid()}computeCetroid(){this.centroid[0]=(this.p0[0]+this.p1[0]+this.p2[0])/3,this.centroid[1]=(this.p0[1]+this.p1[1]+this.p2[1])/3,this.centroid[2]=(this.p0[2]+this.p1[2]+this.p2[2])/3}getArea(){let e=H.sub(this.p2,this.p1),r=H.sub(this.p0,this.p1);return H.len(H.cross(e,r))*.5}}class Vc extends xn{constructor(e=1,r=1,s=1,n=1,i=1,o=1){super(),this.width=e,this.height=r,this.depth=s,this.widthSegments=n,this.heightSegments=i,this.depthSegments=o,n=Math.floor(n),i=Math.floor(i),o=Math.floor(o);const a=[],c=[],m=[],_=[];let v=0;P.call(this,2,1,0,-1,-1,s,r,e,o,i),P.call(this,2,1,0,1,-1,s,r,-e,o,i),P.call(this,0,2,1,1,1,e,s,r,n,o),P.call(this,0,2,1,1,-1,e,s,-r,n,o),P.call(this,0,1,2,1,-1,e,r,s,n,i),P.call(this,0,1,2,-1,-1,e,r,-s,n,i),this.createBuffersWithTangentsManually(a.length,c,m,_,new Uint16Array(a));function P(O,D,U,X,Y,Q,q,j,W,Z){const ue=Q/W,me=q/Z,ye=Q/2,ve=q/2,Ve=j/2,oe=W+1,xe=Z+1;let he=0;const Ge=H.create();for(let we=0;we<xe;we++){const Le=we*me-ve;for(let Ce=0;Ce<oe;Ce++){const Ee=Ce*ue-ye;Ge[O]=Ee*X,Ge[D]=Le*Y,Ge[U]=Ve,c.push(H.clone(Ge)),Ge[O]=0,Ge[D]=0,Ge[U]=j>0?1:-1,m.push(H.clone(Ge)),_.push(dt.create(Ce/W,1-we/Z)),he+=1}}for(let we=0;we<Z;we++)for(let Le=0;Le<W;Le++){const Ce=v+Le+oe*we,Ee=v+Le+oe*(we+1),be=v+(Le+1)+oe*(we+1),Pe=v+(Le+1)+oe*we;a.push(Ce,Ee,Pe);const He=new $r(Ce,Ee,Pe,c[Ce],c[Ee],c[Pe],m[Ce],m[Ee],m[Pe],_[Ce],_[Ee],_[Pe]);this.faces.push(He),a.push(Ee,be,Pe);const et=new $r(Ee,be,Pe,c[Ee],c[be],c[Pe],m[Ee],m[be],m[Pe],_[Ee],_[be],_[Pe]);this.faces.push(et)}v+=he}}}class G_{constructor(){this.isReflective=!0,this.metallic=.1,this.roughness=.8,this._baseColor=H.create()}get color(){return this._baseColor}set color(e){this.setColor(e[0],e[1],e[2])}setColorR(e){this._baseColor[0]=e}setColorG(e){this._baseColor[1]=e}setColorB(e){this._baseColor[2]=e}setColor(e,r,s){this._baseColor[0]=e,this._baseColor[1]=r,this._baseColor[2]=s}}const zn=class zn extends kr{constructor(e){super(),this.materialProps=new G_,this.firstIndex=0,this.baseVertex=0,this.firstInstance=0,this.instanceCount=1,this.isOpaque=!0,this.modelMaterialBindGroupEntries=[],this.uploadModelBufferToGPU=!0,this.materials=new Map,this.textures=new Map,this._worldBoundingBox=new Gc,this._sampler=vt.defaultSampler,this.geometry=e;const r=gr(te.ModelUniform);this.bufferUniformValues=Qt(r.structs.ModelUniform),this.modelBuffer=x.device.createBuffer({label:`${this.label} Model GPUBuffer`,size:this.bufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),ee.addBufferBytes(this.modelBuffer);const s=[{binding:0,resource:{buffer:this.modelBuffer}}];this.modelBindGroup=x.device.createBindGroup({layout:$.defaultModelBindGroupLayout,entries:s}),this.modelMaterialBindGroupEntries=[{binding:Js.Default,resource:this.sampler},{binding:De.Albedo,resource:Ke.dummyTexture.createView()},{binding:De.Normal,resource:Ke.dummyTexture.createView()},{binding:De.MetallicRoughness,resource:Ke.dummyTexture.createView()}],this.texturesBindGroup=x.device.createBindGroup({label:"Model Textures Bind Group",layout:$.defaultModelMaterialBindGroupLayout,entries:this.modelMaterialBindGroupEntries}),this.setTexture(Ke.dummyTexture,De.Albedo),this.setTexture(Ke.dummyTexture,De.Normal),this.setTexture(Ke.dummyTexture,De.MetallicRoughness)}get worldBoundingBox(){return H.transformMat4(this.geometry.boundingBox.min,this.modelMatrix,this._worldBoundingBox.min),H.transformMat4(this.geometry.boundingBox.max,this.modelMatrix,this._worldBoundingBox.max),this._worldBoundingBox}get boundingBox(){return this.geometry.boundingBox}set boundingBox(e){this.geometry.boundingBox=e}get sampler(){return this.getSampler()}set sampler(e){this.setSampler(e),this.modelMaterialBindGroupEntries[0].resource=e,this.updateTexturesBindGroup()}getSampler(){return this._sampler}setSampler(e){this._sampler=e}setTexture(e,r=1){this.textures.set(r,e),this.modelMaterialBindGroupEntries[r].resource=e.createView(),this.updateTexturesBindGroup()}getTexture(e){return this.textures.get(e)}get material(){return this.materials.get(x.getActiveRenderPassType())}updateTexturesBindGroup(){this.texturesBindGroup=x.device.createBindGroup({label:"Model Textures Bind Group",layout:$.defaultModelMaterialBindGroupLayout,entries:this.modelMaterialBindGroupEntries})}setMaterial(e,r){let s=r??K.Deferred;this.materials.set(s,e)}getMaterial(e){let r=e??K.Deferred;return this.materials.get(r)}updateWorldMatrix(){const e=super.updateWorldMatrix();return this.uploadModelBufferToGPU=e,e}preRender(e){x.ENABLE_DEBUG_GROUPS&&e.pushDebugGroup(`Render ${this.label}`),this.uploadModelBufferToGPU&&(this.bufferUniformValues.set({worldMatrix:this.modelMatrix,prevFrameWorldMatrix:this.prevFrameModelMatrix,normalMatrix:this.normalMatrix,isReflective:this.materialProps.isReflective?1:0,baseColor:this.materialProps.color,metallic:this.materialProps.metallic,roughness:this.materialProps.roughness}),this.uploadModelBufferToGPU=!1,x.device.queue.writeBuffer(this.modelBuffer,0,this.bufferUniformValues.arrayBuffer)),e.setIndexBuffer(this.geometry.indexBuffer,zn.INDEX_FORMAT,this.geometry.indexBufferOffsets[0]);for(let r=0;r<this.geometry.vertexBuffers.length;r++){const s=this.geometry.vertexBufferOffsets.get(this.geometry.vertexBuffers[r]);e.setVertexBuffer(r,this.geometry.vertexBuffers[r],s[0])}e.setBindGroup(Be.Model,this.modelBindGroup),e.setBindGroup(Be.PBRTextures,this.texturesBindGroup)}onRender(e){this.material.bind(),e.drawIndexed(this.geometry.indexCount,this.instanceCount,this.firstIndex,this.baseVertex,this.firstInstance)}postRender(e){x.ENABLE_DEBUG_GROUPS&&e.popDebugGroup()}render(e){this.material&&super.render(e)}};zn.INDEX_FORMAT="uint16";let Je=zn;const Hc="main",L_=`
  @group(0) @binding(0) var inTexture: texture_2d<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var<uniform> inOutTextureScaleFactor: u32;

  @compute @workgroup_size(8, 8)
  fn ${Hc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(inTexture, 0).xy;
    if (any(id.xy > texSize.xy)) {
      return;
    }

    let inColor = textureLoad(inTexture, id.xy * inOutTextureScaleFactor, 0);
    textureStore(outTexture, id.xy, inColor);
  }
`,_o="computeMipMap",jc=(t="rgba8unorm")=>`
  @group(0) @binding(0) var prevMipLevel: texture_2d<f32>;
  @group(0) @binding(1) var nextMipLevel: texture_storage_2d<${t}, write>;

  @compute @workgroup_size(8, 8)
  fn ${_o}(@builtin(global_invocation_id) id: vec3u) {
    let offset = vec2<u32>(0, 1);
    let color = (
        textureLoad(prevMipLevel, 2 * id.xy + offset.xx, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.xy, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.yx, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.yy, 0)
    ) * 0.25;
    textureStore(nextMipLevel, id.xy, color);
  }
`;function zc(t,e,r){const s=[{binding:0,resource:e[t-1]},{binding:1,resource:e[t]}];return x.device.createBindGroup({label:"Mip Generator Input Bind Group",layout:r,entries:s})}const es=class es extends Nt{static copyTextureView(e,r,s,n,i,o,a={viewDimension:"2d",sampleType:"unfilterable-float"},c={access:"write-only",format:"rgba16float",viewDimension:"2d"}){const m=x.device.createBuffer({label:"Copy Texture View Compute Tex Scale Factor Buffer",size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0});ee.addBufferBytes(m);const _=n/i;new Uint32Array(m.getMappedRange()).set(new Uint32Array([_])),m.unmap();const v=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:a},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:c},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{}}],P=x.device.createBindGroupLayout({label:"Copy Texture View Compute Bind Group Layout",entries:v}),O=[{binding:0,resource:r},{binding:1,resource:s},{binding:2,resource:{buffer:m}}],D=x.device.createBindGroup({layout:P,entries:O}),U=x.device.createPipelineLayout({label:"Copy Texture View Compute PSO Layout",bindGroupLayouts:[P]}),X=$.createComputePipeline({label:"Copy Texture View Compute PSO",layout:U,compute:{module:$.createShaderModule(L_),entryPoint:Hc}});e.setPipeline(X),e.setBindGroup(0,D),e.dispatchWorkgroups(Math.ceil(i/8),Math.ceil(o/8),1)}};es.generateMipsForCubeTexture=e=>{if(e.depthOrArrayLayers!=6){console.error("Need a cube texture");return}const r=hr(e.width,e.height),s={baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1,dimension:"2d",format:e.format},n=[],i=[];for(let v=0;v<6;v++){const P=[],O=[dt.create(e.width,e.height)];for(let D=0;D<r;D++){let U=`MIP Level ${D}`;if(s.label=U,s.baseArrayLayer=v,s.baseMipLevel=D,P.push(e.createView(s)),D>0){const X=O[D-1],Y=dt.divScalar(X,2);O.push(Y)}}n.push(P),i.push(O)}const o=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:e.format,viewDimension:"2d"}}],a=x.device.createBindGroupLayout({label:"Mip Generator CubeTexture Input Bind Group Layout",entries:o}),c=$.createComputePipeline({label:"Compute Mip ComputePSO",layout:x.device.createPipelineLayout({label:"Compute Mip ComputePSO CubeTexture Layout",bindGroupLayouts:[a]}),compute:{entryPoint:_o,module:$.createShaderModule(jc(e.format))}}),m=x.device.createCommandEncoder({label:"Mip Generate Command Encoder}"}),_=m.beginComputePass();_.setPipeline(c);for(let v=0;v<6;v++){const P=i[v],O=n[v];for(let D=1;D<P.length;D++){const U=P[D][0],X=P[D][1],Y=8,Q=(U+Y-1)/Y,q=(X+Y-1)/Y,j=zc(D,O,a);_.setBindGroup(0,j),_.dispatchWorkgroups(Q,q,1)}}_.end(),x.device.queue.submit([m.finish()])},es.generateMipsFor2DTextureWithRenderPSO=()=>{},es.generateMipsFor2DTextureWithComputePSO=(e,r="Mipmapped 2D Texture")=>{const s=hr(e.width,e.height),n={aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1,dimension:"2d",format:e.format},i=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:e.format,viewDimension:"2d"}}],o=x.device.createBindGroupLayout({label:"Mip Generator Input Bind Group Layout",entries:i}),a=$.createComputePipeline({label:"Compute Mip ComputePSO",layout:x.device.createPipelineLayout({label:"Compute Mip ComputePSO Layout",bindGroupLayouts:[o]}),compute:{entryPoint:_o,module:$.createShaderModule(jc())}}),c=[],m=[dt.create(e.width,e.height)];for(let P=0;P<s;P++){let O=`MIP Level ${P}`;if(n.label=O,n.baseMipLevel=P,c.push(e.createView(n)),P>0){const D=m[P-1],U=dt.divScalar(D,2);m.push(U)}}const _=x.device.createCommandEncoder({label:`Mip Generate Command Encoder for ${r}`}),v=_.beginComputePass();v.setPipeline(a);for(let P=1;P<m.length;P++){const O=m[P][0],D=m[P][1],U=8,X=(O+U-1)/U,Y=(D+U-1)/U,Q=zc(P,c,o);v.setBindGroup(0,Q),v.dispatchWorkgroups(X,Y,1)}v.end(),x.device.queue.submit([_.finish()])},es.createHDRTexture=(e,r=GPUTextureUsage.TEXTURE_BINDING,s="HDR Texture")=>{const n=x.device.createTexture({label:s,format:"rgba16float",size:{width:e.width,height:e.height,depthOrArrayLayers:1},usage:r});return x.device.queue.writeTexture({texture:n,mipLevel:0},e.rgbaHalfFloat,{offset:0,bytesPerRow:e.width*Uint16Array.BYTES_PER_ELEMENT*4},{width:e.width,height:e.height,depthOrArrayLayers:1}),n};let Cr=es,O_=0;const Ps=class Ps extends Nt{static createEmptyCubeTexture(e,r=`Cube Texture ${O_++}`,s=!1,n="rgba16float",i=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST){const o={label:r,dimension:"2d",size:{width:e,height:e,depthOrArrayLayers:6},usage:i,format:n};return s&&(o.mipLevelCount=hr(e,e)),x.device.createTexture(o)}};Ps.cubeTextureFromIndividualHDRTextures=(e,r="Environment Cube Texture From Individual HDR Textures",s=512,n=!1)=>{const i=Ps.createEmptyCubeTexture(s,r,n),o=x.device.createCommandEncoder();x.ENABLE_DEBUG_GROUPS&&o.pushDebugGroup("Texture View Copy");const a=o.beginComputePass();let c=s;for(let m=0;m<6;m++)Cr.copyTextureView(a,e[m].createView({}),i.createView({baseArrayLayer:m,arrayLayerCount:1,baseMipLevel:0,mipLevelCount:1,dimension:"2d"}),s,c,c);return a.end(),x.ENABLE_DEBUG_GROUPS&&o.popDebugGroup(),x.device.queue.submit([o.finish()]),n&&Cr.generateMipsForCubeTexture(i),i},Ps.cubeTextureFromHDR=(e,r=512)=>{const s=x.device.createTexture({label:"Environment Cube Texture",dimension:"2d",size:{width:r,height:r,depthOrArrayLayers:6},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING,format:"rgba8unorm"}),n=new vi(Math.PI*.5,1,.1,10);n.updateProjectionMatrix();const i=x.device.createBuffer({label:"HDR -> CubeMap Camera ProjView Matrix Buffer",size:16*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM});ee.addBufferBytes(i);const o=[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,texture:{sampleType:"unfilterable-float"},visibility:GPUShaderStage.FRAGMENT},{binding:2,sampler:{type:"non-filtering"},visibility:GPUShaderStage.FRAGMENT}],a=x.device.createBindGroupLayout({label:"Environment Probe Camera Bind Group Layout",entries:o}),c=[{binding:0,resource:{buffer:i}},{binding:1,resource:e.createView()},{binding:2,resource:vt.createSampler({})}],m=x.device.createBindGroup({label:"Environment Probe Camera Bind Group",layout:a,entries:c}),_=x.device.createCommandEncoder({label:"HDR Environment to Cube Map Command Encoder"}),v=[{loadOp:"load",storeOp:"store",view:null}],P=[{format:"rgba8unorm"}],O=$.createRenderPipeline({label:"HDR To CubeMap Render PSO",layout:x.device.createPipelineLayout({bindGroupLayouts:[a]}),vertex:{module:$.createShaderModule(Nc),entryPoint:Uc,buffers:ze.defaultLayout},fragment:{module:$.createShaderModule(Nc),entryPoint:kc,targets:P},primitive:{cullMode:"none"}}),D=new Vc;for(let U=0;U<6;U++){v[0].view=s.createView({dimension:"2d",baseArrayLayer:U,arrayLayerCount:1});const X=H.add(n.position,gd[U]),Y=ae.lookAt(n.position,X,yd[U]),Q=ae.mul(n.projectionMatrix,Y);x.device.queue.writeBuffer(i,0,Q);const q={label:`Draw Face ${U} Render Pass`,colorAttachments:v},j=_.beginRenderPass(q);j.setPipeline(O),j.setBindGroup(0,m),j.setIndexBuffer(D.indexBuffer,Je.INDEX_FORMAT),j.setVertexBuffer(0,D.vertexBuffer),j.drawIndexed(D.indexCount),j.end()}return x.device.queue.submit([_.finish()]),s};let ws=Ps;const D_=new Uint8Array([0,32,8,40,2,34,10,42,48,16,56,24,50,18,58,26,12,44,4,36,14,46,6,38,60,28,52,20,62,30,54,22,3,35,11,43,1,33,9,41,51,19,59,27,49,17,57,25,15,47,7,39,13,45,5,37,63,31,55,23,61,29,53,21]),Jc=new Uint8Array([255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255]);let Tn,vs,Sn;const Kc=new Float32Array(1),I_=new Int32Array(Kc.buffer);function En(t){Kc[0]=t;const e=I_[0];let r=e>>16&32768,s=e>>12&2047,n=e>>23&255;return n<103?r:n>142?(r|=31744,r|=(n==255?0:1)&&e&8388607,r):n<113?(s|=2048,r|=(s>>114-n)+(s>>113-n&1),r):(r|=n-112<<10|s>>1,r+=s&1,r)}const ir=class ir extends Nt{static get dummyTexture(){return Tn||(Tn=x.device.createTexture({label:"Default Dummy 8x8 Texture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:1},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),x.device.queue.writeTexture({texture:Tn,mipLevel:0},Jc,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:1}),Tn)}static get dummyCubeTexture(){if(vs)return vs;vs=x.device.createTexture({label:"Default Dummy 8x8 Cube Texture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:6},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});for(let e=0;e<6;e++)x.device.queue.writeTexture({texture:vs,mipLevel:0,origin:{x:0,y:0,z:e}},Jc,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:0});return vs}static get bayerDitherPatternTexture(){return Sn||(Sn=x.device.createTexture({label:"Bayer ordered dithered GPUTexture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:1},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),x.device.queue.writeTexture({texture:Sn,mipLevel:0},D_,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:1}),Sn)}};ir.loadHDRImage=async e=>{const r=await R_.load(e),s=r.width*r.height,n={width:r.width,height:r.height,rgbaHalfFloat:new Uint16Array(r.width*r.height*4)};for(let i=0;i<s;i++){let o=r.rgbFloat[i*3+0],a=r.rgbFloat[i*3+1],c=r.rgbFloat[i*3+2];n.rgbaHalfFloat[i*4+0]=En(o),n.rgbaHalfFloat[i*4+1]=En(a),n.rgbaHalfFloat[i*4+2]=En(c),n.rgbaHalfFloat[i*4+3]=En(1)}return n},ir.loadHDRTexture=async(e,r=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC,s=`HDR Texture ${e}`)=>{const n=await ir.loadHDRImage(e),i=await Cr.createHDRTexture(n,r,s);return ee.addTextureBytes(i),i},ir.load6SeparateHDRFacesAsCubeMapTexture=async(e,r,s,n=null)=>{if(e.length!==6){console.error("Need 6 separate urls for 6 separate environment textures");return}const i=await Promise.all(e.map(a=>ir.loadHDRTexture(a))),o=ws.cubeTextureFromIndividualHDRTextures(i,n,r,s);return ee.addTextureBytes(o),o},ir.loadTextureFromData=async(e,r="rgba8unorm",s=!0,n=!1,i=!1,o="Bitmap Texture")=>{const a=new Blob([e],{type:"image/png"}),c=await createImageBitmap(a,{colorSpaceConversion:"none"});let m=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT;s&&(m|=GPUTextureUsage.STORAGE_BINDING);const _={label:o,dimension:"2d",size:{width:c.width,height:c.height,depthOrArrayLayers:1},format:r,usage:m};s&&(_.mipLevelCount=hr(c.width,c.height));const v=x.device.createTexture(_);if(x.device.queue.copyExternalImageToTexture({source:c,flipY:n},{texture:v},{width:c.width,height:c.height}),!s)return ee.addTextureBytes(v),v;Cr.generateMipsFor2DTextureWithComputePSO(v),ee.addTextureBytes(v);const P=document.createElement("canvas"),O=P.getContext("2d");return P.width=v.width/2,P.height=v.height/2,O.drawImage(c,0,0),i&&(P.style.setProperty("position","fixed"),P.style.setProperty("z-index","99"),P.style.setProperty("left","2rem"),P.style.setProperty("bottom","2rem"),P.style.setProperty("width",`${v.width*.1}px`),P.style.setProperty("height",`${v.height*.1}px`),P.dataset.debugLabel=`${o.toLowerCase()}`,document.body.appendChild(P)),c.close(),v};let Ke=ir;const F_=34963,U_=34962,k_="5823059166183034438";class N_ extends kr{constructor(e){super(),this.url=e,this.nodeMaterialIds=new Map([]),this.gpuSamplers=new Map,this.gpuTextures=new Map,this.gpuBuffers=new Map,this.updateWorldMatrix()}setMaterial(e,r=K.Deferred){return this.traverse(s=>{s instanceof Je&&s.setMaterial(e,r)}),this}setIsReflective(e){return this.traverse(r=>{r instanceof Je&&(r.materialProps.isReflective=e)}),this}setTextureForAll(e,r=1){return this.traverse(s=>{s instanceof Je&&s.setTexture(e,r)}),this}setSampler(e){return this.traverse(r=>{r instanceof Je&&r.setSampler(e)}),this}setTextureFor(e,r,s=1){const n=this.findChildByLabel(e);if(!(n instanceof Je)){console.error("Found child is not instance of a Drawable");return}return n.setTexture(r,s),this}async load(){const e=[],r=Pp(this.url,ho);e.push(r);const s=__(await r),n=this.initGPUTexturesFrom(s.textures);return e.push(n),this.initGPUSamplersFrom(s.samplers),this.initGPUBuffersFrom(s.bufferViews),this.initMaterialsFrom(s.materials),this.initNodesFrom(s),Promise.all(e)}async initMaterialsFrom(e){for(const r of e){if(r.pbrMetallicRoughness&&r.pbrMetallicRoughness.baseColorTexture){const s=await this.gpuTextures.get(r.pbrMetallicRoughness.baseColorTexture.texture.id),n=this.nodeMaterialIds.get(r.id);for(const i of n)i.setTexture(s,De.Albedo);if(r.pbrMetallicRoughness.metallicRoughnessTexture){const i=await this.gpuTextures.get(r.pbrMetallicRoughness.metallicRoughnessTexture.texture.id),o=this.nodeMaterialIds.get(r.id);for(const a of o)a.setTexture(i,De.MetallicRoughness)}}if(r.normalTexture){const s=await this.gpuTextures.get(r.normalTexture.texture.id),n=this.nodeMaterialIds.get(r.id);for(const i of n)i.setTexture(s,De.Normal)}}}async initGPUTexturesFrom(e){const r=[];for(const s of e){const n=Ke.loadTextureFromData(s.source.bufferView.data,"rgba8unorm",!0,!1,!1,`GLTF Texture: ${s.id}`);r.push(n),this.gpuTextures.set(s.id,n)}return Promise.all(r)}initGPUSamplersFrom(e){for(const r of e){const s=vt.getSamplerFromGltfSamplerDef(r);this.gpuSamplers.set(r.id,s)}}initGPUBuffersFrom(e){for(let r of e){let s=0;r.target===F_&&(s|=GPUBufferUsage.INDEX),r.target===U_&&(s|=GPUBufferUsage.VERTEX);const n=Math.ceil(r.byteLength/4)*4,i=x.device.createBuffer({label:r.id,mappedAtCreation:!0,size:n,usage:s});ee.addBufferBytes(i),new Uint8Array(i.getMappedRange()).set(new Uint8Array(r.buffer.arrayBuffer,r.byteOffset,r.byteLength)),i.unmap(),this.gpuBuffers.set(r.id,i)}}initNodesFrom(e){var r,s,n,i;for(const o of e.nodes)if(o.mesh)for(const a of o.mesh.primitives){const c=new b_(a,this.gpuBuffers),m=new Je(c),_=H.create(),v=H.create(1,1,1),P=ks.identity(),O=this.nodeMaterialIds.get(a.material.id)||[];O.push(m),this.nodeMaterialIds.set(a.material.id,O),a.material.pbrMetallicRoughness.baseColorTexture&&a.material.pbrMetallicRoughness.baseColorTexture.texture.source.uri.includes(k_)?m.materialProps.isReflective=!0:m.materialProps.isReflective=!1,m.label=o.name??o.id;const D=(s=(r=a.attributes)==null?void 0:r.POSITION)==null?void 0:s.min;D&&m.boundingBox.setMinAABBfromGLTF(D);const U=(i=(n=a.attributes)==null?void 0:n.POSITION)==null?void 0:i.max;U&&m.boundingBox.setMaxAABBfromGLTF(U),o.translation&&H.set(o.translation[0],o.translation[1],o.translation[2],_),o.scale&&H.set(o.scale[0],o.scale[1],o.scale[2],v),o.rotation&&ks.set(o.rotation[0],o.rotation[1],o.rotation[2],o.rotation[3],P),m.setCustomMatrixFromTRS(_,P,v),m.sampler=this.gpuSamplers.get("sampler-0"),this.addChild(m)}}}const Xc="vertexMain",Wc="fragmentMain",V_=`
  ${te.Camera}

  @group(${Be.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;

  @group(1) @binding(0) var<storage, read> linePointPositions: array<vec4f>;

  @vertex
  fn ${Xc}(
    @builtin(vertex_index) vertexId: u32,
  ) -> @builtin(position) vec4f {
    let position = linePointPositions[vertexId];
    return camera.projectionViewMatrix * position;
  }

  @fragment
  fn ${Wc}() -> @location(0) vec4f {
    return vec4f(vec3f(1), 1);
  }
`;class H_ extends kr{constructor(e){super(),this.points=e,this.pointsGPUBuffer=x.device.createBuffer({label:"Line Points GPU Buffer",size:4*e.length*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0}),ee.addBufferBytes(this.pointsGPUBuffer);const r=new Float32Array(this.pointsGPUBuffer.getMappedRange());for(let c=0;c<e.length;c++)r[c*4+0]=e[c][0],r[c*4+1]=e[c][1],r[c*4+2]=e[c][2],r[c*4+3]=1;this.pointsGPUBuffer.unmap();const s=[{binding:0,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX}],n=x.device.createBindGroupLayout({label:"ParticlesMoveCurve Debug Bind Group Layout",entries:s}),i=[{binding:0,resource:{buffer:this.pointsGPUBuffer}}];this.bindGroup=x.device.createBindGroup({label:"ParticlesMoveCurve Debug Bind Group",layout:n,entries:i});const o=$.createShaderModule(V_,"ParticlesMoveCurve Debug Shader Module"),a=[{format:"rgba16float"}];this.renderPSO=$.createRenderPipeline({label:"ParticlesMoveCurve Debug Render PSO",layout:x.device.createPipelineLayout({label:"ParticlesMoveCurve Debug Render PSO Layout",bindGroupLayouts:[$.defaultCameraPlusLightsBindGroupLayout,n]}),vertex:{entryPoint:Xc,module:o},fragment:{entryPoint:Wc,module:o,targets:a},depthStencil:{format:x.depthStencilFormat,depthCompare:"less",depthWriteEnabled:!0},primitive:{topology:"line-strip"}})}render(e){this.visible&&(x.ENABLE_DEBUG_GROUPS&&e.pushDebugGroup(`Render Debug Line: ${this.label}`),e.setPipeline(this.renderPSO),e.setBindGroup(1,this.bindGroup),e.draw(this.points.length),x.ENABLE_DEBUG_GROUPS&&e.popDebugGroup())}}class j_ extends kr{constructor(){super(...arguments),this.debugMeshes=[],this.opaqueMeshes=[],this.transparentMeshes=[],this.culledOpaqueMeshes=[],this.culledTransparentMeshes=[],this.nonCulledTransparentCount=0,this.nonCulledOpaqueCount=0,this.onGraphChangedCallbacks=[]}get nodesCount(){return this.opaqueMeshes.length+this.transparentMeshes.length}get visibleNodesCount(){return this.nonCulledOpaqueCount+this.nonCulledTransparentCount}addOnGraphChangedCallback(e){this.onGraphChangedCallbacks.push(e)}renderDebugMeshes(e){for(const r of this.debugMeshes)r.render(e)}renderOpaqueNodes(e,r){if(!r){for(const n of this.opaqueMeshes)n.render(e);return}const s=r.cullMeshes(this.opaqueMeshes,this.culledOpaqueMeshes);this.nonCulledOpaqueCount=s;for(let n=0;n<s;n++)this.culledOpaqueMeshes[n].render(e)}renderTransparentNodes(e,r){if(!r){for(const n of this.transparentMeshes)n.render(e);return}const s=r.cullMeshes(this.transparentMeshes,this.culledTransparentMeshes);this.nonCulledTransparentCount=s;for(let n=0;n<s;n++)this.culledTransparentMeshes[n].render(e)}sortTransparentNodesFrom(e){this.transparentMeshes.sort((r,s)=>{const n=r.worldBoundingBox.boundingBoxCenter,i=s.worldBoundingBox.boundingBoxCenter,o=r.worldPosition[0]!==0?r.worldPosition[0]:n[0],a=r.worldPosition[1]!==0?r.worldPosition[1]:n[0],c=r.worldPosition[2]!==0?r.worldPosition[2]:n[0],m=s.worldPosition[0]!==0?s.worldPosition[0]:i[0],_=s.worldPosition[1]!==0?s.worldPosition[1]:i[0],v=s.worldPosition[2]!==0?s.worldPosition[2]:i[0],P=e.position[0]-o,O=e.position[1]-a,D=e.position[2]-c,U=e.position[0]-m,X=e.position[1]-_,Y=e.position[2]-v,Q=P*O*D;return U*X*Y-Q})}onChildAdd(e){e instanceof Je&&(e.isOpaque?(this.opaqueMeshes.push(e),this.culledOpaqueMeshes.push(e)):(this.transparentMeshes.push(e),this.culledTransparentMeshes.push(e))),e instanceof H_&&this.debugMeshes.push(e);for(const r of this.onGraphChangedCallbacks)r()}onChildRemove(e){super.onChildRemove(e);const r=({id:s})=>s!==e.id;e instanceof Je&&(e.isOpaque?(this.opaqueMeshes=this.opaqueMeshes.filter(r),this.culledOpaqueMeshes=this.culledOpaqueMeshes.filter(r)):(this.transparentMeshes=this.transparentMeshes.filter(r),this.culledTransparentMeshes=this.culledTransparentMeshes.filter(r)));for(const s of this.onGraphChangedCallbacks)s()}}const Yc=`
  // Van Der Corpus sequence
  // @see http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html
  fn vdcSequence(inBits: u32) -> f32 {
    var bits = inBits;
    bits = (bits << 16u) | (bits >> 16u);
    bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
    bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
    bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
    bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
    return f32(bits) * 2.3283064365386963e-10; // / 0x100000000
  }

  // Hammersley sequence
  // @see http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html
  fn hammersley(i: u32, N: u32) -> vec2f {
    return vec2f(f32(i) / f32(N), vdcSequence(i));
  }

  // Based on Karis 2014
  // GGX NDF via importance sampling
  fn importanceSampleGGX(Xi: vec2f, N: vec3f, roughness: f32) -> vec3f {
    let alpha = roughness * roughness;
    let alpha2 = alpha * alpha;

    let phi = TWO_PI * Xi.x;
    let cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (alpha2 - 1.0) * Xi.y));
    let sinTheta = sqrt(1.0 - cosTheta * cosTheta);

    // from spherical coordinates to cartesian coordinates
    let H = vec3f(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);

    // from tangent-space vector to world-space sample vector
    
    let up = select(WORLD_UP, WORLD_FORWARD, abs(N.z) < 0.999);
    let tangent = normalize(cross(up, N));
    let bitangent = cross(N, tangent);

    return tangent * H.x + bitangent * H.y + N * H.z;
  }

  fn GTR2(NdotH: f32, a: f32) -> f32 {
    let a2 = a * a;
    let t = 1.0 + (a2 - 1.0) * NdotH * NdotH;
    return step(0.0, NdotH) * a2 / (PI * t * t);
  }

  fn distributionGGX(NdotH: f32, roughness: f32) -> f32 {
    return GTR2(NdotH, roughness * roughness);
  }

  fn visibilitySmithGGXCorrelated(NdotV: f32, NdotL: f32, roughness: f32) -> f32 {
    let a2 = roughness * roughness;
    let oneMinusA2 = 1.0 - a2;
    let ggxv = NdotL * sqrt(NdotV * NdotV * oneMinusA2 + a2);
    let ggxl = NdotV * sqrt(NdotL * NdotL * oneMinusA2 + a2);
  
    let ggx = ggxv + ggxl;
    if (ggx > 0.0) {
        return 0.5 / ggx;
    }
    return 0.0;
  }
`,$c="main",z_=`
  ${te.CommonHelpers}

  @group(0) @binding(0) var outTexture: texture_storage_2d<rgba16float, write>;

  const SAMPLE_COUNT = 1024u;

  ${Yc}

  // https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf
  // Karis 2014
  @must_use
  fn integrate(NdotV: f32, roughness: f32) -> vec2f {
    var V = vec3f(0.0);
    V.x = sqrt(1.0 - NdotV * NdotV); // sin
    V.y = 0.0;
    V.z = NdotV; // cos

    // N points straight upwards for this integration
    let N = vec3f(0.0, 0.0, 1.0);

    var A = 0.0;
    var B = 0.0;

    for (var i = 0u; i < SAMPLE_COUNT; i++) {
      let Xi = hammersley(i, SAMPLE_COUNT);
      let H = importanceSampleGGX(Xi, N, roughness);
      let L = 2.0 * dot(V, H) * H - V;

      let NdotL = saturate(L.z);
      let NdotH = saturate(H.z);
      let VdotH = saturate(dot(V, H));
      
      if (NdotL > 0.0) {
        let V_pdf = visibilitySmithGGXCorrelated(NdotV, NdotL, roughness) * VdotH * NdotL / NdotH;
        let Fc = pow(1.0 - VdotH, 5.0);
        A += (1.0 - Fc) * V_pdf;
        B += Fc * V_pdf;
      }
    }

    return 4.0 * vec2f(A, B) / f32(SAMPLE_COUNT);
  }

  @compute @workgroup_size(8, 8)
  fn ${$c}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy) - 1.0;
    let uv = vec2f(id.xy) / size;

    let result = vec4f(integrate(uv.x, uv.y), 0, 0);
    textureStore(outTexture, id.xy, result);
  }
`;let Mn;const Qc=[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}}],Jn=class Jn extends Nt{static get computePSO(){if(Mn)return Mn;const e=x.device.createBindGroupLayout({label:"BDRF Lut Compute PSO Bind Group Layout",entries:Qc});return Mn=x.device.createComputePipeline({label:"BDRF LUT Generate Compute PSO",compute:{module:$.createShaderModule(z_),entryPoint:$c},layout:x.device.createPipelineLayout({label:"BDRF LUT Generation Compute PSO Layout",bindGroupLayouts:[e]})}),Mn}};Jn.encode=(e=512)=>{const r=x.device.createTexture({label:"BDRF LUT Texture",size:{width:e,height:e,depthOrArrayLayers:1},format:"rgba16float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST,mipLevelCount:1}),s=x.device.createCommandEncoder({label:"BDRF LUT Generate Command Encoder"});x.ENABLE_DEBUG_GROUPS&&s.pushDebugGroup("BDRF LUT Generation");const n=s.beginComputePass({label:"BDRF LUT Generate Compute Pass"}),i=x.device.createBindGroupLayout({label:"BDRF Lut Compute PSO Bind Group Layout",entries:Qc}),o=[{binding:0,resource:r.createView()}],a=x.device.createBindGroup({label:"BDRF LUT Generate Input Bind Group",layout:i,entries:o}),c=8,m=(e+c-1)/c,_=(e+c-1)/c;return n.setPipeline(Jn.computePSO),n.setBindGroup(0,a),n.dispatchWorkgroups(m,_,1),n.end(),x.ENABLE_DEBUG_GROUPS&&s.popDebugGroup(),x.device.queue.submit([s.finish()]),ee.addTextureBytes(r),r};let bo=Jn;const qc="main",J_=`
  ${te.CommonHelpers}
  ${te.MathHelpers}

  @group(0) @binding(0) var inTexture: texture_cube<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var cubeSampler: sampler;
  @group(0) @binding(3) var<uniform> face: u32;

  @compute @workgroup_size(8, 8)
  fn ${qc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy);
    let uv = vec2f(id.xy) / size;
    
    var ruv = 2.0 * uv - 1.0;
    ruv.y = ruv.y * -1;
    
    var irradiance = vec3f(0.0);
    let rotation = CUBE_ROTATIONS[face];
    let N = normalize(vec3f(ruv, 1.0) * rotateAxisAngle(rotation.xyz, rotation.w));
    var UP = select(WORLD_UP, WORLD_FORWARD, abs(N.z) < 0.999);
    let RIGHT = normalize(cross(UP, N));
    UP = cross(RIGHT, N);

    var sampleCount = 0u;

    for (var phi: f32 = 0.0; phi < TWO_PI; phi += DELTA_PHI) {
      let sinPhi = sin(phi);
      let cosPhi = cos(phi);
      for (var theta: f32 = 0.0; theta < HALF_PI; theta += DELTA_THETA) {
        let sinTheta = sin(theta);
        let cosTheta = cos(theta);

        let tempVec = cosPhi * RIGHT + sinPhi * UP;
        let sampleVector = cosTheta * N + sinTheta * tempVec;

        irradiance += textureSampleLevel(inTexture, cubeSampler, sampleVector, 2).rgb * cos(theta) * sin(theta);
        sampleCount++;
      }
    }
    
    irradiance = PI * irradiance / f32(sampleCount);
    textureStore(outTexture, id.xy, vec4f(irradiance, 1.0));
  }
`;let Pn;const Zc=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{},visibility:GPUShaderStage.COMPUTE}],Kn=class Kn extends Nt{static get computePSO(){if(Pn)return Pn;const e=x.device.createBindGroupLayout({label:"Diffuse IBL Compute PSO Bind Group Layout",entries:Zc});return Pn=$.createComputePipeline({label:"Diffuse IBL Compute PSO",compute:{module:$.createShaderModule(J_),entryPoint:qc},layout:x.device.createPipelineLayout({label:"Diffuse IBL Compute PSO Layout",bindGroupLayouts:[e]})}),Pn}};Kn.encode=(e,r=32)=>{if(e.depthOrArrayLayers!==6){console.error("Need cube texture as a source for IBL Diffuse");return}if(e.format!=="rgba16float"){console.error("Only rgba16float cube textures supported for Diffuse IBL for now");return}const s=ws.createEmptyCubeTexture(r,"Diffuse IBL Texture",!0),n=x.device.createBindGroupLayout({label:"Diffuse IBL Compute PSO Bind Group Layout",entries:Zc}),i=[{binding:0,resource:null},{binding:1,resource:null},{binding:2,resource:vt.createSampler({addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"})},{binding:3,resource:{buffer:null}}],o=x.device.createCommandEncoder({label:"Diffuse IBL Command Encoder"}),a=o.beginComputePass({label:"Diffuse IBL Compute Pass"});x.ENABLE_DEBUG_GROUPS&&a.pushDebugGroup("Begin Diffuse IBL"),a.setPipeline(Kn.computePSO);const c=e.createView({dimension:"cube"});for(let m=0;m<6;m++){let _=x.device.createBuffer({label:"Diffuse IBL Face GPUBuffer",size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0});ee.addBufferBytes(_),new Uint32Array(_.getMappedRange()).set(new Uint32Array([m])),_.unmap();const v=s.createView({format:s.format,dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:m,arrayLayerCount:1});i[0].resource=c,i[1].resource=v,i[3].resource={buffer:_};const P=x.device.createBindGroup({layout:n,entries:i}),O=8,D=(s.width+O-1)/O,U=(s.height+O-1)/O;a.setBindGroup(0,P),a.dispatchWorkgroups(D,U,1)}return x.ENABLE_DEBUG_GROUPS&&a.popDebugGroup(),a.end(),x.device.queue.submit([o.finish()]),ee.addTextureBytes(s),s};let xo=Kn;const el="main",K_=`
  ${te.CommonHelpers}
  ${te.MathHelpers}

  @group(0) @binding(0) var inTexture: texture_cube<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var cubeSampler: sampler;
  @group(0) @binding(3) var<uniform> face: u32;
  @group(0) @binding(4) var<uniform> roughness: f32;

  const SAMPLE_COUNT: u32 = 1024;

  ${Yc}

  @compute @workgroup_size(8, 8)
  fn ${el}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy);
    let uv = vec2f(id.xy) / size;
    
    var ruv = 2.0 * uv - 1.0;
    ruv.y = ruv.y * -1;

    let rotation = CUBE_ROTATIONS[face];
    let N = normalize(vec3f(ruv, 1.0) * rotateAxisAngle(rotation.xyz, rotation.w));

    let R = N;
    let V = R;

    var prefilteredColor = vec3f(0.0);
    var totalWeight = 0.0;

    for (var i = 0u; i < SAMPLE_COUNT; i++) {
      // generates a sample vector that's biased towards the preferred alignment direction (importance sampling).
      let Xi = hammersley(i, SAMPLE_COUNT);
      let H = importanceSampleGGX(Xi, N, roughness);
      let L = normalize(2.0 * dot(V, H) * H - V);

      let NdotL = max(dot(N, L), 0.0);

      if (NdotL > 0.0) {
        // sample from the environment's mip level based on roughness/pdf

        let NdotH = max(dot(N, H), 0.0);
        let HdotV = max(dot(H, V), 0.0);
        let D = distributionGGX(NdotH, roughness);
        let pdf = max((D * NdotH / (4.0 * HdotV)) + 0.0001, 0.0001);

        let resolution = f32(textureDimensions(inTexture).x); // resolution of source cubemap (per face)
        let saTexel = 4.0 * PI / (6.0 * resolution * resolution);
        let saSample = 1.0 / (f32(SAMPLE_COUNT) * pdf + 0.0001);

        let mipLevel = select(0.5 * log2(saSample / saTexel), 0.0, roughness == 0.0);

        prefilteredColor += textureSampleLevel(inTexture, cubeSampler, L, mipLevel).rgb * NdotL;
        totalWeight += NdotL;
      }
    }

    prefilteredColor = prefilteredColor / totalWeight;
    textureStore(outTexture, id.xy, vec4f(prefilteredColor, 1.0));
  }
`;let Rn;const tl=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:4,buffer:{},visibility:GPUShaderStage.COMPUTE}],Xn=class Xn extends Nt{static get computePSO(){if(Rn)return Rn;const e=x.device.createBindGroupLayout({label:"Specular IBL Compute PSO Bind Group Layout",entries:tl});return Rn=$.createComputePipeline({label:"Specular IBL Compute PSO",compute:{module:$.createShaderModule(K_),entryPoint:el},layout:x.device.createPipelineLayout({label:"Specular IBL Compute PSO",bindGroupLayouts:[e]})}),Rn}};Xn.encode=(e,r=128)=>{if(e.depthOrArrayLayers!==6){console.error("Need cube texture as a source of IBL Specular");return}if(e.format!=="rgba16float"){console.error("Only rgba16float cube textures supported for Specular IBL for now");return}const s=ws.createEmptyCubeTexture(r,"Specular IBL Texture",!0),n=e.createView({dimension:"cube"});let i=s.mipLevelCount;const o=[{binding:0,resource:n},{binding:1,resource:null},{binding:2,resource:vt.createSampler({minFilter:"linear",magFilter:"linear"})},{binding:3,resource:{buffer:null}},{binding:4,resource:{buffer:null}}];let a=x.device.createCommandEncoder({label:"Specular IBL Command Encoder"});x.ENABLE_DEBUG_GROUPS&&a.pushDebugGroup("Begin Specular IBL Generation");let c=a.beginComputePass({label:"Specular IBL Compute Pass"});c.setPipeline(Xn.computePSO);const m=x.device.createBindGroupLayout({label:"Specular IBL Compute PSO Bind Group Layout",entries:tl});let _=r;for(let v=0;v<i;v++){const P=v/(i-1),O=x.device.createBuffer({label:"Roughness Buffer",mappedAtCreation:!0,size:Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});ee.addBufferBytes(O),new Float32Array(O.getMappedRange()).set(new Float32Array([P])),O.unmap(),o[4].resource={buffer:O};for(let D=0;D<6;D++){const U=x.device.createBuffer({label:"Face Buffer",mappedAtCreation:!0,size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});ee.addBufferBytes(U),new Uint32Array(U.getMappedRange()).set(new Uint32Array([D])),U.unmap(),o[1].resource=s.createView({format:s.format,dimension:"2d",baseMipLevel:v,mipLevelCount:1,baseArrayLayer:D,arrayLayerCount:1}),o[3].resource={buffer:U};const X=x.device.createBindGroup({layout:m,entries:o}),Y=8,Q=(_+Y-1)/Y,q=(_+Y-1)/Y;c.setBindGroup(0,X),c.dispatchWorkgroups(Q,q,1)}_/=2}return c.end(),x.ENABLE_DEBUG_GROUPS&&a.popDebugGroup(),x.device.queue.submit([a.finish()]),ee.addTextureBytes(s),s};let Ao=Xn;var re=(t=>(t[t.Normal=0]="Normal",t[t.AO=1]="AO",t[t.Metallic=2]="Metallic",t[t.Roughness=3]="Roughness",t[t.Reflectance=4]="Reflectance",t[t.Albedo=5]="Albedo",t[t.Depth=6]="Depth",t[t.Velocity=7]="Velocity",t[t.ShadowDepthCascade0=8]="ShadowDepthCascade0",t[t.ShadowDepthCascade1=9]="ShadowDepthCascade1",t[t.BDRF=10]="BDRF",t))(re||{});const er="fullscreenVertex",Tr=`
  ${te.VertexOutput}

  const pos = array(
    vec2(-1.0, -1.0), vec2(3, -1.0), vec2(-1.0, 3),
  );
  const uv = array(
    vec2(0.0, 0.0), vec2(2.0, 0.0), vec2(0.0, 2.0)
  );

  @vertex
  fn ${er}(
    @builtin(vertex_index) vertexId: u32,
    @builtin(instance_index) instanceId: u32,
  ) -> VertexOutput {
    var out: VertexOutput;
    out.position = vec4f(pos[vertexId], 0.0, 1.0);
    out.uv = uv[vertexId];
    out.instanceId = instanceId;
    return out;
  }
`,X_=/#([^\s]*)(\s*)/gm;class rl{constructor(e){ce(this,"elseIsValid",!0);ce(this,"branches",[]);this.pushBranch("if",e)}pushBranch(e,r){if(!this.elseIsValid)throw new Error(`#${e} not preceeded by an #if or #elif`);this.elseIsValid=e==="if"||e==="elif",this.branches.push({expression:!!r,string:""})}appendStringToCurrentBranch(...e){for(const r of e)this.branches[this.branches.length-1].string+=r}resolve(){for(const e of this.branches)if(e.expression)return e.string;return""}}function tr(t,...e){const r=[];let s=new rl(!0);s.elseIsValid=!1;const n=(i,o)=>{if(i.index+i[0].length!=o.length)throw new Error(`#${i[1]} must be immediately followed by a template expression (ie: \${value})`)};for(let i=0;i<t.length;++i){const o=t[i],a=o.matchAll(X_);let c=0,m=!1;for(const _ of a){switch(s.appendStringToCurrentBranch(o.substring(c,_.index)),_[1]){case"if":n(_,o),m=!0,r.push(s),s=new rl(e[i]);break;case"elif":n(_,o),m=!0,s.pushBranch(_[1],e[i]);break;case"else":s.pushBranch(_[1],!0),s.appendStringToCurrentBranch(_[2]);break;case"endif":if(!r.length)throw new Error(`#${_[1]} not preceeded by an #if`);const v=s.resolve();s=r.pop(),s.appendStringToCurrentBranch(v,_[2]);break;default:s.appendStringToCurrentBranch(_[0]);break}c=_.index+_[0].length}c!=o.length&&s.appendStringToCurrentBranch(o.substring(c,o.length)),!m&&e.length>i&&s.appendStringToCurrentBranch(e[i])}if(r.length)throw new Error("Mismatched #if/#endif count");return s.resolve()}const Cs=`
  fn encodeNormal(n: vec3f) -> vec2f {
    // return n.xy* 0.5 + 0.5;
    let p = sqrt(n.z * 8 + 8);
    return n.xy / p + 0.5;
  }
 
  fn decodeNormal(enc: vec2f) -> vec3f {
    
    let fenc = enc * 4 - 2;
    let f = dot(fenc, fenc);
    let g = sqrt(1 - f / 4);
    
    return vec3f(
      fenc * g,
      1 - f / 2
    );
  }
`,sl="fragmentShaderDebugTexture",W_=t=>tr`
  ${te.VertexOutput}

  ${Cs}

  @group(0) @binding(0) var mySampler: sampler;

  #if ${t===re.Depth||t===re.ShadowDepthCascade0||t===re.ShadowDepthCascade1}
    @group(0) @binding(1) var myTexture: texture_depth_2d;
  #else
    @group(0) @binding(1) var myTexture: texture_2d<f32>;
  #endif

  @fragment
  fn ${sl}(in: VertexOutput) -> @location(0) vec4<f32> {
    var uv = in.uv;
    uv.y = 1.0 - uv.y;
    var color: vec4f;
    #if ${t===re.Normal}
    color = vec4f(decodeNormal(textureSample(myTexture, mySampler, uv).rg), 1.0);
    // color = vec4f(textureSample(myTexture, mySampler, uv).rgb, 1.0);
    #elif ${t===re.Metallic}
    color = vec4f(textureSample(myTexture, mySampler, uv).bbb, 1.0);
    #elif ${t===re.Roughness}
    color = vec4f(textureSample(myTexture, mySampler, uv).aaa, 1.0);
    #elif ${t===re.Reflectance}
    color = vec4f(textureSample(myTexture, mySampler, uv).a, 0.0, 0.0, 1.0);
    #elif ${t===re.Depth}
    let depth = textureSample(myTexture, mySampler, uv);

    let near: f32 = 0.1; // Example near plane
    let far: f32 = 20.0; // Example far plane

    // Linearize the depth (from clip space depth to linear depth)
    let depth_linear = near * far / (far - depth * (far - near));

    // Normalize the linear depth to [0, 1] (NDC space)
    let depth_ndc = (depth_linear - near) / (far - near);
    color = vec4f(vec3f(depth_ndc), 1);

    #elif ${t===re.ShadowDepthCascade0||t===re.ShadowDepthCascade1}
    let depth = textureSample(myTexture, mySampler, uv);

    let near: f32 = 0.1; // Example near plane
    let far: f32 = 1.0; // Example far plane

    // Linearize the depth (from clip space depth to linear depth)
    let depth_linear = near * far / (far - depth * (far - near));

    // Normalize the linear depth to [0, 1] (NDC space)
    let depth_ndc = (depth_linear - near) / (far - near);
    color = vec4f(vec3f(depth_ndc), 1);
    #elif ${t===re.Velocity}
    color = vec4f(textureSample(myTexture, mySampler, uv).rg * 100, 0, 1);
    #elif ${t===re.BDRF}
    color = vec4f(textureSample(myTexture, mySampler, in.uv).rg, 0, 1);
    #elif ${t===re.Albedo}
    color = vec4f(textureSample(myTexture, mySampler, uv).rgb, 1);
    #elif ${t===re.AO}
    color = vec4f(textureSample(myTexture, mySampler, uv).rrr, 1);
    #else
    color = textureSample(myTexture, mySampler, uv);
    #endif
    return color;
  }
`,Y_=new Map([[re.Albedo,"Albedo"],[re.Normal,"View-Space Normal"],[re.AO,"Screen-Space AO"],[re.Metallic,"Metallic"],[re.Roughness,"Roughness"],[re.Reflectance,"Reflectance"],[re.Depth,"Depth"],[re.Velocity,"Velocity"],[re.ShadowDepthCascade0,"Cascade #1"],[re.ShadowDepthCascade1,"Cascade #2"]]);class Dt{constructor(e){this.type=e,this.$rootEl=document.createElement("div"),this.$headline=document.createElement("h4"),this.$canvas=document.createElement("canvas"),this.$rootEl.classList.add("debug-canvas-wrapper"),this.$canvas.classList.add("debug-canvas"),this.$headline.innerText=Y_.get(e),this.$rootEl.appendChild(this.$headline),this.$rootEl.appendChild(this.$canvas),this.ctx=this.$canvas.getContext("webgpu"),this.ctx.configure({device:x.device,format:x.pixelFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT});const r=[{format:x.pixelFormat}];this.samplerTextureBindGroupLayoutEntries=[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:this.isDepthTexture?"depth":"float"}}],this.samplerTextureBindGroupLayout=x.device.createBindGroupLayout({label:"TextureDebugMesh Sampler + Texture GPUBindGroupLayout",entries:this.samplerTextureBindGroupLayoutEntries}),this.renderPSO=$.createRenderPipeline({label:`Debug Canvas ${e} Render PSO`,vertex:{module:$.createShaderModule(Tr),entryPoint:er},fragment:{module:$.createShaderModule(W_(this.type)),entryPoint:sl,targets:r},layout:x.device.createPipelineLayout({label:`Debug Canvas ${e} Render PSO Layout`,bindGroupLayouts:[this.samplerTextureBindGroupLayout]})});const s=[{loadOp:"load",storeOp:"store",view:null}];this.renderPassDescriptor={label:`Debug Canvas ${e} Render Pass Descriptor`,colorAttachments:s}}get isDepthTexture(){return this.type===re.Depth||this.type===re.ShadowDepthCascade0||this.type===re.ShadowDepthCascade1}appendTo(e){e.appendChild(this.$rootEl)}setTexture(e,r=e.width,s=e.height){this.debugTexture=e,this.$canvas.width=r,this.$canvas.height=s;let n=0,i="2d";this.type===re.ShadowDepthCascade0?n=0:this.type===re.ShadowDepthCascade1&&(n=1);const o=[{binding:0,resource:vt.createSampler({magFilter:"linear",minFilter:"linear"})},{binding:1,resource:e.createView({aspect:this.isDepthTexture?"depth-only":"all",baseArrayLayer:n,dimension:i})}];this.samplerTextureBindGroup=x.device.createBindGroup({layout:this.samplerTextureBindGroupLayout,entries:o})}render(e){if(!this.debugTexture)return;this.renderPassDescriptor.colorAttachments[0].view=this.ctx.getCurrentTexture().createView();const r=e.beginRenderPass(this.renderPassDescriptor);x.ENABLE_DEBUG_GROUPS&&r.pushDebugGroup(`Display Debug Texture ${this.type}`),r.setPipeline(this.renderPSO),r.setBindGroup(0,this.samplerTextureBindGroup),r.draw(3),x.ENABLE_DEBUG_GROUPS&&r.popDebugGroup(),r.end()}}var Bo=(t=>(t[t.GBuffer=0]="GBuffer",t[t.Shadow=1]="Shadow",t))(Bo||{});const $_=new Map([[0,"G-Buffer Debug"],[1,"Shadows Debug"]]);class Gn{constructor(e){this.canvases=new Map,this.$root=Gn.createRootElement(),this.$main=document.createElement("div"),this.$main.classList.add("section");const r=document.createElement("h2");r.textContent=$_.get(e),r.classList.add("section-headline"),this.$root.appendChild(r),this.$root.appendChild(this.$main)}static createRootElement(){const e=document.createElement("div");return e.classList.add("texture-debug-wrapper"),e}appendTo(e){e.appendChild(this.$root)}setTextureFor(e,r,s=r.width*.2,n=r.height*.2){return this.canvases.get(e).setTexture(r,s,n),this}render(e){for(const r of this.canvases.values())r.render(e)}}class Q_ extends Gn{constructor(){super(Bo.GBuffer);const e=new Dt(re.Albedo);e.appendTo(this.$main),this.canvases.set(re.Albedo,e);const r=new Dt(re.Normal);r.appendTo(this.$main),this.canvases.set(re.Normal,r);const s=new Dt(re.Metallic);s.appendTo(this.$main),this.canvases.set(re.Metallic,s);const n=new Dt(re.Roughness);n.appendTo(this.$main),this.canvases.set(re.Roughness,n);const i=new Dt(re.AO);i.appendTo(this.$main),this.canvases.set(re.AO,i);const o=new Dt(re.Reflectance);o.appendTo(this.$main),this.canvases.set(re.Reflectance,o);const a=new Dt(re.Depth);a.appendTo(this.$main),this.canvases.set(re.Depth,a);const c=new Dt(re.Velocity);c.appendTo(this.$main),this.canvases.set(re.Velocity,c)}}class q_ extends Gn{constructor(){super(Bo.Shadow);const e=new Dt(re.ShadowDepthCascade0);e.appendTo(this.$main),this.canvases.set(re.ShadowDepthCascade0,e);const r=new Dt(re.ShadowDepthCascade1);r.appendTo(this.$main),this.canvases.set(re.ShadowDepthCascade1,r)}}const Wn=class Wn{constructor(){this.open=!1,this.$root=document.createElement("div"),this.$root.id=Wn.ROOT_EL_ID,document.body.appendChild(this.$root),this.gbufferDebugSection=new Q_,this.gbufferDebugSection.appendTo(this.$root),this.shadowDebugSection=new q_,this.shadowDebugSection.appendTo(this.$root)}reveal(){this.open=!0,this.$root.classList.add("open")}hide(){this.open=!1,this.$root.classList.remove("open")}scrollToShadowSection(){this.shadowDebugSection.$root.scrollIntoView({block:"start",inline:"nearest"})}scrollIntoGbufferSection(){this.gbufferDebugSection.$root.scrollIntoView({block:"start",inline:"nearest"})}setTextureGBufferSection(e,r,s=r.width*.2,n=r.height*.2){return this.open?(this.gbufferDebugSection.setTextureFor(e,r,s,n),this):this}setTextureShadowSection(e,r,s=r.width*.2,n=r.height*.2){return this.open?(this.shadowDebugSection.setTextureFor(e,r,s,n),this):this}render(e){this.open&&(this.gbufferDebugSection.render(e),this.shadowDebugSection.render(e))}};Wn.ROOT_EL_ID="webgpu-debug-root";let wo=Wn;const Z_=new Map([[de.CPUTotal,"cpu-total"],[de.GPUTotal,"gpu-total"],[de.FPS,"fps"],[de.VRAM,"vram"],[de.VisibleMeshes,"culled-meshes"],[de.LightsCount,"lights-count"],[de.DeferredRenderPass,"deferred"],[de.DirectionalAmbientLightingRenderPass,"directional-ambient-light"],[de.PointLightsStencilMask,"point-lights-stencil-mask"],[de.PointLightsLighting,"point-lights-lighting"],[de.SSAORenderPass,"ssao"],[de.TransparentRenderPass,"transparent"],[de.ShadowRenderPass,"shadow"],[de.TAAResolveRenderPass,"taa-resolve"],[de.ReflectionRenderPass,"reflection"],[de.BlitRenderPass,"blit"]]),eb=new Map([[de.CPUTotal,"CPU"],[de.GPUTotal,"GPU"],[de.FPS,"FPS"],[de.VRAM,"VRAM Usage"],[de.VisibleMeshes,"Visible Meshes"],[de.LightsCount,"Lights Count"],[de.DeferredRenderPass,"G-Buffer Render Pass"],[de.DirectionalAmbientLightingRenderPass,"Directional + Ambient Render Pass"],[de.PointLightsStencilMask,"Point Lights Stencil Mask Pass"],[de.PointLightsLighting,"Point Lights Render Pass"],[de.SSAORenderPass,"SSAO Render Pass"],[de.TransparentRenderPass,"Transparent Render Pass"],[de.ShadowRenderPass,"Directional Shadow Render Pass"],[de.TAAResolveRenderPass,"TAA Resolve Render Pass"],[de.ReflectionRenderPass,"Reflection Render Pass"],[de.BlitRenderPass,"Blit Render Pass"]]),$o=class $o{constructor(){this.$renderPassTimingDisplayEls=new Map,this.$root=document.createElement("div"),this.$root.id="timings-debug-container",this.$root.classList.add("fadable"),document.body.appendChild(this.$root);for(const e of Ph){const r=Z_.get(e),s=document.createElement("div");s.id=`${r}-debug-timing`,s.classList.add("timing-container"),this.$root.appendChild(s);const n=document.createElement("div");n.classList.add("timing-label"),n.innerText=`${eb.get(e)}:`,s.appendChild(n);const i=document.createElement("div");i.classList.add("timing-value"),s.appendChild(i);const o={root:s,label:n,value:i};this.$renderPassTimingDisplayEls.set(e,o)}}toggleVisibility(){this.$root.classList.toggle("hidden")}setDisplayValue(e,r){const s=this.$renderPassTimingDisplayEls.get(e);return s.value.innerText=r,this}};$o.NOT_AVAILABLE_STR="N/A";let vo=$o;const tb=gr(te.Light),rb=Qt(tb.structs.Light);class Qr extends kr{constructor(e){super(),this.lightType=e,this.id=crypto.randomUUID(),this._color=H.create(1,1,0),this._intensity=1;const r=gr(te.Light);this.lightsStorageView=Qt(r.structs.Light),this.lightsStorageView.set({color:this._color,position:this.position,lightType:Mh.get(e),intensity:1})}static get STRUCT_BYTE_SIZE(){return rb.arrayBuffer.byteLength}get intensity(){return this._intensity}set intensity(e){this._intensity=e,this.lightsStorageView.set({intensity:e})}get color(){return this.getColor()}set color(e){this.setColor(e[0],e[1],e[2])}setColor(e,r,s){this._color[0]=e,this._color[1]=r,this._color[2]=s,this.lightsStorageView.set({color:this._color})}setColorAsVec3(e){H.copy(e,this._color),this.lightsStorageView.set({color:this._color})}getColor(){return this._color}setPosition(e,r,s){return super.setPosition(e,r,s),this.lightsStorageView.set({position:this.position}),this}setPositionAsVec3(e){return super.setPositionAsVec3(e),this.lightsStorageView.set({position:this.position}),this}setPositionX(e){return super.setPositionX(e),this.lightsStorageView.set({position:this.position}),this}setPositionY(e){return super.setPositionY(e),this.lightsStorageView.set({position:this.position}),this}setPositionZ(e){return super.setPositionZ(e),this.lightsStorageView.set({position:this.position}),this}}class Co extends Qr{constructor(){super(_r.Directional)}}class Sr extends Qr{get radius(){return this._radius}set radius(e){this._radius=e,this.lightsStorageView.set({radius:e})}constructor(){super(_r.Point),this.intensity=1,this.radius=1}}class zt extends Sr{static get bindGroupLayout(){if(this._bindGroupLayout)return this._bindGroupLayout;const e=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return this._bindGroupLayout=x.device.createBindGroupLayout({label:"Camera Face Culled Point Light Bind Group Layout",entries:e}),this._bindGroupLayout}updateGPUBuffer(){x.device.queue.writeBuffer(this.gpuBuffer,0,this.lightsStorageView.arrayBuffer)}constructor(){super(),this.gpuBuffer=x.device.createBuffer({label:"Camera Face Culled Point Light GPU Buffer",size:Qr.STRUCT_BYTE_SIZE,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),ee.addBufferBytes(this.gpuBuffer),this.lightsStorageView.set({type:ru,intensity:1,radius:1,color:H.create(1,1,1),position:H.create(0,1,0)}),this.updateGPUBuffer();const e=[{binding:0,resource:{buffer:this.gpuBuffer}}];this.bindGroup=x.device.createBindGroup({label:"Camera Face Culled Point Light Bind Group",entries:e,layout:zt.bindGroupLayout})}}class sb{constructor(){this.pointLights=[],this.cameraFaceCulledPointLights=[],this.directionalLights=[],this.allLights=[]}get lightsCount(){return this.allLights.length}get pointLightsCount(){return this.pointLights.length}get directionalLightsCount(){return this.directionalLights.length}updateGPUBuffer(){if(!this.allLights.length){console.warn("No lights, skip creating GPUBuffer");return}this.gpuBuffer&&(ee.removeBufferBytes(this.gpuBuffer),this.gpuBuffer.destroy()),this.gpuBuffer=x.device.createBuffer({label:"Lights GPU Buffer",size:Qr.STRUCT_BYTE_SIZE*this.allLights.length,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE}),ee.addBufferBytes(this.gpuBuffer);let e=0;for(let r=0;r<this.directionalLights.length;r++)x.device.queue.writeBuffer(this.gpuBuffer,e*Qr.STRUCT_BYTE_SIZE,this.directionalLights[r].lightsStorageView.arrayBuffer),e++;for(let r=0;r<this.pointLights.length;r++)x.device.queue.writeBuffer(this.gpuBuffer,e*Qr.STRUCT_BYTE_SIZE,this.pointLights[r].lightsStorageView.arrayBuffer),e++;return this}addLight(e){return e instanceof zt?this.cameraFaceCulledPointLights.push(e):e instanceof Sr?this.pointLights.push(e):e instanceof Co&&this.directionalLights.push(e),this.allLights.push(e),this}removeLight(e){const r=s=>s.id!==e.id;return e instanceof zt?this.cameraFaceCulledPointLights=this.cameraFaceCulledPointLights.filter(r):e instanceof Sr?this.pointLights=this.pointLights.filter(r):e instanceof Co&&(this.directionalLights=this.directionalLights.filter(r)),this.allLights=this.allLights.filter(r),this}render(e){throw new Error("Needs implementation")}}const nb=gr(te.Particle),Er=Qt(nb.structs.Particle),Pt=class Pt{constructor({radius:e,position:r,velocity:s,lifeSpeed:n,life:i}={radius:1,position:H.create(0,3,0),velocity:H.create(0,1,0),lifeSpeed:1,life:0}){this.radius=e,this.position=r,this.origPosition=r,this.velocity=s,this.lifeSpeed=n,this.life=i}};Pt.STRUCT_BYTE_SIZE=Er.arrayBuffer.byteLength,Pt.STRUCT_FLOATS_COUNT=Pt.STRUCT_BYTE_SIZE/Float32Array.BYTES_PER_ELEMENT,Pt.RADIUS_OFFSET=Er.views.radius.byteOffset/Float32Array.BYTES_PER_ELEMENT,Pt.POSITION_OFFSET=Er.views.position.byteOffset/Float32Array.BYTES_PER_ELEMENT,Pt.ORIG_POSITION_OFFSET=Er.views.origPosition.byteOffset/Float32Array.BYTES_PER_ELEMENT,Pt.VELOCITY_OFFSET=Er.views.velocity.byteOffset/Float32Array.BYTES_PER_ELEMENT,Pt.LIFE_OFFSET=Er.views.life.byteOffset/Float32Array.BYTES_PER_ELEMENT,Pt.LIFE_SPEED_OFFSET=Er.views.lifeSpeed.byteOffset/Float32Array.BYTES_PER_ELEMENT;let Mt=Pt;const nl="vertexMain",il="fragMain",ib=`
  ${te.Particle}
  ${te.Light}
  ${te.Camera}

  struct VertexOut {
    @builtin(position) position: vec4f,
    @location(0) uv: vec2f,
    @location(1) @interpolate(flat) instanceId: u32,
  };

  @group(0) @binding(0) var<uniform> camera: Camera;

  @group(1) @binding(0) var<storage, read> particles: array<Particle>;
  @group(1) @binding(1) var<storage, read> lights: array<Light>;

  override ANIMATED_PARTICLES_OFFSET_START: u32;
  override CURVE_PARTICLES_OFFSET: u32;

  const positions = array<vec2f, 4>(
    vec2f(-1.0, -1.0), 
    vec2f(1.0, -1.0),  
    vec2f(-1.0, 1.0),   
    vec2f(1.0, 1.0),   
  );

  const uvs = array<vec2f, 4>(
    vec2f(0.0, 1.0),
    vec2f(1.0, 1.0),
    vec2f(0.0, 0.0),
    vec2f(1.0, 0.0),
  );

  @vertex
  fn ${nl}(
    @builtin(vertex_index) vertexId: u32,
    @builtin(instance_index) instanceId: u32,
  ) -> VertexOut {
    let p = particles[instanceId];
    let particlePosition = p.position;
    let particleRadius = select(p.radius - p.radius * p.life, p.radius, instanceId >= CURVE_PARTICLES_OFFSET);
    // let particleRadius = p.radius;
    let uv = uvs[vertexId];
    var out: VertexOut;
    out.position = camera.projectionViewMatrix * vec4f(particlePosition, 1);
    let aspect = f32(camera.viewportWidth) / f32(camera.viewportHeight);
    out.position += vec4f(positions[vertexId].xy * vec2f(particleRadius, particleRadius * aspect), 0, 0);
    out.instanceId = instanceId;
    out.uv = uv;
    return out;
  }

  @fragment
  fn ${il}(
    in: VertexOut
  ) -> @location(0) vec4f {
    let light = &lights[in.instanceId + ANIMATED_PARTICLES_OFFSET_START];
    let d = distance(in.uv, vec2f(0.5));
    let mask = 1.0 - smoothstep(0.2, 0.5, d);
    if (mask < 0.2) {
      discard;
    }
    let lightColor = light.color;
    return vec4f(light.color * mask * 0.8, 1);
  }
`,ol="updatePointLights",ob=`
  ${te.Particle}
  ${te.Light}

  struct SimSettings {
    time: f32,
    timeDelta: f32,
  };

  @group(0) @binding(0) var<storage, read_write> particles: array<Particle>;
  @group(0) @binding(1) var<storage, read_write> lights: array<Light>;
  @group(0) @binding(2) var<uniform> simSettings: SimSettings;
  @group(0) @binding(3) var<storage, read> linePointPositions: array<vec4f>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;
  override ANIMATED_PARTICLES_OFFSET_START: u32;
  override FIREWORK_PARTICLES_OFFSET: u32;
  override FIREWORK_PARTICLES_COUNT: u32;
  override CURVE_PARTICLES_OFFSET: u32;
  override CURVE_PARTICLES_COUNT: u32;
  override CURVE_POSITIONS_COUNT: u32;
  
  @must_use
  fn noise(p: vec3f) -> f32 {
    return fract(
      sin(dot(p, vec3f(12.9898, 78.233, 45.164))) * 43758.5453
    );
  }

  @must_use
  fn random(seed: f32) -> f32 {
    return fract(sin(seed * 12.9898) * 43758.5453);
  }

  // Curl noise for more natural 3D fluid-like motion
  fn curlNoise(p: vec3<f32>) -> vec3<f32> {
    let eps = 0.1;
    
    let nx = noise(p + vec3<f32>(eps, 0.0, 0.0));
    let ny = noise(p + vec3<f32>(0.0, eps, 0.0));
    let nz = noise(p + vec3<f32>(0.0, 0.0, eps));
    
    let x = ny - noise(p - vec3<f32>(eps, 0.0, 0.0));
    let y = nz - noise(p - vec3<f32>(0.0, eps, 0.0));
    let z = nx - noise(p - vec3<f32>(0.0, 0.0, eps));
    
    return vec3<f32>(x, y, z) / (2.0 * eps);
  }

  fn interpolateLinePoint(t: f32) -> vec3f {
    let totalCount = CURVE_POSITIONS_COUNT;
    let segmentLength = 1.0 / f32(totalCount - 1u);
    let baseIndex = u32(t / segmentLength);
    let localT = fract(t / segmentLength);
    let safeIndex = min(baseIndex, totalCount - 2u);
    let start = linePointPositions[safeIndex];
    let end = linePointPositions[safeIndex + 1u];
    return mix(start, end, localT).xyz;
  }

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)
  fn ${ol}(
    @builtin(global_invocation_id) tid : vec3u
  ) {
    let idx = tid.x;
    let particle = &particles[idx];
    let light = &lights[idx + ANIMATED_PARTICLES_OFFSET_START];

    particle.life += particle.lifeSpeed * simSettings.timeDelta;

    if (particle.life >= 1) {
      particle.position = particle.origPosition;
      particle.life = 0;
    }

    if (idx >= FIREWORK_PARTICLES_OFFSET && idx < CURVE_PARTICLES_OFFSET - 4) {
      let turbulence = curlNoise(
        particle.position * 0.05 + 
        vec3<f32>(0.0, simSettings.time * 0.05, 0.0)
      ) * 0.2;
      particle.position += (particle.velocity + turbulence) * simSettings.timeDelta;
      light.intensity = (1 - particle.life);
    }

    if (idx >= CURVE_PARTICLES_OFFSET && idx < CURVE_PARTICLES_OFFSET + CURVE_PARTICLES_COUNT) {
      particle.position = interpolateLinePoint(particle.life) + particle.velocity;  
    }

    if (idx >= CURVE_PARTICLES_OFFSET + CURVE_PARTICLES_COUNT) {
      particle.position = vec3f(
        particle.life * 15 - 7.5,
        cos(particle.life + particle.life * particle.velocity.y * 30) * 1.2 + 3.5,
        sin(particle.life + particle.life * particle.velocity.y * 30) * 1.075 + particle.velocity.x
      );
      let fadeIn = smoothstep(0.0, 0.1, particle.life);
      let fadeOut = 1.0 - smoothstep(0.9, 1.0, particle.life);
      light.intensity = 0.5 * fadeIn * fadeOut;
      light.radius = 1 * fadeIn * fadeOut;
    }
    light.position = particle.position;

  }
`,Ln=[H.create(3.9,3,.9),H.create(3.9,3,-1.5),H.create(-4.95,3,.9),H.create(-4.95,3,-1.5)],ab=[H.create(3.9,3,1.15),H.create(3.9,3,-1.75),H.create(-4.95,3,1.15),H.create(-4.95,3,-1.75)],Ts=H.scale(H.create(1,.01,.01),10),Oe=class Oe extends sb{constructor(e){super(),this.particles=[],this.particlesSimSettingsArr=new Float32Array(2).fill(0),this.render2ndFloorParticles=!0;const r=new Co;r.setPosition(.1,20,.1),r.setColor(.2156,.2627,.3333),r.intensity=2,this.addLight(r),this.mainDirLight=r;let s=3,n=.3,i=new zt;i.radius=s,i.intensity=n,i.setPositionAsVec3(Ln[0]),i.setColorAsVec3(Ts),i.updateGPUBuffer(),this.addLight(i);let o=new zt;o.radius=s,o.intensity=n,o.setPositionAsVec3(Ln[1]),o.setColorAsVec3(Ts),o.updateGPUBuffer(),this.addLight(o);let a=new zt;a.intensity=n,a.radius=s,a.setPositionAsVec3(Ln[2]),a.setColorAsVec3(Ts),a.updateGPUBuffer(),this.addLight(a);let c=new zt;c.intensity=n,c.radius=s,c.setPositionAsVec3(Ln[3]),c.setColorAsVec3(Ts),c.updateGPUBuffer(),this.addLight(c);for(let j=0;j<Oe.PARTICLES_PER_FIRE;j++)for(let W=0;W<4;W++){const Z=new Sr,ue=H.add(ab[W],H.create((Math.random()*2-1)*.1,0,(Math.random()*2-1)*.1));Z.radius=.5,Z.intensity=.1,Z.setPositionAsVec3(ue),Z.setColorAsVec3(Ts),this.addParticleLight(Z,.025)}const m=x.device.createBuffer({label:"Lighting System Curve Points GPU Buffer",size:4*e.length*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0});ee.addBufferBytes(m);const _=new Float32Array(m.getMappedRange());for(let j=0;j<e.length;j++)_[j*4+0]=e[j][0],_[j*4+1]=e[j][1],_[j*4+2]=e[j][2],_[j*4+3]=1;m.unmap();let v=H.create();for(let j=0;j<Oe.PARTICLES_PER_CURVE;j++){const W=new Sr;W.setColor(Math.random()*3+1,Math.random()*3+1,Math.random()*3+1),W.setPositionAsVec3(v),W.radius=2,W.intensity=1;const Z=j/Oe.PARTICLES_PER_CURVE;this.addParticleLight(W,.02,Z,.01,H.random(.5))}this.particlesLength=this.particles.length;for(let j=0;j<Oe.PARTICLES_PER_CORRIDOR;j++){const W=new Sr;W.setColor(Math.random()*3+1,Math.random()*3+1,Math.random()*3+1),W.setPositionAsVec3(v),W.radius=1,this.addParticleLight(W,.02,j/Oe.PARTICLES_PER_CORRIDOR,.01,H.create(3.125,1,0))}for(let j=0;j<Oe.PARTICLES_PER_CORRIDOR;j++){const W=new Sr;W.setColor(Math.random()*3+1,Math.random()*3+1,Math.random()*3+1),W.setPositionAsVec3(v),W.radius=1,this.addParticleLight(W,.02,j/Oe.PARTICLES_PER_CORRIDOR,.01,H.create(-3.775,-1,0))}console.log(this.lightsCount),this.updateGPUBuffer(),this.updateParticlesBuffer(),this.particleSimSettingsBuffer=x.device.createBuffer({label:"Particles Update Sim Settings",size:2*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),ee.addBufferBytes(this.particleSimSettingsBuffer);const P=[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}],O=x.device.createBindGroupLayout({label:"Lights Compute Bind Group Layout",entries:P}),D=[{binding:0,resource:{buffer:this.particlesGPUBuffer}},{binding:1,resource:{buffer:this.gpuBuffer}},{binding:2,resource:{buffer:this.particleSimSettingsBuffer}},{binding:3,resource:{buffer:m}}];this.computeBindGroup=x.device.createBindGroup({label:"Lights Compute Bind Group",entries:D,layout:O});const U=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}],X=x.device.createBindGroupLayout({label:"Lights Render Bind Group Layout",entries:U}),Y=[{binding:0,resource:{buffer:this.particlesGPUBuffer}},{binding:1,resource:{buffer:this.gpuBuffer}}];this.renderBindGroup=x.device.createBindGroup({label:"Lights Render Bind Group",entries:Y,layout:X}),this.computePSO=$.createComputePipeline({label:"Update Lights Compute PSO",layout:x.device.createPipelineLayout({label:"Lights Compute PSO Layout",bindGroupLayouts:[O]}),compute:{entryPoint:ol,module:$.createShaderModule(ob,"Update Lights Shader Module"),constants:{WORKGROUP_SIZE_X:Oe.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:Oe.COMPUTE_WORKGROUP_SIZE_Y,ANIMATED_PARTICLES_OFFSET_START:1,FIREWORK_PARTICLES_OFFSET:5,CURVE_PARTICLES_OFFSET:4*Oe.PARTICLES_PER_FIRE,CURVE_PARTICLES_COUNT:Oe.PARTICLES_PER_CURVE,CURVE_POSITIONS_COUNT:e.length}}});const Q=[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{operation:"add",srcFactor:"one",dstFactor:"one"}}}],q=$.createShaderModule(ib,"Render Lights Shader Module");this.renderPSO=$.createRenderPipeline({label:"Render Lights PSO",layout:x.device.createPipelineLayout({label:"Lights Render PSO Layout",bindGroupLayouts:[$.defaultCameraPlusLightsBindGroupLayout,X]}),vertex:{entryPoint:nl,module:q,constants:{CURVE_PARTICLES_OFFSET:4*Oe.PARTICLES_PER_FIRE}},fragment:{entryPoint:il,module:q,targets:Q,constants:{ANIMATED_PARTICLES_OFFSET_START:1}},depthStencil:{format:x.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less"}}),this.particleIndexBuffer=x.device.createBuffer({label:"Particle Index Buffer",size:6*Uint16Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),ee.addBufferBytes(this.particleIndexBuffer),new Uint16Array(this.particleIndexBuffer.getMappedRange()).set([0,1,3,0,2,3]),this.particleIndexBuffer.unmap()}uploadMainDirLightToGPU(){x.device.queue.writeBuffer(this.gpuBuffer,0,this.mainDirLight.lightsStorageView.arrayBuffer)}set sunIntensity(e){this.mainDirLight.intensity=e,this.uploadMainDirLightToGPU()}set sunPositionX(e){this.mainDirLight.setPositionX(e),this.uploadMainDirLightToGPU()}set sunPositionY(e){this.mainDirLight.setPositionY(e),this.uploadMainDirLightToGPU()}set sunPositionZ(e){this.mainDirLight.setPositionZ(e),this.uploadMainDirLightToGPU()}addParticleLight(e,r=.05,s=0,n=Math.random()*1.5+.35,i=H.create(0,.5,0)){super.addLight(e);const o=new Mt({radius:r,position:e.position,velocity:i,lifeSpeed:n,life:s});return this.particles.push(o),this}updateParticlesBuffer(){this.particlesGPUBuffer&&(ee.removeBufferBytes(this.particlesGPUBuffer),this.particlesGPUBuffer.destroy()),this.particlesGPUBuffer=x.device.createBuffer({label:"Light Particles GPU Buffer",size:Mt.STRUCT_BYTE_SIZE*this.particles.length,mappedAtCreation:!0,usage:GPUBufferUsage.STORAGE}),ee.addBufferBytes(this.particlesGPUBuffer);const e=new Float32Array(this.particlesGPUBuffer.getMappedRange());for(let r=0;r<this.particles.length;r++){const s=r*Mt.STRUCT_FLOATS_COUNT,n=s+Mt.POSITION_OFFSET,i=s+Mt.ORIG_POSITION_OFFSET,o=s+Mt.VELOCITY_OFFSET,a=s+Mt.LIFE_OFFSET,c=s+Mt.LIFE_SPEED_OFFSET,m=s+Mt.RADIUS_OFFSET;e[n+0]=this.particles[r].position[0],e[n+1]=this.particles[r].position[1],e[n+2]=this.particles[r].position[2],e[i+0]=this.particles[r].origPosition[0],e[i+1]=this.particles[r].origPosition[1],e[i+2]=this.particles[r].origPosition[2],e[o+0]=this.particles[r].velocity[0],e[o+1]=this.particles[r].velocity[1],e[o+2]=this.particles[r].velocity[2],e[a]=this.particles[r].life,e[c]=this.particles[r].lifeSpeed,e[m]=this.particles[r].radius}this.particlesGPUBuffer.unmap(),this.particles=null}update(e){this.particlesSimSettingsArr[0]=x.elapsedTimeMs,this.particlesSimSettingsArr[1]=x.deltaTimeMs,x.device.queue.writeBuffer(this.particleSimSettingsBuffer,0,this.particlesSimSettingsArr);const r=e.beginComputePass({label:"Update Lights Compute Encoder"});r.setPipeline(this.computePSO),r.setBindGroup(0,this.computeBindGroup);const s=Math.ceil(this.allLights.length/Oe.COMPUTE_WORKGROUP_SIZE_X);r.dispatchWorkgroups(s,1,1),r.end()}render(e){e.setPipeline(this.renderPSO),e.setBindGroup(1,this.renderBindGroup),e.setIndexBuffer(this.particleIndexBuffer,Je.INDEX_FORMAT),e.drawIndexed(6,this.render2ndFloorParticles?this.particlesLength:Oe.PARTICLES_PER_FIRE*4)}};Oe.COMPUTE_WORKGROUP_SIZE_X=8,Oe.COMPUTE_WORKGROUP_SIZE_Y=1,Oe.PARTICLES_PER_FIRE=64,Oe.PARTICLES_PER_CURVE=150,Oe.PARTICLES_PER_CORRIDOR=32;let To=Oe;class Jt{constructor({vertexShaderSrc:e,vertexShaderEntryFn:r,vertexBuffers:s=ze.defaultLayout,fragmentShaderSrc:n,fragmentShaderEntryFn:i,bindGroupLayouts:o=[$.defaultCameraBindGroupLayout,$.defaultModelBindGroupLayout,$.defaultModelMaterialBindGroupLayout],constants:a={},targets:c=[],depthStencilState:m={format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"},primitive:_={cullMode:"back",topology:"triangle-list"},debugLabel:v}){const P={label:v,layout:x.device.createPipelineLayout({bindGroupLayouts:o}),vertex:{module:$.createShaderModule(e,`${v} material vertex shader module`),entryPoint:r,buffers:s}};if(i&&n&&c.length){const O=$.createShaderModule(n,`${v} material fragment shader module`);P.fragment={module:O,entryPoint:i,targets:c,constants:a}}m&&(P.depthStencil=m),_&&(P.primitive=_),this.renderPSO=$.createRenderPipeline(P)}bind(){x.bindRenderPSO(this.renderPSO)}}const al="vertexMain",ul="fragmentMain",cl=`
  ${te.VertexInput}
  ${te.VertexOutput}
  ${te.GBufferOutput}
  ${te.Camera}
  ${te.ModelUniform}

  @group(${Be.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(1) @binding(0) var inTexture: texture_cube<f32>;
  @group(1) @binding(1) var inSampler: sampler;
  @group(1) @binding(2) var bayerDitherTexture: texture_2d<f32>;
  @group(1) @binding(3) var bayerDitherSampler: sampler;

  @vertex
  fn ${al}(in: VertexInput) -> VertexOutput {
    var out: VertexOutput;

    var viewMatrix = camera.viewMatrix;
    viewMatrix[3] = vec4f(0, 0, 0, 1);
    let projViewMatrix = camera.projectionMatrix * viewMatrix;
    let position = in.position;
    out.position = (projViewMatrix * position).xyww;
    // hijack to compute uvs for frag shader
    out.viewNormal = 0.5 * (in.position.xyz + vec3(1.0, 1.0, 1.0));
    out.uv = in.uv;
    return out;
  }

  @fragment
  fn ${ul}(in: VertexOutput) -> @location(0) vec4f {
    var cubemapVec = in.viewNormal - vec3(0.5);
    var color = textureSampleLevel(inTexture, inSampler, cubemapVec, 4); //7.8);
    let o = textureSample(bayerDitherTexture, bayerDitherSampler, in.position.xy / 8.0).r / 32.0 - (1.0 / 128.0);
    color.r += o;
    color.g += o;
    color.b += o;
    return vec4f(color.rgb, 1.0);
  }
`;class ub extends xn{constructor(e=1,r=1,s=1,n=1){super(),this.width=e,this.height=r,this.widthSegments=s,this.heightSegments=n;const i=e*.5,o=r*.5,a=s+1,c=n+1,m=Math.floor(s),_=Math.floor(n),v=e/s,P=r/n,O=[],D=[],U=[],X=[];for(let Y=0;Y<c;Y++){const Q=Y*P-o;for(let q=0;q<a;q++){const j=q*v-i;D.push(H.create(j,-Q,0)),U.push(H.create(0,0,1)),X.push(dt.create(q/m,1-Y/_))}}for(let Y=0;Y<_;Y++)for(let Q=0;Q<m;Q++){const q=Q+a*Y,j=Q+a*(Y+1),W=Q+1+a*(Y+1),Z=Q+1+a*Y;O.push(q,j,Z);const ue=new $r(q,j,Z,D[q],D[j],D[Z],U[q],U[j],U[Z],X[q],X[j],X[Z]);this.faces.push(ue),O.push(j,W,Z);const me=new $r(j,W,Z,D[j],D[W],D[Z],U[j],U[W],U[Z],X[j],X[W],X[Z]);this.faces.push(me)}this.createBuffersWithTangentsManually(O.length,D,U,X,new Uint16Array(O))}}class ll extends xn{constructor(e=1,r=32,s=16,n=0,i=Math.PI*2,o=0,a=Math.PI){super(),this.radius=e,this.widthSegments=r,this.heightSegments=s,this.phiStart=n,this.phiLength=i,this.thetaStart=o,this.thetaLength=a,r=Math.max(3,Math.floor(r)),s=Math.max(2,Math.floor(s));const c=Math.min(o+a,Math.PI);let m=0;const _=[],v=H.create(),P=H.create(),O=dt.create(),D=[],U=[],X=[],Y=[];for(let Q=0;Q<=s;Q++){const q=[],j=Q/s;let W=0;Q===0&&o===0?W=.5/r:Q===s&&c===Math.PI&&(W=-.5/r);for(let Z=0;Z<=r;Z++){const ue=Z/r;v[0]=-e*Math.cos(n+ue*i)*Math.sin(o+j*a),v[1]=e*Math.cos(o+j*a),v[2]=e*Math.sin(n+ue*i)*Math.sin(o+j*a),D.push(H.clone(v)),H.copy(v,P),H.normalize(P,P),U.push(H.clone(P)),O[0]=ue+W,O[1]=1-j,X.push(dt.clone(O)),q.push(m++)}_.push(q)}for(let Q=0;Q<s;Q++)for(let q=0;q<r;q++){const j=_[Q][q+1],W=_[Q][q],Z=_[Q+1][q],ue=_[Q+1][q+1];if(Q!==0||o>0){Y.push(j,W,ue);const Ce=D[j],Ee=D[W],be=D[ue],Pe=U[j],He=U[W],et=U[ue],Xe=X[j],lt=X[W],tt=X[ue],f=new $r(j,W,ue,Ce,Ee,be,Pe,He,et,Xe,lt,tt);this.faces.push(f)}(Q!==s-1||c<Math.PI)&&Y.push(W,Z,ue);const me=D[W],ye=D[Z],ve=D[ue],Ve=U[W],oe=U[Z],xe=U[ue],he=X[W],Ge=X[Z],we=X[ue],Le=new $r(W,Z,ue,me,ye,ve,Ve,oe,xe,he,Ge,we);this.faces.push(Le)}this.createBuffersWithTangentsManually(Y.length,D,U,X,new Uint16Array(Y))}}let So,Eo,Mo,Po;const It=Object.freeze({get defaultPlaneGeometry(){return So||(So=new ub,So)},get unitCubeGeometry(){return Eo||(Eo=new Vc,Eo)},get unitSphereGeometry(){return Mo||(Mo=new ll,Mo)},get pointLightSphereGeometry(){return Po||(Po=new ll(1,9,9),Po)}});class cb extends Je{set texture(e){this.setTexture(e)}setTexture(e){if(e.depthOrArrayLayers!==6)return;this._texture=e;const r=[{binding:0,resource:e.createView({dimension:"cube"})},{binding:1,resource:vt.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear"})},{binding:2,resource:Ke.bayerDitherPatternTexture.createView()},{binding:3,resource:vt.createSampler({addressModeU:"repeat",addressModeV:"repeat",minFilter:"linear"})}];this.texSamplerBindGroup=x.device.createBindGroup({label:"Skybox Sampler + Texture Bind Group",layout:this.texSamplerBindGroupLayout,entries:r})}constructor(){super(It.unitCubeGeometry),this.label="Skybox";const e=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.FRAGMENT},{binding:1,sampler:{type:"filtering"},visibility:GPUShaderStage.FRAGMENT},{binding:2,texture:{sampleType:"float"},visibility:GPUShaderStage.FRAGMENT},{binding:3,sampler:{},visibility:GPUShaderStage.FRAGMENT}];this.texSamplerBindGroupLayout=x.device.createBindGroupLayout({label:"Skybox Sampler + Texture Bind Group Layout",entries:e});const r=new Jt({debugLabel:"Skybox Material",vertexShaderSrc:cl,vertexShaderEntryFn:al,fragmentShaderSrc:cl,fragmentShaderEntryFn:ul,targets:[{format:"rgba16float"}],bindGroupLayouts:[$.defaultCameraBindGroupLayout,this.texSamplerBindGroupLayout],depthStencilState:{format:x.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal"},primitive:{cullMode:"front"}});this.setMaterial(r,K.Skybox)}preRender(e){super.preRender(e),this._texture&&e.setBindGroup(1,this.texSamplerBindGroup)}render(e){this._texture&&super.render(e)}}class ct{constructor(e,r,s){if(this.type=e,this.width=r,this.height=s,this.enabled=!0,this.inputTextureNames=[],this.outputTextureNames=[],this.outTextures=[],this.inputTextureViews=[],this.resultBuffers=[],this.state="free",this.gpuTimingAverage=new Ys,this.name=ps.get(e),x.supportsGPUTimestampQuery){const n=ps.get(e);this.querySet=x.device.createQuerySet({label:`Timestamp Query for Render Pass: ${n}`,type:"timestamp",count:2}),this.resolveBuffer=x.device.createBuffer({label:`Timestamp Query Resolve GPUBuffer for Render Pass: ${n}`,size:2*8,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),ee.addBufferBytes(this.resolveBuffer)}}destroy(){var e;for(const r of this.outTextures)ee.removeTextureBytes(r),r.destroy();this.inputTextureViews.length=0,(e=this.querySet)==null||e.destroy(),this.resolveBuffer&&(ee.removeBufferBytes(this.resolveBuffer),this.resolveBuffer.destroy()),this.inputTextureNames.length=0,this.inputTextureViews.length=0;for(const r of this.resultBuffers)ee.removeBufferBytes(r),r.destroy()}resetInputs(){return this.inputTextureNames.length=0,this.inputTextureViews.length=0,this}clearInputTextures(){return this.inputTextureNames.length=0,this.inputTextureViews.length=0,this}clearOutputTextures(){return this.outputTextureNames.length=0,this}addInputTexture(e){return this.inputTextureNames.push(e),this}addInputTextures(e){return this.inputTextureNames.push(...e),this}addOutputTexture(e){return this.outputTextureNames.push(e),this}addOutputTextures(e){return this.outputTextureNames.push(...e),this}createRenderPassDescriptor(){throw new Error("Needs implementation")}createComputePassDescriptor(){throw new Error("Needs implementation")}augmentRenderPassDescriptorWithTimestampQuery(e){return x.supportsGPUTimestampQuery&&(e.timestampWrites={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}),e}resolveTiming(e){if(!x.supportsGPUTimestampQuery)return;this.state="wait for result";const r=this.resultBuffers.pop();r?this.resultBuffer=r:(this.resultBuffer=x.device.createBuffer({label:`Timestamp Query Result Buffer for render pass: ${this.name}`,size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),ee.addBufferBytes(this.resultBuffer)),e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),e.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,this.resultBuffer.size)}async getStartAndEndTimings(){if(!x.supportsGPUTimestampQuery)return[0,0];const e=this.resultBuffer;this.state="free",await e.mapAsync(GPUMapMode.READ);const r=new BigInt64Array(e.getMappedRange()),s=[Number(r[0]),Number(r[1])];return e.unmap(),this.resultBuffers.push(e),s}async getTimingResult(){if(!x.supportsGPUTimestampQuery)return{avgValue:0,timings:[0,0]};const e=await this.getStartAndEndTimings(),r=(e[1]-e[0])/1e6;return this.gpuTimingAverage.addSample(r),{timings:e,avgValue:this.gpuTimingAverage.get()}}setDebugCamera(e){this.debugCamera=e}toggleDebugCamera(e){this.cameraBindGroup=x.device.createBindGroup({label:`Camera Bind Group for: ${ps.get(this.type)}`,layout:$.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:e?this.debugCamera.gpuBuffer:this.camera.gpuBuffer}}]})}setCamera(e){return this.camera=e,this.cameraBindGroup=x.device.createBindGroup({label:`Camera Bind Group for: ${ps.get(this.type)}`,layout:$.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:e.gpuBuffer}}]}),this}postRender(e){this.resolveTiming(e)}onFrameEnd(){}render(e,r,s){throw new Error("Needs implementation")}}const dl="blit",lb=`
  @group(0) @binding(0) var bloomTexture: texture_2d<f32>;
  @group(0) @binding(1) var sceneTexture: texture_2d<f32>;
  @group(0) @binding(2) var<uniform> bloomMixFactor: f32;

  @must_use
  fn ACESFilm(x: vec3f) -> vec3f {
    let v = x;
    let a = 2.51f;
    let b = 0.03f;
    let c = 2.43f;
    let d = 0.59f;
    let e = 0.14f;
    return saturate((v * (a * x + b)) / (x * (c * x + d) + e));
  }

  fn rand (co: vec2f) -> f32 {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
  }
  
  fn transition(p: vec2f, progress: f32, fromColor: vec3f, toColor: vec3f) -> vec3f {
    let size = vec2(10.0);
    let smoothness = 0.5;
    let r = rand(floor(size * p));
    let m = smoothstep(0.0, -smoothness, r - (progress * (1.0 + smoothness)));
    return mix(fromColor, toColor, m);
  }

  @fragment
  fn ${dl}(@builtin(position) coord : vec4f) -> @location(0) vec4f {
    var bloomColor = textureLoad(bloomTexture, vec2i(floor(coord.xy)), 0).xyz;
    var color = textureLoad(sceneTexture, vec2i(floor(coord.xy)), 0).xyz;

    let texSize = vec2f(textureDimensions(sceneTexture));
    // bloomColor = select(color, bloomColor, bloomColor.r > 0.);

    color = mix(color, bloomColor, bloomMixFactor);
    // color = mix(color, bloomColor, 1);

    color = ACESFilm(color.rgb);
    color = pow(color, vec3f(1.0 / 2.2));

    let uv = coord.xy / texSize;
    color = transition(uv, 1, vec3f(rand(uv)) * 0.1, color);

    return vec4f(vec3(color), 1.0);
  }
`,Rs=class Rs extends ct{set bloomEnabled(e){x.device.queue.writeBuffer(this.bloomMixFactorBuffer,0,new Float32Array([e?Rs.BLOOM_MIX_FACTOR:0]))}constructor(e,r){super(K.Blit,e,r);const s=$.createShaderModule(Tr),n=$.createShaderModule(lb),i=[{format:"bgra8unorm"}],o=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,buffer:{}}];this.texturesBindGroupLayout=x.device.createBindGroupLayout({label:"GBuffer Textures Bind Group",entries:o});const a={layout:x.device.createPipelineLayout({bindGroupLayouts:[this.texturesBindGroupLayout]}),vertex:{module:s,entryPoint:er},fragment:{module:n,entryPoint:dl,targets:i},primitive:{topology:"triangle-list",cullMode:"back"}};this.renderPSO=$.createRenderPipeline(a),this.bloomMixFactorBuffer=x.device.createBuffer({label:"Bloom Mix Factor GPU Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),new Float32Array(this.bloomMixFactorBuffer.getMappedRange()).set([Rs.BLOOM_MIX_FACTOR]),this.bloomMixFactorBuffer.unmap()}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:null,loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:e,label:"Blit Pass"}),this.renderPassDescriptor}render(e,r,s){if(!this.inputTextureViews.length){this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView());const o=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:{buffer:this.bloomMixFactorBuffer}}];this.textureBindGroup=x.device.createBindGroup({layout:this.texturesBindGroupLayout,entries:o})}const n=this.createRenderPassDescriptor();n.colorAttachments[0].view=x.canvasContext.getCurrentTexture().createView();const i=e.beginRenderPass(n);return x.setActiveRenderPass(this.type,i),x.bindRenderPSO(this.renderPSO),i.setBindGroup(0,this.textureBindGroup),i.draw(6),i.end(),this.postRender(e),[]}};Rs.BLOOM_MIX_FACTOR=.035;let Ro=Rs;const hl="main",db=`
  @group(0) @binding(0) var srcTexture: texture_2d<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var srcSampler: sampler;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${hl}(
    @builtin(global_invocation_id) tid : vec3u,
  ) {
    let outTexSize = textureDimensions(outTexture);

    if (any(tid.xy >= outTexSize)) {
      return;
    }

    let srcTexSize = vec2f(textureDimensions(srcTexture));
    
    let texelSize = vec2f(1.0) / srcTexSize;
    let x = texelSize.x;
    let y = texelSize.y;

    let texCoords = vec2f((f32(tid.x) + 0.5) / f32(outTexSize.x), (f32(tid.y) + 0.5) / f32(outTexSize.y));

    // Take 13 samples around current texel:
    // a - b - c
    // - j - k -
    // d - e - f
    // - l - m -
    // g - h - i
    // === ('e' is the current texel) ===
    let a = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y + 2 * y), 0).rgb;
    let b = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y + 2 * y), 0).rgb;
    let c = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y + 2 * y), 0).rgb;

    let d = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y), 0).rgb;
    let e = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y), 0).rgb;
    let f = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y), 0).rgb;

    let g = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y - 2 * y), 0).rgb;
    let h = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y - 2 * y), 0).rgb;
    let i = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y - 2 * y), 0).rgb;

    let j = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - x, texCoords.y + y), 0).rgb;
    let k = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + x, texCoords.y + y), 0).rgb;
    let l = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - x, texCoords.y - y), 0).rgb;
    let m = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + x, texCoords.y - y), 0).rgb;

    // Apply weighted distribution:
    // 0.5 + 0.125 + 0.125 + 0.125 + 0.125 = 1
    // a,b,d,e * 0.125
    // b,c,e,f * 0.125
    // d,e,g,h * 0.125
    // e,f,h,i * 0.125
    // j,k,l,m * 0.5
    // This shows 5 square areas that are being sampled. But some of them overlap,
    // so to have an energy preserving downsample we need to make some adjustments.
    // The weights are the distributed, so that the sum of j,k,l,m (e.g.)
    // contribute 0.5 to the final color output. The code below is written
    // to effectively yield this sum. We get:
    // 0.125*5 + 0.03125*4 + 0.0625*4 = 1
    var downsample = e * 0.125;
    downsample += (a + c + g + i) * 0.03125;
    downsample += (b + d + f + h) * 0.0625;
    downsample += (j + k + l + m) * 0.125;
    
    textureStore(outTexture, tid.xy, vec4f(downsample, 1.0));
    // textureStore(outTexture, tid.xy, vec4f(texCoords, 0.0, 1.0));
  }
`,or=class or extends ct{constructor(e,r){super(K.BloomDownsample,e,r),this.mipLevelCount=hr(e,r),this.outTextures.push(x.device.createTexture({label:"Bloom Downscale Texture",size:{width:e,height:r},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST,format:"rgba16float",mipLevelCount:this.mipLevelCount})),ee.addTextureBytes(this.outTextures[0]),this.sampler=vt.createSampler({label:"Bloom Downscale Sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"});const s=[{binding:0,texture:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{format:"rgba16float"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE}];this.bindGroupLayout=x.device.createBindGroupLayout({label:"Bloom Downscale Bind Group Layout",entries:s}),this.computePSO=$.createComputePipeline({label:"Bloom Downscale Render PSO",layout:x.device.createPipelineLayout({label:"Bloom Downscale Render PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:hl,module:$.createShaderModule(db),constants:{WORKGROUP_SIZE_X:or.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:or.COMPUTE_WORKGROUP_SIZE_Y}}})}render(e,r,s){e.copyTextureToTexture({texture:s[0],mipLevel:0},{texture:this.outTextures[0],mipLevel:0},{width:this.width,height:this.height});const n=[{binding:0,resource:null},{binding:1,resource:null},{binding:2,resource:this.sampler}],i=e.beginComputePass({label:"Bloom Downscale Compute Pass"});i.setPipeline(this.computePSO);for(let o=1;o<this.mipLevelCount;o++){n[0].resource=this.outTextures[0].createView({baseMipLevel:o-1,mipLevelCount:1}),n[1].resource=this.outTextures[0].createView({baseMipLevel:o,mipLevelCount:1});const a=x.device.createBindGroup({label:`Bloom Downscale Bind Group for Mip ${o}`,entries:n,layout:this.bindGroupLayout});i.setBindGroup(0,a);const c=this.outTextures[0].width/Math.pow(2,o),m=this.outTextures[0].height/Math.pow(2,o),_=Math.ceil(c/or.COMPUTE_WORKGROUP_SIZE_X),v=Math.ceil(m/or.COMPUTE_WORKGROUP_SIZE_Y);i.dispatchWorkgroups(_,v,1)}return i.end(),this.postRender(e),this.outTextures}};or.COMPUTE_WORKGROUP_SIZE_X=8,or.COMPUTE_WORKGROUP_SIZE_Y=8;let Go=or;const fl="main",hb=`
  ${te.VertexOutput}

  @group(0) @binding(0) var srcTexture: texture_2d<f32>;
  @group(0) @binding(1) var srcSampler: sampler;
  @group(0) @binding(2) var<uniform> filterRadius: f32;

  @fragment
  fn ${fl}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let srcSize = vec2f(textureDimensions(srcTexture));
    let aspect = srcSize.x / srcSize.y;

    let x = filterRadius;
    let y = filterRadius * aspect;

    let texCoord = vec2f(in.uv.x, 1 - in.uv.y);

    let a = textureSample(srcTexture, srcSampler, vec2f(texCoord.x - x, texCoord.y + y)).rgb;
    let b = textureSample(srcTexture, srcSampler, vec2f(texCoord.x,     texCoord.y + y)).rgb;
    let c = textureSample(srcTexture, srcSampler, vec2f(texCoord.x + x, texCoord.y + y)).rgb;

    let d = textureSample(srcTexture, srcSampler, vec2f(texCoord.x - x, texCoord.y)).rgb;
    let e = textureSample(srcTexture, srcSampler, vec2f(texCoord.x,     texCoord.y)).rgb;
    let f = textureSample(srcTexture, srcSampler, vec2f(texCoord.x + x, texCoord.y)).rgb;

    let g = textureSample(srcTexture, srcSampler, vec2(texCoord.x - x, texCoord.y - y)).rgb;
    let h = textureSample(srcTexture, srcSampler, vec2(texCoord.x,     texCoord.y - y)).rgb;
    let i = textureSample(srcTexture, srcSampler, vec2(texCoord.x + x, texCoord.y - y)).rgb;

    var upsample = e * 4.0;
    upsample += (b + d + f + h) * 2.0;
    upsample += (a + c + g + i);
    upsample *= 1.0 / 16.0;

    return vec4f(upsample, 1.0);
  }
`;class fb extends ct{destroy(){ee.removeBufferBytes(this.filterRadiusBuffer),this.filterRadiusBuffer.destroy()}set bloomFilterRadius(e){x.device.queue.writeBuffer(this.filterRadiusBuffer,0,new Float32Array([e]))}constructor(e,r){super(K.BloomUpsample,e,r),this.sampler=vt.createSampler({label:"Bloom Downscale Sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"}),this.filterRadiusBuffer=x.device.createBuffer({label:"Bloom Upscale Filter Radius GPU Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),ee.addBufferBytes(this.filterRadiusBuffer),new Float32Array(this.filterRadiusBuffer.getMappedRange()).set([.0035]),this.filterRadiusBuffer.unmap();const s=[{binding:0,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}];this.bindGroupLayout=x.device.createBindGroupLayout({label:"Bloom Upscale Bind Group Layout",entries:s});const n=[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{operation:"add",srcFactor:"one",dstFactor:"one"}}}];this.renderPSO=$.createRenderPipeline({label:"Bloom Upscale Render PSO",layout:x.device.createPipelineLayout({label:"Bloom Upscale Render PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),vertex:{entryPoint:er,module:$.createShaderModule(Tr)},fragment:{entryPoint:fl,module:$.createShaderModule(hb),targets:n}})}render(e,r,s){const n=[{binding:0,resource:null},{binding:1,resource:this.sampler},{binding:2,resource:{buffer:this.filterRadiusBuffer}}],i={colorAttachments:[{loadOp:"load",storeOp:"store",view:null}]},o=Math.ceil(hr(s[0].width,s[0].height)*.5);for(let a=o-1;a>0;a--){i.label=`Bloom Upscale Mip Level ${a}`,i.colorAttachments[0].view=s[0].createView({baseMipLevel:a-1,mipLevelCount:1});const c=e.beginRenderPass(i);c.setPipeline(this.renderPSO),n[0].resource=s[0].createView({baseMipLevel:a,mipLevelCount:1});const m=x.device.createBindGroup({label:`Bloom Upscale Bind Group for Mip ${a}`,entries:n,layout:this.bindGroupLayout});c.setBindGroup(0,m),c.draw(3),c.end()}return this.postRender(e),s}}const pb=`

  @must_use
  fn ShadowLayerIdxCalculate(
    worldPos: vec3f,
    camera: Camera,
    shadowCascades: array<ShadowCascade, 2>
  ) -> i32 {
  let fragPosViewSpace = camera.viewMatrix * vec4f(worldPos, 1.0);
  let depthValue = abs(fragPosViewSpace.z);

  var layer: i32 = -1;
  let cascadesCount: i32 = 2;
    for (var i: i32 = 0; i < cascadesCount; i++) {
      if (depthValue < shadowCascades[i].distance) {
        layer = i;
        break;
      }
    }

    if (layer == -1) {
      layer = 1;
    }
    return layer;
  }

  fn ShadowCalculate(
    worldPos: vec3f,
    N: vec3f,
    lightPosition: vec3f,
    camera: Camera,
    shadowTextureWidth: f32,
    shadowTextureHeight: f32,
    shadowCascades: array<ShadowCascade, 2>,
    shadowDepthTexture: texture_depth_2d_array,
    shadowDepthSampler: sampler_comparison
  ) -> f32 {

    let layer = ShadowLayerIdxCalculate(
      worldPos,
      camera,
      shadowCascades
    );
    let fragPosLightSpace = shadowCascades[layer].projViewMatrix * vec4f(worldPos, 1.0);

    // perform perspective divide
    var projCoords = fragPosLightSpace.xyz / fragPosLightSpace.w;
    projCoords.x = projCoords.x * 0.5 + 0.5;
    projCoords.y = projCoords.y * 0.5 + 0.5;
    projCoords.y = 1 -  projCoords.y;
    let uv = projCoords.xy;

    var shadow = 0.0;

    let texelSize = 1 / vec2f(shadowTextureWidth, shadowTextureHeight);

    for (var y = -2; y <= 2; y++) {
      for (var x = -2; x <= 2; x++) {
        let uv = projCoords.xy + vec2f(f32(x), f32(y)) * texelSize;
        let pcfDepth = textureSampleCompareLevel(
          shadowDepthTexture,
          shadowDepthSampler,
          uv,
          layer,
          projCoords.z
        );
        shadow += pcfDepth;
      }
    }

    shadow /= 16;

    return shadow;
  }
`,pl=t=>tr`
  @must_use
  fn DistributionGGX(viewSpaceNormal: vec3f, H: vec3f, roughness: f32) -> f32 {
    let a = roughness*roughness;
    let a2 = a*a;
    let NdotH = max(dot(viewSpaceNormal, H), 0.0);
    let NdotH2 = NdotH*NdotH;

    let nom   = a2;
    var denom = (NdotH2 * (a2 - 1.0) + 1.0);
    denom = PI * denom * denom + 0.0001;

    return nom / denom;
}

  @must_use
  fn GeometrySchlickGGX(NdotV: f32, roughness: f32) -> f32 {
    let r = (roughness + 1.0);
    let k = (r * r) / 8;

    let nom   = NdotV;
    let denom = NdotV * (1.0 - k) + k + 0.0001;
    return nom / denom;
  }

  @must_use
  fn GeometrySmith(viewSpaceNormal: vec3f, V: vec3f, L: vec3f, roughness: f32) -> f32 {
    let NdotV = max(dot(viewSpaceNormal, V), 0.0);
    let NdotL = max(dot(viewSpaceNormal, L), 0.0);
    let ggx2 = GeometrySchlickGGX(NdotV, roughness);
    let ggx1 = GeometrySchlickGGX(NdotL, roughness);
    return ggx1 * ggx2;
  }

  @must_use
  fn FresnelSchlick(cosTheta: f32, F0: vec3f) -> vec3f {
    return F0 + (1.0 - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);
  }

  @must_use
  fn FresnelSchlickRoughness(cosTheta: f32, F0: vec3f, roughness: f32) -> vec3f {
    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);
  }

  @must_use
  fn PBRLighting(
    material: Material,
    instanceId: u32,
    viewSpacePos: vec3f,
    viewSpaceNormal: vec3f,
    V: vec3f,
    shadow: f32,
    opacity: f32,
    #if ${t===K.PointLightsNonCulledLighting}
      lightPosition: vec3f,
      lightRadius: f32,
      lightColor: vec3f,
      lightIntensity: f32,
    #elif ${t===K.DirectionalAmbientLighting}
      diffuseIBLTexture: texture_cube<f32>,
      specularIBLTexture: texture_cube<f32>,
      bdrfLutTexture: texture_2d<f32>,
      envTexSampler: sampler,
    #endif
  ) -> vec4f {
    let albedo = material.albedo;
    let F0 = mix(vec3f(0.04), albedo, material.metallic);
    
    var Lo = vec3f(0.0);
    let albedoOverPi = albedo / PI;

    let roughness = material.roughness;
    let roughnessSq = roughness * roughness;
    let roughnessQuad = roughnessSq * roughnessSq;

    let metallic = material.metallic;

    #if ${t===K.DirectionalAmbientLighting}
    let light = &lightsBuffer[instanceId];
    // let isPointLight = light.lightType == ${_r.Point};
    let lightViewSpacePos = (camera.viewMatrix * vec4f(light.position, 0.0)).xyz;
    
    let lightColor = light.color;
    let lightIntensity = light.intensity;
    let L = normalize(lightViewSpacePos);
    let attenuation = 1.0;

    // return vec4f(vec3f(shadow), 1.0)

    #elif ${t===K.PointLightsLighting}
    let light = &lightsBuffer[instanceId];
    let lightColor = light.color;
    let lightIntensity = light.intensity;
    let lightViewSpacePos = (camera.viewMatrix * vec4f(light.position, 1.0)).xyz;
    let dist = lightViewSpacePos.xyz - viewSpacePos.xyz;
    let d = length(dist);
    var attenuation = 1 - smoothstep(0.0, light.radius, d);
    attenuation *= attenuation;
    let L = normalize(dist);
    #elif ${t===K.PointLightsNonCulledLighting}
    let lightViewSpacePos = (camera.viewMatrix * vec4f(lightPosition, 1)).xyz;
    let dist = lightViewSpacePos.xyz - viewSpacePos.xyz;
    let d = length(dist);
    var attenuation = 1 - smoothstep(0.0, lightRadius, d);
    attenuation *= attenuation;
    let L = normalize(dist);
    #endif

    
    let H = normalize(V + L);
    
    let radiance = lightColor * attenuation * lightIntensity;

    let NDF = DistributionGGX(viewSpaceNormal, H, roughnessQuad);
    let G = GeometrySmith(viewSpaceNormal, V, L, roughness);
    var F = FresnelSchlick(max(dot(H, V), 0.0), F0);

    let numerator = NDF * G * F;
    // let denominator = 4.0 * (NdotV * NdotL, 0.0001); // + 0.0001 to prevent divide by zero
    let denominator = 4.0 * max(dot(viewSpaceNormal, V), 0.0) * max(dot(viewSpaceNormal, L), 0.0) + 0.0001; // + 0.0001 to prevent divide by zero

    var specular = numerator / denominator;

      // kS is equal to Fresnel
    var kS = F;
    // for energy conservation, the diffuse and specular light can't
    // be above 1.0 (unless the surface emits light); to preserve this
    // relationship the diffuse component (kD) should equal 1.0 - kS.
    var kD = vec3f(1.0 - kS);
    // multiply kD by the inverse metalness such that only non-metals
    // have diffuse lighting, or a linear blend if partly metal (pure metals
    // have no diffuse light).
    kD *= 1.0 - metallic;

    let NdotL = max(dot(viewSpaceNormal, L), 0.0); 

    // add to outgoing radiance Lo
    Lo += (kD * albedoOverPi + specular) * radiance * NdotL * shadow; // * light.opacity;  // note that we already multiplied the BRDF by the Fresnel
  
    #if ${t===K.DirectionalAmbientLighting}
      let worldSpaceNorm = (camera.inverseViewMatrix * vec4f(viewSpaceNormal, 0)).xyz;
      let worldSpaceV = (camera.inverseViewMatrix * vec4f(V, 0)).xyz;
      let irradiance = textureSampleLevel(diffuseIBLTexture, envTexSampler, worldSpaceNorm, 0).rgb;
      kS = FresnelSchlickRoughness(max(dot(viewSpaceNormal, V), 0.0), F0, roughness); 
      kD = 1.0 - kS;
      kD *= 1.0 - metallic;
      // let ambientIBL = kD * irradiance;
      // let ambientFactor = 0.2;

      let R = reflect(-worldSpaceV, worldSpaceNorm);
      let MAX_REFLECTION_LOD = 8.0;
      let prefilteredColor = vec3f(
        textureSampleLevel(
          specularIBLTexture,
          envTexSampler,
          R,
          material.roughness * MAX_REFLECTION_LOD
        ).rgb
      );

      let uv = vec2f(max(dot(worldSpaceNorm, worldSpaceV), 0.0), roughness);
      let envBDRF = textureSample(bdrfLutTexture, envTexSampler, uv).rg;
      specular = prefilteredColor * (F * envBDRF.x + envBDRF.y);
      // specular = mix(specular, specular * 0.2, 1 - shadow);

      let diffuse = irradiance * albedo;
      let ambient = (kD * diffuse + specular * metallic) * material.ambientOcclusion;

      // let ambient = vec3f(0.03) * albedo * material.ambientOcclusion;
      
      var color = ambient + Lo;
    #else
      var color = Lo;
    #endif

    return vec4f(color, opacity);
  }
`,gt=class gt extends ct{constructor(e,r,s){super(K.Shadow,r,s),this.sceneDirectionalLight=e,this.type=K.Shadow,this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:[],depthStencilAttachment:{view:null,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},label:"Shadow Render Pass Cascade #0"}),this.outTextures.push(x.device.createTexture({label:"Directional Shadow Depth Texture",format:"depth32float",size:{width:gt.TEXTURE_SIZE,height:gt.TEXTURE_SIZE,depthOrArrayLayers:gt.TEXTURE_CASCADES_COUNT},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING})),ee.addTextureBytes(this.outTextures[0]),this.shadowTextureCascade0=this.outTextures[0].createView({baseArrayLayer:0,arrayLayerCount:1,dimension:"2d"}),this.shadowTextureCascade1=this.outTextures[0].createView({baseArrayLayer:1,arrayLayerCount:1,dimension:"2d"});const n=gr(te.Camera);this.shadowCameraCascade0BufferUniformValues=Qt(n.structs.Camera),this.shadowCameraCascade1BufferUniformValues=Qt(n.structs.Camera),this.shadowCameraCascade0GPUBuffer=x.device.createBuffer({label:"Shadow Camera GPU Buffer Cascade #0",size:this.shadowCameraCascade0BufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),ee.addBufferBytes(this.shadowCameraCascade0GPUBuffer),this.shadowCameraCascade1GPUBuffer=x.device.createBuffer({label:"Shadow Camera GPU Buffer Cascade #1",size:this.shadowCameraCascade1BufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),ee.addBufferBytes(this.shadowCameraCascade1GPUBuffer),this.shadowCameraCascade0BindGroup=x.device.createBindGroup({label:"Shadow Camera Bind Group Cascade #0",layout:$.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:this.shadowCameraCascade0GPUBuffer}}]}),this.shadowCameraCascade1BindGroup=x.device.createBindGroup({label:"Shadow Camera Bind Group Cascade #1",layout:$.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:this.shadowCameraCascade1GPUBuffer}}]});const i=gr(te.ShadowCascade);this.shadowCascadeView=Qt(i.structs.ShadowCascade),this.shadowCascadesBuffer=x.device.createBuffer({label:"Directional Shadow Cascade ProjView Matrices",size:gt.TEXTURE_CASCADES_COUNT*this.shadowCascadeView.arrayBuffer.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),ee.addBufferBytes(this.shadowCascadesBuffer)}set shadowMapSize(e){const r=this.outTextures[0];this.outTextures[0]=x.device.createTexture({label:"Directional Shadow Depth Texture",format:"depth32float",size:{width:e,height:e,depthOrArrayLayers:gt.TEXTURE_CASCADES_COUNT},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.shadowTextureCascade0=this.outTextures[0].createView({baseArrayLayer:0,arrayLayerCount:1,dimension:"2d"}),this.shadowTextureCascade1=this.outTextures[0].createView({baseArrayLayer:1,arrayLayerCount:1,dimension:"2d"}),ee.addTextureBytes(this.outTextures[0]),x.device.queue.onSubmittedWorkDone().then(()=>{ee.removeTextureBytes(r),r.destroy()})}destroy(){super.destroy(),ee.removeBufferBytes(this.shadowCascadesBuffer),ee.removeBufferBytes(this.shadowCameraCascade0GPUBuffer),ee.removeBufferBytes(this.shadowCameraCascade1GPUBuffer),this.shadowCascadesBuffer.destroy(),this.shadowCameraCascade0GPUBuffer.destroy(),this.shadowCameraCascade1GPUBuffer.destroy()}setCamera(e){return this.camera=e,this}getLightSpaceMatrix(){const e=this.camera.frustumCornersWorldSpace;let r=H.create(0,0,0);for(let X=0;X<e.length;X++){const Y=e[X];H.add(r,Y,r)}H.divScalar(r,e.length,r);let s=H.create(),n=H.create();H.normalize(this.sceneDirectionalLight.position,n),H.add(r,n,s);let i=ae.create();ae.lookAt(s,r,Ks.UP_VECTOR,i);let o=Number.MAX_VALUE,a=-o,c=Number.MAX_VALUE,m=-c,_=Number.MAX_VALUE,v=-_;for(let X=0;X<e.length;X++){const Y=e[X],Q=as.create();H.transformMat4(Y,i,Q),o=Math.min(o,Q[0]),a=Math.max(a,Q[0]),c=Math.min(c,Q[1]),m=Math.max(m,Q[1]),_=Math.min(_,Q[2]),v=Math.max(v,Q[2])}let P=-_;_=-v,v=P;const O=(v-_)/2;_-=O*5,v+=O*5;const D=ae.create();ae.ortho(o,a,c,m,_,v,D);const U=ae.create();return ae.mul(D,i,U),U}render(e,r,s){const n=this.camera.near,i=this.camera.far;this.camera.near=.1,this.camera.far=gt.TEXTURE_CASCADE_FAR_DISTANCES[0],this.camera.updateProjectionMatrix();const o=this.getLightSpaceMatrix();this.shadowCascadeView.set({projViewMatrix:o,distance:this.camera.far}),x.device.queue.writeBuffer(this.shadowCascadesBuffer,0,this.shadowCascadeView.arrayBuffer),this.shadowCameraCascade0BufferUniformValues.set({projectionViewMatrix:o}),x.device.queue.writeBuffer(this.shadowCameraCascade0GPUBuffer,0,this.shadowCameraCascade0BufferUniformValues.arrayBuffer),this.renderPassDescriptor.depthStencilAttachment.view=this.shadowTextureCascade0,this.renderPassDescriptor.label="Shadow Render Pass Cascade #0";const a=e.beginRenderPass(this.renderPassDescriptor);x.setActiveRenderPass(this.type,a),a.setBindGroup(Be.CameraPlusOptionalLights,this.shadowCameraCascade0BindGroup),x.ENABLE_DEBUG_GROUPS&&a.pushDebugGroup("Render Shadow Cascade #0"),r.renderOpaqueNodes(a),r.renderTransparentNodes(a),x.ENABLE_DEBUG_GROUPS&&a.popDebugGroup(),a.end(),this.camera.near=gt.TEXTURE_CASCADE_FAR_DISTANCES[0],this.camera.far=gt.TEXTURE_CASCADE_FAR_DISTANCES[1],this.camera.updateProjectionMatrix();const c=this.getLightSpaceMatrix();this.shadowCascadeView.set({projViewMatrix:c,distance:this.camera.far}),x.device.queue.writeBuffer(this.shadowCascadesBuffer,this.shadowCascadeView.arrayBuffer.byteLength*1,this.shadowCascadeView.arrayBuffer),this.shadowCameraCascade1BufferUniformValues.set({projectionViewMatrix:c}),x.device.queue.writeBuffer(this.shadowCameraCascade1GPUBuffer,0,this.shadowCameraCascade1BufferUniformValues.arrayBuffer),this.renderPassDescriptor.depthStencilAttachment.view=this.shadowTextureCascade1,this.renderPassDescriptor.label="Shadow Render Pass Cascade #1";const m=e.beginRenderPass(this.renderPassDescriptor);return x.setActiveRenderPass(this.type,m),x.ENABLE_DEBUG_GROUPS&&m.pushDebugGroup("Render Shadow Cascade #1"),m.setBindGroup(Be.CameraPlusOptionalLights,this.shadowCameraCascade1BindGroup),r.renderOpaqueNodes(m),r.renderTransparentNodes(m),x.ENABLE_DEBUG_GROUPS&&m.popDebugGroup(),m.end(),this.camera.near=n,this.camera.far=i,this.camera.updateProjectionMatrix(),this.postRender(e),this.outTextures}};gt.TEXTURE_SIZE=4098,gt.TEXTURE_CASCADES_COUNT=2,gt.TEXTURE_CASCADE_FAR_DISTANCES=[6,17,200];let On=gt;const mb=t=>tr`
  @group(0) @binding(0) var normalTexture: texture_2d<f32>;
  @group(0) @binding(1) var colorTexture: texture_2d<f32>;
  @group(0) @binding(2) var depthTexture: texture_depth_2d;
  @group(0) @binding(3) var aoTexture: texture_2d<f32>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  
  #if ${t===K.PointLightsLighting||t===K.PointLightsStencilMask||t===K.DirectionalAmbientLighting}
  @group(0) @binding(5) var<storage, read> lightsBuffer: array<Light>;
  @group(0) @binding(6) var<uniform> debugLightsInfo: LightSettings;
  #endif

  #if ${t===K.PointLightsNonCulledLighting}
  @group(1) @binding(0) var<uniform> cameraCulledPointLight: Light;
  #endif

  #if ${t===K.DirectionalAmbientLighting}
  @group(1) @binding(0) var<storage, read> shadowCascades: array<ShadowCascade, 2>;
  @group(1) @binding(1) var shadowMapSampler: sampler_comparison;
  @group(1) @binding(2) var shadowDepthTexture: texture_depth_2d_array;
  @group(1) @binding(3) var diffuseIBLTexture: texture_cube<f32>;
  @group(1) @binding(4) var specularIBLTexture: texture_cube<f32>;
  @group(1) @binding(5) var bdrfLutTexture: texture_2d<f32>;
  @group(1) @binding(6) var envTexSampler: sampler;
  @group(1) @binding(7) var<uniform> ssaoMixFactor: f32;
  #endif
`,Dn="integrateMain",Lo=t=>tr`
  ${te.VertexOutput}
  ${te.Light}
  ${te.Camera}
  ${te.Material}
  ${te.ShadowCascade}
  ${te.CommonHelpers}
  ${te.MathHelpers}

  ${pl(t)}
  ${pb}
  ${Cs}

  struct LightSettings {
    debugLights: f32,
    debugShadowCascadeLayer: f32
  };

  #if ${t===K.DirectionalAmbientLighting}
  const SHADOW_MAP_SIZE: f32 = ${On.TEXTURE_SIZE};
  #endif

  ${mb(t)}

  @fragment
  fn ${Dn}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    let encodedN = textureLoad(normalTexture, pixelCoords, 0).rg;
    let metallic = textureLoad(normalTexture, pixelCoords, 0).b;
    let roughness = textureLoad(normalTexture, pixelCoords, 0).a;
    let viewSpaceNormal = decodeNormal(encodedN);
    
    let albedo = textureLoad(colorTexture, pixelCoords, 0).xyz;
    let depth = textureLoad(depthTexture, pixelCoords, 0);
    
    let aoPixelCoords = vec2i(floor(coord.xy));
    let ao = textureLoad(aoTexture, aoPixelCoords, 0).r;
    // return vec4f(ao, ao, ao, 1);

    // return vec4f(viewSpaceNormal, 1.0);
    

    var material = Material();
    material.albedo = albedo;
    material.roughness = roughness;
    // return vec4f(vec3f(1 - metallic), 1);
    material.metallic = metallic;
    // material.ambientOcclusion = select(1.0, ao, pixelCoords.x > i32(textureDimensions(normalTexture).x / 2));

    #if ${t===K.DirectionalAmbientLighting}
    material.ambientOcclusion = mix(1.0, ao, ssaoMixFactor);
    #endif
    
    let viewSpacePos = calcViewSpacePos(camera, coord.xy, depth);
    
    let V = normalize(-viewSpacePos);

    #if ${t===K.DirectionalAmbientLighting}
    let worldSpacePos = calcWorldPos(camera, coord.xy, depth);
    let shadowLayerIdx = ShadowLayerIdxCalculate(worldSpacePos, camera, shadowCascades);
    let r = select(0.0, 1.0, shadowLayerIdx == 0);
    let g = select(0.0, 1.0, shadowLayerIdx == 1);
    let b = select(0.0, 1.0, shadowLayerIdx == 2);
    if (debugLightsInfo.debugShadowCascadeLayer == 1) {
      material.albedo = vec3f(r, g, b);
    }
    // TODO: Directional light is expected to be at index 0
    // Write a better mechanism for quering it
    let lightPosition = (camera.viewMatrix * (vec4f(lightsBuffer[0].position, 0))).xyz;
    // let shadow = 1.0;
    let shadow = ShadowCalculate(
      worldSpacePos,
      viewSpaceNormal,
      lightPosition,
      camera,
      SHADOW_MAP_SIZE,
      SHADOW_MAP_SIZE,
      shadowCascades,
      shadowDepthTexture,
      shadowMapSampler
    );
    #else
    let shadow = 1.0;
    #endif

    let opacity = 1.0;

    var color = PBRLighting(
      material,
      in.instanceId,
      viewSpacePos,
      viewSpaceNormal,
      V,
      shadow,
      opacity,
      #if ${t===K.PointLightsNonCulledLighting}
      cameraCulledPointLight.position,
      cameraCulledPointLight.radius,
      cameraCulledPointLight.color,
      cameraCulledPointLight.intensity,
      #elif ${t==K.DirectionalAmbientLighting}
      diffuseIBLTexture,
      specularIBLTexture,
      bdrfLutTexture,
      envTexSampler
      #endif
    );

    #if ${t===K.PointLightsLighting}
    let debugColor = vec4f(1.0, 0.0, 0.0, 1.0);
    return mix(color, debugColor, debugLightsInfo.debugLights);
    #else
    return color;
    #endif
  }
`,Qo=class Qo extends ct{constructor(e,r,s){super(e,r,s),this.gbufferCommonBindGroupLayoutEntries=[],this.gbufferTexturesBindGroupEntries=[],this._debugLightsMask=!1,this._debugShadowCascadeLayer=!1,this.gbufferCommonBindGroupLayoutEntries.push({binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:4,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}),(e===K.PointLightsLighting||e===K.DirectionalAmbientLighting||e===K.PointLightsStencilMask)&&(this.gbufferCommonBindGroupLayoutEntries.push({binding:5,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:6,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}})),this.gbufferCommonBindGroupLayout=x.device.createBindGroupLayout({label:"GBuffer Textures Bind Group",entries:this.gbufferCommonBindGroupLayoutEntries}),this.debugLightsBuffer=x.device.createBuffer({label:"Debug Lights GPUBuffer",size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),ee.addBufferBytes(this.debugLightsBuffer),new Float32Array(this.debugLightsBuffer.getMappedRange()).set(new Float32Array([0,0])),this.debugLightsBuffer.unmap(),this.gbufferTexturesBindGroupEntries.push({binding:0,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:1,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:2,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:3,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:4,resource:{buffer:null}}),(e===K.DirectionalAmbientLighting||e===K.PointLightsLighting||e===K.PointLightsStencilMask)&&(this.gbufferTexturesBindGroupEntries.push({binding:5,resource:{buffer:null}}),this.gbufferTexturesBindGroupEntries.push({binding:6,resource:{buffer:this.debugLightsBuffer}}))}set debugLightsMask(e){this._debugLightsMask=e,this.updateLightSettingsBuffer()}set debugShadowCascadeLayer(e){this._debugShadowCascadeLayer=e,this.updateLightSettingsBuffer()}updateLightSettingsBuffer(){x.device.queue.writeBuffer(this.debugLightsBuffer,0,new Float32Array([this._debugLightsMask?1:0,this._debugShadowCascadeLayer?1:0]))}updateGbufferBindGroupEntryAt(e,r){return this.gbufferTexturesBindGroupEntries[e].resource=r,this}recreateGBufferTexturesBindGroup(){this.gbufferTexturesBindGroup=x.device.createBindGroup({label:"G-Buffer Textures Input Bind Group",layout:this.gbufferCommonBindGroupLayout,entries:this.gbufferTexturesBindGroupEntries})}};Qo.RENDER_TARGETS=[{format:"rgba16float",blend:{color:{srcFactor:"one",dstFactor:"one",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one",operation:"add"}}}];let qr=Qo;class Oo extends qr{constructor(e,r,s){super(K.DirectionalAmbientLighting,r,s),this.shadowCascadesBuffer=e,this.dirLightShadowBindGroupEntries=[],this.shadowSampler=vt.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear",compare:"less"}),this.envSampler=vt.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear"}),this.ssaoMixBuffer=x.device.createBuffer({label:"Ambient SSAO Mix Factor Buffer",usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,size:1*Float32Array.BYTES_PER_ELEMENT,mappedAtCreation:!0}),ee.addBufferBytes(this.ssaoMixBuffer),new Float32Array(this.ssaoMixBuffer.getMappedRange()).set([1]),this.ssaoMixBuffer.unmap();const n=[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"comparison"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth",viewDimension:"2d-array"}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"cube"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"cube"}},{binding:5,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"2d"}},{binding:6,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:7,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}];this.dirLightShadowBindGroupLayout=x.device.createBindGroupLayout({label:"Direcional Light Shadow Bind Group Layout",entries:n});const i=x.device.createPipelineLayout({label:"Dir Light PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout,this.dirLightShadowBindGroupLayout]});this.dirLightShadowBindGroupEntries=[{binding:0,resource:{buffer:this.shadowCascadesBuffer}},{binding:1,resource:this.shadowSampler},{binding:2,resource:Ke.dummyTexture.createView({})},{binding:3,resource:Ke.dummyCubeTexture.createView({dimension:"cube"})},{binding:4,resource:Ke.dummyCubeTexture.createView({dimension:"cube"})},{binding:5,resource:Ke.dummyTexture.createView({})},{binding:6,resource:this.envSampler},{binding:7,resource:{buffer:this.ssaoMixBuffer}}];const o={label:"Directional Light Render PSO",layout:i,vertex:{module:$.createShaderModule(Tr,"Fullscreen Vertex Shader Module"),entryPoint:er},fragment:{module:$.createShaderModule(Lo(K.DirectionalAmbientLighting),"Directional Light Pass Shader Module"),entryPoint:Dn,targets:Oo.RENDER_TARGETS},depthStencil:{format:x.depthStencilFormat,depthWriteEnabled:!1}};this.renderPSO=$.createRenderPipeline(o),this.outTextures.push(x.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:r,height:s,depthOrArrayLayers:1},usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"GBuffer Result Texture"})),ee.addTextureBytes(this.outTextures[0]),this.outTextureView=this.outTextures[0].createView()}set ssaoMixFactor(e){x.device.queue.writeBuffer(this.ssaoMixBuffer,0,new Float32Array([e]))}setDiffuseIBLTexture(e){return this.dirLightShadowBindGroupEntries[3].resource=e.createView({dimension:"cube"}),this.recreateDirLightShadowBindGroup(),this}setSpecularIBLTexture(e){return this.dirLightShadowBindGroupEntries[4].resource=e.createView({dimension:"cube"}),this.recreateDirLightShadowBindGroup(),this}setBDRFLutTexture(e){return this.dirLightShadowBindGroupEntries[5].resource=e.createView({dimension:"2d"}),this.recreateDirLightShadowBindGroup(),this}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextureView,loadOp:"clear",clearValue:[0,0,0,1],storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Directional + Ambient Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!1,view:this.inputTextureViews[3],stencilLoadOp:"load",stencilStoreOp:"store"}}),this.renderPassDescriptor}recreateDirLightShadowBindGroup(){this.dirLightShadowBindGroup=x.device.createBindGroup({label:"Directional Ambient LightingSystem G-Buffer Directional Shadow Input Bind Group",layout:this.dirLightShadowBindGroupLayout,entries:this.dirLightShadowBindGroupEntries})}render(e,r,s){this.inputTextureViews.length||(this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView()),this.inputTextureViews.push(s[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(s[2].createView({aspect:"all"})),this.inputTextureViews.push(s[3].createView()),this.inputTextureViews.push(s[4].createView({dimension:"2d-array"})),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[2]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).updateGbufferBindGroupEntryAt(5,{buffer:r.lightingManager.gpuBuffer}).recreateGBufferTexturesBindGroup(),this.dirLightShadowBindGroupEntries[2].resource=this.inputTextureViews[5],this.recreateDirLightShadowBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor());return x.setActiveRenderPass(this.type,n),x.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Directional + Ambient LightingSystem"),x.bindRenderPSO(this.renderPSO),n.setBindGroup(0,this.gbufferTexturesBindGroup),n.setBindGroup(1,this.dirLightShadowBindGroup),n.draw(3),x.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}}class gb extends ct{constructor(e,r){super(K.Deferred,e,r),this.outTextures.push(x.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Normal + Metallic + Roughness + GBuffer Texture"})),this.outTextures.push(x.device.createTexture({dimension:"2d",format:"bgra8unorm",mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Color + Reflectance GBuffer Texture"})),this.outTextures.push(x.device.createTexture({dimension:"2d",format:"rg16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Velocity GBuffer Texture"})),this.outTextures.push(x.device.createTexture({dimension:"2d",format:x.depthStencilFormat,mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Depth + Stencil GBuffer Texture"}));for(const s of this.outTextures)ee.addTextureBytes(s)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextures[Vt.NormalMetallicRoughness].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"},{view:this.outTextures[Vt.ColorReflectance].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"},{view:this.outTextures[Vt.Velocity].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:e,depthStencilAttachment:{view:this.outTextures[3].createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1,stencilLoadOp:"clear",stencilStoreOp:"store",stencilClearValue:0},label:"GBuffer Render Pass"}),this.renderPassDescriptor}render(e,r,s){const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return x.setActiveRenderPass(this.type,i),x.ENABLE_DEBUG_GROUPS&&i.pushDebugGroup("Render G-Buffer"),i.setBindGroup(Be.CameraPlusOptionalLights,this.cameraBindGroup),i.setStencilReference(128),r.renderOpaqueNodes(i,this.camera),x.ENABLE_DEBUG_GROUPS&&i.popDebugGroup(),i.end(),this.postRender(e),this.outTextures}}const ml="copyDepth",yb=`

  @group(0) @binding(0) var sourceDepth: texture_depth_2d;
  @group(0) @binding(1) var destDepth: texture_storage_2d<r32float, write>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${ml}(
    @builtin(global_invocation_id) pos : vec3u
  ) {
    let texSize = textureDimensions(sourceDepth);
    
    if (any(pos.xy > texSize)) {
      return;
    }

    let src = textureLoad(sourceDepth, pos.xy, 0);
    textureStore(destDepth, pos.xy, vec4f(src));
  }

`,ar=class ar extends ct{constructor(e,r){super(K.CopyDepthForHiZ,e,r);const s=[{binding:0,texture:{sampleType:"depth"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"r32float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE}];this.bindGroupLayout=x.device.createBindGroupLayout({label:"Hi-Z Copy Depth Bind Group Layout",entries:s}),this.computePSO=$.createComputePipeline({label:"Hi-Z Copy Depth Compute PSO",layout:x.device.createPipelineLayout({label:"Hi-Z Copy Depth Compute PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:ml,module:$.createShaderModule(yb,"Hi-Z Depth Copy Compute Shader Module"),constants:{WORKGROUP_SIZE_X:ar.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:ar.COMPUTE_WORKGROUP_SIZE_Y}}}),this.outTextures.push(x.device.createTexture({label:"Hi-Z Depth Texture",size:{width:e,height:r},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING,format:"r32float",mipLevelCount:hr(e,r)})),ee.addTextureBytes(this.outTextures[0])}createComputePassDescriptor(){return this.computePassDescriptor?this.computePassDescriptor:(this.computePassDescriptor={label:"Copy Hi-Z Depth Compute Pass"},this.computePassDescriptor)}render(e,r,s){if(!this.inputTextureViews.length){this.inputTextureViews.push(s[0].createView({aspect:"depth-only"}));const a=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.outTextures[0].createView({baseMipLevel:0,mipLevelCount:1})}];this.bindGroup=x.device.createBindGroup({label:"Hi-Z Depth Copy Bind Group",layout:this.bindGroupLayout,entries:a})}const n=e.beginComputePass(this.createComputePassDescriptor());n.setPipeline(this.computePSO),n.setBindGroup(0,this.bindGroup);const i=Math.ceil(this.outTextures[0].width/ar.COMPUTE_WORKGROUP_SIZE_X),o=Math.ceil(this.outTextures[0].height/ar.COMPUTE_WORKGROUP_SIZE_Y);return n.dispatchWorkgroups(i,o,1),n.end(),this.postRender(e),this.outTextures}};ar.COMPUTE_WORKGROUP_SIZE_X=8,ar.COMPUTE_WORKGROUP_SIZE_Y=8;let Do=ar;const gl="computeHiZMips",_b=`
  @group(0) @binding(0) var prevMipLevel: texture_2d<f32>;
  @group(0) @binding(1) var nextMipLevel: texture_storage_2d<r32float, write>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;  

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${gl}(@builtin(global_invocation_id) pos : vec3u) {
    let texSize = textureDimensions(prevMipLevel);
    if (any(pos.xy > texSize)) {
      return;
    }

    let depthDim = vec2f(textureDimensions(prevMipLevel).xy);
    let outDepthDim = vec2f(textureDimensions(nextMipLevel).xy);

    let ratio = depthDim / outDepthDim;

    let vReadCoord = vec2u(pos.x << 1, pos.y << 1);
    let vWriteCoord = pos.xy;

    let depthSamples = vec4f(
      textureLoad(prevMipLevel, vReadCoord, 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(1, 0), 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(0, 1), 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(1, 1), 0).r
    );

    var minDepth = min(
      depthSamples.x,
      min(
        depthSamples.y,
        min(depthSamples.z, depthSamples.w)
      )
    );

    let needExtraSampleX = ratio.x > 2.01;
    let needExtraSampleY = ratio.y > 2.01;

    minDepth = select(
      minDepth,
      min(
        minDepth,
        min(
          textureLoad(prevMipLevel, vReadCoord + vec2u(2, 0), 0).r,
          textureLoad(prevMipLevel, vReadCoord + vec2u(2, 1), 0).r
        )
      ),
      needExtraSampleX
    );
    minDepth = select(
      minDepth,
      min(
        minDepth,
        min(
          textureLoad(prevMipLevel, vReadCoord + vec2u(0, 2), 0).r,
          textureLoad(prevMipLevel, vReadCoord + vec2u(1, 2), 0).r
        )
      ),
      needExtraSampleY
    );
    minDepth = select(
      minDepth,
      min(
        minDepth,
        textureLoad(prevMipLevel, vReadCoord + vec2u(2, 2), 0).r
      ),
      needExtraSampleX && needExtraSampleY
    );
    
    textureStore(nextMipLevel, pos.xy, vec4f(minDepth));

  }
`,Ft=class Ft extends ct{constructor(e,r){super(K.HiZ,e,r),this.mipTexSizes=[],this.mipTexViews=[];const s=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"unfilterable-float"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"r32float",viewDimension:"2d"}}];this.bindGroupLayout=x.device.createBindGroupLayout({label:"Hi-Z Bind Group Layout",entries:s}),this.computePSO=$.createComputePipeline({label:"Hi-Z Compute PSO",layout:x.device.createPipelineLayout({label:"Hi-Z Compute PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:gl,module:$.createShaderModule(_b,"Compute Hi-Z Shader Module"),constants:{WORKGROUP_SIZE_X:Ft.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:Ft.COMPUTE_WORKGROUP_SIZE_Y}}})}createComputePassDescriptor(){return this.computePassDescriptor?this.computePassDescriptor:(this.computePassDescriptor={label:"Hi-Z Depth Mip Compute Pass"},this.computePassDescriptor)}render(e,r,s){const n=s[0].mipLevelCount,i=s[0].width,o=s[0].height;if(!this.mipTexSizes.length){this.mipTexSizes.push(dt.create(i,o));for(let _=1;_<n;_++){const v=this.mipTexSizes[_-1],P=dt.divScalar(v,2);this.mipTexSizes.push(P)}}const a={baseMipLevel:0,mipLevelCount:1,dimension:"2d",format:s[0].format};if(!this.mipTexViews.length)for(let _=0;_<n;_++)a.label=`Hi-Z Depth Mip Level ${_}`,a.baseMipLevel=_,this.mipTexViews.push(s[0].createView(a));const c=[{binding:0,resource:null},{binding:1,resource:null}],m=e.beginComputePass(this.createComputePassDescriptor());m.setPipeline(this.computePSO);for(let _=1;_<n;_++){const v=this.mipTexSizes[_][0],P=this.mipTexSizes[_][1],O=(v+Ft.COMPUTE_WORKGROUP_SIZE_X-1)/Ft.COMPUTE_WORKGROUP_SIZE_X,D=(P+Ft.COMPUTE_WORKGROUP_SIZE_Y-1)/Ft.COMPUTE_WORKGROUP_SIZE_Y;c[0].resource=this.mipTexViews[_-1],c[1].resource=this.mipTexViews[_];const U=x.device.createBindGroup({layout:this.bindGroupLayout,entries:c});m.setBindGroup(0,U),m.dispatchWorkgroups(O,D,1)}return m.end(),this.postRender(e),s}};Ft.COMPUTE_WORKGROUP_SIZE_X=8,Ft.COMPUTE_WORKGROUP_SIZE_Y=8;let Io=Ft;const In="pointLightVertex",Fo=t=>tr`

  ${te.VertexInput}
  ${te.VertexOutput}
  ${te.Camera}
  ${te.Light}

  #if ${t===K.PointLightsStencilMask}
  @group(0) @binding(0) var<uniform> camera: Camera;
  @group(0) @binding(1) var<storage, read> lightsBuffer: array<Light>;
  #else
  @group(0) @binding(0) var normalTexture: texture_2d<f32>;
  @group(0) @binding(1) var colorTexture: texture_2d<f32>;
  @group(0) @binding(2) var depthTexture: texture_depth_2d;
  @group(0) @binding(3) var aoTexture: texture_2d<f32>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  #endif

  #if ${t===K.PointLightsLighting||t===K.DirectionalAmbientLighting}
  @group(0) @binding(5) var<storage, read> lightsBuffer: array<Light>;
  @group(0) @binding(6) var<uniform> debugLights: f32;
  #endif

  #if ${t===K.PointLightsNonCulledLighting}

  @group(1) @binding(0) var<uniform> cameraCulledPointLight: Light;

  #endif

  @vertex
  fn ${In}(
    @builtin(instance_index) instanceId: u32,
    in: VertexInput
  ) -> VertexOutput {
    #if ${t===K.PointLightsNonCulledLighting}
      let light = cameraCulledPointLight;
      let trueInstanceId = 0u;
    #else
      let trueInstanceId = instanceId;
      let light = lightsBuffer[trueInstanceId];
    #endif

    var position = in.position;
    position *= vec4f(vec3f(light.radius), 1.0);
    position += vec4f(light.position, 0.0);
    let pos = camera.projectionViewMatrix * position;

    var out: VertexOutput;
    out.position = pos;
    out.instanceId = trueInstanceId;
    return out;
  }
`;class bb extends qr{setCamera(e){return this.camera=e,this.lightsMaskBindGroupEntries[0].resource={buffer:e.gpuBuffer},this}setLightsBuffer(e){return this.lightsMaskBindGroupEntries[1].resource={buffer:e},this}updateLightsMaskBindGroup(){return this.lightsMaskBindGroup=x.device.createBindGroup({layout:this.lightsMaskBindGroupLayout,entries:this.lightsMaskBindGroupEntries}),this}constructor(e,r){super(K.PointLightsStencilMask,e,r),this.lightsMaskBindGroupEntries=[{binding:0,resource:null},{binding:1,resource:null}];const s=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}];this.lightsMaskBindGroupLayout=x.device.createBindGroupLayout({label:"Light Masking Bind Group",entries:s});const n={label:"Point Light Mask PSO",layout:x.device.createPipelineLayout({label:"Point Lights Mask Render PSO Layout",bindGroupLayouts:[this.lightsMaskBindGroupLayout]}),vertex:{module:$.createShaderModule(Fo(K.PointLightsStencilMask),"Point Light Mask Pass Vertex Shader"),entryPoint:In,buffers:ze.defaultLayout,constants:{}},depthStencil:{format:x.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal",stencilReadMask:0,stencilWriteMask:255,stencilBack:{compare:"always",depthFailOp:"increment-wrap",failOp:"keep",passOp:"keep"},stencilFront:{compare:"always",depthFailOp:"decrement-wrap",failOp:"keep",passOp:"keep"}},primitive:{cullMode:"none"}};this.renderPSO=$.createRenderPipeline(n)}createRenderPassDescriptor(){return this.renderPassDescriptor?this.renderPassDescriptor:(this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Point Lights Mask Stencil Pass",colorAttachments:[],depthStencilAttachment:{view:this.inputTextureViews[0],depthLoadOp:"load",depthStoreOp:"store",stencilLoadOp:"clear",stencilStoreOp:"store",stencilClearValue:0}}),this.renderPassDescriptor)}render(e,r,s){this.inputTextureViews.length||this.inputTextureViews.push(s[0].createView());const n=e.beginRenderPass(this.createRenderPassDescriptor());return x.setActiveRenderPass(this.type,n),x.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Point Lights Stencil Mask"),x.bindRenderPSO(this.renderPSO),n.setStencilReference(128),n.setBindGroup(0,this.lightsMaskBindGroup),n.setVertexBuffer(0,It.pointLightSphereGeometry.vertexBuffers[0]),n.setIndexBuffer(It.pointLightSphereGeometry.indexBuffer,Je.INDEX_FORMAT),n.drawIndexed(It.pointLightSphereGeometry.indexCount,r.lightingManager.pointLightsCount,0,0,1),x.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),[s[0]]}}const Rr=class Rr extends qr{constructor(e,r){super(K.PointLightsNonCulledLighting,e,r);const s=x.device.createPipelineLayout({label:"Render Non-Instanced Non-Culled Point Lights PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout,zt.bindGroupLayout]}),n={label:Rr.FRONT_FACE_RENDER_PSO_LABEL,layout:s,vertex:{module:$.createShaderModule(Fo(K.PointLightsNonCulledLighting),"Non-Instanced Non-Culled Point Lights Vertex Shader"),entryPoint:In,buffers:ze.defaultLayout},fragment:{module:$.createShaderModule(Lo(K.PointLightsNonCulledLighting)),entryPoint:Dn,targets:Rr.RENDER_TARGETS},depthStencil:{format:x.depthStencilFormat,depthWriteEnabled:!1},primitive:{cullMode:"back"}};this.frontFaceCullRenderPSO=$.createRenderPipeline(n),n.label=Rr.BACK_FACE_RENDER_PSO_LABEL,n.primitive.cullMode="front",this.backFaceCullRenderPSO=$.createRenderPipeline(n)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[5],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Non-Instanced Non-Culled Point Lights Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!0,view:this.inputTextureViews[2]}}),this.renderPassDescriptor}render(e,r,s){this.inputTextureViews.length||(this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView()),this.inputTextureViews.push(s[2].createView({aspect:"all"})),this.inputTextureViews.push(s[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(s[3].createView()),this.inputTextureViews.push(s[4].createView()),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[3]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).recreateGBufferTexturesBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor()),i=It.pointLightSphereGeometry.indexBuffer,o=It.pointLightSphereGeometry.vertexBuffers[0],a=It.pointLightSphereGeometry.indexCount;n.setIndexBuffer(i,Je.INDEX_FORMAT),n.setVertexBuffer(0,o),n.setBindGroup(0,this.gbufferTexturesBindGroup);let c=!1;for(const m of r.lightingManager.cameraFaceCulledPointLights)H.dist(m.position,this.camera.position)>m.radius+.1?(c||n.setPipeline(this.frontFaceCullRenderPSO),c=!0,c=!1):(n.setPipeline(this.backFaceCullRenderPSO),c=!1,c=!0),n.setBindGroup(1,m.bindGroup),n.drawIndexed(a);return n.end(),this.postRender(e),[s[4]]}};Rr.FRONT_FACE_RENDER_PSO_LABEL="Render Non-Instanced Non-Culled Point Lights Front Face PSO Descriptor",Rr.BACK_FACE_RENDER_PSO_LABEL="Render Non-Instanced Non-Culled Point Lights Back Face PSO Descriptor";let Uo=Rr;class ko extends qr{constructor(e,r){super(K.PointLightsLighting,e,r);const s=x.device.createPipelineLayout({label:"Render Lights PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout]}),n={compare:"less",failOp:"keep",depthFailOp:"keep",passOp:"keep"},i={label:"Point Light Render PSO",layout:s,vertex:{module:$.createShaderModule(Fo(K.PointLightsLighting),"Point Light Render Pass Vertex Shader"),entryPoint:In,buffers:ze.defaultLayout,constants:{}},fragment:{module:$.createShaderModule(Lo(K.PointLightsLighting),"Point Light Render Pass Fragment Shader"),entryPoint:Dn,targets:ko.RENDER_TARGETS},depthStencil:{format:x.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal",stencilReadMask:255,stencilWriteMask:0,stencilBack:n,stencilFront:n},primitive:{cullMode:"back"}};this.renderPSO=$.createRenderPipeline(i)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[5],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Point Lights Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!1,view:this.inputTextureViews[2],stencilLoadOp:"load",stencilStoreOp:"store"}}),this.renderPassDescriptor}render(e,r,s){this.inputTextureViews.length||(this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView()),this.inputTextureViews.push(s[2].createView({aspect:"all"})),this.inputTextureViews.push(s[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(s[3].createView()),this.inputTextureViews.push(s[4].createView()),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[3]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).updateGbufferBindGroupEntryAt(5,{buffer:r.lightingManager.gpuBuffer}).recreateGBufferTexturesBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor());return x.setActiveRenderPass(this.type,n),x.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Point LightingSystem"),x.bindRenderPSO(this.renderPSO),n.setBindGroup(0,this.gbufferTexturesBindGroup),n.setVertexBuffer(0,It.pointLightSphereGeometry.vertexBuffers[0]),n.setIndexBuffer(It.pointLightSphereGeometry.indexBuffer,Je.INDEX_FORMAT),n.drawIndexed(It.pointLightSphereGeometry.indexCount,r.lightingManager.pointLightsCount,0,0,1),x.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),[s[4]]}}const yl="main",xb=t=>`
  ${te.Camera}

  struct SSRSettings {
    isHiZ: i32,
    maxIterations: i32,
    debugMissedIntersections: i32
  };

  @group(0) @binding(0) var sceneTexture: texture_2d<f32>;
  @group(0) @binding(1) var normalMetallicRoughnessTexture: texture_2d<f32>;
  @group(0) @binding(2) var albedoReflectanceTexture: texture_2d<f32>;
  @group(0) @binding(3) var depthTexture: texture_2d<f32>;
  @group(0) @binding(4) var outTexture: texture_storage_2d<${t}, write>;
  @group(0) @binding(5) var<uniform> camera: Camera;
  @group(0) @binding(6) var<uniform> settings: SSRSettings;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  ${Cs}

  const MAX_THICKNESS = 0.001;

  fn ComputePosAndReflection(
    tid: vec2u,
    viewNormal: vec3f,
    projectionMatrix: mat4x4f,
    inverseProjectionMatrix: mat4x4f,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    outSamplePosInTexSpace: ptr<function, vec3f>,
    outReflDirInTexSpace: ptr<function, vec3f>,
    outMaxDistance: ptr<function, f32>
  ) {
    let sampleDepth = textureLoad(depthTexture, tid, 0).r;
    var samplePosClipSpace = vec4f(
      ((f32(tid.x) + 0.5) / f32(viewportWidth)) * 2 - 1.0,
      ((f32(tid.y) + 0.5) / f32(viewportHeight)) * 2 - 1.0,
      sampleDepth,
      1
    );
    samplePosClipSpace.y *= -1;
    var samplePosViewSpace = inverseProjectionMatrix * samplePosClipSpace;
    samplePosViewSpace /= samplePosViewSpace.w;
    let vCamToSampleViewSpace = normalize(samplePosViewSpace.xyz);
    let vReflectionViewSpace = vec4f(reflect(vCamToSampleViewSpace.xyz, viewNormal.xyz), 0.0);

    var vReflectionEndPosViewSpace = samplePosViewSpace + vReflectionViewSpace * 1000;
    // vReflectionEndPosViewSpace /= select(1.0, vReflectionEndPosViewSpace.z, vReflectionEndPosViewSpace.z > 0.0);
    var vReflectionEndPosClipSpace = projectionMatrix * vec4f(vReflectionEndPosViewSpace.xyz, 1.0);
    vReflectionEndPosClipSpace /= vReflectionEndPosClipSpace.w;

    let vReflectionDir = normalize((vReflectionEndPosClipSpace - samplePosClipSpace).xyz);

    // transform to texture space
    (*outSamplePosInTexSpace) = vec3f(
      samplePosClipSpace.xy * vec2f(0.5, -0.5) + vec2f(0.5, 0.5),
      samplePosClipSpace.z
    );

    (*outReflDirInTexSpace) = vec3f(
      vReflectionDir.xy * vec2f(0.5, -0.5),
      vReflectionDir.z
    );

    (*outMaxDistance) = select(-outSamplePosInTexSpace.x / outReflDirInTexSpace.x, (1 - outSamplePosInTexSpace.x) / outReflDirInTexSpace.x, outReflDirInTexSpace.x >= 0);
    (*outMaxDistance) = min(*outMaxDistance, select((1 - outSamplePosInTexSpace.y) / outReflDirInTexSpace.y, -outSamplePosInTexSpace.y / outReflDirInTexSpace.y, outReflDirInTexSpace.y < 0));
    (*outMaxDistance) = min(*outMaxDistance, select((1 - outSamplePosInTexSpace.z) / outReflDirInTexSpace.z, -outSamplePosInTexSpace.z / outReflDirInTexSpace.z, outReflDirInTexSpace.z < 0));
  }

  @must_use
  fn FindIntersectionLinear(
    samplePosInTexSpace: vec3f,
    reflDirInTexSpace: vec3f,
    maxTraceDistance: f32,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    intersection: ptr<function, vec3f>
  ) -> f32 {
    let vReflectionEndPosTexSpace = samplePosInTexSpace + reflDirInTexSpace * maxTraceDistance;
    var dp = vReflectionEndPosTexSpace.xyz - samplePosInTexSpace.xyz;
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let sampleScreenPos = vec2i(samplePosInTexSpace.xy * viewSize);
    let endPosScreenPos = vec2i(vReflectionEndPosTexSpace.xy * viewSize);
    let dp2 = endPosScreenPos - sampleScreenPos;
    let maxDist = max(abs(dp2.x), abs(dp2.y));
    dp /= f32(maxDist);

    var rayPosTexSpace = vec4f(samplePosInTexSpace.xyz + dp, 0);
    let rayDirTexSpace = vec4f(dp.xyz, 0);
    let rayPosStartTexSpace = rayPosTexSpace;

    var hitIndex = -1;
    for (var i = 0; i < maxDist && i < settings.maxIterations; i += 4) {
      let rayPosTexSpace0 = rayPosTexSpace + rayDirTexSpace * 0;
      let rayPosTexSpace1 = rayPosTexSpace + rayDirTexSpace * 1;
      let rayPosTexSpace2 = rayPosTexSpace + rayDirTexSpace * 2;
      let rayPosTexSpace3 = rayPosTexSpace + rayDirTexSpace * 3;

      let depth0 = textureLoad(depthTexture, vec2u(rayPosTexSpace0.xy * viewSize), 0).r;
      let depth1 = textureLoad(depthTexture, vec2u(rayPosTexSpace1.xy * viewSize), 0).r;
      let depth2 = textureLoad(depthTexture, vec2u(rayPosTexSpace2.xy * viewSize), 0).r;
      let depth3 = textureLoad(depthTexture, vec2u(rayPosTexSpace3.xy * viewSize), 0).r;

      var thickness = 0.0;

      thickness = rayPosTexSpace0.z - depth0;
      hitIndex = select(hitIndex, i + 0, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace1.z - depth1;
      hitIndex = select(hitIndex, i + 1, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace2.z - depth2;
      hitIndex = select(hitIndex, i + 2, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace3.z - depth3;
      hitIndex = select(hitIndex, i + 3, thickness >= 0 && thickness < MAX_THICKNESS);

      if (hitIndex != -1) {
        break;
      }

      rayPosTexSpace = rayPosTexSpace3 + rayDirTexSpace;
    }

    let intersected = hitIndex >= 0;
    (*intersection) = rayPosStartTexSpace.xyz + rayDirTexSpace.xyz * f32(hitIndex);

    return select(0.0, 1.0, intersected);
  }

  @must_use
  fn getCellCount(mipLevel: i32, depthTexture: texture_2d<f32>) -> vec2f {
    return vec2f(textureDimensions(depthTexture, mipLevel));
  }

  @must_use
  fn getCell(pos: vec2f, cell_count: vec2f) -> vec2f {
    return vec2f(floor(pos * cell_count));
  }

  @must_use
  fn intersectDepthPlane(o: vec3f, d: vec3f, z: f32) -> vec3f {
	  return o + d * z;
  }

  @must_use
  fn intersectCellBoundary(
    o: vec3f,
    d: vec3f,
    cell: vec2f,
    cellCount: vec2f,
    crossStep: vec2f,
    crossOffset: vec2f
  ) -> vec3f {
    var intersection = vec3f(0.0);
    
    let index = cell + crossStep;
    var boundary = index / cellCount;
    boundary += crossOffset;
    
    var delta = boundary - o.xy;
    delta /= d.xy;
    let t = min(delta.x, delta.y);
    
    intersection = intersectDepthPlane(o, d, t);
    
    return intersection;
  }

  @must_use
  fn getMinimumDepthPlane(
    p: vec2f,
    mipLevel: i32,
    depthTexture: texture_2d<f32>
  ) -> f32 {
    return textureLoad(depthTexture, vec2u(p), mipLevel).r;
  }

  @must_use
  fn crossedCellBoundary(oldCellIndex: vec2f, newCellIndex: vec2f) -> bool {
	  return (oldCellIndex.x != newCellIndex.x) || (oldCellIndex.y != newCellIndex.y);
  }

  @must_use
  fn FindIntersectionHiZ(
    samplePosInTexSpace: vec3f,
    reflDirInTexSpace: vec3f,
    maxTraceDistance: f32,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    intersection: ptr<function, vec3f>
  ) -> f32 {
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let maxLevel = textureNumLevels(depthTexture) - 1;

    var crossStep = vec2f(
      select(-1.0, 1.0, reflDirInTexSpace.x >= 0),
      select(-1.0, 1.0, reflDirInTexSpace.y >= 0)
    );
    let crossOffset = crossStep / viewSize / 128.0;
    crossStep = saturate(crossStep);
    
    var ray = samplePosInTexSpace.xyz;
    let minZ = ray.z;
    let maxZ = ray.z + reflDirInTexSpace.z * maxTraceDistance;
    let deltaZ = (maxZ - minZ);

    let o = ray;
    let d = reflDirInTexSpace * maxTraceDistance;

    let startLevel = 2;
    let stopLevel = 0;

    let startCellCount = getCellCount(startLevel, depthTexture);
	
    let rayCell = getCell(ray.xy, startCellCount);
    ray = intersectCellBoundary(
      o,
      d,
      rayCell,
      startCellCount,
      crossStep,
      crossOffset * 64
    );

    var level = startLevel;
    var iter = 0;
    let isBackwardRay = reflDirInTexSpace.z < 0;
    let rayDir = select(1.0, -1.0, isBackwardRay);

    while(level >= stopLevel && ray.z * rayDir <= maxZ * rayDir && iter < settings.maxIterations) {
      let cellCount = getCellCount(level, depthTexture);
      let oldCellIdx = getCell(ray.xy, cellCount);
      let cellMinZ = getMinimumDepthPlane((oldCellIdx + 0.5), level, depthTexture);
      let tmpRay = select(
        ray,
        intersectDepthPlane(o, d, (cellMinZ - minZ) / deltaZ),
        (cellMinZ > ray.z) && !isBackwardRay
      );
      let newCellIdx = getCell(tmpRay.xy, cellCount);
      
      let thickness = select(0, (ray.z - cellMinZ), level == 0);
      let crossed = (isBackwardRay && (cellMinZ > ray.z)) ||
                    (thickness > (MAX_THICKNESS)) ||
                    crossedCellBoundary(oldCellIdx, newCellIdx);
      ray = select(
        tmpRay,
        intersectCellBoundary(o, d, oldCellIdx, cellCount, crossStep, crossOffset),
        crossed
      );
      level = select(
        level - 1,
        min(i32(maxLevel), level + 1),
        crossed
      );
      
      iter++;
    }

    let intersected = (level < stopLevel);
    (*intersection) = ray;
	
    let intensity = select(0.0, 1.0, intersected);
    
    return intensity;
  }

  @must_use
  fn ComputeReflectionColor(
    intensity: f32,
    intersection: vec3f,
    viewportWidth: u32,
    viewportHeight: u32,
    sceneTexture: texture_2d<f32>
  ) -> vec4f {
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let texCoords = vec2u(intersection.xy * viewSize);
    let ssrColor = textureLoad(sceneTexture, texCoords, 0);
    return ssrColor;
  }

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${yl}(@builtin(global_invocation_id) globalInvocationId : vec3u,) {
    let pos = globalInvocationId.xy;

    let encodedN = textureLoad(normalMetallicRoughnessTexture, pos, 0).rg;
    let N = decodeNormal(encodedN);
    let sceneColor = textureLoad(sceneTexture, pos, 0);
    let reflectanceMask = textureLoad(albedoReflectanceTexture, pos, 0).a;

    var reflectionColor = vec4f(0);
    var intensity = 0.0;

    let isReflectance = reflectanceMask != 0;
    if (isReflectance) {
      var samplePosInTexSpace = vec3f(0);
      var reflDirInTexSpace = vec3f(0);
      var maxTraceDistance = 0.0;

      ComputePosAndReflection(
        pos.xy,
        N,
        camera.projectionMatrix,
        camera.inverseProjectionMatrix,
        camera.viewportWidth,
        camera.viewportHeight,
        depthTexture,
        &samplePosInTexSpace,
        &reflDirInTexSpace,
        &maxTraceDistance
      );

      var intersection = vec3f(0);

      if (settings.isHiZ == 1) {
        intensity = FindIntersectionHiZ(
          samplePosInTexSpace,
          reflDirInTexSpace,
          maxTraceDistance,
          camera.viewportWidth,
          camera.viewportHeight,
          depthTexture,
          &intersection
        );
      } else {
        intensity = FindIntersectionLinear(
          samplePosInTexSpace,
          reflDirInTexSpace,
          maxTraceDistance,
          camera.viewportWidth,
          camera.viewportHeight,
          depthTexture,
          &intersection
        );
      }

      reflectionColor = ComputeReflectionColor(
        intensity,
        intersection,
        camera.viewportWidth,
        camera.viewportHeight,
        sceneTexture
      );
    }

    let combinedColor = sceneColor + reflectionColor;
    let finalColor = select(
      combinedColor,
      mix(
        select(combinedColor, vec4f(0, 1, 0, 1), isReflectance),
        combinedColor,
        intensity
      ),
      settings.debugMissedIntersections == 1
    );

    textureStore(outTexture, pos, finalColor);
    
  }
`,ur=class ur extends ct{constructor(e,r){super(K.Reflection,e,r),this._maxIterations=150,this._debugMissedIntersections=!1,this._isHiZ=!0;const s=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:3,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"unfilterable-float"}},{binding:4,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}];this.bindGroupLayout=x.device.createBindGroupLayout({label:"Reflection Pass ComputePSO Bind Group Layout",entries:s}),this.computePSO=$.createComputePipeline({label:"Reflection Pass Compute PSO",layout:x.device.createPipelineLayout({label:"Reflection PASS ComputePSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:yl,module:$.createShaderModule(xb("rgba16float")),constants:{WORKGROUP_SIZE_X:ur.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:ur.COMPUTE_WORKGROUP_SIZE_Y}}}),this.settingsBuffer=x.device.createBuffer({label:"SSR Settings Buffer",size:4*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),ee.addBufferBytes(this.settingsBuffer),new Int32Array(this.settingsBuffer.getMappedRange()).set(new Int32Array([this._isHiZ?1:0,this._maxIterations,this._debugMissedIntersections?1:0])),this.settingsBuffer.unmap(),this.outTextures.push(x.device.createTexture({label:"Reflection Texture",size:{width:e,height:r,depthOrArrayLayers:1},format:"rgba16float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC})),ee.addTextureBytes(this.outTextures[0])}set maxIterations(e){this._maxIterations=e,this.updateSettingsBuffer()}set debugMissedIntersections(e){this._debugMissedIntersections=e,this.updateSettingsBuffer()}set isHiZ(e){this._isHiZ=e,this.updateSettingsBuffer()}updateSettingsBuffer(){x.device.queue.writeBuffer(this.settingsBuffer,0,new Int32Array([this._isHiZ?1:0,this._maxIterations,this._debugMissedIntersections?1:0]))}destroy(){super.destroy(),ee.removeBufferBytes(this.settingsBuffer),this.settingsBuffer.destroy()}setCamera(e){return this.camera=e,this}createComputePassDescriptor(){return this.computePassDescriptor?this.computePassDescriptor:(this.computePassDescriptor={label:"Reflection Compute Pass Encoder"},this.computePassDescriptor)}render(e,r,s){if(!this.inputTextureViews.length){this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView()),this.inputTextureViews.push(s[2].createView()),this.inputTextureViews.push(s[3].createView());const a=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:this.inputTextureViews[2]},{binding:3,resource:this.inputTextureViews[3]},{binding:4,resource:this.outTextures[0].createView()},{binding:5,resource:{buffer:this.camera.gpuBuffer}},{binding:6,resource:{buffer:this.settingsBuffer}}];this.bindGroup=x.device.createBindGroup({label:"Compute Reflections Bind Group",entries:a,layout:this.bindGroupLayout})}const n=e.beginComputePass(this.createComputePassDescriptor());x.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Reflection Compute Pass"),n.setPipeline(this.computePSO),n.setBindGroup(0,this.bindGroup);const i=Math.ceil(this.outTextures[0].width/ur.COMPUTE_WORKGROUP_SIZE_X),o=Math.ceil(this.outTextures[0].height/ur.COMPUTE_WORKGROUP_SIZE_Y);return n.dispatchWorkgroups(i,o,1),x.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}};ur.COMPUTE_WORKGROUP_SIZE_X=8,ur.COMPUTE_WORKGROUP_SIZE_Y=8;let No=ur;const _l="fragBlurSSAO",Ab=`
  ${te.Camera}
  ${te.VertexOutput}

  @group(0) @binding(0) var ssaoTexture: texture_2d<f32>;

  @fragment
  fn ${_l}(in: VertexOutput) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    var result = 0.0;
    for (var y = -2; y < 2; y++) {
      for (var x = -2; x < 2; x++) {
        let offset = pixelCoords + vec2i(x, y);
        result += textureLoad(ssaoTexture, offset, 0).r;
      }
    }
    return vec4f(result / 16.0, 0, 0, 1);
  }
`;class Bb extends ct{constructor(e,r){super(K.SSAOBlur,e,r);const s=[{format:"r16float"}],n=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}];this.bindGroupLayout=x.device.createBindGroupLayout({label:"SSAO Blur Input Bind Group",entries:n}),this.renderPSO=$.createRenderPipeline({label:"SSAO Blur RenderPSO",layout:x.device.createPipelineLayout({label:"SSAO Blur RenderPSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),vertex:{module:$.createShaderModule(Tr),entryPoint:er},fragment:{module:$.createShaderModule(Ab),entryPoint:_l,targets:s}}),this.outTextures.push(x.device.createTexture({dimension:"2d",format:"r16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,label:"SSAO Blurred Texture"})),ee.addTextureBytes(this.outTextures[0]),this.outTextureView=this.outTextures[0].createView()}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{loadOp:"load",storeOp:"store",view:this.outTextureView}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"SSAO Blur Render Pass Descriptor",colorAttachments:e}),this.renderPassDescriptor}render(e,r,s){if(!this.inputTextureViews.length){this.inputTextureViews.push(s[0].createView());const i=[{binding:0,resource:this.inputTextureViews[0]}];this.bindGroup=x.device.createBindGroup({label:"SSAO Blur Bind Group",entries:i,layout:this.bindGroupLayout})}const n=e.beginRenderPass(this.createRenderPassDescriptor());return x.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin SSAO Blur"),n.setBindGroup(0,this.bindGroup),n.setPipeline(this.renderPSO),n.draw(3),x.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}}const bl="fragSSAO",wb=`
  ${te.Camera}
  ${te.VertexOutput}
  ${te.MathHelpers}

  ${Cs}

  struct Settings {
    kernelSize: u32,
    radius: f32,
    strength: f32
  };

  @group(0) @binding(0) var normalMetallicRoughnessTex: texture_2d<f32>;
  @group(0) @binding(1) var depthTexture: texture_depth_2d;
  @group(0) @binding(2) var noiseTexture: texture_2d<f32>;
  @group(0) @binding(3) var<storage, read> kernelBuffer: array<vec4f>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  @group(0) @binding(5) var<uniform> settings: Settings; 

  @fragment
  fn ${bl}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    let encodedN = textureLoad(normalMetallicRoughnessTex, pixelCoords, 0).rg;
    let viewNormal = decodeNormal(encodedN); 
    let centerDepth = textureLoad(depthTexture, pixelCoords, 0);
    let viewSpacePos = calcViewSpacePos(camera, coord.xy, centerDepth);

    let noiseScale = vec2i(textureDimensions(noiseTexture).xy);
    let sampleCoords = pixelCoords % noiseScale;
    var randomVec = textureLoad(noiseTexture, sampleCoords, 0).rgb;
    randomVec = (camera.viewMatrix * vec4f(randomVec, 0)).xyz;

    let viewTangent = normalize(randomVec - viewNormal * dot(randomVec, viewNormal));
    let viewBitangent = cross(viewNormal, viewTangent);
    let TBN = mat3x3f(viewTangent, viewBitangent, viewNormal);

    let kernelSize = settings.kernelSize;
    let radius = settings.radius;

    var occlusion = 0.0;

    let screenSize = vec2i(textureDimensions(depthTexture).xy);

    for (var i = 0u; i < kernelSize; i++) {
      var viewSamplePos = TBN * kernelBuffer[i].xyz;
      viewSamplePos = viewSpacePos + viewSamplePos * radius;

      let viewSampleDir = normalize(viewSamplePos - viewSpacePos);
      let NdotS = max(dot(viewNormal, viewSampleDir), 0.0);

      let clipPos = camera.projectionMatrix * vec4f(viewSamplePos, 1.0);
      let ndcPos = clipPos.xy / clipPos.w;

      let screenCoord = vec2i(vec2f(ndcPos.x * 0.5 + 0.5, -ndcPos.y * 0.5 + 0.5) * vec2f(screenSize));

      var sampleDepth = textureLoad(depthTexture, screenCoord, 0);
      sampleDepth = calcViewSpacePos(camera, vec2f(screenCoord), sampleDepth).z;
      
      let rangeCheck = smoothstep(0.0, 1.0, radius / abs(viewSpacePos.z - sampleDepth));

      occlusion += select(0.0, 1.0, sampleDepth > viewSamplePos.z) * rangeCheck * NdotS;
    }

    occlusion = 1 - (occlusion / f32(kernelSize));
    let finalOcclusion = pow(occlusion, settings.strength);

    return vec4f(finalOcclusion);
  }
`,qo=class qo extends ct{constructor(e,r){super(K.SSAO,e,r),this.gbufferTexturesBindGroupEntries=[],this.startKernelSize=8,this._kernelSize=128,this._radius=.5,this._strength=2;const s=this.kernelSize,n=new Float32Array(s*4);for(let c=0;c<s;c++){const m=as.create(Math.random()*2-1,Math.random()*2-1,Math.random(),0),_=c/s;as.scale(m,hd(.1,1,_*_),m),n.set(m,c*4)}this.kernelBuffer=x.device.createBuffer({label:"SSAO Kernel Buffer",mappedAtCreation:!0,size:s*4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE}),ee.addBufferBytes(this.kernelBuffer),new Float32Array(this.kernelBuffer.getMappedRange()).set(n),this.kernelBuffer.unmap(),this.settingsBuffer=x.device.createBuffer({label:"SSAO Settings GPU Buffer",size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM,mappedAtCreation:!0});const i=this.settingsBuffer.getMappedRange();new Uint32Array(i).set([this.startKernelSize]),new Float32Array(i).set([this.radius,this.strength],1),ee.addBufferBytes(this.settingsBuffer),this.settingsBuffer.unmap();const o=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}];this.gbufferCommonBindGroupLayout=x.device.createBindGroupLayout({label:"SSAO Input Bind Group",entries:o});const a=[{format:"r16float"}];this.renderPSO=$.createRenderPipeline({label:"SSAO RenderPSO",layout:x.device.createPipelineLayout({label:"SSAO RenderPSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout]}),vertex:{module:$.createShaderModule(Tr),entryPoint:er},fragment:{module:$.createShaderModule(wb),entryPoint:bl,targets:a}}),this.outTextures.push(x.device.createTexture({dimension:"2d",format:"r16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,label:"SSAO Texture"})),this.outTextureView=this.outTextures[0].createView(),ee.addTextureBytes(this.outTextures[0]),this.loadBlueNoiseTexture()}get kernelSize(){return this._kernelSize}set kernelSize(e){this._kernelSize=e,this.updateSettingsBufferKernelSize()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateSettingsBufferRadius()}get strength(){return this._strength}set strength(e){this._strength=e,this.updateSettingsBufferStrength()}updateSettingsBufferKernelSize(){x.device.queue.writeBuffer(this.settingsBuffer,0,new Uint32Array([this.kernelSize]))}updateSettingsBufferRadius(){x.device.queue.writeBuffer(this.settingsBuffer,Uint32Array.BYTES_PER_ELEMENT,new Float32Array([this.radius]))}updateSettingsBufferStrength(){x.device.queue.writeBuffer(this.settingsBuffer,Uint32Array.BYTES_PER_ELEMENT+Float32Array.BYTES_PER_ELEMENT,new Float32Array([this.strength]))}destroy(){var e;super.destroy(),this.noiseTexture&&ee.removeTextureBytes(this.noiseTexture),ee.removeBufferBytes(this.kernelBuffer),(e=this.noiseTexture)==null||e.destroy(),this.kernelBuffer.destroy()}async loadBlueNoiseTexture(){const e=await(await fetch("/textures/blueNoise.png")).blob(),r=await createImageBitmap(e);this.noiseTexture=x.device.createTexture({label:"Blue Noise Texture",format:"rgba32float",size:{width:r.width,height:r.height},usage:GPUTextureUsage.TEXTURE_BINDING}),x.device.queue.copyExternalImageToTexture({source:r},{texture:this.noiseTexture},{width:r.width,height:r.height}),r.close()}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{loadOp:"load",storeOp:"store",view:this.outTextureView}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"SSAO Render Pass Descriptor",colorAttachments:e}),this.renderPassDescriptor}render(e,r,s){var o;this.inputTextureViews.length||(this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView({aspect:"depth-only"})),this.gbufferTexturesBindGroupEntries=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:((o=this.noiseTexture)==null?void 0:o.createView())||Ke.dummyTexture.createView()},{binding:3,resource:{buffer:this.kernelBuffer}},{binding:4,resource:{buffer:this.camera.gpuBuffer}},{binding:5,resource:{buffer:this.settingsBuffer}}],this.gbufferTexturesBindGroup=x.device.createBindGroup({layout:this.gbufferCommonBindGroupLayout,entries:this.gbufferTexturesBindGroupEntries}));const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return x.setActiveRenderPass(this.type,i),x.ENABLE_DEBUG_GROUPS&&i.pushDebugGroup("Begin SSAO"),i.setBindGroup(0,this.gbufferTexturesBindGroup),x.bindRenderPSO(this.renderPSO),i.draw(3),x.ENABLE_DEBUG_GROUPS&&i.popDebugGroup(),i.end(),this.postRender(e),this.outTextures}};qo.SSAO_SCALE_FACTOR=.5;let Vo=qo;class vb extends ct{constructor(e,r){super(K.Skybox,e,r)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[0],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Skybox render Pass",colorAttachments:e,depthStencilAttachment:{stencilReadOnly:!0,view:this.inputTextureViews[1],depthLoadOp:"load",depthStoreOp:"store"}}),this.renderPassDescriptor}render(e,r,s){var i;this.inputTextureViews.length||(this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView()));const n=e.beginRenderPass(this.createRenderPassDescriptor());return x.setActiveRenderPass(this.type,n),x.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Skybox"),n.setBindGroup(Be.CameraPlusOptionalLights,this.cameraBindGroup),(i=r.skybox)==null||i.render(n),x.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),s}}const xl="main",Cb=`

  @group(0) @binding(0) var colorTexture: texture_2d<f32>;
  @group(0) @binding(1) var velocityTexture: texture_2d<f32>;
  @group(0) @binding(2) var historyTexture: texture_2d<f32>;
  @group(0) @binding(3) var<uniform> historyMixFactor: f32;

  @fragment
  fn ${xl}(@builtin(position) coord: vec4f) -> @location(0) vec4f {
    let pixelCoords = vec2i(floor(coord.xy));
    let currColor = textureLoad(colorTexture, pixelCoords, 0).xyz;
    let velocity = textureLoad(velocityTexture, pixelCoords, 0).xy;
    let prevousPixelPos = vec2i(floor(coord.xy - velocity));
    
    var history = textureLoad(historyTexture, prevousPixelPos, 0).xyz;

    let nearColor0 = textureLoad(colorTexture, pixelCoords + vec2i(1, 0), 0).xyz;
    let nearColor1 = textureLoad(colorTexture, pixelCoords + vec2i(0, 1), 0).xyz;
    let nearColor2 = textureLoad(colorTexture, pixelCoords + vec2i(-1, 0), 0).xyz;
    let nearColor3 = textureLoad(colorTexture, pixelCoords + vec2i(0, -1), 0).xyz;
    
    let boxMin = min(currColor, min(nearColor0, min(nearColor1, min(nearColor2, nearColor3))));
    let boxMax = max(currColor, max(nearColor0, max(nearColor1, max(nearColor2, nearColor3))));;
    
    history = clamp(history, boxMin, boxMax);

    var color = vec4f(mix(currColor, history, historyMixFactor), 1.0);

    return color;
  }
`,Gs=class Gs extends ct{constructor(e,r){super(K.TAAResolve,e,r),this.historyReset=!1;const s=$.createShaderModule(Tr),n=$.createShaderModule(Cb),i=[{format:"rgba16float"}],o=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{}}];this.texturesBindGroupLayout=x.device.createBindGroupLayout({label:"TAA Resolve Input Textures Bind Group",entries:o});const a={layout:x.device.createPipelineLayout({bindGroupLayouts:[this.texturesBindGroupLayout]}),vertex:{module:s,entryPoint:er},fragment:{module:n,entryPoint:xl,targets:i},primitive:{topology:"triangle-list",cullMode:"back"}};this.renderPSO=$.createRenderPipeline(a),this.outTextures.push(x.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC,label:"TAA Resolve Texture"})),this.outTextureView=this.outTextures[0].createView(),ee.addTextureBytes(this.outTextures[0]),this.sourceCopyTextureInfo={texture:this.outTextures[0],mipLevel:0,origin:{x:0,y:0,z:0}},this.outTextures.push(x.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,label:"TAA Resolve Texture"})),this.historyTextureView=this.outTextures[1].createView(),ee.addTextureBytes(this.outTextures[1]),this.destCopyTextureInfo={texture:this.outTextures[1],mipLevel:0,origin:{x:0,y:0,z:0}},this.copyTextureExtend={width:e,height:r,depthOrArrayLayers:1},this.historyMixFactorBuffer=x.device.createBuffer({label:"TAA History Mix Factor Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),new Float32Array(this.historyMixFactorBuffer.getMappedRange()).set([Gs.HISTORY_MIX_FACTOR]),ee.addBufferBytes(this.historyMixFactorBuffer),this.historyMixFactorBuffer.unmap()}destroy(){ee.removeBufferBytes(this.historyMixFactorBuffer),this.historyMixFactorBuffer.destroy()}resetHistory(){this.historyReset=!0,x.device.queue.writeBuffer(this.historyMixFactorBuffer,0,new Float32Array([0]))}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextureView,loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"TAA Resolve Pass",colorAttachments:e}),this.renderPassDescriptor}render(e,r,s){if(!this.inputTextureViews.length){this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView());const o=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:this.historyTextureView},{binding:3,resource:{buffer:this.historyMixFactorBuffer}}];this.textureBindGroup=x.device.createBindGroup({layout:this.texturesBindGroupLayout,entries:o})}const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return x.setActiveRenderPass(this.type,i),x.bindRenderPSO(this.renderPSO),i.setBindGroup(0,this.textureBindGroup),i.draw(3),i.end(),e.copyTextureToTexture(this.sourceCopyTextureInfo,this.destCopyTextureInfo,this.copyTextureExtend),this.postRender(e),this.historyReset&&(x.device.queue.onSubmittedWorkDone().then(()=>{x.device.queue.writeBuffer(this.historyMixFactorBuffer,0,new Float32Array([Gs.HISTORY_MIX_FACTOR]))}),this.historyReset=!1),this.outTextures}};Gs.HISTORY_MIX_FACTOR=.9;let Ho=Gs;class Tb extends ct{constructor(e,r){super(K.Transparent,e,r)}toggleDebugCamera(e){}setCamera(e){return this.camera=e,this}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[0],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Transparent Render Pass",colorAttachments:e,depthStencilAttachment:{view:this.inputTextureViews[1],depthLoadOp:"load",depthStoreOp:"store",stencilReadOnly:!0}}),this.renderPassDescriptor}render(e,r,s){this.inputTextureViews.length||(this.inputTextureViews.push(s[0].createView()),this.inputTextureViews.push(s[1].createView()));const n=e.beginRenderPass(this.createRenderPassDescriptor());return x.setActiveRenderPass(this.type,n),x.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Render Transparent Nodes"),this.cameraBindGroup=x.device.createBindGroup({label:"Camera Bind Group for: Transparent Pass",layout:$.defaultCameraPlusLightsBindGroupLayout,entries:[{binding:0,resource:{buffer:this.camera.gpuBuffer}},{binding:1,resource:{buffer:r.lightingManager.gpuBuffer}}]}),n.setBindGroup(Be.CameraPlusOptionalLights,this.cameraBindGroup),r.lightingManager.render(n),r.renderDebugMeshes(n),x.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),s}}const Ss="deferredPBRFrag",Fn=({hasPBRTextures:t=!1,isInstanced:e=!1}={})=>tr`
  ${te.Camera}
  ${te.VertexOutput}
  ${te.GBufferOutput}
  ${te.ModelUniform}
  ${te.InstanceInput}

  @group(${Be.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(${Be.Model}) @binding(0) var<uniform> model: ModelUniform;
  
  @group(${Be.PBRTextures}) @binding(${Js.Default}) var texSampler: sampler;
  @group(${Be.PBRTextures}) @binding(${De.Albedo}) var albedoTexture: texture_2d<f32>;
  @group(${Be.PBRTextures}) @binding(${De.Normal}) var normalTexture: texture_2d<f32>;
  @group(${Be.PBRTextures}) @binding(${De.MetallicRoughness}) var metallicRoughnessTexture: texture_2d<f32>;

  #if ${e}
  @group(${Be.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
  #endif

  ${Cs}

  @fragment
  fn ${Ss}(in: VertexOutput) -> GBufferOutput  {
    let uv = in.uv;
    
    var viewSpaceN = normalize(in.viewNormal);
    let viewSpaceT = normalize(in.viewTangent);
    let viewSpaceB = normalize(in.viewBitangent);
    let viewSpaceTBN = mat3x3f(viewSpaceT, viewSpaceB, viewSpaceN);

    // var textureNormal = textureSampleLevel(normalTexture, texSampler, uv, 5.0).rgb * 2 - 1;
    let textureNormal = textureSample(normalTexture, texSampler, uv).rgb * 2 - 1;
    
    if (${t}) {
      viewSpaceN = normalize(viewSpaceTBN * textureNormal);
    }

    var color = model.baseColor;
    if (${t}) {
      let texColor = textureSample(albedoTexture, texSampler, uv);
      if (texColor.a < 0.2) {
        discard;
      }
      color = texColor.rgb;
    }

    var out: GBufferOutput;

    #if ${e}
      var metallic = instanceInputs[in.instanceId].metallic;
      var roughness = instanceInputs[in.instanceId].roughness;
    #else
      var metallic = model.metallic;
      var roughness = model.roughness;
    #endif


    if (${t}) {
      let metallicRoughness = textureSample(metallicRoughnessTexture, texSampler, uv).rgb;
      metallic = metallicRoughness.b;
      roughness = metallicRoughness.g;
    }

    out.normalMetallicRoughness = vec4f(
      encodeNormal(viewSpaceN),
      metallic,
      roughness
    );
    
    out.color = vec4f(color, f32(model.isReflective));
    
    var oldPos = in.prevFrameClipPos;
    var newPos = in.currFrameClipPos;
    
    oldPos /= oldPos.w;
    oldPos.x = (oldPos.x+1)/2.0;
    oldPos.y = (oldPos.y+1)/2.0;
    oldPos.y = 1 - oldPos.y;
    
    newPos /= newPos.w;
    newPos.x = (newPos.x+1)/2.0;
    newPos.y = (newPos.y+1)/2.0;
    newPos.y = 1 - newPos.y;

    out.velocity = vec4f((newPos - oldPos).xy, 0, 1);
  
    return out;
  }
`,Al="forwardPBRFrag",Sb=({hasPBRTextures:t=!1,isInstanced:e=!1}={})=>tr`
  ${te.Camera}
  ${te.VertexOutput}
  ${te.GBufferOutput}
  ${te.ModelUniform}
  ${te.Material}
  ${te.InstanceInput}
  ${te.CommonHelpers}
  ${te.Light}

  @group(${Be.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(${Be.CameraPlusOptionalLights}) @binding(1) var<storage, read> lightsBuffer: array<Light>;

  @group(${Be.Model}) @binding(0) var<uniform> model: ModelUniform;

  @group(${Be.PBRTextures}) @binding(${Js.Default}) var texSampler: sampler;
  @group(${Be.PBRTextures}) @binding(${De.Albedo}) var albedoTexture: texture_2d<f32>;
  @group(${Be.PBRTextures}) @binding(${De.Normal}) var normalTexture: texture_2d<f32>;
  @group(${Be.PBRTextures}) @binding(${De.MetallicRoughness}) var metallicRoughnessTexture: texture_2d<f32>;

  #if ${e}
  @group(${Be.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
  #endif

  ${pl({isDeferred:!1,hasIBL:!1})}

  @fragment
  fn ${Al}(in: VertexOutput) -> @location(0) vec4f {
    let uv = in.uv;

    var N = normalize(in.viewNormal);
    let T = normalize(in.viewTangent);
    let B = normalize(in.viewBitangent);
    let TBN = mat3x3f(T, B, N);
    let textureNormal = textureSample(normalTexture, texSampler, uv).rgb * 2 - 1;
    if (${t}) {
      N = normalize(TBN * textureNormal);
    }

    #if ${e}
      var metallic = instanceInputs[in.instanceId].metallic;
      var roughness = instanceInputs[in.instanceId].roughness;
    #else
      var metallic = model.metallic;
      var roughness = model.roughness;
    #endif

    if (${t}) {
      let metallicRoughness = textureSample(metallicRoughnessTexture, texSampler, uv).rgb;
      metallic = metallicRoughness.b;
      roughness = metallicRoughness.g;
    }

    let modelTexColor = textureSample(albedoTexture, texSampler, uv).rgb;
    var color = vec4f(model.baseColor, 1);
    if (${t}) {
      color = textureSample(albedoTexture, texSampler, uv);
    }

    // if (color.a < 0.01) {
    //   discard;
    // }

    var material = Material();
    material.albedo = color.rgb;
    material.roughness = roughness;
    // return vec4f(vec3f(1 - metallic), 1);
    material.metallic = metallic;
    material.ambientOcclusion = 1.0;

    let V = normalize(camera.position - in.worldPosition);

    return PBRLighting(
      material,
      0,
      in.worldPosition,
      N,
      V,
      1,
      color.a
    );
  }
`,Kt="vertexMain",rr=({isInstanced:t,isShadow:e}={isInstanced:!1,isShadow:!1})=>tr`
    ${te.VertexInput}
    ${te.VertexOutput}
    ${te.ModelUniform}
    ${te.Camera}
    ${te.InstanceInput}

    @group(${Be.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
    @group(${Be.Model}) @binding(0) var<uniform> model: ModelUniform;
    
    @group(${Be.PBRTextures}) @binding(${De.Albedo}) var albedoTexture: texture_2d<f32>;
    @group(${Be.PBRTextures}) @binding(${De.Normal}) var normalTexture: texture_2d<f32>;

    #if ${t}
      @group(${Be.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
    #endif

    @vertex
    fn ${Kt}(
      @builtin(instance_index) instanceId: u32,
      in: VertexInput
    ) -> VertexOutput {
      var position = in.position;

      var worldMatrix: mat4x4f;

      #if ${!e}
      var prevWorldMatrix: mat4x4f;
      #endif

      #if ${t}
        worldMatrix = instanceInputs[instanceId].worldMatrix * model.worldMatrix;
        #if ${!e}
          prevWorldMatrix = instanceInputs[instanceId].worldMatrix * model.prevFrameWorldMatrix;
        #endif
      #else
        worldMatrix = model.worldMatrix;
        #if ${!e}
          prevWorldMatrix = model.prevFrameWorldMatrix;
        #endif
      #endif
      
      var out: VertexOutput;
      let worldPosition = worldMatrix * in.position;
      #if ${e}
        out.position = camera.projectionViewMatrix * worldPosition;
      #else
        out.position = camera.projectionViewMatrix * worldPosition;
        out.worldPosition = worldPosition.xyz;

        // var jitterOffset = camera.jitterOffset;
        // jitterOffset.x = ((jitterOffset.x - 0.5) / f32(camera.viewportWidth)) * 2;
        // jitterOffset.y = ((jitterOffset.y - 0.5) / f32(camera.viewportHeight)) * 2;

        out.position += vec4f(camera.jitterOffset * out.position.w, 0, 0);

        out.currFrameClipPos = out.position;
        out.prevFrameClipPos = camera.prevFrameProjectionViewMatrix * prevWorldMatrix * in.position;
        
        let viewSpaceNormMatrix = mat3x3f(
          camera.viewMatrix[0].xyz,
          camera.viewMatrix[1].xyz,
          camera.viewMatrix[2].xyz
        ) * model.normalMatrix;

        let viewTangent = normalize(viewSpaceNormMatrix * in.tangent.xyz);
        let viewNormal = normalize(viewSpaceNormMatrix * in.normal);
        let viewBitangent = normalize(cross(viewNormal, viewTangent)) * in.tangent.w;

        out.viewTangent = viewTangent;
        out.viewBitangent = viewBitangent;
        out.viewNormal = viewNormal;
        out.instanceId = instanceId;
        out.uv = in.uv;
      #endif

      return out;
    }
  `;let Un,kn,Nn,jo,zo,Jo,Ko,Xo;const Bl=Object.freeze({get defaultGLTFTransparentPBRMaterial(){return Xo||(Xo=new Jt({debugLabel:"Forward Pass Default PBR Material",vertexShaderSrc:rr(),vertexShaderEntryFn:Kt,vertexBuffers:ze.defaultGLTFLayout,fragmentShaderSrc:Sb({hasPBRTextures:!0}),fragmentShaderEntryFn:Al,targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}],bindGroupLayouts:[$.defaultCameraPlusLightsBindGroupLayout,$.defaultModelBindGroupLayout,$.defaultModelMaterialBindGroupLayout],depthStencilState:{format:Mr.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less"},primitive:{cullMode:"none"}}),Xo)},get defaultDeferredPBRMaterial(){if(Un)return Un;const t={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return Un=new Jt({debugLabel:"Deferred Pass Default PBR Material",vertexShaderSrc:rr(),vertexShaderEntryFn:Kt,vertexBuffers:ze.defaultLayout,fragmentShaderSrc:Fn(),fragmentShaderEntryFn:Ss,constants:{},targets:yr,depthStencilState:{format:Mr.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:t,stencilFront:t}}),Un},get defaultGLTFDeferredPBRMaterial(){if(kn)return kn;const t={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return kn=new Jt({debugLabel:"Deferred Pass Default PBR Material",vertexShaderSrc:rr(),vertexShaderEntryFn:Kt,vertexBuffers:ze.defaultGLTFLayout,fragmentShaderSrc:Fn(),fragmentShaderEntryFn:Ss,constants:{},targets:yr,depthStencilState:{format:Mr.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:t,stencilFront:t}}),kn},get defaultGLTFTexturedDeferredMaterial(){if(Nn)return Nn;const t={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return Nn=new Jt({debugLabel:"Default Textured Deferred PBR",vertexShaderSrc:rr(),vertexShaderEntryFn:Kt,vertexBuffers:ze.defaultGLTFLayout,fragmentShaderSrc:Fn({hasPBRTextures:!0}),fragmentShaderEntryFn:Ss,constants:{},targets:yr,depthStencilState:{format:Mr.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:t,stencilFront:t}}),Nn},get defaultDeferredInstancedMaterial(){return jo||(jo=new Jt({debugLabel:"Material",vertexShaderSrc:rr({isInstanced:!0}),vertexShaderEntryFn:Kt,fragmentShaderSrc:Fn(),fragmentShaderEntryFn:Ss,bindGroupLayouts:[$.defaultCameraBindGroupLayout,$.defaultModelBindGroupLayout,$.instancesBindGroupLayout],targets:yr}),jo)},get defaultShadowMaterial(){return Jo||(Jo=new Jt({debugLabel:"Default Shadow Material",vertexShaderSrc:rr(),vertexShaderEntryFn:Kt,vertexBuffers:ze.defaultLayout}),Jo)},get defaultGLTFShadowMaterial(){return zo||(zo=new Jt({debugLabel:"Default Shadow Material",vertexShaderSrc:rr({isShadow:!0}),vertexShaderEntryFn:Kt,vertexBuffers:ze.defaultGLTFLayout,primitive:{cullMode:"front"},depthStencilState:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}}),zo)},get defaultInstancedShadowMaterial(){return Ko||(Ko=new Jt({debugLabel:"Default Shadow Material",vertexShaderSrc:rr({isInstanced:!0}),vertexShaderEntryFn:Kt,bindGroupLayouts:[$.defaultCameraBindGroupLayout,$.defaultModelBindGroupLayout,$.defaultModelMaterialBindGroupLayout,$.instancesBindGroupLayout],depthStencilState:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}}),Ko)}}),Yn=class Yn extends x{constructor(){super(),this.scene=new j_,this.cpuAverage=new Ys,this.gpuAverage=new Ys,this.fpsDisplayAverage=new Ys,this.enableAnimation=!0,this.mainCamera=new vi(70,1,Za,eu),this.mainCamera.shouldJitter=!0,this.mainCamera.setPosition(4,3,0),this.mainCamera.setLookAt(0,2,0),this.mainCamera.updateViewMatrix(),this.mainCameraCtrl=new Th(this.mainCamera,document.body,x.$canvas),this.mainCameraCtrl.startTick(),this.debugCamera=new vi(70,1,Za,eu),this.debugCamera.setPosition(6,12,1),this.debugCamera.setLookAt(0,7,0),this.debugCamera.updateViewMatrix();const e=new Gh(mh,!0).getPoints(240);this.lightingManager=new To(e),this.scene.lightingManager=this.lightingManager,this.texturesDebugContainer=new wo,this.timingDebugContainer=new vo,this.scene.skybox=new cb;const r=new N_("/sponza/Sponza.gltf");this.scene.addChild(r),r.setPositionY(2).updateWorldMatrix(),Promise.all([Ke.load6SeparateHDRFacesAsCubeMapTexture(ph,512,!0,"Skybox Faces"),r.load()]).then(([s])=>{this.envDiffuseTexture=xo.encode(s),this.envSpecularTexture=Ao.encode(s,256),this.envBdrfLutTexture=bo.encode(),Cr.generateMipsForCubeTexture(this.envDiffuseTexture),this.scene.skybox.setTexture(this.envDiffuseTexture),this.renderPassComposer.getPass(K.DirectionalAmbientLighting).setDiffuseIBLTexture(this.envDiffuseTexture).setSpecularIBLTexture(this.envSpecularTexture).setBDRFLutTexture(this.envBdrfLutTexture),ee.removeTextureBytes(s),s.destroy(),r.setMaterial(Bl.defaultGLTFTexturedDeferredMaterial).setMaterial(Bl.defaultGLTFShadowMaterial,K.Shadow)})}set sunPositionX(e){this.lightingManager.sunPositionX=e}set sunPositionY(e){this.lightingManager.sunPositionY=e}set sunPositionZ(e){this.lightingManager.sunPositionZ=e}set sunIntensity(e){this.lightingManager.sunIntensity=e}set ssaoEnabled(e){this.renderPassComposer.getPass(K.DirectionalAmbientLighting).ssaoMixFactor=e?1:0}set ssaoKernelSize(e){this.renderPassComposer.getPass(K.SSAO).kernelSize=e}set ssaoRadius(e){this.renderPassComposer.getPass(K.SSAO).radius=e}set ssaoStrength(e){this.renderPassComposer.getPass(K.SSAO).strength=e}set enableTAA(e){this.mainCamera.shouldJitter=e;const r=this.renderPassComposer.getPass(K.TAAResolve),s=this.renderPassComposer.getPass(K.BloomDownsample),n=this.renderPassComposer.getPass(K.Blit);r.enabled=e,e&&r.resetHistory(),s.resetInputs().addInputTexture(e?ds:hs),n.resetInputs().addInputTextures([fs,e?ds:hs])}set debugGBuffer(e){e?this.texturesDebugContainer.reveal():this.texturesDebugContainer.hide(),e&&this.texturesDebugContainer.scrollIntoGbufferSection()}set debugShadowMap(e){e?this.texturesDebugContainer.reveal():this.texturesDebugContainer.hide(),e&&this.texturesDebugContainer.scrollToShadowSection()}set shadowMapSize(e){const r=this.renderPassComposer.getPass(K.Shadow);this.renderPassComposer.getPass(K.DirectionalAmbientLighting).resetInputs().addInputTextures([Lt,qt,at,Nr,ls]),r.shadowMapSize=e}set debugShadowCascadeIndex(e){this.renderPassComposer.getPass(K.DirectionalAmbientLighting).debugShadowCascadeLayer=e}set debugLightsMask(e){this.renderPassComposer.getPass(K.PointLightsLighting).debugLightsMask=e}set render2ndFloorPoints(e){this.lightingManager.render2ndFloorParticles=e}set ssrIsHiZ(e){this.renderPassComposer.getPass(K.Reflection).isHiZ=e,this.renderPassComposer.getPass(K.HiZ).enabled=e}set ssrMaxIterations(e){this.renderPassComposer.getPass(K.Reflection).maxIterations=e}set debugMissedSSR(e){this.renderPassComposer.getPass(K.Reflection).debugMissedIntersections=e}set ssrEnabled(e){this.renderPassComposer.getPass(K.Reflection).enabled=e,this.renderPassComposer.getPass(K.TAAResolve).clearInputTextures().addInputTextures([e?hs:Et,Xs])}set bloomEnabled(e){this.renderPassComposer.getPass(K.BloomDownsample).enabled=e,this.renderPassComposer.getPass(K.BloomUpsample).enabled=e,this.renderPassComposer.getPass(K.Blit).bloomEnabled=e}set bloomFilterRadius(e){this.renderPassComposer.getPass(K.BloomUpsample).bloomFilterRadius=e}set debugBoundingBoxes(e){this.renderPassComposer.getPass(K.DebugBounds).enabled=e}set debugMovementCurve(e){this.curveMoveLine.visible=e}toggleStatsVisibility(){this.timingDebugContainer.toggleVisibility()}recreateRenderComposer(e,r){var j;(j=this.renderPassComposer)==null||j.destroy(),this.renderPassComposer=new Rh,this.renderPassComposer.setScene(this.scene);const s=new On(this.lightingManager.mainDirLight,e,r).addOutputTexture(ls).setCamera(this.mainCamera),n=new gb(e,r).setCamera(this.mainCamera).addOutputTextures([Lt,qt,Xs,at]),i=new Vo(e,r).setCamera(this.mainCamera).addInputTextures([Lt,at]).addOutputTexture(tu),o=new Bb(e,r).addInputTexture(tu).addOutputTexture(Nr),a=new Oo(s.shadowCascadesBuffer,e,r).setCamera(this.mainCamera).addInputTextures([Lt,qt,at,Nr,ls]).addOutputTexture(Et);this.envDiffuseTexture&&a.setDiffuseIBLTexture(this.envDiffuseTexture),this.envSpecularTexture&&a.setSpecularIBLTexture(this.envSpecularTexture),this.envBdrfLutTexture&&a.setBDRFLutTexture(this.envBdrfLutTexture);const c=new Uo(e,r).setCamera(this.mainCamera).addInputTextures([Lt,qt,at,Nr,Et]).addOutputTexture(Et),m=new bb(e,r).setCamera(this.mainCamera).addInputTextures([at]).addOutputTexture(at).setLightsBuffer(this.lightingManager.gpuBuffer).updateLightsMaskBindGroup(),_=new ko(e,r).setCamera(this.mainCamera).addInputTextures([Lt,qt,at,Nr,Et]).addOutputTexture(Et),v=new Tb(e,r).setCamera(this.mainCamera).addInputTextures([Et,at]).addOutputTextures([Et,at]),P=new vb(e,r).setCamera(this.mainCamera).addInputTextures([Et,at]).addOutputTextures([Et,at]),O=new Do(e,r).addInputTexture(at).addOutputTexture(Ws),D=new Io(e,r).addInputTexture(Ws).addOutputTexture(Ws),U=new No(e,r).setCamera(this.mainCamera).addInputTextures([Et,Lt,qt,Ws]).addOutputTexture(hs),X=new Ho(e,r).addInputTextures([hs,Xs]).addOutputTexture(ds),Y=new Go(e,r).addInputTexture(ds).addOutputTexture(fs),Q=new fb(e,r).addInputTexture(fs).addOutputTexture(fs),q=new Ro(e,r).addInputTextures([fs,ds]);this.renderPassComposer.addPass(s).addPass(n).addPass(i).addPass(o).addPass(a).addPass(c).addPass(m).addPass(_).addPass(v).addPass(P).addPass(O).addPass(D).addPass(U).addPass(X).addPass(Y).addPass(Q).addPass(q)}resize(e,r){this.debugCamera.onResize(e,r),this.mainCamera.onResize(e,r),this.recreateRenderComposer(e,r)}async renderFrame(e){const r=(e-x.elapsedTimeMs)*.001,s=r-x.prevTimeMs;x.prevTimeMs=r,x.elapsedTimeMs+=this.enableAnimation?s:0,x.deltaTimeMs=this.enableAnimation?Math.min(s,.5):0;const n=performance.now();this.debugCamera.onFrameStart(),this.mainCamera.onFrameStart();const i=x.device.createCommandEncoder({label:"Frame Command Encoder"});this.lightingManager.update(i),this.renderPassComposer.render(i),this.texturesDebugContainer.setTextureGBufferSection(re.Albedo,this.renderPassComposer.getTexture(qt)).setTextureGBufferSection(re.Normal,this.renderPassComposer.getTexture(Lt)).setTextureGBufferSection(re.Metallic,this.renderPassComposer.getTexture(Lt)).setTextureGBufferSection(re.Roughness,this.renderPassComposer.getTexture(Lt)).setTextureGBufferSection(re.AO,this.renderPassComposer.getTexture(Nr)).setTextureGBufferSection(re.Reflectance,this.renderPassComposer.getTexture(qt)).setTextureGBufferSection(re.Depth,this.renderPassComposer.getTexture(at)).setTextureGBufferSection(re.Velocity,this.renderPassComposer.getTexture(Xs)).setTextureShadowSection(re.ShadowDepthCascade0,this.renderPassComposer.getTexture(ls)).setTextureShadowSection(re.ShadowDepthCascade1,this.renderPassComposer.getTexture(ls)).render(i),x.device.queue.submit([i.finish()]),this.renderPassComposer.onFrameEnd(),this.mainCamera.onFrameEnd(),this.debugCamera.onFrameEnd();const o=performance.now()-n;if(x.supportsGPUTimestampQuery){const[_,v]=await Promise.all([this.renderPassComposer.getPass(K.Shadow).getTimingResult(),this.renderPassComposer.getPass(K.Blit).getTimingResult()]),P=_.timings,O=(v.timings[1]-P[0])/1e6;this.gpuAverage.addSample(O)}this.cpuAverage.addSample(o),this.fpsDisplayAverage.addSample(1/s);const a=this.cpuAverage.get(),c=this.fpsDisplayAverage.get(),m=this.gpuAverage.get();this.timingDebugContainer.setDisplayValue(de.CPUTotal,a!==0?`${a.toFixed(1)}ms`:"N/A").setDisplayValue(de.GPUTotal,m>0?`${m.toFixed(1)}ms`:"N/A").setDisplayValue(de.FPS,c!==0?`${c.toFixed(1)}ms`:"N/A").setDisplayValue(de.VRAM,ee.getFormattedSize()).setDisplayValue(de.VisibleMeshes,`${this.scene.visibleNodesCount} / ${this.scene.nodesCount}`).setDisplayValue(de.LightsCount,this.lightingManager.lightsCount.toString()),x.frameIndex++}};Yn.initialize=async e=>{if(!navigator.gpu)return;const r=await navigator.gpu.requestAdapter();x.$canvas=e,x.canvasContext=e.getContext("webgpu"),x.pixelFormat=navigator.gpu.getPreferredCanvasFormat();const s=[],n=!0;return s.push("timestamp-query"),s.push("float32-filterable"),x.device=await r.requestDevice({requiredFeatures:s}),x.supportsGPUTimestampQuery=n,x.canvasContext.configure({device:x.device,format:x.pixelFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT}),new Yn};let Mr=Yn;const Pr=document.getElementById("c"),Te=await Mr.initialize(Pr);Te===void 0&&document.getElementById("no-webgpu-wrapper").style.setProperty("display","block");const Ae={"Play Animation":!0,"Performance Stats":!1,"Enable TAA":!0,"Debug G-Buffer":!1,"Debug Shadow Map":!1,"Debug Shadow Cascades":!1,"Shadow Map Size":2048,"Debug Point Lights Mask":!1,"Render 2nd Floor Points":!0,"Enable SSR":!0,"SSR Method":"hi-z","SSR Max Iterations":30,"Debug No Info Rays":!1,"Sun Intensity":2,"Sun Position X":.1,"Sun Position Y":100,"Sun Position Z":.1,"Debug Skybox":!0,"Enable Bloom":!0,"Bloom Filter Radius":.0035,"Enable SSAO":!0,"SSAO Kernel Size":8,"SSAO Radius":.2,"SSAO Strength":3},Xt=new Zl({width:270});Xt.add(Ae,"Play Animation").onChange(t=>{Te.enableAnimation=t}),Xt.add(Ae,"Performance Stats").onChange(t=>{Te.toggleStatsVisibility()}),Xt.add(Ae,"Debug G-Buffer").onChange(t=>{Te.debugGBuffer=t,Sl(),t&&Ae["Debug Shadow Map"]&&(Ae["Debug Shadow Map"]=!1)}).listen();const Zr=Xt.addFolder("Lighting");Zr.open(),Zr.add(Ae,"Sun Intensity",0,100).onChange(t=>{Te.sunIntensity=t}),Zr.add(Ae,"Sun Position X",-60,60,.5).onChange(t=>{Te.sunPositionZ=t}),Zr.add(Ae,"Sun Position Z",-150,150,.5).onChange(t=>{Te.sunPositionX=t});const Vn=Xt.addFolder("Shadow");Vn.open(),Vn.add(Ae,"Debug Shadow Map").onChange(t=>{Te.debugShadowMap=t,Sl(),t&&Ae["Debug G-Buffer"]&&(Ae["Debug G-Buffer"]=!1)}).listen(),Vn.add(Ae,"Shadow Map Size",[512,1024,2048,4096]).onChange(t=>{Te.shadowMapSize=parseInt(t)}),Vn.add(Ae,"Debug Shadow Cascades").onChange(t=>{Te.debugShadowCascadeIndex=t});let wl=Ae["Enable Bloom"];Zr.add(Ae,"Debug Point Lights Mask").onChange(t=>{t?(wl=Ae["Enable Bloom"],Ae["Enable Bloom"]=!1,Te.bloomEnabled=!1):wl&&(Ae["Enable Bloom"]=!0,Te.bloomEnabled=!0),Te.debugLightsMask=t}),Zr.add(Ae,"Render 2nd Floor Points").onChange(t=>{Te.render2ndFloorPoints=t});const Es=Xt.addFolder("Screen space Ambient Occlusion");Es.open(),Es.add(Ae,"Enable SSAO").onChange(t=>{Te.ssaoEnabled=t}),Es.add(Ae,"SSAO Kernel Size",8,128,1).onChange(t=>{Te.ssaoKernelSize=t}),Es.add(Ae,"SSAO Radius",0,1).onChange(t=>{Te.ssaoRadius=t}),Es.add(Ae,"SSAO Strength",0,5).onChange(t=>{Te.ssaoStrength=t});const Ms=Xt.addFolder("Screen space Reflections");Ms.open(),Ms.add(Ae,"Enable SSR").onChange(t=>{Te.ssrEnabled=t}),Ms.add(Ae,"SSR Method",["hi-z","linear"]).onChange(t=>{Te.ssrIsHiZ=t==="hi-z"}),Ms.add(Ae,"SSR Max Iterations",0,1500,1).onChange(t=>{Te.ssrMaxIterations=t}),Ms.add(Ae,"Debug No Info Rays").onChange(t=>{Te.debugMissedSSR=t});const Wo=Xt.addFolder("Bloom");Wo.open(),Wo.add(Ae,"Enable Bloom").onChange(t=>{Te.bloomEnabled=t}).listen(),Wo.add(Ae,"Bloom Filter Radius",.001,.005,5e-4).onChange(t=>{Te.bloomFilterRadius=t});const vl=Xt.addFolder("Anti-Aliasing");vl.open(),vl.add(Ae,"Enable TAA").onChange(t=>{Te.enableTAA=t}),requestAnimationFrame(Cl),window.addEventListener("resize",Tl),Tl();function Cl(){const t=performance.now();Te.renderFrame(t),requestAnimationFrame(Cl)}function Tl(){const t=Math.min(innerWidth,1920),e=Math.min(innerHeight,1080);Pr.width=t,Pr.height=e,Pr.style.setProperty("left",`${innerWidth*.5-t*.5}px`),Pr.style.setProperty("top",`${innerHeight*.5-e*.5}px`),Pr.style.setProperty("width",`${t}px`),Pr.style.setProperty("height",`${e}px`),Te.resize(t,e)}function Sl(){document.getElementById("logo").classList.toggle("debug-open"),document.getElementById("timings-debug-container").classList.toggle("debug-open")}})();
