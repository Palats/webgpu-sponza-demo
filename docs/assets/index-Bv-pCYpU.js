var Wp=Object.defineProperty;var $p=(ke,$e,qe)=>$e in ke?Wp(ke,$e,{enumerable:!0,configurable:!0,writable:!0,value:qe}):ke[$e]=qe;var ee=(ke,$e,qe)=>$p(ke,typeof $e!="symbol"?$e+"":$e,qe);(async()=>{var zc,jc;function ke(s,e){var t=s.__state.conversionName.toString(),r=Math.round(s.r),n=Math.round(s.g),i=Math.round(s.b),o=s.a,u=Math.round(s.h),l=s.s.toFixed(1),m=s.v.toFixed(1);if(e||t==="THREE_CHAR_HEX"||t==="SIX_CHAR_HEX"){for(var b=s.hex.toString(16);b.length<6;)b="0"+b;return"#"+b}return t==="CSS_RGB"?"rgb("+r+","+n+","+i+")":t==="CSS_RGBA"?"rgba("+r+","+n+","+i+","+o+")":t==="HEX"?"0x"+s.hex.toString(16):t==="RGB_ARRAY"?"["+r+","+n+","+i+"]":t==="RGBA_ARRAY"?"["+r+","+n+","+i+","+o+"]":t==="RGB_OBJ"?"{r:"+r+",g:"+n+",b:"+i+"}":t==="RGBA_OBJ"?"{r:"+r+",g:"+n+",b:"+i+",a:"+o+"}":t==="HSV_OBJ"?"{h:"+u+",s:"+l+",v:"+m+"}":t==="HSVA_OBJ"?"{h:"+u+",s:"+l+",v:"+m+",a:"+o+"}":"unknown format"}(function(){const s=document.createElement("link").relList;if(!(s&&s.supports&&s.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const r=function(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}(t);fetch(t.href,r)}})();var $e=Array.prototype.forEach,qe=Array.prototype.slice,N={BREAK:{},extend:function(s){return this.each(qe.call(arguments,1),function(e){(this.isObject(e)?Object.keys(e):[]).forEach((function(t){this.isUndefined(e[t])||(s[t]=e[t])}).bind(this))},this),s},defaults:function(s){return this.each(qe.call(arguments,1),function(e){(this.isObject(e)?Object.keys(e):[]).forEach((function(t){this.isUndefined(s[t])&&(s[t]=e[t])}).bind(this))},this),s},compose:function(){var s=qe.call(arguments);return function(){for(var e=qe.call(arguments),t=s.length-1;t>=0;t--)e=[s[t].apply(this,e)];return e[0]}},each:function(s,e,t){if(s){if($e&&s.forEach&&s.forEach===$e)s.forEach(e,t);else if(s.length===s.length+0){var r,n=void 0;for(n=0,r=s.length;n<r;n++)if(n in s&&e.call(t,s[n],n)===this.BREAK)return}else for(var i in s)if(e.call(t,s[i],i)===this.BREAK)return}},defer:function(s){setTimeout(s,0)},debounce:function(s,e,t){var r=void 0;return function(){var n=this,i=arguments,o=t||!r;clearTimeout(r),r=setTimeout(function(){r=null,t||s.apply(n,i)},e),o&&s.apply(n,i)}},toArray:function(s){return s.toArray?s.toArray():qe.call(s)},isUndefined:function(s){return s===void 0},isNull:function(s){return s===null},isNaN:function(s){function e(t){return s.apply(this,arguments)}return e.toString=function(){return s.toString()},e}(function(s){return isNaN(s)}),isArray:Array.isArray||function(s){return s.constructor===Array},isObject:function(s){return s===Object(s)},isNumber:function(s){return s===s+0},isString:function(s){return s===s+""},isBoolean:function(s){return s===!1||s===!0},isFunction:function(s){return s instanceof Function}},$c=[{litmus:N.isString,conversions:{THREE_CHAR_HEX:{read:function(s){var e=s.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return e!==null&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString(),0)}},write:ke},SIX_CHAR_HEX:{read:function(s){var e=s.match(/^#([A-F0-9]{6})$/i);return e!==null&&{space:"HEX",hex:parseInt("0x"+e[1].toString(),0)}},write:ke},CSS_RGB:{read:function(s){var e=s.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e!==null&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:ke},CSS_RGBA:{read:function(s){var e=s.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e!==null&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:ke}}},{litmus:N.isNumber,conversions:{HEX:{read:function(s){return{space:"HEX",hex:s,conversionName:"HEX"}},write:function(s){return s.hex}}}},{litmus:N.isArray,conversions:{RGB_ARRAY:{read:function(s){return s.length===3&&{space:"RGB",r:s[0],g:s[1],b:s[2]}},write:function(s){return[s.r,s.g,s.b]}},RGBA_ARRAY:{read:function(s){return s.length===4&&{space:"RGB",r:s[0],g:s[1],b:s[2],a:s[3]}},write:function(s){return[s.r,s.g,s.b,s.a]}}}},{litmus:N.isObject,conversions:{RGBA_OBJ:{read:function(s){return!!(N.isNumber(s.r)&&N.isNumber(s.g)&&N.isNumber(s.b)&&N.isNumber(s.a))&&{space:"RGB",r:s.r,g:s.g,b:s.b,a:s.a}},write:function(s){return{r:s.r,g:s.g,b:s.b,a:s.a}}},RGB_OBJ:{read:function(s){return!!(N.isNumber(s.r)&&N.isNumber(s.g)&&N.isNumber(s.b))&&{space:"RGB",r:s.r,g:s.g,b:s.b}},write:function(s){return{r:s.r,g:s.g,b:s.b}}},HSVA_OBJ:{read:function(s){return!!(N.isNumber(s.h)&&N.isNumber(s.s)&&N.isNumber(s.v)&&N.isNumber(s.a))&&{space:"HSV",h:s.h,s:s.s,v:s.v,a:s.a}},write:function(s){return{h:s.h,s:s.s,v:s.v,a:s.a}}},HSV_OBJ:{read:function(s){return!!(N.isNumber(s.h)&&N.isNumber(s.s)&&N.isNumber(s.v))&&{space:"HSV",h:s.h,s:s.s,v:s.v}},write:function(s){return{h:s.h,s:s.s,v:s.v}}}}}],br=void 0,Kr=void 0,yn=function(){Kr=!1;var s=arguments.length>1?N.toArray(arguments):arguments[0];return N.each($c,function(e){if(e.litmus(s))return N.each(e.conversions,function(t,r){if(br=t.read(s),Kr===!1&&br!==!1)return Kr=br,br.conversionName=r,br.conversion=t,N.BREAK}),N.BREAK}),Kr},fo=void 0,Xr={hsv_to_rgb:function(s,e,t){var r=Math.floor(s/60)%6,n=s/60-Math.floor(s/60),i=t*(1-e),o=t*(1-n*e),u=t*(1-(1-n)*e),l=[[t,u,i],[o,t,i],[i,t,u],[i,o,t],[u,i,t],[t,i,o]][r];return{r:255*l[0],g:255*l[1],b:255*l[2]}},rgb_to_hsv:function(s,e,t){var r=Math.min(s,e,t),n=Math.max(s,e,t),i=n-r,o=void 0;return n===0?{h:NaN,s:0,v:0}:(o=s===n?(e-t)/i:e===n?2+(t-s)/i:4+(s-e)/i,(o/=6)<0&&(o+=1),{h:360*o,s:i/n,v:n/255})},rgb_to_hex:function(s,e,t){var r=this.hex_with_component(0,2,s);return r=this.hex_with_component(r,1,e),r=this.hex_with_component(r,0,t)},component_from_hex:function(s,e){return s>>8*e&255},hex_with_component:function(s,e,t){return t<<(fo=8*e)|s&~(255<<fo)}},qc=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},ze=function(s,e){if(!(s instanceof e))throw new TypeError("Cannot call a class as a function")},je=function(){function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}}(),pt=function s(e,t,r){e===null&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,t);if(n===void 0){var i=Object.getPrototypeOf(e);return i===null?void 0:s(i,t,r)}if("value"in n)return n.value;var o=n.get;return o!==void 0?o.call(r):void 0},mt=function(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(s,e):s.__proto__=e)},gt=function(s,e){if(!s)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||typeof e!="object"&&typeof e!="function"?s:e},ye=function(){function s(){if(ze(this,s),this.__state=yn.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return je(s,[{key:"toString",value:function(){return ke(this)}},{key:"toHexString",value:function(){return ke(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),s}();function bn(s,e,t){Object.defineProperty(s,e,{get:function(){return this.__state.space==="RGB"||ye.recalculateRGB(this,e,t),this.__state[e]},set:function(r){this.__state.space!=="RGB"&&(ye.recalculateRGB(this,e,t),this.__state.space="RGB"),this.__state[e]=r}})}function xn(s,e){Object.defineProperty(s,e,{get:function(){return this.__state.space==="HSV"||ye.recalculateHSV(this),this.__state[e]},set:function(t){this.__state.space!=="HSV"&&(ye.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=t}})}ye.recalculateRGB=function(s,e,t){if(s.__state.space==="HEX")s.__state[e]=Xr.component_from_hex(s.__state.hex,t);else{if(s.__state.space!=="HSV")throw new Error("Corrupted color state");N.extend(s.__state,Xr.hsv_to_rgb(s.__state.h,s.__state.s,s.__state.v))}},ye.recalculateHSV=function(s){var e=Xr.rgb_to_hsv(s.r,s.g,s.b);N.extend(s.__state,{s:e.s,v:e.v}),N.isNaN(e.h)?N.isUndefined(s.__state.h)&&(s.__state.h=0):s.__state.h=e.h},ye.COMPONENTS=["r","g","b","h","s","v","hex","a"],bn(ye.prototype,"r",2),bn(ye.prototype,"g",1),bn(ye.prototype,"b",0),xn(ye.prototype,"h"),xn(ye.prototype,"s"),xn(ye.prototype,"v"),Object.defineProperty(ye.prototype,"a",{get:function(){return this.__state.a},set:function(s){this.__state.a=s}}),Object.defineProperty(ye.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=Xr.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(s){this.__state.space="HEX",this.__state.hex=s}});var Mt=function(){function s(e,t){ze(this,s),this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onChange=void 0,this.__onFinishChange=void 0}return je(s,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),s}(),po={};N.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(s,e){N.each(s,function(t){po[t]=e})});var Qc=/(\d+(\.\d+)?)px/;function Qe(s){if(s==="0"||N.isUndefined(s))return 0;var e=s.match(Qc);return N.isNull(e)?0:parseFloat(e[1])}var I={makeSelectable:function(s,e){s!==void 0&&s.style!==void 0&&(s.onselectstart=e?function(){return!1}:function(){},s.style.MozUserSelect=e?"auto":"none",s.style.KhtmlUserSelect=e?"auto":"none",s.unselectable=e?"on":"off")},makeFullscreen:function(s,e,t){var r=t,n=e;N.isUndefined(n)&&(n=!0),N.isUndefined(r)&&(r=!0),s.style.position="absolute",n&&(s.style.left=0,s.style.right=0),r&&(s.style.top=0,s.style.bottom=0)},fakeEvent:function(s,e,t,r){var n=t||{},i=po[e];if(!i)throw new Error("Event type "+e+" not supported.");var o=document.createEvent(i);switch(i){case"MouseEvents":var u=n.x||n.clientX||0,l=n.y||n.clientY||0;o.initMouseEvent(e,n.bubbles||!1,n.cancelable||!0,window,n.clickCount||1,0,0,u,l,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var m=o.initKeyboardEvent||o.initKeyEvent;N.defaults(n,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),m(e,n.bubbles||!1,n.cancelable,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode);break;default:o.initEvent(e,n.bubbles||!1,n.cancelable||!0)}N.defaults(o,r),s.dispatchEvent(o)},bind:function(s,e,t,r){var n=r||!1;return s.addEventListener?s.addEventListener(e,t,n):s.attachEvent&&s.attachEvent("on"+e,t),I},unbind:function(s,e,t,r){var n=r||!1;return s.removeEventListener?s.removeEventListener(e,t,n):s.detachEvent&&s.detachEvent("on"+e,t),I},addClass:function(s,e){if(s.className===void 0)s.className=e;else if(s.className!==e){var t=s.className.split(/ +/);t.indexOf(e)===-1&&(t.push(e),s.className=t.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return I},removeClass:function(s,e){if(e)if(s.className===e)s.removeAttribute("class");else{var t=s.className.split(/ +/),r=t.indexOf(e);r!==-1&&(t.splice(r,1),s.className=t.join(" "))}else s.className=void 0;return I},hasClass:function(s,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(s.className)||!1},getWidth:function(s){var e=getComputedStyle(s);return Qe(e["border-left-width"])+Qe(e["border-right-width"])+Qe(e["padding-left"])+Qe(e["padding-right"])+Qe(e.width)},getHeight:function(s){var e=getComputedStyle(s);return Qe(e["border-top-width"])+Qe(e["border-bottom-width"])+Qe(e["padding-top"])+Qe(e["padding-bottom"])+Qe(e.height)},getOffset:function(s){var e=s,t={left:0,top:0};if(e.offsetParent)do t.left+=e.offsetLeft,t.top+=e.offsetTop,e=e.offsetParent;while(e);return t},isActive:function(s){return s===document.activeElement&&(s.type||s.href)}},mo=function(){function s(e,t){ze(this,s);var r=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),n=r;return r.__prev=r.getValue(),r.__checkbox=document.createElement("input"),r.__checkbox.setAttribute("type","checkbox"),I.bind(r.__checkbox,"change",function(){n.setValue(!n.__prev)},!1),r.domElement.appendChild(r.__checkbox),r.updateDisplay(),r}return mt(s,Mt),je(s,[{key:"setValue",value:function(e){var t=pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),t}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}(),Zc=function(){function s(e,t,r){ze(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),i=r,o=n;if(n.__select=document.createElement("select"),N.isArray(i)){var u={};N.each(i,function(l){u[l]=l}),i=u}return N.each(i,function(l,m){var b=document.createElement("option");b.innerHTML=m,b.setAttribute("value",l),o.__select.appendChild(b)}),n.updateDisplay(),I.bind(n.__select,"change",function(){var l=this.options[this.selectedIndex].value;o.setValue(l)}),n.domElement.appendChild(n.__select),n}return mt(s,Mt),je(s,[{key:"setValue",value:function(e){var t=pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),t}},{key:"updateDisplay",value:function(){return I.isActive(this.__select)?this:(this.__select.value=this.getValue(),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this))}}]),s}(),el=function(){function s(e,t){ze(this,s);var r=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),n=r;function i(){n.setValue(n.__input.value)}return r.__input=document.createElement("input"),r.__input.setAttribute("type","text"),I.bind(r.__input,"keyup",i),I.bind(r.__input,"change",i),I.bind(r.__input,"blur",function(){n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())}),I.bind(r.__input,"keydown",function(o){o.keyCode===13&&this.blur()}),r.updateDisplay(),r.domElement.appendChild(r.__input),r}return mt(s,Mt),je(s,[{key:"updateDisplay",value:function(){return I.isActive(this.__input)||(this.__input.value=this.getValue()),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}();function go(s){var e=s.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var yo=function(){function s(e,t,r){ze(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),i=r||{};return n.__min=i.min,n.__max=i.max,n.__step=i.step,N.isUndefined(n.__step)?n.initialValue===0?n.__impliedStep=1:n.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(n.initialValue))/Math.LN10))/10:n.__impliedStep=n.__step,n.__precision=go(n.__impliedStep),n}return mt(s,Mt),je(s,[{key:"setValue",value:function(e){var t=e;return this.__min!==void 0&&t<this.__min?t=this.__min:this.__max!==void 0&&t>this.__max&&(t=this.__max),this.__step!==void 0&&t%this.__step!=0&&(t=Math.round(t/this.__step)*this.__step),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setValue",this).call(this,t)}},{key:"min",value:function(e){return this.__min=e,this}},{key:"max",value:function(e){return this.__max=e,this}},{key:"step",value:function(e){return this.__step=e,this.__impliedStep=e,this.__precision=go(e),this}}]),s}(),Yr=function(){function s(e,t,r){ze(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t,r));n.__truncationSuspended=!1;var i=n,o=void 0;function u(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}function l(b){var d=o-b.clientY;i.setValue(i.getValue()+d*i.__impliedStep),o=b.clientY}function m(){I.unbind(window,"mousemove",l),I.unbind(window,"mouseup",m),u()}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),I.bind(n.__input,"change",function(){var b=parseFloat(i.__input.value);N.isNaN(b)||i.setValue(b)}),I.bind(n.__input,"blur",function(){u()}),I.bind(n.__input,"mousedown",function(b){I.bind(window,"mousemove",l),I.bind(window,"mouseup",m),o=b.clientY}),I.bind(n.__input,"keydown",function(b){b.keyCode===13&&(i.__truncationSuspended=!0,this.blur(),i.__truncationSuspended=!1,u())}),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return mt(s,yo),je(s,[{key:"updateDisplay",value:function(){var e,t,r;return this.__input.value=this.__truncationSuspended?this.getValue():(e=this.getValue(),t=this.__precision,r=Math.pow(10,t),Math.round(e*r)/r),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}();function bo(s,e,t,r,n){return r+(s-e)/(t-e)*(n-r)}var _n=function(){function s(e,t,r,n,i){ze(this,s);var o=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t,{min:r,max:n,step:i})),u=o;function l(x){x.preventDefault();var g=u.__background.getBoundingClientRect();return u.setValue(bo(x.clientX,g.left,g.right,u.__min,u.__max)),!1}function m(){I.unbind(window,"mousemove",l),I.unbind(window,"mouseup",m),u.__onFinishChange&&u.__onFinishChange.call(u,u.getValue())}function b(x){var g=x.touches[0].clientX,_=u.__background.getBoundingClientRect();u.setValue(bo(g,_.left,_.right,u.__min,u.__max))}function d(){I.unbind(window,"touchmove",b),I.unbind(window,"touchend",d),u.__onFinishChange&&u.__onFinishChange.call(u,u.getValue())}return o.__background=document.createElement("div"),o.__foreground=document.createElement("div"),I.bind(o.__background,"mousedown",function(x){document.activeElement.blur(),I.bind(window,"mousemove",l),I.bind(window,"mouseup",m),l(x)}),I.bind(o.__background,"touchstart",function(x){x.touches.length===1&&(I.bind(window,"touchmove",b),I.bind(window,"touchend",d),b(x))}),I.addClass(o.__background,"slider"),I.addClass(o.__foreground,"slider-fg"),o.updateDisplay(),o.__background.appendChild(o.__foreground),o.domElement.appendChild(o.__background),o}return mt(s,yo),je(s,[{key:"updateDisplay",value:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}(),xo=function(){function s(e,t,r){ze(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),i=n;return n.__button=document.createElement("div"),n.__button.innerHTML=r===void 0?"Fire":r,I.bind(n.__button,"click",function(o){return o.preventDefault(),i.fire(),!1}),I.addClass(n.__button,"button"),n.domElement.appendChild(n.__button),n}return mt(s,Mt),je(s,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),s}(),An=function(){function s(e,t){ze(this,s);var r=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t));r.__color=new ye(r.getValue()),r.__temp=new ye(0);var n=r;r.domElement=document.createElement("div"),I.makeSelectable(r.domElement,!1),r.__selector=document.createElement("div"),r.__selector.className="selector",r.__saturation_field=document.createElement("div"),r.__saturation_field.className="saturation-field",r.__field_knob=document.createElement("div"),r.__field_knob.className="field-knob",r.__field_knob_border="2px solid ",r.__hue_knob=document.createElement("div"),r.__hue_knob.className="hue-knob",r.__hue_field=document.createElement("div"),r.__hue_field.className="hue-field",r.__input=document.createElement("input"),r.__input.type="text",r.__input_textShadow="0 1px 1px ",I.bind(r.__input,"keydown",function(w){w.keyCode===13&&d.call(this)}),I.bind(r.__input,"blur",d),I.bind(r.__selector,"mousedown",function(){I.addClass(this,"drag").bind(window,"mouseup",function(){I.removeClass(n.__selector,"drag")})}),I.bind(r.__selector,"touchstart",function(){I.addClass(this,"drag").bind(window,"touchend",function(){I.removeClass(n.__selector,"drag")})});var i,o=document.createElement("div");function u(w){g(w),I.bind(window,"mousemove",g),I.bind(window,"touchmove",g),I.bind(window,"mouseup",m),I.bind(window,"touchend",m)}function l(w){_(w),I.bind(window,"mousemove",_),I.bind(window,"touchmove",_),I.bind(window,"mouseup",b),I.bind(window,"touchend",b)}function m(){I.unbind(window,"mousemove",g),I.unbind(window,"touchmove",g),I.unbind(window,"mouseup",m),I.unbind(window,"touchend",m),x()}function b(){I.unbind(window,"mousemove",_),I.unbind(window,"touchmove",_),I.unbind(window,"mouseup",b),I.unbind(window,"touchend",b),x()}function d(){var w=yn(this.value);w!==!1?(n.__color.__state=w,n.setValue(n.__color.toOriginal())):this.value=n.__color.toString()}function x(){n.__onFinishChange&&n.__onFinishChange.call(n,n.__color.toOriginal())}function g(w){w.type.indexOf("touch")===-1&&w.preventDefault();var f=n.__saturation_field.getBoundingClientRect(),p=w.touches&&w.touches[0]||w,a=p.clientX,c=p.clientY,h=(a-f.left)/(f.right-f.left),y=1-(c-f.top)/(f.bottom-f.top);return y>1?y=1:y<0&&(y=0),h>1?h=1:h<0&&(h=0),n.__color.v=y,n.__color.s=h,n.setValue(n.__color.toOriginal()),!1}function _(w){w.type.indexOf("touch")===-1&&w.preventDefault();var f=n.__hue_field.getBoundingClientRect(),p=1-((w.touches&&w.touches[0]||w).clientY-f.top)/(f.bottom-f.top);return p>1?p=1:p<0&&(p=0),n.__color.h=360*p,n.setValue(n.__color.toOriginal()),!1}return N.extend(r.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),N.extend(r.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:r.__field_knob_border+(r.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),N.extend(r.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),N.extend(r.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),N.extend(o.style,{width:"100%",height:"100%",background:"none"}),_o(o,"top","rgba(0,0,0,0)","#000"),N.extend(r.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(i=r.__hue_field).style.background="",i.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",i.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",N.extend(r.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:r.__input_textShadow+"rgba(0,0,0,0.7)"}),I.bind(r.__saturation_field,"mousedown",u),I.bind(r.__saturation_field,"touchstart",u),I.bind(r.__field_knob,"mousedown",u),I.bind(r.__field_knob,"touchstart",u),I.bind(r.__hue_field,"mousedown",l),I.bind(r.__hue_field,"touchstart",l),r.__saturation_field.appendChild(o),r.__selector.appendChild(r.__field_knob),r.__selector.appendChild(r.__saturation_field),r.__selector.appendChild(r.__hue_field),r.__hue_field.appendChild(r.__hue_knob),r.domElement.appendChild(r.__input),r.domElement.appendChild(r.__selector),r.updateDisplay(),r}return mt(s,Mt),je(s,[{key:"updateDisplay",value:function(){var e=yn(this.getValue());if(e!==!1){var t=!1;N.each(ye.COMPONENTS,function(i){if(!N.isUndefined(e[i])&&!N.isUndefined(this.__color.__state[i])&&e[i]!==this.__color.__state[i])return t=!0,{}},this),t&&N.extend(this.__color.__state,e)}N.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var r=this.__color.v<.5||this.__color.s>.5?255:0,n=255-r;N.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+r+","+r+","+r+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,_o(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),N.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+r+","+r+","+r+")",textShadow:this.__input_textShadow+"rgba("+n+","+n+","+n+",.7)"})}}]),s}(),tl=["-moz-","-o-","-webkit-","-ms-",""];function _o(s,e,t,r){s.style.background="",N.each(tl,function(n){s.style.cssText+="background: "+n+"linear-gradient("+e+", "+t+" 0%, "+r+" 100%); "})}var rl=function(s,e){var t=e||document,r=document.createElement("style");r.type="text/css",r.innerHTML=s;var n=t.getElementsByTagName("head")[0];try{n.appendChild(r)}catch{}},sl=function(s,e){var t=s[e];return N.isArray(arguments[2])||N.isObject(arguments[2])?new Zc(s,e,arguments[2]):N.isNumber(t)?N.isNumber(arguments[2])&&N.isNumber(arguments[3])?N.isNumber(arguments[4])?new _n(s,e,arguments[2],arguments[3],arguments[4]):new _n(s,e,arguments[2],arguments[3]):N.isNumber(arguments[4])?new Yr(s,e,{min:arguments[2],max:arguments[3],step:arguments[4]}):new Yr(s,e,{min:arguments[2],max:arguments[3]}):N.isString(t)?new el(s,e):N.isFunction(t)?new xo(s,e,""):N.isBoolean(t)?new mo(s,e):null},nl=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(s){setTimeout(s,1e3/60)},il=function(){function s(){ze(this,s),this.backgroundElement=document.createElement("div"),N.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),I.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),N.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;I.bind(this.backgroundElement,"click",function(){e.hide()})}return je(s,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),N.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var e=this,t=function r(){e.domElement.style.display="none",e.backgroundElement.style.display="none",I.unbind(e.domElement,"webkitTransitionEnd",r),I.unbind(e.domElement,"transitionend",r),I.unbind(e.domElement,"oTransitionEnd",r)};I.bind(this.domElement,"webkitTransitionEnd",t),I.bind(this.domElement,"transitionend",t),I.bind(this.domElement,"oTransitionEnd",t),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-I.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-I.getHeight(this.domElement)/2+"px"}}]),s}(),ol=function(s){if(typeof window<"u"){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=s,document.head.appendChild(e),s}}(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);rl(ol);var xr="Default",_r=function(){try{return!!window.localStorage}catch{return!1}}(),Wr=void 0,Ao=!0,Wt=void 0,Bn=!1,Bo=[],le=function s(e){var t=this,r=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),I.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],r=N.defaults(r,{closeOnTop:!1,autoPlace:!0,width:s.DEFAULT_WIDTH}),r=N.defaults(r,{resizable:r.autoPlace,hideable:r.autoPlace}),N.isUndefined(r.load)?r.load={preset:xr}:r.preset&&(r.load.preset=r.preset),N.isUndefined(r.parent)&&r.hideable&&Bo.push(this),r.resizable=N.isUndefined(r.parent)&&r.resizable,r.autoPlace&&N.isUndefined(r.scrollable)&&(r.scrollable=!0);var n,i=_r&&localStorage.getItem($t(this,"isLocal"))==="true",o=void 0,u=void 0;if(Object.defineProperties(this,{parent:{get:function(){return r.parent}},scrollable:{get:function(){return r.scrollable}},autoPlace:{get:function(){return r.autoPlace}},closeOnTop:{get:function(){return r.closeOnTop}},preset:{get:function(){return t.parent?t.getRoot().preset:r.load.preset},set:function(b){t.parent?t.getRoot().preset=b:r.load.preset=b,function(d){for(var x=0;x<d.__preset_select.length;x++)d.__preset_select[x].value===d.preset&&(d.__preset_select.selectedIndex=x)}(this),t.revert()}},width:{get:function(){return r.width},set:function(b){r.width=b,Tn(t,b)}},name:{get:function(){return r.name},set:function(b){r.name=b,u&&(u.innerHTML=r.name)}},closed:{get:function(){return r.closed},set:function(b){r.closed=b,r.closed?I.addClass(t.__ul,s.CLASS_CLOSED):I.removeClass(t.__ul,s.CLASS_CLOSED),this.onResize(),t.__closeButton&&(t.__closeButton.innerHTML=b?s.TEXT_OPEN:s.TEXT_CLOSED)}},load:{get:function(){return r.load}},useLocalStorage:{get:function(){return i},set:function(b){_r&&(i=b,b?I.bind(window,"unload",o):I.unbind(window,"unload",o),localStorage.setItem($t(t,"isLocal"),b))}}}),N.isUndefined(r.parent)){if(this.closed=r.closed||!1,I.addClass(this.domElement,s.CLASS_MAIN),I.makeSelectable(this.domElement,!1),_r&&i){t.useLocalStorage=!0;var l=localStorage.getItem($t(this,"gui"));l&&(r.load=JSON.parse(l))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=s.TEXT_CLOSED,I.addClass(this.__closeButton,s.CLASS_CLOSE_BUTTON),r.closeOnTop?(I.addClass(this.__closeButton,s.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(I.addClass(this.__closeButton,s.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),I.bind(this.__closeButton,"click",function(){t.closed=!t.closed})}else{r.closed===void 0&&(r.closed=!0);var m=document.createTextNode(r.name);I.addClass(m,"controller-name"),u=vn(t,m),I.addClass(this.__ul,s.CLASS_CLOSED),I.addClass(u,"title"),I.bind(u,"click",function(b){return b.preventDefault(),t.closed=!t.closed,!1}),r.closed||(this.closed=!1)}r.autoPlace&&(N.isUndefined(r.parent)&&(Ao&&(Wt=document.createElement("div"),I.addClass(Wt,"dg"),I.addClass(Wt,s.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(Wt),Ao=!1),Wt.appendChild(this.domElement),I.addClass(this.domElement,s.CLASS_AUTO_PLACE)),this.parent||Tn(t,r.width)),this.__resizeHandler=function(){t.onResizeDebounced()},I.bind(window,"resize",this.__resizeHandler),I.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),I.bind(this.__ul,"transitionend",this.__resizeHandler),I.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),r.resizable&&al(this),o=function(){_r&&localStorage.getItem($t(t,"isLocal"))==="true"&&localStorage.setItem($t(t,"gui"),JSON.stringify(t.getSaveObject()))},this.saveToLocalStorageIfPossible=o,r.parent||((n=t.getRoot()).width+=1,N.defer(function(){n.width-=1}))};function vn(s,e,t){var r=document.createElement("li");return e&&r.appendChild(e),t?s.__ul.insertBefore(r,t):s.__ul.appendChild(r),s.onResize(),r}function vo(s){I.unbind(window,"resize",s.__resizeHandler),s.saveToLocalStorageIfPossible&&I.unbind(window,"unload",s.saveToLocalStorageIfPossible)}function wn(s,e){var t=s.__preset_select[s.__preset_select.selectedIndex];t.innerHTML=e?t.value+"*":t.value}function wo(s,e){var t=s.getRoot(),r=t.__rememberedObjects.indexOf(e.object);if(r!==-1){var n=t.__rememberedObjectIndecesToControllers[r];if(n===void 0&&(n={},t.__rememberedObjectIndecesToControllers[r]=n),n[e.property]=e,t.load&&t.load.remembered){var i=t.load.remembered,o=void 0;if(i[s.preset])o=i[s.preset];else{if(!i[xr])return;o=i[xr]}if(o[r]&&o[r][e.property]!==void 0){var u=o[r][e.property];e.initialValue=u,e.setValue(u)}}}}function Ar(s,e,t,r){if(e[t]===void 0)throw new Error('Object "'+e+'" has no property "'+t+'"');var n=void 0;if(r.color)n=new An(e,t);else{var i=[e,t].concat(r.factoryArgs);n=sl.apply(s,i)}r.before instanceof Mt&&(r.before=r.before.__li),wo(s,n),I.addClass(n.domElement,"c");var o=document.createElement("span");I.addClass(o,"property-name"),o.innerHTML=n.property;var u=document.createElement("div");u.appendChild(o),u.appendChild(n.domElement);var l=vn(s,u,r.before);return I.addClass(l,le.CLASS_CONTROLLER_ROW),n instanceof An?I.addClass(l,"color"):I.addClass(l,qc(n.getValue())),function(m,b,d){if(d.__li=b,d.__gui=m,N.extend(d,{options:function(_){if(arguments.length>1){var w=d.__li.nextElementSibling;return d.remove(),Ar(m,d.object,d.property,{before:w,factoryArgs:[N.toArray(arguments)]})}if(N.isArray(_)||N.isObject(_)){var f=d.__li.nextElementSibling;return d.remove(),Ar(m,d.object,d.property,{before:f,factoryArgs:[_]})}},name:function(_){return d.__li.firstElementChild.firstElementChild.innerHTML=_,d},listen:function(){return d.__gui.listen(d),d},remove:function(){return d.__gui.remove(d),d}}),d instanceof _n){var x=new Yr(d.object,d.property,{min:d.__min,max:d.__max,step:d.__step});N.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(_){var w=d[_],f=x[_];d[_]=x[_]=function(){var p=Array.prototype.slice.call(arguments);return f.apply(x,p),w.apply(d,p)}}),I.addClass(b,"has-slider"),d.domElement.insertBefore(x.domElement,d.domElement.firstElementChild)}else if(d instanceof Yr){var g=function(_){if(N.isNumber(d.__min)&&N.isNumber(d.__max)){var w=d.__li.firstElementChild.firstElementChild.innerHTML,f=d.__gui.__listening.indexOf(d)>-1;d.remove();var p=Ar(m,d.object,d.property,{before:d.__li.nextElementSibling,factoryArgs:[d.__min,d.__max,d.__step]});return p.name(w),f&&p.listen(),p}return _};d.min=N.compose(g,d.min),d.max=N.compose(g,d.max)}else d instanceof mo?(I.bind(b,"click",function(){I.fakeEvent(d.__checkbox,"click")}),I.bind(d.__checkbox,"click",function(_){_.stopPropagation()})):d instanceof xo?(I.bind(b,"click",function(){I.fakeEvent(d.__button,"click")}),I.bind(b,"mouseover",function(){I.addClass(d.__button,"hover")}),I.bind(b,"mouseout",function(){I.removeClass(d.__button,"hover")})):d instanceof An&&(I.addClass(b,"color"),d.updateDisplay=N.compose(function(_){return b.style.borderLeftColor=d.__color.toString(),_},d.updateDisplay),d.updateDisplay());d.setValue=N.compose(function(_){return m.getRoot().__preset_select&&d.isModified()&&wn(m.getRoot(),!0),_},d.setValue)}(s,l,n),s.__controllers.push(n),n}function $t(s,e){return document.location.href+"."+e}function Cn(s,e,t){var r=document.createElement("option");r.innerHTML=e,r.value=e,s.__preset_select.appendChild(r),t&&(s.__preset_select.selectedIndex=s.__preset_select.length-1)}function Co(s,e){e.style.display=s.useLocalStorage?"block":"none"}function al(s){var e=void 0;function t(i){return i.preventDefault(),s.width+=e-i.clientX,s.onResize(),e=i.clientX,!1}function r(){I.removeClass(s.__closeButton,le.CLASS_DRAG),I.unbind(window,"mousemove",t),I.unbind(window,"mouseup",r)}function n(i){return i.preventDefault(),e=i.clientX,I.addClass(s.__closeButton,le.CLASS_DRAG),I.bind(window,"mousemove",t),I.bind(window,"mouseup",r),!1}s.__resize_handle=document.createElement("div"),N.extend(s.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),I.bind(s.__resize_handle,"mousedown",n),I.bind(s.__closeButton,"mousedown",n),s.domElement.insertBefore(s.__resize_handle,s.domElement.firstElementChild)}function Tn(s,e){s.domElement.style.width=e+"px",s.__save_row&&s.autoPlace&&(s.__save_row.style.width=e+"px"),s.__closeButton&&(s.__closeButton.style.width=e+"px")}function $r(s,e){var t={};return N.each(s.__rememberedObjects,function(r,n){var i={},o=s.__rememberedObjectIndecesToControllers[n];N.each(o,function(u,l){i[l]=e?u.initialValue:u.getValue()}),t[n]=i}),t}function To(s){s.length!==0&&nl.call(window,function(){To(s)}),N.each(s,function(e){e.updateDisplay()})}le.toggleHide=function(){Bn=!Bn,N.each(Bo,function(s){s.domElement.style.display=Bn?"none":""})},le.CLASS_AUTO_PLACE="a",le.CLASS_AUTO_PLACE_CONTAINER="ac",le.CLASS_MAIN="main",le.CLASS_CONTROLLER_ROW="cr",le.CLASS_TOO_TALL="taller-than-window",le.CLASS_CLOSED="closed",le.CLASS_CLOSE_BUTTON="close-button",le.CLASS_CLOSE_TOP="close-top",le.CLASS_CLOSE_BOTTOM="close-bottom",le.CLASS_DRAG="drag",le.DEFAULT_WIDTH=245,le.TEXT_CLOSED="Close Controls",le.TEXT_OPEN="Open Controls",le._keydownHandler=function(s){document.activeElement.type==="text"||s.which!==72&&s.keyCode!==72||le.toggleHide()},I.bind(window,"keydown",le._keydownHandler,!1),N.extend(le.prototype,{add:function(s,e){return Ar(this,s,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(s,e){return Ar(this,s,e,{color:!0})},remove:function(s){this.__ul.removeChild(s.__li),this.__controllers.splice(this.__controllers.indexOf(s),1);var e=this;N.defer(function(){e.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&Wt.removeChild(this.domElement);var s=this;N.each(this.__folders,function(e){s.removeFolder(e)}),I.unbind(window,"keydown",le._keydownHandler,!1),vo(this)},addFolder:function(s){if(this.__folders[s]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+s+'"');var e={name:s,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[s]&&(e.closed=this.load.folders[s].closed,e.load=this.load.folders[s]);var t=new le(e);this.__folders[s]=t;var r=vn(this,t.domElement);return I.addClass(r,"folder"),t},removeFolder:function(s){this.__ul.removeChild(s.domElement.parentElement),delete this.__folders[s.name],this.load&&this.load.folders&&this.load.folders[s.name]&&delete this.load.folders[s.name],vo(s);var e=this;N.each(s.__folders,function(t){s.removeFolder(t)}),N.defer(function(){e.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var s=this.getRoot();if(s.scrollable){var e=I.getOffset(s.__ul).top,t=0;N.each(s.__ul.childNodes,function(r){s.autoPlace&&r===s.__save_row||(t+=I.getHeight(r))}),window.innerHeight-e-20<t?(I.addClass(s.domElement,le.CLASS_TOO_TALL),s.__ul.style.height=window.innerHeight-e-20+"px"):(I.removeClass(s.domElement,le.CLASS_TOO_TALL),s.__ul.style.height="auto")}s.__resize_handle&&N.defer(function(){s.__resize_handle.style.height=s.__ul.offsetHeight+"px"}),s.__closeButton&&(s.__closeButton.style.width=s.width+"px")},onResizeDebounced:N.debounce(function(){this.onResize()},50),remember:function(){if(N.isUndefined(Wr)&&((Wr=new il).domElement.innerHTML=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`),this.parent)throw new Error("You can only call remember on a top level GUI.");var s=this;N.each(Array.prototype.slice.call(arguments),function(e){s.__rememberedObjects.length===0&&function(t){var r=t.__save_row=document.createElement("li");I.addClass(t.domElement,"has-save"),t.__ul.insertBefore(r,t.__ul.firstChild),I.addClass(r,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;",I.addClass(n,"button gears");var i=document.createElement("span");i.innerHTML="Save",I.addClass(i,"button"),I.addClass(i,"save");var o=document.createElement("span");o.innerHTML="New",I.addClass(o,"button"),I.addClass(o,"save-as");var u=document.createElement("span");u.innerHTML="Revert",I.addClass(u,"button"),I.addClass(u,"revert");var l=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?N.each(t.load.remembered,function(x,g){Cn(t,g,g===t.preset)}):Cn(t,xr,!1),I.bind(l,"change",function(){for(var x=0;x<t.__preset_select.length;x++)t.__preset_select[x].innerHTML=t.__preset_select[x].value;t.preset=this.value}),r.appendChild(l),r.appendChild(n),r.appendChild(i),r.appendChild(o),r.appendChild(u),_r){var m=document.getElementById("dg-local-explain"),b=document.getElementById("dg-local-storage");document.getElementById("dg-save-locally").style.display="block",localStorage.getItem($t(t,"isLocal"))==="true"&&b.setAttribute("checked","checked"),Co(t,m),I.bind(b,"change",function(){t.useLocalStorage=!t.useLocalStorage,Co(t,m)})}var d=document.getElementById("dg-new-constructor");I.bind(d,"keydown",function(x){!x.metaKey||x.which!==67&&x.keyCode!==67||Wr.hide()}),I.bind(n,"click",function(){d.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),Wr.show(),d.focus(),d.select()}),I.bind(i,"click",function(){t.save()}),I.bind(o,"click",function(){var x=prompt("Enter a new preset name.");x&&t.saveAs(x)}),I.bind(u,"click",function(){t.revert()})}(s),s.__rememberedObjects.indexOf(e)===-1&&s.__rememberedObjects.push(e)}),this.autoPlace&&Tn(this,this.width)},getRoot:function(){for(var s=this;s.parent;)s=s.parent;return s},getSaveObject:function(){var s=this.load;return s.closed=this.closed,this.__rememberedObjects.length>0&&(s.preset=this.preset,s.remembered||(s.remembered={}),s.remembered[this.preset]=$r(this)),s.folders={},N.each(this.__folders,function(e,t){s.folders[t]=e.getSaveObject()}),s},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=$r(this),wn(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(s){this.load.remembered||(this.load.remembered={},this.load.remembered[xr]=$r(this,!0)),this.load.remembered[s]=$r(this),this.preset=s,Cn(this,s,!0),this.saveToLocalStorageIfPossible()},revert:function(s){N.each(this.__controllers,function(e){this.getRoot().load.remembered?wo(s||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())},this),N.each(this.__folders,function(e){e.revert(e)}),s||wn(this.getRoot(),!1)},listen:function(s){var e=this.__listening.length===0;this.__listening.push(s),e&&To(this.__listening)},updateDisplay:function(){N.each(this.__controllers,function(s){s.updateDisplay()}),N.each(this.__folders,function(s){s.updateDisplay()})}});var ul=le;const cl=(So=Array,Eo=s=>s.fill(0),class extends So{constructor(...s){super(...s),Eo(this)}});var So,Eo;let ne=1e-6;const Mo=new Map;function Po(s){let e=Mo.get(s);return e||(e=function(t){function r(a=0,c=0){const h=new t(2);return a!==void 0&&(h[0]=a,c!==void 0&&(h[1]=c)),h}function n(a,c,h){const y=h??new t(2);return y[0]=a[0]-c[0],y[1]=a[1]-c[1],y}function i(a,c,h,y){const A=y??new t(2);return A[0]=a[0]+h*(c[0]-a[0]),A[1]=a[1]+h*(c[1]-a[1]),A}function o(a,c,h){const y=h??new t(2);return y[0]=a[0]*c,y[1]=a[1]*c,y}function u(a,c){const h=c??new t(2);return h[0]=1/a[0],h[1]=1/a[1],h}function l(a,c){return a[0]*c[0]+a[1]*c[1]}function m(a){const c=a[0],h=a[1];return Math.sqrt(c*c+h*h)}function b(a){const c=a[0],h=a[1];return c*c+h*h}function d(a,c){const h=a[0]-c[0],y=a[1]-c[1];return Math.sqrt(h*h+y*y)}function x(a,c){const h=a[0]-c[0],y=a[1]-c[1];return h*h+y*y}function g(a,c){const h=c??new t(2),y=a[0],A=a[1],C=Math.sqrt(y*y+A*A);return C>1e-5?(h[0]=y/C,h[1]=A/C):(h[0]=0,h[1]=0),h}function _(a,c){const h=c??new t(2);return h[0]=a[0],h[1]=a[1],h}function w(a,c,h){const y=h??new t(2);return y[0]=a[0]*c[0],y[1]=a[1]*c[1],y}function f(a,c,h){const y=h??new t(2);return y[0]=a[0]/c[0],y[1]=a[1]/c[1],y}function p(a,c,h){const y=h??new t(2);return g(a,y),o(y,c,y)}return{create:r,fromValues:r,set:function(a,c,h){const y=h??new t(2);return y[0]=a,y[1]=c,y},ceil:function(a,c){const h=c??new t(2);return h[0]=Math.ceil(a[0]),h[1]=Math.ceil(a[1]),h},floor:function(a,c){const h=c??new t(2);return h[0]=Math.floor(a[0]),h[1]=Math.floor(a[1]),h},round:function(a,c){const h=c??new t(2);return h[0]=Math.round(a[0]),h[1]=Math.round(a[1]),h},clamp:function(a,c=0,h=1,y){const A=y??new t(2);return A[0]=Math.min(h,Math.max(c,a[0])),A[1]=Math.min(h,Math.max(c,a[1])),A},add:function(a,c,h){const y=h??new t(2);return y[0]=a[0]+c[0],y[1]=a[1]+c[1],y},addScaled:function(a,c,h,y){const A=y??new t(2);return A[0]=a[0]+c[0]*h,A[1]=a[1]+c[1]*h,A},angle:function(a,c){const h=a[0],y=a[1],A=c[0],C=c[1],R=Math.sqrt(h*h+y*y)*Math.sqrt(A*A+C*C),U=R&&l(a,c)/R;return Math.acos(U)},subtract:n,sub:n,equalsApproximately:function(a,c){return Math.abs(a[0]-c[0])<ne&&Math.abs(a[1]-c[1])<ne},equals:function(a,c){return a[0]===c[0]&&a[1]===c[1]},lerp:i,lerpV:function(a,c,h,y){const A=y??new t(2);return A[0]=a[0]+h[0]*(c[0]-a[0]),A[1]=a[1]+h[1]*(c[1]-a[1]),A},max:function(a,c,h){const y=h??new t(2);return y[0]=Math.max(a[0],c[0]),y[1]=Math.max(a[1],c[1]),y},min:function(a,c,h){const y=h??new t(2);return y[0]=Math.min(a[0],c[0]),y[1]=Math.min(a[1],c[1]),y},mulScalar:o,scale:o,divScalar:function(a,c,h){const y=h??new t(2);return y[0]=a[0]/c,y[1]=a[1]/c,y},inverse:u,invert:u,cross:function(a,c,h){const y=h??new t(3),A=a[0]*c[1]-a[1]*c[0];return y[0]=0,y[1]=0,y[2]=A,y},dot:l,length:m,len:m,lengthSq:b,lenSq:b,distance:d,dist:d,distanceSq:x,distSq:x,normalize:g,negate:function(a,c){const h=c??new t(2);return h[0]=-a[0],h[1]=-a[1],h},copy:_,clone:_,multiply:w,mul:w,divide:f,div:f,random:function(a=1,c){const h=c??new t(2),y=2*Math.random()*Math.PI;return h[0]=Math.cos(y)*a,h[1]=Math.sin(y)*a,h},zero:function(a){const c=a??new t(2);return c[0]=0,c[1]=0,c},transformMat4:function(a,c,h){const y=h??new t(2),A=a[0],C=a[1];return y[0]=A*c[0]+C*c[4]+c[12],y[1]=A*c[1]+C*c[5]+c[13],y},transformMat3:function(a,c,h){const y=h??new t(2),A=a[0],C=a[1];return y[0]=c[0]*A+c[4]*C+c[8],y[1]=c[1]*A+c[5]*C+c[9],y},rotate:function(a,c,h,y){const A=y??new t(2),C=a[0]-c[0],R=a[1]-c[1],U=Math.sin(h),k=Math.cos(h);return A[0]=C*k-R*U+c[0],A[1]=C*U+R*k+c[1],A},setLength:p,truncate:function(a,c,h){const y=h??new t(2);return m(a)>c?p(a,c,y):_(a,y)},midpoint:function(a,c,h){return i(a,c,.5,h??new t(2))}}}(s),Mo.set(s,e)),e}const Ro=new Map;function qr(s){let e=Ro.get(s);return e||(e=function(t){function r(a,c,h){const y=new t(3);return a!==void 0&&(y[0]=a,c!==void 0&&(y[1]=c,h!==void 0&&(y[2]=h))),y}function n(a,c,h){const y=h??new t(3);return y[0]=a[0]-c[0],y[1]=a[1]-c[1],y[2]=a[2]-c[2],y}function i(a,c,h,y){const A=y??new t(3);return A[0]=a[0]+h*(c[0]-a[0]),A[1]=a[1]+h*(c[1]-a[1]),A[2]=a[2]+h*(c[2]-a[2]),A}function o(a,c,h){const y=h??new t(3);return y[0]=a[0]*c,y[1]=a[1]*c,y[2]=a[2]*c,y}function u(a,c){const h=c??new t(3);return h[0]=1/a[0],h[1]=1/a[1],h[2]=1/a[2],h}function l(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]}function m(a){const c=a[0],h=a[1],y=a[2];return Math.sqrt(c*c+h*h+y*y)}function b(a){const c=a[0],h=a[1],y=a[2];return c*c+h*h+y*y}function d(a,c){const h=a[0]-c[0],y=a[1]-c[1],A=a[2]-c[2];return Math.sqrt(h*h+y*y+A*A)}function x(a,c){const h=a[0]-c[0],y=a[1]-c[1],A=a[2]-c[2];return h*h+y*y+A*A}function g(a,c){const h=c??new t(3),y=a[0],A=a[1],C=a[2],R=Math.sqrt(y*y+A*A+C*C);return R>1e-5?(h[0]=y/R,h[1]=A/R,h[2]=C/R):(h[0]=0,h[1]=0,h[2]=0),h}function _(a,c){const h=c??new t(3);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h}function w(a,c,h){const y=h??new t(3);return y[0]=a[0]*c[0],y[1]=a[1]*c[1],y[2]=a[2]*c[2],y}function f(a,c,h){const y=h??new t(3);return y[0]=a[0]/c[0],y[1]=a[1]/c[1],y[2]=a[2]/c[2],y}function p(a,c,h){const y=h??new t(3);return g(a,y),o(y,c,y)}return{create:r,fromValues:r,set:function(a,c,h,y){const A=y??new t(3);return A[0]=a,A[1]=c,A[2]=h,A},ceil:function(a,c){const h=c??new t(3);return h[0]=Math.ceil(a[0]),h[1]=Math.ceil(a[1]),h[2]=Math.ceil(a[2]),h},floor:function(a,c){const h=c??new t(3);return h[0]=Math.floor(a[0]),h[1]=Math.floor(a[1]),h[2]=Math.floor(a[2]),h},round:function(a,c){const h=c??new t(3);return h[0]=Math.round(a[0]),h[1]=Math.round(a[1]),h[2]=Math.round(a[2]),h},clamp:function(a,c=0,h=1,y){const A=y??new t(3);return A[0]=Math.min(h,Math.max(c,a[0])),A[1]=Math.min(h,Math.max(c,a[1])),A[2]=Math.min(h,Math.max(c,a[2])),A},add:function(a,c,h){const y=h??new t(3);return y[0]=a[0]+c[0],y[1]=a[1]+c[1],y[2]=a[2]+c[2],y},addScaled:function(a,c,h,y){const A=y??new t(3);return A[0]=a[0]+c[0]*h,A[1]=a[1]+c[1]*h,A[2]=a[2]+c[2]*h,A},angle:function(a,c){const h=a[0],y=a[1],A=a[2],C=c[0],R=c[1],U=c[2],k=Math.sqrt(h*h+y*y+A*A)*Math.sqrt(C*C+R*R+U*U),T=k&&l(a,c)/k;return Math.acos(T)},subtract:n,sub:n,equalsApproximately:function(a,c){return Math.abs(a[0]-c[0])<ne&&Math.abs(a[1]-c[1])<ne&&Math.abs(a[2]-c[2])<ne},equals:function(a,c){return a[0]===c[0]&&a[1]===c[1]&&a[2]===c[2]},lerp:i,lerpV:function(a,c,h,y){const A=y??new t(3);return A[0]=a[0]+h[0]*(c[0]-a[0]),A[1]=a[1]+h[1]*(c[1]-a[1]),A[2]=a[2]+h[2]*(c[2]-a[2]),A},max:function(a,c,h){const y=h??new t(3);return y[0]=Math.max(a[0],c[0]),y[1]=Math.max(a[1],c[1]),y[2]=Math.max(a[2],c[2]),y},min:function(a,c,h){const y=h??new t(3);return y[0]=Math.min(a[0],c[0]),y[1]=Math.min(a[1],c[1]),y[2]=Math.min(a[2],c[2]),y},mulScalar:o,scale:o,divScalar:function(a,c,h){const y=h??new t(3);return y[0]=a[0]/c,y[1]=a[1]/c,y[2]=a[2]/c,y},inverse:u,invert:u,cross:function(a,c,h){const y=h??new t(3),A=a[2]*c[0]-a[0]*c[2],C=a[0]*c[1]-a[1]*c[0];return y[0]=a[1]*c[2]-a[2]*c[1],y[1]=A,y[2]=C,y},dot:l,length:m,len:m,lengthSq:b,lenSq:b,distance:d,dist:d,distanceSq:x,distSq:x,normalize:g,negate:function(a,c){const h=c??new t(3);return h[0]=-a[0],h[1]=-a[1],h[2]=-a[2],h},copy:_,clone:_,multiply:w,mul:w,divide:f,div:f,random:function(a=1,c){const h=c??new t(3),y=2*Math.random()*Math.PI,A=2*Math.random()-1,C=Math.sqrt(1-A*A)*a;return h[0]=Math.cos(y)*C,h[1]=Math.sin(y)*C,h[2]=A*a,h},zero:function(a){const c=a??new t(3);return c[0]=0,c[1]=0,c[2]=0,c},transformMat4:function(a,c,h){const y=h??new t(3),A=a[0],C=a[1],R=a[2],U=c[3]*A+c[7]*C+c[11]*R+c[15]||1;return y[0]=(c[0]*A+c[4]*C+c[8]*R+c[12])/U,y[1]=(c[1]*A+c[5]*C+c[9]*R+c[13])/U,y[2]=(c[2]*A+c[6]*C+c[10]*R+c[14])/U,y},transformMat4Upper3x3:function(a,c,h){const y=h??new t(3),A=a[0],C=a[1],R=a[2];return y[0]=A*c[0]+C*c[4]+R*c[8],y[1]=A*c[1]+C*c[5]+R*c[9],y[2]=A*c[2]+C*c[6]+R*c[10],y},transformMat3:function(a,c,h){const y=h??new t(3),A=a[0],C=a[1],R=a[2];return y[0]=A*c[0]+C*c[4]+R*c[8],y[1]=A*c[1]+C*c[5]+R*c[9],y[2]=A*c[2]+C*c[6]+R*c[10],y},transformQuat:function(a,c,h){const y=h??new t(3),A=c[0],C=c[1],R=c[2],U=2*c[3],k=a[0],T=a[1],S=a[2],P=C*S-R*T,L=R*k-A*S,F=A*T-C*k;return y[0]=k+P*U+2*(C*F-R*L),y[1]=T+L*U+2*(R*P-A*F),y[2]=S+F*U+2*(A*L-C*P),y},getTranslation:function(a,c){const h=c??new t(3);return h[0]=a[12],h[1]=a[13],h[2]=a[14],h},getAxis:function(a,c,h){const y=h??new t(3),A=4*c;return y[0]=a[A+0],y[1]=a[A+1],y[2]=a[A+2],y},getScaling:function(a,c){const h=c??new t(3),y=a[0],A=a[1],C=a[2],R=a[4],U=a[5],k=a[6],T=a[8],S=a[9],P=a[10];return h[0]=Math.sqrt(y*y+A*A+C*C),h[1]=Math.sqrt(R*R+U*U+k*k),h[2]=Math.sqrt(T*T+S*S+P*P),h},rotateX:function(a,c,h,y){const A=y??new t(3),C=[],R=[];return C[0]=a[0]-c[0],C[1]=a[1]-c[1],C[2]=a[2]-c[2],R[0]=C[0],R[1]=C[1]*Math.cos(h)-C[2]*Math.sin(h),R[2]=C[1]*Math.sin(h)+C[2]*Math.cos(h),A[0]=R[0]+c[0],A[1]=R[1]+c[1],A[2]=R[2]+c[2],A},rotateY:function(a,c,h,y){const A=y??new t(3),C=[],R=[];return C[0]=a[0]-c[0],C[1]=a[1]-c[1],C[2]=a[2]-c[2],R[0]=C[2]*Math.sin(h)+C[0]*Math.cos(h),R[1]=C[1],R[2]=C[2]*Math.cos(h)-C[0]*Math.sin(h),A[0]=R[0]+c[0],A[1]=R[1]+c[1],A[2]=R[2]+c[2],A},rotateZ:function(a,c,h,y){const A=y??new t(3),C=[],R=[];return C[0]=a[0]-c[0],C[1]=a[1]-c[1],C[2]=a[2]-c[2],R[0]=C[0]*Math.cos(h)-C[1]*Math.sin(h),R[1]=C[0]*Math.sin(h)+C[1]*Math.cos(h),R[2]=C[2],A[0]=R[0]+c[0],A[1]=R[1]+c[1],A[2]=R[2]+c[2],A},setLength:p,truncate:function(a,c,h){const y=h??new t(3);return m(a)>c?p(a,c,y):_(a,y)},midpoint:function(a,c,h){return i(a,c,.5,h??new t(3))}}}(s),Ro.set(s,e)),e}const Go=new Map;function ll(s){let e=Go.get(s);return e||(e=function(t){const r=Po(t),n=qr(t);function i(d,x){const g=x??new t(12);return g[0]=d[0],g[1]=d[1],g[2]=d[2],g[4]=d[4],g[5]=d[5],g[6]=d[6],g[8]=d[8],g[9]=d[9],g[10]=d[10],g}function o(d){const x=d??new t(12);return x[0]=1,x[1]=0,x[2]=0,x[4]=0,x[5]=1,x[6]=0,x[8]=0,x[9]=0,x[10]=1,x}function u(d,x){const g=x??new t(12),_=d[0],w=d[1],f=d[2],p=d[4],a=d[5],c=d[6],h=d[8],y=d[9],A=d[10],C=A*a-c*y,R=-A*p+c*h,U=y*p-a*h,k=1/(_*C+w*R+f*U);return g[0]=C*k,g[1]=(-A*w+f*y)*k,g[2]=(c*w-f*a)*k,g[4]=R*k,g[5]=(A*_-f*h)*k,g[6]=(-c*_+f*p)*k,g[8]=U*k,g[9]=(-y*_+w*h)*k,g[10]=(a*_-w*p)*k,g}function l(d,x,g){const _=g??new t(12),w=d[0],f=d[1],p=d[2],a=d[4],c=d[5],h=d[6],y=d[8],A=d[9],C=d[10],R=x[0],U=x[1],k=x[2],T=x[4],S=x[5],P=x[6],L=x[8],F=x[9],O=x[10];return _[0]=w*R+a*U+y*k,_[1]=f*R+c*U+A*k,_[2]=p*R+h*U+C*k,_[4]=w*T+a*S+y*P,_[5]=f*T+c*S+A*P,_[6]=p*T+h*S+C*P,_[8]=w*L+a*F+y*O,_[9]=f*L+c*F+A*O,_[10]=p*L+h*F+C*O,_}function m(d,x){const g=x??new t(12),_=Math.cos(d),w=Math.sin(d);return g[0]=_,g[1]=w,g[2]=0,g[4]=-w,g[5]=_,g[6]=0,g[8]=0,g[9]=0,g[10]=1,g}function b(d,x,g){const _=g??new t(12),w=d[0],f=d[1],p=d[2],a=d[4],c=d[5],h=d[6],y=Math.cos(x),A=Math.sin(x);return _[0]=y*w+A*a,_[1]=y*f+A*c,_[2]=y*p+A*h,_[4]=y*a-A*w,_[5]=y*c-A*f,_[6]=y*h-A*p,d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_}return{clone:i,create:function(d,x,g,_,w,f,p,a,c){const h=new t(12);return h[3]=0,h[7]=0,h[11]=0,d!==void 0&&(h[0]=d,x!==void 0&&(h[1]=x,g!==void 0&&(h[2]=g,_!==void 0&&(h[4]=_,w!==void 0&&(h[5]=w,f!==void 0&&(h[6]=f,p!==void 0&&(h[8]=p,a!==void 0&&(h[9]=a,c!==void 0&&(h[10]=c))))))))),h},set:function(d,x,g,_,w,f,p,a,c,h){const y=h??new t(12);return y[0]=d,y[1]=x,y[2]=g,y[3]=0,y[4]=_,y[5]=w,y[6]=f,y[7]=0,y[8]=p,y[9]=a,y[10]=c,y[11]=0,y},fromMat4:function(d,x){const g=x??new t(12);return g[0]=d[0],g[1]=d[1],g[2]=d[2],g[3]=0,g[4]=d[4],g[5]=d[5],g[6]=d[6],g[7]=0,g[8]=d[8],g[9]=d[9],g[10]=d[10],g[11]=0,g},fromQuat:function(d,x){const g=x??new t(12),_=d[0],w=d[1],f=d[2],p=d[3],a=_+_,c=w+w,h=f+f,y=_*a,A=w*a,C=w*c,R=f*a,U=f*c,k=f*h,T=p*a,S=p*c,P=p*h;return g[0]=1-C-k,g[1]=A+P,g[2]=R-S,g[3]=0,g[4]=A-P,g[5]=1-y-k,g[6]=U+T,g[7]=0,g[8]=R+S,g[9]=U-T,g[10]=1-y-C,g[11]=0,g},negate:function(d,x){const g=x??new t(12);return g[0]=-d[0],g[1]=-d[1],g[2]=-d[2],g[4]=-d[4],g[5]=-d[5],g[6]=-d[6],g[8]=-d[8],g[9]=-d[9],g[10]=-d[10],g},copy:i,equalsApproximately:function(d,x){return Math.abs(d[0]-x[0])<ne&&Math.abs(d[1]-x[1])<ne&&Math.abs(d[2]-x[2])<ne&&Math.abs(d[4]-x[4])<ne&&Math.abs(d[5]-x[5])<ne&&Math.abs(d[6]-x[6])<ne&&Math.abs(d[8]-x[8])<ne&&Math.abs(d[9]-x[9])<ne&&Math.abs(d[10]-x[10])<ne},equals:function(d,x){return d[0]===x[0]&&d[1]===x[1]&&d[2]===x[2]&&d[4]===x[4]&&d[5]===x[5]&&d[6]===x[6]&&d[8]===x[8]&&d[9]===x[9]&&d[10]===x[10]},identity:o,transpose:function(d,x){const g=x??new t(12);if(g===d){let C;return C=d[1],d[1]=d[4],d[4]=C,C=d[2],d[2]=d[8],d[8]=C,C=d[6],d[6]=d[9],d[9]=C,g}const _=d[0],w=d[1],f=d[2],p=d[4],a=d[5],c=d[6],h=d[8],y=d[9],A=d[10];return g[0]=_,g[1]=p,g[2]=h,g[4]=w,g[5]=a,g[6]=y,g[8]=f,g[9]=c,g[10]=A,g},inverse:u,invert:u,determinant:function(d){const x=d[0],g=d[1],_=d[2],w=d[4],f=d[5],p=d[6],a=d[8],c=d[9],h=d[10];return x*(f*h-c*p)-w*(g*h-c*_)+a*(g*p-f*_)},mul:l,multiply:l,setTranslation:function(d,x,g){const _=g??o();return d!==_&&(_[0]=d[0],_[1]=d[1],_[2]=d[2],_[4]=d[4],_[5]=d[5],_[6]=d[6]),_[8]=x[0],_[9]=x[1],_[10]=1,_},getTranslation:function(d,x){const g=x??r.create();return g[0]=d[8],g[1]=d[9],g},getAxis:function(d,x,g){const _=g??r.create(),w=4*x;return _[0]=d[w+0],_[1]=d[w+1],_},setAxis:function(d,x,g,_){const w=_===d?d:i(d,_),f=4*g;return w[f+0]=x[0],w[f+1]=x[1],w},getScaling:function(d,x){const g=x??r.create(),_=d[0],w=d[1],f=d[4],p=d[5];return g[0]=Math.sqrt(_*_+w*w),g[1]=Math.sqrt(f*f+p*p),g},get3DScaling:function(d,x){const g=x??n.create(),_=d[0],w=d[1],f=d[2],p=d[4],a=d[5],c=d[6],h=d[8],y=d[9],A=d[10];return g[0]=Math.sqrt(_*_+w*w+f*f),g[1]=Math.sqrt(p*p+a*a+c*c),g[2]=Math.sqrt(h*h+y*y+A*A),g},translation:function(d,x){const g=x??new t(12);return g[0]=1,g[1]=0,g[2]=0,g[4]=0,g[5]=1,g[6]=0,g[8]=d[0],g[9]=d[1],g[10]=1,g},translate:function(d,x,g){const _=g??new t(12),w=x[0],f=x[1],p=d[0],a=d[1],c=d[2],h=d[4],y=d[5],A=d[6],C=d[8],R=d[9],U=d[10];return d!==_&&(_[0]=p,_[1]=a,_[2]=c,_[4]=h,_[5]=y,_[6]=A),_[8]=p*w+h*f+C,_[9]=a*w+y*f+R,_[10]=c*w+A*f+U,_},rotation:m,rotate:b,rotationX:function(d,x){const g=x??new t(12),_=Math.cos(d),w=Math.sin(d);return g[0]=1,g[1]=0,g[2]=0,g[4]=0,g[5]=_,g[6]=w,g[8]=0,g[9]=-w,g[10]=_,g},rotateX:function(d,x,g){const _=g??new t(12),w=d[4],f=d[5],p=d[6],a=d[8],c=d[9],h=d[10],y=Math.cos(x),A=Math.sin(x);return _[4]=y*w+A*a,_[5]=y*f+A*c,_[6]=y*p+A*h,_[8]=y*a-A*w,_[9]=y*c-A*f,_[10]=y*h-A*p,d!==_&&(_[0]=d[0],_[1]=d[1],_[2]=d[2]),_},rotationY:function(d,x){const g=x??new t(12),_=Math.cos(d),w=Math.sin(d);return g[0]=_,g[1]=0,g[2]=-w,g[4]=0,g[5]=1,g[6]=0,g[8]=w,g[9]=0,g[10]=_,g},rotateY:function(d,x,g){const _=g??new t(12),w=d[0],f=d[1],p=d[2],a=d[8],c=d[9],h=d[10],y=Math.cos(x),A=Math.sin(x);return _[0]=y*w-A*a,_[1]=y*f-A*c,_[2]=y*p-A*h,_[8]=y*a+A*w,_[9]=y*c+A*f,_[10]=y*h+A*p,d!==_&&(_[4]=d[4],_[5]=d[5],_[6]=d[6]),_},rotationZ:m,rotateZ:b,scaling:function(d,x){const g=x??new t(12);return g[0]=d[0],g[1]=0,g[2]=0,g[4]=0,g[5]=d[1],g[6]=0,g[8]=0,g[9]=0,g[10]=1,g},scale:function(d,x,g){const _=g??new t(12),w=x[0],f=x[1];return _[0]=w*d[0],_[1]=w*d[1],_[2]=w*d[2],_[4]=f*d[4],_[5]=f*d[5],_[6]=f*d[6],d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_},uniformScaling:function(d,x){const g=x??new t(12);return g[0]=d,g[1]=0,g[2]=0,g[4]=0,g[5]=d,g[6]=0,g[8]=0,g[9]=0,g[10]=1,g},uniformScale:function(d,x,g){const _=g??new t(12);return _[0]=x*d[0],_[1]=x*d[1],_[2]=x*d[2],_[4]=x*d[4],_[5]=x*d[5],_[6]=x*d[6],d!==_&&(_[8]=d[8],_[9]=d[9],_[10]=d[10]),_},scaling3D:function(d,x){const g=x??new t(12);return g[0]=d[0],g[1]=0,g[2]=0,g[4]=0,g[5]=d[1],g[6]=0,g[8]=0,g[9]=0,g[10]=d[2],g},scale3D:function(d,x,g){const _=g??new t(12),w=x[0],f=x[1],p=x[2];return _[0]=w*d[0],_[1]=w*d[1],_[2]=w*d[2],_[4]=f*d[4],_[5]=f*d[5],_[6]=f*d[6],_[8]=p*d[8],_[9]=p*d[9],_[10]=p*d[10],_},uniformScaling3D:function(d,x){const g=x??new t(12);return g[0]=d,g[1]=0,g[2]=0,g[4]=0,g[5]=d,g[6]=0,g[8]=0,g[9]=0,g[10]=d,g},uniformScale3D:function(d,x,g){const _=g??new t(12);return _[0]=x*d[0],_[1]=x*d[1],_[2]=x*d[2],_[4]=x*d[4],_[5]=x*d[5],_[6]=x*d[6],_[8]=x*d[8],_[9]=x*d[9],_[10]=x*d[10],_}}}(s),Go.set(s,e)),e}const Lo=new Map;function dl(s){let e=Lo.get(s);return e||(e=function(t){const r=qr(t);function n(f,p){const a=p??new t(16);return a[0]=f[0],a[1]=f[1],a[2]=f[2],a[3]=f[3],a[4]=f[4],a[5]=f[5],a[6]=f[6],a[7]=f[7],a[8]=f[8],a[9]=f[9],a[10]=f[10],a[11]=f[11],a[12]=f[12],a[13]=f[13],a[14]=f[14],a[15]=f[15],a}const i=n;function o(f){const p=f??new t(16);return p[0]=1,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=1,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=1,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p}function u(f,p){const a=p??new t(16),c=f[0],h=f[1],y=f[2],A=f[3],C=f[4],R=f[5],U=f[6],k=f[7],T=f[8],S=f[9],P=f[10],L=f[11],F=f[12],O=f[13],H=f[14],K=f[15],X=P*K,j=H*L,z=U*K,q=H*k,Z=U*L,te=P*k,re=y*K,fe=H*A,pe=y*L,ge=P*A,Ge=y*k,Le=U*A,Oe=T*O,Ie=F*S,Fe=C*O,De=F*R,Ue=C*S,ln=T*R,dn=c*O,hn=F*h,fn=c*S,pn=T*h,mn=c*R,gn=C*h,Kc=X*R+q*S+Z*O-(j*R+z*S+te*O),Xc=j*h+re*S+ge*O-(X*h+fe*S+pe*O),Yc=z*h+fe*R+Ge*O-(q*h+re*R+Le*O),Wc=te*h+pe*R+Le*S-(Z*h+ge*R+Ge*S),ve=1/(c*Kc+C*Xc+T*Yc+F*Wc);return a[0]=ve*Kc,a[1]=ve*Xc,a[2]=ve*Yc,a[3]=ve*Wc,a[4]=ve*(j*C+z*T+te*F-(X*C+q*T+Z*F)),a[5]=ve*(X*c+fe*T+pe*F-(j*c+re*T+ge*F)),a[6]=ve*(q*c+re*C+Le*F-(z*c+fe*C+Ge*F)),a[7]=ve*(Z*c+ge*C+Ge*T-(te*c+pe*C+Le*T)),a[8]=ve*(Oe*k+De*L+Ue*K-(Ie*k+Fe*L+ln*K)),a[9]=ve*(Ie*A+dn*L+pn*K-(Oe*A+hn*L+fn*K)),a[10]=ve*(Fe*A+hn*k+mn*K-(De*A+dn*k+gn*K)),a[11]=ve*(ln*A+fn*k+gn*L-(Ue*A+pn*k+mn*L)),a[12]=ve*(Fe*P+ln*H+Ie*U-(Ue*H+Oe*U+De*P)),a[13]=ve*(fn*H+Oe*y+hn*P-(dn*P+pn*H+Ie*y)),a[14]=ve*(dn*U+gn*H+De*y-(mn*H+Fe*y+hn*U)),a[15]=ve*(mn*P+Ue*y+pn*U-(fn*U+gn*P+ln*y)),a}const l=u;function m(f,p,a){const c=a??new t(16),h=f[0],y=f[1],A=f[2],C=f[3],R=f[4],U=f[5],k=f[6],T=f[7],S=f[8],P=f[9],L=f[10],F=f[11],O=f[12],H=f[13],K=f[14],X=f[15],j=p[0],z=p[1],q=p[2],Z=p[3],te=p[4],re=p[5],fe=p[6],pe=p[7],ge=p[8],Ge=p[9],Le=p[10],Oe=p[11],Ie=p[12],Fe=p[13],De=p[14],Ue=p[15];return c[0]=h*j+R*z+S*q+O*Z,c[1]=y*j+U*z+P*q+H*Z,c[2]=A*j+k*z+L*q+K*Z,c[3]=C*j+T*z+F*q+X*Z,c[4]=h*te+R*re+S*fe+O*pe,c[5]=y*te+U*re+P*fe+H*pe,c[6]=A*te+k*re+L*fe+K*pe,c[7]=C*te+T*re+F*fe+X*pe,c[8]=h*ge+R*Ge+S*Le+O*Oe,c[9]=y*ge+U*Ge+P*Le+H*Oe,c[10]=A*ge+k*Ge+L*Le+K*Oe,c[11]=C*ge+T*Ge+F*Le+X*Oe,c[12]=h*Ie+R*Fe+S*De+O*Ue,c[13]=y*Ie+U*Fe+P*De+H*Ue,c[14]=A*Ie+k*Fe+L*De+K*Ue,c[15]=C*Ie+T*Fe+F*De+X*Ue,c}const b=m,d=r.create(),x=r.create(),g=r.create();function _(f,p,a){const c=a??new t(16);let h=f[0],y=f[1],A=f[2];const C=Math.sqrt(h*h+y*y+A*A);h/=C,y/=C,A/=C;const R=h*h,U=y*y,k=A*A,T=Math.cos(p),S=Math.sin(p),P=1-T;return c[0]=R+(1-R)*T,c[1]=h*y*P+A*S,c[2]=h*A*P-y*S,c[3]=0,c[4]=h*y*P-A*S,c[5]=U+(1-U)*T,c[6]=y*A*P+h*S,c[7]=0,c[8]=h*A*P+y*S,c[9]=y*A*P-h*S,c[10]=k+(1-k)*T,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c}function w(f,p,a,c){const h=c??new t(16);let y=p[0],A=p[1],C=p[2];const R=Math.sqrt(y*y+A*A+C*C);y/=R,A/=R,C/=R;const U=y*y,k=A*A,T=C*C,S=Math.cos(a),P=Math.sin(a),L=1-S,F=U+(1-U)*S,O=y*A*L+C*P,H=y*C*L-A*P,K=y*A*L-C*P,X=k+(1-k)*S,j=A*C*L+y*P,z=y*C*L+A*P,q=A*C*L-y*P,Z=T+(1-T)*S,te=f[0],re=f[1],fe=f[2],pe=f[3],ge=f[4],Ge=f[5],Le=f[6],Oe=f[7],Ie=f[8],Fe=f[9],De=f[10],Ue=f[11];return h[0]=F*te+O*ge+H*Ie,h[1]=F*re+O*Ge+H*Fe,h[2]=F*fe+O*Le+H*De,h[3]=F*pe+O*Oe+H*Ue,h[4]=K*te+X*ge+j*Ie,h[5]=K*re+X*Ge+j*Fe,h[6]=K*fe+X*Le+j*De,h[7]=K*pe+X*Oe+j*Ue,h[8]=z*te+q*ge+Z*Ie,h[9]=z*re+q*Ge+Z*Fe,h[10]=z*fe+q*Le+Z*De,h[11]=z*pe+q*Oe+Z*Ue,f!==h&&(h[12]=f[12],h[13]=f[13],h[14]=f[14],h[15]=f[15]),h}return{create:function(f,p,a,c,h,y,A,C,R,U,k,T,S,P,L,F){const O=new t(16);return f!==void 0&&(O[0]=f,p!==void 0&&(O[1]=p,a!==void 0&&(O[2]=a,c!==void 0&&(O[3]=c,h!==void 0&&(O[4]=h,y!==void 0&&(O[5]=y,A!==void 0&&(O[6]=A,C!==void 0&&(O[7]=C,R!==void 0&&(O[8]=R,U!==void 0&&(O[9]=U,k!==void 0&&(O[10]=k,T!==void 0&&(O[11]=T,S!==void 0&&(O[12]=S,P!==void 0&&(O[13]=P,L!==void 0&&(O[14]=L,F!==void 0&&(O[15]=F)))))))))))))))),O},set:function(f,p,a,c,h,y,A,C,R,U,k,T,S,P,L,F,O){const H=O??new t(16);return H[0]=f,H[1]=p,H[2]=a,H[3]=c,H[4]=h,H[5]=y,H[6]=A,H[7]=C,H[8]=R,H[9]=U,H[10]=k,H[11]=T,H[12]=S,H[13]=P,H[14]=L,H[15]=F,H},fromMat3:function(f,p){const a=p??new t(16);return a[0]=f[0],a[1]=f[1],a[2]=f[2],a[3]=0,a[4]=f[4],a[5]=f[5],a[6]=f[6],a[7]=0,a[8]=f[8],a[9]=f[9],a[10]=f[10],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},fromQuat:function(f,p){const a=p??new t(16),c=f[0],h=f[1],y=f[2],A=f[3],C=c+c,R=h+h,U=y+y,k=c*C,T=h*C,S=h*R,P=y*C,L=y*R,F=y*U,O=A*C,H=A*R,K=A*U;return a[0]=1-S-F,a[1]=T+K,a[2]=P-H,a[3]=0,a[4]=T-K,a[5]=1-k-F,a[6]=L+O,a[7]=0,a[8]=P+H,a[9]=L-O,a[10]=1-k-S,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},negate:function(f,p){const a=p??new t(16);return a[0]=-f[0],a[1]=-f[1],a[2]=-f[2],a[3]=-f[3],a[4]=-f[4],a[5]=-f[5],a[6]=-f[6],a[7]=-f[7],a[8]=-f[8],a[9]=-f[9],a[10]=-f[10],a[11]=-f[11],a[12]=-f[12],a[13]=-f[13],a[14]=-f[14],a[15]=-f[15],a},copy:n,clone:i,equalsApproximately:function(f,p){return Math.abs(f[0]-p[0])<ne&&Math.abs(f[1]-p[1])<ne&&Math.abs(f[2]-p[2])<ne&&Math.abs(f[3]-p[3])<ne&&Math.abs(f[4]-p[4])<ne&&Math.abs(f[5]-p[5])<ne&&Math.abs(f[6]-p[6])<ne&&Math.abs(f[7]-p[7])<ne&&Math.abs(f[8]-p[8])<ne&&Math.abs(f[9]-p[9])<ne&&Math.abs(f[10]-p[10])<ne&&Math.abs(f[11]-p[11])<ne&&Math.abs(f[12]-p[12])<ne&&Math.abs(f[13]-p[13])<ne&&Math.abs(f[14]-p[14])<ne&&Math.abs(f[15]-p[15])<ne},equals:function(f,p){return f[0]===p[0]&&f[1]===p[1]&&f[2]===p[2]&&f[3]===p[3]&&f[4]===p[4]&&f[5]===p[5]&&f[6]===p[6]&&f[7]===p[7]&&f[8]===p[8]&&f[9]===p[9]&&f[10]===p[10]&&f[11]===p[11]&&f[12]===p[12]&&f[13]===p[13]&&f[14]===p[14]&&f[15]===p[15]},identity:o,transpose:function(f,p){const a=p??new t(16);if(a===f){let X;return X=f[1],f[1]=f[4],f[4]=X,X=f[2],f[2]=f[8],f[8]=X,X=f[3],f[3]=f[12],f[12]=X,X=f[6],f[6]=f[9],f[9]=X,X=f[7],f[7]=f[13],f[13]=X,X=f[11],f[11]=f[14],f[14]=X,a}const c=f[0],h=f[1],y=f[2],A=f[3],C=f[4],R=f[5],U=f[6],k=f[7],T=f[8],S=f[9],P=f[10],L=f[11],F=f[12],O=f[13],H=f[14],K=f[15];return a[0]=c,a[1]=C,a[2]=T,a[3]=F,a[4]=h,a[5]=R,a[6]=S,a[7]=O,a[8]=y,a[9]=U,a[10]=P,a[11]=H,a[12]=A,a[13]=k,a[14]=L,a[15]=K,a},inverse:u,determinant:function(f){const p=f[0],a=f[1],c=f[2],h=f[3],y=f[4],A=f[5],C=f[6],R=f[7],U=f[8],k=f[9],T=f[10],S=f[11],P=f[12],L=f[13],F=f[14],O=f[15],H=T*O,K=F*S,X=C*O,j=F*R,z=C*S,q=T*R,Z=c*O,te=F*h,re=c*S,fe=T*h,pe=c*R,ge=C*h;return p*(H*A+j*k+z*L-(K*A+X*k+q*L))+y*(K*a+Z*k+fe*L-(H*a+te*k+re*L))+U*(X*a+te*A+pe*L-(j*a+Z*A+ge*L))+P*(q*a+re*A+ge*k-(z*a+fe*A+pe*k))},invert:l,multiply:m,mul:b,setTranslation:function(f,p,a){const c=a??o();return f!==c&&(c[0]=f[0],c[1]=f[1],c[2]=f[2],c[3]=f[3],c[4]=f[4],c[5]=f[5],c[6]=f[6],c[7]=f[7],c[8]=f[8],c[9]=f[9],c[10]=f[10],c[11]=f[11]),c[12]=p[0],c[13]=p[1],c[14]=p[2],c[15]=1,c},getTranslation:function(f,p){const a=p??r.create();return a[0]=f[12],a[1]=f[13],a[2]=f[14],a},getAxis:function(f,p,a){const c=a??r.create(),h=4*p;return c[0]=f[h+0],c[1]=f[h+1],c[2]=f[h+2],c},setAxis:function(f,p,a,c){const h=c===f?c:n(f,c),y=4*a;return h[y+0]=p[0],h[y+1]=p[1],h[y+2]=p[2],h},getScaling:function(f,p){const a=p??r.create(),c=f[0],h=f[1],y=f[2],A=f[4],C=f[5],R=f[6],U=f[8],k=f[9],T=f[10];return a[0]=Math.sqrt(c*c+h*h+y*y),a[1]=Math.sqrt(A*A+C*C+R*R),a[2]=Math.sqrt(U*U+k*k+T*T),a},perspective:function(f,p,a,c,h){const y=h??new t(16),A=Math.tan(.5*Math.PI-.5*f);if(y[0]=A/p,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=A,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,Number.isFinite(c)){const C=1/(a-c);y[10]=c*C,y[14]=c*a*C}else y[10]=-1,y[14]=-a;return y},perspectiveReverseZ:function(f,p,a,c=1/0,h){const y=h??new t(16),A=1/Math.tan(.5*f);if(y[0]=A/p,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=A,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,c===1/0)y[10]=0,y[14]=a;else{const C=1/(c-a);y[10]=a*C,y[14]=c*a*C}return y},ortho:function(f,p,a,c,h,y,A){const C=A??new t(16);return C[0]=2/(p-f),C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2/(c-a),C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1/(h-y),C[11]=0,C[12]=(p+f)/(f-p),C[13]=(c+a)/(a-c),C[14]=h/(h-y),C[15]=1,C},frustum:function(f,p,a,c,h,y,A){const C=A??new t(16),R=p-f,U=c-a,k=h-y;return C[0]=2*h/R,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2*h/U,C[6]=0,C[7]=0,C[8]=(f+p)/R,C[9]=(c+a)/U,C[10]=y/k,C[11]=-1,C[12]=0,C[13]=0,C[14]=h*y/k,C[15]=0,C},frustumReverseZ:function(f,p,a,c,h,y=1/0,A){const C=A??new t(16),R=p-f,U=c-a;if(C[0]=2*h/R,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2*h/U,C[6]=0,C[7]=0,C[8]=(f+p)/R,C[9]=(c+a)/U,C[11]=-1,C[12]=0,C[13]=0,C[15]=0,y===1/0)C[10]=0,C[14]=h;else{const k=1/(y-h);C[10]=h*k,C[14]=y*h*k}return C},aim:function(f,p,a,c){const h=c??new t(16);return r.normalize(r.subtract(p,f,g),g),r.normalize(r.cross(a,g,d),d),r.normalize(r.cross(g,d,x),x),h[0]=d[0],h[1]=d[1],h[2]=d[2],h[3]=0,h[4]=x[0],h[5]=x[1],h[6]=x[2],h[7]=0,h[8]=g[0],h[9]=g[1],h[10]=g[2],h[11]=0,h[12]=f[0],h[13]=f[1],h[14]=f[2],h[15]=1,h},cameraAim:function(f,p,a,c){const h=c??new t(16);return r.normalize(r.subtract(f,p,g),g),r.normalize(r.cross(a,g,d),d),r.normalize(r.cross(g,d,x),x),h[0]=d[0],h[1]=d[1],h[2]=d[2],h[3]=0,h[4]=x[0],h[5]=x[1],h[6]=x[2],h[7]=0,h[8]=g[0],h[9]=g[1],h[10]=g[2],h[11]=0,h[12]=f[0],h[13]=f[1],h[14]=f[2],h[15]=1,h},lookAt:function(f,p,a,c){const h=c??new t(16);return r.normalize(r.subtract(f,p,g),g),r.normalize(r.cross(a,g,d),d),r.normalize(r.cross(g,d,x),x),h[0]=d[0],h[1]=x[0],h[2]=g[0],h[3]=0,h[4]=d[1],h[5]=x[1],h[6]=g[1],h[7]=0,h[8]=d[2],h[9]=x[2],h[10]=g[2],h[11]=0,h[12]=-(d[0]*f[0]+d[1]*f[1]+d[2]*f[2]),h[13]=-(x[0]*f[0]+x[1]*f[1]+x[2]*f[2]),h[14]=-(g[0]*f[0]+g[1]*f[1]+g[2]*f[2]),h[15]=1,h},translation:function(f,p){const a=p??new t(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=f[0],a[13]=f[1],a[14]=f[2],a[15]=1,a},translate:function(f,p,a){const c=a??new t(16),h=p[0],y=p[1],A=p[2],C=f[0],R=f[1],U=f[2],k=f[3],T=f[4],S=f[5],P=f[6],L=f[7],F=f[8],O=f[9],H=f[10],K=f[11],X=f[12],j=f[13],z=f[14],q=f[15];return f!==c&&(c[0]=C,c[1]=R,c[2]=U,c[3]=k,c[4]=T,c[5]=S,c[6]=P,c[7]=L,c[8]=F,c[9]=O,c[10]=H,c[11]=K),c[12]=C*h+T*y+F*A+X,c[13]=R*h+S*y+O*A+j,c[14]=U*h+P*y+H*A+z,c[15]=k*h+L*y+K*A+q,c},rotationX:function(f,p){const a=p??new t(16),c=Math.cos(f),h=Math.sin(f);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=c,a[6]=h,a[7]=0,a[8]=0,a[9]=-h,a[10]=c,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},rotateX:function(f,p,a){const c=a??new t(16),h=f[4],y=f[5],A=f[6],C=f[7],R=f[8],U=f[9],k=f[10],T=f[11],S=Math.cos(p),P=Math.sin(p);return c[4]=S*h+P*R,c[5]=S*y+P*U,c[6]=S*A+P*k,c[7]=S*C+P*T,c[8]=S*R-P*h,c[9]=S*U-P*y,c[10]=S*k-P*A,c[11]=S*T-P*C,f!==c&&(c[0]=f[0],c[1]=f[1],c[2]=f[2],c[3]=f[3],c[12]=f[12],c[13]=f[13],c[14]=f[14],c[15]=f[15]),c},rotationY:function(f,p){const a=p??new t(16),c=Math.cos(f),h=Math.sin(f);return a[0]=c,a[1]=0,a[2]=-h,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=h,a[9]=0,a[10]=c,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},rotateY:function(f,p,a){const c=a??new t(16),h=f[0],y=f[1],A=f[2],C=f[3],R=f[8],U=f[9],k=f[10],T=f[11],S=Math.cos(p),P=Math.sin(p);return c[0]=S*h-P*R,c[1]=S*y-P*U,c[2]=S*A-P*k,c[3]=S*C-P*T,c[8]=S*R+P*h,c[9]=S*U+P*y,c[10]=S*k+P*A,c[11]=S*T+P*C,f!==c&&(c[4]=f[4],c[5]=f[5],c[6]=f[6],c[7]=f[7],c[12]=f[12],c[13]=f[13],c[14]=f[14],c[15]=f[15]),c},rotationZ:function(f,p){const a=p??new t(16),c=Math.cos(f),h=Math.sin(f);return a[0]=c,a[1]=h,a[2]=0,a[3]=0,a[4]=-h,a[5]=c,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},rotateZ:function(f,p,a){const c=a??new t(16),h=f[0],y=f[1],A=f[2],C=f[3],R=f[4],U=f[5],k=f[6],T=f[7],S=Math.cos(p),P=Math.sin(p);return c[0]=S*h+P*R,c[1]=S*y+P*U,c[2]=S*A+P*k,c[3]=S*C+P*T,c[4]=S*R-P*h,c[5]=S*U-P*y,c[6]=S*k-P*A,c[7]=S*T-P*C,f!==c&&(c[8]=f[8],c[9]=f[9],c[10]=f[10],c[11]=f[11],c[12]=f[12],c[13]=f[13],c[14]=f[14],c[15]=f[15]),c},axisRotation:_,rotation:_,axisRotate:w,rotate:w,scaling:function(f,p){const a=p??new t(16);return a[0]=f[0],a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f[1],a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=f[2],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},scale:function(f,p,a){const c=a??new t(16),h=p[0],y=p[1],A=p[2];return c[0]=h*f[0],c[1]=h*f[1],c[2]=h*f[2],c[3]=h*f[3],c[4]=y*f[4],c[5]=y*f[5],c[6]=y*f[6],c[7]=y*f[7],c[8]=A*f[8],c[9]=A*f[9],c[10]=A*f[10],c[11]=A*f[11],f!==c&&(c[12]=f[12],c[13]=f[13],c[14]=f[14],c[15]=f[15]),c},uniformScaling:function(f,p){const a=p??new t(16);return a[0]=f,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=f,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},uniformScale:function(f,p,a){const c=a??new t(16);return c[0]=p*f[0],c[1]=p*f[1],c[2]=p*f[2],c[3]=p*f[3],c[4]=p*f[4],c[5]=p*f[5],c[6]=p*f[6],c[7]=p*f[7],c[8]=p*f[8],c[9]=p*f[9],c[10]=p*f[10],c[11]=p*f[11],f!==c&&(c[12]=f[12],c[13]=f[13],c[14]=f[14],c[15]=f[15]),c}}}(s),Lo.set(s,e)),e}const Oo=new Map;function hl(s){let e=Oo.get(s);return e||(e=function(t){const r=qr(t);function n(T,S,P,L){const F=new t(4);return T!==void 0&&(F[0]=T,S!==void 0&&(F[1]=S,P!==void 0&&(F[2]=P,L!==void 0&&(F[3]=L)))),F}const i=n;function o(T,S,P){const L=P??new t(4),F=.5*S,O=Math.sin(F);return L[0]=O*T[0],L[1]=O*T[1],L[2]=O*T[2],L[3]=Math.cos(F),L}function u(T,S,P){const L=P??new t(4),F=T[0],O=T[1],H=T[2],K=T[3],X=S[0],j=S[1],z=S[2],q=S[3];return L[0]=F*q+K*X+O*z-H*j,L[1]=O*q+K*j+H*X-F*z,L[2]=H*q+K*z+F*j-O*X,L[3]=K*q-F*X-O*j-H*z,L}const l=u;function m(T,S,P,L){const F=L??new t(4),O=T[0],H=T[1],K=T[2],X=T[3];let j,z,q=S[0],Z=S[1],te=S[2],re=S[3],fe=O*q+H*Z+K*te+X*re;if(fe<0&&(fe=-fe,q=-q,Z=-Z,te=-te,re=-re),1-fe>ne){const pe=Math.acos(fe),ge=Math.sin(pe);j=Math.sin((1-P)*pe)/ge,z=Math.sin(P*pe)/ge}else j=1-P,z=P;return F[0]=j*O+z*q,F[1]=j*H+z*Z,F[2]=j*K+z*te,F[3]=j*X+z*re,F}function b(T,S){const P=S??new t(4);return P[0]=T[0],P[1]=T[1],P[2]=T[2],P[3]=T[3],P}const d=b;function x(T,S,P){const L=P??new t(4);return L[0]=T[0]-S[0],L[1]=T[1]-S[1],L[2]=T[2]-S[2],L[3]=T[3]-S[3],L}const g=x;function _(T,S,P){const L=P??new t(4);return L[0]=T[0]*S,L[1]=T[1]*S,L[2]=T[2]*S,L[3]=T[3]*S,L}const w=_;function f(T,S){return T[0]*S[0]+T[1]*S[1]+T[2]*S[2]+T[3]*S[3]}function p(T){const S=T[0],P=T[1],L=T[2],F=T[3];return Math.sqrt(S*S+P*P+L*L+F*F)}const a=p;function c(T){const S=T[0],P=T[1],L=T[2],F=T[3];return S*S+P*P+L*L+F*F}const h=c;function y(T,S){const P=S??new t(4),L=T[0],F=T[1],O=T[2],H=T[3],K=Math.sqrt(L*L+F*F+O*O+H*H);return K>1e-5?(P[0]=L/K,P[1]=F/K,P[2]=O/K,P[3]=H/K):(P[0]=0,P[1]=0,P[2]=0,P[3]=1),P}const A=r.create(),C=r.create(),R=r.create(),U=new t(4),k=new t(4);return{create:n,fromValues:i,set:function(T,S,P,L,F){const O=F??new t(4);return O[0]=T,O[1]=S,O[2]=P,O[3]=L,O},fromAxisAngle:o,toAxisAngle:function(T,S){const P=S??r.create(3),L=2*Math.acos(T[3]),F=Math.sin(.5*L);return F>ne?(P[0]=T[0]/F,P[1]=T[1]/F,P[2]=T[2]/F):(P[0]=1,P[1]=0,P[2]=0),{angle:L,axis:P}},angle:function(T,S){const P=f(T,S);return Math.acos(2*P*P-1)},multiply:u,mul:l,rotateX:function(T,S,P){const L=P??new t(4),F=.5*S,O=T[0],H=T[1],K=T[2],X=T[3],j=Math.sin(F),z=Math.cos(F);return L[0]=O*z+X*j,L[1]=H*z+K*j,L[2]=K*z-H*j,L[3]=X*z-O*j,L},rotateY:function(T,S,P){const L=P??new t(4),F=.5*S,O=T[0],H=T[1],K=T[2],X=T[3],j=Math.sin(F),z=Math.cos(F);return L[0]=O*z-K*j,L[1]=H*z+X*j,L[2]=K*z+O*j,L[3]=X*z-H*j,L},rotateZ:function(T,S,P){const L=P??new t(4),F=.5*S,O=T[0],H=T[1],K=T[2],X=T[3],j=Math.sin(F),z=Math.cos(F);return L[0]=O*z+H*j,L[1]=H*z-O*j,L[2]=K*z+X*j,L[3]=X*z-K*j,L},slerp:m,inverse:function(T,S){const P=S??new t(4),L=T[0],F=T[1],O=T[2],H=T[3],K=L*L+F*F+O*O+H*H,X=K?1/K:0;return P[0]=-L*X,P[1]=-F*X,P[2]=-O*X,P[3]=H*X,P},conjugate:function(T,S){const P=S??new t(4);return P[0]=-T[0],P[1]=-T[1],P[2]=-T[2],P[3]=T[3],P},fromMat:function(T,S){const P=S??new t(4),L=T[0]+T[5]+T[10];if(L>0){const F=Math.sqrt(L+1);P[3]=.5*F;const O=.5/F;P[0]=(T[6]-T[9])*O,P[1]=(T[8]-T[2])*O,P[2]=(T[1]-T[4])*O}else{let F=0;T[5]>T[0]&&(F=1),T[10]>T[4*F+F]&&(F=2);const O=(F+1)%3,H=(F+2)%3,K=Math.sqrt(T[4*F+F]-T[4*O+O]-T[4*H+H]+1);P[F]=.5*K;const X=.5/K;P[3]=(T[4*O+H]-T[4*H+O])*X,P[O]=(T[4*O+F]+T[4*F+O])*X,P[H]=(T[4*H+F]+T[4*F+H])*X}return P},fromEuler:function(T,S,P,L,F){const O=F??new t(4),H=.5*T,K=.5*S,X=.5*P,j=Math.sin(H),z=Math.cos(H),q=Math.sin(K),Z=Math.cos(K),te=Math.sin(X),re=Math.cos(X);switch(L){case"xyz":O[0]=j*Z*re+z*q*te,O[1]=z*q*re-j*Z*te,O[2]=z*Z*te+j*q*re,O[3]=z*Z*re-j*q*te;break;case"xzy":O[0]=j*Z*re-z*q*te,O[1]=z*q*re-j*Z*te,O[2]=z*Z*te+j*q*re,O[3]=z*Z*re+j*q*te;break;case"yxz":O[0]=j*Z*re+z*q*te,O[1]=z*q*re-j*Z*te,O[2]=z*Z*te-j*q*re,O[3]=z*Z*re+j*q*te;break;case"yzx":O[0]=j*Z*re+z*q*te,O[1]=z*q*re+j*Z*te,O[2]=z*Z*te-j*q*re,O[3]=z*Z*re-j*q*te;break;case"zxy":O[0]=j*Z*re-z*q*te,O[1]=z*q*re+j*Z*te,O[2]=z*Z*te+j*q*re,O[3]=z*Z*re-j*q*te;break;case"zyx":O[0]=j*Z*re-z*q*te,O[1]=z*q*re+j*Z*te,O[2]=z*Z*te-j*q*re,O[3]=z*Z*re+j*q*te;break;default:throw new Error(`Unknown rotation order: ${L}`)}return O},copy:b,clone:d,add:function(T,S,P){const L=P??new t(4);return L[0]=T[0]+S[0],L[1]=T[1]+S[1],L[2]=T[2]+S[2],L[3]=T[3]+S[3],L},subtract:x,sub:g,mulScalar:_,scale:w,divScalar:function(T,S,P){const L=P??new t(4);return L[0]=T[0]/S,L[1]=T[1]/S,L[2]=T[2]/S,L[3]=T[3]/S,L},dot:f,lerp:function(T,S,P,L){const F=L??new t(4);return F[0]=T[0]+P*(S[0]-T[0]),F[1]=T[1]+P*(S[1]-T[1]),F[2]=T[2]+P*(S[2]-T[2]),F[3]=T[3]+P*(S[3]-T[3]),F},length:p,len:a,lengthSq:c,lenSq:h,normalize:y,equalsApproximately:function(T,S){return Math.abs(T[0]-S[0])<ne&&Math.abs(T[1]-S[1])<ne&&Math.abs(T[2]-S[2])<ne&&Math.abs(T[3]-S[3])<ne},equals:function(T,S){return T[0]===S[0]&&T[1]===S[1]&&T[2]===S[2]&&T[3]===S[3]},identity:function(T){const S=T??new t(4);return S[0]=0,S[1]=0,S[2]=0,S[3]=1,S},rotationTo:function(T,S,P){const L=P??new t(4),F=r.dot(T,S);return F<-.999999?(r.cross(C,T,A),r.len(A)<1e-6&&r.cross(R,T,A),r.normalize(A,A),o(A,Math.PI,L),L):F>.999999?(L[0]=0,L[1]=0,L[2]=0,L[3]=1,L):(r.cross(T,S,A),L[0]=A[0],L[1]=A[1],L[2]=A[2],L[3]=1+F,y(L,L))},sqlerp:function(T,S,P,L,F,O){const H=O??new t(4);return m(T,L,F,U),m(S,P,F,k),m(U,k,2*F*(1-F),H),H}}}(s),Oo.set(s,e)),e}const Io=new Map;function fl(s){let e=Io.get(s);return e||(e=function(t){function r(p,a,c,h){const y=new t(4);return p!==void 0&&(y[0]=p,a!==void 0&&(y[1]=a,c!==void 0&&(y[2]=c,h!==void 0&&(y[3]=h)))),y}function n(p,a,c){const h=c??new t(4);return h[0]=p[0]-a[0],h[1]=p[1]-a[1],h[2]=p[2]-a[2],h[3]=p[3]-a[3],h}function i(p,a,c,h){const y=h??new t(4);return y[0]=p[0]+c*(a[0]-p[0]),y[1]=p[1]+c*(a[1]-p[1]),y[2]=p[2]+c*(a[2]-p[2]),y[3]=p[3]+c*(a[3]-p[3]),y}function o(p,a,c){const h=c??new t(4);return h[0]=p[0]*a,h[1]=p[1]*a,h[2]=p[2]*a,h[3]=p[3]*a,h}function u(p,a){const c=a??new t(4);return c[0]=1/p[0],c[1]=1/p[1],c[2]=1/p[2],c[3]=1/p[3],c}function l(p){const a=p[0],c=p[1],h=p[2],y=p[3];return Math.sqrt(a*a+c*c+h*h+y*y)}function m(p){const a=p[0],c=p[1],h=p[2],y=p[3];return a*a+c*c+h*h+y*y}function b(p,a){const c=p[0]-a[0],h=p[1]-a[1],y=p[2]-a[2],A=p[3]-a[3];return Math.sqrt(c*c+h*h+y*y+A*A)}function d(p,a){const c=p[0]-a[0],h=p[1]-a[1],y=p[2]-a[2],A=p[3]-a[3];return c*c+h*h+y*y+A*A}function x(p,a){const c=a??new t(4),h=p[0],y=p[1],A=p[2],C=p[3],R=Math.sqrt(h*h+y*y+A*A+C*C);return R>1e-5?(c[0]=h/R,c[1]=y/R,c[2]=A/R,c[3]=C/R):(c[0]=0,c[1]=0,c[2]=0,c[3]=0),c}function g(p,a){const c=a??new t(4);return c[0]=p[0],c[1]=p[1],c[2]=p[2],c[3]=p[3],c}function _(p,a,c){const h=c??new t(4);return h[0]=p[0]*a[0],h[1]=p[1]*a[1],h[2]=p[2]*a[2],h[3]=p[3]*a[3],h}function w(p,a,c){const h=c??new t(4);return h[0]=p[0]/a[0],h[1]=p[1]/a[1],h[2]=p[2]/a[2],h[3]=p[3]/a[3],h}function f(p,a,c){const h=c??new t(4);return x(p,h),o(h,a,h)}return{create:r,fromValues:r,set:function(p,a,c,h,y){const A=y??new t(4);return A[0]=p,A[1]=a,A[2]=c,A[3]=h,A},ceil:function(p,a){const c=a??new t(4);return c[0]=Math.ceil(p[0]),c[1]=Math.ceil(p[1]),c[2]=Math.ceil(p[2]),c[3]=Math.ceil(p[3]),c},floor:function(p,a){const c=a??new t(4);return c[0]=Math.floor(p[0]),c[1]=Math.floor(p[1]),c[2]=Math.floor(p[2]),c[3]=Math.floor(p[3]),c},round:function(p,a){const c=a??new t(4);return c[0]=Math.round(p[0]),c[1]=Math.round(p[1]),c[2]=Math.round(p[2]),c[3]=Math.round(p[3]),c},clamp:function(p,a=0,c=1,h){const y=h??new t(4);return y[0]=Math.min(c,Math.max(a,p[0])),y[1]=Math.min(c,Math.max(a,p[1])),y[2]=Math.min(c,Math.max(a,p[2])),y[3]=Math.min(c,Math.max(a,p[3])),y},add:function(p,a,c){const h=c??new t(4);return h[0]=p[0]+a[0],h[1]=p[1]+a[1],h[2]=p[2]+a[2],h[3]=p[3]+a[3],h},addScaled:function(p,a,c,h){const y=h??new t(4);return y[0]=p[0]+a[0]*c,y[1]=p[1]+a[1]*c,y[2]=p[2]+a[2]*c,y[3]=p[3]+a[3]*c,y},subtract:n,sub:n,equalsApproximately:function(p,a){return Math.abs(p[0]-a[0])<ne&&Math.abs(p[1]-a[1])<ne&&Math.abs(p[2]-a[2])<ne&&Math.abs(p[3]-a[3])<ne},equals:function(p,a){return p[0]===a[0]&&p[1]===a[1]&&p[2]===a[2]&&p[3]===a[3]},lerp:i,lerpV:function(p,a,c,h){const y=h??new t(4);return y[0]=p[0]+c[0]*(a[0]-p[0]),y[1]=p[1]+c[1]*(a[1]-p[1]),y[2]=p[2]+c[2]*(a[2]-p[2]),y[3]=p[3]+c[3]*(a[3]-p[3]),y},max:function(p,a,c){const h=c??new t(4);return h[0]=Math.max(p[0],a[0]),h[1]=Math.max(p[1],a[1]),h[2]=Math.max(p[2],a[2]),h[3]=Math.max(p[3],a[3]),h},min:function(p,a,c){const h=c??new t(4);return h[0]=Math.min(p[0],a[0]),h[1]=Math.min(p[1],a[1]),h[2]=Math.min(p[2],a[2]),h[3]=Math.min(p[3],a[3]),h},mulScalar:o,scale:o,divScalar:function(p,a,c){const h=c??new t(4);return h[0]=p[0]/a,h[1]=p[1]/a,h[2]=p[2]/a,h[3]=p[3]/a,h},inverse:u,invert:u,dot:function(p,a){return p[0]*a[0]+p[1]*a[1]+p[2]*a[2]+p[3]*a[3]},length:l,len:l,lengthSq:m,lenSq:m,distance:b,dist:b,distanceSq:d,distSq:d,normalize:x,negate:function(p,a){const c=a??new t(4);return c[0]=-p[0],c[1]=-p[1],c[2]=-p[2],c[3]=-p[3],c},copy:g,clone:g,multiply:_,mul:_,divide:w,div:w,zero:function(p){const a=p??new t(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},transformMat4:function(p,a,c){const h=c??new t(4),y=p[0],A=p[1],C=p[2],R=p[3];return h[0]=a[0]*y+a[4]*A+a[8]*C+a[12]*R,h[1]=a[1]*y+a[5]*A+a[9]*C+a[13]*R,h[2]=a[2]*y+a[6]*A+a[10]*C+a[14]*R,h[3]=a[3]*y+a[7]*A+a[11]*C+a[15]*R,h},setLength:f,truncate:function(p,a,c){const h=c??new t(4);return l(p)>a?f(p,a,h):g(p,h)},midpoint:function(p,a,c){return i(p,a,.5,c??new t(4))}}}(s),Io.set(s,e)),e}function Sn(s,e,t,r,n,i){return{mat3:ll(s),mat4:dl(e),quat:hl(t),vec2:Po(r),vec3:qr(n),vec4:fl(i)}}const{mat3:Qr,mat4:Q,quat:Zr,vec2:Se,vec3:D,vec4:Br}=Sn(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array);Sn(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),Sn(cl,Array,Array,Array,Array,Array);const pl=""+new URL("Sponza-Eg7MFCLQ.gltf",import.meta.url).href;class Ze{constructor(){throw new Error(`${this.constructor.name} is non-instantiable`)}}class qt extends Ze{static linear(e){return e}static quad_In(e){return e*e}static quad_Out(e){return e*(2-e)}static quad_InOut(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}static cubic_In(e){return e*e*e}static cubic_Out(e){return--e*e*e+1}static cubic_InOut(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}static quart_In(e){return e*e*e*e}static quart_Out(e){return 1- --e*e*e*e}static quart_InOut(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}static quint_In(e){return e*e*e*e*e}static quint_Out(e){return--e*e*e*e*e+1}static quint_InOut(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}static sine_In(e){return 1-Math.cos(e*Math.PI/2)}static sine_Out(e){return Math.sin(e*Math.PI/2)}static sine_InOut(e){return .5*(1-Math.cos(Math.PI*e))}static exp_In(e){return e===0?0:Math.pow(1024,e-1)}static exp_Out(e){return e===1?1:1-Math.pow(2,-10*e)}static exp_InOut(e){return e===0||e===1?e:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}static circ_In(e){return 1-Math.sqrt(1-e*e)}static circ_Out(e){return Math.sqrt(1- --e*e)}static circ_InOut(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}static elastic_In(e){return e===0||e===1?e:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)}static elastic_Out(e){return e===0||e===1?e:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1}static elastic_InOut(e){return e===0||e===1?e:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}static back_In(e){return e*e*(2.70158*e-1.70158)}static back_Out(e){return--e*e*(2.70158*e+1.70158)+1}static back_InOut(e){const t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}static bounce_In(e){return 1-qt.bounce_Out(1-e)}static bounce_Out(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}static bounce_InOut(e){return e<.5?.5*qt.bounce_In(2*e):.5*qt.bounce_Out(2*e-1)+.5}}class es{constructor({durationMS:e,delayMS:t=0,easeName:r="linear",onUpdate:n,onComplete:i=()=>{}}){this.startMS=0,this.update=()=>{this.rafID=window.requestAnimationFrame(this.update);let o=(performance.now()-this.startMS)/this.durationMS;o<0?o=0:o>1&&(o=1);const u=this.easeFunc(o);this.onUpdate(u,o),o>=1&&(this.onComplete(),this.stop())},this.durationMS=e,this.delayMS=t,this.easeFunc=qt[r],this.onUpdate=n,this.onComplete=i}start(){const e=()=>{this.startMS=performance.now(),this.rafID=window.requestAnimationFrame(this.update),clearTimeout(this.delayID)};return this.delayMS?this.delayID=window.setTimeout(e,this.delayMS):e(),this}stop(){return window.clearTimeout(this.delayID),window.cancelAnimationFrame(this.rafID),this.rafID=-1,this}setEase(e){return this.easeFunc=qt[e],this}}const vt=class vt{static getActiveRenderPassType(){return this.activeRenderPassType}static setActiveRenderPass(e,t){this.activeRenderPassType=e,this.activeRenderPassEncoder=t,this.currentlyBoundRenderPSO=null}static bindRenderPSO(e){var t;e!==this.currentlyBoundRenderPSO&&(this.currentlyBoundRenderPSO=e,(t=this.activeRenderPassEncoder)==null||t.setPipeline(e))}};vt.ENABLE_DEBUG_GROUPS=!1,vt.elapsedTimeMs=0,vt.deltaTimeMs=0,vt.frameIndex=0,vt.depthStencilFormat="depth24plus-stencil8",vt.prevTimeMs=0;let v=vt;const we=D.create(),ml=87,gl=83,yl=65,bl=68,xl=69,_l=81,Fo="ontouchstart"in window||navigator.maxTouchPoints>0,oe=class oe{constructor(e,t=document.body,r=t){this.camera=e,this.keyboardDomElement=t,this.mouseDomElement=r,this.angles=Se.create(0,.5*-Math.PI),this.viewMat=Q.create(),this.rotMat=Q.identity(),this.lastX=0,this.lastY=0,this.presedKeys=new Array(128),this.rafId=-1,this.speed=40,this.touchMoveX=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchMoveY=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchMoveTargetX=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchMoveTargetY=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchMoveAngle=0,this.touchLookX=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchLookY=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchLookTargetX=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchLookTargetY=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchLookAngle=0,this.isTouchMoveActive=!1,this.isTouchLookActive=!1,this.onLookHandleTouchStart=()=>{this.isTouchLookActive=!0},this.onLookHandleTouchMove=n=>{const i=n.touches[this.isTouchMoveActive?1:0].clientX,o=n.touches[this.isTouchMoveActive?1:0].clientY,u=innerWidth-24-.5*oe.TOUCHMOVE_ROOT_SIZE-i,l=innerHeight-24-.5*oe.TOUCHMOVE_ROOT_SIZE-o,m=Math.min(Math.sqrt(u*u+l*l),60),b=Math.atan2(-l,-u),d=Math.cos(b)*m-.5*oe.TOUCHMOVE_HANDLE_SIZE,x=Math.sin(b)*m-.5*oe.TOUCHMOVE_HANDLE_SIZE;this.touchLookTargetX=d,this.touchLookTargetY=x,this.touchLookAngle=b},this.onLookHandleTouchEnd=()=>{this.touchLookTargetX=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchLookTargetY=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.isTouchLookActive=!1},this.onMoveHandleTouchStart=()=>{this.isTouchMoveActive=!0},this.onMoveHandleTouchEnd=()=>{this.touchMoveTargetX=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.touchMoveTargetY=.5*-oe.TOUCHMOVE_HANDLE_SIZE,this.isTouchMoveActive=!1},this.onMoveHandleTouchMove=n=>{const i=n.touches[0].clientX,o=n.touches[0].clientY,u=24+.5*oe.TOUCHMOVE_ROOT_SIZE-i,l=innerHeight-24-.5*oe.TOUCHMOVE_ROOT_SIZE-o,m=Math.min(Math.sqrt(u*u+l*l),60),b=Math.atan2(-l,-u),d=Math.cos(b)*m-.5*oe.TOUCHMOVE_HANDLE_SIZE,x=Math.sin(b)*m-.5*oe.TOUCHMOVE_HANDLE_SIZE;this.touchMoveTargetX=d,this.touchMoveTargetY=x,this.touchMoveAngle=b},this.update=n=>{var l,m;const i=.001*this.speed;D.set(0,0,0,we);const o=v.deltaTimeMs;if(Fo){if(this.touchMoveX+=(this.touchMoveTargetX-this.touchMoveX)*o*5,this.touchMoveY+=(this.touchMoveTargetY-this.touchMoveY)*o*5,(l=this.$touchMoveHandle)==null||l.style.setProperty("transform",`translate3d(${this.touchMoveX}px, ${this.touchMoveY}px, 0)`),this.touchLookX+=(this.touchLookTargetX-this.touchLookX)*o*5,this.touchLookY+=(this.touchLookTargetY-this.touchLookY)*o*5,(m=this.$touchLookHandle)==null||m.style.setProperty("transform",`translate3d(${this.touchLookX}px, ${this.touchLookY}px, 0)`),this.isTouchLookActive){const b=Math.cos(this.touchLookAngle),d=Math.sin(this.touchLookAngle);this.rotateView(.0075*b,.0075*d)}if(this.isTouchMoveActive){const b=Math.cos(this.touchMoveAngle),d=Math.sin(this.touchMoveAngle);we[0]=.05*b,we[2]=.05*d}}else(this.presedKeys[ml]||this.presedKeys[38])&&(we[2]-=i),(this.presedKeys[gl]||this.presedKeys[40])&&(we[2]+=i),(this.presedKeys[yl]||this.presedKeys[37])&&(we[0]-=i),(this.presedKeys[bl]||this.presedKeys[39])&&(we[0]+=i),this.presedKeys[xl]&&(we[1]+=i),this.presedKeys[_l]&&(we[1]-=i);we[0]===0&&we[1]===0&&we[2]===0||(D.transformMat4(we,this.rotMat,we),D.add(this.position,we,this.position));const u=this.viewMat;Q.identity(u),Q.rotateX(u,this.angles[0],u),Q.rotateY(u,this.angles[1],u),Q.translate(u,D.negate(this.position),u),this.camera.setPosition(this.position[0],this.position[1],this.position[2]),this.camera.updateViewMatrixWithMat(u),this.rafId=requestAnimationFrame(this.update)},this.onMouseDown=n=>{this.lastX=n.pageX,this.lastY=n.pageY,this.mouseDomElement.addEventListener("mousemove",this.onMouseMove)},this.onMouseUp=()=>{this.mouseDomElement.removeEventListener("mousemove",this.onMouseMove)},this.onMouseMove=n=>{const i=n.pageX-this.lastX,o=n.pageY-this.lastY;this.lastX=n.pageX,this.lastY=n.pageY,this.rotateView(.0075*i,.005*o)},this.onKeyDown=n=>{this.presedKeys[n.keyCode]=!0},this.onKeyUp=n=>{this.presedKeys[n.keyCode]=!1},this.position=e.position,t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp),r.addEventListener("mousedown",this.onMouseDown),r.addEventListener("mouseup",this.onMouseUp),this.rotateView(.0075,.005),Fo&&(this.$touchMoveRoot=document.createElement("div"),this.$touchMoveRoot.style.setProperty("position","fixed"),this.$touchMoveRoot.style.setProperty("left","24px"),this.$touchMoveRoot.style.setProperty("bottom","24px"),this.$touchMoveRoot.style.setProperty("width",`${oe.TOUCHMOVE_ROOT_SIZE}px`),this.$touchMoveRoot.style.setProperty("height",`${oe.TOUCHMOVE_ROOT_SIZE}px`),this.$touchMoveRoot.style.setProperty("border-radius","50%"),this.$touchMoveRoot.style.setProperty("border","2px solid white"),this.$touchMoveRoot.style.setProperty("z-index","9999"),this.$touchMoveRoot.style.setProperty("transition","opacity 0.125s ease"),this.$touchMoveRoot.style.setProperty("opacity","0"),this.$touchMoveHandle=document.createElement("div"),this.$touchMoveHandle.style.setProperty("width",`${oe.TOUCHMOVE_HANDLE_SIZE}px`),this.$touchMoveHandle.style.setProperty("height",`${oe.TOUCHMOVE_HANDLE_SIZE}px`),this.$touchMoveHandle.style.setProperty("position","absolute"),this.$touchMoveHandle.style.setProperty("left","50%"),this.$touchMoveHandle.style.setProperty("top","50%"),this.$touchMoveHandle.style.setProperty("background-color","rgba(255, 255, 255, 0.72)"),this.$touchMoveHandle.style.setProperty("border-radius","50%"),this.$touchMoveRoot.appendChild(this.$touchMoveHandle),document.body.appendChild(this.$touchMoveRoot),this.$touchLookRoot=document.createElement("div"),this.$touchLookRoot.style.setProperty("position","fixed"),this.$touchLookRoot.style.setProperty("bottom","24px"),this.$touchLookRoot.style.setProperty("right","24px"),this.$touchLookRoot.style.setProperty("width",`${oe.TOUCHMOVE_ROOT_SIZE}px`),this.$touchLookRoot.style.setProperty("height",`${oe.TOUCHMOVE_ROOT_SIZE}px`),this.$touchLookRoot.style.setProperty("border","2px solid white"),this.$touchLookRoot.style.setProperty("border-radius","50%"),this.$touchLookRoot.style.setProperty("z-index","9999"),this.$touchLookRoot.style.setProperty("transition","opacity 0.125s ease"),this.$touchLookRoot.style.setProperty("opacity","0"),document.body.appendChild(this.$touchLookRoot),this.$touchLookHandle=document.createElement("div"),this.$touchLookHandle.style.setProperty("width",`${oe.TOUCHMOVE_HANDLE_SIZE}px`),this.$touchLookHandle.style.setProperty("height",`${oe.TOUCHMOVE_HANDLE_SIZE}px`),this.$touchLookHandle.style.setProperty("position","absolute"),this.$touchLookHandle.style.setProperty("left","50%"),this.$touchLookHandle.style.setProperty("top","50%"),this.$touchLookHandle.style.setProperty("background-color","rgba(255, 255, 255, 0.72)"),this.$touchLookHandle.style.setProperty("border-radius","50%"),this.$touchLookRoot.appendChild(this.$touchLookHandle),this.$touchMoveHandle.addEventListener("touchstart",this.onMoveHandleTouchStart),this.$touchMoveHandle.addEventListener("touchmove",this.onMoveHandleTouchMove),this.$touchMoveHandle.addEventListener("touchend",this.onMoveHandleTouchEnd),this.$touchMoveHandle.addEventListener("touchcancel",this.onMoveHandleTouchEnd),this.$touchLookHandle.addEventListener("touchstart",this.onLookHandleTouchStart),this.$touchLookHandle.addEventListener("touchmove",this.onLookHandleTouchMove),this.$touchLookHandle.addEventListener("touchend",this.onLookHandleTouchEnd),this.$touchLookHandle.addEventListener("touchcancel",this.onLookHandleTouchEnd))}revealTouchControls(){this.$touchMoveRoot.style.setProperty("opacity","1"),this.$touchLookRoot.style.setProperty("opacity","1")}startTick(){this.rafId=requestAnimationFrame(this.update)}endTick(){cancelAnimationFrame(this.rafId)}rotateView(e,t){if(e||t){for(this.angles[1]+=e;this.angles[1]<0;)this.angles[1]+=2*Math.PI;for(;this.angles[1]>=2*Math.PI;)this.angles[1]-=2*Math.PI;this.angles[0]+=t,this.angles[0]<.5*-Math.PI&&(this.angles[0]=.5*-Math.PI),this.angles[0]>.5*Math.PI&&(this.angles[0]=.5*Math.PI),Q.identity(this.rotMat),Q.rotateY(this.rotMat,-this.angles[1],this.rotMat),Q.rotateX(this.rotMat,-this.angles[0],this.rotMat)}}};oe.TOUCHMOVE_ROOT_SIZE=120,oe.TOUCHMOVE_HANDLE_SIZE=90;let En=oe;const Do=(s,e,t)=>s+t*(e-s),Pt=(s,e)=>{const t=Math.max(s,e);return 1+Math.log2(t)|0},Al=Q.identity(),Bl=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],vl=[[0,1,0],[0,1,0],[0,0,-1],[0,0,1],[0,1,0],[0,1,0]],Uo=new Float32Array(1),wl=new Int32Array(Uo.buffer),ts=s=>{Uo[0]=s;const e=wl[0];let t=e>>16&32768,r=e>>12&2047;const n=e>>23&255;return n<103?t:n>142?(t|=31744,t|=(n==255?0:1)&&8388607&e,t):n<113?(r|=2048,t|=(r>>114-n)+(r>>113-n&1),t):(t|=n-112<<10|r>>1,t+=1&r,t)},Mn=(s,e)=>((s+e-1)/e|0)*e,ko=s=>s&&typeof s.length=="number"&&s.buffer instanceof ArrayBuffer&&typeof s.byteLength=="number",ie={i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array},bool:{numElements:0,align:1,size:0,type:"bool",View:Uint32Array}},Qt={...ie,"atomic<i32>":ie.i32,"atomic<u32>":ie.u32,"vec2<i32>":ie.vec2i,"vec2<u32>":ie.vec2u,"vec2<f32>":ie.vec2f,"vec2<f16>":ie.vec2h,"vec3<i32>":ie.vec3i,"vec3<u32>":ie.vec3u,"vec3<f32>":ie.vec3f,"vec3<f16>":ie.vec3h,"vec4<i32>":ie.vec4i,"vec4<u32>":ie.vec4u,"vec4<f32>":ie.vec4f,"vec4<f16>":ie.vec4h,"mat2x2<f32>":ie.mat2x2f,"mat2x2<f16>":ie.mat2x2h,"mat3x2<f32>":ie.mat3x2f,"mat3x2<f16>":ie.mat3x2h,"mat4x2<f32>":ie.mat4x2f,"mat4x2<f16>":ie.mat4x2h,"mat2x3<f32>":ie.mat2x3f,"mat2x3<f16>":ie.mat2x3h,"mat3x3<f32>":ie.mat3x3f,"mat3x3<f16>":ie.mat3x3h,"mat4x3<f32>":ie.mat4x3f,"mat4x3<f16>":ie.mat4x3h,"mat2x4<f32>":ie.mat2x4f,"mat2x4<f16>":ie.mat2x4h,"mat3x4<f32>":ie.mat3x4f,"mat3x4<f16>":ie.mat3x4h,"mat4x4<f32>":ie.mat4x4f,"mat4x4<f16>":ie.mat4x4h},Cl=(No=Qt,Object.keys(No));var No;function Vo(s,e,t,r){const{size:n,type:i}=s;try{const{View:o,align:u}=Qt[i],l=r!==void 0,m=l?Mn(n,u):n,b=m/o.BYTES_PER_ELEMENT;return new o(e,t,b*(l?r===0?(e.byteLength-t)/m:r:1))}catch{throw new Error(`unknown type: ${i}`)}}function Tl(s,e,t){const r=t||0,n=new ArrayBuffer(function(o){const u=o;if(u.elementType)return u.size;{const l=o,m=u.numElements||1;if(l.fields)return o.size*m;{const b=o,{align:d}=Qt[b.type];return m>1?Mn(o.size,d)*m:o.size}}}(s)),i=(o,u)=>{const l=o,m=l.elementType;if(m){if(function(d){return!d.fields&&!d.elementType}(m)&&Qt[m.type].flatten)return Vo(m,n,u,l.numElements);{const{size:d}=Ho(o),x=l.numElements===0?(n.byteLength-u)/d:l.numElements;return b=g=>i(m,u+d*g),new Array(x).fill(0).map((g,_)=>b(_))}}if(typeof o=="string")throw Error("unreachable");{const d=o.fields;if(d){const x={};for(const[g,{type:_,offset:w}]of Object.entries(d))x[g]=i(_,u+w);return x}return Vo(o,n,u)}var b};return{views:i(s,r),arrayBuffer:n}}function Pn(s,e){if(s!==void 0)if(ko(e)){const t=e;if(t.length===1&&typeof s=="number")t[0]=s;else if(Array.isArray(s[0])||ko(s[0])){const r=s[0].length,n=r===3?4:r;for(let i=0;i<s.length;++i){const o=i*n;t.set(s[i],o)}}else t.set(s)}else if(Array.isArray(e)){const t=e;s.forEach((r,n)=>{Pn(r,t[n])})}else{const t=e;for(const[r,n]of Object.entries(s)){const i=t[r];i&&Pn(n,i)}}}function yt(s,e,t=0){const r=s,n=Tl(r.group===void 0?s:r.typeDefinition,0,t);return{...n,set(i){Pn(i,n.views)}}}function Rn(s){const e=s.elementType;if(e)return Rn(e);const t=s.fields;if(t)return Object.values(t).reduce((i,{type:o})=>Math.max(i,Rn(o)),0);const{type:r}=s,{align:n}=Qt[r];return n}function Ho(s){const e=s.elementType;if(e){const r=e.size,n=Rn(e);return{unalignedSize:r,align:n,size:Mn(r,n)}}const t=s.fields;if(t){const r=Object.values(t).pop();if(r.type.size===0)return Ho(r.type)}return{size:0,unalignedSize:0,align:1}}(function(s=[],e){const t=new Set;for(const r of Cl){const n=Qt[r];t.has(n)||(t.add(n),n.flatten=s.includes(r)?e:!e)}})();class Sl{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}let ot=class{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(s){throw new Error("Cannot evaluate node")}evaluateString(s){return this.evaluate(s).toString()}search(s){}searchBlock(s,e){if(s){e(rs.instance);for(const t of s)t instanceof Array?this.searchBlock(t,e):t.search(e);e(ss.instance)}}};class rs extends ot{}rs.instance=new rs;class ss extends ot{}ss.instance=new ss;class he extends ot{constructor(){super()}}let Gn=class extends he{constructor(s,e,t,r,n,i){super(),this.calls=new Set,this.name=s,this.args=e,this.returnType=t,this.body=r,this.startLine=n,this.endLine=i}get astNodeType(){return"function"}search(s){this.searchBlock(this.body,s)}};class El extends he{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Ml extends he{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Pl extends he{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Rl extends he{constructor(e,t,r,n){super(),this.init=e,this.condition=t,this.increment=r,this.body=n}get astNodeType(){return"for"}search(e){var t,r,n;(t=this.init)===null||t===void 0||t.search(e),(r=this.condition)===null||r===void 0||r.search(e),(n=this.increment)===null||n===void 0||n.search(e),this.searchBlock(this.body,e)}}class Rt extends he{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Jo extends he{constructor(e,t,r){super(),this.name=e,this.type=t,this.value=r}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Ln extends he{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class zo extends he{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var Zt,vr,G,E,be;(function(s){s.increment="++",s.decrement="--"})(Zt||(Zt={})),function(s){s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return s[t]}}(Zt||(Zt={}));class Gl extends he{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(function(s){s.assign="=",s.addAssign="+=",s.subtractAssin="-=",s.multiplyAssign="*=",s.divideAssign="/=",s.moduloAssign="%=",s.andAssign="&=",s.orAssign="|=",s.xorAssign="^=",s.shiftLeftAssign="<<=",s.shiftRightAssign=">>="})(vr||(vr={})),function(s){s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}}(vr||(vr={}));class Ll extends he{constructor(e,t,r){super(),this.operator=e,this.variable=t,this.value=r}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class jo extends he{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}search(e){for(const t of this.args)t.search(e);e(this)}}class Ol extends he{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class Il extends he{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"body"}}class Fl extends he{constructor(e,t,r,n){super(),this.condition=e,this.body=t,this.elseif=r,this.else=n}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Dl extends he{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Ul extends he{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class kl extends he{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Nl extends he{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class Ko extends he{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Vl extends he{constructor(){super()}get astNodeType(){return"discard"}}class Hl extends he{constructor(){super()}get astNodeType(){return"break"}}class Jl extends he{constructor(){super()}get astNodeType(){return"continue"}}class Gt extends he{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class Lt extends Gt{constructor(e,t,r,n){super(e),this.members=t,this.startLine=r,this.endLine=n}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}}class Xo extends Gt{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"template"}}class zl extends Gt{constructor(e,t,r,n){super(e),this.storage=t,this.type=r,this.access=n}get astNodeType(){return"pointer"}}class Yo extends Gt{constructor(e,t,r,n){super(e),this.attributes=t,this.format=r,this.count=n}get astNodeType(){return"array"}get isArray(){return!0}}class wr extends Gt{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"sampler"}}class Ke extends ot{constructor(){super()}}class Wo extends Ke{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class er extends Ke{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){e(this);for(const t of this.args)t.search(e)}}class $o extends Ke{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return 180*this.args[0].evaluate(e)/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}search(e){for(const t of this.args)t.search(e);e(this)}}class On extends Ke{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}evaluate(e){const t=e.constants.get(this.name);if(!t)throw new Error("Cannot evaluate node");return t.evaluate(e)}}class qo extends Ke{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}evaluate(e){var t,r;if(this.initializer instanceof er){const n=(t=this.postfix)===null||t===void 0?void 0:t.evaluateString(e),i=(r=this.initializer.type)===null||r===void 0?void 0:r.name,o=e.structs.get(i),u=o==null?void 0:o.getMemberIndex(n);if(u!=-1)return this.initializer.args[u].evaluate(e);console.log(u)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class Qo extends Ke{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class jl extends Ke{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class Kl extends Ke{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}search(e){this.searchBlock(this.args,e)}}class Zo extends Ke{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class Xl extends Ke{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class ea extends Ke{constructor(){super()}}class Yl extends ea{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class et extends ea{constructor(e,t,r){super(),this.operator=e,this.left=t,this.right=r}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class ta extends ot{constructor(){super()}}class Wl extends ta{constructor(e,t){super(),this.selector=e,this.body=t}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class $l extends ta{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class ql extends ot{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"argument"}}class Ql extends ot{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Zl extends ot{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"member"}}class ra extends ot{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}(function(s){s[s.token=0]="token",s[s.keyword=1]="keyword",s[s.reserved=2]="reserved"})(E||(E={}));class M{constructor(e,t,r){this.name=e,this.type=t,this.rule=r}toString(){return this.name}}class B{}G=B,B.none=new M("",E.reserved,""),B.eof=new M("EOF",E.token,""),B.reserved={asm:new M("asm",E.reserved,"asm"),bf16:new M("bf16",E.reserved,"bf16"),do:new M("do",E.reserved,"do"),enum:new M("enum",E.reserved,"enum"),f16:new M("f16",E.reserved,"f16"),f64:new M("f64",E.reserved,"f64"),handle:new M("handle",E.reserved,"handle"),i8:new M("i8",E.reserved,"i8"),i16:new M("i16",E.reserved,"i16"),i64:new M("i64",E.reserved,"i64"),mat:new M("mat",E.reserved,"mat"),premerge:new M("premerge",E.reserved,"premerge"),regardless:new M("regardless",E.reserved,"regardless"),typedef:new M("typedef",E.reserved,"typedef"),u8:new M("u8",E.reserved,"u8"),u16:new M("u16",E.reserved,"u16"),u64:new M("u64",E.reserved,"u64"),unless:new M("unless",E.reserved,"unless"),using:new M("using",E.reserved,"using"),vec:new M("vec",E.reserved,"vec"),void:new M("void",E.reserved,"void")},B.keywords={array:new M("array",E.keyword,"array"),atomic:new M("atomic",E.keyword,"atomic"),bool:new M("bool",E.keyword,"bool"),f32:new M("f32",E.keyword,"f32"),i32:new M("i32",E.keyword,"i32"),mat2x2:new M("mat2x2",E.keyword,"mat2x2"),mat2x3:new M("mat2x3",E.keyword,"mat2x3"),mat2x4:new M("mat2x4",E.keyword,"mat2x4"),mat3x2:new M("mat3x2",E.keyword,"mat3x2"),mat3x3:new M("mat3x3",E.keyword,"mat3x3"),mat3x4:new M("mat3x4",E.keyword,"mat3x4"),mat4x2:new M("mat4x2",E.keyword,"mat4x2"),mat4x3:new M("mat4x3",E.keyword,"mat4x3"),mat4x4:new M("mat4x4",E.keyword,"mat4x4"),ptr:new M("ptr",E.keyword,"ptr"),sampler:new M("sampler",E.keyword,"sampler"),sampler_comparison:new M("sampler_comparison",E.keyword,"sampler_comparison"),struct:new M("struct",E.keyword,"struct"),texture_1d:new M("texture_1d",E.keyword,"texture_1d"),texture_2d:new M("texture_2d",E.keyword,"texture_2d"),texture_2d_array:new M("texture_2d_array",E.keyword,"texture_2d_array"),texture_3d:new M("texture_3d",E.keyword,"texture_3d"),texture_cube:new M("texture_cube",E.keyword,"texture_cube"),texture_cube_array:new M("texture_cube_array",E.keyword,"texture_cube_array"),texture_multisampled_2d:new M("texture_multisampled_2d",E.keyword,"texture_multisampled_2d"),texture_storage_1d:new M("texture_storage_1d",E.keyword,"texture_storage_1d"),texture_storage_2d:new M("texture_storage_2d",E.keyword,"texture_storage_2d"),texture_storage_2d_array:new M("texture_storage_2d_array",E.keyword,"texture_storage_2d_array"),texture_storage_3d:new M("texture_storage_3d",E.keyword,"texture_storage_3d"),texture_depth_2d:new M("texture_depth_2d",E.keyword,"texture_depth_2d"),texture_depth_2d_array:new M("texture_depth_2d_array",E.keyword,"texture_depth_2d_array"),texture_depth_cube:new M("texture_depth_cube",E.keyword,"texture_depth_cube"),texture_depth_cube_array:new M("texture_depth_cube_array",E.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new M("texture_depth_multisampled_2d",E.keyword,"texture_depth_multisampled_2d"),texture_external:new M("texture_external",E.keyword,"texture_external"),u32:new M("u32",E.keyword,"u32"),vec2:new M("vec2",E.keyword,"vec2"),vec3:new M("vec3",E.keyword,"vec3"),vec4:new M("vec4",E.keyword,"vec4"),bitcast:new M("bitcast",E.keyword,"bitcast"),block:new M("block",E.keyword,"block"),break:new M("break",E.keyword,"break"),case:new M("case",E.keyword,"case"),continue:new M("continue",E.keyword,"continue"),continuing:new M("continuing",E.keyword,"continuing"),default:new M("default",E.keyword,"default"),diagnostic:new M("diagnostic",E.keyword,"diagnostic"),discard:new M("discard",E.keyword,"discard"),else:new M("else",E.keyword,"else"),enable:new M("enable",E.keyword,"enable"),fallthrough:new M("fallthrough",E.keyword,"fallthrough"),false:new M("false",E.keyword,"false"),fn:new M("fn",E.keyword,"fn"),for:new M("for",E.keyword,"for"),function:new M("function",E.keyword,"function"),if:new M("if",E.keyword,"if"),let:new M("let",E.keyword,"let"),const:new M("const",E.keyword,"const"),loop:new M("loop",E.keyword,"loop"),while:new M("while",E.keyword,"while"),private:new M("private",E.keyword,"private"),read:new M("read",E.keyword,"read"),read_write:new M("read_write",E.keyword,"read_write"),return:new M("return",E.keyword,"return"),requires:new M("requires",E.keyword,"requires"),storage:new M("storage",E.keyword,"storage"),switch:new M("switch",E.keyword,"switch"),true:new M("true",E.keyword,"true"),alias:new M("alias",E.keyword,"alias"),type:new M("type",E.keyword,"type"),uniform:new M("uniform",E.keyword,"uniform"),var:new M("var",E.keyword,"var"),override:new M("override",E.keyword,"override"),workgroup:new M("workgroup",E.keyword,"workgroup"),write:new M("write",E.keyword,"write"),r8unorm:new M("r8unorm",E.keyword,"r8unorm"),r8snorm:new M("r8snorm",E.keyword,"r8snorm"),r8uint:new M("r8uint",E.keyword,"r8uint"),r8sint:new M("r8sint",E.keyword,"r8sint"),r16uint:new M("r16uint",E.keyword,"r16uint"),r16sint:new M("r16sint",E.keyword,"r16sint"),r16float:new M("r16float",E.keyword,"r16float"),rg8unorm:new M("rg8unorm",E.keyword,"rg8unorm"),rg8snorm:new M("rg8snorm",E.keyword,"rg8snorm"),rg8uint:new M("rg8uint",E.keyword,"rg8uint"),rg8sint:new M("rg8sint",E.keyword,"rg8sint"),r32uint:new M("r32uint",E.keyword,"r32uint"),r32sint:new M("r32sint",E.keyword,"r32sint"),r32float:new M("r32float",E.keyword,"r32float"),rg16uint:new M("rg16uint",E.keyword,"rg16uint"),rg16sint:new M("rg16sint",E.keyword,"rg16sint"),rg16float:new M("rg16float",E.keyword,"rg16float"),rgba8unorm:new M("rgba8unorm",E.keyword,"rgba8unorm"),rgba8unorm_srgb:new M("rgba8unorm_srgb",E.keyword,"rgba8unorm_srgb"),rgba8snorm:new M("rgba8snorm",E.keyword,"rgba8snorm"),rgba8uint:new M("rgba8uint",E.keyword,"rgba8uint"),rgba8sint:new M("rgba8sint",E.keyword,"rgba8sint"),bgra8unorm:new M("bgra8unorm",E.keyword,"bgra8unorm"),bgra8unorm_srgb:new M("bgra8unorm_srgb",E.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new M("rgb10a2unorm",E.keyword,"rgb10a2unorm"),rg11b10float:new M("rg11b10float",E.keyword,"rg11b10float"),rg32uint:new M("rg32uint",E.keyword,"rg32uint"),rg32sint:new M("rg32sint",E.keyword,"rg32sint"),rg32float:new M("rg32float",E.keyword,"rg32float"),rgba16uint:new M("rgba16uint",E.keyword,"rgba16uint"),rgba16sint:new M("rgba16sint",E.keyword,"rgba16sint"),rgba16float:new M("rgba16float",E.keyword,"rgba16float"),rgba32uint:new M("rgba32uint",E.keyword,"rgba32uint"),rgba32sint:new M("rgba32sint",E.keyword,"rgba32sint"),rgba32float:new M("rgba32float",E.keyword,"rgba32float"),static_assert:new M("static_assert",E.keyword,"static_assert")},B.tokens={decimal_float_literal:new M("decimal_float_literal",E.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new M("hex_float_literal",E.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new M("int_literal",E.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new M("uint_literal",E.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new M("ident",E.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new M("and",E.token,"&"),and_and:new M("and_and",E.token,"&&"),arrow:new M("arrow ",E.token,"->"),attr:new M("attr",E.token,"@"),attr_left:new M("attr_left",E.token,"[["),attr_right:new M("attr_right",E.token,"]]"),forward_slash:new M("forward_slash",E.token,"/"),bang:new M("bang",E.token,"!"),bracket_left:new M("bracket_left",E.token,"["),bracket_right:new M("bracket_right",E.token,"]"),brace_left:new M("brace_left",E.token,"{"),brace_right:new M("brace_right",E.token,"}"),colon:new M("colon",E.token,":"),comma:new M("comma",E.token,","),equal:new M("equal",E.token,"="),equal_equal:new M("equal_equal",E.token,"=="),not_equal:new M("not_equal",E.token,"!="),greater_than:new M("greater_than",E.token,">"),greater_than_equal:new M("greater_than_equal",E.token,">="),shift_right:new M("shift_right",E.token,">>"),less_than:new M("less_than",E.token,"<"),less_than_equal:new M("less_than_equal",E.token,"<="),shift_left:new M("shift_left",E.token,"<<"),modulo:new M("modulo",E.token,"%"),minus:new M("minus",E.token,"-"),minus_minus:new M("minus_minus",E.token,"--"),period:new M("period",E.token,"."),plus:new M("plus",E.token,"+"),plus_plus:new M("plus_plus",E.token,"++"),or:new M("or",E.token,"|"),or_or:new M("or_or",E.token,"||"),paren_left:new M("paren_left",E.token,"("),paren_right:new M("paren_right",E.token,")"),semicolon:new M("semicolon",E.token,";"),star:new M("star",E.token,"*"),tilde:new M("tilde",E.token,"~"),underscore:new M("underscore",E.token,"_"),xor:new M("xor",E.token,"^"),plus_equal:new M("plus_equal",E.token,"+="),minus_equal:new M("minus_equal",E.token,"-="),times_equal:new M("times_equal",E.token,"*="),division_equal:new M("division_equal",E.token,"/="),modulo_equal:new M("modulo_equal",E.token,"%="),and_equal:new M("and_equal",E.token,"&="),or_equal:new M("or_equal",E.token,"|="),xor_equal:new M("xor_equal",E.token,"^="),shift_right_equal:new M("shift_right_equal",E.token,">>="),shift_left_equal:new M("shift_left_equal",E.token,"<<=")},B.simpleTokens={"@":G.tokens.attr,"{":G.tokens.brace_left,"}":G.tokens.brace_right,":":G.tokens.colon,",":G.tokens.comma,"(":G.tokens.paren_left,")":G.tokens.paren_right,";":G.tokens.semicolon},B.literalTokens={"&":G.tokens.and,"&&":G.tokens.and_and,"->":G.tokens.arrow,"[[":G.tokens.attr_left,"]]":G.tokens.attr_right,"/":G.tokens.forward_slash,"!":G.tokens.bang,"[":G.tokens.bracket_left,"]":G.tokens.bracket_right,"=":G.tokens.equal,"==":G.tokens.equal_equal,"!=":G.tokens.not_equal,">":G.tokens.greater_than,">=":G.tokens.greater_than_equal,">>":G.tokens.shift_right,"<":G.tokens.less_than,"<=":G.tokens.less_than_equal,"<<":G.tokens.shift_left,"%":G.tokens.modulo,"-":G.tokens.minus,"--":G.tokens.minus_minus,".":G.tokens.period,"+":G.tokens.plus,"++":G.tokens.plus_plus,"|":G.tokens.or,"||":G.tokens.or_or,"*":G.tokens.star,"~":G.tokens.tilde,_:G.tokens.underscore,"^":G.tokens.xor,"+=":G.tokens.plus_equal,"-=":G.tokens.minus_equal,"*=":G.tokens.times_equal,"/=":G.tokens.division_equal,"%=":G.tokens.modulo_equal,"&=":G.tokens.and_equal,"|=":G.tokens.or_equal,"^=":G.tokens.xor_equal,">>=":G.tokens.shift_right_equal,"<<=":G.tokens.shift_left_equal},B.regexTokens={decimal_float_literal:G.tokens.decimal_float_literal,hex_float_literal:G.tokens.hex_float_literal,int_literal:G.tokens.int_literal,uint_literal:G.tokens.uint_literal,ident:G.tokens.ident},B.storage_class=[G.keywords.function,G.keywords.private,G.keywords.workgroup,G.keywords.uniform,G.keywords.storage],B.access_mode=[G.keywords.read,G.keywords.write,G.keywords.read_write],B.sampler_type=[G.keywords.sampler,G.keywords.sampler_comparison],B.sampled_texture_type=[G.keywords.texture_1d,G.keywords.texture_2d,G.keywords.texture_2d_array,G.keywords.texture_3d,G.keywords.texture_cube,G.keywords.texture_cube_array],B.multisampled_texture_type=[G.keywords.texture_multisampled_2d],B.storage_texture_type=[G.keywords.texture_storage_1d,G.keywords.texture_storage_2d,G.keywords.texture_storage_2d_array,G.keywords.texture_storage_3d],B.depth_texture_type=[G.keywords.texture_depth_2d,G.keywords.texture_depth_2d_array,G.keywords.texture_depth_cube,G.keywords.texture_depth_cube_array,G.keywords.texture_depth_multisampled_2d],B.texture_external_type=[G.keywords.texture_external],B.any_texture_type=[...G.sampled_texture_type,...G.multisampled_texture_type,...G.storage_texture_type,...G.depth_texture_type,...G.texture_external_type],B.texel_format=[G.keywords.r8unorm,G.keywords.r8snorm,G.keywords.r8uint,G.keywords.r8sint,G.keywords.r16uint,G.keywords.r16sint,G.keywords.r16float,G.keywords.rg8unorm,G.keywords.rg8snorm,G.keywords.rg8uint,G.keywords.rg8sint,G.keywords.r32uint,G.keywords.r32sint,G.keywords.r32float,G.keywords.rg16uint,G.keywords.rg16sint,G.keywords.rg16float,G.keywords.rgba8unorm,G.keywords.rgba8unorm_srgb,G.keywords.rgba8snorm,G.keywords.rgba8uint,G.keywords.rgba8sint,G.keywords.bgra8unorm,G.keywords.bgra8unorm_srgb,G.keywords.rgb10a2unorm,G.keywords.rg11b10float,G.keywords.rg32uint,G.keywords.rg32sint,G.keywords.rg32float,G.keywords.rgba16uint,G.keywords.rgba16sint,G.keywords.rgba16float,G.keywords.rgba32uint,G.keywords.rgba32sint,G.keywords.rgba32float],B.const_literal=[G.tokens.int_literal,G.tokens.uint_literal,G.tokens.decimal_float_literal,G.tokens.hex_float_literal,G.keywords.true,G.keywords.false],B.literal_or_ident=[G.tokens.ident,G.tokens.int_literal,G.tokens.uint_literal,G.tokens.decimal_float_literal,G.tokens.hex_float_literal],B.element_count_expression=[G.tokens.int_literal,G.tokens.uint_literal,G.tokens.ident],B.template_types=[G.keywords.vec2,G.keywords.vec3,G.keywords.vec4,G.keywords.mat2x2,G.keywords.mat2x3,G.keywords.mat2x4,G.keywords.mat3x2,G.keywords.mat3x3,G.keywords.mat3x4,G.keywords.mat4x2,G.keywords.mat4x3,G.keywords.mat4x4,G.keywords.atomic,G.keywords.bitcast,...G.any_texture_type],B.attribute_name=[G.tokens.ident,G.keywords.block,G.keywords.diagnostic],B.assignment_operators=[G.tokens.equal,G.tokens.plus_equal,G.tokens.minus_equal,G.tokens.times_equal,G.tokens.division_equal,G.tokens.modulo_equal,G.tokens.and_equal,G.tokens.or_equal,G.tokens.xor_equal,G.tokens.shift_right_equal,G.tokens.shift_left_equal],B.increment_operators=[G.tokens.plus_plus,G.tokens.minus_minus];class sa{constructor(e,t,r){this.type=e,this.lexeme=t,this.line=r}toString(){return this.lexeme}isTemplateType(){return B.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==B.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class ed{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new sa(B.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const t=B.simpleTokens[e];if(t)return this._addToken(t),!0;let r=B.none;const n=this._isAlpha(e),i=e==="_";if(this._isAlphaNumeric(e)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)e+=this._advance(),o=this._peekAhead()}if(n){const o=B.keywords[e];if(o)return this._addToken(o),!0}if(n||i)return this._addToken(B.tokens.ident),!0;for(;;){let o=this._findType(e);const u=this._peekAhead();if(e==">"&&(u==">"||u=="=")){let l=!1,m=this._tokens.length-1;for(let b=0;b<5&&m>=0;++b,--m)if(this._tokens[m].type===B.tokens.less_than){m>0&&this._tokens[m-1].isArrayOrTemplateType()&&(l=!0);break}if(l)return this._addToken(o),!0}if(o===B.none){let l=e,m=0;const b=2;for(let d=0;d<b;++d)if(l+=this._peekAhead(d),o=this._findType(l),o!==B.none){m=d;break}if(o===B.none)return r!==B.none&&(this._current--,this._addToken(r),!0);e=l,this._current+=m+1}if(r=o,this._isAtEnd())break;e+=this._advance()}return r!==B.none&&(this._addToken(r),!0)}_findType(e){for(const r in B.regexTokens){const n=B.regexTokens[r];if(this._match(e,n.rule))return n}return B.literalTokens[e]||B.none}_match(e,t){const r=t.exec(e);return r&&r.index==0&&r[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e=="_"||e>="0"&&e<="9"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new sa(e,t,this._line))}}class td{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new Sl,this._deferArrayCountEval=[]}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;t.push(r)}if(this._deferArrayCountEval.length>0){for(const r of this._deferArrayCountEval){const n=r.arrayType,i=r.countNode;if(i instanceof On){const o=i.name,u=this._context.constants.get(o);if(u)try{const l=u.evaluate(this._context);n.count=l}catch{}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e)if(typeof e=="string"){const t=new ed(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,t){return{token:e,message:t,toString:function(){return`${t}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==B.eof}_match(e){if(e instanceof M)return!!this._check(e)&&(this._advance(),!0);for(let t=0,r=e.length;t<r;++t){const n=e[t];if(this._check(n))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),t)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const r=t.type;return e.indexOf(r)!=-1}return t.type==e}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(B.tokens.semicolon)&&!this._isAtEnd(););if(this._match(B.keywords.alias)){const t=this._type_alias();return this._consume(B.tokens.semicolon,"Expected ';'"),t}if(this._match(B.keywords.diagnostic)){const t=this._diagnostic();return this._consume(B.tokens.semicolon,"Expected ';'"),t}if(this._match(B.keywords.requires)){const t=this._requires_directive();return this._consume(B.tokens.semicolon,"Expected ';'"),t}if(this._match(B.keywords.enable)){const t=this._enable_directive();return this._consume(B.tokens.semicolon,"Expected ';'"),t}const e=this._attribute();if(this._check(B.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(B.tokens.semicolon,"Expected ';'."),t}if(this._check(B.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(B.tokens.semicolon,"Expected ';'."),t}if(this._check(B.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(B.tokens.semicolon,"Expected ';'."),t}if(this._check(B.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(B.tokens.semicolon,"Expected ';'."),t}if(this._check(B.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),t}if(this._check(B.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),t}return null}_function_decl(){if(!this._match(B.keywords.fn))return null;const e=this._currentLine,t=this._consume(B.tokens.ident,"Expected function name.").toString();this._consume(B.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(B.tokens.paren_right))do{if(this._check(B.tokens.paren_right))break;const u=this._attribute(),l=this._consume(B.tokens.ident,"Expected argument name.").toString();this._consume(B.tokens.colon,"Expected ':' for argument type.");const m=this._attribute(),b=this._type_decl();b!=null&&(b.attributes=m,r.push(new ql(l,b,u)))}while(this._match(B.tokens.comma));this._consume(B.tokens.paren_right,"Expected ')' after function arguments.");let n=null;if(this._match(B.tokens.arrow)){const u=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=u)}const i=this._compound_statement(),o=this._currentLine;return new Gn(t,r,n,i,e,o)}_compound_statement(){const e=[];for(this._consume(B.tokens.brace_left,"Expected '{' for block.");!this._check(B.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(B.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(B.tokens.semicolon)&&!this._isAtEnd(););if(this._check(B.tokens.attr)&&this._attribute(),this._check(B.keywords.if))return this._if_statement();if(this._check(B.keywords.switch))return this._switch_statement();if(this._check(B.keywords.loop))return this._loop_statement();if(this._check(B.keywords.for))return this._for_statement();if(this._check(B.keywords.while))return this._while_statement();if(this._check(B.keywords.continuing))return this._continuing_statement();if(this._check(B.keywords.static_assert))return this._static_assert_statement();if(this._check(B.tokens.brace_left))return this._compound_statement();let e=null;return e=this._check(B.keywords.return)?this._return_statement():this._check([B.keywords.var,B.keywords.let,B.keywords.const])?this._variable_statement():this._match(B.keywords.discard)?new Vl:this._match(B.keywords.break)?new Hl:this._match(B.keywords.continue)?new Jl:this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),e!=null&&this._consume(B.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(B.keywords.static_assert))return null;const e=this._optional_paren_expression();return new El(e)}_while_statement(){if(!this._match(B.keywords.while))return null;const e=this._optional_paren_expression();this._check(B.tokens.attr)&&this._attribute();const t=this._compound_statement();return new Ml(e,t)}_continuing_statement(){if(!this._match(B.keywords.continuing))return null;const e=this._compound_statement();return new Pl(e)}_for_statement(){if(!this._match(B.keywords.for))return null;this._consume(B.tokens.paren_left,"Expected '('.");const e=this._check(B.tokens.semicolon)?null:this._for_init();this._consume(B.tokens.semicolon,"Expected ';'.");const t=this._check(B.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(B.tokens.semicolon,"Expected ';'.");const r=this._check(B.tokens.paren_right)?null:this._for_increment();this._consume(B.tokens.paren_right,"Expected ')'."),this._check(B.tokens.attr)&&this._attribute();const n=this._compound_statement();return new Rl(e,t,r,n)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(B.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(B.tokens.equal)&&(t=this._short_circuit_or_expression()),new Rt(e.name,e.type,e.storage,e.access,t)}if(this._match(B.keywords.let)){const e=this._consume(B.tokens.ident,"Expected name for let.").toString();let t=null;if(this._match(B.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}this._consume(B.tokens.equal,"Expected '=' for let.");const r=this._short_circuit_or_expression();return new Ln(e,t,null,null,r)}if(this._match(B.keywords.const)){const e=this._consume(B.tokens.ident,"Expected name for const.").toString();let t=null;if(this._match(B.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}this._consume(B.tokens.equal,"Expected '=' for const.");const r=this._short_circuit_or_expression();return new zo(e,t,null,null,r)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(B.increment_operators))return this._current=e,null;const r=this._consume(B.increment_operators,"Expected increment operator");return new Gl(r.type===B.tokens.plus_plus?Zt.increment:Zt.decrement,t)}_assignment_statement(){let e=null;if(this._check(B.tokens.brace_right))return null;let t=this._match(B.tokens.underscore);if(t||(e=this._unary_expression()),!t&&e==null)return null;const r=this._consume(B.assignment_operators,"Expected assignment operator."),n=this._short_circuit_or_expression();return new Ll(vr.parse(r.lexeme),e,n)}_func_call_statement(){if(!this._check(B.tokens.ident))return null;const e=this._current,t=this._consume(B.tokens.ident,"Expected function name."),r=this._argument_expression_list();return r===null?(this._current=e,null):new jo(t.lexeme,r)}_loop_statement(){if(!this._match(B.keywords.loop))return null;this._check(B.tokens.attr)&&this._attribute(),this._consume(B.tokens.brace_left,"Expected '{' for loop.");const e=[];let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let n of t)e.push(n);else e.push(t);t=this._statement()}let r=null;return this._match(B.keywords.continuing)&&(r=this._compound_statement()),this._consume(B.tokens.brace_right,"Expected '}' for loop."),new Ol(e,r)}_switch_statement(){if(!this._match(B.keywords.switch))return null;const e=this._optional_paren_expression();this._check(B.tokens.attr)&&this._attribute(),this._consume(B.tokens.brace_left,"Expected '{' for switch.");const t=this._switch_body();if(t==null||t.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(B.tokens.brace_right,"Expected '}' for switch."),new Il(e,t)}_switch_body(){const e=[];if(this._match(B.keywords.case)){const t=this._case_selectors();this._match(B.tokens.colon),this._check(B.tokens.attr)&&this._attribute(),this._consume(B.tokens.brace_left,"Exected '{' for switch case.");const r=this._case_body();this._consume(B.tokens.brace_right,"Exected '}' for switch case."),e.push(new Wl(t,r))}if(this._match(B.keywords.default)){this._match(B.tokens.colon),this._check(B.tokens.attr)&&this._attribute(),this._consume(B.tokens.brace_left,"Exected '{' for switch default.");const t=this._case_body();this._consume(B.tokens.brace_right,"Exected '}' for switch default."),e.push(new $l(t))}if(this._check([B.keywords.default,B.keywords.case])){const t=this._switch_body();e.push(t[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(B.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(B.keywords.fallthrough))return this._consume(B.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(B.keywords.if))return null;const e=this._optional_paren_expression();this._check(B.tokens.attr)&&this._attribute();const t=this._compound_statement();let r=[];this._match_elseif()&&(this._check(B.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let n=null;return this._match(B.keywords.else)&&(this._check(B.tokens.attr)&&this._attribute(),n=this._compound_statement()),new Fl(e,t,r,n)}_match_elseif(){return this._tokens[this._current].type===B.keywords.else&&this._tokens[this._current+1].type===B.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),r=this._compound_statement();return e.push(new Ql(t,r)),this._match_elseif()&&(this._check(B.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(B.keywords.return))return null;const e=this._short_circuit_or_expression();return new Dl(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(B.tokens.or_or);)e=new et(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(B.tokens.and_and);)e=new et(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(B.tokens.or);)e=new et(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(B.tokens.xor);)e=new et(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(B.tokens.and);)e=new et(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([B.tokens.equal_equal,B.tokens.not_equal])?new et(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([B.tokens.less_than,B.tokens.greater_than,B.tokens.less_than_equal,B.tokens.greater_than_equal]);)e=new et(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([B.tokens.shift_left,B.tokens.shift_right]);)e=new et(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([B.tokens.plus,B.tokens.minus]);)e=new et(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([B.tokens.star,B.tokens.forward_slash,B.tokens.modulo]);)e=new et(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([B.tokens.minus,B.tokens.bang,B.tokens.tilde,B.tokens.star,B.tokens.and])?new Yl(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(B.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(B.tokens.bracket_right,"Expected ']'.");const t=new Xl(e),r=this._postfix_expression();return r&&(t.postfix=r),t}if(this._match(B.tokens.period)){const e=this._consume(B.tokens.ident,"Expected member name."),t=this._postfix_expression(),r=new Wo(e.lexeme);return t&&(r.postfix=t),r}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(B.tokens.ident)){const r=this._previous().toString();if(this._check(B.tokens.paren_left)){const n=this._argument_expression_list(),i=this._getStruct(r);return i!=null?new er(i,n):new $o(r,n)}if(this._context.constants.has(r)){const n=this._context.constants.get(r);return new qo(r,n.value)}return new On(r)}if(this._match(B.const_literal))return new Qo(parseFloat(this._previous().toString()));if(this._check(B.tokens.paren_left))return this._paren_expression();if(this._match(B.keywords.bitcast)){this._consume(B.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(B.tokens.greater_than,"Expected '>'.");const n=this._paren_expression();return new jl(r,n)}const e=this._type_decl(),t=this._argument_expression_list();return new Kl(e,t)}_argument_expression_list(){if(!this._match(B.tokens.paren_left))return null;const e=[];do{if(this._check(B.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(B.tokens.comma));return this._consume(B.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(B.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(B.tokens.paren_right),new Zo([e])}_paren_expression(){this._consume(B.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(B.tokens.paren_right,"Expected ')'."),new Zo([e])}_struct_decl(){if(!this._match(B.keywords.struct))return null;const e=this._currentLine,t=this._consume(B.tokens.ident,"Expected name for struct.").toString();this._consume(B.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(B.tokens.brace_right);){const o=this._attribute(),u=this._consume(B.tokens.ident,"Expected variable name.").toString();this._consume(B.tokens.colon,"Expected ':' for struct member type.");const l=this._attribute(),m=this._type_decl();m!=null&&(m.attributes=l),this._check(B.tokens.brace_right)?this._match(B.tokens.comma):this._consume(B.tokens.comma,"Expected ',' for struct member."),r.push(new Zl(u,m,o))}this._consume(B.tokens.brace_right,"Expected '}' after struct body.");const n=this._currentLine,i=new Lt(t,r,e,n);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(B.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(B.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(B.keywords.const))return null;const e=this._consume(B.tokens.ident,"Expected variable name");let t=null;if(this._match(B.tokens.colon)){const i=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=i)}let r=null;if(this._match(B.tokens.equal)){const i=this._short_circuit_or_expression();if(i instanceof er)r=i;else if(i instanceof qo&&i.initializer instanceof er)r=i.initializer;else try{const o=i.evaluate(this._context);r=new Qo(o)}catch{r=i}}const n=new zo(e.toString(),t,"","",r);return this._context.constants.set(n.name,n),n}_global_let_decl(){if(!this._match(B.keywords.let))return null;const e=this._consume(B.tokens.ident,"Expected variable name");let t=null;if(this._match(B.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}let r=null;return this._match(B.tokens.equal)&&(r=this._const_expression()),new Ln(e.toString(),t,"","",r)}_const_expression(){if(this._match(B.const_literal))return new Wo(this._previous().toString());const e=this._type_decl();this._consume(B.tokens.paren_left,"Expected '('.");let t=[];for(;!this._check(B.tokens.paren_right)&&(t.push(this._const_expression()),this._check(B.tokens.comma));)this._advance();return this._consume(B.tokens.paren_right,"Expected ')'."),new er(e,t)}_variable_decl(){if(!this._match(B.keywords.var))return null;let e="",t="";this._match(B.tokens.less_than)&&(e=this._consume(B.storage_class,"Expected storage_class.").toString(),this._match(B.tokens.comma)&&(t=this._consume(B.access_mode,"Expected access_mode.").toString()),this._consume(B.tokens.greater_than,"Expected '>'."));const r=this._consume(B.tokens.ident,"Expected variable name");let n=null;if(this._match(B.tokens.colon)){const i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}return new Rt(r.toString(),n,e,t,null)}_override_decl(){if(!this._match(B.keywords.override))return null;const e=this._consume(B.tokens.ident,"Expected variable name");let t=null;if(this._match(B.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}return new Jo(e.toString(),t,null)}_diagnostic(){this._consume(B.tokens.paren_left,"Expected '('");const e=this._consume(B.tokens.ident,"Expected severity control name.");this._consume(B.tokens.comma,"Expected ','");const t=this._consume(B.tokens.ident,"Expected diagnostic rule name.");return this._consume(B.tokens.paren_right,"Expected ')'"),new Nl(e.toString(),t.toString())}_enable_directive(){const e=this._consume(B.tokens.ident,"identity expected.");return new Ul(e.toString())}_requires_directive(){const e=[this._consume(B.tokens.ident,"identity expected.").toString()];for(;this._match(B.tokens.comma);){const t=this._consume(B.tokens.ident,"identity expected.");e.push(t.toString())}return new kl(e)}_type_alias(){const e=this._consume(B.tokens.ident,"identity expected.");this._consume(B.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const r=new Ko(e.toString(),t);return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([B.tokens.ident,...B.texel_format,B.keywords.bool,B.keywords.f32,B.keywords.i32,B.keywords.u32])){const r=this._advance(),n=r.toString();return this._context.structs.has(n)?this._context.structs.get(n):this._context.aliases.has(n)?this._context.aliases.get(n).type:new Gt(r.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(B.template_types)){let r=this._advance().toString(),n=null,i=null;return this._match(B.tokens.less_than)&&(n=this._type_decl(),i=null,this._match(B.tokens.comma)&&(i=this._consume(B.access_mode,"Expected access_mode for pointer").toString()),this._consume(B.tokens.greater_than,"Expected '>' for type.")),new Xo(r,n,i)}if(this._match(B.keywords.ptr)){let r=this._previous().toString();this._consume(B.tokens.less_than,"Expected '<' for pointer.");const n=this._consume(B.storage_class,"Expected storage_class for pointer");this._consume(B.tokens.comma,"Expected ',' for pointer.");const i=this._type_decl();let o=null;return this._match(B.tokens.comma)&&(o=this._consume(B.access_mode,"Expected access_mode for pointer").toString()),this._consume(B.tokens.greater_than,"Expected '>' for pointer."),new zl(r,n.toString(),i,o)}const t=this._attribute();if(this._match(B.keywords.array)){let r=null,n=-1;const i=this._previous();let o=null;if(this._match(B.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let l="";if(this._match(B.tokens.comma)){o=this._shift_expression();try{l=o.evaluate(this._context).toString(),o=null}catch{l="1"}}this._consume(B.tokens.greater_than,"Expected '>' for array."),n=l?parseInt(l):0}const u=new Yo(i.toString(),t,r,n);return o&&this._deferArrayCountEval.push({arrayType:u,countNode:o}),u}return null}_texture_sampler_types(){if(this._match(B.sampler_type))return new wr(this._previous().toString(),null,null);if(this._match(B.depth_texture_type))return new wr(this._previous().toString(),null,null);if(this._match(B.sampled_texture_type)||this._match(B.multisampled_texture_type)){const e=this._previous();this._consume(B.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(B.tokens.greater_than,"Expected '>' for sampler type."),new wr(e.toString(),t,null)}if(this._match(B.storage_texture_type)){const e=this._previous();this._consume(B.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(B.texel_format,"Invalid texel format.").toString();this._consume(B.tokens.comma,"Expected ',' after texel format.");const r=this._consume(B.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(B.tokens.greater_than,"Expected '>' for sampler type."),new wr(e.toString(),t,r)}return null}_attribute(){let e=[];for(;this._match(B.tokens.attr);){const t=this._consume(B.attribute_name,"Expected attribute name"),r=new ra(t.toString(),null);if(this._match(B.tokens.paren_left)){if(r.value=this._consume(B.literal_or_ident,"Expected attribute value").toString(),this._check(B.tokens.comma)){this._advance();do{const n=this._consume(B.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(n)}while(this._match(B.tokens.comma))}this._consume(B.tokens.paren_right,"Expected ')'")}e.push(r)}for(;this._match(B.tokens.attr_left);){if(!this._check(B.tokens.attr_right))do{const t=this._consume(B.attribute_name,"Expected attribute name"),r=new ra(t.toString(),null);if(this._match(B.tokens.paren_left)){if(r.value=[this._consume(B.literal_or_ident,"Expected attribute value").toString()],this._check(B.tokens.comma)){this._advance();do{const n=this._consume(B.literal_or_ident,"Expected attribute value").toString();r.value.push(n)}while(this._match(B.tokens.comma))}this._consume(B.tokens.paren_right,"Expected ')'")}e.push(r)}while(this._match(B.tokens.comma));this._consume(B.tokens.attr_right,"Expected ']]' after attribute declarations")}return e.length==0?null:e}}class tr{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class na{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class ns extends tr{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class In extends tr{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class ia extends tr{constructor(e,t,r,n){super(e,r),this.format=t,this.access=n}get isTemplate(){return!0}}(function(s){s[s.Uniform=0]="Uniform",s[s.Storage=1]="Storage",s[s.Texture=2]="Texture",s[s.Sampler=3]="Sampler",s[s.StorageTexture=4]="StorageTexture"})(be||(be={}));class is{constructor(e,t,r,n,i,o,u){this.name=e,this.type=t,this.group=r,this.binding=n,this.attributes=i,this.resourceType=o,this.access=u}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class rd{constructor(e,t){this.name=e,this.type=t}}class os{constructor(e,t){this.align=e,this.size=t}}class sd{constructor(e,t,r,n){this.name=e,this.type=t,this.locationType=r,this.location=n,this.interpolation=null}}class oa{constructor(e,t,r,n){this.name=e,this.type=t,this.locationType=r,this.location=n}}class nd{constructor(e,t=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t}}class id{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class od{constructor(e,t,r,n){this.name=e,this.type=t,this.attributes=r,this.id=n}}class ad{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class at{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new id,this.functions=[],this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}update(e){const t=new td().parse(e);for(const r of t)r instanceof Gn&&this._functions.set(r.name,new ad(r));for(const r of t)if(r instanceof Lt){const n=this._getTypeInfo(r,null);n instanceof ns&&this.structs.push(n)}for(const r of t)if(r instanceof Ko)this.aliases.push(this._getAliasInfo(r));else if(r instanceof Jo){const n=r,i=this._getAttributeNum(n.attributes,"id",0),o=n.type!=null?this._getTypeInfo(n.type,n.attributes):null;this.overrides.push(new od(n.name,o,n.attributes,i))}else if(this._isUniformVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),u=this._getTypeInfo(n.type,n.attributes),l=new is(n.name,u,i,o,n.attributes,be.Uniform,n.access);this.uniforms.push(l)}else if(this._isStorageVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),u=this._getTypeInfo(n.type,n.attributes),l=this._isStorageTexture(u),m=new is(n.name,u,i,o,n.attributes,l?be.StorageTexture:be.Storage,n.access);this.storage.push(m)}else if(this._isTextureVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),u=this._getTypeInfo(n.type,n.attributes),l=this._isStorageTexture(u),m=new is(n.name,u,i,o,n.attributes,l?be.StorageTexture:be.Texture,n.access);l?this.storage.push(m):this.textures.push(m)}else if(this._isSamplerVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),u=this._getTypeInfo(n.type,n.attributes),l=new is(n.name,u,i,o,n.attributes,be.Sampler,n.access);this.samplers.push(l)}else if(r instanceof Gn){const n=this._getAttribute(r,"vertex"),i=this._getAttribute(r,"fragment"),o=this._getAttribute(r,"compute"),u=n||i||o,l=new nd(r.name,u==null?void 0:u.name);l.startLine=r.startLine,l.endLine=r.endLine,this.functions.push(l),this._functions.get(r.name).info=l,u&&(this._functions.get(r.name).inUse=!0,l.inUse=!0,l.resources=this._findResources(r,!!u),l.inputs=this._getInputs(r.args),l.outputs=this._getOutputs(r.returnType),this.entry[u.name].push(l))}for(const r of this._functions.values())r.info&&(r.info.inUse=r.inUse,this._addCalls(r.node,r.info.calls));for(const r of this.uniforms)this._markStructsInUse(r.type);for(const r of this.storage)this._markStructsInUse(r.type)}_markStructsInUse(e){if(e.isStruct){e.inUse=!0;for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var r;for(const n of e.calls){const i=(r=this._functions.get(n.name))===null||r===void 0?void 0:r.info;i&&t.add(i)}}findResource(e,t){for(const r of this.uniforms)if(r.group==e&&r.binding==t)return r;for(const r of this.storage)if(r.group==e&&r.binding==t)return r;for(const r of this.textures)if(r.group==e&&r.binding==t)return r;for(const r of this.samplers)if(r.group==e&&r.binding==t)return r;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this._getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const r=[],n=this,i=[];return e.search(o=>{if(o instanceof rs)i.push({});else if(o instanceof ss)i.pop();else if(o instanceof Rt){const u=o;t&&u.type!==null&&this._markStructsFromAST(u.type),i.length>0&&(i[i.length-1][u.name]=u)}else if(o instanceof er){const u=o;t&&u.type!==null&&this._markStructsFromAST(u.type)}else if(o instanceof Ln){const u=o;t&&u.type!==null&&this._markStructsFromAST(u.type),i.length>0&&(i[i.length-1][u.name]=u)}else if(o instanceof On){const u=o;if(i.length>0&&i[i.length-1][u.name])return;const l=n._findResource(u.name);l&&r.push(l)}else if(o instanceof $o){const u=o,l=n._functions.get(u.name);l&&(t&&(l.inUse=!0),e.calls.add(l.node),l.resources===null&&(l.resources=n._findResources(l.node,t)),r.push(...l.resources))}else if(o instanceof jo){const u=o,l=n._functions.get(u.name);l&&(t&&(l.inUse=!0),e.calls.add(l.node),l.resources===null&&(l.resources=n._findResources(l.node,t)),r.push(...l.resources))}}),[...new Map(r.map(o=>[o.name,o])).values()]}getBindGroups(){const e=[];function t(r,n){r>=e.length&&(e.length=r+1),e[r]===void 0&&(e[r]=[]),n>=e[r].length&&(e[r].length=n+1)}for(const r of this.uniforms)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.storage)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.textures)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.samplers)t(r.group,r.binding),e[r.group][r.binding]=r;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Lt)this._getStructOutputs(e,t);else{const r=this._getOutputInfo(e);r!==null&&t.push(r)}return t}_getStructOutputs(e,t){for(const r of e.members)if(r.type instanceof Lt)this._getStructOutputs(r.type,t);else{const n=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(n!==null){const i=this._getTypeInfo(r.type,r.type.attributes),o=this._parseInt(n.value),u=new oa(r.name,i,n.name,o);t.push(u)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getTypeInfo(e,e.attributes),n=this._parseInt(t.value);return new oa("",r,t.name,n)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const r of e)if(r.type instanceof Lt)this._getStructInputs(r.type,t);else{const n=this._getInputInfo(r);n!==null&&t.push(n)}return t}_getStructInputs(e,t){for(const r of e.members)if(r.type instanceof Lt)this._getStructInputs(r.type,t);else{const n=this._getInputInfo(r);n!==null&&t.push(n)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getAttribute(e,"interpolation"),n=this._getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),o=new sd(e.name,n,t.name,i);return r!==null&&(o.interpolation=this._parseString(r.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new rd(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,t){if(this._types.has(e))return this._types.get(e);if(e instanceof Yo){const n=e,i=this._getTypeInfo(n.format,n.attributes),o=new In(n.name,t);return o.format=i,o.count=n.count,this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof Lt){const n=e,i=new ns(n.name,t);i.startLine=n.startLine,i.endLine=n.endLine;for(const o of n.members){const u=this._getTypeInfo(o.type,o.attributes);i.members.push(new na(o.name,u,o.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof wr){const n=e,i=n.format instanceof Gt,o=n.format?i?this._getTypeInfo(n.format,null):new tr(n.format,null):null,u=new ia(n.name,o,t,n.access);return this._types.set(e,u),this._updateTypeInfo(u),u}if(e instanceof Xo){const n=e,i=n.format?this._getTypeInfo(n.format,null):null,o=new ia(n.name,i,t,n.access);return this._types.set(e,o),this._updateTypeInfo(o),o}const r=new tr(e.name,t);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var t,r;const n=this._getTypeSize(e);if(e.size=(t=n==null?void 0:n.size)!==null&&t!==void 0?t:0,e instanceof In){const i=this._getTypeSize(e.format);e.stride=(r=i==null?void 0:i.size)!==null&&r!==void 0?r:0,this._updateTypeInfo(e.format)}e instanceof ns&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let r=0,n=0,i=0,o=0;for(let u=0,l=e.members.length;u<l;++u){const m=e.members[u],b=this._getTypeSize(m);if(!b)continue;(t=this._getAlias(m.type.name))!==null&&t!==void 0||m.type;const d=b.align,x=b.size;r=this._roundUp(d,r+n),n=x,i=r,o=Math.max(o,d),m.offset=r,m.size=x,this._updateTypeInfo(m.type)}e.size=this._roundUp(o,i+n),e.align=o}_getTypeSize(e){var t;if(e==null)return null;const r=this._getAttributeNum(e.attributes,"size",0),n=this._getAttributeNum(e.attributes,"align",0);if(e instanceof na&&(e=e.type),e instanceof tr){const i=this._getAlias(e.name);i!==null&&(e=i)}{const i=at._typeInfo[e.name];if(i!==void 0){const o=e.format==="f16"?2:1;return new os(Math.max(n,i.align/o),Math.max(r,i.size/o))}}{const i=at._typeInfo[e.name.substring(0,e.name.length-1)];if(i){const o=e.name[e.name.length-1]==="h"?2:1;return new os(Math.max(n,i.align/o),Math.max(r,i.size/o))}}if(e instanceof In){let i=e,o=8,u=8;const l=this._getTypeSize(i.format);return l!==null&&(u=l.size,o=l.align),u=i.count*this._getAttributeNum((t=e==null?void 0:e.attributes)!==null&&t!==void 0?t:null,"stride",this._roundUp(o,u)),r&&(u=r),new os(Math.max(n,o),Math.max(r,u))}if(e instanceof ns){let i=0,o=0,u=0,l=0,m=0;for(const b of e.members){const d=this._getTypeSize(b.type);d!==null&&(i=Math.max(d.align,i),u=this._roundUp(d.align,u+l),l=d.size,m=u)}return o=this._roundUp(i,m+l),new os(Math.max(n,i),Math.max(r,o))}return null}_isUniformVar(e){return e instanceof Rt&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Rt&&e.storage=="storage"}_isTextureVar(e){return e instanceof Rt&&e.type!==null&&at._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Rt&&e.type!==null&&at._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const r=e;if(!r||!r.attributes)return null;const n=r.attributes;for(let i of n)if(i.name==t)return i;return null}_getAttributeNum(e,t,r){if(e===null)return r;for(let n of e)if(n.name==t){let i=n!==null&&n.value!==null?n.value:r;return i instanceof Array&&(i=i[0]),typeof i=="number"?i:typeof i=="string"?parseInt(i):r}return r}_roundUp(e,t){return Math.ceil(t/e)*e}}function rr(s,e){return Object.fromEntries(e.map(t=>{const r=function(n,i,o){switch(i.resourceType){case be.Uniform:case be.Storage:case be.StorageTexture:return Un(n,i.type,o);default:return{size:0,type:i.type.name}}}(s,t,0);return[t.name,{typeDefinition:r,group:t.group,binding:t.binding,size:r.size}]}))}function aa(s,e,t){return{fields:Object.fromEntries(e.members.map(r=>[r.name,{offset:r.offset,type:Un(s,r.type,0)}])),size:e.size,offset:t}}function ud(s){var e;if(s.name.includes("depth"))return"depth";switch((e=s.format)==null?void 0:e.name){case"f32":return"float";case"i32":return"sint";case"u32":return"uint";default:throw new Error("unknown texture sample type")}}function ua(s){return s.name.includes("2d_array")?"2d-array":s.name.includes("cube_array")?"cube-array":s.name.includes("3d")?"3d":s.name.includes("1d")?"1d":s.name.includes("cube")?"cube":"2d"}function cd(s){switch(s.access){case"read":return"read-only";case"write":return"write-only";case"read_write":return"read-write";default:throw new Error("unknonw storage texture access")}}function ld(s){return s.name.endsWith("_comparison")?"comparison":"filtering"}function dd(s,e){const{binding:t,access:r,type:n}=s;switch(s.resourceType){case be.Uniform:return{binding:t,visibility:e,buffer:{...s.size&&{minBindingSize:s.size}}};case be.Storage:return{binding:t,visibility:e,buffer:{type:r===""||r==="read"?"read-only-storage":"storage",...s.size&&{minBindingSize:s.size}}};case be.Texture:{if(n.name==="texture_external")return{binding:t,visibility:e,externalTexture:{}};const i=n.name.includes("multisampled");return{binding:t,visibility:e,texture:{sampleType:ud(n),viewDimension:ua(n),multisampled:i}}}case be.Sampler:return{binding:t,visibility:e,sampler:{type:ld(n)}};case be.StorageTexture:return{binding:t,visibility:e,storageTexture:{access:cd(n),format:n.format.name,viewDimension:ua(n)}};default:throw new Error("unknown resource type")}}function Fn(s,e){const t={};for(const r of s)t[r.name]={stage:e,resources:r.resources.map(n=>{const{name:i,group:o}=n;return{name:i,group:o,entry:dd(n,e)}})};return t}function Ot(s){const e=new at(s),t=Object.fromEntries(e.structs.map(u=>[u.name,aa(e,u,0)])),r=rr(e,e.uniforms),n=rr(e,e.storage.filter(u=>u.resourceType===be.Storage)),i=rr(e,e.storage.filter(u=>u.resourceType===be.StorageTexture)),o=rr(e,e.textures.filter(u=>u.type.name!=="texture_external"));return{externalTextures:rr(e,e.textures.filter(u=>u.type.name==="texture_external")),samplers:rr(e,e.samplers),structs:t,storages:n,storageTextures:i,textures:o,uniforms:r,entryPoints:{...Fn(e.entry.vertex,GPUShaderStage.VERTEX),...Fn(e.entry.fragment,GPUShaderStage.FRAGMENT),...Fn(e.entry.compute,GPUShaderStage.COMPUTE)}}}function Dn(s,e=""){if(!s)throw new Error(e)}function Un(s,e,t){if(e.isArray){Dn(!e.isStruct,"struct array is invalid"),Dn(!e.isStruct,"template array is invalid");const r=e;return{size:r.size,elementType:Un(s,r.format,t),numElements:r.count}}if(e.isStruct)return Dn(!e.isTemplate,"template struct is invalid"),aa(s,e,t);{const r=e,n=e.isTemplate?`${r.name}<${r.format.name}>`:e.name;return{size:e.size,type:n}}}at._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},at._textureTypes=B.any_texture_type.map(s=>s.name),at._samplerTypes=B.sampler_type.map(s=>s.name);const hd=new Map([[Int8Array,{formats:["sint8","snorm8"],defaultForType:1}],[Uint8Array,{formats:["uint8","unorm8"],defaultForType:1}],[Int16Array,{formats:["sint16","snorm16"],defaultForType:1}],[Uint16Array,{formats:["uint16","unorm16"],defaultForType:1}],[Int32Array,{formats:["sint32","snorm32"],defaultForType:0}],[Uint32Array,{formats:["uint32","unorm32"],defaultForType:0}],[Float32Array,{formats:["float32","float32"],defaultForType:0}]]);new Map([...hd.entries()].map(([s,{formats:[e,t]}])=>[[e,s],[t,s]]).flat());class fd{constructor(e,t){this.normal=e,this.d=t}normalize(){const e=D.len(this.normal);D.normalize(this.normal,this.normal),this.d/=e}checkIfBBoxIsInside(e){const t=this.normal[0]>=0?e.maxX:e.minX,r=this.normal[1]>=0?e.maxY:e.minY,n=this.normal[2]>=0?e.maxZ:e.minZ;return this.normal[0]*t+this.normal[1]*r+this.normal[2]*n+this.d>=0}}let ca={};const la=new WeakMap,da={metric:[{from:0,to:1e3,unit:"B",long:"bytes"},{from:1e3,to:1e6,unit:"kB",long:"kilobytes"},{from:1e6,to:1e9,unit:"MB",long:"megabytes"},{from:1e9,to:1e12,unit:"GB",long:"gigabytes"},{from:1e12,to:1e15,unit:"TB",long:"terabytes"},{from:1e15,to:1e18,unit:"PB",long:"petabytes"},{from:1e18,to:1e21,unit:"EB",long:"exabytes"},{from:1e21,to:1e24,unit:"ZB",long:"zettabytes"},{from:1e24,to:1e27,unit:"YB",long:"yottabytes"}],metric_octet:[{from:0,to:1e3,unit:"o",long:"octets"},{from:1e3,to:1e6,unit:"ko",long:"kilooctets"},{from:1e6,to:1e9,unit:"Mo",long:"megaoctets"},{from:1e9,to:1e12,unit:"Go",long:"gigaoctets"},{from:1e12,to:1e15,unit:"To",long:"teraoctets"},{from:1e15,to:1e18,unit:"Po",long:"petaoctets"},{from:1e18,to:1e21,unit:"Eo",long:"exaoctets"},{from:1e21,to:1e24,unit:"Zo",long:"zettaoctets"},{from:1e24,to:1e27,unit:"Yo",long:"yottaoctets"}],iec:[{from:0,to:Math.pow(1024,1),unit:"B",long:"bytes"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"KiB",long:"kibibytes"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"MiB",long:"mebibytes"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"GiB",long:"gibibytes"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"TiB",long:"tebibytes"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"PiB",long:"pebibytes"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"EiB",long:"exbibytes"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"ZiB",long:"zebibytes"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"YiB",long:"yobibytes"}],iec_octet:[{from:0,to:Math.pow(1024,1),unit:"o",long:"octets"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"Kio",long:"kibioctets"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"Mio",long:"mebioctets"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"Gio",long:"gibioctets"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"Tio",long:"tebioctets"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"Pio",long:"pebioctets"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"Eio",long:"exbioctets"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"Zio",long:"zebioctets"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"Yio",long:"yobioctets"}]};class pd{constructor(e,t){t=Object.assign({units:"metric",precision:1,locale:void 0},ca,t),la.set(this,t),Object.assign(da,t.customUnits);const r=e<0?"-":"";e=Math.abs(e);const n=da[t.units];if(!n)throw new Error(`Invalid units specified: ${t.units}`);{const i=n.find(o=>e>=o.from&&e<o.to);if(i){const o=new Intl.NumberFormat(t.locale,{style:"decimal",maximumFractionDigits:t.precision}),u=i.from===0?r+o.format(e):r+o.format(e/i.from);this.value=u,this.unit=i.unit,this.long=i.long}else this.value=r+e,this.unit="",this.long=""}}toString(){const e=la.get(this);return e.toStringFn?e.toStringFn.bind(this)():`${this.value} ${this.unit}`}}function ha(s,e){return new pd(s,e)}ha.defaultOptions=function(s){ca=s};const fa=new Map([["r16float",Uint16Array.BYTES_PER_ELEMENT],["rg16float",2*Uint16Array.BYTES_PER_ELEMENT],["rgba16float",4*Uint16Array.BYTES_PER_ELEMENT],["r32float",Float32Array.BYTES_PER_ELEMENT],["rg32float",2*Float32Array.BYTES_PER_ELEMENT],["rgba32float",4*Float32Array.BYTES_PER_ELEMENT],["bgra8unorm",4*Uint8Array.BYTES_PER_ELEMENT],["rgba8unorm",4*Uint8Array.BYTES_PER_ELEMENT],["depth24plus",3],["depth32float",Float32Array.BYTES_PER_ELEMENT],["depth24plus-stencil8",Float32Array.BYTES_PER_ELEMENT]]),uo=class uo extends Ze{static get formattedSize(){return this.getFormattedSize()}static getFormattedSize(){return ha(this.bytesAllocated).toString()}static addBytes(e){this.bytesAllocated+=e}static removeBytes(e){this.bytesAllocated-=e,this.bytesAllocated<0&&console.warn("Bytes allocated less than 0!")}static addBufferBytes(e){this.addBytes(e.size)}static removeBufferBytes(e){this.removeBytes(e.size)}static addTextureBytes(e){const t=fa.get(e.format);if(t)for(let r=0;r<e.depthOrArrayLayers;r++)for(let n=0;n<e.mipLevelCount;n++){const i=t*Math.ceil(e.width/Math.pow(2,n))*Math.ceil(e.height/Math.pow(2,n));this.addBytes(i)}else console.warn(`No byte size per pixel info for ${e.format}`)}static removeTextureBytes(e){const t=fa.get(e.format);if(t)for(let r=0;r<e.depthOrArrayLayers;r++)for(let n=0;n<e.mipLevelCount;n++){const i=t*Math.ceil(e.width/Math.pow(2,n))*Math.ceil(e.height/Math.pow(2,n));this.removeBytes(i)}else console.warn(`No byte size per pixel info for ${e.format}`)}};uo.bytesAllocated=0;let Y=uo;class sr{constructor(){this._position=D.fromValues(0,0,0),this._rotation=D.fromValues(0,0,0),this._scale=D.fromValues(1,1,1),this._worldPosition=D.create(),this.translateMatrix=Q.identity(),this.scaleMatrix=Q.identity(),this.rotationMatrix=Q.identity(),this.cachedMatrix=Q.create(),this.worldMatrix=Q.identity(),this.normalMatrix=Qr.create(),this.quaternion=Zr.create(),this.prevFrameModelMatrix=Q.create(),this.matrixNeedsUpdate=!0,this.id=crypto.randomUUID(),this.label="Object",this.children=[],this._visible=!0}get visible(){return this._visible}set visible(e){this.onVisibilityChange(e),this._visible=e}get modelMatrix(){return this.worldMatrix}setCustomMatrix(e){this._customMatrix=e,this.matrixNeedsUpdate=!0}setCustomMatrixFromTRS(e,t,r){const n=Q.scaling(r),i=Q.fromQuat(t),o=Q.translation(e);Q.mul(n,i,n),Q.mul(n,o),this.setCustomMatrix(n)}updateNormalMatrix(){Qr.fromMat4(this.worldMatrix,this.normalMatrix),Qr.inverse(this.normalMatrix,this.normalMatrix),Qr.transpose(this.normalMatrix,this.normalMatrix)}updateWorldMatrix(){var t;const e=((t=this.parent)==null?void 0:t.worldMatrix)??Al;return this.matrixNeedsUpdate?(this._customMatrix?Q.copy(this._customMatrix,this.cachedMatrix):(Q.identity(this.scaleMatrix),Q.scale(this.scaleMatrix,this.scale,this.scaleMatrix),this.quaternion=Zr.fromEuler(this.rotation[0],this.rotation[1],this.rotation[2],"xyz"),Q.fromQuat(this.quaternion,this.rotationMatrix),Q.identity(this.translateMatrix),Q.translate(this.translateMatrix,this.position,this.translateMatrix),Q.mul(this.scaleMatrix,this.rotationMatrix,this.cachedMatrix),Q.mul(this.translateMatrix,this.cachedMatrix,this.cachedMatrix)),Q.mul(e,this.cachedMatrix,this.worldMatrix),Q.copy(this.worldMatrix,this.prevFrameModelMatrix),this.updateNormalMatrix(),this.matrixNeedsUpdate=!1,!0):(Q.mul(e,this.cachedMatrix,this.worldMatrix),Q.copy(this.worldMatrix,this.prevFrameModelMatrix),this.updateNormalMatrix(),!1)}onVisibilityChange(e){}addChild(e){e.parent=this,this.children.push(e),e.updateWorldMatrix(),this.onChildAdd(e)}removeChild(e){this.children=this.children.filter(({id:t})=>t!=e.id),e.parent=null,this.onChildRemove(e)}onChildAdd(e){var t;(t=this.parent)==null||t.onChildAdd(e)}onChildRemove(e){var t;(t=this.parent)==null||t.onChildRemove(e)}traverse(e,t=!0){if(e(this),t)for(const r of this.children)r.traverse(e,t)}findChild(e){if(e(this))return this;for(const t of this.children)if(t.findChild(e))return t}findChildByLabel(e){return this.findChild(({label:t})=>e===t)}findChildById(e){return this.findChild(({id:t})=>e===t)}preRender(e){}onRender(e){}postRender(e){}render(e){this.visible&&(this.preRender(e),this.onRender(e),this.postRender(e))}get worldPosition(){return this.getWorldPosition()}getWorldPosition(){return this._worldPosition[0]=this.worldMatrix[12],this._worldPosition[1]=this.worldMatrix[13],this._worldPosition[2]=this.worldMatrix[14],this._worldPosition}setPositionAsVec3(e){return D.clone(e,this._position),this.matrixNeedsUpdate=!0,this}setPosition(e,t,r){return this._position[0]=e,this._position[1]=t,this._position[2]=r,this.matrixNeedsUpdate=!0,this}setPositionX(e){return this._position[0]=e,this.matrixNeedsUpdate=!0,this}setPositionY(e){return this._position[1]=e,this.matrixNeedsUpdate=!0,this}setPositionZ(e){return this._position[2]=e,this.matrixNeedsUpdate=!0,this}get position(){return this.getPosition()}getPosition(){return this._position}getPositionX(){return this._position[0]}getPositionY(){return this._position[1]}getPositionZ(){return this._position[2]}setRotation(e,t,r){return this._rotation[0]=e,this._rotation[1]=t,this._rotation[2]=r,this.matrixNeedsUpdate=!0,this}setRotationX(e){return this._rotation[0]=e,this.matrixNeedsUpdate=!0,this}setRotationY(e){return this._rotation[1]=e,this.matrixNeedsUpdate=!0,this}setRotationZ(e){return this._rotation[2]=e,this.matrixNeedsUpdate=!0,this}get rotation(){return this.getRotation()}getRotation(){return this._rotation}getRotationX(){return this._rotation[0]}getRotationY(){return this._rotation[1]}getRotationZ(){return this._rotation[2]}setScale(e,t,r){return this._scale[0]=e,this._scale[1]=t,this._scale[2]=r,this.matrixNeedsUpdate=!0,this}setScaleX(e){return this._scale[0]=e,this.matrixNeedsUpdate=!0,this}setScaleY(e){return this._scale[1]=e,this.matrixNeedsUpdate=!0,this}setScaleZ(e){return this._scale[2]=e,this.matrixNeedsUpdate=!0,this}get scale(){return this.getScale()}getScale(){return this._scale}getScaleX(){return this._scale[0]}getScaleY(){return this._scale[1]}getScaleZ(){return this._scale[2]}}const Ne=Object.freeze({get Position(){return 0},get Normal(){return 1},get TexCoord(){return 2},get Tangent(){return 3}}),ue=Object.freeze({get CameraPlusOptionalLights(){return 0},get Model(){return 1},get PBRTextures(){return 2},get InstanceInputs(){return 3}}),ut=Object.freeze({get NormalMetallicRoughness(){return 0},get ColorReflectance(){return 1},get Velocity(){return 2}}),as=Object.freeze({get Default(){return 0}}),me=Object.freeze({get Albedo(){return 1},get Normal(){return 2},get MetallicRoughness(){return 3},get AO(){return 4}}),W=Object.freeze({get VertexInput(){return`

      struct VertexInput {
        @location(${Ne.Position}) position: vec4f,
        @location(${Ne.Normal}) normal: vec3f,
        @location(${Ne.TexCoord}) uv: vec2f,
        @location(${Ne.Tangent}) tangent: vec4f,
      };

    `},get VertexOutput(){return`
    
      struct VertexOutput {
        @builtin(position) position: vec4f,
        @location(0) worldPosition: vec3f,
        @location(1) viewNormal: vec3f,
        @location(2) uv: vec2f,
        @location(3) viewTangent: vec3f,
        @location(4) viewBitangent: vec3f,
        @location(5) currFrameClipPos: vec4f,
        @location(6) prevFrameClipPos: vec4f,
        @location(7) @interpolate(flat) instanceId: u32,
      };

    `},get InstanceInput(){return`
      struct InstanceInput {
        worldMatrix: mat4x4f,
        metallic: f32,
        roughness: f32,
      };
    `},get ModelUniform(){return`

      struct ModelUniform {
        worldMatrix: mat4x4f,
        prevFrameWorldMatrix: mat4x4f,
        normalMatrix: mat3x3f,
        baseColor: vec3f,
        isReflective: u32,
        metallic: f32,
        roughness: f32,
      };

    `},get Camera(){return`

      struct Camera {
        position: vec3f,
        projectionMatrix: mat4x4f,
        viewMatrix: mat4x4f,
        projectionViewMatrix: mat4x4f,
        inverseProjectionViewMatrix: mat4x4f,
        inverseViewMatrix: mat4x4f,
        inverseProjectionMatrix: mat4x4f,
        prevFrameProjectionViewMatrix: mat4x4f,
        viewportWidth: u32,
        viewportHeight: u32,
        jitterOffset: vec2f,
      };

      @must_use
      fn calcWorldPos(
        camera: Camera,
        coord: vec2f,
        depth: f32
      ) -> vec3f {
        let ndcX = coord.x / f32(camera.viewportWidth) * 2.0 - 1.0;
        let ndcY = (1.0 - coord.y / f32(camera.viewportHeight)) * 2.0 - 1.0;
        let clipPos = vec4f(ndcX, ndcY, depth, 1.0);

        let worldSpacePos = camera.inverseProjectionViewMatrix * clipPos;
        return worldSpacePos.xyz / worldSpacePos.w;
      }

      @must_use
      fn calcViewSpacePos(
        camera: Camera,
        coord: vec2f,
        depth: f32
      ) -> vec3f {
        let ndcX = coord.x / f32(camera.viewportWidth) * 2.0 - 1.0;
        let ndcY = (1.0 - coord.y / f32(camera.viewportHeight)) * 2.0 - 1.0;
        let clipPos = vec4f(ndcX, ndcY, depth, 1.0);

        let viewSpacePos = camera.inverseProjectionMatrix * clipPos;
        return viewSpacePos.xyz / viewSpacePos.w;
      }

    `},get GBufferOutput(){return`

      struct GBufferOutput {
        @location(${ut.NormalMetallicRoughness}) normalMetallicRoughness: vec4f,
        @location(${ut.ColorReflectance}) color: vec4f,
        @location(${ut.Velocity}) velocity: vec4f,
      };
      
    `},get AABB(){return`
      struct AABB {
        min: vec3f,
        max: vec3f,
      };
    `},get Particle(){return`
      struct Particle {
        radius: f32,
        position: vec3f,
        origPosition: vec3f,
        velocity: vec3f,
        lifeSpeed: f32,
        life: f32
      };
    `},get Light(){return`

      struct Light {
        lightType: u32, // 0 - Directional Light, 1 - Point Light, 2 - Ambient Light
        intensity: f32,
        radius: f32,
        position: vec3f,
        color: vec3f,
      };

    `},get Material(){return`
    
      struct Material {
        metallic: f32,
        albedo: vec3f,
        roughness: f32,
        ambientOcclusion: f32,
      };

    `},get ShadowCascade(){return`
      struct ShadowCascade {
        projViewMatrix: mat4x4<f32>,
        distance: f32,
      };
    `},get CommonHelpers(){return`

      const WORLD_UP = vec3f(0.0, 1.0, 0.0);
      const WORLD_FORWARD = vec3f(0.0, 0.0, 1.0);
      const PI: f32 = 3.1415;
      const TWO_PI: f32 = 6.2831;
      const HALF_PI: f32 = 1.5707;
      const DELTA_PHI: f32 = 0.01745;
      const DELTA_THETA: f32 = 0.01745;
    
      const CUBE_NORMALS: array<vec3<f32>, 6> = array<vec3<f32>, 6>(
        vec3<f32>(1.0, 0.0, 0.0),
        vec3<f32>(-1.0, 0.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, -1.0, 0.0),
        vec3<f32>(0.0, 0.0, 1.0),
        vec3<f32>(0.0, 0.0, -1.0)
      );
      
      const CUBE_UPS: array<vec3<f32>, 6> = array<vec3<f32>, 6>(
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 0.0, -1.0),
        vec3<f32>(0.0, 0.0, 1.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0)
      );
      
      const CUBE_ROTATIONS: array<vec4<f32>, 6> = array<vec4<f32>, 6>(
        vec4<f32>(0.0, 1.0, 0.0, HALF_PI),
        vec4<f32>(0.0, 1.0, 0.0, -HALF_PI),
        vec4<f32>(1.0, 0.0, 0.0, -HALF_PI),
        vec4<f32>(1.0, 0.0, 0.0, HALF_PI),
        vec4<f32>(0.0, 0.0, 1.0, 0.0),
        vec4<f32>(0.0, 1.0, 0.0, PI)
      );
    `},get MathHelpers(){return`

      @must_use
      fn rotateAxisAngle(inAxis: vec3f, angle: f32) -> mat3x3f {
        let axis = normalize(inAxis);
        let s = sin(angle);
        let c = cos(angle);
        let oc = 1.0 - c;
    
        return mat3x3f(
          oc * axis.x * axis.x + c, oc * axis.x * axis.y - axis.z * s, oc * axis.z * axis.x + axis.y * s,
          oc * axis.x * axis.y + axis.z * s, oc * axis.y * axis.y + c, oc * axis.y * axis.z - axis.x * s,
          oc * axis.z * axis.x - axis.y * s, oc * axis.y * axis.z + axis.x * s, oc * axis.z * axis.z + c
        );
      }
      
    `}}),pa=[[.5,.333333],[.25,.666667],[.75,.111111],[.125,.444444],[.625,.777778],[.375,.222222],[.875,.555556],[.0625,.888889],[.5625,.037037],[.3125,.37037],[.8125,.703704],[.1875,.148148],[.6875,.481481],[.4375,.814815],[.9375,.259259],[.03125,.592593]],tn=class tn extends sr{constructor(){super(),this.lookAt=D.fromValues(0,0,0),this.hasChangedSinceLastFrame=!0,this.projectionMatrix=Q.create(),this.inverseProjectionMatrix=Q.create(),this.viewMatrix=Q.create(),this.inverseViewMatrix=Q.create(),this.projectionViewMatrix=Q.create(),this.inverseProjectionViewMatrix=Q.create(),this._shouldJitter=!1,this._shouldJitterChanged=!1,this.prevFrameProjectionViewMatrix=Q.create(),this.frameCounter=0,this.frustumPlanes=[],this.hamiltonSequence=new Array(16).fill([]).map(()=>new Array(2).fill(0));const e=Ot(W.Camera);this.bufferUniformValues=yt(e.structs.Camera),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,projectionMatrix:this.projectionMatrix,projectionViewMatrix:this.projectionViewMatrix}),this.gpuBuffer=v.device.createBuffer({size:this.bufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,label:"Camera GPUBuffer"}),Y.addBufferBytes(this.gpuBuffer);for(let t=0;t<6;t++)this.frustumPlanes.push(new fd(D.create(),0))}get shouldJitter(){return this._shouldJitter}set shouldJitter(e){this._shouldJitter=e,this._shouldJitterChanged=!0}set x(e){this.position[0]=e,this.bufferUniformValues.set({position:this.position})}get x(){return this.position[0]}set y(e){this.position[1]=e,this.bufferUniformValues.set({position:this.position})}get y(){return this.position[1]}set z(e){this.position[2]=e,this.bufferUniformValues.set({position:this.position})}get z(){return this.position[2]}get frustumCornersWorldSpace(){const e=this.inverseProjectionViewMatrix,t=[];for(let r=0;r<2;r++)for(let n=0;n<2;n++)for(let i=0;i<2;i++){const o=2*r-1,u=2*n-1,l=i,m=1,b=Br.create(o,u,l,m);Br.transformMat4(b,e,b),b[0]/=b[3],b[1]/=b[3],b[2]/=b[3],t.push(b)}return t}cullMeshes(e,t){let r=0;for(let n=0;n<e.length;n++){const i=e[n].worldBoundingBox;let o=0;for(const u of this.frustumPlanes)u.checkIfBBoxIsInside(i)&&o++;o===6&&(t[r]=e[n],r++)}return r}setLookAt(e,t,r){this.lookAt[0]=e,this.lookAt[1]=t,this.lookAt[2]=r}setLookAtVec3(e){this.lookAt=e}updateViewMatrix(){return Q.lookAt(this.position,this.lookAt,tn.UP_VECTOR,this.viewMatrix),Q.inverse(this.viewMatrix,this.inverseViewMatrix),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,inverseViewMatrix:this.inverseViewMatrix}),this.updateProjectionViewMatrix(),this}updateViewMatrixWithMat(e){return this.viewMatrix=e,Q.inverse(this.viewMatrix,this.inverseViewMatrix),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,inverseViewMatrix:this.inverseViewMatrix}),this.updateProjectionViewMatrix(),this}updateProjectionMatrix(){return Q.inverse(this.projectionMatrix,this.inverseProjectionMatrix),this.bufferUniformValues.set({projectionMatrix:this.projectionMatrix,inverseProjectionMatrix:this.inverseProjectionMatrix}),this.updateProjectionViewMatrix(),this}updateProjectionViewMatrix(){return Q.mul(this.projectionMatrix,this.viewMatrix,this.projectionViewMatrix),Q.inverse(this.projectionViewMatrix,this.inverseProjectionViewMatrix),this.bufferUniformValues.set({projectionViewMatrix:this.projectionViewMatrix,inverseProjectionViewMatrix:this.inverseProjectionViewMatrix,prevFrameProjectionViewMatrix:this.prevFrameProjectionViewMatrix}),this.updateFrustumPlanes(),this}onResize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.bufferUniformValues.set({viewportWidth:e,viewportHeight:t});for(let r=0;r<16;r++)this.hamiltonSequence[r][0]=(pa[r][0]-.5)/this.viewportWidth*2,this.hamiltonSequence[r][1]=(pa[r][1]-.5)/this.viewportHeight*2}onFrameStart(){const e=this.hamiltonSequence[this.frameCounter%16];this._shouldJitterChanged&&(this._shouldJitter||this.bufferUniformValues.set({jitterOffset:[0,0]}),this._shouldJitterChanged=!1),this._shouldJitter&&this.bufferUniformValues.set({jitterOffset:e}),v.device.queue.writeBuffer(this.gpuBuffer,0,this.bufferUniformValues.arrayBuffer)}onFrameEnd(){Q.copy(this.projectionViewMatrix,this.prevFrameProjectionViewMatrix),this.frameCounter++,this.hasChangedSinceLastFrame=!1}updateFrustumPlanes(){const e=this.projectionViewMatrix;this.frustumPlanes[0].normal[0]=e[3]+e[0],this.frustumPlanes[0].normal[1]=e[7]+e[4],this.frustumPlanes[0].normal[2]=e[11]+e[8],this.frustumPlanes[0].d=e[15]+e[12],this.frustumPlanes[1].normal[0]=e[3]-e[0],this.frustumPlanes[1].normal[1]=e[7]-e[4],this.frustumPlanes[1].normal[2]=e[11]-e[8],this.frustumPlanes[1].d=e[15]-e[12],this.frustumPlanes[2].normal[0]=e[3]+e[1],this.frustumPlanes[2].normal[1]=e[7]+e[5],this.frustumPlanes[2].normal[2]=e[11]+e[9],this.frustumPlanes[2].d=e[15]+e[13],this.frustumPlanes[3].normal[0]=e[3]-e[1],this.frustumPlanes[3].normal[1]=e[7]-e[5],this.frustumPlanes[3].normal[2]=e[11]-e[9],this.frustumPlanes[3].d=e[15]-e[13],this.frustumPlanes[4].normal[0]=e[3]+e[2],this.frustumPlanes[4].normal[1]=e[7]+e[6],this.frustumPlanes[4].normal[2]=e[11]+e[10],this.frustumPlanes[4].d=e[15]+e[14],this.frustumPlanes[5].normal[0]=e[3]-e[2],this.frustumPlanes[5].normal[1]=e[7]-e[6],this.frustumPlanes[5].normal[2]=e[11]-e[10],this.frustumPlanes[5].d=e[15]-e[14];for(const t of this.frustumPlanes)t.normalize()}};tn.UP_VECTOR=D.fromValues(0,1,0);let us=tn;class kn extends us{constructor(e,t,r,n){super(),this.fieldOfView=e,this.aspect=t,this.fieldOfView=e*Math.PI/180,this.aspect=t,this.near=r,this.far=n,this.updateProjectionMatrix()}onResize(e,t){super.onResize(e,t),this.aspect=e/t,this.updateProjectionMatrix()}updateProjectionMatrix(){return Q.perspective(this.fieldOfView,this.aspect,this.near,this.far,this.projectionMatrix),super.updateProjectionMatrix(),this.updateProjectionViewMatrix(),this}}var V=(s=>(s[s.Deferred=0]="Deferred",s[s.DirectionalAmbientLighting=1]="DirectionalAmbientLighting",s[s.PointLightsNonCulledLighting=2]="PointLightsNonCulledLighting",s[s.PointLightsStencilMask=3]="PointLightsStencilMask",s[s.PointLightsLighting=4]="PointLightsLighting",s[s.SSAO=5]="SSAO",s[s.SSAOBlur=6]="SSAOBlur",s[s.Skybox=7]="Skybox",s[s.Transparent=8]="Transparent",s[s.Shadow=9]="Shadow",s[s.MomentsShadow=10]="MomentsShadow",s[s.BlurMomentsShadow=11]="BlurMomentsShadow",s[s.EnvironmentCube=12]="EnvironmentCube",s[s.TAAResolve=13]="TAAResolve",s[s.CopyDepthForHiZ=14]="CopyDepthForHiZ",s[s.HiZ=15]="HiZ",s[s.Reflection=16]="Reflection",s[s.BloomDownsample=17]="BloomDownsample",s[s.BloomUpsample=18]="BloomUpsample",s[s.DebugBounds=19]="DebugBounds",s[s.Blit=20]="Blit",s))(V||{}),se=(s=>(s[s.CPUTotal=0]="CPUTotal",s[s.GPUTotal=1]="GPUTotal",s[s.FPS=2]="FPS",s[s.VRAM=3]="VRAM",s[s.VisibleMeshes=4]="VisibleMeshes",s[s.LightsCount=5]="LightsCount",s[s.DeferredRenderPass=6]="DeferredRenderPass",s[s.DirectionalAmbientLightingRenderPass=7]="DirectionalAmbientLightingRenderPass",s[s.PointLightsStencilMask=8]="PointLightsStencilMask",s[s.PointLightsLighting=9]="PointLightsLighting",s[s.SSAORenderPass=10]="SSAORenderPass",s[s.TransparentRenderPass=11]="TransparentRenderPass",s[s.ShadowRenderPass=12]="ShadowRenderPass",s[s.TAAResolveRenderPass=13]="TAAResolveRenderPass",s[s.ReflectionRenderPass=14]="ReflectionRenderPass",s[s.BlitRenderPass=15]="BlitRenderPass",s))(se||{}),It=(s=>(s[s.Directional=0]="Directional",s[s.Point=1]="Point",s[s.Ambient=2]="Ambient",s))(It||{});const md=new Map([[It.Directional,0],[It.Point,1],[It.Ambient,2]]);V.Deferred,V.DirectionalAmbientLighting,V.SSAO,V.Transparent,V.Shadow,V.TAAResolve,V.Reflection,V.Blit;const gd=[se.CPUTotal,se.GPUTotal,se.FPS,se.VRAM,se.VisibleMeshes,se.LightsCount],Cr=new Map([[V.Deferred,"G-Buffer Render Pass"],[V.DirectionalAmbientLighting,"Directional + Ambient Render Pass"],[V.PointLightsStencilMask,"Point Lights Stencil Mask Pass"],[V.PointLightsLighting,"Point Lights LightingSystem"],[V.SSAO,"SSAO Render Pass"],[V.SSAOBlur,"SSAO Blur Render Pass"],[V.Skybox,"Skybox Render Pass"],[V.Transparent,"Transparent Render Pass"],[V.Shadow,"Shadow Render Pass"],[V.EnvironmentCube,"Environment Cube Pass"],[V.TAAResolve,"TAA Resolve Render Pass"],[V.CopyDepthForHiZ,"Copy Depth for Hi-Z Render Pass"],[V.HiZ,"Hi-Z Depth Render Pass"],[V.Reflection,"SSR Render Pass"],[V.DebugBounds,"Debug Bounds Render Pass"],[V.Blit,"Blit Render Pass"]]);class yd{constructor(){this.passes=[],this.textureCache=new Map}destroy(){for(const e of this.passes)e.destroy();this.textureCache.clear()}setScene(e){this.scene=e}addPass(e){if(!this.passes.some(({type:t})=>t===e.type))return this.passes.push(e),this;{const t=Cr.get(e.type);console.warn(`RenderPass ${t} has already been added`)}}removePass(e){this.passes=this.passes.filter(({type:t})=>t!==e)}getPass(e){return this.passes.find(({type:t})=>t===e)}setTexture(e,t){this.textureCache.set(e,t)}getTexture(e){return this.textureCache.get(e)}async render(e){for(const t of this.passes){if(!t.enabled)continue;const r=t.inputTextureNames.map(i=>this.textureCache.get(i)),n=t.render(e,this.scene,r);t.outputTextureNames.forEach((i,o)=>{this.textureCache.set(i,n[o])})}}onFrameEnd(){for(const e of this.passes)e.onFrameEnd()}}class Nn{constructor(){this.c0=0,this.c1=0,this.c2=0,this.c3=0}set(e,t,r,n){this.c0=e,this.c1=r,this.c2=-3*e+3*t-2*r-n,this.c3=2*e-2*t+r+n}initCatmullRom(e,t,r,n,i){this.set(t,r,i*(r-e),i*(n-t))}initNonuniformCatmullRom(e,t,r,n,i,o,u){let l=(t-e)/i-(r-e)/(i+o)+(r-t)/o,m=(r-t)/o-(n-t)/(o+u)+(n-r)/u;l*=o,m*=o,this.set(t,r,l,m)}calc(e){const t=e*e,r=t*e;return this.c0+this.c1*e+this.c2*t+this.c3*r}}const ma=new Nn,ga=new Nn,ya=new Nn,bt=D.create();class bd{constructor(e=[],t=!1,r=.5){this.points=e,this.closed=t,this.tension=r}getPoint(e,t=D.create()){const r=t,n=this.points.length,i=(n-(this.closed?0:1))*e;let o,u,l=Math.floor(i),m=i-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/n)+1)*n:m===0&&l===n-1&&(l=n-2,m=1),this.closed||l>0?o=this.points[(l-1)%n]:(D.sub(this.points[0],this.points[1],bt),D.add(bt,this.points[0],bt),o=bt);const b=this.points[l%n],d=this.points[(l+1)%n];this.closed||l+2<n?u=this.points[(l+2)%n]:(D.sub(this.points[n-1],this.points[n-2],bt),D.add(bt,this.points[n-1],bt),u=bt);const x=.25;let g=Math.pow(D.distSq(o,b),x),_=Math.pow(D.distSq(b,d),x),w=Math.pow(D.distSq(d,u),x);return _<1e-4&&(_=1),g<1e-4&&(g=_),w<1e-4&&(w=_),ma.initNonuniformCatmullRom(o[0],b[0],d[0],u[0],g,_,w),ga.initNonuniformCatmullRom(o[1],b[1],d[1],u[1],g,_,w),ya.initNonuniformCatmullRom(o[2],b[2],d[2],u[2],g,_,w),D.set(ma.calc(m),ga.calc(m),ya.calc(m),r),r}getPoints(e=5){const t=[];for(let r=0;r<e;r++)t.push(this.getPoint(r/e));return t}}class cs{constructor(e=200){this.numSamples=e,this.total=0,this.samples=[],this.cursor=0}addSample(e){this.total+=e-(this.samples[this.cursor]||0),this.samples[this.cursor]=e,this.cursor=(this.cursor+1)%this.numSamples}get(){return this.total/this.samples.length}}async function ba(s,e,t,r){return r._parse(s,e,t,r)}function ct(s,e){if(!s)throw new Error(e||"loader assertion failed.")}const ls=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),xa=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);xa&&parseFloat(xa[1]);const ds=globalThis,nr=globalThis.process||{};function Vn(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||function(){var e,t;if(typeof window<"u"&&((e=window.process)==null?void 0:e.type)==="renderer"||typeof process<"u"&&((t=process.versions)!=null&&t.electron))return!0;const s=typeof navigator<"u"&&navigator.userAgent;return!!(s&&s.indexOf("Electron")>=0)}()}const _a="4.0.7";class xd{constructor(e,t,r="sessionStorage"){this.storage=function(n){try{const i=window[n],o="__storage_test__";return i.setItem(o,o),i.removeItem(o),i}catch{return null}}(r),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}var hs;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(hs||(hs={}));function Aa(s){return typeof s!="string"?s:(s=s.toUpperCase(),hs[s]||hs.WHITE)}function Hn(s,e){if(!s)throw new Error("Assertion failed")}function ir(){var e,t,r;let s;if(Vn()&&ds.performance)s=(t=(e=ds==null?void 0:ds.performance)==null?void 0:e.now)==null?void 0:t.call(e);else if("hrtime"in nr){const n=(r=nr==null?void 0:nr.hrtime)==null?void 0:r.call(nr);s=1e3*n[0]+n[1]/1e6}else s=Date.now();return s}const or={debug:Vn()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},_d={enabled:!0,level:0};function ar(){}const Ba={},va={once:!0};class Jn{constructor({id:e}={id:""}){this.VERSION=_a,this._startTs=ir(),this._deltaTs=ir(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new xd(`__probe-${this.id}__`,_d),this.timeStamp(`${this.id} started`),function(t,r=["constructor"]){const n=Object.getPrototypeOf(t),i=Object.getOwnPropertyNames(n),o=t;for(const u of i){const l=o[u];typeof l=="function"&&(r.find(m=>u===m)||(o[u]=l.bind(t)))}}(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((ir()-this._startTs).toPrecision(10))}getDelta(){return Number((ir()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,or.warn,arguments,va)}error(e){return this._getLogFunction(0,e,or.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,or.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,or.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,or.debug||or.info,arguments,va)}table(e,t,r){return t?this._getLogFunction(e,t,console.table||ar,r&&[r],{tag:Ad(t)}):ar}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||ar)}group(e,t,r={collapsed:!1}){const n=Ca({logLevel:e,message:t,opts:r}),{collapsed:i}=r;return n.method=(i?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t,r={}){return this.group(e,t,Object.assign({},r,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||ar)}withGroup(e,t,r){this.group(e,t)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=wa(e)}_getLogFunction(e,t,r,n,i){if(this._shouldLog(e)){i=Ca({logLevel:e,message:t,args:n,opts:i}),Hn(r=r||i.method),i.total=this.getTotal(),i.delta=this.getDelta(),this._deltaTs=ir();const o=i.tag||i.message;if(i.once&&o){if(Ba[o])return ar;Ba[o]=ir()}return t=function(u,l,m){if(typeof l=="string"){const b=m.time?function(d,x=8){const g=Math.max(x-d.length,0);return`${" ".repeat(g)}${d}`}(function(d){let x;return x=d<10?`${d.toFixed(2)}ms`:d<100?`${d.toFixed(1)}ms`:d<1e3?`${d.toFixed(0)}ms`:`${(d/1e3).toFixed(2)}s`,x}(m.total)):"";l=function(d,x,g){return Vn||typeof d!="string"||(x&&(d=`\x1B[${Aa(x)}m${d}\x1B[39m`),g&&(d=`\x1B[${Aa(g)+10}m${d}\x1B[49m`)),d}(l=m.time?`${u}: ${b}  ${l}`:`${u}: ${l}`,m.color,m.background)}return l}(this.id,i.message,i),r.bind(console,t,...i.args)}return ar}}function wa(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return Hn(Number.isFinite(e)&&e>=0),e}function Ca(s){const{logLevel:e,message:t}=s;s.logLevel=wa(e);const r=s.args?Array.from(s.args):[];for(;r.length&&r.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&r.unshift(t),s.message=e;break;case"object":Object.assign(s,e)}typeof s.message=="function"&&(s.message=s.message());const n=typeof s.message;return Hn(n==="string"||n==="object"),Object.assign(s,{args:r},s.opts)}function Ad(s){for(const e in s)for(const t in s[e])return t||"untitled";return"empty"}Jn.VERSION=_a;const zn="4.3.2",Bd=zn[0]>="0"&&zn[0]<="9"?`v${zn}`:"",vd=function(){const s=new Jn({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=s,globalThis.loaders.version=Bd,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=s,s}();function wd(s,e){return Ta(s||{},e)}function Ta(s,e,t=0){if(t>3)return e;const r={...s};for(const[n,i]of Object.entries(e))i&&typeof i=="object"&&!Array.isArray(i)?r[n]=Ta(r[n]||{},e[n],t+1):r[n]=e[n];return r}const Cd=((zc=globalThis._loadersgl_)!=null&&zc.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version);function lt(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}const Ve=typeof process!="object"||String(process)!=="[object process]"||process.browser,jn=typeof importScripts=="function",Td=typeof window<"u"&&window.orientation!==void 0,Sa=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Sa&&parseFloat(Sa[1]);class Sd{constructor(e,t){ee(this,"name");ee(this,"workerThread");ee(this,"isRunning",!0);ee(this,"result");ee(this,"_resolve",()=>{});ee(this,"_reject",()=>{});this.name=e,this.workerThread=t,this.result=new Promise((r,n)=>{this._resolve=r,this._reject=n})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){lt(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){lt(this.isRunning),this.isRunning=!1,this._reject(e)}}class Kn{terminate(){}}const Xn=new Map;function Ed(s){lt(s.source&&!s.url||!s.source&&s.url);let e=Xn.get(s.source||s.url);return e||(s.url&&(e=function(t){if(!t.startsWith("http"))return t;return Ea((r=t,`try {
  importScripts('${r}');
} catch (error) {
  console.error(error);
  throw error;
}`));var r}(s.url),Xn.set(s.url,e)),s.source&&(e=Ea(s.source),Xn.set(s.source,e))),lt(e),e}function Ea(s){const e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function Ma(s,e=!0,t){const r=t||new Set;if(s){if(Pa(s))r.add(s);else if(Pa(s.buffer))r.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(const n in s)Ma(s[n],e,r)}}return t===void 0?Array.from(r):[]}function Pa(s){return!!s&&(s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas)}const Yn=()=>{};class Wn{constructor(e){ee(this,"name");ee(this,"source");ee(this,"url");ee(this,"terminated",!1);ee(this,"worker");ee(this,"onMessage");ee(this,"onError");ee(this,"_loadableURL","");const{name:t,source:r,url:n}=e;lt(r||n),this.name=t,this.source=r,this.url=n,this.onMessage=Yn,this.onError=i=>console.log(i),this.worker=Ve?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&Ve||Kn!==void 0&&!Ve}destroy(){this.onMessage=Yn,this.onError=Yn,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||Ma(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=Ed({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const t=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Kn(t,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new Kn(this.source,{eval:!0})}return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class Md{constructor(e){ee(this,"name","unnamed");ee(this,"source");ee(this,"url");ee(this,"maxConcurrency",1);ee(this,"maxMobileConcurrency",1);ee(this,"onDebug",()=>{});ee(this,"reuseWorkers",!0);ee(this,"props",{});ee(this,"jobQueue",[]);ee(this,"idleQueue",[]);ee(this,"count",0);ee(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return Wn.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(n,i,o)=>n.done(o),r=(n,i)=>n.error(i)){const n=new Promise(i=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:i}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new Sd(t.name,e);e.onMessage=n=>t.onMessage(r,n.type,n.payload),e.onError=n=>t.onError(r,n),t.onStart(r);try{await r.result}catch(n){console.error(`Worker exception: ${n}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Ve||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Wn({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Td?this.maxMobileConcurrency:this.maxConcurrency}}const Pd={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},wt=class wt{constructor(e){ee(this,"props");ee(this,"workerPools",new Map);this.props={...Pd},this.setProps(e),this.workerPools=new Map}static isSupported(){return Wn.isSupported()}static getWorkerFarm(e={}){return wt._workerFarm=wt._workerFarm||new wt({}),wt._workerFarm.setProps(e),wt._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:n}=e;let i=this.workerPools.get(t);return i||(i=new Md({name:t,source:r,url:n}),i.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,i)),i}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};ee(wt,"_workerFarm");let fs=wt;const $n={};async function Ft(s,e=null,t={},r=null){return e&&(s=function(n,i,o={},u=null){if(!o.useLocalLibraries&&n.startsWith("http"))return n;u=u||n;const l=o.modules||{};return l[u]?l[u]:Ve?o.CDN?(lt(o.CDN.startsWith("http")),`${o.CDN}/${i}@${Cd}/dist/libs/${u}`):jn?`../src/libs/${u}`:`modules/${i}/src/libs/${u}`:`modules/${i}/dist/libs/${u}`}(s,e,t,r)),$n[s]=$n[s]||async function(n){if(n.endsWith("wasm"))return await async function(o){const{readFileAsArrayBuffer:u}=globalThis.loaders||{};return Ve||!u||o.startsWith("http")?await(await fetch(o)).arrayBuffer():await u(o)}(n);if(!Ve)try{const{requireFromFile:o}=globalThis.loaders||{};return await(o==null?void 0:o(n))}catch(o){return console.error(o),null}if(jn)return importScripts(n);const i=await async function(o){const{readFileAsText:u}=globalThis.loaders||{};return Ve||!u||o.startsWith("http")?await(await fetch(o)).text():await u(o)}(n);return function(o,u){if(!Ve){const{requireFromString:m}=globalThis.loaders||{};return m==null?void 0:m(o,u)}if(jn)return eval.call(globalThis,o),null;const l=document.createElement("script");l.id=u;try{l.appendChild(document.createTextNode(o))}catch{l.text=o}return document.body.appendChild(l),null}(i,n)}(s),await $n[s]}async function Rd(s,e,t,r,n){const i=s.id,o=function(b,d={}){const x=d[b.id]||{},g=Ve?`${b.id}-worker.js`:`${b.id}-worker-node.js`;let _=x.workerUrl;if(_||b.id!=="compression"||(_=d.workerUrl),d._workerType==="test"&&(_=Ve?`modules/${b.module}/dist/${g}`:`modules/${b.module}/src/workers/${b.id}-worker-node.ts`),!_){let w=b.version;w==="latest"&&(w="latest");const f=w?`@${w}`:"";_=`https://unpkg.com/@loaders.gl/${b.module}${f}/dist/${g}`}return lt(_),_}(s,t),u=fs.getWorkerFarm(t).getWorkerPool({name:i,url:o});t=JSON.parse(JSON.stringify(t)),r=JSON.parse(JSON.stringify(r||{}));const l=await u.startJob("process-on-worker",Gd.bind(null,n));return l.postMessage("process",{input:e,options:t,context:r}),await(await l.result).result}async function Gd(s,e,t,r){switch(t){case"done":e.done(r);break;case"error":e.error(new Error(r.error));break;case"process":const{id:n,input:i,options:o}=r;try{const u=await s(i,o);e.postMessage("done",{id:n,result:u})}catch(u){const l=u instanceof Error?u.message:"unknown error";e.postMessage("error",{id:n,error:l})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function Ra(s,e,t){if(s.byteLength<=e+t)return"";const r=new DataView(s);let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(r.getUint8(e+i));return n}function Ld(s){try{return JSON.parse(s)}catch{throw new Error(`Failed to parse JSON from data starting with "${function(t,r=5){return typeof t=="string"?t.slice(0,r):ArrayBuffer.isView(t)?Ra(t.buffer,t.byteOffset,r):t instanceof ArrayBuffer?Ra(t,0,r):""}(s)}"`)}}function Od(...s){return function(e){const t=e.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),r=t.reduce((o,u)=>o+u.byteLength,0),n=new Uint8Array(r);let i=0;for(const o of t)n.set(o,i),i+=o.byteLength;return n.buffer}(s)}function Ga(s,e,t){const r=t!==void 0?new Uint8Array(s).subarray(e,e+t):new Uint8Array(s).subarray(e);return new Uint8Array(r).buffer}function Tr(s,e){return ct(s>=0),ct(e>0),s+(e-1)&~(e-1)}function Id(s,e,t){let r;if(s instanceof ArrayBuffer)r=new Uint8Array(s);else{const n=s.byteOffset,i=s.byteLength;r=new Uint8Array(s.buffer||s.arrayBuffer,n,i)}return e.set(r,t),t+Tr(r.byteLength,4)}const La={};function Oa(s){if((e=s)&&typeof e=="object"&&e.isBuffer)return s;var e;if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){const t=s;return new TextEncoder().encode(t).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function Ia(s){const e=s?s.lastIndexOf("/"):-1;return e>=0?s.substr(e+1):""}const Sr=s=>typeof s=="function",Er=s=>s!==null&&typeof s=="object",Fa=s=>Er(s)&&s.constructor==={}.constructor,Dt=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json,Ut=s=>typeof Blob<"u"&&s instanceof Blob,Da=s=>(e=>typeof ReadableStream<"u"&&e instanceof ReadableStream||Er(e)&&Sr(e.tee)&&Sr(e.cancel)&&Sr(e.getReader))(s)||(e=>Er(e)&&Sr(e.read)&&Sr(e.pipe)&&(t=>typeof t=="boolean")(e.readable))(s);class Fd extends Error{constructor(t,r){super(t);ee(this,"reason");ee(this,"url");ee(this,"response");this.reason=r.reason,this.url=r.url,this.response=r.response}}const Dd=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Ud=/^([-\w.]+\/[-\w.+]+)/;function Ua(s,e){return s.toLowerCase()===e.toLowerCase()}function ka(s){const e=Dd.exec(s);return e?e[1]:""}const Na=/\?.*/;function qn(s){return s.replace(Na,"")}function ps(s){return Dt(s)?s.url:Ut(s)?s.name||"":typeof s=="string"?s:""}function Qn(s){if(Dt(s)){const e=s,t=e.headers.get("content-type")||"",r=qn(e.url);return function(n){const i=Ud.exec(n);return i?i[1]:n}(t)||ka(r)}return Ut(s)?s.type||"":typeof s=="string"?ka(s):""}async function Va(s){if(Dt(s))return s;const e={},t=function(u){return Dt(u)?u.headers["content-length"]||-1:Ut(u)?u.size:typeof u=="string"?u.length:u instanceof ArrayBuffer||ArrayBuffer.isView(u)?u.byteLength:-1}(s);t>=0&&(e["content-length"]=String(t));const r=ps(s),n=Qn(s);n&&(e["content-type"]=n);const i=await async function(u){if(typeof u=="string")return`data:,${u.slice(0,5)}`;if(u instanceof Blob){const m=u.slice(0,5);return await new Promise(b=>{const d=new FileReader;d.onload=x=>{var g;return b((g=x==null?void 0:x.target)==null?void 0:g.result)},d.readAsDataURL(m)})}return u instanceof ArrayBuffer?`data:base64,${function(m){let b="";const d=new Uint8Array(m);for(let x=0;x<d.byteLength;x++)b+=String.fromCharCode(d[x]);return btoa(b)}(u.slice(0,5))}`:null}(s);i&&(e["x-first-bytes"]=i),typeof s=="string"&&(s=new TextEncoder().encode(s));const o=new Response(s,{headers:e});return Object.defineProperty(o,"url",{value:r}),o}async function kd(s){if(!s.ok)throw await async function(t){const r=function(o){if(o.length<50)return o;const u=o.slice(o.length-15);return`${o.substr(0,32)}...${u}`}(t.url);let n=`Failed to fetch resource (${t.status}) ${t.statusText}: ${r}`;n=n.length>100?`${n.slice(0,100)}...`:n;const i={reason:t.statusText,url:t.url,response:t};try{const o=t.headers.get("Content-Type");i.reason=!t.bodyUsed&&(o!=null&&o.includes("application/json"))?await t.json():await t.text()}catch{}return new Fd(n,i)}(s)}async function Ha(s,e){var t,r;if(typeof s=="string"){const n=function(i){for(const o in La)if(i.startsWith(o)){const u=La[o];i=i.replace(o,u)}return i.startsWith("http://")||i.startsWith("https://")||(i=`${i}`),i}(s);return function(i){return!function(o){return o.startsWith("http:")||o.startsWith("https:")}(i)&&!function(o){return o.startsWith("data:")}(i)}(n)&&((t=globalThis.loaders)!=null&&t.fetchNode)?(r=globalThis.loaders)==null?void 0:r.fetchNode(n,e):await fetch(n,e)}return await Va(s)}const Ja=new Jn({id:"loaders.gl"});class Nd{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const za={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){ee(this,"console");this.console=console}log(...s){return this.console.log.bind(this.console,...s)}info(...s){return this.console.info.bind(this.console,...s)}warn(...s){return this.console.warn.bind(this.console,...s)}error(...s){return this.console.error.bind(this.console,...s)}},useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:ls,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},Vd={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function ja(){globalThis.loaders=globalThis.loaders||{};const{loaders:s}=globalThis;return s._state||(s._state={}),s._state}function Ka(){const s=ja();return s.globalOptions=s.globalOptions||{...za},s.globalOptions}function Hd(s,e,t,r){return t=t||[],function(n,i){Xa(n,null,za,Vd,i);for(const o of i){const u=n&&n[o.id]||{},l=o.options&&o.options[o.id]||{},m=o.deprecatedOptions&&o.deprecatedOptions[o.id]||{};Xa(u,o.id,l,m,i)}}(s,t=Array.isArray(t)?t:[t]),function(n,i,o){const u=n.options||{},l={...u};return function(m,b){b&&!("baseUri"in m)&&(m.baseUri=b)}(l,o),l.log===null&&(l.log=new Nd),Ya(l,Ka()),Ya(l,i),l}(e,s,r)}function Xa(s,e,t,r,n){const i=e||"Top level",o=e?`${e}.`:"";for(const u in s){const l=!e&&Er(s[u]);if(!(u in t)&&!(u==="baseUri"&&!e)&&!(u==="workerUrl"&&e)){if(u in r)Ja.warn(`${i} loader option '${o}${u}' no longer supported, use '${r[u]}'`)();else if(!l){const m=Jd(u,n);Ja.warn(`${i} loader option '${o}${u}' not recognized. ${m}`)()}}}}function Jd(s,e){const t=s.toLowerCase();let r="";for(const n of e)for(const i in n.options){if(s===i)return`Did you mean '${n.id}.${i}'?`;const o=i.toLowerCase();(t.startsWith(o)||o.startsWith(t))&&(r=r||`Did you mean '${n.id}.${i}'?`)}return r}function Ya(s,e){for(const t in e)if(t in e){const r=e[t];Fa(r)&&Fa(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function Zn(s){return s?(Array.isArray(s)&&(s=s[0]),Array.isArray(s==null?void 0:s.extensions)):!1}function Wa(s){let e;return ct(s,"null loader"),ct(Zn(s),"invalid loader"),Array.isArray(s)&&(e=s[1],s=s[0],s={...s,options:{...s.options,...e}}),(s!=null&&s.parseTextSync||s!=null&&s.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}function zd(){return(()=>{const s=ja();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry})()}const jd=/\.([^.]+)$/;function $a(s,e=[],t,r){if(!qa(s))return null;if(e&&!Array.isArray(e))return Wa(e);let n=[];e&&(n=n.concat(e)),t!=null&&t.ignoreRegisteredLoaders||n.push(...zd()),function(o){for(const u of o)Wa(u)}(n);const i=function(o,u,l,m){const b=ps(o),d=Qn(o),x=qn(b)||(m==null?void 0:m.url);let g=null,_="";return l!=null&&l.mimeType&&(g=ei(u,l==null?void 0:l.mimeType),_=`match forced by supplied MIME type ${l==null?void 0:l.mimeType}`),g=g||function(w,f){const p=f&&jd.exec(f),a=p&&p[1];return a?function(c,h){h=h.toLowerCase();for(const y of c)for(const A of y.extensions)if(A.toLowerCase()===h)return y;return null}(w,a):null}(u,x),_=_||(g?`matched url ${x}`:""),g=g||ei(u,d),_=_||(g?`matched MIME type ${d}`:""),g=g||function(w,f){if(!f)return null;for(const p of w)if(typeof f=="string"){if(Kd(f,p))return p}else if(ArrayBuffer.isView(f)){if(Za(f.buffer,f.byteOffset,p))return p}else if(f instanceof ArrayBuffer&&Za(f,0,p))return p;return null}(u,o),_=_||(g?`matched initial data ${eu(o)}`:""),l!=null&&l.fallbackMimeType&&(g=g||ei(u,l==null?void 0:l.fallbackMimeType),_=_||(g?`matched fallback MIME type ${d}`:"")),_&&vd.log(1,`selectLoader selected ${g==null?void 0:g.name}: ${_}.`),g}(s,n,t,r);if(!i&&!(t!=null&&t.nothrow))throw new Error(Qa(s));return i}function qa(s){return!(s instanceof Response&&s.status===204)}function Qa(s){const e=ps(s),t=Qn(s);let r="No valid loader found (";r+=e?`${Ia(e)}, `:"no url provided, ",r+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const n=s?eu(s):"";return r+=n?` first bytes: "${n}"`:"first bytes: not available",r+=")",r}function ei(s,e){var t;for(const r of s)if((t=r.mimeTypes)!=null&&t.some(n=>Ua(e,n))||Ua(e,`application/x.${r.id}`))return r;return null}function Kd(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(t=>s.startsWith(t))}function Za(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(r=>function(n,i,o,u){if(u instanceof ArrayBuffer)return function(l,m,b){if(b=b||l.byteLength,l.byteLength<b||m.byteLength<b)return!1;const d=new Uint8Array(l),x=new Uint8Array(m);for(let g=0;g<d.length;++g)if(d[g]!==x[g])return!1;return!0}(u,n,u.byteLength);switch(typeof u){case"function":return u(n);case"string":return u===ti(n,i,u.length);default:return!1}}(s,e,0,r))}function eu(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?ti(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?ti(s,0,e):""}function ti(s,e,t){if(s.byteLength<e+t)return"";const r=new DataView(s);let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(r.getUint8(e+i));return n}const Xd=262144;function tu(s,e){return ls?async function*(t,r){const n=t.getReader();let i;try{for(;;){const o=i||n.read();r!=null&&r._streamReadAhead&&(i=n.read());const{done:u,value:l}=await o;if(u)return;yield Oa(l)}}catch{n.releaseLock()}}(s,e):async function*(t){for await(const r of t)yield Oa(r)}(s)}function Yd(s,e){if(typeof s=="string")return function*(t,r){const n=(r==null?void 0:r.chunkSize)||262144;let i=0;const o=new TextEncoder;for(;i<t.length;){const u=Math.min(t.length-i,n),l=t.slice(i,i+u);i+=u,yield o.encode(l)}}(s,e);if(s instanceof ArrayBuffer)return function*(t,r={}){const{chunkSize:n=Xd}=r;let i=0;for(;i<t.byteLength;){const o=Math.min(t.byteLength-i,n),u=new ArrayBuffer(o),l=new Uint8Array(t,i,o);new Uint8Array(u).set(l),i+=o,yield u}}(s,e);if(Ut(s))return async function*(t,r){const n=(r==null?void 0:r.chunkSize)||1048576;let i=0;for(;i<t.size;){const o=i+n,u=await t.slice(i,o).arrayBuffer();i=o,yield u}}(s,e);if(Da(s))return tu(s,e);if(Dt(s))return tu(s.body,e);throw new Error("makeIterator")}const ru="Cannot convert supplied data type";async function Wd(s,e,t){const r=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||r)return function(i,o){if(o.text&&typeof i=="string")return i;var u;if((u=i)&&typeof u=="object"&&u.isBuffer&&(i=i.buffer),i instanceof ArrayBuffer){const l=i;return o.text&&!o.binary?new TextDecoder("utf8").decode(l):l}if(ArrayBuffer.isView(i)){if(o.text&&!o.binary)return new TextDecoder("utf8").decode(i);let l=i.buffer;const m=i.byteLength||i.length;return i.byteOffset===0&&m===l.byteLength||(l=l.slice(i.byteOffset,i.byteOffset+m)),l}throw new Error(ru)}(s,e);if(Ut(s)&&(s=await Va(s)),Dt(s)){const i=s;return await kd(i),e.binary?await i.arrayBuffer():await i.text()}if(Da(s)&&(s=Yd(s,t)),n=s,!!n&&typeof n[Symbol.iterator]=="function"||(i=>i&&typeof i[Symbol.asyncIterator]=="function")(s))return async function(i){const o=[];for await(const u of i)o.push(u);return Od(...o)}(s);var n;throw new Error(ru)}function su(s,e){const t=Ka(),r=s||t;return typeof r.fetch=="function"?r.fetch:Er(r.fetch)?n=>Ha(n,r.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:Ha}function $d(s,e,t){if(t)return t;const r={fetch:su(e,s),...s};if(r.url){const n=qn(r.url);r.baseUrl=n,r.queryString=function(i){const o=i.match(Na);return o&&o[0]}(r.url),r.filename=Ia(n),r.baseUrl=function(i){const o=i?i.lastIndexOf("/"):-1;return o>=0?i.substr(0,o):""}(n)}return Array.isArray(r.loaders)||(r.loaders=null),r}async function ri(s,e,t,r){!e||Array.isArray(e)||Zn(e)||(r=void 0,t=e,e=void 0),t=t||{};const n=ps(s=await s),i=function(u,l){if(u&&!Array.isArray(u))return u;let m;if(u&&(m=Array.isArray(u)?u:[u]),l&&l.loaders){const b=Array.isArray(l.loaders)?l.loaders:[l.loaders];m=m?[...m,...b]:b}return m&&m.length?m:void 0}(e,r),o=await async function(u,l=[],m,b){if(!qa(u))return null;let d=$a(u,l,{...m,nothrow:!0},b);if(d)return d;if(Ut(u)&&(d=$a(u=await u.slice(0,10).arrayBuffer(),l,m,b)),!d&&!(m!=null&&m.nothrow))throw new Error(Qa(u));return d}(s,i,t);return o?(r=$d({url:n,_parse:ri,loaders:i},t=Hd(t,o,i,n),r||null),await async function(u,l,m,b){if(function(x){lt(x,"no worker provided");const g=x.version}(u),m=wd(u.options,m),Dt(l)){const x=l,{ok:g,redirected:_,status:w,statusText:f,type:p,url:a}=x,c=Object.fromEntries(x.headers.entries());b.response={headers:c,ok:g,redirected:_,status:w,statusText:f,type:p,url:a}}l=await Wd(l,u,m);const d=u;if(d.parseTextSync&&typeof l=="string")return d.parseTextSync(l,m,b);if(function(x,g){return!!fs.isSupported()&&!(!Ve&&!(g!=null&&g._nodeWorkers))&&x.worker&&(g==null?void 0:g.worker)}(u,m))return await Rd(u,l,m,b,ri);if(d.parseText&&typeof l=="string")return await d.parseText(l,m,b);if(d.parse)return await d.parse(l,m,b);throw lt(!d.parseSync),new Error(`${u.id} loader - no parser found and worker is disabled`)}(o,s,t,r)):null}function qd(s,e,t){const r=function(i){switch(i.constructor){case Int8Array:return"int8";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int16Array:return"int16";case Uint16Array:return"uint16";case Int32Array:return"int32";case Uint32Array:return"uint32";case Float32Array:return"float32";case Float64Array:return"float64";default:return"null"}}(e.value),n=t||function(i){const o={};return"byteOffset"in i&&(o.byteOffset=i.byteOffset.toString(10)),"byteStride"in i&&(o.byteStride=i.byteStride.toString(10)),"normalized"in i&&(o.normalized=i.normalized.toString()),o}(e);return{name:s,type:{type:"fixed-size-list",listSize:e.size,children:[{name:"value",type:r}]},nullable:!1,metadata:n}}const Qd=(jc=globalThis.loaders)==null?void 0:jc.parseImageNode,si=typeof Image<"u",ni=typeof ImageBitmap<"u",Zd=!!Qd,ii=!!ls||Zd;function eh(s){const e=function(t){return typeof ImageBitmap<"u"&&t instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&t instanceof Image?"image":t&&typeof t=="object"&&t.data&&t.width&&t.height?"data":null}(s);if(!e)throw new Error("Not an image");return e}function nu(s){switch(eh(s)){case"data":return s;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}const th=/^data:image\/svg\+xml/,rh=/\.svg((\?|#).*)?$/;function oi(s){return s&&(th.test(s)||rh.test(s))}function iu(s,e){if(oi(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function ou(s,e,t){const r=function(o,u){if(oi(u)){let l=new TextDecoder().decode(o);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(l=unescape(encodeURIComponent(l)))}catch(m){throw new Error(m.message)}return`data:image/svg+xml;base64,${btoa(l)}`}return iu(o,u)}(s,t),n=self.URL||self.webkitURL,i=typeof r!="string"&&n.createObjectURL(r);try{return await async function(o,u){const l=new Image;return l.src=o,u.image&&u.image.decode&&l.decode?(await l.decode(),l):await new Promise((m,b)=>{try{l.onload=()=>m(l),l.onerror=d=>{const x=d instanceof Error?d.message:"error";b(new Error(x))}}catch(d){b(d)}})}(i||r,e)}finally{i&&n.revokeObjectURL(i)}}const sh={};let au=!0;async function nh(s,e,t){let r;oi(t)?r=await ou(s,e,t):r=iu(s,t);const n=e&&e.imagebitmap;return await async function(i,o=null){if(!function(u){for(const l in u||sh)return!1;return!0}(o)&&au||(o=null),o)try{return await createImageBitmap(i,o)}catch(u){console.warn(u),au=!1}return await createImageBitmap(i)}(r,n)}function ih(s){return function(e,t,r=0){const n=(i=t,[...i].map(o=>o.charCodeAt(0)));var i;for(let o=0;o<n.length;++o)if(n[o]!==e[o+r])return!1;return!0}(s,"ftyp",4)&&96&s[8]?function(e){switch((t=e,r=8,n=12,String.fromCharCode(...t.slice(r,n))).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}var t,r,n}(s):null}const tt=!1,Mr=!0;function ai(s){const e=Pr(s);return function(t){const r=Pr(t);return r.byteLength>=24&&r.getUint32(0,tt)===2303741511?{mimeType:"image/png",width:r.getUint32(16,tt),height:r.getUint32(20,tt)}:null}(e)||function(t){const r=Pr(t);if(!(r.byteLength>=3&&r.getUint16(0,tt)===65496&&r.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:o}=function(){const l=new Set([65499,65476,65484,65501,65534]);for(let b=65504;b<65520;++b)l.add(b);return{tableMarkers:l,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}();let u=2;for(;u+9<r.byteLength;){const l=r.getUint16(u,tt);if(o.has(l))return{mimeType:"image/jpeg",height:r.getUint16(u+5,tt),width:r.getUint16(u+7,tt)};if(!i.has(l))return null;u+=2,u+=r.getUint16(u,tt)}return null}(e)||function(t){const r=Pr(t);return r.byteLength>=10&&r.getUint32(0,tt)===1195984440?{mimeType:"image/gif",width:r.getUint16(6,Mr),height:r.getUint16(8,Mr)}:null}(e)||function(t){const r=Pr(t);return r.byteLength>=14&&r.getUint16(0,tt)===16973&&r.getUint32(2,Mr)===r.byteLength?{mimeType:"image/bmp",width:r.getUint32(18,Mr),height:r.getUint32(22,Mr)}:null}(e)||function(t){const r=new Uint8Array(t instanceof DataView?t.buffer:t),n=ih(r);return n?{mimeType:n.mimeType,width:0,height:0}:null}(e)}function Pr(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}const oh={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:"4.3.2",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:async function(s,e,t){const r=((e=e||{}).image||{}).type||"auto",{url:n}=t||{};let i;switch(function(o){switch(o){case"auto":case"data":return function(){if(ni)return"imagebitmap";if(si)return"image";if(ii)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(u){switch(u){case"auto":return ni||si||ii;case"imagebitmap":return ni;case"image":return si;case"data":return ii;default:throw new Error(`@loaders.gl/images: image ${u} not supported in this environment`)}}(o),o}}(r)){case"imagebitmap":i=await nh(s,e,n);break;case"image":i=await ou(s,e,n);break;case"data":i=await async function(o){var m;const{mimeType:u}=ai(o)||{},l=(m=globalThis.loaders)==null?void 0:m.parseImageNode;return ct(l),await l(o,u)}(s);break;default:ct(!1)}return r==="data"&&(i=nu(i)),i},tests:[s=>!!ai(new DataView(s))],options:{image:{type:"auto",decode:!0}}},ui={};function ah(s){if(ui[s]===void 0){const e=ls?function(t){switch(t){case"image/avif":case"image/webp":return function(r){try{return document.createElement("canvas").toDataURL(r).indexOf(`data:${r}`)===0}catch{return!1}}(t);default:return!0}}(s):function(t){var o,u;const r=["image/png","image/jpeg","image/gif"],n=((o=globalThis.loaders)==null?void 0:o.imageFormatsNode)||r;return!!((u=globalThis.loaders)==null?void 0:u.parseImageNode)&&n.includes(t)}(s);ui[s]=e}return ui[s]}function Ee(s,e){if(!s)throw new Error(e||"assert failed: gltf")}const uu={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},cu={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},lu=["SCALAR","VEC2","VEC3","VEC4"],uh=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],ch=new Map(uh),lh={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},dh={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},hh={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function du(s){return lu[s-1]||lu[0]}function ms(s){const e=ch.get(s.constructor);if(!e)throw new Error("Illegal typed array");return e}function ci(s,e){const t=hh[s.componentType],r=lh[s.type],n=dh[s.componentType],i=s.count*r,o=s.count*r*n;return Ee(o>=0&&o<=e.byteLength),{ArrayType:t,length:i,byteLength:o,componentByteSize:cu[s.componentType],numberOfComponentsInElement:uu[s.type]}}class xe{constructor(e){ee(this,"gltf");ee(this,"sourceBuffers");ee(this,"byteLength");this.gltf={json:(e==null?void 0:e.json)||{asset:{version:"2.0",generator:"loaders.gl"},buffers:[],extensions:{},extensionsRequired:[],extensionsUsed:[]},buffers:(e==null?void 0:e.buffers)||[],images:(e==null?void 0:e.images)||[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}hasExtension(e){const t=this.getUsedExtensions().find(n=>n===e),r=this.getRequiredExtensions().find(n=>n===e);return typeof t=="string"||typeof r=="string"}getExtension(e){const t=this.getUsedExtensions().find(n=>n===e),r=this.json.extensions||{};return t?r[e]:null}getRequiredExtension(e){return this.getRequiredExtensions().find(r=>r===e)?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(e,t){return(e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if(typeof t=="object")return t;const r=this.json[e]&&this.json[e][t];if(!r)throw new Error(`glTF file error: Could not find ${e}[${t}]`);return r}getTypedArrayForBufferView(e){const t=(e=this.getBufferView(e)).buffer,r=this.gltf.buffers[t];Ee(r);const n=(e.byteOffset||0)+r.byteOffset;return new Uint8Array(r.arrayBuffer,n,e.byteLength)}getTypedArrayForAccessor(e){const t=this.getAccessor(e);return function(r,n,i){var a,c;const o=typeof i=="number"?(a=r.accessors)==null?void 0:a[i]:i;if(!o)throw new Error(`No gltf accessor ${JSON.stringify(i)}`);const u=(c=r.bufferViews)==null?void 0:c[o.bufferView||0];if(!u)throw new Error(`No gltf buffer view for accessor ${u}`);const{arrayBuffer:l,byteOffset:m}=n[u.buffer],b=(m||0)+(o.byteOffset||0)+(u.byteOffset||0),{ArrayType:d,length:x,componentByteSize:g,numberOfComponentsInElement:_}=ci(o,u),w=g*_,f=u.byteStride||w;if(u.byteStride===void 0||u.byteStride===w)return new d(l,b,x);const p=new d(x);for(let h=0;h<o.count;h++){const y=new d(l,b+h*f,_);p.set(y,h*_)}return p}(this.gltf.json,this.gltf.buffers,t)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),r=this.getBuffer(t.buffer).data,n=t.byteOffset||0;return new Uint8Array(r,n,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,r){return e.extensions=e.extensions||{},e.extensions[t]=r,this.registerUsedExtension(t),this}setObjectExtension(e,t,r){(e.extensions||{})[t]=r}removeObjectExtension(e,t){const r=(e==null?void 0:e.extensions)||{};if(r[t]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const n=this.json.extensionsRemoved;n.includes(t)||n.push(t)}delete r[t]}addExtension(e,t={}){return Ee(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e,t={}){return Ee(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find(t=>t===e)||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find(t=>t===e)||this.json.extensionsRequired.push(e)}removeExtension(e){var t;if((t=this.json.extensions)!=null&&t[e]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const r=this.json.extensionsRemoved;r.includes(e)||r.push(e)}this.json.extensions&&delete this.json.extensions[e],this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e)}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:r}=e;this.json.nodes=this.json.nodes||[];const n={mesh:t};return r&&(n.matrix=r),this.json.nodes.push(n),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:r,material:n,mode:i=4}=e,o={primitives:[{attributes:this._addAttributes(t),mode:i}]};if(r){const u=this._addIndices(r);o.primitives[0].indices=u}return Number.isFinite(n)&&(o.primitives[0].material=n),this.json.meshes=this.json.meshes||[],this.json.meshes.push(o),this.json.meshes.length-1}addPointCloud(e){const t={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(t),this.json.meshes.length-1}addImage(e,t){const r=ai(e),n=t||(r==null?void 0:r.mimeType),i={bufferView:this.addBufferView(e),mimeType:n};return this.json.images=this.json.images||[],this.json.images.push(i),this.json.images.length-1}addBufferView(e,t=0,r=this.byteLength){const n=e.byteLength;Ee(Number.isFinite(n)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const i={buffer:t,byteOffset:r,byteLength:n};return this.byteLength+=Tr(n,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(i),this.json.bufferViews.length-1}addAccessor(e,t){const r={bufferView:e,type:du(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(r),this.json.accessors.length-1}addBinaryBuffer(e,t={size:3}){const r=this.addBufferView(e);let n={min:t.min,max:t.max};n.min&&n.max||(n=this._getAccessorMinMax(e,t.size));const i={size:t.size,componentType:ms(e),count:Math.round(e.length/t.size),min:n.min,max:n.max};return this.addAccessor(r,Object.assign(i,t))}addTexture(e){const{imageIndex:t}=e,r={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(r),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var i,o;const e=this.byteLength,t=new ArrayBuffer(e),r=new Uint8Array(t);let n=0;for(const u of this.sourceBuffers||[])n=Id(u,r,n);(o=(i=this.json)==null?void 0:i.buffers)!=null&&o[0]?this.json.buffers[0].byteLength=e:this.json.buffers=[{byteLength:e}],this.gltf.binary=t,this.sourceBuffers=[t],this.gltf.buffers=[{arrayBuffer:t,byteOffset:0,byteLength:t.byteLength}]}_removeStringFromArray(e,t){let r=!0;for(;r;){const n=e.indexOf(t);n>-1?e.splice(n,1):r=!1}}_addAttributes(e={}){const t={};for(const r in e){const n=e[r],i=this._getGltfAttributeName(r),o=this.addBinaryBuffer(n.value,n);t[i]=o}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const r={min:null,max:null};if(e.length<t)return r;r.min=[],r.max=[];const n=e.subarray(0,t);for(const i of n)r.min.push(i),r.max.push(i);for(let i=t;i<e.length;i+=t)for(let o=0;o<t;o++)r.min[0+o]=Math.min(r.min[0+o],e[i+o]),r.max[0+o]=Math.max(r.max[0+o],e[i+o]);return r}}function hu(s){return(s%1+1)%1}const fu={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16,BOOLEAN:1,STRING:1,ENUM:1},fh={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:BigInt64Array,UINT64:BigUint64Array,FLOAT32:Float32Array,FLOAT64:Float64Array},pu={INT8:1,UINT8:1,INT16:2,UINT16:2,INT32:4,UINT32:4,INT64:8,UINT64:8,FLOAT32:4,FLOAT64:8};function li(s,e){return pu[e]*fu[s]}function gs(s,e,t,r){if(t!=="UINT8"&&t!=="UINT16"&&t!=="UINT32"&&t!=="UINT64")return null;const n=ys(s.getTypedArrayForBufferView(e),"SCALAR",t,r+1);return n instanceof BigInt64Array||n instanceof BigUint64Array?null:n}function ys(s,e,t,r=1){const n=fh[t],i=pu[t],o=r*fu[e],u=o*i;let l=s.buffer,m=s.byteOffset;return m%i!=0&&(l=new Uint8Array(l).slice(m,m+u).buffer,m=0),new n(l,m,o)}function di(s,e,t){var m,b,d,x,g;const r=`TEXCOORD_${e.texCoord||0}`,n=t.attributes[r],i=s.getTypedArrayForAccessor(n),o=s.gltf.json,u=e.index,l=(b=(m=o.textures)==null?void 0:m[u])==null?void 0:b.source;if(l!==void 0){const _=(x=(d=o.images)==null?void 0:d[l])==null?void 0:x.mimeType,w=(g=s.gltf.images)==null?void 0:g[l];if(w&&w.width!==void 0){const f=[];for(let p=0;p<i.length;p+=2){const a=ph(w,_,i,p,e.channels);f.push(a)}return f}}return[]}function mu(s,e,t,r,n){if(!(t!=null&&t.length))return;const i=[];for(const b of t){let d=r.findIndex(x=>x===b);d===-1&&(d=r.push(b)-1),i.push(d)}const o=new Uint32Array(i),u=s.gltf.buffers.push({arrayBuffer:o.buffer,byteOffset:o.byteOffset,byteLength:o.byteLength})-1,l=s.addBufferView(o,u,0),m=s.addAccessor(l,{size:1,componentType:ms(o),count:o.length});n.attributes[e]=m}function ph(s,e,t,r,n=[0]){const i={r:{offset:0,shift:0},g:{offset:1,shift:8},b:{offset:2,shift:16},a:{offset:3,shift:24}},o=t[r],u=t[r+1];let l=1;!e||e.indexOf("image/jpeg")===-1&&e.indexOf("image/png")===-1||(l=4);const m=function(d,x,g,_=1){const w=g.width,f=hu(d)*(w-1),p=Math.round(f),a=g.height,c=hu(x)*(a-1),h=Math.round(c),y=g.components?g.components:_;return(h*w+p)*y}(o,u,s,l);let b=0;for(const d of n){const x=typeof d=="number"?Object.values(i)[d]:i[d],g=m+x.offset,_=nu(s);if(_.data.length<=g)throw new Error(`${_.data.length} <= ${g}`);b|=_.data[g]<<x.shift}return b}function gu(s,e,t,r,n){const i=[];for(let o=0;o<e;o++){const u=t[o],l=t[o+1]-t[o];if(l+u>r)break;const m=u/n,b=l/n;i.push(s.slice(m,m+b))}return i}function yu(s,e,t){const r=[];for(let n=0;n<e;n++){const i=n*t;r.push(s.slice(i,i+t))}return r}function bu(s,e,t,r){if(t)throw new Error("Not implemented - arrayOffsets for strings is specified");if(r){const n=[],i=new TextDecoder("utf8");let o=0;for(let u=0;u<s;u++){const l=r[u+1]-r[u];if(l+o<=e.length){const m=e.subarray(o,l+o),b=i.decode(m);n.push(b),o+=l}}return n}return[]}const ur="EXT_mesh_features",mh=ur;function gh(s,e,t){var i,o,u;if(!((i=t==null?void 0:t.gltf)!=null&&i.loadBuffers))return;const r=(o=e.extensions)==null?void 0:o[ur],n=r==null?void 0:r.featureIds;if(n)for(const l of n){let m;if(l.attribute!==void 0){const b=`_FEATURE_ID_${l.attribute}`,d=e.attributes[b];m=s.getTypedArrayForAccessor(d)}else m=l.texture!==void 0&&((u=t==null?void 0:t.gltf)!=null&&u.loadImages)?di(s,l.texture,e):[];l.data=m}}function yh(s,e){var n;const t=(n=e.extensions)==null?void 0:n[ur];if(!t)return;const r=t.featureIds;r.forEach((i,o)=>{if(i.data){const{accessorKey:u,index:l}=function(x){const g="_FEATURE_ID_",_=Object.keys(x).filter(p=>p.indexOf(g)===0);let w=-1;for(const p of _){const a=Number(p.substring(g.length));a>w&&(w=a)}return w++,{accessorKey:`${g}${w}`,index:w}}(e.attributes),m=new Uint32Array(i.data);r[o]={featureCount:m.length,propertyTable:i.propertyTable,attribute:l},s.gltf.buffers.push({arrayBuffer:m.buffer,byteOffset:m.byteOffset,byteLength:m.byteLength});const b=s.addBufferView(m),d=s.addAccessor(b,{size:1,componentType:ms(m),count:m.length});e.attributes[u]=d}})}const bh=Object.freeze(Object.defineProperty({__proto__:null,createExtMeshFeatures:function(s,e,t,r){e.extensions||(e.extensions={});let n=e.extensions[ur];n||(n={featureIds:[]},e.extensions[ur]=n);const{featureIds:i}=n,o={featureCount:t.length,propertyTable:r,data:t};i.push(o),s.addObjectExtension(e,ur,n)},decode:async function(s,e){(function(t,r){const n=t.gltf.json;if(n.meshes)for(const i of n.meshes)for(const o of i.primitives)gh(t,o,r)})(new xe(s),e)},encode:function(s,e){const t=new xe(s);return function(r){const n=r.gltf.json.meshes;if(n)for(const i of n)for(const o of i.primitives)yh(r,o)}(t),t.createBinaryChunk(),t.gltf},name:mh},Symbol.toStringTag,{value:"Module"})),cr="EXT_structural_metadata",xh=cr;function _h(s,e){for(const t of s)if(t.class===e)return t;return null}function Ah(s,e,t,r){var o;if(!e)return;const n=(o=t.extensions)==null?void 0:o[cr],i=n==null?void 0:n.propertyTextures;if(i)for(const u of i)Bh(s,e[u],t,r)}function Bh(s,e,t,r){var i;if(!e.properties)return;r.dataAttributeNames||(r.dataAttributeNames=[]);const n=e.class;for(const o in e.properties){const u=`${n}_${o}`,l=(i=e.properties)==null?void 0:i[o];if(!l)continue;l.data||(l.data=[]);const m=l.data,b=di(s,l,t);b!==null&&(mu(s,u,b,m,t),l.data=m,r.dataAttributeNames.push(u))}}function vh(s,e,t){var i,o;const r=(i=e.classes)==null?void 0:i[t.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${t.class}`);const n=t.count;for(const u in r.properties){const l=r.properties[u],m=(o=t.properties)==null?void 0:o[u];if(m){const b=wh(s,e,l,n,m);m.data=b}}}function wh(s,e,t,r,n){let i=[];const o=n.values,u=s.getTypedArrayForBufferView(o),l=function(b,d,x,g){return d.array&&d.count===void 0&&x.arrayOffsets!==void 0?gs(b,x.arrayOffsets,x.arrayOffsetType||"UINT32",g):null}(s,t,n,r),m=function(b,d,x){return d.stringOffsets!==void 0?gs(b,d.stringOffsets,d.stringOffsetType||"UINT32",x):null}(s,n,r);switch(t.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":case"MAT2":case"MAT3":case"MAT4":i=function(b,d,x,g){const _=b.array,w=b.count,f=li(b.type,b.componentType),p=x.byteLength/f;let a;return a=b.componentType?ys(x,b.type,b.componentType,p):x,_?g?gu(a,d,g,x.length,f):w?yu(a,d,w):[]:a}(t,r,u,l);break;case"BOOLEAN":throw new Error(`Not implemented - classProperty.type=${t.type}`);case"STRING":i=bu(r,u,l,m);break;case"ENUM":i=function(b,d,x,g,_){var y;const w=d.enumType;if(!w)throw new Error("Incorrect data in the EXT_structural_metadata extension: classProperty.enumType is not set for type ENUM");const f=(y=b.enums)==null?void 0:y[w];if(!f)throw new Error(`Incorrect data in the EXT_structural_metadata extension: schema.enums does't contain ${w}`);const p=f.valueType||"UINT16",a=li(d.type,p),c=g.byteLength/a;let h=ys(g,d.type,p,c);if(h||(h=g),d.array){if(_)return function(C){const{valuesData:R,numberOfElements:U,arrayOffsets:k,valuesDataBytesLength:T,elementSize:S,enumEntry:P}=C,L=[];for(let F=0;F<U;F++){const O=k[F],H=k[F+1]-k[F];if(H+O>T)break;const K=hi(R,O/S,H/S,P);L.push(K)}return L}({valuesData:h,numberOfElements:x,arrayOffsets:_,valuesDataBytesLength:g.length,elementSize:a,enumEntry:f});const A=d.count;return A?function(C,R,U,k){const T=[];for(let S=0;S<R;S++){const P=hi(C,U*S,U,k);T.push(P)}return T}(h,x,A,f):[]}return hi(h,0,x,f)}(e,t,r,u,l);break;default:throw new Error(`Unknown classProperty type ${t.type}`)}return i}function hi(s,e,t,r){const n=[];for(let i=0;i<t;i++)if(s instanceof BigInt64Array||s instanceof BigUint64Array)n.push("");else{const o=Ch(r,s[e+i]);o?n.push(o.name):n.push("")}return n}function Ch(s,e){for(const t of s.values)if(t.value===e)return t;return null}function Th(s,e,t){for(const r in s.properties){const n=s.properties[r].data;if(n){const i=e.properties[r];if(i){const o=Sh(n,i,t);s.properties[r]=o}}}}function Sh(s,e,t){const r={values:0};if(e.type==="STRING"){const{stringData:n,stringOffsets:i}=function(o){const u=new TextEncoder,l=[];let m=0;for(const _ of o){const w=u.encode(_);m+=w.length,l.push(w)}const b=new Uint8Array(m),d=[];let x=0;for(const _ of l)b.set(_,x),d.push(x),x+=_.length;d.push(x);const g=new Uint32Array(d);return{stringData:b,stringOffsets:g}}(s);r.stringOffsets=fi(i,t),r.values=fi(n,t)}else if(e.type==="SCALAR"&&e.componentType){const n=function(i,o){const u=[];for(const m of i)u.push(Number(m));const l=Eh[o];if(!l)throw new Error("Illegal component type");return new l(u)}(s,e.componentType);r.values=fi(n,t)}return r}const Eh={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:Int32Array,UINT64:Uint32Array,FLOAT32:Float32Array,FLOAT64:Float64Array};function fi(s,e){return e.gltf.buffers.push({arrayBuffer:s.buffer,byteOffset:s.byteOffset,byteLength:s.byteLength}),e.addBufferView(s)}const Mh=Object.freeze(Object.defineProperty({__proto__:null,createExtStructuralMetadata:function(s,e,t="schemaClassId"){let r=s.getExtension(cr);r||(r=s.addExtension(cr)),r.schema=function(i,o,u){const l=u??{id:"schema_id"},m={properties:{}};for(const b of i){const d={type:b.elementType,componentType:b.componentType};m.properties[b.name]=d}return l.classes={},l.classes[o]=m,l}(e,t,r.schema);const n=function(i,o,u){var d;const l={class:o,count:0};let m=0;const b=(d=u.classes)==null?void 0:d[o];for(const x of i){if(m===0&&(m=x.values.length),m!==x.values.length&&x.values.length)throw new Error("Illegal values in attributes");(b==null?void 0:b.properties[x.name])&&(l.properties||(l.properties={}),l.properties[x.name]={values:0,data:x.values})}return l.count=m,l}(e,t,r.schema);return r.propertyTables||(r.propertyTables=[]),r.propertyTables.push(n)-1},decode:async function(s,e){(function(t,r){var i,o;if(!((i=r.gltf)!=null&&i.loadBuffers))return;const n=t.getExtension(cr);n&&((o=r.gltf)!=null&&o.loadImages&&function(u,l){const m=l.propertyTextures,b=u.gltf.json;if(m&&b.meshes)for(const d of b.meshes)for(const x of d.primitives)Ah(u,m,x,l)}(t,n),function(u,l){const m=l.schema;if(!m)return;const b=m.classes,d=l.propertyTables;if(b&&d)for(const x in b){const g=_h(d,x);g&&vh(u,m,g)}}(t,n))})(new xe(s),e)},encode:function(s,e){const t=new xe(s);return function(r){var i,o;const n=r.getExtension(cr);if(n&&n.propertyTables)for(const u of n.propertyTables){const l=u.class,m=(o=(i=n.schema)==null?void 0:i.classes)==null?void 0:o[l];u.properties&&m&&Th(u,m,r)}}(t),t.createBinaryChunk(),t.gltf},name:xh},Symbol.toStringTag,{value:"Module"})),xu="EXT_feature_metadata",Ph=xu;function Rh(s,e){for(const t in s){const r=s[t];if(r.class===e)return r}return null}function Gh(s,e){for(const t in s){const r=s[t];if(r.class===e)return r}return null}function Lh(s,e,t){var i,o;if(!t.class)return;const r=(i=e.classes)==null?void 0:i[t.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${t.class}`);const n=t.count;for(const u in r.properties){const l=r.properties[u],m=(o=t.properties)==null?void 0:o[u];if(m){const b=Ih(s,e,l,n,m);m.data=b}}}function Oh(s,e,t){var n;const r=e.class;for(const i in t.properties){const o=(n=e==null?void 0:e.properties)==null?void 0:n[i];if(o){const u=Fh(s,o,r);o.data=u}}}function Ih(s,e,t,r,n){let i=[];const o=n.bufferView,u=s.getTypedArrayForBufferView(o),l=function(b,d,x,g){return d.type==="ARRAY"&&d.componentCount===void 0&&x.arrayOffsetBufferView!==void 0?gs(b,x.arrayOffsetBufferView,x.offsetType||"UINT32",g):null}(s,t,n,r),m=function(b,d,x,g){return x.stringOffsetBufferView!==void 0?gs(b,x.stringOffsetBufferView,x.offsetType||"UINT32",g):null}(s,0,n,r);return t.type==="STRING"||t.componentType==="STRING"?i=bu(r,u,l,m):function(b){const d=["UINT8","INT16","UINT16","INT32","UINT32","INT64","UINT64","FLOAT32","FLOAT64"];return d.includes(b.type)||b.componentType!==void 0&&d.includes(b.componentType)}(t)&&(i=function(b,d,x,g){const _=b.type==="ARRAY",w=b.componentCount,f="SCALAR",p=b.componentType||b.type,a=li(f,p),c=x.byteLength/a,h=ys(x,f,p,c);return _?g?gu(h,d,g,x.length,a):w?yu(h,d,w):[]:h}(t,r,u,l)),i}function Fh(s,e,t){const r=s.gltf.json;if(!r.meshes)return[];const n=[];for(const i of r.meshes)for(const o of i.primitives)Dh(s,t,e,n,o);return n}function Dh(s,e,t,r,n){const i=di(s,{channels:t.channels,...t.texture},n);i&&mu(s,e,i,r,n)}const Uh=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e){(function(t,r){var i,o;if(!((i=r.gltf)!=null&&i.loadBuffers))return;const n=t.getExtension(xu);n&&((o=r.gltf)!=null&&o.loadImages&&function(u,l){const m=l.schema;if(!m)return;const b=m.classes,{featureTextures:d}=l;if(b&&d)for(const x in b){const g=b[x],_=Gh(d,x);_&&Oh(u,_,g)}}(t,n),function(u,l){const m=l.schema;if(!m)return;const b=m.classes,d=l.featureTables;if(b&&d)for(const x in b){const g=Rh(d,x);g&&Lh(u,m,g)}}(t,n))})(new xe(s),e)},name:Ph},Symbol.toStringTag,{value:"Module"})),kh="basis_transcoder.js",Nh="basis_transcoder.wasm",Vh="basis_encoder.js",Hh="basis_encoder.wasm";let _u,pi;async function Au(s){var r;var e;return e=s.modules,globalThis.loaders||(globalThis.loaders={}),(r=globalThis.loaders).modules||(r.modules={}),Object.assign(globalThis.loaders.modules,e),function(n){var o,u;return((u=(o=globalThis.loaders)==null?void 0:o.modules)==null?void 0:u[n])||null}("basis")||(_u||(_u=async function(n){let i=null,o=null;return[i,o]=await Promise.all([await Ft(kh,"textures",n),await Ft(Nh,"textures",n)]),i=i||globalThis.BASIS,await function(u,l){const m={};return l&&(m.wasmBinary=l),new Promise(b=>{u(m).then(d=>{const{BasisFile:x,initializeBasis:g}=d;g(),b({BasisFile:x})})})}(i,o)}(s)),await _u)}async function Bu(s){const e=s.modules||{};return e.basisEncoder?e.basisEncoder:(pi=pi||async function(t){let r=null,n=null;return[r,n]=await Promise.all([await Ft(Vh,"textures",t),await Ft(Hh,"textures",t)]),r=r||globalThis.BASIS,await function(i,o){const u={};return o&&(u.wasmBinary=o),new Promise(l=>{i(u).then(m=>{const{BasisFile:b,KTX2File:d,initializeBasis:x,BasisEncoder:g}=m;x(),l({BasisFile:b,KTX2File:d,BasisEncoder:g})})})}(r,n)}(s),await pi)}const Jh=["","WEBKIT_","MOZ_"],vu={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let bs=null;function zh(s){if(!bs){s=s||function(){try{return document.createElement("canvas").getContext("webgl")}catch{return null}}()||void 0,bs=new Set;for(const e of Jh)for(const t in vu)if(s&&s.getExtension(`${e}${t}`)){const r=vu[t];bs.add(r)}}return bs}const Me=[171,75,84,88,32,50,48,187,13,10,26,10],jh={etc1:{basisFormat:0,compressed:!0,format:36196},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:33776},bc3:{basisFormat:3,compressed:!0,format:33779},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:35840},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:35842},"astc-4x4":{basisFormat:10,compressed:!0,format:37808},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};function mi(s,e,t){const r=new s(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("Failed to start basis transcoding");const n=r.getNumImages(),i=[];for(let o=0;o<n;o++){const u=r.getNumLevels(o),l=[];for(let m=0;m<u;m++)l.push(Kh(r,o,m,t));i.push(l)}return i}finally{r.close(),r.delete()}}function Kh(s,e,t,r){const n=s.getImageWidth(e,t),i=s.getImageHeight(e,t),o=s.getHasAlpha(),{compressed:u,format:l,basisFormat:m}=Cu(r,o),b=s.getImageTranscodedSizeInBytes(e,t,m),d=new Uint8Array(b);if(!s.transcodeImage(d,e,t,m,0,0))throw new Error("failed to start Basis transcoding");return{width:n,height:i,data:d,compressed:u,format:l,hasAlpha:o}}function wu(s,e,t){const r=new s(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("failed to start KTX2 transcoding");const n=r.getLevels(),i=[];for(let o=0;o<n;o++)i.push(Xh(r,o,t));return[i]}finally{r.close(),r.delete()}}function Xh(s,e,t){const{alphaFlag:r,height:n,width:i}=s.getImageLevelInfo(e,0,0),{compressed:o,format:u,basisFormat:l}=Cu(t,r),m=s.getImageTranscodedSizeInBytes(e,0,0,l),b=new Uint8Array(m);if(!s.transcodeImage(b,e,0,0,l,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:i,height:n,data:b,compressed:o,levelSize:m,hasAlpha:r,format:u}}function Cu(s,e){let t=s&&s.basis&&s.basis.format;return t==="auto"&&(t=Tu()),typeof t=="object"&&(t=e?t.alpha:t.noAlpha),t=t.toLowerCase(),jh[t]}function Tu(){const s=zh();return s.has("astc")?"astc-4x4":s.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:s.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:s.has("etc1")?"etc1":s.has("etc2")?"etc2":"rgb565"}const Yh={dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:"4.3.2",worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}},parse:async function(s,e){if(e.basis.containerFormat==="auto"){if(function(r){const n=new Uint8Array(r);return!(n.byteLength<Me.length||n[0]!==Me[0]||n[1]!==Me[1]||n[2]!==Me[2]||n[3]!==Me[3]||n[4]!==Me[4]||n[5]!==Me[5]||n[6]!==Me[6]||n[7]!==Me[7]||n[8]!==Me[8]||n[9]!==Me[9]||n[10]!==Me[10]||n[11]!==Me[11])}(s))return wu((await Bu(e)).KTX2File,s,e);const{BasisFile:t}=await Au(e);return mi(t,s,e)}if(e.basis.module==="encoder"){const t=await Bu(e);return e.basis.containerFormat==="ktx2"?wu(t.KTX2File,s,e):mi(t.BasisFile,s,e)}{const{BasisFile:t}=await Au(e);return mi(t,s,e)}}},lr=!0,Su=1735152710,Wh=1313821514,$h=5130562;function qh(s,e,t=0,r={}){const n=new DataView(e),i=function(l,m=0){return`${String.fromCharCode(l.getUint8(m+0))}${String.fromCharCode(l.getUint8(m+1))}${String.fromCharCode(l.getUint8(m+2))}${String.fromCharCode(l.getUint8(m+3))}`}(n,t+0),o=n.getUint32(t+4,lr),u=n.getUint32(t+8,lr);switch(Object.assign(s,{header:{byteOffset:t,byteLength:u,hasBinChunk:!1},type:i,version:o,json:{},binChunks:[]}),t+=12,s.version){case 1:return function(l,m,b){ct(l.header.byteLength>20);const d=m.getUint32(b+0,lr),x=m.getUint32(b+4,lr);return b+=8,ct(x===0),gi(l,m,b,d),b+=d,b+=yi(l,m,b,l.header.byteLength),b}(s,n,t);case 2:return function(l,m,b,d){return ct(l.header.byteLength>20),function(x,g,_,w){for(;_+8<=x.header.byteLength;){const f=g.getUint32(_+0,lr),p=g.getUint32(_+4,lr);switch(_+=8,p){case Wh:gi(x,g,_,f);break;case $h:yi(x,g,_,f);break;case 0:w.strict||gi(x,g,_,f);break;case 1:w.strict||yi(x,g,_,f)}_+=Tr(f,4)}}(l,m,b,d),b+l.header.byteLength}(s,n,t,{});default:throw new Error(`Invalid GLB version ${s.version}. Only supports version 1 and 2.`)}}function gi(s,e,t,r){const n=new Uint8Array(e.buffer,t,r),i=new TextDecoder("utf8").decode(n);return s.json=JSON.parse(i),Tr(r,4)}function yi(s,e,t,r){return s.header.hasBinChunk=!0,s.binChunks.push({byteOffset:t,byteLength:r,arrayBuffer:e.buffer}),Tr(r,4)}function Eu(s,e){if(s.startsWith("data:")||s.startsWith("http:")||s.startsWith("https:"))return s;const t=e.baseUri||e.uri;if(!t)throw new Error(`'baseUri' must be provided to resolve relative url ${s}`);return t.substr(0,t.lastIndexOf("/")+1)+s}const Qh="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",Zh="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",ef=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),tf=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),rf={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},sf={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function nf(s,e,t,r,n,i="NONE"){const o=await async function(){return bi||(bi=async function(){let u=Qh;WebAssembly.validate(ef)&&(u=Zh,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const l=await WebAssembly.instantiate(function(m){const b=new Uint8Array(m.length);for(let x=0;x<m.length;++x){const g=m.charCodeAt(x);b[x]=g>96?g-71:g>64?g-65:g>47?g+4:g>46?63:62}let d=0;for(let x=0;x<m.length;++x)b[d++]=b[x]<60?tf[b[x]]:64*(b[x]-60)+b[++x];return b.buffer.slice(0,d)}(u),{});return await l.instance.exports.__wasm_call_ctors(),l.instance}()),bi}();(function(u,l,m,b,d,x,g){const _=u.exports.sbrk,w=b+3&-4,f=_(w*d),p=_(x.length),a=new Uint8Array(u.exports.memory.buffer);a.set(x,p);const c=l(f,b,d,p,x.length);if(c===0&&g&&g(f,w,d),m.set(a.subarray(f,f+b*d)),_(f-_(0)),c!==0)throw new Error(`Malformed buffer data: ${c}`)})(o,o.exports[sf[n]],s,e,t,r,o.exports[rf[i||"NONE"]])}let bi;const xs="EXT_meshopt_compression",of=xs;async function af(s,e){const t=s.getObjectExtension(e,xs);if(t){const{byteOffset:r=0,byteLength:n=0,byteStride:i,count:o,mode:u,filter:l="NONE",buffer:m}=t,b=s.gltf.buffers[m],d=new Uint8Array(b.arrayBuffer,b.byteOffset+r,n),x=new Uint8Array(s.gltf.buffers[e.buffer].arrayBuffer,e.byteOffset,e.byteLength);await nf(x,o,i,d,u,l),s.removeObjectExtension(e,xs)}}const uf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e){var n,i;const t=new xe(s);if(!((n=e==null?void 0:e.gltf)!=null&&n.decompressMeshes)||!((i=e.gltf)!=null&&i.loadBuffers))return;const r=[];for(const o of s.json.bufferViews||[])r.push(af(t,o));await Promise.all(r),t.removeExtension(xs)},name:of},Symbol.toStringTag,{value:"Module"})),dr="EXT_texture_webp",cf=Object.freeze(Object.defineProperty({__proto__:null,name:dr,preprocess:function(s,e){const t=new xe(s);if(!ah("image/webp")){if(t.getRequiredExtensions().includes(dr))throw new Error(`gltf: Required extension ${dr} not supported by browser`);return}const{json:r}=t;for(const n of r.textures||[]){const i=t.getObjectExtension(n,dr);i&&(n.source=i.source),t.removeObjectExtension(n,dr)}t.removeExtension(dr)}},Symbol.toStringTag,{value:"Module"})),_s="KHR_texture_basisu",lf=Object.freeze(Object.defineProperty({__proto__:null,name:_s,preprocess:function(s,e){const t=new xe(s),{json:r}=t;for(const n of r.textures||[]){const i=t.getObjectExtension(n,_s);i&&(n.source=i.source,t.removeObjectExtension(n,_s))}t.removeExtension(_s)}},Symbol.toStringTag,{value:"Module"})),df={dataType:null,batchType:null,name:"Draco",id:"draco",module:"draco",version:"4.3.2",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:typeof WebAssembly=="object"?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};function Mu(s,e,t){return qd(s,e,t?Pu(t.metadata):void 0)}function Pu(s){Object.entries(s);const e={};for(const t in s)e[`${t}.string`]=JSON.stringify(s[t]);return e}const Ru={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},hf={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array};class ff{constructor(e){ee(this,"draco");ee(this,"decoder");ee(this,"metadataQuerier");this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,t={}){const r=new this.draco.DecoderBuffer;r.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const n=this.decoder.GetEncodedGeometryType(r),i=n===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let o;switch(n){case this.draco.TRIANGULAR_MESH:o=this.decoder.DecodeBufferToMesh(r,i);break;case this.draco.POINT_CLOUD:o=this.decoder.DecodeBufferToPointCloud(r,i);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!o.ok()||!i.ptr){const d=`DRACO decompression failed: ${o.error_msg()}`;throw new Error(d)}const u=this._getDracoLoaderData(i,n,t),l=this._getMeshData(i,u,t),m=function(d){let x=1/0,g=1/0,_=1/0,w=-1/0,f=-1/0,p=-1/0;const a=d.POSITION?d.POSITION.value:[],c=a&&a.length;for(let h=0;h<c;h+=3){const y=a[h],A=a[h+1],C=a[h+2];x=y<x?y:x,g=A<g?A:g,_=C<_?C:_,w=y>w?y:w,f=A>f?A:f,p=C>p?C:p}return[[x,g,_],[w,f,p]]}(l.attributes),b=function(d,x,g){const _=Pu(x.metadata),w=[],f=function(p){const a={};for(const c in p){const h=p[c];a[h.name||"undefined"]=h}return a}(x.attributes);for(const p in d){const a=Mu(p,d[p],f[p]);w.push(a)}if(g){const p=Mu("indices",g);w.push(p)}return{fields:w,metadata:_}}(l.attributes,u,l.indices);return{loader:"draco",loaderData:u,header:{vertexCount:i.num_points(),boundingBox:m},...l,schema:b}}finally{this.draco.destroy(r),i&&this.draco.destroy(i)}}_getDracoLoaderData(e,t,r){const n=this._getTopLevelMetadata(e),i=this._getDracoAttributes(e,r);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:n,attributes:i}}_getDracoAttributes(e,t){const r={};for(let n=0;n<e.num_attributes();n++){const i=this.decoder.GetAttribute(e,n),o=this._getAttributeMetadata(e,n);r[i.unique_id()]={unique_id:i.unique_id(),attribute_type:i.attribute_type(),data_type:i.data_type(),num_components:i.num_components(),byte_offset:i.byte_offset(),byte_stride:i.byte_stride(),normalized:i.normalized(),attribute_index:n,metadata:o};const u=this._getQuantizationTransform(i,t);u&&(r[i.unique_id()].quantization_transform=u);const l=this._getOctahedronTransform(i,t);l&&(r[i.unique_id()].octahedron_transform=l)}return r}_getMeshData(e,t,r){const n=this._getMeshAttributes(t,e,r);if(!n.POSITION)throw new Error("DRACO: No position attribute found.");return e instanceof this.draco.Mesh?r.topology==="triangle-strip"?{topology:"triangle-strip",mode:4,attributes:n,indices:{value:this._getTriangleStripIndices(e),size:1}}:{topology:"triangle-list",mode:5,attributes:n,indices:{value:this._getTriangleListIndices(e),size:1}}:{topology:"point-list",mode:0,attributes:n}}_getMeshAttributes(e,t,r){const n={};for(const i of Object.values(e.attributes)){const o=this._deduceAttributeName(i,r);i.name=o;const u=this._getAttributeValues(t,i);if(u){const{value:l,size:m}=u;n[o]={value:l,size:m,byteOffset:i.byte_offset,byteStride:i.byte_stride,normalized:i.normalized}}}return n}_getTriangleListIndices(e){const t=3*e.num_faces(),r=4*t,n=this.draco._malloc(r);try{return this.decoder.GetTrianglesUInt32Array(e,r,n),new Uint32Array(this.draco.HEAPF32.buffer,n,t).slice()}finally{this.draco._free(n)}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),function(r){const n=r.size(),i=new Int32Array(n);for(let o=0;o<n;o++)i[o]=r.GetValue(o);return i}(t)}finally{this.draco.destroy(t)}}_getAttributeValues(e,t){const r=hf[t.data_type];if(!r)return console.warn(`DRACO: Unsupported attribute type ${t.data_type}`),null;const n=t.num_components,i=e.num_points()*n,o=i*r.BYTES_PER_ELEMENT,u=function(b,d){switch(d){case Float32Array:return b.DT_FLOAT32;case Int8Array:return b.DT_INT8;case Int16Array:return b.DT_INT16;case Int32Array:return b.DT_INT32;case Uint8Array:return b.DT_UINT8;case Uint16Array:return b.DT_UINT16;case Uint32Array:return b.DT_UINT32;default:return b.DT_INVALID}}(this.draco,r);let l;const m=this.draco._malloc(o);try{const b=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,b,u,o,m),l=new r(this.draco.HEAPF32.buffer,m,i).slice()}finally{this.draco._free(m)}return{value:l,size:n}}_deduceAttributeName(e,t){const r=e.unique_id;for(const[o,u]of Object.entries(t.extraAttributes||{}))if(u===r)return o;const n=e.attribute_type;for(const o in Ru)if(this.draco[o]===n)return Ru[o];const i=t.attributeNameEntry||"name";return e.metadata[i]?e.metadata[i].string:`CUSTOM_ATTRIBUTE_${r}`}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const r=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(r)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const t={},r=this.metadataQuerier.NumEntries(e);for(let n=0;n<r;n++){const i=this.metadataQuerier.GetEntryName(e,n);t[i]=this._getDracoMetadataField(e,i)}return t}_getDracoMetadataField(e,t){const r=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,r);const n=function(i){const o=i.size(),u=new Int32Array(o);for(let l=0;l<o;l++)u[l]=i.GetValue(l);return u}(r);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:n}}finally{this.draco.destroy(r)}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:r=[]}=e,n=[...t,...r];for(const i of n)this.decoder.SkipAttributeTransform(this.draco[i])}_getQuantizationTransform(e,t){const{quantizedAttributes:r=[]}=t,n=e.attribute_type();if(r.map(i=>this.decoder[i]).includes(n)){const i=new this.draco.AttributeQuantizationTransform;try{if(i.InitFromAttribute(e))return{quantization_bits:i.quantization_bits(),range:i.range(),min_values:new Float32Array([1,2,3]).map(o=>i.min_value(o))}}finally{this.draco.destroy(i)}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:r=[]}=t,n=e.attribute_type();if(r.map(i=>this.decoder[i]).includes(n)){const i=new this.draco.AttributeQuantizationTransform;try{if(i.InitFromAttribute(e))return{quantization_bits:i.quantization_bits()}}finally{this.draco.destroy(i)}}return null}}const xi="https://www.gstatic.com/draco/versioned/decoders/1.5.6",As="draco_wasm_wrapper.js",Bs="draco_decoder.wasm",vs="draco_decoder.js",Gu="draco_encoder.js",_i={[As]:`${xi}/${As}`,[Bs]:`${xi}/${Bs}`,[vs]:`${xi}/${vs}`,[Gu]:`https://raw.githubusercontent.com/google/draco/1.4.1/javascript/${Gu}`};let Ai;async function pf(s){const e=s.modules||{};return e.draco3d?Ai||(Ai=e.draco3d.createDecoderModule({}).then(t=>({draco:t}))):Ai||(Ai=async function(t){let r,n;return(t.draco&&t.draco.decoderType)==="js"?r=await Ft(_i[vs],"draco",t,vs):[r,n]=await Promise.all([await Ft(_i[As],"draco",t,As),await Ft(_i[Bs],"draco",t,Bs)]),r=r||globalThis.DracoDecoderModule,await function(i,o){const u={};return o&&(u.wasmBinary=o),new Promise(l=>{i({...u,onModuleLoaded:m=>l({draco:m})})})}(r,n)}(s)),await Ai}const mf={...df,parse:async function(s,e){const{draco:t}=await pf(e),r=new ff(t);try{return r.parseSync(s,e==null?void 0:e.draco)}finally{r.destroy()}}};function Lu(s){const{buffer:e,size:t,count:r}=function(n){let i=n,o=1,u=0;return n&&n.value&&(i=n.value,o=n.size||1),i&&(ArrayBuffer.isView(i)||(i=function(l,m,b=!1){return l?Array.isArray(l)?new m(l):b&&!(l instanceof m)?new m(l):l:null}(i,Float32Array)),u=i.length/o),{buffer:i,size:o,count:u}}(s);return{value:e,size:t,byteOffset:0,count:r,type:du(t),componentType:ms(e)}}const kt="KHR_draco_mesh_compression",gf=kt;async function yf(s,e,t,r){const n=s.getObjectExtension(e,kt);if(!n)return;const i=s.getTypedArrayForBufferView(n.bufferView),o=Ga(i.buffer,i.byteOffset),u={...t};delete u["3d-tiles"];const l=await ba(o,mf,u,r),m=function(b){const d={};for(const x in b){const g=b[x];if(x!=="indices"){const _=Lu(g);d[x]=_}}return d}(l.attributes);for(const[b,d]of Object.entries(m))if(b in e.attributes){const x=e.attributes[b],g=s.getAccessor(x);g!=null&&g.min&&(g!=null&&g.max)&&(d.min=g.min,d.max=g.max)}e.attributes=m,l.indices&&(e.indices=Lu(l.indices)),s.removeObjectExtension(e,kt),function(b){if(!b.attributes&&Object.keys(b.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}(e)}function bf(s,e,t=4,r,n){if(!r.DracoWriter)throw new Error("options.gltf.DracoWriter not provided")}function*Ou(s){for(const e of s.json.meshes||[])for(const t of e.primitives)yield t}const xf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e,t){var i;if(!((i=e==null?void 0:e.gltf)!=null&&i.decompressMeshes))return;const r=new xe(s),n=[];for(const o of Ou(r))r.getObjectExtension(o,kt)&&n.push(yf(r,o,e,t));await Promise.all(n),r.removeExtension(kt)},encode:function(s,e={}){const t=new xe(s);for(const r of t.json.meshes||[])bf(),t.addRequiredExtension(kt)},name:gf,preprocess:function(s,e,t){const r=new xe(s);for(const n of Ou(r))r.getObjectExtension(n,kt)}},Symbol.toStringTag,{value:"Module"}));globalThis.mathgl=globalThis.mathgl||{config:{EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1}};const He=globalThis.mathgl.config;function _f(s,{precision:e=He.precision}={}){return s=function(t){return Math.round(t/He.EPSILON)*He.EPSILON}(s),`${parseFloat(s.toPrecision(e))}`}function ws(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Iu(s,e,t){const r=He.EPSILON;try{if(s===e)return!0;if(ws(s)&&ws(e)){if(s.length!==e.length)return!1;for(let n=0;n<s.length;++n)if(!Iu(s[n],e[n]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"&&Math.abs(s-e)<=He.EPSILON*Math.max(1,Math.abs(s),Math.abs(e))}finally{He.EPSILON=r}}class Fu extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=e[r+t];return this.check()}toArray(e=[],t=0){for(let r=0;r<this.ELEMENTS;++r)e[t+r]=this[r];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:ws(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(He)}formatString(e){let t="";for(let r=0;r<this.ELEMENTS;++r)t+=(r>0?", ":"")+_f(this[r],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!Iu(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,r){if(r===void 0)return this.lerp(this,e,t);for(let n=0;n<this.ELEMENTS;++n){const i=e[n],o=typeof t=="number"?t:t[n];this[n]=i+r*(o-i)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),t[r]);return this.check()}add(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]+=t[r];return this.check()}subtract(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]-=t[r];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(He.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),t);return this.check()}get elements(){return this}}function Pe(s){if(!Number.isFinite(s))throw new Error(`Invalid number ${JSON.stringify(s)}`);return s}function Af(s,e,t=""){if(He.debug&&!function(r,n){if(r.length!==n)return!1;for(let i=0;i<r.length;++i)if(!Number.isFinite(r[i]))return!1;return!0}(s,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return s}function Du(s,e){if(!s)throw new Error(`math.gl assertion ${e}`)}class Bf extends Fu{get x(){return this[0]}set x(e){this[0]=Pe(e)}get y(){return this[1]}set y(e){this[1]=Pe(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let r=0;r<this.ELEMENTS;++r){const n=this[r]-e[r];t+=n*n}return Pe(t)}dot(e){let t=0;for(let r=0;r<this.ELEMENTS;++r)t+=this[r]*e[r];return Pe(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]*=t[r];return this.check()}divide(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]/=t[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Du(e>=0&&e<this.ELEMENTS,"index is out of range"),Pe(this[e])}setComponent(e,t){return Du(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}let Cs=typeof Float32Array<"u"?Float32Array:Array;function Uu(s,e,t){const r=e[0],n=e[1],i=e[2];return s[0]=r*t[0]+n*t[3]+i*t[6],s[1]=r*t[1]+n*t[4]+i*t[7],s[2]=r*t[2]+n*t[5]+i*t[8],s}(function(){const s=function(){const e=new Cs(2);return Cs!=Float32Array&&(e[0]=0,e[1]=0),e}()})(),function(){const s=function(){const e=new Cs(3);return Cs!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}()}();const Bi=[0,0,0];let Ts;class vi extends Bf{static get ZERO(){return Ts||(Ts=new vi(0,0,0),Object.freeze(Ts)),Ts}constructor(e=0,t=0,r=0){super(-0,-0,-0),arguments.length===1&&ws(e)?this.copy(e):(He.debug&&(Pe(e),Pe(t),Pe(r)),this[0]=e,this[1]=t,this[2]=r)}set(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return He.debug&&(Pe(e.x),Pe(e.y),Pe(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Pe(e)}angle(e){return function(t,r){const n=t[0],i=t[1],o=t[2],u=r[0],l=r[1],m=r[2],b=Math.sqrt((n*n+i*i+o*o)*(u*u+l*l+m*m)),d=b&&function(x,g){return x[0]*g[0]+x[1]*g[1]+x[2]*g[2]}(t,r)/b;return Math.acos(Math.min(Math.max(d,-1),1))}(this,e)}cross(e){return function(t,r,n){const i=r[0],o=r[1],u=r[2],l=n[0],m=n[1],b=n[2];t[0]=o*b-u*m,t[1]=u*l-i*b,t[2]=i*m-o*l}(this,this,e),this.check()}rotateX({radians:e,origin:t=Bi}){return function(r,n,i,o){const u=[],l=[];u[0]=n[0]-i[0],u[1]=n[1]-i[1],u[2]=n[2]-i[2],l[0]=u[0],l[1]=u[1]*Math.cos(o)-u[2]*Math.sin(o),l[2]=u[1]*Math.sin(o)+u[2]*Math.cos(o),r[0]=l[0]+i[0],r[1]=l[1]+i[1],r[2]=l[2]+i[2]}(this,this,t,e),this.check()}rotateY({radians:e,origin:t=Bi}){return function(r,n,i,o){const u=[],l=[];u[0]=n[0]-i[0],u[1]=n[1]-i[1],u[2]=n[2]-i[2],l[0]=u[2]*Math.sin(o)+u[0]*Math.cos(o),l[1]=u[1],l[2]=u[2]*Math.cos(o)-u[0]*Math.sin(o),r[0]=l[0]+i[0],r[1]=l[1]+i[1],r[2]=l[2]+i[2]}(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=Bi}){return function(r,n,i,o){const u=[],l=[];u[0]=n[0]-i[0],u[1]=n[1]-i[1],u[2]=n[2]-i[2],l[0]=u[0]*Math.cos(o)-u[1]*Math.sin(o),l[1]=u[0]*Math.sin(o)+u[1]*Math.cos(o),l[2]=u[2],r[0]=l[0]+i[0],r[1]=l[1]+i[1],r[2]=l[2]+i[2]}(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return function(t,r,n){const i=r[0],o=r[1],u=r[2];let l=n[3]*i+n[7]*o+n[11]*u+n[15];l=l||1,t[0]=(n[0]*i+n[4]*o+n[8]*u+n[12])/l,t[1]=(n[1]*i+n[5]*o+n[9]*u+n[13])/l,t[2]=(n[2]*i+n[6]*o+n[10]*u+n[14])/l}(this,this,e),this.check()}transformAsVector(e){return function(t,r,n){const i=r[0],o=r[1],u=r[2],l=n[3]*i+n[7]*o+n[11]*u||1;t[0]=(n[0]*i+n[4]*o+n[8]*u)/l,t[1]=(n[1]*i+n[5]*o+n[9]*u)/l,t[2]=(n[2]*i+n[6]*o+n[10]*u)/l}(this,this,e),this.check()}transformByMatrix3(e){return Uu(this,this,e),this.check()}transformByMatrix2(e){return function(t,r,n){const i=r[0],o=r[1];t[0]=n[0]*i+n[2]*o,t[1]=n[1]*i+n[3]*o,t[2]=r[2]}(this,this,e),this.check()}transformByQuaternion(e){return function(t,r,n){const i=n[0],o=n[1],u=n[2],l=n[3],m=r[0],b=r[1],d=r[2];let x=o*d-u*b,g=u*m-i*d,_=i*b-o*m,w=o*_-u*g,f=u*x-i*_,p=i*g-o*x;const a=2*l;x*=a,g*=a,_*=a,w*=2,f*=2,p*=2,t[0]=m+x+w,t[1]=b+g+f,t[2]=d+_+p}(this,this,e),this.check()}}class vf extends Fu{toString(){let e="[";if(He.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let r=0;r<this.RANK;++r)e+=` ${this[r*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,r){return this[t*this.RANK+e]=Pe(r),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const r=e*this.RANK;for(let n=0;n<this.RANK;++n)t[n]=this[r+n];return t}setColumn(e,t){const r=e*this.RANK;for(let n=0;n<this.RANK;++n)this[r+n]=t[n];return this}}function ku(s,e,t){const r=e[0],n=e[1],i=e[2],o=e[3],u=e[4],l=e[5],m=e[6],b=e[7],d=e[8],x=t[0],g=t[1],_=t[2],w=t[3],f=t[4],p=t[5],a=t[6],c=t[7],h=t[8];return s[0]=x*r+g*o+_*m,s[1]=x*n+g*u+_*b,s[2]=x*i+g*l+_*d,s[3]=w*r+f*o+p*m,s[4]=w*n+f*u+p*b,s[5]=w*i+f*l+p*d,s[6]=a*r+c*o+h*m,s[7]=a*n+c*u+h*b,s[8]=a*i+c*l+h*d,s}function Nu(s,e,t){const r=t[0],n=t[1];return s[0]=r*e[0],s[1]=r*e[1],s[2]=r*e[2],s[3]=n*e[3],s[4]=n*e[4],s[5]=n*e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s}var wi;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL1ROW0=3]="COL1ROW0",s[s.COL1ROW1=4]="COL1ROW1",s[s.COL1ROW2=5]="COL1ROW2",s[s.COL2ROW0=6]="COL2ROW0",s[s.COL2ROW1=7]="COL2ROW1",s[s.COL2ROW2=8]="COL2ROW2"})(wi||(wi={}));const wf=Object.freeze([1,0,0,0,1,0,0,0,1]);class hr extends vf{static get IDENTITY(){return function(){return Es||(Es=new hr,Object.freeze(Es)),Es}()}static get ZERO(){return function(){return Ss||(Ss=new hr([0,0,0,0,0,0,0,0,0]),Object.freeze(Ss)),Ss}()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return wi}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(wf)}fromObject(e){return this.check()}fromQuaternion(e){return function(t,r){const n=r[0],i=r[1],o=r[2],u=r[3],l=n+n,m=i+i,b=o+o,d=n*l,x=i*l,g=i*m,_=o*l,w=o*m,f=o*b,p=u*l,a=u*m,c=u*b;t[0]=1-g-f,t[3]=x-c,t[6]=_+a,t[1]=x+c,t[4]=1-d-f,t[7]=w-p,t[2]=_-a,t[5]=w+p,t[8]=1-d-g}(this,e),this.check()}set(e,t,r,n,i,o,u,l,m){return this[0]=e,this[1]=t,this[2]=r,this[3]=n,this[4]=i,this[5]=o,this[6]=u,this[7]=l,this[8]=m,this.check()}setRowMajor(e,t,r,n,i,o,u,l,m){return this[0]=e,this[1]=n,this[2]=u,this[3]=t,this[4]=i,this[5]=l,this[6]=r,this[7]=o,this[8]=m,this.check()}determinant(){return function(e){const t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],u=e[5],l=e[6],m=e[7],b=e[8];return t*(b*o-u*m)+r*(-b*i+u*l)+n*(m*i-o*l)}(this)}transpose(){return function(e,t){if(e===t){const r=t[1],n=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(this,this),this.check()}invert(){return function(e,t){const r=t[0],n=t[1],i=t[2],o=t[3],u=t[4],l=t[5],m=t[6],b=t[7],d=t[8],x=d*u-l*b,g=-d*o+l*m,_=b*o-u*m;let w=r*x+n*g+i*_;w&&(w=1/w,e[0]=x*w,e[1]=(-d*n+i*b)*w,e[2]=(l*n-i*u)*w,e[3]=g*w,e[4]=(d*r-i*m)*w,e[5]=(-l*r+i*o)*w,e[6]=_*w,e[7]=(-b*r+n*m)*w,e[8]=(u*r-n*o)*w)}(this,this),this.check()}multiplyLeft(e){return ku(this,e,this),this.check()}multiplyRight(e){return ku(this,this,e),this.check()}rotate(e){return function(t,r,n){const i=r[0],o=r[1],u=r[2],l=r[3],m=r[4],b=r[5],d=r[6],x=r[7],g=r[8],_=Math.sin(n),w=Math.cos(n);t[0]=w*i+_*l,t[1]=w*o+_*m,t[2]=w*u+_*b,t[3]=w*l-_*i,t[4]=w*m-_*o,t[5]=w*b-_*u,t[6]=d,t[7]=x,t[8]=g}(this,this,e),this.check()}scale(e){return Array.isArray(e)?Nu(this,this,e):Nu(this,this,[e,e]),this.check()}translate(e){return function(t,r,n){const i=r[0],o=r[1],u=r[2],l=r[3],m=r[4],b=r[5],d=r[6],x=r[7],g=r[8],_=n[0],w=n[1];t[0]=i,t[1]=o,t[2]=u,t[3]=l,t[4]=m,t[5]=b,t[6]=_*i+w*l+d,t[7]=_*o+w*m+x,t[8]=_*u+w*b+g}(this,this,e),this.check()}transform(e,t){let r;switch(e.length){case 2:r=function(n,i,o){const u=i[0],l=i[1];return n[0]=o[0]*u+o[3]*l+o[6],n[1]=o[1]*u+o[4]*l+o[7],n}(t||[-0,-0],e,this);break;case 3:r=Uu(t||[-0,-0,-0],e,this);break;case 4:r=function(n,i,o){const u=i[0],l=i[1],m=i[2];return n[0]=o[0]*u+o[3]*l+o[6]*m,n[1]=o[1]*u+o[4]*l+o[7]*m,n[2]=o[2]*u+o[5]*l+o[8]*m,n[3]=i[3],n}(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Af(r,e.length),r}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let Ss,Es=null;const Ms="KHR_texture_transform",Cf=Ms,Ps=new vi,Tf=new hr,Sf=new hr;function Ef(s,e){var i,o,u,l;const t=(i=e.json.materials)==null?void 0:i[s],r=[(o=t==null?void 0:t.pbrMetallicRoughness)==null?void 0:o.baseColorTexture,t==null?void 0:t.emissiveTexture,t==null?void 0:t.normalTexture,t==null?void 0:t.occlusionTexture,(u=t==null?void 0:t.pbrMetallicRoughness)==null?void 0:u.metallicRoughnessTexture],n=[];for(const m of r)m&&((l=m==null?void 0:m.extensions)!=null&&l[Ms])&&Mf(e,s,m,n)}function Mf(s,e,t,r){const n=function(o,u){var x;const l=(x=o.extensions)==null?void 0:x[Ms],{texCoord:m=0}=o,{texCoord:b=m}=l;if(!(u.findIndex(([g,_])=>g===m&&_===b)!==-1)){const g=function(_){const{offset:w=[0,0],rotation:f=0,scale:p=[1,1]}=_,a=new hr().set(1,0,0,0,1,0,w[0],w[1],1),c=Tf.set(Math.cos(f),Math.sin(f),0,-Math.sin(f),Math.cos(f),0,0,0,1),h=Sf.set(p[0],0,0,0,p[1],0,0,0,1);return a.multiplyRight(c).multiplyRight(h)}(l);return m!==b&&(o.texCoord=b),u.push([m,b]),{originalTexCoord:m,texCoord:b,matrix:g}}return null}(t,r);if(!n)return;const i=s.json.meshes||[];for(const o of i)for(const u of o.primitives){const l=u.material;Number.isFinite(l)&&e===l&&Pf(s,u,n)}}function Pf(s,e,t){var u,l;const{originalTexCoord:r,texCoord:n,matrix:i}=t,o=e.attributes[`TEXCOORD_${r}`];if(Number.isFinite(o)){const m=(u=s.json.accessors)==null?void 0:u[o];if(m&&m.bufferView){const b=(l=s.json.bufferViews)==null?void 0:l[m.bufferView];if(b){const{arrayBuffer:d,byteOffset:x}=s.buffers[b.buffer],g=(x||0)+(m.byteOffset||0)+(b.byteOffset||0),{ArrayType:_,length:w}=ci(m,b),f=cu[m.componentType],p=uu[m.type],a=b.byteStride||f*p,c=new Float32Array(w);for(let h=0;h<m.count;h++){const y=new _(d,g+h*a,2);Ps.set(y[0],y[1],1),Ps.transformByMatrix3(i),c.set([Ps[0],Ps[1]],h*p)}r===n?function(h,y,A,C){h.componentType=5126,A.push({arrayBuffer:C.buffer,byteOffset:0,byteLength:C.buffer.byteLength}),y.buffer=A.length-1,y.byteLength=C.buffer.byteLength,y.byteOffset=0,delete y.byteStride}(m,b,s.buffers,c):function(h,y,A,C,R){C.buffers.push({arrayBuffer:R.buffer,byteOffset:0,byteLength:R.buffer.byteLength});const U=C.json.bufferViews;if(!U)return;U.push({buffer:C.buffers.length-1,byteLength:R.buffer.byteLength,byteOffset:0});const k=C.json.accessors;k&&(k.push({bufferView:(U==null?void 0:U.length)-1,byteOffset:0,componentType:5126,count:y.count,type:"VEC2"}),A.attributes[`TEXCOORD_${h}`]=k.length-1)}(n,m,e,s,c)}}}}const Rf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e){var r;if(!new xe(s).hasExtension(Ms)||!((r=e.gltf)!=null&&r.loadBuffers))return;const t=s.json.materials||[];for(let n=0;n<t.length;n++)Ef(n,s)},name:Cf},Symbol.toStringTag,{value:"Module"})),Nt="KHR_lights_punctual",Gf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s){const e=new xe(s),{json:t}=e,r=e.getExtension(Nt);r&&(e.json.lights=r.lights,e.removeExtension(Nt));for(const n of t.nodes||[]){const i=e.getObjectExtension(n,Nt);i&&(n.light=i.light),e.removeObjectExtension(n,Nt)}},encode:async function(s){const e=new xe(s),{json:t}=e;if(t.lights){const r=e.addExtension(Nt);Ee(!r.lights),r.lights=t.lights,delete t.lights}if(e.json.lights){for(const r of e.json.lights){const n=r.node;e.addObjectExtension(n,Nt,r)}delete e.json.lights}},name:Nt},Symbol.toStringTag,{value:"Module"})),Rr="KHR_materials_unlit",Lf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s){const e=new xe(s),{json:t}=e;for(const r of t.materials||[])r.extensions&&r.extensions.KHR_materials_unlit&&(r.unlit=!0),e.removeObjectExtension(r,Rr);e.removeExtension(Rr)},encode:function(s){const e=new xe(s),{json:t}=e;if(e.materials)for(const r of t.materials||[])r.unlit&&(delete r.unlit,e.addObjectExtension(r,Rr,{}),e.addExtension(Rr))},name:Rr},Symbol.toStringTag,{value:"Module"})),Gr="KHR_techniques_webgl",Of=Gr;function If(s,e){const t=Object.assign({},s.values);return Object.keys(s.uniforms||{}).forEach(r=>{s.uniforms[r].value&&!(r in t)&&(t[r]=s.uniforms[r].value)}),Object.keys(t).forEach(r=>{typeof t[r]=="object"&&t[r].index!==void 0&&(t[r].texture=e.getTexture(t[r].index))}),t}const Vu=[Mh,bh,uf,cf,lf,xf,Gf,Lf,Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s){const e=new xe(s),{json:t}=e,r=e.getExtension(Gr);if(r){const n=function(i,o){const{programs:u=[],shaders:l=[],techniques:m=[]}=i,b=new TextDecoder;return l.forEach(d=>{if(!Number.isFinite(d.bufferView))throw new Error("KHR_techniques_webgl: no shader code");d.code=b.decode(o.getTypedArrayForBufferView(d.bufferView))}),u.forEach(d=>{d.fragmentShader=l[d.fragmentShader],d.vertexShader=l[d.vertexShader]}),m.forEach(d=>{d.program=u[d.program]}),m}(r,e);for(const i of t.materials||[]){const o=e.getObjectExtension(i,Gr);o&&(i.technique=Object.assign({},o,n[o.technique]),i.technique.values=If(i.technique,e)),e.removeObjectExtension(i,Gr)}e.removeExtension(Gr)}},encode:async function(s,e){},name:Of},Symbol.toStringTag,{value:"Module"})),Rf,Uh];function Hu(s,e){var r;const t=((r=e==null?void 0:e.gltf)==null?void 0:r.excludeExtensions)||{};return!(s in t&&!t[s])}const Ci="KHR_binary_glTF",Ju={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},Ff={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class Df{constructor(){ee(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}});ee(this,"json")}normalize(e,t){this.json=e.json;const r=e.json;switch(r.asset&&r.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return void console.warn(`glTF: Unknown version ${r.asset.version}`)}if(!t.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(r),this._convertTopLevelObjectsToArrays(r),function(n){const i=new xe(n),{json:o}=i;for(const u of o.images||[]){const l=i.getObjectExtension(u,Ci);l&&Object.assign(u,l),i.removeObjectExtension(u,Ci)}o.buffers&&o.buffers[0]&&delete o.buffers[0].uri,i.removeExtension(Ci)}(e),this._convertObjectIdsToArrayIndices(r),this._updateObjects(r),this._updateMaterial(r)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const t in Ju)this._convertTopLevelObjectToArray(e,t)}_convertTopLevelObjectToArray(e,t){const r=e[t];if(r&&!Array.isArray(r)){e[t]=[];for(const n in r){const i=r[n];i.id=i.id||n;const o=e[t].length;e[t].push(i),this.idToIndexMap[t][n]=o}}}_convertObjectIdsToArrayIndices(e){for(const t in Ju)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const t of e.textures)this._convertTextureIds(t);for(const t of e.meshes)this._convertMeshIds(t);for(const t of e.nodes)this._convertNodeIds(t);for(const t of e.scenes)this._convertSceneIds(t)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const t of e.primitives){const{attributes:r,indices:n,material:i}=t;for(const o in r)r[o]=this._convertIdToIndex(r[o],"accessor");n&&(t.indices=this._convertIdToIndex(n,"accessor")),i&&(t.material=this._convertIdToIndex(i,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map(t=>this._convertIdToIndex(t,"node"))),e.meshes&&(e.meshes=e.meshes.map(t=>this._convertIdToIndex(t,"mesh")))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map(t=>this._convertIdToIndex(t,"node")))}_convertIdsToIndices(e,t){e[t]||(console.warn(`gltf v1: json doesn't contain attribute ${t}`),e[t]=[]);for(const r of e[t])for(const n in r){const i=r[n],o=this._convertIdToIndex(i,n);r[n]=o}}_convertIdToIndex(e,t){const r=Ff[t];if(r in this.idToIndexMap){const n=this.idToIndexMap[r][e];if(!Number.isFinite(n))throw new Error(`gltf v1: failed to resolve ${t} with id ${e}`);return n}return e}_updateObjects(e){for(const t of this.json.buffers)delete t.type}_updateMaterial(e){var t,r,n;for(const i of e.materials){i.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const o=((t=i.values)==null?void 0:t.tex)||((r=i.values)==null?void 0:r.texture2d_0)||((n=i.values)==null?void 0:n.diffuseTex),u=e.textures.findIndex(l=>l.id===o);u!==-1&&(i.pbrMetallicRoughness.baseColorTexture={index:u})}}}async function Uf(s,e,t=0,r,n){var i,o,u;return function(l,m,b,d){if(d.uri&&(l.baseUri=d.uri),m instanceof ArrayBuffer&&!function(_,w=0,f={}){const p=new DataView(_),{magic:a=Su}=f,c=p.getUint32(w,!1);return c===a||c===Su}(m,b,d)&&(m=new TextDecoder().decode(m)),typeof m=="string")l.json=Ld(m);else if(m instanceof ArrayBuffer){const _={};b=qh(_,m,b,d.glb),Ee(_.type==="glTF",`Invalid GLB magic string ${_.type}`),l._glb=_,l.json=_.json}else Ee(!1,"GLTF: must be ArrayBuffer or string");const x=l.json.buffers||[];if(l.buffers=new Array(x.length).fill(null),l._glb&&l._glb.header.hasBinChunk){const{binChunks:_}=l._glb;l.buffers[0]={arrayBuffer:_[0].arrayBuffer,byteOffset:_[0].byteOffset,byteLength:_[0].byteLength}}const g=l.json.images||[];l.images=new Array(g.length).fill({})}(s,e,t,r),function(l,m={}){new Df().normalize(l,m)}(s,{normalize:(i=r==null?void 0:r.gltf)==null?void 0:i.normalize}),function(l,m={},b){var x;const d=Vu.filter(g=>Hu(g.name,m));for(const g of d)(x=g.preprocess)==null||x.call(g,l,m,b)}(s,r,n),(o=r==null?void 0:r.gltf)!=null&&o.loadBuffers&&s.json.buffers&&await async function(l,m,b){var x,g;const d=l.json.buffers||[];for(let _=0;_<d.length;++_){const w=d[_];if(w.uri){const{fetch:f}=b;Ee(f);const p=Eu(w.uri,m),a=await((x=b==null?void 0:b.fetch)==null?void 0:x.call(b,p)),c=await((g=a==null?void 0:a.arrayBuffer)==null?void 0:g.call(a));l.buffers[_]={arrayBuffer:c,byteOffset:0,byteLength:c.byteLength},delete w.uri}else l.buffers[_]===null&&(l.buffers[_]={arrayBuffer:new ArrayBuffer(w.byteLength),byteOffset:0,byteLength:w.byteLength})}}(s,r,n),(u=r==null?void 0:r.gltf)!=null&&u.loadImages&&await async function(l,m,b){const d=function(_){const w=new Set,f=_.json.textures||[];for(const p of f)p.source!==void 0&&w.add(p.source);return Array.from(w).sort()}(l),x=l.json.images||[],g=[];for(const _ of d)g.push(kf(l,x[_],_,m,b));return await Promise.all(g)}(s,r,n),await async function(l,m={},b){var x;const d=Vu.filter(g=>Hu(g.name,m));for(const g of d)await((x=g.decode)==null?void 0:x.call(g,l,m,b))}(s,r,n),s}async function kf(s,e,t,r,n){let i;if(e.uri&&!e.hasOwnProperty("bufferView")){const u=Eu(e.uri,r),{fetch:l}=n;i=await(await l(u)).arrayBuffer(),e.bufferView={data:i}}if(Number.isFinite(e.bufferView)){const u=function(l,m,b){const d=l.bufferViews[b];Ee(d);const x=m[d.buffer];Ee(x);const g=(d.byteOffset||0)+x.byteOffset;return new Uint8Array(x.arrayBuffer,g,d.byteLength)}(s.json,s.buffers,e.bufferView);i=Ga(u.buffer,u.byteOffset,u.byteLength)}Ee(i,"glTF image has no data");let o=await ba(i,[oh,Yh],{...r,mimeType:e.mimeType,basis:r.basis||{format:Tu()}},n);o&&o[0]&&(o={compressed:!0,mipmaps:!1,width:o[0].width,height:o[0].height,data:o[0]}),s.images=s.images||[],s.images[t]=o}const Ti={dataType:null,batchType:null,name:"glTF",id:"gltf",module:"gltf",version:"4.3.2",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:async function(s,e={},t){(e={...Ti.options,...e}).gltf={...Ti.options.gltf,...e.gltf};const{byteOffset:r=0}=e;return await Uf({},s,r,e,t)},options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0},log:console}},Nf={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Vf={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},zu=10240,ju=10241,Ku=10242,Xu=10243,Yu=10497,Hf=9729,Jf=9986,zf={magFilter:zu,minFilter:ju,wrapS:Ku,wrapT:Xu},jf={[zu]:Hf,[ju]:Jf,[Ku]:Yu,[Xu]:Yu};class Kf{constructor(){ee(this,"baseUri","");ee(this,"jsonUnprocessed");ee(this,"json");ee(this,"buffers",[]);ee(this,"images",[])}postProcess(e,t={}){const{json:r,buffers:n=[],images:i=[]}=e,{baseUri:o=""}=e;return Ee(r),this.baseUri=o,this.buffers=n,this.images=i,this.jsonUnprocessed=r,this.json=this._resolveTree(e.json,t),this.json}_resolveTree(e,t={}){const r={...e};return this.json=r,e.bufferViews&&(r.bufferViews=e.bufferViews.map((n,i)=>this._resolveBufferView(n,i))),e.images&&(r.images=e.images.map((n,i)=>this._resolveImage(n,i))),e.samplers&&(r.samplers=e.samplers.map((n,i)=>this._resolveSampler(n,i))),e.textures&&(r.textures=e.textures.map((n,i)=>this._resolveTexture(n,i))),e.accessors&&(r.accessors=e.accessors.map((n,i)=>this._resolveAccessor(n,i))),e.materials&&(r.materials=e.materials.map((n,i)=>this._resolveMaterial(n,i))),e.meshes&&(r.meshes=e.meshes.map((n,i)=>this._resolveMesh(n,i))),e.nodes&&(r.nodes=e.nodes.map((n,i)=>this._resolveNode(n,i)),r.nodes=r.nodes.map((n,i)=>this._resolveNodeChildren(n))),e.skins&&(r.skins=e.skins.map((n,i)=>this._resolveSkin(n,i))),e.scenes&&(r.scenes=e.scenes.map((n,i)=>this._resolveScene(n,i))),typeof this.json.scene=="number"&&r.scenes&&(r.scene=r.scenes[this.json.scene]),r}getScene(e){return this._get(this.json.scenes,e)}getNode(e){return this._get(this.json.nodes,e)}getSkin(e){return this._get(this.json.skins,e)}getMesh(e){return this._get(this.json.meshes,e)}getMaterial(e){return this._get(this.json.materials,e)}getAccessor(e){return this._get(this.json.accessors,e)}getCamera(e){return this._get(this.json.cameras,e)}getTexture(e){return this._get(this.json.textures,e)}getSampler(e){return this._get(this.json.samplers,e)}getImage(e){return this._get(this.json.images,e)}getBufferView(e){return this._get(this.json.bufferViews,e)}getBuffer(e){return this._get(this.json.buffers,e)}_get(e,t){if(typeof t=="object")return t;const r=e&&e[t];return r||console.warn(`glTF file error: Could not find ${e}[${t}]`),r}_resolveScene(e,t){return{...e,id:e.id||`scene-${t}`,nodes:(e.nodes||[]).map(r=>this.getNode(r))}}_resolveNode(e,t){const r={...e,id:(e==null?void 0:e.id)||`node-${t}`};return e.mesh!==void 0&&(r.mesh=this.getMesh(e.mesh)),e.camera!==void 0&&(r.camera=this.getCamera(e.camera)),e.skin!==void 0&&(r.skin=this.getSkin(e.skin)),e.meshes!==void 0&&e.meshes.length&&(r.mesh=e.meshes.reduce((n,i)=>{const o=this.getMesh(i);return n.id=o.id,n.primitives=n.primitives.concat(o.primitives),n},{primitives:[]})),r}_resolveNodeChildren(e){return e.children&&(e.children=e.children.map(t=>this.getNode(t))),e}_resolveSkin(e,t){const r=typeof e.inverseBindMatrices=="number"?this.getAccessor(e.inverseBindMatrices):void 0;return{...e,id:e.id||`skin-${t}`,inverseBindMatrices:r}}_resolveMesh(e,t){const r={...e,id:e.id||`mesh-${t}`,primitives:[]};return e.primitives&&(r.primitives=e.primitives.map(n=>{const i={...n,attributes:{},indices:void 0,material:void 0},o=n.attributes;for(const u in o)i.attributes[u]=this.getAccessor(o[u]);return n.indices!==void 0&&(i.indices=this.getAccessor(n.indices)),n.material!==void 0&&(i.material=this.getMaterial(n.material)),i})),r}_resolveMaterial(e,t){const r={...e,id:e.id||`material-${t}`};if(r.normalTexture&&(r.normalTexture={...r.normalTexture},r.normalTexture.texture=this.getTexture(r.normalTexture.index)),r.occlusionTexture&&(r.occlusionTexture={...r.occlusionTexture},r.occlusionTexture.texture=this.getTexture(r.occlusionTexture.index)),r.emissiveTexture&&(r.emissiveTexture={...r.emissiveTexture},r.emissiveTexture.texture=this.getTexture(r.emissiveTexture.index)),r.emissiveFactor||(r.emissiveFactor=r.emissiveTexture?[1,1,1]:[0,0,0]),r.pbrMetallicRoughness){r.pbrMetallicRoughness={...r.pbrMetallicRoughness};const n=r.pbrMetallicRoughness;n.baseColorTexture&&(n.baseColorTexture={...n.baseColorTexture},n.baseColorTexture.texture=this.getTexture(n.baseColorTexture.index)),n.metallicRoughnessTexture&&(n.metallicRoughnessTexture={...n.metallicRoughnessTexture},n.metallicRoughnessTexture.texture=this.getTexture(n.metallicRoughnessTexture.index))}return r}_resolveAccessor(e,t){const r=(n=e.componentType,Vf[n]);var n;const i=(o=e.type,Nf[o]);var o;const u=r*i,l={...e,id:e.id||`accessor-${t}`,bytesPerComponent:r,components:i,bytesPerElement:u,value:void 0,bufferView:void 0,sparse:void 0};if(e.bufferView!==void 0&&(l.bufferView=this.getBufferView(e.bufferView)),l.bufferView){const m=l.bufferView.buffer,{ArrayType:b,byteLength:d}=ci(l,l.bufferView),x=(l.bufferView.byteOffset||0)+(l.byteOffset||0)+m.byteOffset;let g=m.arrayBuffer.slice(x,x+d);l.bufferView.byteStride&&(g=this._getValueFromInterleavedBuffer(m,x,l.bufferView.byteStride,l.bytesPerElement,l.count)),l.value=new b(g)}return l}_getValueFromInterleavedBuffer(e,t,r,n,i){const o=new Uint8Array(i*n);for(let u=0;u<i;u++){const l=t+u*r;o.set(new Uint8Array(e.arrayBuffer.slice(l,l+n)),u*n)}return o.buffer}_resolveTexture(e,t){return{...e,id:e.id||`texture-${t}`,sampler:typeof e.sampler=="number"?this.getSampler(e.sampler):{id:"default-sampler",parameters:jf},source:typeof e.source=="number"?this.getImage(e.source):void 0}}_resolveSampler(e,t){const r={id:e.id||`sampler-${t}`,...e,parameters:{}};for(const n in r){const i=this._enumSamplerParameter(n);i!==void 0&&(r.parameters[i]=r[n])}return r}_enumSamplerParameter(e){return zf[e]}_resolveImage(e,t){const r={...e,id:e.id||`image-${t}`,image:null,bufferView:e.bufferView!==void 0?this.getBufferView(e.bufferView):void 0},n=this.images[t];return n&&(r.image=n),r}_resolveBufferView(e,t){const r=e.buffer,n=this.buffers[r].arrayBuffer;let i=this.buffers[r].byteOffset||0;return e.byteOffset&&(i+=e.byteOffset),{id:`bufferView-${t}`,...e,buffer:this.buffers[r],data:new Uint8Array(n,i,e.byteLength)}}_resolveCamera(e,t){const r={...e,id:e.id||`camera-${t}`};return r.perspective,r.orthographic,r}}let Rs,Gs,Si,Ei;const rn=class rn extends Ze{static get defaultGLTFLayout(){if(Gs)return Gs;const e=[{shaderLocation:Ne.Position,format:"float32x3",offset:0}],t=[{shaderLocation:Ne.Normal,format:"float32x3",offset:0}],r=[{shaderLocation:Ne.TexCoord,format:"float32x2",offset:0}],n=[{shaderLocation:Ne.Tangent,format:"float32x4",offset:0}];return Gs=[{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:e},{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:t},{arrayStride:2*Float32Array.BYTES_PER_ELEMENT,attributes:r},{arrayStride:4*Float32Array.BYTES_PER_ELEMENT,attributes:n}],Gs}static get defaultLayout(){if(Rs)return Rs;const e=[{shaderLocation:Ne.Position,offset:0,format:"float32x3"},{shaderLocation:Ne.Normal,offset:3*Float32Array.BYTES_PER_ELEMENT,format:"float32x3"},{shaderLocation:Ne.TexCoord,offset:6*Float32Array.BYTES_PER_ELEMENT,format:"float32x2"},{shaderLocation:Ne.Tangent,offset:8*Float32Array.BYTES_PER_ELEMENT,format:"float32x4"}];return Rs=[{arrayStride:rn.itemsPerVertexDefaultLayout*Float32Array.BYTES_PER_ELEMENT,attributes:e}],Rs}};rn.itemsPerVertexDefaultLayout=12;let _e=rn;class Wu{constructor(){this.min=D.create(),this.max=D.create(),this._temp=D.create()}get minX(){return this.min[0]}get minY(){return this.min[1]}get minZ(){return this.min[2]}get maxX(){return this.max[0]}get maxY(){return this.max[1]}get maxZ(){return this.max[2]}getArea(){const e=this.max[0]-this.min[0],t=this.max[1]-this.min[1],r=this.max[2]-this.min[2];return 2*(e*e+t*t+r*r)}setMinAABB(e,t,r){this.min[0]=e,this.min[1]=t,this.min[2]=r}setMinAABBfromGLTF(e){this.setMinAABB(e[0],e[1],e[2])}setMaxAABB(e,t,r){this.max[0]=e,this.max[1]=t,this.max[2]=r}setMaxAABBfromGLTF(e){this.setMaxAABB(e[0],e[1],e[2])}get boundingBoxCenter(){return this.getBoundingBoxCenter()}getBoundingBoxCenter(){return this._temp[0]=this.max[0]-this.min[0],this._temp[1]=this.max[1]-this.min[1],this._temp[2]=this.max[2]-this.min[2],this._temp}}class Ls{constructor(){this.faces=[],this.boundingBox=new Wu,this.vertexBuffers=[],this.indexCount=0,this.vertexBufferOffsets=new Map,this.indexBufferOffsets=[0,0]}createBuffersWithTangentsManually(e,t,r,n,i){this.indexCount=e;const o=D.create(),u=D.create(),l=new Float32Array(_e.itemsPerVertexDefaultLayout*e),m=new Array(t.length).fill(null).map(h=>D.create()),b=new Array(t.length).fill(null).map(h=>D.create());for(const h of this.faces)a(h);let d=Number.POSITIVE_INFINITY,x=Number.POSITIVE_INFINITY,g=Number.POSITIVE_INFINITY,_=Number.NEGATIVE_INFINITY,w=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let h=0;h<i.length;h+=3){const y=i[h+0],A=i[h+1],C=i[h+2];p(y),p(A),p(C)}function p(h){const y=r[h],A=t[h],C=n[h],R=m[h];d=Math.min(d,A[0]),x=Math.min(x,A[1]),g=Math.min(g,A[2]),_=Math.max(_,A[0]),w=Math.max(w,A[1]),f=Math.max(f,A[2]);const U=D.normalize(D.sub(R,D.mulScalar(y,D.dot(y,R)))),k=D.normalize(D.cross(y,R)),T=D.dot(k,b[h])<0?-1:1,S=h*_e.itemsPerVertexDefaultLayout;l[S+0]=A[0],l[S+1]=A[1],l[S+2]=A[2],l[S+3]=y[0],l[S+4]=y[1],l[S+5]=y[2],l[S+6]=C[0],l[S+7]=C[1],l[S+8]=U[0],l[S+9]=U[1],l[S+10]=U[2],l[S+11]=T}function a(h){const y=D.sub(h.p1,h.p0),A=D.sub(h.p2,h.p0),C=Se.sub(h.texCoord1,h.texCoord0),R=Se.sub(h.texCoord2,h.texCoord0),U=1/(C[0]*R[1]-R[0]*C[1]);o[0]=U*(R[1]*y[0]-C[1]*A[0]),o[1]=U*(R[1]*y[1]-C[1]*A[1]),o[2]=U*(R[1]*y[2]-C[1]*A[2]),u[0]=U*(-R[0]*y[0]+C[0]*A[0]),u[1]=U*(-R[0]*y[1]+C[0]*A[1]),u[2]=U*(-R[0]*y[2]+C[0]*A[2]),D.normalize(o,o),D.normalize(u,u),D.add(m[h.indexV0],o,m[h.indexV0]),D.add(m[h.indexV1],o,m[h.indexV1]),D.add(m[h.indexV2],o,b[h.indexV2]),D.add(b[h.indexV0],u,b[h.indexV0]),D.add(b[h.indexV1],u,b[h.indexV1]),D.add(b[h.indexV2],u,b[h.indexV2])}this.boundingBox.setMinAABB(d,x,g),this.boundingBox.setMaxAABB(_,w,f);const c=v.device.createBuffer({mappedAtCreation:!0,size:e*_e.itemsPerVertexDefaultLayout*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX,label:"Mesh Interleaved Vertex GPUBuffer"});Y.addBufferBytes(c),new Float32Array(c.getMappedRange()).set(l,0),c.unmap(),this.vertexBuffers.push(c),this.vertexBufferOffsets.set(c,[0,0]),this.indexBuffer=v.device.createBuffer({mappedAtCreation:!0,size:Uint16Array.BYTES_PER_ELEMENT*i.length,usage:GPUBufferUsage.INDEX,label:"Mesh Index GPUBuffer"}),Y.addBufferBytes(this.indexBuffer),new Uint16Array(this.indexBuffer.getMappedRange()).set(i),this.indexBuffer.unmap(),this.indexBufferOffsets=[0,0]}}class Xf extends Ls{constructor(e,t){super(),this.gpuBuffers=t,this.firstIndex=0;const r=e.attributes.POSITION,n=e.attributes.NORMAL,i=e.attributes.TEXCOORD_0,o=e.attributes.TANGENT;if(!r)throw new Error("GLTF Mesh needs to have vertices array");[r,n,i,o].forEach(m=>{if(!m){const x=v.device.createBuffer({label:"Vertex Buffer Placeholder",size:1,usage:GPUBufferUsage.VERTEX});return this.vertexBufferOffsets.set(x,[0,1]),Y.addBufferBytes(x),void this.vertexBuffers.push(x)}const b=m.bufferView,d=this.gpuBuffers.get(b.id);this.vertexBuffers.push(d),this.vertexBufferOffsets.set(d,[0,0])});const u=e.indices.bufferView,l=this.gpuBuffers.get(u.id);this.indexBufferOffsets[0]=e.indices.byteOffset,this.indexBufferOffsets[1]=e.indices.count*e.indices.bytesPerElement,this.indexCount=e.indices.count,this.indexBuffer=l}}const $u=new Map,Vt=WebGLRenderingContext;class Je extends Ze{static get defaultNearestSampler(){return Si||(Si=this.createSampler({minFilter:"nearest",magFilter:"nearest"}),Si)}static get defaultSampler(){return Ei||(Ei=this.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear",maxAnisotropy:4}),Ei)}static createSampler(e){const t=structuredClone(e);t.label&&delete t.label;const r=JSON.stringify(t);let n;return(n=$u.get(r))||(n=v.device.createSampler(e),$u.set(r,n)),n}static getSamplerFromGltfSamplerDef(e){function t(n){switch(n){case Vt.CLAMP_TO_EDGE:return"clamp-to-edge";case Vt.MIRRORED_REPEAT:return"mirror-repeat";default:return"repeat"}}const r={addressModeU:t(e.wrapS),addressModeV:t(e.wrapT)};switch(e.magFilter&&e.magFilter!=Vt.LINEAR||(r.magFilter="linear"),e.minFilter){case Vt.LINEAR:case Vt.LINEAR_MIPMAP_NEAREST:r.minFilter="linear";break;case Vt.NEAREST_MIPMAP_LINEAR:r.mipmapFilter="linear";break;case Vt.LINEAR_MIPMAP_LINEAR:default:r.minFilter="linear",r.mipmapFilter="linear"}return r.maxAnisotropy=16,this.createSampler(r)}}function Mi(s,e){if(s[3]!==0){var t=(r=1,n=s[3]-136,r*Math.pow(2,n));e[0]=s[0]*t,e[1]=s[1]*t,e[2]=s[2]*t}else e[0]=e[1]=e[2]=0;var r,n}function Pi(s,e){var t=s[0],r=s[1],n=s[2],i=Math.max(t,Math.max(r,n));if(i<9999999999999999e-48)e[0]=e[1]=e[2]=e[3]=0;else{var o=function(b){var d={f:b=Number(b),e:0};if(b!==0&&Number.isFinite(b)){for(var x=Math.abs(b),g=Math.log2||function(f){return Math.log(f)*Math.LOG2E},_=Math.max(-1023,Math.floor(g(x))+1),w=x*Math.pow(2,-_);w>=1;)w*=.5,_++;for(;w<.5;)w*=2,_--;b<0&&(w=-w),d.f=w,d.e=_}return d}(i),u=o.f,l=o.e,m=u/i*256;e[0]=t*m,e[1]=r*m,e[2]=n*m,e[3]=l+128}}function qu(s,e,t){var r=[];return function(n,i,o,u,l){if(!(o<=0||i<=0||!l)){var m=`#?RADIANCE
# Written by hdr.js
FORMAT=32-bit_rle_rgbe
EXPOSURE=1.0

-Y `+o+" +X "+i+`
`;m.split("").forEach(function(x){var g=x.charCodeAt(0);n.push(g)});for(var b=new Uint8Array(4*i),d=0;d<o;d++)Yf(n,i,u,b,l.subarray(u*i*d))}}(r,s,e,3,t),new Uint8Array(r)}function Yf(s,e,t,r,n){var i,o=new Uint8Array([2,2,0,0]),u=new Uint8Array(4),l=new Float32Array(3);if(o[2]=(65280&e)>>8,o[3]=255&e,e<8||e>=32768)for(i=0;i<e;i++){switch(t){case 4:case 3:l[2]=n[i*t+2],l[1]=n[i*t+1],l[0]=n[i*t+0];break;default:l[0]=l[1]=l[2]=n[i*t+0]}Pi(l,u),s.push(u[0],u[1],u[2],u[3])}else{var m=void 0,b=void 0;for(i=0;i<e;i++){switch(t){case 4:case 3:l[2]=n[i*t+2],l[1]=n[i*t+1],l[0]=n[i*t+0];break;default:l[0]=l[1]=l[2]=n[i*t+0]}Pi(l,u),r[i+0*e]=u[0],r[i+1*e]=u[1],r[i+2*e]=u[2],r[i+3*e]=u[3]}for(s.push(o[0],o[1],o[2],o[3]),m=0;m<4;m++){var d=r.subarray(e*m);for(i=0;i<e;){for(b=i;b+2<e&&(d[b]!==d[b+1]||d[b]!==d[b+2]);)++b;for(b+2>=e&&(b=e);i<b;)(x=b-i)>128&&(x=128),Wf(s,x,d.subarray(i)),i+=x;if(b+2<e){for(;b<e&&d[b]==d[i];)++b;for(;i<b;){var x;(x=b-i)>127&&(x=127),$f(s,x,d[i]),i+=x}}}}}}function Wf(s,e,t){var r=255&e;if(!(e<=128))throw new Error("length is greater than 128");s.push(r);for(var n=0;n<e;n++)s.push(t[n])}function $f(s,e,t){var r=e+128&255;if(!(e+128<=255))throw new Error("length is greater than 128");s.push(r,t)}function Qu(s,e){for(var t=e.length,r=0;r<t;r++)if(s[r]!==e.charCodeAt(r))return!1;return!0}var qf=10240,Zu=1<<24;function ec(s){var e="",t=0;if(!function(T){var S=Qu(T,`#?RADIANCE
`);return S||(S=Qu(T,`#?RGBE
`)),S}(s))return"Corrupt HDR image.";for(;!e.match(/\n\n[^\n]+\n/g)&&t<qf;)e+=String.fromCharCode(s[t++]);var r=e.match(/FORMAT=(.*)$/m)[1];if(r!=="32-bit_rle_rgbe")return"Unsupported HDR format: "+r;var n=e.split(/\n/).reverse()[1].split(" ");if(n[0]!=="-Y"||n[2]!=="+X")return"Unsupported HDR format";var i,o,u=Number.parseFloat(n[3]),l=Number.parseFloat(n[1]);if(u>Zu||l>Zu)return"Very large image (corrupt?)";var m=s[t],b=s[t+1],d=s[t+2],x=m!==2||b!==2||!!(128&d),g=new Float32Array(u*l*3);if(u<8||u>=32768||x)for(o=0;o<l;++o)for(i=0;i<u;++i){var _=s.subarray(t,t+4);t+=4;var w=3*(o*u+i);Mi(_,g.subarray(w,w+3))}else for(var f,p,a,c=void 0,h=0;h<l;h++){if(f=s[t++],p=s[t++],a=s[t++],f!==2||p!==2||128&a)return"Invalid scanline";if(a<<=8,(a|=s[t++])!==u)return"invalid decoded scanline length";c||(c=new Uint8Array(4*u));for(var y=void 0,A=void 0,C=0;C<4;C++){var R=void 0;for(i=0;(R=u-i)>0;)if((y=s[t++])>128){if(A=s[t++],(y-=128)>R)return"bad RLE data in HDR";for(var U=0;U<y;U++)c[4*i+++C]=A}else{if(y>R)return"bad RLE data in HDR";for(U=0;U<y;U++)c[4*i+++C]=s[t++]}}for(var k=0;k<u;k++)Mi(c.subarray(4*k),g.subarray(3*(h*u+k)))}return{rgbFloat:g,width:u,height:l}}var Qf=Object.freeze({load:function(s){return new Promise(function(e,t){typeof XMLHttpRequest>"u"&&t("XMLHttpRequest is undefined, use HDRjs.read instead.");var r=new XMLHttpRequest;r.responseType="arraybuffer",r.onload=function(){if(r.status>=400)return t("Load successfully, but HTTP status code >= 400, status: "+r.status);var n=ec(new Uint8Array(r.response));typeof n=="string"?t(n):e(n)},r.onerror=function(n){t("Failed to load: "+s)},r.open("GET",s,!0),r.send()})},save:function(s,e,t,r){if(!(document!=null&&document.createElement)||!(URL!=null&&URL.createObjectURL))return console.warn("NO document.createElement or URL.createObjectURL"),!1;var n=qu(e,t,s),i=URL.createObjectURL(new Blob([n])),o=document.createElement("a");return o.href=i,o.download=r+".hdr",o.rel="noopener",setTimeout(function(){URL.revokeObjectURL(o.href)},4e4),setTimeout(function(){(function(u){try{u.dispatchEvent(new MouseEvent("click"))}catch{var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),u.dispatchEvent(l)}})(o)},0),!0},read:ec,write:qu,float2rgbe:Pi,rgbe2float:Mi});const tc="vertexMain",rc="fragmentMain",sc=`
  ${W.VertexInput}
  ${W.VertexOutput}

  @group(0) @binding(0) var<uniform> projViewMatrix: mat4x4f;
  @group(0) @binding(1) var inTexture: texture_2d<f32>;
  @group(0) @binding(2) var inSampler: sampler;

  const invAtan = vec2(0.1591, 0.3183);
  fn SampleSphericalMap(v: vec3f) -> vec2f {
    var uv = vec2f(atan(v.z / v.x), asin(v.y));
    uv *= invAtan;
    uv += 0.5;
    return uv;
  }


  @vertex
  fn ${tc}(in: VertexInput) -> VertexOutput {
    var out: VertexOutput;
    out.position = projViewMatrix * in.position;
    // hijack
    out.viewNormal = in.position.xyz;
    return out;
  }

  @fragment
  fn ${rc}(in: VertexOutput) -> @location(0) vec4f {
    let uv = SampleSphericalMap(normalize(in.normal.rgb)); // make sure to normalize localPos
    let color = textureSample(inTexture, inSampler, uv).rgb;
    return vec4f(color, 1);
  }
`;let Os,Is,Fs,Ds,Us;const Ri=new Map([]),J={get defaultCameraPlusLightsBindGroupLayout(){if(Is)return Is;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}];return Is=v.device.createBindGroupLayout({label:"Camera + Lights GPUBindGroupLayout",entries:s}),Is},get defaultCameraBindGroupLayout(){if(Os)return Os;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return Os=v.device.createBindGroupLayout({label:"Camera GPUBindGroupLayout",entries:s}),Os},get defaultModelBindGroupLayout(){if(Fs)return Fs;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return Fs=v.device.createBindGroupLayout({label:"Model GPUBindGroupLayout",entries:s}),Fs},get defaultModelMaterialBindGroupLayout(){if(Ds)return Ds;const s=[{binding:as.Default,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:me.Albedo,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:me.Normal,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:me.MetallicRoughness,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}];return Ds=v.device.createBindGroupLayout({label:"Model Textures GPUBindGroupLayout",entries:s}),Ds},get instancesBindGroupLayout(){if(Us)return Us;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}];return Us=v.device.createBindGroupLayout({label:"Instance Models GPUBindGroupLayout",entries:s}),Us},createShaderModule:(s,e=`Shader Module #${Ri.size}`)=>{let t;return(t=Ri.get(s))||(t=v.device.createShaderModule({label:e,code:s}),Ri.set(s,t)),t},createRenderPipeline:s=>v.device.createRenderPipeline(s),createComputePipeline:s=>v.device.createComputePipeline(s)};class fr{constructor(e,t,r,n,i,o,u,l,m,b,d,x){this.indexV0=e,this.indexV1=t,this.indexV2=r,this.p0=n,this.p1=i,this.p2=o,this.n0=u,this.n1=l,this.v2=m,this.texCoord0=b,this.texCoord1=d,this.texCoord2=x,this.centroid=D.create(),this.computeCetroid()}computeCetroid(){this.centroid[0]=(this.p0[0]+this.p1[0]+this.p2[0])/3,this.centroid[1]=(this.p0[1]+this.p1[1]+this.p2[1])/3,this.centroid[2]=(this.p0[2]+this.p1[2]+this.p2[2])/3}getArea(){const e=D.sub(this.p2,this.p1),t=D.sub(this.p0,this.p1);return .5*D.len(D.cross(e,t))}}class nc extends Ls{constructor(e=1,t=1,r=1,n=1,i=1,o=1){super(),this.width=e,this.height=t,this.depth=r,this.widthSegments=n,this.heightSegments=i,this.depthSegments=o,n=Math.floor(n),i=Math.floor(i),o=Math.floor(o);const u=[],l=[],m=[],b=[];let d=0;function x(g,_,w,f,p,a,c,h,y,A){const C=a/y,R=c/A,U=a/2,k=c/2,T=h/2,S=y+1,P=A+1;let L=0;const F=D.create();for(let O=0;O<P;O++){const H=O*R-k;for(let K=0;K<S;K++){const X=K*C-U;F[g]=X*f,F[_]=H*p,F[w]=T,l.push(D.clone(F)),F[g]=0,F[_]=0,F[w]=h>0?1:-1,m.push(D.clone(F)),b.push(Se.create(K/y,1-O/A)),L+=1}}for(let O=0;O<A;O++)for(let H=0;H<y;H++){const K=d+H+S*O,X=d+H+S*(O+1),j=d+(H+1)+S*(O+1),z=d+(H+1)+S*O;u.push(K,X,z);const q=new fr(K,X,z,l[K],l[X],l[z],m[K],m[X],m[z],b[K],b[X],b[z]);this.faces.push(q),u.push(X,j,z);const Z=new fr(X,j,z,l[X],l[j],l[z],m[X],m[j],m[z],b[X],b[j],b[z]);this.faces.push(Z)}d+=L}x.call(this,2,1,0,-1,-1,r,t,e,o,i),x.call(this,2,1,0,1,-1,r,t,-e,o,i),x.call(this,0,2,1,1,1,e,r,t,n,o),x.call(this,0,2,1,1,-1,e,r,-t,n,o),x.call(this,0,1,2,1,-1,e,t,r,n,i),x.call(this,0,1,2,-1,-1,e,t,-r,n,i),this.createBuffersWithTangentsManually(u.length,l,m,b,new Uint16Array(u))}}class Zf{constructor(){this.isReflective=!0,this.metallic=.1,this.roughness=.8,this._baseColor=D.create()}get color(){return this._baseColor}set color(e){this.setColor(e[0],e[1],e[2])}setColorR(e){this._baseColor[0]=e}setColorG(e){this._baseColor[1]=e}setColorB(e){this._baseColor[2]=e}setColor(e,t,r){this._baseColor[0]=e,this._baseColor[1]=t,this._baseColor[2]=r}}const sn=class sn extends sr{constructor(e){super(),this.materialProps=new Zf,this.firstIndex=0,this.baseVertex=0,this.firstInstance=0,this.instanceCount=1,this.isOpaque=!0,this.modelMaterialBindGroupEntries=[],this.uploadModelBufferToGPU=!0,this.materials=new Map,this.textures=new Map,this._worldBoundingBox=new Wu,this._sampler=Je.defaultSampler,this.geometry=e;const t=Ot(W.ModelUniform);this.bufferUniformValues=yt(t.structs.ModelUniform),this.modelBuffer=v.device.createBuffer({label:`${this.label} Model GPUBuffer`,size:this.bufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y.addBufferBytes(this.modelBuffer);const r=[{binding:0,resource:{buffer:this.modelBuffer}}];this.modelBindGroup=v.device.createBindGroup({layout:J.defaultModelBindGroupLayout,entries:r}),this.modelMaterialBindGroupEntries=[{binding:as.Default,resource:this.sampler},{binding:me.Albedo,resource:Be.dummyTexture.createView()},{binding:me.Normal,resource:Be.dummyTexture.createView()},{binding:me.MetallicRoughness,resource:Be.dummyTexture.createView()}],this.texturesBindGroup=v.device.createBindGroup({label:"Model Textures Bind Group",layout:J.defaultModelMaterialBindGroupLayout,entries:this.modelMaterialBindGroupEntries}),this.setTexture(Be.dummyTexture,me.Albedo),this.setTexture(Be.dummyTexture,me.Normal),this.setTexture(Be.dummyTexture,me.MetallicRoughness)}get worldBoundingBox(){return D.transformMat4(this.geometry.boundingBox.min,this.modelMatrix,this._worldBoundingBox.min),D.transformMat4(this.geometry.boundingBox.max,this.modelMatrix,this._worldBoundingBox.max),this._worldBoundingBox}get boundingBox(){return this.geometry.boundingBox}set boundingBox(e){this.geometry.boundingBox=e}get sampler(){return this.getSampler()}set sampler(e){this.setSampler(e),this.modelMaterialBindGroupEntries[0].resource=e,this.updateTexturesBindGroup()}getSampler(){return this._sampler}setSampler(e){this._sampler=e}setTexture(e,t=1){this.textures.set(t,e),this.modelMaterialBindGroupEntries[t].resource=e.createView(),this.updateTexturesBindGroup()}getTexture(e){return this.textures.get(e)}get material(){return this.materials.get(v.getActiveRenderPassType())}updateTexturesBindGroup(){this.texturesBindGroup=v.device.createBindGroup({label:"Model Textures Bind Group",layout:J.defaultModelMaterialBindGroupLayout,entries:this.modelMaterialBindGroupEntries})}setMaterial(e,t){const r=t??V.Deferred;this.materials.set(r,e)}getMaterial(e){const t=e??V.Deferred;return this.materials.get(t)}updateWorldMatrix(){const e=super.updateWorldMatrix();return this.uploadModelBufferToGPU=e,e}preRender(e){v.ENABLE_DEBUG_GROUPS&&e.pushDebugGroup(`Render ${this.label}`),this.uploadModelBufferToGPU&&(this.bufferUniformValues.set({worldMatrix:this.modelMatrix,prevFrameWorldMatrix:this.prevFrameModelMatrix,normalMatrix:this.normalMatrix,isReflective:this.materialProps.isReflective?1:0,baseColor:this.materialProps.color,metallic:this.materialProps.metallic,roughness:this.materialProps.roughness}),this.uploadModelBufferToGPU=!1,v.device.queue.writeBuffer(this.modelBuffer,0,this.bufferUniformValues.arrayBuffer)),e.setIndexBuffer(this.geometry.indexBuffer,sn.INDEX_FORMAT,this.geometry.indexBufferOffsets[0]);for(let t=0;t<this.geometry.vertexBuffers.length;t++){const r=this.geometry.vertexBufferOffsets.get(this.geometry.vertexBuffers[t]);e.setVertexBuffer(t,this.geometry.vertexBuffers[t],r[0])}e.setBindGroup(ue.Model,this.modelBindGroup),e.setBindGroup(ue.PBRTextures,this.texturesBindGroup)}onRender(e){this.material.bind(),e.drawIndexed(this.geometry.indexCount,this.instanceCount,this.firstIndex,this.baseVertex,this.firstInstance)}postRender(e){v.ENABLE_DEBUG_GROUPS&&e.popDebugGroup()}render(e){this.material&&super.render(e)}};sn.INDEX_FORMAT="uint16";let Ae=sn;const ic="main",ep=`
  @group(0) @binding(0) var inTexture: texture_2d<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var<uniform> inOutTextureScaleFactor: u32;

  @compute @workgroup_size(8, 8)
  fn ${ic}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(inTexture, 0).xy;
    if (any(id.xy > texSize.xy)) {
      return;
    }

    let inColor = textureLoad(inTexture, id.xy * inOutTextureScaleFactor, 0);
    textureStore(outTexture, id.xy, inColor);
  }
`,Gi="computeMipMap",oc=(s="rgba8unorm")=>`
  @group(0) @binding(0) var prevMipLevel: texture_2d<f32>;
  @group(0) @binding(1) var nextMipLevel: texture_storage_2d<${s}, write>;

  @compute @workgroup_size(8, 8)
  fn ${Gi}(@builtin(global_invocation_id) id: vec3u) {
    let offset = vec2<u32>(0, 1);
    let color = (
        textureLoad(prevMipLevel, 2 * id.xy + offset.xx, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.xy, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.yx, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.yy, 0)
    ) * 0.25;
    textureStore(nextMipLevel, id.xy, color);
  }
`;function ac(s,e,t){const r=[{binding:0,resource:e[s-1]},{binding:1,resource:e[s]}];return v.device.createBindGroup({label:"Mip Generator Input Bind Group",layout:t,entries:r})}const yr=class yr extends Ze{static copyTextureView(e,t,r,n,i,o,u={viewDimension:"2d",sampleType:"unfilterable-float"},l={access:"write-only",format:"rgba16float",viewDimension:"2d"}){const m=v.device.createBuffer({label:"Copy Texture View Compute Tex Scale Factor Buffer",size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0});Y.addBufferBytes(m);const b=n/i;new Uint32Array(m.getMappedRange()).set(new Uint32Array([b])),m.unmap();const d=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:u},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:l},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{}}],x=v.device.createBindGroupLayout({label:"Copy Texture View Compute Bind Group Layout",entries:d}),g=[{binding:0,resource:t},{binding:1,resource:r},{binding:2,resource:{buffer:m}}],_=v.device.createBindGroup({layout:x,entries:g}),w=v.device.createPipelineLayout({label:"Copy Texture View Compute PSO Layout",bindGroupLayouts:[x]}),f=J.createComputePipeline({label:"Copy Texture View Compute PSO",layout:w,compute:{module:J.createShaderModule(ep),entryPoint:ic}});e.setPipeline(f),e.setBindGroup(0,_),e.dispatchWorkgroups(Math.ceil(i/8),Math.ceil(o/8),1)}};yr.generateMipsForCubeTexture=e=>{if(e.depthOrArrayLayers!=6)return void console.error("Need a cube texture");const t=Pt(e.width,e.height),r={baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1,dimension:"2d",format:e.format},n=[],i=[];for(let d=0;d<6;d++){const x=[],g=[Se.create(e.width,e.height)];for(let _=0;_<t;_++){const w=`MIP Level ${_}`;if(r.label=w,r.baseArrayLayer=d,r.baseMipLevel=_,x.push(e.createView(r)),_>0){const f=g[_-1],p=Se.divScalar(f,2);g.push(p)}}n.push(x),i.push(g)}const o=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:e.format,viewDimension:"2d"}}],u=v.device.createBindGroupLayout({label:"Mip Generator CubeTexture Input Bind Group Layout",entries:o}),l=J.createComputePipeline({label:"Compute Mip ComputePSO",layout:v.device.createPipelineLayout({label:"Compute Mip ComputePSO CubeTexture Layout",bindGroupLayouts:[u]}),compute:{entryPoint:Gi,module:J.createShaderModule(oc(e.format))}}),m=v.device.createCommandEncoder({label:"Mip Generate Command Encoder}"}),b=m.beginComputePass();b.setPipeline(l);for(let d=0;d<6;d++){const x=i[d],g=n[d];for(let _=1;_<x.length;_++){const f=(x[_][0]+8-1)/8,p=(x[_][1]+8-1)/8,a=ac(_,g,u);b.setBindGroup(0,a),b.dispatchWorkgroups(f,p,1)}}b.end(),v.device.queue.submit([m.finish()])},yr.generateMipsFor2DTextureWithRenderPSO=()=>{},yr.generateMipsFor2DTextureWithComputePSO=(e,t="Mipmapped 2D Texture")=>{const r=Pt(e.width,e.height),n={aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1,dimension:"2d",format:e.format},i=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:e.format,viewDimension:"2d"}}],o=v.device.createBindGroupLayout({label:"Mip Generator Input Bind Group Layout",entries:i}),u=J.createComputePipeline({label:"Compute Mip ComputePSO",layout:v.device.createPipelineLayout({label:"Compute Mip ComputePSO Layout",bindGroupLayouts:[o]}),compute:{entryPoint:Gi,module:J.createShaderModule(oc())}}),l=[],m=[Se.create(e.width,e.height)];for(let x=0;x<r;x++){const g=`MIP Level ${x}`;if(n.label=g,n.baseMipLevel=x,l.push(e.createView(n)),x>0){const _=m[x-1],w=Se.divScalar(_,2);m.push(w)}}const b=v.device.createCommandEncoder({label:`Mip Generate Command Encoder for ${t}`}),d=b.beginComputePass();d.setPipeline(u);for(let x=1;x<m.length;x++){const _=(m[x][0]+8-1)/8,w=(m[x][1]+8-1)/8,f=ac(x,l,o);d.setBindGroup(0,f),d.dispatchWorkgroups(_,w,1)}d.end(),v.device.queue.submit([b.finish()])},yr.createHDRTexture=(e,t=GPUTextureUsage.TEXTURE_BINDING,r="HDR Texture")=>{const n=v.device.createTexture({label:r,format:"rgba16float",size:{width:e.width,height:e.height,depthOrArrayLayers:1},usage:t});return v.device.queue.writeTexture({texture:n,mipLevel:0},e.rgbaHalfFloat,{offset:0,bytesPerRow:e.width*Uint16Array.BYTES_PER_ELEMENT*4},{width:e.width,height:e.height,depthOrArrayLayers:1}),n};let Ht=yr,tp=0;const Jr=class Jr extends Ze{static createEmptyCubeTexture(e,t="Cube Texture "+tp++,r=!1,n="rgba16float",i=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST){const o={label:t,dimension:"2d",size:{width:e,height:e,depthOrArrayLayers:6},usage:i,format:n};return r&&(o.mipLevelCount=Pt(e,e)),v.device.createTexture(o)}};Jr.cubeTextureFromIndividualHDRTextures=(e,t="Environment Cube Texture From Individual HDR Textures",r=512,n=!1)=>{const i=Jr.createEmptyCubeTexture(r,t,n),o=v.device.createCommandEncoder();v.ENABLE_DEBUG_GROUPS&&o.pushDebugGroup("Texture View Copy");const u=o.beginComputePass(),l=r;for(let m=0;m<6;m++)Ht.copyTextureView(u,e[m].createView({}),i.createView({baseArrayLayer:m,arrayLayerCount:1,baseMipLevel:0,mipLevelCount:1,dimension:"2d"}),r,l,l);return u.end(),v.ENABLE_DEBUG_GROUPS&&o.popDebugGroup(),v.device.queue.submit([o.finish()]),n&&Ht.generateMipsForCubeTexture(i),i},Jr.cubeTextureFromHDR=(e,t=512)=>{const r=v.device.createTexture({label:"Environment Cube Texture",dimension:"2d",size:{width:t,height:t,depthOrArrayLayers:6},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING,format:"rgba8unorm"}),n=new kn(.5*Math.PI,1,.1,10);n.updateProjectionMatrix();const i=v.device.createBuffer({label:"HDR -> CubeMap Camera ProjView Matrix Buffer",size:16*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM});Y.addBufferBytes(i);const o=[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,texture:{sampleType:"unfilterable-float"},visibility:GPUShaderStage.FRAGMENT},{binding:2,sampler:{type:"non-filtering"},visibility:GPUShaderStage.FRAGMENT}],u=v.device.createBindGroupLayout({label:"Environment Probe Camera Bind Group Layout",entries:o}),l=[{binding:0,resource:{buffer:i}},{binding:1,resource:e.createView()},{binding:2,resource:Je.createSampler({})}],m=v.device.createBindGroup({label:"Environment Probe Camera Bind Group",layout:u,entries:l}),b=v.device.createCommandEncoder({label:"HDR Environment to Cube Map Command Encoder"}),d=[{loadOp:"load",storeOp:"store",view:null}],x=J.createRenderPipeline({label:"HDR To CubeMap Render PSO",layout:v.device.createPipelineLayout({bindGroupLayouts:[u]}),vertex:{module:J.createShaderModule(sc),entryPoint:tc,buffers:_e.defaultLayout},fragment:{module:J.createShaderModule(sc),entryPoint:rc,targets:[{format:"rgba8unorm"}]},primitive:{cullMode:"none"}}),g=new nc;for(let _=0;_<6;_++){d[0].view=r.createView({dimension:"2d",baseArrayLayer:_,arrayLayerCount:1});const w=D.add(n.position,Bl[_]),f=Q.lookAt(n.position,w,vl[_]),p=Q.mul(n.projectionMatrix,f);v.device.queue.writeBuffer(i,0,p);const a={label:`Draw Face ${_} Render Pass`,colorAttachments:d},c=b.beginRenderPass(a);c.setPipeline(x),c.setBindGroup(0,m),c.setIndexBuffer(g.indexBuffer,Ae.INDEX_FORMAT),c.setVertexBuffer(0,g.vertexBuffer),c.drawIndexed(g.indexCount),c.end()}return v.device.queue.submit([b.finish()]),r};let Lr=Jr;const rp=new Uint8Array([0,32,8,40,2,34,10,42,48,16,56,24,50,18,58,26,12,44,4,36,14,46,6,38,60,28,52,20,62,30,54,22,3,35,11,43,1,33,9,41,51,19,59,27,49,17,57,25,15,47,7,39,13,45,5,37,63,31,55,23,61,29,53,21]),uc=new Uint8Array([255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255]);let ks,Or,Ns;const Ct=class Ct extends Ze{static get dummyTexture(){return ks||(ks=v.device.createTexture({label:"Default Dummy 8x8 Texture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:1},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),v.device.queue.writeTexture({texture:ks,mipLevel:0},uc,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:1}),ks)}static get dummyCubeTexture(){if(Or)return Or;Or=v.device.createTexture({label:"Default Dummy 8x8 Cube Texture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:6},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});for(let e=0;e<6;e++)v.device.queue.writeTexture({texture:Or,mipLevel:0,origin:{x:0,y:0,z:e}},uc,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:0});return Or}static get bayerDitherPatternTexture(){return Ns||(Ns=v.device.createTexture({label:"Bayer ordered dithered GPUTexture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:1},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),v.device.queue.writeTexture({texture:Ns,mipLevel:0},rp,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:1}),Ns)}};Ct.loadHDRImage=async e=>{const t=await Qf.load(e),r=t.width*t.height,n={width:t.width,height:t.height,rgbaHalfFloat:new Uint16Array(t.width*t.height*4)};for(let i=0;i<r;i++){const o=t.rgbFloat[3*i+0],u=t.rgbFloat[3*i+1],l=t.rgbFloat[3*i+2];n.rgbaHalfFloat[4*i+0]=ts(o),n.rgbaHalfFloat[4*i+1]=ts(u),n.rgbaHalfFloat[4*i+2]=ts(l),n.rgbaHalfFloat[4*i+3]=ts(1)}return n},Ct.loadHDRTexture=async(e,t=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC,r=`HDR Texture ${e}`)=>{const n=await Ct.loadHDRImage(e),i=await Ht.createHDRTexture(n,t,r);return Y.addTextureBytes(i),i},Ct.load6SeparateHDRFacesAsCubeMapTexture=async(e,t,r,n=null)=>{if(e.length!==6)return void console.error("Need 6 separate urls for 6 separate environment textures");const i=await Promise.all(e.map(u=>Ct.loadHDRTexture(u))),o=Lr.cubeTextureFromIndividualHDRTextures(i,n,t,r);return Y.addTextureBytes(o),o},Ct.loadTextureFromData=async(e,t="rgba8unorm",r=!0,n=!1,i=!1,o="Bitmap Texture")=>{const u=new Blob([e],{type:"image/png"}),l=await createImageBitmap(u,{colorSpaceConversion:"none"});let m=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT;r&&(m|=GPUTextureUsage.STORAGE_BINDING);const b={label:o,dimension:"2d",size:{width:l.width,height:l.height,depthOrArrayLayers:1},format:t,usage:m};r&&(b.mipLevelCount=Pt(l.width,l.height));const d=v.device.createTexture(b);if(v.device.queue.copyExternalImageToTexture({source:l,flipY:n},{texture:d},{width:l.width,height:l.height}),!r)return Y.addTextureBytes(d),d;Ht.generateMipsFor2DTextureWithComputePSO(d),Y.addTextureBytes(d);const x=document.createElement("canvas"),g=x.getContext("2d");return x.width=d.width/2,x.height=d.height/2,g.drawImage(l,0,0),i&&(x.style.setProperty("position","fixed"),x.style.setProperty("z-index","99"),x.style.setProperty("left","2rem"),x.style.setProperty("bottom","2rem"),x.style.setProperty("width",.1*d.width+"px"),x.style.setProperty("height",.1*d.height+"px"),x.dataset.debugLabel=`${o.toLowerCase()}`,document.body.appendChild(x)),l.close(),d};let Be=Ct;class sp extends sr{constructor(e){super(),this.url=e,this.nodeMaterialIds=new Map([]),this.gpuSamplers=new Map,this.gpuTextures=new Map,this.gpuBuffers=new Map,this.updateWorldMatrix()}setMaterial(e,t=V.Deferred){return this.traverse(r=>{r instanceof Ae&&r.setMaterial(e,t)}),this}setIsReflective(e){return this.traverse(t=>{t instanceof Ae&&(t.materialProps.isReflective=e)}),this}setTextureForAll(e,t=1){return this.traverse(r=>{r instanceof Ae&&r.setTexture(e,t)}),this}setSampler(e){return this.traverse(t=>{t instanceof Ae&&t.setSampler(e)}),this}setTextureFor(e,t,r=1){const n=this.findChildByLabel(e);if(n instanceof Ae)return n.setTexture(t,r),this;console.error("Found child is not instance of a Drawable")}async load(){const e=[],t=async function(u,l,m){let b,d;Array.isArray(l)||Zn(l)?(b=l,d=m):(b=[],d=l);const x=su(d);let g=u;return typeof u=="string"&&(g=await x(u)),Ut(u)&&(g=await x(u)),Array.isArray(b),await ri(g,b,d)}(this.url,Ti);e.push(t);const r=(n=await t,new Kf().postProcess(n,i));var n,i;const o=this.initGPUTexturesFrom(r.textures);return e.push(o),this.initGPUSamplersFrom(r.samplers),this.initGPUBuffersFrom(r.bufferViews),this.initMaterialsFrom(r.materials),this.initNodesFrom(r),Promise.all(e)}async initMaterialsFrom(e){for(const t of e){if(t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture){const r=await this.gpuTextures.get(t.pbrMetallicRoughness.baseColorTexture.texture.id),n=this.nodeMaterialIds.get(t.id);for(const i of n)i.setTexture(r,me.Albedo);if(t.pbrMetallicRoughness.metallicRoughnessTexture){const i=await this.gpuTextures.get(t.pbrMetallicRoughness.metallicRoughnessTexture.texture.id),o=this.nodeMaterialIds.get(t.id);for(const u of o)u.setTexture(i,me.MetallicRoughness)}}if(t.normalTexture){const r=await this.gpuTextures.get(t.normalTexture.texture.id),n=this.nodeMaterialIds.get(t.id);for(const i of n)i.setTexture(r,me.Normal)}}}async initGPUTexturesFrom(e){const t=[];for(const r of e){const n=Be.loadTextureFromData(r.source.bufferView.data,"rgba8unorm",!0,!1,!1,`GLTF Texture: ${r.id}`);t.push(n),this.gpuTextures.set(r.id,n)}return Promise.all(t)}initGPUSamplersFrom(e){for(const t of e){const r=Je.getSamplerFromGltfSamplerDef(t);this.gpuSamplers.set(t.id,r)}}initGPUBuffersFrom(e){for(const t of e){let r=0;t.target===34963&&(r|=GPUBufferUsage.INDEX),t.target===34962&&(r|=GPUBufferUsage.VERTEX);const n=4*Math.ceil(t.byteLength/4),i=v.device.createBuffer({label:t.id,mappedAtCreation:!0,size:n,usage:r});Y.addBufferBytes(i),new Uint8Array(i.getMappedRange()).set(new Uint8Array(t.buffer.arrayBuffer,t.byteOffset,t.byteLength)),i.unmap(),this.gpuBuffers.set(t.id,i)}}initNodesFrom(e){var t,r,n,i;for(const o of e.nodes)if(o.mesh)for(const u of o.mesh.primitives){const l=new Xf(u,this.gpuBuffers),m=new Ae(l),b=D.create(),d=D.create(1,1,1),x=Zr.identity(),g=this.nodeMaterialIds.get(u.material.id)||[];g.push(m),this.nodeMaterialIds.set(u.material.id,g),u.material.pbrMetallicRoughness.baseColorTexture&&u.material.pbrMetallicRoughness.baseColorTexture.texture.source.uri.includes("5823059166183034438")?m.materialProps.isReflective=!0:m.materialProps.isReflective=!1,m.label=o.name??o.id;const _=(r=(t=u.attributes)==null?void 0:t.POSITION)==null?void 0:r.min;_&&m.boundingBox.setMinAABBfromGLTF(_);const w=(i=(n=u.attributes)==null?void 0:n.POSITION)==null?void 0:i.max;w&&m.boundingBox.setMaxAABBfromGLTF(w),o.translation&&D.set(o.translation[0],o.translation[1],o.translation[2],b),o.scale&&D.set(o.scale[0],o.scale[1],o.scale[2],d),o.rotation&&Zr.set(o.rotation[0],o.rotation[1],o.rotation[2],o.rotation[3],x),m.setCustomMatrixFromTRS(b,x,d),m.sampler=this.gpuSamplers.get("sampler-0"),this.addChild(m)}}}const cc="vertexMain",lc="fragmentMain",np=`
  ${W.Camera}

  @group(${ue.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;

  @group(1) @binding(0) var<storage, read> linePointPositions: array<vec4f>;

  @vertex
  fn ${cc}(
    @builtin(vertex_index) vertexId: u32,
  ) -> @builtin(position) vec4f {
    let position = linePointPositions[vertexId];
    return camera.projectionViewMatrix * position;
  }

  @fragment
  fn ${lc}() -> @location(0) vec4f {
    return vec4f(vec3f(1), 1);
  }
`;class ip extends sr{constructor(e){super(),this.points=e,this.pointsGPUBuffer=v.device.createBuffer({label:"Line Points GPU Buffer",size:4*e.length*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0}),Y.addBufferBytes(this.pointsGPUBuffer);const t=new Float32Array(this.pointsGPUBuffer.getMappedRange());for(let u=0;u<e.length;u++)t[4*u+0]=e[u][0],t[4*u+1]=e[u][1],t[4*u+2]=e[u][2],t[4*u+3]=1;this.pointsGPUBuffer.unmap();const r=[{binding:0,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX}],n=v.device.createBindGroupLayout({label:"ParticlesMoveCurve Debug Bind Group Layout",entries:r}),i=[{binding:0,resource:{buffer:this.pointsGPUBuffer}}];this.bindGroup=v.device.createBindGroup({label:"ParticlesMoveCurve Debug Bind Group",layout:n,entries:i});const o=J.createShaderModule(np,"ParticlesMoveCurve Debug Shader Module");this.renderPSO=J.createRenderPipeline({label:"ParticlesMoveCurve Debug Render PSO",layout:v.device.createPipelineLayout({label:"ParticlesMoveCurve Debug Render PSO Layout",bindGroupLayouts:[J.defaultCameraPlusLightsBindGroupLayout,n]}),vertex:{entryPoint:cc,module:o},fragment:{entryPoint:lc,module:o,targets:[{format:"rgba16float"}]},depthStencil:{format:v.depthStencilFormat,depthCompare:"less",depthWriteEnabled:!0},primitive:{topology:"line-strip"}})}render(e){this.visible&&(v.ENABLE_DEBUG_GROUPS&&e.pushDebugGroup(`Render Debug Line: ${this.label}`),e.setPipeline(this.renderPSO),e.setBindGroup(1,this.bindGroup),e.draw(this.points.length),v.ENABLE_DEBUG_GROUPS&&e.popDebugGroup())}}class op extends sr{constructor(){super(...arguments),this.debugMeshes=[],this.opaqueMeshes=[],this.transparentMeshes=[],this.culledOpaqueMeshes=[],this.culledTransparentMeshes=[],this.nonCulledTransparentCount=0,this.nonCulledOpaqueCount=0,this.onGraphChangedCallbacks=[]}get nodesCount(){return this.opaqueMeshes.length+this.transparentMeshes.length}get visibleNodesCount(){return this.nonCulledOpaqueCount+this.nonCulledTransparentCount}addOnGraphChangedCallback(e){this.onGraphChangedCallbacks.push(e)}renderDebugMeshes(e){for(const t of this.debugMeshes)t.render(e)}renderOpaqueNodes(e,t){if(!t){for(const n of this.opaqueMeshes)n.render(e);return}const r=t.cullMeshes(this.opaqueMeshes,this.culledOpaqueMeshes);this.nonCulledOpaqueCount=r;for(let n=0;n<r;n++)this.culledOpaqueMeshes[n].render(e)}renderTransparentNodes(e,t){if(!t){for(const n of this.transparentMeshes)n.render(e);return}const r=t.cullMeshes(this.transparentMeshes,this.culledTransparentMeshes);this.nonCulledTransparentCount=r;for(let n=0;n<r;n++)this.culledTransparentMeshes[n].render(e)}onChildAdd(e){e instanceof Ae&&(e.isOpaque?(this.opaqueMeshes.push(e),this.culledOpaqueMeshes.push(e)):(this.transparentMeshes.push(e),this.culledTransparentMeshes.push(e))),e instanceof ip&&this.debugMeshes.push(e);for(const t of this.onGraphChangedCallbacks)t()}onChildRemove(e){super.onChildRemove(e);const t=({id:r})=>r!==e.id;e instanceof Ae&&(e.isOpaque?(this.opaqueMeshes=this.opaqueMeshes.filter(t),this.culledOpaqueMeshes=this.culledOpaqueMeshes.filter(t)):(this.transparentMeshes=this.transparentMeshes.filter(t),this.culledTransparentMeshes=this.culledTransparentMeshes.filter(t)));for(const r of this.onGraphChangedCallbacks)r()}}const dc=`
  // Van Der Corpus sequence
  // @see http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html
  fn vdcSequence(inBits: u32) -> f32 {
    var bits = inBits;
    bits = (bits << 16u) | (bits >> 16u);
    bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
    bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
    bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
    bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
    return f32(bits) * 2.3283064365386963e-10; // / 0x100000000
  }

  // Hammersley sequence
  // @see http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html
  fn hammersley(i: u32, N: u32) -> vec2f {
    return vec2f(f32(i) / f32(N), vdcSequence(i));
  }

  // Based on Karis 2014
  // GGX NDF via importance sampling
  fn importanceSampleGGX(Xi: vec2f, N: vec3f, roughness: f32) -> vec3f {
    let alpha = roughness * roughness;
    let alpha2 = alpha * alpha;

    let phi = TWO_PI * Xi.x;
    let cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (alpha2 - 1.0) * Xi.y));
    let sinTheta = sqrt(1.0 - cosTheta * cosTheta);

    // from spherical coordinates to cartesian coordinates
    let H = vec3f(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);

    // from tangent-space vector to world-space sample vector
    
    let up = select(WORLD_UP, WORLD_FORWARD, abs(N.z) < 0.999);
    let tangent = normalize(cross(up, N));
    let bitangent = cross(N, tangent);

    return tangent * H.x + bitangent * H.y + N * H.z;
  }

  fn GTR2(NdotH: f32, a: f32) -> f32 {
    let a2 = a * a;
    let t = 1.0 + (a2 - 1.0) * NdotH * NdotH;
    return step(0.0, NdotH) * a2 / (PI * t * t);
  }

  fn distributionGGX(NdotH: f32, roughness: f32) -> f32 {
    return GTR2(NdotH, roughness * roughness);
  }

  fn visibilitySmithGGXCorrelated(NdotV: f32, NdotL: f32, roughness: f32) -> f32 {
    let a2 = roughness * roughness;
    let oneMinusA2 = 1.0 - a2;
    let ggxv = NdotL * sqrt(NdotV * NdotV * oneMinusA2 + a2);
    let ggxl = NdotV * sqrt(NdotL * NdotL * oneMinusA2 + a2);
  
    let ggx = ggxv + ggxl;
    if (ggx > 0.0) {
        return 0.5 / ggx;
    }
    return 0.0;
  }
`,hc="main",ap=`
  ${W.CommonHelpers}

  @group(0) @binding(0) var outTexture: texture_storage_2d<rgba16float, write>;

  const SAMPLE_COUNT = 1024u;

  ${dc}

  // https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf
  // Karis 2014
  @must_use
  fn integrate(NdotV: f32, roughness: f32) -> vec2f {
    var V = vec3f(0.0);
    V.x = sqrt(1.0 - NdotV * NdotV); // sin
    V.y = 0.0;
    V.z = NdotV; // cos

    // N points straight upwards for this integration
    let N = vec3f(0.0, 0.0, 1.0);

    var A = 0.0;
    var B = 0.0;

    for (var i = 0u; i < SAMPLE_COUNT; i++) {
      let Xi = hammersley(i, SAMPLE_COUNT);
      let H = importanceSampleGGX(Xi, N, roughness);
      let L = 2.0 * dot(V, H) * H - V;

      let NdotL = saturate(L.z);
      let NdotH = saturate(H.z);
      let VdotH = saturate(dot(V, H));
      
      if (NdotL > 0.0) {
        let V_pdf = visibilitySmithGGXCorrelated(NdotV, NdotL, roughness) * VdotH * NdotL / NdotH;
        let Fc = pow(1.0 - VdotH, 5.0);
        A += (1.0 - Fc) * V_pdf;
        B += Fc * V_pdf;
      }
    }

    return 4.0 * vec2f(A, B) / f32(SAMPLE_COUNT);
  }

  @compute @workgroup_size(8, 8)
  fn ${hc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy) - 1.0;
    let uv = vec2f(id.xy) / size;

    let result = vec4f(integrate(uv.x, uv.y), 0, 0);
    textureStore(outTexture, id.xy, result);
  }
`;let Vs;const fc=[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}}],nn=class nn extends Ze{static get computePSO(){if(Vs)return Vs;const e=v.device.createBindGroupLayout({label:"BDRF Lut Compute PSO Bind Group Layout",entries:fc});return Vs=v.device.createComputePipeline({label:"BDRF LUT Generate Compute PSO",compute:{module:J.createShaderModule(ap),entryPoint:hc},layout:v.device.createPipelineLayout({label:"BDRF LUT Generation Compute PSO Layout",bindGroupLayouts:[e]})}),Vs}};nn.encode=(e=512)=>{const t=v.device.createTexture({label:"BDRF LUT Texture",size:{width:e,height:e,depthOrArrayLayers:1},format:"rgba16float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST,mipLevelCount:1}),r=v.device.createCommandEncoder({label:"BDRF LUT Generate Command Encoder"});v.ENABLE_DEBUG_GROUPS&&r.pushDebugGroup("BDRF LUT Generation");const n=r.beginComputePass({label:"BDRF LUT Generate Compute Pass"}),i=v.device.createBindGroupLayout({label:"BDRF Lut Compute PSO Bind Group Layout",entries:fc}),o=[{binding:0,resource:t.createView()}],u=v.device.createBindGroup({label:"BDRF LUT Generate Input Bind Group",layout:i,entries:o}),l=(e+8-1)/8,m=(e+8-1)/8;return n.setPipeline(nn.computePSO),n.setBindGroup(0,u),n.dispatchWorkgroups(l,m,1),n.end(),v.ENABLE_DEBUG_GROUPS&&r.popDebugGroup(),v.device.queue.submit([r.finish()]),Y.addTextureBytes(t),t};let Li=nn;const pc="main",up=`
  ${W.CommonHelpers}
  ${W.MathHelpers}

  @group(0) @binding(0) var inTexture: texture_cube<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var cubeSampler: sampler;
  @group(0) @binding(3) var<uniform> face: u32;

  @compute @workgroup_size(8, 8)
  fn ${pc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy);
    let uv = vec2f(id.xy) / size;
    
    var ruv = 2.0 * uv - 1.0;
    ruv.y = ruv.y * -1;
    
    var irradiance = vec3f(0.0);
    let rotation = CUBE_ROTATIONS[face];
    let N = normalize(vec3f(ruv, 1.0) * rotateAxisAngle(rotation.xyz, rotation.w));
    var UP = select(WORLD_UP, WORLD_FORWARD, abs(N.z) < 0.999);
    let RIGHT = normalize(cross(UP, N));
    UP = cross(RIGHT, N);

    var sampleCount = 0u;

    for (var phi: f32 = 0.0; phi < TWO_PI; phi += DELTA_PHI) {
      let sinPhi = sin(phi);
      let cosPhi = cos(phi);
      for (var theta: f32 = 0.0; theta < HALF_PI; theta += DELTA_THETA) {
        let sinTheta = sin(theta);
        let cosTheta = cos(theta);

        let tempVec = cosPhi * RIGHT + sinPhi * UP;
        let sampleVector = cosTheta * N + sinTheta * tempVec;

        irradiance += textureSampleLevel(inTexture, cubeSampler, sampleVector, 2).rgb * cos(theta) * sin(theta);
        sampleCount++;
      }
    }
    
    irradiance = PI * irradiance / f32(sampleCount);
    textureStore(outTexture, id.xy, vec4f(irradiance, 1.0));
  }
`;let Hs;const mc=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{},visibility:GPUShaderStage.COMPUTE}],on=class on extends Ze{static get computePSO(){if(Hs)return Hs;const e=v.device.createBindGroupLayout({label:"Diffuse IBL Compute PSO Bind Group Layout",entries:mc});return Hs=J.createComputePipeline({label:"Diffuse IBL Compute PSO",compute:{module:J.createShaderModule(up),entryPoint:pc},layout:v.device.createPipelineLayout({label:"Diffuse IBL Compute PSO Layout",bindGroupLayouts:[e]})}),Hs}};on.encode=(e,t=32)=>{if(e.depthOrArrayLayers!==6)return void console.error("Need cube texture as a source for IBL Diffuse");if(e.format!=="rgba16float")return void console.error("Only rgba16float cube textures supported for Diffuse IBL for now");const r=Lr.createEmptyCubeTexture(t,"Diffuse IBL Texture",!0),n=v.device.createBindGroupLayout({label:"Diffuse IBL Compute PSO Bind Group Layout",entries:mc}),i=[{binding:0,resource:null},{binding:1,resource:null},{binding:2,resource:Je.createSampler({addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"})},{binding:3,resource:{buffer:null}}],o=v.device.createCommandEncoder({label:"Diffuse IBL Command Encoder"}),u=o.beginComputePass({label:"Diffuse IBL Compute Pass"});v.ENABLE_DEBUG_GROUPS&&u.pushDebugGroup("Begin Diffuse IBL"),u.setPipeline(on.computePSO);const l=e.createView({dimension:"cube"});for(let m=0;m<6;m++){const b=v.device.createBuffer({label:"Diffuse IBL Face GPUBuffer",size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0});Y.addBufferBytes(b),new Uint32Array(b.getMappedRange()).set(new Uint32Array([m])),b.unmap();const d=r.createView({format:r.format,dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:m,arrayLayerCount:1});i[0].resource=l,i[1].resource=d,i[3].resource={buffer:b};const x=v.device.createBindGroup({layout:n,entries:i}),g=8,_=(r.width+g-1)/g,w=(r.height+g-1)/g;u.setBindGroup(0,x),u.dispatchWorkgroups(_,w,1)}return v.ENABLE_DEBUG_GROUPS&&u.popDebugGroup(),u.end(),v.device.queue.submit([o.finish()]),Y.addTextureBytes(r),r};let Oi=on;const gc="main",cp=`
  ${W.CommonHelpers}
  ${W.MathHelpers}

  @group(0) @binding(0) var inTexture: texture_cube<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var cubeSampler: sampler;
  @group(0) @binding(3) var<uniform> face: u32;
  @group(0) @binding(4) var<uniform> roughness: f32;

  const SAMPLE_COUNT: u32 = 1024;

  ${dc}

  @compute @workgroup_size(8, 8)
  fn ${gc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy);
    let uv = vec2f(id.xy) / size;
    
    var ruv = 2.0 * uv - 1.0;
    ruv.y = ruv.y * -1;

    let rotation = CUBE_ROTATIONS[face];
    let N = normalize(vec3f(ruv, 1.0) * rotateAxisAngle(rotation.xyz, rotation.w));

    let R = N;
    let V = R;

    var prefilteredColor = vec3f(0.0);
    var totalWeight = 0.0;

    for (var i = 0u; i < SAMPLE_COUNT; i++) {
      // generates a sample vector that's biased towards the preferred alignment direction (importance sampling).
      let Xi = hammersley(i, SAMPLE_COUNT);
      let H = importanceSampleGGX(Xi, N, roughness);
      let L = normalize(2.0 * dot(V, H) * H - V);

      let NdotL = max(dot(N, L), 0.0);

      if (NdotL > 0.0) {
        // sample from the environment's mip level based on roughness/pdf

        let NdotH = max(dot(N, H), 0.0);
        let HdotV = max(dot(H, V), 0.0);
        let D = distributionGGX(NdotH, roughness);
        let pdf = max((D * NdotH / (4.0 * HdotV)) + 0.0001, 0.0001);

        let resolution = f32(textureDimensions(inTexture).x); // resolution of source cubemap (per face)
        let saTexel = 4.0 * PI / (6.0 * resolution * resolution);
        let saSample = 1.0 / (f32(SAMPLE_COUNT) * pdf + 0.0001);

        let mipLevel = select(0.5 * log2(saSample / saTexel), 0.0, roughness == 0.0);

        prefilteredColor += textureSampleLevel(inTexture, cubeSampler, L, mipLevel).rgb * NdotL;
        totalWeight += NdotL;
      }
    }

    prefilteredColor = prefilteredColor / totalWeight;
    textureStore(outTexture, id.xy, vec4f(prefilteredColor, 1.0));
  }
`;let Js;const yc=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:4,buffer:{},visibility:GPUShaderStage.COMPUTE}],an=class an extends Ze{static get computePSO(){if(Js)return Js;const e=v.device.createBindGroupLayout({label:"Specular IBL Compute PSO Bind Group Layout",entries:yc});return Js=J.createComputePipeline({label:"Specular IBL Compute PSO",compute:{module:J.createShaderModule(cp),entryPoint:gc},layout:v.device.createPipelineLayout({label:"Specular IBL Compute PSO",bindGroupLayouts:[e]})}),Js}};an.encode=(e,t=128)=>{if(e.depthOrArrayLayers!==6)return void console.error("Need cube texture as a source of IBL Specular");if(e.format!=="rgba16float")return void console.error("Only rgba16float cube textures supported for Specular IBL for now");const r=Lr.createEmptyCubeTexture(t,"Specular IBL Texture",!0),n=e.createView({dimension:"cube"}),i=r.mipLevelCount,o=[{binding:0,resource:n},{binding:1,resource:null},{binding:2,resource:Je.createSampler({minFilter:"linear",magFilter:"linear"})},{binding:3,resource:{buffer:null}},{binding:4,resource:{buffer:null}}],u=v.device.createCommandEncoder({label:"Specular IBL Command Encoder"});v.ENABLE_DEBUG_GROUPS&&u.pushDebugGroup("Begin Specular IBL Generation");const l=u.beginComputePass({label:"Specular IBL Compute Pass"});l.setPipeline(an.computePSO);const m=v.device.createBindGroupLayout({label:"Specular IBL Compute PSO Bind Group Layout",entries:yc});let b=t;for(let d=0;d<i;d++){const x=d/(i-1),g=v.device.createBuffer({label:"Roughness Buffer",mappedAtCreation:!0,size:Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});Y.addBufferBytes(g),new Float32Array(g.getMappedRange()).set(new Float32Array([x])),g.unmap(),o[4].resource={buffer:g};for(let _=0;_<6;_++){const w=v.device.createBuffer({label:"Face Buffer",mappedAtCreation:!0,size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});Y.addBufferBytes(w),new Uint32Array(w.getMappedRange()).set(new Uint32Array([_])),w.unmap(),o[1].resource=r.createView({format:r.format,dimension:"2d",baseMipLevel:d,mipLevelCount:1,baseArrayLayer:_,arrayLayerCount:1}),o[3].resource={buffer:w};const f=v.device.createBindGroup({layout:m,entries:o}),p=8,a=(b+p-1)/p,c=(b+p-1)/p;l.setBindGroup(0,f),l.dispatchWorkgroups(a,c,1)}b/=2}return l.end(),v.ENABLE_DEBUG_GROUPS&&u.popDebugGroup(),v.device.queue.submit([u.finish()]),Y.addTextureBytes(r),r};let Ii=an;var $=(s=>(s[s.Normal=0]="Normal",s[s.AO=1]="AO",s[s.Metallic=2]="Metallic",s[s.Roughness=3]="Roughness",s[s.Reflectance=4]="Reflectance",s[s.Albedo=5]="Albedo",s[s.Depth=6]="Depth",s[s.Velocity=7]="Velocity",s[s.ShadowDepthCascade0=8]="ShadowDepthCascade0",s[s.ShadowDepthCascade1=9]="ShadowDepthCascade1",s[s.BDRF=10]="BDRF",s))($||{});const lp=""+new URL("nx-DA81WUUi.hdr",import.meta.url).href,dp=""+new URL("ny-BiQjxcWx.hdr",import.meta.url).href,hp=""+new URL("nz-BP-ItiR-.hdr",import.meta.url).href,fp=""+new URL("px-DYiCDBPi.hdr",import.meta.url).href,pp=""+new URL("py-CfjHNeO0.hdr",import.meta.url).href,mp=""+new URL("pz-DN7hTcVy.hdr",import.meta.url).href,rt="normal+metallic+roughness texture",xt="albedo+reflectance texture",zs="velocity texture",Ce="depth texture",Ir="directional light depth texture",bc="ssao texture",pr="ssao blur texture",Xe="lighting texture",Fr="taa resolve texture",js="hi-z depth texture",Dr="computed reflections texture",Ur="bloom downscale texture",Jt=new Array(3);Jt[ut.NormalMetallicRoughness]={format:"rgba16float"},Jt[ut.ColorReflectance]={format:"bgra8unorm"},Jt[ut.Velocity]={format:"rg16float"};const gp=[lp,dp,hp,fp,pp,mp],yp=[D.create(5.5,7.5,3.25),D.create(4,6.5,.5),D.create(2.5,6.5,3.25),D.create(1,7.5,.5),D.create(-.5,7.5,3.25),D.create(-2,6.5,.5),D.create(-3.5,6.5,3.25),D.create(-5,7.5,.5),D.create(-6.5,7.5,3.25),D.create(-7.75,6.5,.5),D.create(-10.5,7.5,-.125),D.create(-7.75,7.5,-1),D.create(-6.5,6.5,-4),D.create(-5,6.5,-1),D.create(-3.5,7.5,-4),D.create(-2,7.5,-1),D.create(-.5,6.5,-4),D.create(1,6.5,-1),D.create(2.5,7.5,-4),D.create(4,7.5,-1),D.create(5.5,6.5,-4),D.create(6.5,6.5,-1),D.create(9,6.5,-1),D.create(9.5,7.5,-.125),D.create(9,6.5,.7),D.create(6,6.5,1),D.create(6,7.5,3.25)],xc=D.create(3,20,3),bp=D.create(.1,20,.1),_c=D.create(9.7,3.4,-.35),xp=D.create(9.3,3.4,-.35),_t="fullscreenVertex",zt=`
  ${W.VertexOutput}

  const pos = array(
    vec2(-1.0, -1.0), vec2(3, -1.0), vec2(-1.0, 3),
  );
  const uv = array(
    vec2(0.0, 0.0), vec2(2.0, 0.0), vec2(0.0, 2.0)
  );

  @vertex
  fn ${_t}(
    @builtin(vertex_index) vertexId: u32,
    @builtin(instance_index) instanceId: u32,
  ) -> VertexOutput {
    var out: VertexOutput;
    out.position = vec4f(pos[vertexId], 0.0, 1.0);
    out.uv = uv[vertexId];
    out.instanceId = instanceId;
    return out;
  }
`,_p=/#([^\s]*)(\s*)/gm;class Ac{constructor(e){ee(this,"elseIsValid",!0);ee(this,"branches",[]);this.pushBranch("if",e)}pushBranch(e,t){if(!this.elseIsValid)throw new Error(`#${e} not preceeded by an #if or #elif`);this.elseIsValid=e==="if"||e==="elif",this.branches.push({expression:!!t,string:""})}appendStringToCurrentBranch(...e){for(const t of e)this.branches[this.branches.length-1].string+=t}resolve(){for(const e of this.branches)if(e.expression)return e.string;return""}}function At(s,...e){const t=[];let r=new Ac(!0);r.elseIsValid=!1;const n=(i,o)=>{if(i.index+i[0].length!=o.length)throw new Error(`#${i[1]} must be immediately followed by a template expression (ie: \${value})`)};for(let i=0;i<s.length;++i){const o=s[i],u=o.matchAll(_p);let l=0,m=!1;for(const b of u){switch(r.appendStringToCurrentBranch(o.substring(l,b.index)),b[1]){case"if":n(b,o),m=!0,t.push(r),r=new Ac(e[i]);break;case"elif":n(b,o),m=!0,r.pushBranch(b[1],e[i]);break;case"else":r.pushBranch(b[1],!0),r.appendStringToCurrentBranch(b[2]);break;case"endif":if(!t.length)throw new Error(`#${b[1]} not preceeded by an #if`);const d=r.resolve();r=t.pop(),r.appendStringToCurrentBranch(d,b[2]);break;default:r.appendStringToCurrentBranch(b[0])}l=b.index+b[0].length}l!=o.length&&r.appendStringToCurrentBranch(o.substring(l,o.length)),!m&&e.length>i&&r.appendStringToCurrentBranch(e[i])}if(t.length)throw new Error("Mismatched #if/#endif count");return r.resolve()}const kr=`
  fn encodeNormal(n: vec3f) -> vec2f {
    // return n.xy* 0.5 + 0.5;
    let p = sqrt(n.z * 8 + 8);
    return n.xy / p + 0.5;
  }
 
  fn decodeNormal(enc: vec2f) -> vec3f {
    
    let fenc = enc * 4 - 2;
    let f = dot(fenc, fenc);
    let g = sqrt(1 - f / 4);
    
    return vec3f(
      fenc * g,
      1 - f / 2
    );
  }
`,Bc="fragmentShaderDebugTexture",Ap=new Map([[$.Albedo,"Albedo"],[$.Normal,"View-Space Normal"],[$.AO,"Screen-Space AO"],[$.Metallic,"Metallic"],[$.Roughness,"Roughness"],[$.Reflectance,"Reflectance"],[$.Depth,"Depth"],[$.Velocity,"Velocity"],[$.ShadowDepthCascade0,"Cascade #1"],[$.ShadowDepthCascade1,"Cascade #2"]]);class st{constructor(e){this.type=e,this.$rootEl=document.createElement("div"),this.$headline=document.createElement("h4"),this.$canvas=document.createElement("canvas"),this.$rootEl.classList.add("debug-canvas-wrapper"),this.$canvas.classList.add("debug-canvas"),this.$headline.innerText=Ap.get(e),this.$rootEl.appendChild(this.$headline),this.$rootEl.appendChild(this.$canvas),this.ctx=this.$canvas.getContext("webgpu"),this.ctx.configure({device:v.device,format:v.pixelFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT});const t=[{format:v.pixelFormat}];var r;this.samplerTextureBindGroupLayoutEntries=[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:this.isDepthTexture?"depth":"float"}}],this.samplerTextureBindGroupLayout=v.device.createBindGroupLayout({label:"TextureDebugMesh Sampler + Texture GPUBindGroupLayout",entries:this.samplerTextureBindGroupLayoutEntries}),this.renderPSO=J.createRenderPipeline({label:`Debug Canvas ${e} Render PSO`,vertex:{module:J.createShaderModule(zt),entryPoint:_t},fragment:{module:J.createShaderModule((r=this.type,At`
  ${W.VertexOutput}

  ${kr}

  @group(0) @binding(0) var mySampler: sampler;

  #if ${r===$.Depth||r===$.ShadowDepthCascade0||r===$.ShadowDepthCascade1}
    @group(0) @binding(1) var myTexture: texture_depth_2d;
  #else
    @group(0) @binding(1) var myTexture: texture_2d<f32>;
  #endif

  @fragment
  fn ${Bc}(in: VertexOutput) -> @location(0) vec4<f32> {
    var uv = in.uv;
    uv.y = 1.0 - uv.y;
    var color: vec4f;
    #if ${r===$.Normal}
    color = vec4f(decodeNormal(textureSample(myTexture, mySampler, uv).rg), 1.0);
    // color = vec4f(textureSample(myTexture, mySampler, uv).rgb, 1.0);
    #elif ${r===$.Metallic}
    color = vec4f(textureSample(myTexture, mySampler, uv).bbb, 1.0);
    #elif ${r===$.Roughness}
    color = vec4f(textureSample(myTexture, mySampler, uv).aaa, 1.0);
    #elif ${r===$.Reflectance}
    color = vec4f(textureSample(myTexture, mySampler, uv).a, 0.0, 0.0, 1.0);
    #elif ${r===$.Depth}
    let depth = textureSample(myTexture, mySampler, uv);

    let near: f32 = 0.1; // Example near plane
    let far: f32 = 20.0; // Example far plane

    // Linearize the depth (from clip space depth to linear depth)
    let depth_linear = near * far / (far - depth * (far - near));

    // Normalize the linear depth to [0, 1] (NDC space)
    let depth_ndc = (depth_linear - near) / (far - near);
    color = vec4f(vec3f(depth_ndc), 1);

    #elif ${r===$.ShadowDepthCascade0||r===$.ShadowDepthCascade1}
    let depth = textureSample(myTexture, mySampler, uv);

    let near: f32 = 0.1; // Example near plane
    let far: f32 = 1.0; // Example far plane

    // Linearize the depth (from clip space depth to linear depth)
    let depth_linear = near * far / (far - depth * (far - near));

    // Normalize the linear depth to [0, 1] (NDC space)
    let depth_ndc = (depth_linear - near) / (far - near);
    color = vec4f(vec3f(depth_ndc), 1);
    #elif ${r===$.Velocity}
    color = vec4f(textureSample(myTexture, mySampler, uv).rg * 100, 0, 1);
    #elif ${r===$.BDRF}
    color = vec4f(textureSample(myTexture, mySampler, in.uv).rg, 0, 1);
    #elif ${r===$.Albedo}
    color = vec4f(textureSample(myTexture, mySampler, uv).rgb, 1);
    #elif ${r===$.AO}
    color = vec4f(textureSample(myTexture, mySampler, uv).rrr, 1);
    #else
    color = textureSample(myTexture, mySampler, uv);
    #endif
    return color;
  }
`)),entryPoint:Bc,targets:t},layout:v.device.createPipelineLayout({label:`Debug Canvas ${e} Render PSO Layout`,bindGroupLayouts:[this.samplerTextureBindGroupLayout]})}),this.renderPassDescriptor={label:`Debug Canvas ${e} Render Pass Descriptor`,colorAttachments:[{loadOp:"load",storeOp:"store",view:null}]}}get isDepthTexture(){return this.type===$.Depth||this.type===$.ShadowDepthCascade0||this.type===$.ShadowDepthCascade1}appendTo(e){e.appendChild(this.$rootEl)}setTexture(e,t=e.width,r=e.height){this.debugTexture=e,this.$canvas.width=t,this.$canvas.height=r;let n=0;this.type===$.ShadowDepthCascade0?n=0:this.type===$.ShadowDepthCascade1&&(n=1);const i=[{binding:0,resource:Je.createSampler({magFilter:"linear",minFilter:"linear"})},{binding:1,resource:e.createView({aspect:this.isDepthTexture?"depth-only":"all",baseArrayLayer:n,dimension:"2d"})}];this.samplerTextureBindGroup=v.device.createBindGroup({layout:this.samplerTextureBindGroupLayout,entries:i})}render(e){if(!this.debugTexture)return;this.renderPassDescriptor.colorAttachments[0].view=this.ctx.getCurrentTexture().createView();const t=e.beginRenderPass(this.renderPassDescriptor);v.ENABLE_DEBUG_GROUPS&&t.pushDebugGroup(`Display Debug Texture ${this.type}`),t.setPipeline(this.renderPSO),t.setBindGroup(0,this.samplerTextureBindGroup),t.draw(3),v.ENABLE_DEBUG_GROUPS&&t.popDebugGroup(),t.end()}}var Fi=(s=>(s[s.GBuffer=0]="GBuffer",s[s.Shadow=1]="Shadow",s))(Fi||{});const Bp=new Map([[0,"G-Buffer Debug"],[1,"Shadows Debug"]]);class Ks{constructor(e){this.canvases=new Map,this.$root=Ks.createRootElement(),this.$main=document.createElement("div"),this.$main.classList.add("section");const t=document.createElement("h2");t.textContent=Bp.get(e),t.classList.add("section-headline"),this.$root.appendChild(t),this.$root.appendChild(this.$main)}static createRootElement(){const e=document.createElement("div");return e.classList.add("texture-debug-wrapper"),e}appendTo(e){e.appendChild(this.$root)}setTextureFor(e,t,r=.2*t.width,n=.2*t.height){return this.canvases.get(e).setTexture(t,r,n),this}render(e){for(const t of this.canvases.values())t.render(e)}}class vp extends Ks{constructor(){super(Fi.GBuffer);const e=new st($.Albedo);e.appendTo(this.$main),this.canvases.set($.Albedo,e);const t=new st($.Normal);t.appendTo(this.$main),this.canvases.set($.Normal,t);const r=new st($.Metallic);r.appendTo(this.$main),this.canvases.set($.Metallic,r);const n=new st($.Roughness);n.appendTo(this.$main),this.canvases.set($.Roughness,n);const i=new st($.AO);i.appendTo(this.$main),this.canvases.set($.AO,i);const o=new st($.Reflectance);o.appendTo(this.$main),this.canvases.set($.Reflectance,o);const u=new st($.Depth);u.appendTo(this.$main),this.canvases.set($.Depth,u);const l=new st($.Velocity);l.appendTo(this.$main),this.canvases.set($.Velocity,l)}}class wp extends Ks{constructor(){super(Fi.Shadow);const e=new st($.ShadowDepthCascade0);e.appendTo(this.$main),this.canvases.set($.ShadowDepthCascade0,e);const t=new st($.ShadowDepthCascade1);t.appendTo(this.$main),this.canvases.set($.ShadowDepthCascade1,t)}}const un=class un{constructor(){this.open=!1,this.$root=document.createElement("div"),this.$root.id=un.ROOT_EL_ID,document.body.appendChild(this.$root),this.gbufferDebugSection=new vp,this.gbufferDebugSection.appendTo(this.$root),this.shadowDebugSection=new wp,this.shadowDebugSection.appendTo(this.$root)}reveal(){this.open=!0,this.$root.classList.add("open")}hide(){this.open=!1,this.$root.classList.remove("open")}scrollToShadowSection(){this.shadowDebugSection.$root.scrollIntoView({block:"start",inline:"nearest"})}scrollIntoGbufferSection(){this.gbufferDebugSection.$root.scrollIntoView({block:"start",inline:"nearest"})}setTextureGBufferSection(e,t,r=.2*t.width,n=.2*t.height){return this.open?(this.gbufferDebugSection.setTextureFor(e,t,r,n),this):this}setTextureShadowSection(e,t,r=.2*t.width,n=.2*t.height){return this.open?(this.shadowDebugSection.setTextureFor(e,t,r,n),this):this}render(e){this.open&&(this.gbufferDebugSection.render(e),this.shadowDebugSection.render(e))}};un.ROOT_EL_ID="webgpu-debug-root";let Di=un;const Cp=new Map([[se.CPUTotal,"cpu-total"],[se.GPUTotal,"gpu-total"],[se.FPS,"fps"],[se.VRAM,"vram"],[se.VisibleMeshes,"culled-meshes"],[se.LightsCount,"lights-count"],[se.DeferredRenderPass,"deferred"],[se.DirectionalAmbientLightingRenderPass,"directional-ambient-light"],[se.PointLightsStencilMask,"point-lights-stencil-mask"],[se.PointLightsLighting,"point-lights-lighting"],[se.SSAORenderPass,"ssao"],[se.TransparentRenderPass,"transparent"],[se.ShadowRenderPass,"shadow"],[se.TAAResolveRenderPass,"taa-resolve"],[se.ReflectionRenderPass,"reflection"],[se.BlitRenderPass,"blit"]]),Tp=new Map([[se.CPUTotal,"CPU"],[se.GPUTotal,"GPU"],[se.FPS,"FPS"],[se.VRAM,"VRAM Usage"],[se.VisibleMeshes,"Visible Meshes"],[se.LightsCount,"Lights Count"],[se.DeferredRenderPass,"G-Buffer Render Pass"],[se.DirectionalAmbientLightingRenderPass,"Directional + Ambient Render Pass"],[se.PointLightsStencilMask,"Point Lights Stencil Mask Pass"],[se.PointLightsLighting,"Point Lights Render Pass"],[se.SSAORenderPass,"SSAO Render Pass"],[se.TransparentRenderPass,"Transparent Render Pass"],[se.ShadowRenderPass,"Directional Shadow Render Pass"],[se.TAAResolveRenderPass,"TAA Resolve Render Pass"],[se.ReflectionRenderPass,"Reflection Render Pass"],[se.BlitRenderPass,"Blit Render Pass"]]),co=class co{constructor(){this.$renderPassTimingDisplayEls=new Map,this.$root=document.createElement("div"),this.$root.id="timings-debug-container",this.$root.classList.add("fadable","hidden"),document.body.appendChild(this.$root);for(const e of gd){const t=Cp.get(e),r=document.createElement("div");r.id=`${t}-debug-timing`,r.classList.add("timing-container"),this.$root.appendChild(r);const n=document.createElement("div");n.classList.add("timing-label"),n.innerText=`${Tp.get(e)}:`,r.appendChild(n);const i=document.createElement("div");i.classList.add("timing-value"),r.appendChild(i);const o={root:r,label:n,value:i};this.$renderPassTimingDisplayEls.set(e,o)}}toggleVisibility(){this.$root.classList.toggle("hidden")}setDisplayValue(e,t){return this.$renderPassTimingDisplayEls.get(e).value.innerText=t,this}};co.NOT_AVAILABLE_STR="N/A";let Ui=co;const Sp=yt(Ot(W.Light).structs.Light);class mr extends sr{constructor(e){super(),this.lightType=e,this._color=D.create(1,1,0),this._intensity=1;const t=Ot(W.Light);this.lightsStorageView=yt(t.structs.Light),this.lightsStorageView.set({color:this._color,position:this.position,lightType:md.get(e),intensity:1})}static get STRUCT_BYTE_SIZE(){return Sp.arrayBuffer.byteLength}get intensity(){return this._intensity}set intensity(e){this._intensity=e,this.lightsStorageView.set({intensity:e})}get color(){return this.getColor()}set color(e){this.setColor(e[0],e[1],e[2])}setColor(e,t,r){this._color[0]=e,this._color[1]=t,this._color[2]=r,this.lightsStorageView.set({color:this._color})}setColorAsVec3(e){D.copy(e,this._color),this.lightsStorageView.set({color:this._color})}getColor(){return this._color}setPosition(e,t,r){return super.setPosition(e,t,r),this.lightsStorageView.set({position:this.position}),this}setPositionAsVec3(e){return super.setPositionAsVec3(e),this.lightsStorageView.set({position:this.position}),this}setPositionX(e){return super.setPositionX(e),this.lightsStorageView.set({position:this.position}),this}setPositionY(e){return super.setPositionY(e),this.lightsStorageView.set({position:this.position}),this}setPositionZ(e){return super.setPositionZ(e),this.lightsStorageView.set({position:this.position}),this}}class ki extends mr{constructor(){super(It.Directional)}}class jt extends mr{get radius(){return this._radius}set radius(e){this._radius=e,this.lightsStorageView.set({radius:e})}constructor(){super(It.Point),this.intensity=1,this.radius=1}}class dt extends jt{static get bindGroupLayout(){if(this._bindGroupLayout)return this._bindGroupLayout;const e=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return this._bindGroupLayout=v.device.createBindGroupLayout({label:"Camera Face Culled Point Light Bind Group Layout",entries:e}),this._bindGroupLayout}updateGPUBuffer(){v.device.queue.writeBuffer(this.gpuBuffer,0,this.lightsStorageView.arrayBuffer)}constructor(){super(),this.gpuBuffer=v.device.createBuffer({label:"Camera Face Culled Point Light GPU Buffer",size:mr.STRUCT_BYTE_SIZE,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y.addBufferBytes(this.gpuBuffer),this.lightsStorageView.set({type:1,intensity:1,radius:1,color:D.create(1,1,1),position:D.create(0,1,0)}),this.updateGPUBuffer();const e=[{binding:0,resource:{buffer:this.gpuBuffer}}];this.bindGroup=v.device.createBindGroup({label:"Camera Face Culled Point Light Bind Group",entries:e,layout:dt.bindGroupLayout})}}class Ep{constructor(){this.pointLights=[],this.cameraFaceCulledPointLights=[],this.directionalLights=[],this.allLights=[]}get lightsCount(){return this.allLights.length}get pointLightsCount(){return this.pointLights.length}get directionalLightsCount(){return this.directionalLights.length}updateGPUBuffer(){if(!this.allLights.length)return void console.warn("No lights, skip creating GPUBuffer");this.gpuBuffer&&(Y.removeBufferBytes(this.gpuBuffer),this.gpuBuffer.destroy()),this.gpuBuffer=v.device.createBuffer({label:"Lights GPU Buffer",size:mr.STRUCT_BYTE_SIZE*this.allLights.length,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE}),Y.addBufferBytes(this.gpuBuffer);let e=0;for(let t=0;t<this.directionalLights.length;t++)v.device.queue.writeBuffer(this.gpuBuffer,e*mr.STRUCT_BYTE_SIZE,this.directionalLights[t].lightsStorageView.arrayBuffer),e++;for(let t=0;t<this.pointLights.length;t++)v.device.queue.writeBuffer(this.gpuBuffer,e*mr.STRUCT_BYTE_SIZE,this.pointLights[t].lightsStorageView.arrayBuffer),e++;return this}addLight(e){return e instanceof dt?this.cameraFaceCulledPointLights.push(e):e instanceof jt?this.pointLights.push(e):e instanceof ki&&this.directionalLights.push(e),this.allLights.push(e),this}removeLight(e){const t=r=>r.id!==e.id;return e instanceof dt?this.cameraFaceCulledPointLights=this.cameraFaceCulledPointLights.filter(t):e instanceof jt?this.pointLights=this.pointLights.filter(t):e instanceof ki&&(this.directionalLights=this.directionalLights.filter(t)),this.allLights=this.allLights.filter(t),this}render(e){throw new Error("Needs implementation")}}const Kt=yt(Ot(W.Particle).structs.Particle),We=class We{constructor({radius:e,position:t,velocity:r,lifeSpeed:n,life:i}={radius:1,position:D.create(0,3,0),velocity:D.create(0,1,0),lifeSpeed:1,life:0}){this.radius=e,this.position=t,this.origPosition=t,this.velocity=r,this.lifeSpeed=n,this.life=i}};We.STRUCT_BYTE_SIZE=Kt.arrayBuffer.byteLength,We.STRUCT_FLOATS_COUNT=We.STRUCT_BYTE_SIZE/Float32Array.BYTES_PER_ELEMENT,We.RADIUS_OFFSET=Kt.views.radius.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.POSITION_OFFSET=Kt.views.position.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.ORIG_POSITION_OFFSET=Kt.views.origPosition.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.VELOCITY_OFFSET=Kt.views.velocity.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.LIFE_OFFSET=Kt.views.life.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.LIFE_SPEED_OFFSET=Kt.views.lifeSpeed.byteOffset/Float32Array.BYTES_PER_ELEMENT;let Ye=We;const vc="vertexMain",wc="fragMain",Mp=`
  ${W.Particle}
  ${W.Light}
  ${W.Camera}

  struct VertexOut {
    @builtin(position) position: vec4f,
    @location(0) uv: vec2f,
    @location(1) @interpolate(flat) instanceId: u32,
  };

  @group(0) @binding(0) var<uniform> camera: Camera;

  @group(1) @binding(0) var<storage, read> particles: array<Particle>;
  @group(1) @binding(1) var<storage, read> lights: array<Light>;

  override ANIMATED_PARTICLES_OFFSET_START: u32;
  override CURVE_PARTICLES_OFFSET: u32;

  const positions = array<vec2f, 4>(
    vec2f(-1.0, -1.0), 
    vec2f(1.0, -1.0),  
    vec2f(-1.0, 1.0),   
    vec2f(1.0, 1.0),   
  );

  const uvs = array<vec2f, 4>(
    vec2f(0.0, 1.0),
    vec2f(1.0, 1.0),
    vec2f(0.0, 0.0),
    vec2f(1.0, 0.0),
  );

  @vertex
  fn ${vc}(
    @builtin(vertex_index) vertexId: u32,
    @builtin(instance_index) instanceId: u32,
  ) -> VertexOut {
    let p = particles[instanceId];
    let particlePosition = p.position;
    let particleRadius = select(p.radius - p.radius * p.life, p.radius, instanceId >= CURVE_PARTICLES_OFFSET);
    // let particleRadius = p.radius;
    let uv = uvs[vertexId];
    var out: VertexOut;
    out.position = camera.projectionViewMatrix * vec4f(particlePosition, 1);
    let aspect = f32(camera.viewportWidth) / f32(camera.viewportHeight);
    out.position += vec4f(positions[vertexId].xy * vec2f(particleRadius, particleRadius * aspect), 0, 0);
    out.instanceId = instanceId;
    out.uv = uv;
    return out;
  }

  @fragment
  fn ${wc}(
    in: VertexOut
  ) -> @location(0) vec4f {
    let light = &lights[in.instanceId + ANIMATED_PARTICLES_OFFSET_START];
    let d = distance(in.uv, vec2f(0.5));
    let mask = 1.0 - smoothstep(0.2, 0.5, d);
    if (mask < 0.2) {
      discard;
    }
    let lightColor = light.color;
    return vec4f(light.color * mask * 0.8, 1);
  }
`,Cc="updatePointLights",Pp=`
  ${W.Particle}
  ${W.Light}

  struct SimSettings {
    time: f32,
    timeDelta: f32,
  };

  @group(0) @binding(0) var<storage, read_write> particles: array<Particle>;
  @group(0) @binding(1) var<storage, read_write> lights: array<Light>;
  @group(0) @binding(2) var<uniform> simSettings: SimSettings;
  @group(0) @binding(3) var<storage, read> linePointPositions: array<vec4f>;
  @group(0) @binding(4) var<uniform> fireParticlesRevealFactor: f32;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;
  override ANIMATED_PARTICLES_OFFSET_START: u32;
  override FIREWORK_PARTICLES_OFFSET: u32;
  override FIREWORK_PARTICLES_COUNT: u32;
  override CURVE_PARTICLES_OFFSET: u32;
  override CURVE_PARTICLES_COUNT: u32;
  override CURVE_POSITIONS_COUNT: u32;
  
  @must_use
  fn noise(p: vec3f) -> f32 {
    return fract(
      sin(dot(p, vec3f(12.9898, 78.233, 45.164))) * 43758.5453
    );
  }

  @must_use
  fn random(seed: f32) -> f32 {
    return fract(sin(seed * 12.9898) * 43758.5453);
  }

  // Curl noise for more natural 3D fluid-like motion
  fn curlNoise(p: vec3<f32>) -> vec3<f32> {
    let eps = 0.1;
    
    let nx = noise(p + vec3<f32>(eps, 0.0, 0.0));
    let ny = noise(p + vec3<f32>(0.0, eps, 0.0));
    let nz = noise(p + vec3<f32>(0.0, 0.0, eps));
    
    let x = ny - noise(p - vec3<f32>(eps, 0.0, 0.0));
    let y = nz - noise(p - vec3<f32>(0.0, eps, 0.0));
    let z = nx - noise(p - vec3<f32>(0.0, 0.0, eps));
    
    return vec3<f32>(x, y, z) / (2.0 * eps);
  }

  fn interpolateLinePoint(t: f32) -> vec3f {
    let totalCount = CURVE_POSITIONS_COUNT;
    let segmentLength = 1.0 / f32(totalCount - 1u);
    let baseIndex = u32(t / segmentLength);
    let localT = fract(t / segmentLength);
    let safeIndex = min(baseIndex, totalCount - 2u);
    let start = linePointPositions[safeIndex];
    let end = linePointPositions[safeIndex + 1u];
    return mix(start, end, localT).xyz;
  }

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)
  fn ${Cc}(
    @builtin(global_invocation_id) tid : vec3u
  ) {
    let idx = tid.x;
    let particle = &particles[idx];
    let light = &lights[idx + ANIMATED_PARTICLES_OFFSET_START];

    particle.life += particle.lifeSpeed * simSettings.timeDelta;

    if (particle.life >= 1) {
      particle.position = particle.origPosition;
      particle.life = 0;
    }

    if (idx >= FIREWORK_PARTICLES_OFFSET && idx < FIREWORK_PARTICLES_COUNT) {
      let turbulence = curlNoise(
        particle.position * 0.05 + 
        vec3<f32>(0.0, simSettings.time * 0.05, 0.0)
      ) * 0.2;
      particle.position += (particle.velocity + turbulence) * simSettings.timeDelta;
      light.intensity = saturate((1 - particle.life) * fireParticlesRevealFactor);
      particle.radius = 0.025 * fireParticlesRevealFactor;
      // light.radius *= fireParticlesRevealFactor;
      // light.intensity *= fireParticlesRevealFactor;
    }

    if (idx >= CURVE_PARTICLES_OFFSET && idx < CURVE_PARTICLES_OFFSET + CURVE_PARTICLES_COUNT) {
      particle.position = interpolateLinePoint(particle.life) + particle.velocity;  
    }

    if (idx >= CURVE_PARTICLES_OFFSET + CURVE_PARTICLES_COUNT) {
      particle.position = vec3f(
        particle.life * 15 - 7.5,
        cos(particle.life + particle.life * particle.velocity.y * 30) * 1.2 + 3.5,
        sin(particle.life + particle.life * particle.velocity.y * 30) * 1.075 + particle.velocity.x
      );
      let fadeIn = smoothstep(0.0, 0.1, particle.life);
      let fadeOut = 1.0 - smoothstep(0.9, 1.0, particle.life);
      light.intensity = 0.5 * fadeIn * fadeOut;
      light.radius = 1 * fadeIn * fadeOut;
    }
    light.position = particle.position;

  }
`,Xs=[D.create(3.9,3,.9),D.create(3.9,3,-1.5),D.create(-4.95,3,.9),D.create(-4.95,3,-1.5)],Rp=[D.create(3.9,3,1.15),D.create(3.9,3,-1.75),D.create(-4.95,3,1.15),D.create(-4.95,3,-1.75)],Nr=D.scale(D.create(1,.01,.01),10),de=class de extends Ep{constructor(e){super(),this.particles=[],this.mainFireLights=[],this.particlesSimSettingsArr=new Float32Array(2).fill(0),this.render2ndFloorParticles=!0;const t=new ki;t.setPositionAsVec3(xc),t.setColor(.2156,.2627,.3333),t.intensity=0,this.addLight(t),this.mainDirLight=t;const r=new dt;r.radius=0,r.intensity=0,r.setPositionAsVec3(Xs[0]),r.setColorAsVec3(Nr),r.updateGPUBuffer(),this.addLight(r),this.mainFireLights.push(r);const n=new dt;n.radius=0,n.intensity=0,n.setPositionAsVec3(Xs[1]),n.setColorAsVec3(Nr),n.updateGPUBuffer(),this.addLight(n),this.mainFireLights.push(n);const i=new dt;i.intensity=0,i.radius=0,i.setPositionAsVec3(Xs[2]),i.setColorAsVec3(Nr),i.updateGPUBuffer(),this.addLight(i),this.mainFireLights.push(i);const o=new dt;o.intensity=0,o.radius=0,o.setPositionAsVec3(Xs[3]),o.setColorAsVec3(Nr),o.updateGPUBuffer(),this.addLight(o),this.mainFireLights.push(o);for(let p=0;p<de.PARTICLES_PER_FIRE;p++)for(let a=0;a<4;a++){const c=new jt,h=D.add(Rp[a],D.create(.1*(2*Math.random()-1),0,.1*(2*Math.random()-1)));c.radius=.5,c.intensity=.1,c.setPositionAsVec3(h),c.setColorAsVec3(Nr),this.addParticleLight(c,.025)}const u=v.device.createBuffer({label:"Lighting System Curve Points GPU Buffer",size:4*e.length*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0});Y.addBufferBytes(u);const l=new Float32Array(u.getMappedRange());for(let p=0;p<e.length;p++)l[4*p+0]=e[p][0],l[4*p+1]=e[p][1],l[4*p+2]=e[p][2],l[4*p+3]=1;u.unmap();const m=D.create();for(let p=0;p<de.PARTICLES_PER_CURVE;p++){const a=new jt;a.setColor(3*Math.random()+1,3*Math.random()+1,3*Math.random()+1),a.setPositionAsVec3(m),a.radius=2,a.intensity=1;const c=p/de.PARTICLES_PER_CURVE;this.addParticleLight(a,.02,c,.01,D.random(.5))}this.particlesLength=this.particles.length;for(let p=0;p<de.PARTICLES_PER_CORRIDOR;p++){const a=new jt;a.setColor(3*Math.random()+1,3*Math.random()+1,3*Math.random()+1),a.setPositionAsVec3(m),a.radius=1,this.addParticleLight(a,.02,p/de.PARTICLES_PER_CORRIDOR,.01,D.create(3.125,1,0))}for(let p=0;p<de.PARTICLES_PER_CORRIDOR;p++){const a=new jt;a.setColor(3*Math.random()+1,3*Math.random()+1,3*Math.random()+1),a.setPositionAsVec3(m),a.radius=1,this.addParticleLight(a,.02,p/de.PARTICLES_PER_CORRIDOR,.01,D.create(-3.775,-1,0))}console.log(this.lightsCount),this.updateGPUBuffer(),this.updateParticlesBuffer(),this.particleSimSettingsBuffer=v.device.createBuffer({label:"Particles Update Sim Settings",size:2*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y.addBufferBytes(this.particleSimSettingsBuffer),this.fireParticlesRevealBuffer=v.device.createBuffer({label:"Fire Particles Reveal Factor Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),Y.addBufferBytes(this.fireParticlesRevealBuffer),new Float32Array(this.fireParticlesRevealBuffer.getMappedRange()).set([0]),this.fireParticlesRevealBuffer.unmap();const b=[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{}}],d=v.device.createBindGroupLayout({label:"Lights Compute Bind Group Layout",entries:b}),x=[{binding:0,resource:{buffer:this.particlesGPUBuffer}},{binding:1,resource:{buffer:this.gpuBuffer}},{binding:2,resource:{buffer:this.particleSimSettingsBuffer}},{binding:3,resource:{buffer:u}},{binding:4,resource:{buffer:this.fireParticlesRevealBuffer}}];this.computeBindGroup=v.device.createBindGroup({label:"Lights Compute Bind Group",entries:x,layout:d});const g=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}],_=v.device.createBindGroupLayout({label:"Lights Render Bind Group Layout",entries:g}),w=[{binding:0,resource:{buffer:this.particlesGPUBuffer}},{binding:1,resource:{buffer:this.gpuBuffer}}];this.renderBindGroup=v.device.createBindGroup({label:"Lights Render Bind Group",entries:w,layout:_}),this.computePSO=J.createComputePipeline({label:"Update Lights Compute PSO",layout:v.device.createPipelineLayout({label:"Lights Compute PSO Layout",bindGroupLayouts:[d]}),compute:{entryPoint:Cc,module:J.createShaderModule(Pp,"Update Lights Shader Module"),constants:{WORKGROUP_SIZE_X:de.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:de.COMPUTE_WORKGROUP_SIZE_Y,ANIMATED_PARTICLES_OFFSET_START:1,FIREWORK_PARTICLES_OFFSET:0,FIREWORK_PARTICLES_COUNT:4*de.PARTICLES_PER_FIRE,CURVE_PARTICLES_OFFSET:4*de.PARTICLES_PER_FIRE,CURVE_PARTICLES_COUNT:de.PARTICLES_PER_CURVE,CURVE_POSITIONS_COUNT:e.length}}});const f=J.createShaderModule(Mp,"Render Lights Shader Module");this.renderPSO=J.createRenderPipeline({label:"Render Lights PSO",layout:v.device.createPipelineLayout({label:"Lights Render PSO Layout",bindGroupLayouts:[J.defaultCameraPlusLightsBindGroupLayout,_]}),vertex:{entryPoint:vc,module:f,constants:{CURVE_PARTICLES_OFFSET:4*de.PARTICLES_PER_FIRE}},fragment:{entryPoint:wc,module:f,targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{operation:"add",srcFactor:"one",dstFactor:"one"}}}],constants:{ANIMATED_PARTICLES_OFFSET_START:1}},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less"}}),this.particleIndexBuffer=v.device.createBuffer({label:"Particle Index Buffer",size:6*Uint16Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),Y.addBufferBytes(this.particleIndexBuffer),new Uint16Array(this.particleIndexBuffer.getMappedRange()).set([0,1,3,0,2,3]),this.particleIndexBuffer.unmap()}uploadMainDirLightToGPU(){v.device.queue.writeBuffer(this.gpuBuffer,0,this.mainDirLight.lightsStorageView.arrayBuffer)}set sunIntensity(e){this.mainDirLight.intensity=e,this.uploadMainDirLightToGPU()}set sunPositionX(e){this.mainDirLight.setPositionX(e),this.uploadMainDirLightToGPU()}set sunPositionY(e){this.mainDirLight.setPositionY(e),this.uploadMainDirLightToGPU()}set sunPositionZ(e){this.mainDirLight.setPositionZ(e),this.uploadMainDirLightToGPU()}addParticleLight(e,t=.05,r=0,n=1.5*Math.random()+.35,i=D.create(0,.5,0)){super.addLight(e);const o=new Ye({radius:t,position:e.position,velocity:i,lifeSpeed:n,life:r});return this.particles.push(o),this}updateParticlesBuffer(){this.particlesGPUBuffer&&(Y.removeBufferBytes(this.particlesGPUBuffer),this.particlesGPUBuffer.destroy()),this.particlesGPUBuffer=v.device.createBuffer({label:"Light Particles GPU Buffer",size:Ye.STRUCT_BYTE_SIZE*this.particles.length,mappedAtCreation:!0,usage:GPUBufferUsage.STORAGE}),Y.addBufferBytes(this.particlesGPUBuffer);const e=new Float32Array(this.particlesGPUBuffer.getMappedRange());for(let t=0;t<this.particles.length;t++){const r=t*Ye.STRUCT_FLOATS_COUNT,n=r+Ye.POSITION_OFFSET,i=r+Ye.ORIG_POSITION_OFFSET,o=r+Ye.VELOCITY_OFFSET,u=r+Ye.LIFE_OFFSET,l=r+Ye.LIFE_SPEED_OFFSET,m=r+Ye.RADIUS_OFFSET;e[n+0]=this.particles[t].position[0],e[n+1]=this.particles[t].position[1],e[n+2]=this.particles[t].position[2],e[i+0]=this.particles[t].origPosition[0],e[i+1]=this.particles[t].origPosition[1],e[i+2]=this.particles[t].origPosition[2],e[o+0]=this.particles[t].velocity[0],e[o+1]=this.particles[t].velocity[1],e[o+2]=this.particles[t].velocity[2],e[u]=this.particles[t].life,e[l]=this.particles[t].lifeSpeed,e[m]=this.particles[t].radius}this.particlesGPUBuffer.unmap(),this.particles=null}set fireParticlesRevealFactor(e){this.updateFireParticlesRevealBuffer(e);for(const t of this.mainFireLights)t.radius=de.MAIN_FIRE_LIGHT_RADIUS*e,t.intensity=de.MAIN_FIRE_LIGHT_INTENSITY*e,t.updateGPUBuffer()}updateFireParticlesRevealBuffer(e){v.device.queue.writeBuffer(this.fireParticlesRevealBuffer,0,new Float32Array([e]))}update(e){this.particlesSimSettingsArr[0]=v.elapsedTimeMs,this.particlesSimSettingsArr[1]=v.deltaTimeMs,v.device.queue.writeBuffer(this.particleSimSettingsBuffer,0,this.particlesSimSettingsArr);const t=e.beginComputePass({label:"Update Lights Compute Encoder"});t.setPipeline(this.computePSO),t.setBindGroup(0,this.computeBindGroup);const r=Math.ceil(this.allLights.length/de.COMPUTE_WORKGROUP_SIZE_X);t.dispatchWorkgroups(r,1,1),t.end()}render(e){e.setPipeline(this.renderPSO),e.setBindGroup(1,this.renderBindGroup),e.setIndexBuffer(this.particleIndexBuffer,Ae.INDEX_FORMAT),e.drawIndexed(6,this.render2ndFloorParticles?this.particlesLength:4*de.PARTICLES_PER_FIRE)}};de.COMPUTE_WORKGROUP_SIZE_X=64,de.COMPUTE_WORKGROUP_SIZE_Y=1,de.MAIN_FIRE_LIGHT_RADIUS=3,de.MAIN_FIRE_LIGHT_INTENSITY=.3,de.PARTICLES_PER_FIRE=64,de.PARTICLES_PER_CURVE=150,de.PARTICLES_PER_CORRIDOR=32;let Ni=de;class ht{constructor({vertexShaderSrc:e,vertexShaderEntryFn:t,vertexBuffers:r=_e.defaultLayout,fragmentShaderSrc:n,fragmentShaderEntryFn:i,bindGroupLayouts:o=[J.defaultCameraBindGroupLayout,J.defaultModelBindGroupLayout,J.defaultModelMaterialBindGroupLayout],constants:u={},targets:l=[],depthStencilState:m={format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"},primitive:b={cullMode:"back",topology:"triangle-list"},debugLabel:d}){const x={label:d,layout:v.device.createPipelineLayout({bindGroupLayouts:o}),vertex:{module:J.createShaderModule(e,`${d} material vertex shader module`),entryPoint:t,buffers:r}};if(i&&n&&l.length){const g=J.createShaderModule(n,`${d} material fragment shader module`);x.fragment={module:g,entryPoint:i,targets:l,constants:u}}m&&(x.depthStencil=m),b&&(x.primitive=b),this.renderPSO=J.createRenderPipeline(x)}bind(){v.bindRenderPSO(this.renderPSO)}}const Tc="vertexMain",Sc="fragmentMain",Ec=`
  ${W.VertexInput}
  ${W.VertexOutput}
  ${W.GBufferOutput}
  ${W.Camera}
  ${W.ModelUniform}

  @group(${ue.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(1) @binding(0) var inTexture: texture_cube<f32>;
  @group(1) @binding(1) var inSampler: sampler;
  @group(1) @binding(2) var bayerDitherTexture: texture_2d<f32>;
  @group(1) @binding(3) var bayerDitherSampler: sampler;

  @vertex
  fn ${Tc}(in: VertexInput) -> VertexOutput {
    var out: VertexOutput;

    var viewMatrix = camera.viewMatrix;
    viewMatrix[3] = vec4f(0, 0, 0, 1);
    let projViewMatrix = camera.projectionMatrix * viewMatrix;
    let position = in.position;
    out.position = (projViewMatrix * position).xyww;
    // hijack to compute uvs for frag shader
    out.viewNormal = 0.5 * (in.position.xyz + vec3(1.0, 1.0, 1.0));
    out.uv = in.uv;
    return out;
  }

  @fragment
  fn ${Sc}(in: VertexOutput) -> @location(0) vec4f {
    var cubemapVec = in.viewNormal - vec3(0.5);
    var color = textureSampleLevel(inTexture, inSampler, cubemapVec, 4); //7.8);
    let o = textureSample(bayerDitherTexture, bayerDitherSampler, in.position.xy / 8.0).r / 32.0 - (1.0 / 128.0);
    color.r += o;
    color.g += o;
    color.b += o;
    return vec4f(color.rgb, 1.0);
  }
`;class Gp extends Ls{constructor(e=1,t=1,r=1,n=1){super(),this.width=e,this.height=t,this.widthSegments=r,this.heightSegments=n;const i=.5*e,o=.5*t,u=r+1,l=n+1,m=Math.floor(r),b=Math.floor(n),d=e/r,x=t/n,g=[],_=[],w=[],f=[];for(let p=0;p<l;p++){const a=p*x-o;for(let c=0;c<u;c++){const h=c*d-i;_.push(D.create(h,-a,0)),w.push(D.create(0,0,1)),f.push(Se.create(c/m,1-p/b))}}for(let p=0;p<b;p++)for(let a=0;a<m;a++){const c=a+u*p,h=a+u*(p+1),y=a+1+u*(p+1),A=a+1+u*p;g.push(c,h,A);const C=new fr(c,h,A,_[c],_[h],_[A],w[c],w[h],w[A],f[c],f[h],f[A]);this.faces.push(C),g.push(h,y,A);const R=new fr(h,y,A,_[h],_[y],_[A],w[h],w[y],w[A],f[h],f[y],f[A]);this.faces.push(R)}this.createBuffersWithTangentsManually(g.length,_,w,f,new Uint16Array(g))}}class Mc extends Ls{constructor(e=1,t=32,r=16,n=0,i=2*Math.PI,o=0,u=Math.PI){super(),this.radius=e,this.widthSegments=t,this.heightSegments=r,this.phiStart=n,this.phiLength=i,this.thetaStart=o,this.thetaLength=u,t=Math.max(3,Math.floor(t)),r=Math.max(2,Math.floor(r));const l=Math.min(o+u,Math.PI);let m=0;const b=[],d=D.create(),x=D.create(),g=Se.create(),_=[],w=[],f=[],p=[];for(let a=0;a<=r;a++){const c=[],h=a/r;let y=0;a===0&&o===0?y=.5/t:a===r&&l===Math.PI&&(y=-.5/t);for(let A=0;A<=t;A++){const C=A/t;d[0]=-e*Math.cos(n+C*i)*Math.sin(o+h*u),d[1]=e*Math.cos(o+h*u),d[2]=e*Math.sin(n+C*i)*Math.sin(o+h*u),_.push(D.clone(d)),D.copy(d,x),D.normalize(x,x),w.push(D.clone(x)),g[0]=C+y,g[1]=1-h,f.push(Se.clone(g)),c.push(m++)}b.push(c)}for(let a=0;a<r;a++)for(let c=0;c<t;c++){const h=b[a][c+1],y=b[a][c],A=b[a+1][c],C=b[a+1][c+1];if(a!==0||o>0){p.push(h,y,C);const K=_[h],X=_[y],j=_[C],z=w[h],q=w[y],Z=w[C],te=f[h],re=f[y],fe=f[C],pe=new fr(h,y,C,K,X,j,z,q,Z,te,re,fe);this.faces.push(pe)}(a!==r-1||l<Math.PI)&&p.push(y,A,C);const R=_[y],U=_[A],k=_[C],T=w[y],S=w[A],P=w[C],L=f[y],F=f[A],O=f[C],H=new fr(y,A,C,R,U,k,T,S,P,L,F,O);this.faces.push(H)}this.createBuffersWithTangentsManually(p.length,_,w,f,new Uint16Array(p))}}let Vi,Hi,Ji,zi;const nt=Object.freeze({get defaultPlaneGeometry(){return Vi||(Vi=new Gp,Vi)},get unitCubeGeometry(){return Hi||(Hi=new nc,Hi)},get unitSphereGeometry(){return Ji||(Ji=new Mc,Ji)},get pointLightSphereGeometry(){return zi||(zi=new Mc(1,9,9),zi)}});class Lp extends Ae{set texture(e){this.setTexture(e)}setTexture(e){if(e.depthOrArrayLayers!==6)return;this._texture=e;const t=[{binding:0,resource:e.createView({dimension:"cube"})},{binding:1,resource:Je.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear"})},{binding:2,resource:Be.bayerDitherPatternTexture.createView()},{binding:3,resource:Je.createSampler({addressModeU:"repeat",addressModeV:"repeat",minFilter:"linear"})}];this.texSamplerBindGroup=v.device.createBindGroup({label:"Skybox Sampler + Texture Bind Group",layout:this.texSamplerBindGroupLayout,entries:t})}constructor(){super(nt.unitCubeGeometry),this.label="Skybox";const e=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.FRAGMENT},{binding:1,sampler:{type:"filtering"},visibility:GPUShaderStage.FRAGMENT},{binding:2,texture:{sampleType:"float"},visibility:GPUShaderStage.FRAGMENT},{binding:3,sampler:{},visibility:GPUShaderStage.FRAGMENT}];this.texSamplerBindGroupLayout=v.device.createBindGroupLayout({label:"Skybox Sampler + Texture Bind Group Layout",entries:e});const t=new ht({debugLabel:"Skybox Material",vertexShaderSrc:Ec,vertexShaderEntryFn:Tc,fragmentShaderSrc:Ec,fragmentShaderEntryFn:Sc,targets:[{format:"rgba16float"}],bindGroupLayouts:[J.defaultCameraBindGroupLayout,this.texSamplerBindGroupLayout],depthStencilState:{format:v.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal"},primitive:{cullMode:"front"}});this.setMaterial(t,V.Skybox)}preRender(e){super.preRender(e),this._texture&&e.setBindGroup(1,this.texSamplerBindGroup)}render(e){this._texture&&super.render(e)}}class Te{constructor(e,t,r){if(this.type=e,this.width=t,this.height=r,this.enabled=!0,this.inputTextureNames=[],this.outputTextureNames=[],this.outTextures=[],this.inputTextureViews=[],this.resultBuffers=[],this.state="free",this.gpuTimingAverage=new cs,this.name=Cr.get(e),v.supportsGPUTimestampQuery){const n=Cr.get(e);this.querySet=v.device.createQuerySet({label:`Timestamp Query for Render Pass: ${n}`,type:"timestamp",count:2}),this.resolveBuffer=v.device.createBuffer({label:`Timestamp Query Resolve GPUBuffer for Render Pass: ${n}`,size:16,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),Y.addBufferBytes(this.resolveBuffer)}}destroy(){var e;for(const t of this.outTextures)Y.removeTextureBytes(t),t.destroy();this.inputTextureViews.length=0,(e=this.querySet)==null||e.destroy(),this.resolveBuffer&&(Y.removeBufferBytes(this.resolveBuffer),this.resolveBuffer.destroy()),this.inputTextureNames.length=0,this.inputTextureViews.length=0;for(const t of this.resultBuffers)Y.removeBufferBytes(t),t.destroy()}resetInputs(){return this.inputTextureNames.length=0,this.inputTextureViews.length=0,this}clearInputTextures(){return this.inputTextureNames.length=0,this.inputTextureViews.length=0,this}clearOutputTextures(){return this.outputTextureNames.length=0,this}addInputTexture(e){return this.inputTextureNames.push(e),this}addInputTextures(e){return this.inputTextureNames.push(...e),this}addOutputTexture(e){return this.outputTextureNames.push(e),this}addOutputTextures(e){return this.outputTextureNames.push(...e),this}createRenderPassDescriptor(){throw new Error("Needs implementation")}createComputePassDescriptor(){throw new Error("Needs implementation")}augmentRenderPassDescriptorWithTimestampQuery(e){return v.supportsGPUTimestampQuery&&(e.timestampWrites={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}),e}resolveTiming(e){if(!v.supportsGPUTimestampQuery)return;this.state="wait for result";const t=this.resultBuffers.pop();t?this.resultBuffer=t:(this.resultBuffer=v.device.createBuffer({label:`Timestamp Query Result Buffer for render pass: ${this.name}`,size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),Y.addBufferBytes(this.resultBuffer)),e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),e.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,this.resultBuffer.size)}async getStartAndEndTimings(){if(!v.supportsGPUTimestampQuery)return[0,0];const e=this.resultBuffer;this.state="free",await e.mapAsync(GPUMapMode.READ);const t=new BigInt64Array(e.getMappedRange()),r=[Number(t[0]),Number(t[1])];return e.unmap(),this.resultBuffers.push(e),r}async getTimingResult(){if(!v.supportsGPUTimestampQuery)return{avgValue:0,timings:[0,0]};const e=await this.getStartAndEndTimings(),t=(e[1]-e[0])/1e6;return this.gpuTimingAverage.addSample(t),{timings:e,avgValue:this.gpuTimingAverage.get()}}setDebugCamera(e){this.debugCamera=e}toggleDebugCamera(e){this.cameraBindGroup=v.device.createBindGroup({label:`Camera Bind Group for: ${Cr.get(this.type)}`,layout:J.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:e?this.debugCamera.gpuBuffer:this.camera.gpuBuffer}}]})}setCamera(e){return this.camera=e,this.cameraBindGroup=v.device.createBindGroup({label:`Camera Bind Group for: ${Cr.get(this.type)}`,layout:J.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:e.gpuBuffer}}]}),this}postRender(e){this.resolveTiming(e)}onFrameEnd(){}render(e,t,r){throw new Error("Needs implementation")}}const Pc="blit",Op=`
  @group(0) @binding(0) var bloomTexture: texture_2d<f32>;
  @group(0) @binding(1) var sceneTexture: texture_2d<f32>;
  @group(0) @binding(2) var<uniform> bloomMixFactor: f32;
  @group(0) @binding(3) var<uniform> time: f32;
  @group(0) @binding(4) var<uniform> revealFactor: f32;

  @must_use
  fn ACESFilm(x: vec3f) -> vec3f {
    let v = x;
    let a = 2.51f;
    let b = 0.03f;
    let c = 2.43f;
    let d = 0.59f;
    let e = 0.14f;
    return saturate((v * (a * x + b)) / (x * (c * x + d) + e));
  }

  fn rand (co: vec2f) -> f32 {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
  }
  
  fn transition(p: vec2f, progress: f32, fromColor: vec3f, toColor: vec3f) -> vec3f {
    let size = vec2(10.0);
    let smoothness = 0.5;
    let r = rand(floor(size * p));
    let m = smoothstep(0.0, -smoothness, r - (progress * (1.0 + smoothness)));
    return mix(fromColor, toColor, m);
  }

  @fragment
  fn ${Pc}(@builtin(position) coord : vec4f) -> @location(0) vec4f {
    var bloomColor = textureLoad(bloomTexture, vec2i(floor(coord.xy)), 0).xyz;
    var color = textureLoad(sceneTexture, vec2i(floor(coord.xy)), 0).xyz;

    let texSize = vec2f(textureDimensions(sceneTexture));
    // bloomColor = select(color, bloomColor, bloomColor.r > 0.);

    color = mix(color, bloomColor, bloomMixFactor);
    // color = mix(color, bloomColor, 1);

    color = ACESFilm(color.rgb);
    color = pow(color, vec3f(1.0 / 2.2));

    let uv = coord.xy / texSize;
    let aspect = texSize.x / texSize.y;
    let timeFactor = 1.0;
    let noise = vec3f(rand(vec2f(uv.x + time * timeFactor, uv.y * aspect + time * timeFactor))) * 0.1;
    color = transition(uv, revealFactor, noise, color);
    return vec4f(vec3(color), 1.0);
  }
`,zr=class zr extends Te{destroy(){Y.removeBufferBytes(this.bloomMixFactorBuffer),Y.removeBufferBytes(this.timeBuffer),Y.removeBufferBytes(this.revealFactorBuffer),this.bloomMixFactorBuffer.destroy(),this.timeBuffer.destroy(),this.revealFactorBuffer.destroy()}set bloomEnabled(e){v.device.queue.writeBuffer(this.bloomMixFactorBuffer,0,new Float32Array([e?zr.BLOOM_MIX_FACTOR:0]))}revealWithAnimation(e=500,t="quad_Out"){new es({durationMS:e,easeName:t,onUpdate:r=>{this.updateRevealFactor(r)}}).start()}updateRevealFactor(e){v.device.queue.writeBuffer(this.revealFactorBuffer,0,new Float32Array([e]))}constructor(e,t,r=!1){super(V.Blit,e,t);const n=J.createShaderModule(zt),i=J.createShaderModule(Op),o=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{}}];this.texturesBindGroupLayout=v.device.createBindGroupLayout({label:"GBuffer Textures Bind Group",entries:o});const u={layout:v.device.createPipelineLayout({bindGroupLayouts:[this.texturesBindGroupLayout]}),vertex:{module:n,entryPoint:_t},fragment:{module:i,entryPoint:Pc,targets:[{format:"bgra8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"}};this.renderPSO=J.createRenderPipeline(u),this.bloomMixFactorBuffer=v.device.createBuffer({label:"Bloom Mix Factor GPU Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),Y.addBufferBytes(this.bloomMixFactorBuffer),new Float32Array(this.bloomMixFactorBuffer.getMappedRange()).set([zr.BLOOM_MIX_FACTOR]),this.bloomMixFactorBuffer.unmap(),this.timeBuffer=v.device.createBuffer({label:"Bloom Elapsed Time Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y.addBufferBytes(this.timeBuffer),this.revealFactorBuffer=v.device.createBuffer({label:"Blit Loading Reveal Factor Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),Y.addBufferBytes(this.revealFactorBuffer),new Float32Array(this.revealFactorBuffer.getMappedRange()).set([r?1:0]),this.revealFactorBuffer.unmap()}createRenderPassDescriptor(){return this.renderPassDescriptor?this.renderPassDescriptor:(this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:[{view:null,loadOp:"load",storeOp:"store"}],label:"Blit Pass"}),this.renderPassDescriptor)}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView());const o=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:{buffer:this.bloomMixFactorBuffer}},{binding:3,resource:{buffer:this.timeBuffer}},{binding:4,resource:{buffer:this.revealFactorBuffer}}];this.textureBindGroup=v.device.createBindGroup({layout:this.texturesBindGroupLayout,entries:o})}v.device.queue.writeBuffer(this.timeBuffer,0,new Float32Array([v.elapsedTimeMs]));const n=this.createRenderPassDescriptor();n.colorAttachments[0].view=v.canvasContext.getCurrentTexture().createView();const i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.bindRenderPSO(this.renderPSO),i.setBindGroup(0,this.textureBindGroup),i.draw(6),i.end(),this.postRender(e),[]}};zr.BLOOM_MIX_FACTOR=.035;let ji=zr;const Rc="main",Ip=`
  @group(0) @binding(0) var srcTexture: texture_2d<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var srcSampler: sampler;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${Rc}(
    @builtin(global_invocation_id) tid : vec3u,
  ) {
    let outTexSize = textureDimensions(outTexture);

    if (any(tid.xy >= outTexSize)) {
      return;
    }

    let srcTexSize = vec2f(textureDimensions(srcTexture));
    
    let texelSize = vec2f(1.0) / srcTexSize;
    let x = texelSize.x;
    let y = texelSize.y;

    let texCoords = vec2f((f32(tid.x) + 0.5) / f32(outTexSize.x), (f32(tid.y) + 0.5) / f32(outTexSize.y));

    // Take 13 samples around current texel:
    // a - b - c
    // - j - k -
    // d - e - f
    // - l - m -
    // g - h - i
    // === ('e' is the current texel) ===
    let a = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y + 2 * y), 0).rgb;
    let b = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y + 2 * y), 0).rgb;
    let c = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y + 2 * y), 0).rgb;

    let d = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y), 0).rgb;
    let e = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y), 0).rgb;
    let f = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y), 0).rgb;

    let g = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y - 2 * y), 0).rgb;
    let h = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y - 2 * y), 0).rgb;
    let i = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y - 2 * y), 0).rgb;

    let j = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - x, texCoords.y + y), 0).rgb;
    let k = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + x, texCoords.y + y), 0).rgb;
    let l = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - x, texCoords.y - y), 0).rgb;
    let m = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + x, texCoords.y - y), 0).rgb;

    // Apply weighted distribution:
    // 0.5 + 0.125 + 0.125 + 0.125 + 0.125 = 1
    // a,b,d,e * 0.125
    // b,c,e,f * 0.125
    // d,e,g,h * 0.125
    // e,f,h,i * 0.125
    // j,k,l,m * 0.5
    // This shows 5 square areas that are being sampled. But some of them overlap,
    // so to have an energy preserving downsample we need to make some adjustments.
    // The weights are the distributed, so that the sum of j,k,l,m (e.g.)
    // contribute 0.5 to the final color output. The code below is written
    // to effectively yield this sum. We get:
    // 0.125*5 + 0.03125*4 + 0.0625*4 = 1
    var downsample = e * 0.125;
    downsample += (a + c + g + i) * 0.03125;
    downsample += (b + d + f + h) * 0.0625;
    downsample += (j + k + l + m) * 0.125;
    
    textureStore(outTexture, tid.xy, vec4f(downsample, 1.0));
    // textureStore(outTexture, tid.xy, vec4f(texCoords, 0.0, 1.0));
  }
`,Tt=class Tt extends Te{constructor(e,t){super(V.BloomDownsample,e,t),this.mipLevelCount=Pt(e,t),this.outTextures.push(v.device.createTexture({label:"Bloom Downscale Texture",size:{width:e,height:t},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST,format:"rgba16float",mipLevelCount:this.mipLevelCount})),Y.addTextureBytes(this.outTextures[0]),this.sampler=Je.createSampler({label:"Bloom Downscale Sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"});const r=[{binding:0,texture:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{format:"rgba16float"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Bloom Downscale Bind Group Layout",entries:r}),this.computePSO=J.createComputePipeline({label:"Bloom Downscale Render PSO",layout:v.device.createPipelineLayout({label:"Bloom Downscale Render PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:Rc,module:J.createShaderModule(Ip),constants:{WORKGROUP_SIZE_X:Tt.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:Tt.COMPUTE_WORKGROUP_SIZE_Y}}})}render(e,t,r){e.copyTextureToTexture({texture:r[0],mipLevel:0},{texture:this.outTextures[0],mipLevel:0},{width:this.width,height:this.height});const n=[{binding:0,resource:null},{binding:1,resource:null},{binding:2,resource:this.sampler}],i=e.beginComputePass({label:"Bloom Downscale Compute Pass"});i.setPipeline(this.computePSO);for(let o=1;o<this.mipLevelCount;o++){n[0].resource=this.outTextures[0].createView({baseMipLevel:o-1,mipLevelCount:1}),n[1].resource=this.outTextures[0].createView({baseMipLevel:o,mipLevelCount:1});const u=v.device.createBindGroup({label:`Bloom Downscale Bind Group for Mip ${o}`,entries:n,layout:this.bindGroupLayout});i.setBindGroup(0,u);const l=this.outTextures[0].width/Math.pow(2,o),m=this.outTextures[0].height/Math.pow(2,o),b=Math.ceil(l/Tt.COMPUTE_WORKGROUP_SIZE_X),d=Math.ceil(m/Tt.COMPUTE_WORKGROUP_SIZE_Y);i.dispatchWorkgroups(b,d,1)}return i.end(),this.postRender(e),this.outTextures}};Tt.COMPUTE_WORKGROUP_SIZE_X=8,Tt.COMPUTE_WORKGROUP_SIZE_Y=8;let Ki=Tt;const Gc="main",Fp=`
  ${W.VertexOutput}

  @group(0) @binding(0) var srcTexture: texture_2d<f32>;
  @group(0) @binding(1) var srcSampler: sampler;
  @group(0) @binding(2) var<uniform> filterRadius: f32;

  @fragment
  fn ${Gc}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let srcSize = vec2f(textureDimensions(srcTexture));
    let aspect = srcSize.x / srcSize.y;

    let x = filterRadius;
    let y = filterRadius * aspect;

    let texCoord = vec2f(in.uv.x, 1 - in.uv.y);

    let a = textureSample(srcTexture, srcSampler, vec2f(texCoord.x - x, texCoord.y + y)).rgb;
    let b = textureSample(srcTexture, srcSampler, vec2f(texCoord.x,     texCoord.y + y)).rgb;
    let c = textureSample(srcTexture, srcSampler, vec2f(texCoord.x + x, texCoord.y + y)).rgb;

    let d = textureSample(srcTexture, srcSampler, vec2f(texCoord.x - x, texCoord.y)).rgb;
    let e = textureSample(srcTexture, srcSampler, vec2f(texCoord.x,     texCoord.y)).rgb;
    let f = textureSample(srcTexture, srcSampler, vec2f(texCoord.x + x, texCoord.y)).rgb;

    let g = textureSample(srcTexture, srcSampler, vec2(texCoord.x - x, texCoord.y - y)).rgb;
    let h = textureSample(srcTexture, srcSampler, vec2(texCoord.x,     texCoord.y - y)).rgb;
    let i = textureSample(srcTexture, srcSampler, vec2(texCoord.x + x, texCoord.y - y)).rgb;

    var upsample = e * 4.0;
    upsample += (b + d + f + h) * 2.0;
    upsample += (a + c + g + i);
    upsample *= 1.0 / 16.0;

    return vec4f(upsample, 1.0);
  }
`;class Dp extends Te{destroy(){Y.removeBufferBytes(this.filterRadiusBuffer),this.filterRadiusBuffer.destroy()}set bloomFilterRadius(e){v.device.queue.writeBuffer(this.filterRadiusBuffer,0,new Float32Array([e]))}constructor(e,t){super(V.BloomUpsample,e,t),this.sampler=Je.createSampler({label:"Bloom Downscale Sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"}),this.filterRadiusBuffer=v.device.createBuffer({label:"Bloom Upscale Filter Radius GPU Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),Y.addBufferBytes(this.filterRadiusBuffer),new Float32Array(this.filterRadiusBuffer.getMappedRange()).set([.0035]),this.filterRadiusBuffer.unmap();const r=[{binding:0,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Bloom Upscale Bind Group Layout",entries:r}),this.renderPSO=J.createRenderPipeline({label:"Bloom Upscale Render PSO",layout:v.device.createPipelineLayout({label:"Bloom Upscale Render PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),vertex:{entryPoint:_t,module:J.createShaderModule(zt)},fragment:{entryPoint:Gc,module:J.createShaderModule(Fp),targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{operation:"add",srcFactor:"one",dstFactor:"one"}}}]}})}render(e,t,r){const n=[{binding:0,resource:null},{binding:1,resource:this.sampler},{binding:2,resource:{buffer:this.filterRadiusBuffer}}],i={colorAttachments:[{loadOp:"load",storeOp:"store",view:null}]};for(let o=Math.ceil(.5*Pt(r[0].width,r[0].height))-1;o>0;o--){i.label=`Bloom Upscale Mip Level ${o}`,i.colorAttachments[0].view=r[0].createView({baseMipLevel:o-1,mipLevelCount:1});const u=e.beginRenderPass(i);u.setPipeline(this.renderPSO),n[0].resource=r[0].createView({baseMipLevel:o,mipLevelCount:1});const l=v.device.createBindGroup({label:`Bloom Upscale Bind Group for Mip ${o}`,entries:n,layout:this.bindGroupLayout});u.setBindGroup(0,l),u.draw(3),u.end()}return this.postRender(e),r}}const Lc=s=>At`
  @must_use
  fn DistributionGGX(viewSpaceNormal: vec3f, H: vec3f, roughness: f32) -> f32 {
    let a = roughness*roughness;
    let a2 = a*a;
    let NdotH = max(dot(viewSpaceNormal, H), 0.0);
    let NdotH2 = NdotH*NdotH;

    let nom   = a2;
    var denom = (NdotH2 * (a2 - 1.0) + 1.0);
    denom = PI * denom * denom + 0.0001;

    return nom / denom;
}

  @must_use
  fn GeometrySchlickGGX(NdotV: f32, roughness: f32) -> f32 {
    let r = (roughness + 1.0);
    let k = (r * r) / 8;

    let nom   = NdotV;
    let denom = NdotV * (1.0 - k) + k + 0.0001;
    return nom / denom;
  }

  @must_use
  fn GeometrySmith(viewSpaceNormal: vec3f, V: vec3f, L: vec3f, roughness: f32) -> f32 {
    let NdotV = max(dot(viewSpaceNormal, V), 0.0);
    let NdotL = max(dot(viewSpaceNormal, L), 0.0);
    let ggx2 = GeometrySchlickGGX(NdotV, roughness);
    let ggx1 = GeometrySchlickGGX(NdotL, roughness);
    return ggx1 * ggx2;
  }

  @must_use
  fn FresnelSchlick(cosTheta: f32, F0: vec3f) -> vec3f {
    return F0 + (1.0 - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);
  }

  @must_use
  fn FresnelSchlickRoughness(cosTheta: f32, F0: vec3f, roughness: f32) -> vec3f {
    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);
  }

  @must_use
  fn PBRLighting(
    material: Material,
    instanceId: u32,
    viewSpacePos: vec3f,
    viewSpaceNormal: vec3f,
    V: vec3f,
    shadow: f32,
    opacity: f32,
    #if ${s===V.PointLightsNonCulledLighting}
      lightPosition: vec3f,
      lightRadius: f32,
      lightColor: vec3f,
      lightIntensity: f32,
    #elif ${s===V.DirectionalAmbientLighting}
      diffuseIBLTexture: texture_cube<f32>,
      specularIBLTexture: texture_cube<f32>,
      bdrfLutTexture: texture_2d<f32>,
      envTexSampler: sampler,
    #endif
  ) -> vec4f {
    let albedo = material.albedo;
    let F0 = mix(vec3f(0.04), albedo, material.metallic);
    
    var Lo = vec3f(0.0);
    let albedoOverPi = albedo / PI;

    let roughness = material.roughness;
    let roughnessSq = roughness * roughness;
    let roughnessQuad = roughnessSq * roughnessSq;

    let metallic = material.metallic;

    #if ${s===V.DirectionalAmbientLighting}
    let light = &lightsBuffer[instanceId];
    // let isPointLight = light.lightType == ${It.Point};
    let lightViewSpacePos = (camera.viewMatrix * vec4f(light.position, 0.0)).xyz;
    
    let lightColor = light.color;
    let lightIntensity = light.intensity;
    let L = normalize(lightViewSpacePos);
    let attenuation = 1.0;

    // return vec4f(vec3f(shadow), 1.0)

    #elif ${s===V.PointLightsLighting}
    let light = &lightsBuffer[instanceId];
    let lightColor = light.color;
    let lightIntensity = light.intensity;
    let lightViewSpacePos = (camera.viewMatrix * vec4f(light.position, 1.0)).xyz;
    let dist = lightViewSpacePos.xyz - viewSpacePos.xyz;
    let d = length(dist);
    var attenuation = 1 - smoothstep(0.0, light.radius, d);
    attenuation *= attenuation;
    let L = normalize(dist);
    #elif ${s===V.PointLightsNonCulledLighting}
    let lightViewSpacePos = (camera.viewMatrix * vec4f(lightPosition, 1)).xyz;
    let dist = lightViewSpacePos.xyz - viewSpacePos.xyz;
    let d = length(dist);
    var attenuation = 1 - smoothstep(0.0, lightRadius, d);
    attenuation *= attenuation;
    let L = normalize(dist);
    #endif

    
    let H = normalize(V + L);
    
    let radiance = lightColor * attenuation * lightIntensity;

    let NDF = DistributionGGX(viewSpaceNormal, H, roughnessQuad);
    let G = GeometrySmith(viewSpaceNormal, V, L, roughness);
    var F = FresnelSchlick(max(dot(H, V), 0.0), F0);

    let numerator = NDF * G * F;
    // let denominator = 4.0 * (NdotV * NdotL, 0.0001); // + 0.0001 to prevent divide by zero
    let denominator = 4.0 * max(dot(viewSpaceNormal, V), 0.0) * max(dot(viewSpaceNormal, L), 0.0) + 0.0001; // + 0.0001 to prevent divide by zero

    var specular = numerator / denominator;

      // kS is equal to Fresnel
    var kS = F;
    // for energy conservation, the diffuse and specular light can't
    // be above 1.0 (unless the surface emits light); to preserve this
    // relationship the diffuse component (kD) should equal 1.0 - kS.
    var kD = vec3f(1.0 - kS);
    // multiply kD by the inverse metalness such that only non-metals
    // have diffuse lighting, or a linear blend if partly metal (pure metals
    // have no diffuse light).
    kD *= 1.0 - metallic;

    let NdotL = max(dot(viewSpaceNormal, L), 0.0); 

    // add to outgoing radiance Lo
    Lo += (kD * albedoOverPi + specular) * radiance * NdotL * shadow; // * light.opacity;  // note that we already multiplied the BRDF by the Fresnel
  
    #if ${s===V.DirectionalAmbientLighting}
      let worldSpaceNorm = (camera.inverseViewMatrix * vec4f(viewSpaceNormal, 0)).xyz;
      let worldSpaceV = (camera.inverseViewMatrix * vec4f(V, 0)).xyz;
      let irradiance = textureSampleLevel(diffuseIBLTexture, envTexSampler, worldSpaceNorm, 0).rgb;
      kS = FresnelSchlickRoughness(max(dot(viewSpaceNormal, V), 0.0), F0, roughness); 
      kD = 1.0 - kS;
      kD *= 1.0 - metallic;
      // let ambientIBL = kD * irradiance;
      // let ambientFactor = 0.2;

      let R = reflect(-worldSpaceV, worldSpaceNorm);
      let MAX_REFLECTION_LOD = 8.0;
      let prefilteredColor = vec3f(
        textureSampleLevel(
          specularIBLTexture,
          envTexSampler,
          R,
          material.roughness * MAX_REFLECTION_LOD
        ).rgb
      );

      let uv = vec2f(max(dot(worldSpaceNorm, worldSpaceV), 0.0), roughness);
      let envBDRF = textureSample(bdrfLutTexture, envTexSampler, uv).rg;
      specular = prefilteredColor * (F * envBDRF.x + envBDRF.y);
      // specular = mix(specular, specular * 0.2, 1 - shadow);

      let diffuse = irradiance * albedo;
      let ambient = (kD * diffuse + specular * metallic) * material.ambientOcclusion;

      // let ambient = vec3f(0.03) * albedo * material.ambientOcclusion;
      
      var color = ambient + Lo;
    #else
      var color = Lo;
    #endif

    return vec4f(color, opacity);
  }
`,Re=class Re extends Te{constructor(e,t,r){super(V.Shadow,t,r),this.sceneDirectionalLight=e,this.type=V.Shadow,this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:[],depthStencilAttachment:{view:null,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},label:"Shadow Render Pass Cascade #0"}),this.outTextures.push(v.device.createTexture({label:"Directional Shadow Depth Texture",format:"depth32float",size:{width:Re.TEXTURE_SIZE,height:Re.TEXTURE_SIZE,depthOrArrayLayers:Re.TEXTURE_CASCADES_COUNT},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING})),Y.addTextureBytes(this.outTextures[0]),this.shadowTextureCascade0=this.outTextures[0].createView({baseArrayLayer:0,arrayLayerCount:1,dimension:"2d"}),this.shadowTextureCascade1=this.outTextures[0].createView({baseArrayLayer:1,arrayLayerCount:1,dimension:"2d"});const n=Ot(W.Camera);this.shadowCameraCascade0BufferUniformValues=yt(n.structs.Camera),this.shadowCameraCascade1BufferUniformValues=yt(n.structs.Camera),this.shadowCameraCascade0GPUBuffer=v.device.createBuffer({label:"Shadow Camera GPU Buffer Cascade #0",size:this.shadowCameraCascade0BufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y.addBufferBytes(this.shadowCameraCascade0GPUBuffer),this.shadowCameraCascade1GPUBuffer=v.device.createBuffer({label:"Shadow Camera GPU Buffer Cascade #1",size:this.shadowCameraCascade1BufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),Y.addBufferBytes(this.shadowCameraCascade1GPUBuffer),this.shadowCameraCascade0BindGroup=v.device.createBindGroup({label:"Shadow Camera Bind Group Cascade #0",layout:J.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:this.shadowCameraCascade0GPUBuffer}}]}),this.shadowCameraCascade1BindGroup=v.device.createBindGroup({label:"Shadow Camera Bind Group Cascade #1",layout:J.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:this.shadowCameraCascade1GPUBuffer}}]});const i=Ot(W.ShadowCascade);this.shadowCascadeView=yt(i.structs.ShadowCascade),this.shadowCascadesBuffer=v.device.createBuffer({label:"Directional Shadow Cascade ProjView Matrices",size:Re.TEXTURE_CASCADES_COUNT*this.shadowCascadeView.arrayBuffer.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Y.addBufferBytes(this.shadowCascadesBuffer)}set shadowMapSize(e){const t=this.outTextures[0];this.outTextures[0]=v.device.createTexture({label:"Directional Shadow Depth Texture",format:"depth32float",size:{width:e,height:e,depthOrArrayLayers:Re.TEXTURE_CASCADES_COUNT},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.shadowTextureCascade0=this.outTextures[0].createView({baseArrayLayer:0,arrayLayerCount:1,dimension:"2d"}),this.shadowTextureCascade1=this.outTextures[0].createView({baseArrayLayer:1,arrayLayerCount:1,dimension:"2d"}),Y.addTextureBytes(this.outTextures[0]),v.device.queue.onSubmittedWorkDone().then(()=>{Y.removeTextureBytes(t),t.destroy()})}destroy(){super.destroy(),Y.removeBufferBytes(this.shadowCascadesBuffer),Y.removeBufferBytes(this.shadowCameraCascade0GPUBuffer),Y.removeBufferBytes(this.shadowCameraCascade1GPUBuffer),this.shadowCascadesBuffer.destroy(),this.shadowCameraCascade0GPUBuffer.destroy(),this.shadowCameraCascade1GPUBuffer.destroy()}setCamera(e){return this.camera=e,this}getLightSpaceMatrix(){const e=this.camera.frustumCornersWorldSpace,t=D.create(0,0,0);for(let f=0;f<e.length;f++){const p=e[f];D.add(t,p,t)}D.divScalar(t,e.length,t);const r=D.create(),n=D.create();D.normalize(this.sceneDirectionalLight.position,n),D.add(t,n,r);const i=Q.create();Q.lookAt(r,t,us.UP_VECTOR,i);let o=Number.MAX_VALUE,u=-o,l=Number.MAX_VALUE,m=-l,b=Number.MAX_VALUE,d=-b;for(let f=0;f<e.length;f++){const p=e[f],a=Br.create();D.transformMat4(p,i,a),o=Math.min(o,a[0]),u=Math.max(u,a[0]),l=Math.min(l,a[1]),m=Math.max(m,a[1]),b=Math.min(b,a[2]),d=Math.max(d,a[2])}const x=-b;b=-d,d=x;const g=(d-b)/2;b-=5*g,d+=5*g;const _=Q.create();Q.ortho(o,u,l,m,b,d,_);const w=Q.create();return Q.mul(_,i,w),w}render(e,t,r){const n=this.camera.near,i=this.camera.far;this.camera.near=.1,this.camera.far=Re.TEXTURE_CASCADE_FAR_DISTANCES[0],this.camera.updateProjectionMatrix();const o=this.getLightSpaceMatrix();this.shadowCascadeView.set({projViewMatrix:o,distance:this.camera.far}),v.device.queue.writeBuffer(this.shadowCascadesBuffer,0,this.shadowCascadeView.arrayBuffer),this.shadowCameraCascade0BufferUniformValues.set({projectionViewMatrix:o}),v.device.queue.writeBuffer(this.shadowCameraCascade0GPUBuffer,0,this.shadowCameraCascade0BufferUniformValues.arrayBuffer),this.renderPassDescriptor.depthStencilAttachment.view=this.shadowTextureCascade0,this.renderPassDescriptor.label="Shadow Render Pass Cascade #0";const u=e.beginRenderPass(this.renderPassDescriptor);v.setActiveRenderPass(this.type,u),u.setBindGroup(ue.CameraPlusOptionalLights,this.shadowCameraCascade0BindGroup),v.ENABLE_DEBUG_GROUPS&&u.pushDebugGroup("Render Shadow Cascade #0"),t.renderOpaqueNodes(u),t.renderTransparentNodes(u),v.ENABLE_DEBUG_GROUPS&&u.popDebugGroup(),u.end(),this.camera.near=Re.TEXTURE_CASCADE_FAR_DISTANCES[0],this.camera.far=Re.TEXTURE_CASCADE_FAR_DISTANCES[1],this.camera.updateProjectionMatrix();const l=this.getLightSpaceMatrix();this.shadowCascadeView.set({projViewMatrix:l,distance:this.camera.far}),v.device.queue.writeBuffer(this.shadowCascadesBuffer,1*this.shadowCascadeView.arrayBuffer.byteLength,this.shadowCascadeView.arrayBuffer),this.shadowCameraCascade1BufferUniformValues.set({projectionViewMatrix:l}),v.device.queue.writeBuffer(this.shadowCameraCascade1GPUBuffer,0,this.shadowCameraCascade1BufferUniformValues.arrayBuffer),this.renderPassDescriptor.depthStencilAttachment.view=this.shadowTextureCascade1,this.renderPassDescriptor.label="Shadow Render Pass Cascade #1";const m=e.beginRenderPass(this.renderPassDescriptor);return v.setActiveRenderPass(this.type,m),v.ENABLE_DEBUG_GROUPS&&m.pushDebugGroup("Render Shadow Cascade #1"),m.setBindGroup(ue.CameraPlusOptionalLights,this.shadowCameraCascade1BindGroup),t.renderOpaqueNodes(m),t.renderTransparentNodes(m),v.ENABLE_DEBUG_GROUPS&&m.popDebugGroup(),m.end(),this.camera.near=n,this.camera.far=i,this.camera.updateProjectionMatrix(),this.postRender(e),this.outTextures}};Re.TEXTURE_SIZE=4098,Re.TEXTURE_CASCADES_COUNT=2,Re.TEXTURE_CASCADE_FAR_DISTANCES=[6,17,200];let Ys=Re;const Ws="integrateMain",Xi=s=>{return At`
  ${W.VertexOutput}
  ${W.Light}
  ${W.Camera}
  ${W.Material}
  ${W.ShadowCascade}
  ${W.CommonHelpers}
  ${W.MathHelpers}

  ${Lc(s)}
  ${`

  @must_use
  fn ShadowLayerIdxCalculate(
    worldPos: vec3f,
    camera: Camera,
    shadowCascades: array<ShadowCascade, 2>
  ) -> i32 {
  let fragPosViewSpace = camera.viewMatrix * vec4f(worldPos, 1.0);
  let depthValue = abs(fragPosViewSpace.z);

  var layer: i32 = -1;
  let cascadesCount: i32 = 2;
    for (var i: i32 = 0; i < cascadesCount; i++) {
      if (depthValue < shadowCascades[i].distance) {
        layer = i;
        break;
      }
    }

    if (layer == -1) {
      layer = 1;
    }
    return layer;
  }

  fn ShadowCalculate(
    worldPos: vec3f,
    N: vec3f,
    lightPosition: vec3f,
    camera: Camera,
    shadowTextureWidth: f32,
    shadowTextureHeight: f32,
    shadowCascades: array<ShadowCascade, 2>,
    shadowDepthTexture: texture_depth_2d_array,
    shadowDepthSampler: sampler_comparison
  ) -> f32 {

    let layer = ShadowLayerIdxCalculate(
      worldPos,
      camera,
      shadowCascades
    );
    let fragPosLightSpace = shadowCascades[layer].projViewMatrix * vec4f(worldPos, 1.0);

    // perform perspective divide
    var projCoords = fragPosLightSpace.xyz / fragPosLightSpace.w;
    projCoords.x = projCoords.x * 0.5 + 0.5;
    projCoords.y = projCoords.y * 0.5 + 0.5;
    projCoords.y = 1 -  projCoords.y;
    let uv = projCoords.xy;

    var shadow = 0.0;

    let texelSize = 1 / vec2f(shadowTextureWidth, shadowTextureHeight);

    for (var y = -2; y <= 2; y++) {
      for (var x = -2; x <= 2; x++) {
        let uv = projCoords.xy + vec2f(f32(x), f32(y)) * texelSize;
        let pcfDepth = textureSampleCompareLevel(
          shadowDepthTexture,
          shadowDepthSampler,
          uv,
          layer,
          projCoords.z
        );
        shadow += pcfDepth;
      }
    }

    shadow /= 16;

    return shadow;
  }
`}
  ${kr}

  struct LightSettings {
    debugLights: f32,
    debugShadowCascadeLayer: f32
  };

  #if ${s===V.DirectionalAmbientLighting}
  const SHADOW_MAP_SIZE: f32 = ${Ys.TEXTURE_SIZE};
  #endif

  ${e=s,At`
  @group(0) @binding(0) var normalTexture: texture_2d<f32>;
  @group(0) @binding(1) var colorTexture: texture_2d<f32>;
  @group(0) @binding(2) var depthTexture: texture_depth_2d;
  @group(0) @binding(3) var aoTexture: texture_2d<f32>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  
  #if ${e===V.PointLightsLighting||e===V.PointLightsStencilMask||e===V.DirectionalAmbientLighting}
  @group(0) @binding(5) var<storage, read> lightsBuffer: array<Light>;
  @group(0) @binding(6) var<uniform> debugLightsInfo: LightSettings;
  #endif

  #if ${e===V.PointLightsNonCulledLighting}
  @group(1) @binding(0) var<uniform> cameraCulledPointLight: Light;
  #endif

  #if ${e===V.DirectionalAmbientLighting}
  @group(1) @binding(0) var<storage, read> shadowCascades: array<ShadowCascade, 2>;
  @group(1) @binding(1) var shadowMapSampler: sampler_comparison;
  @group(1) @binding(2) var shadowDepthTexture: texture_depth_2d_array;
  @group(1) @binding(3) var diffuseIBLTexture: texture_cube<f32>;
  @group(1) @binding(4) var specularIBLTexture: texture_cube<f32>;
  @group(1) @binding(5) var bdrfLutTexture: texture_2d<f32>;
  @group(1) @binding(6) var envTexSampler: sampler;
  @group(1) @binding(7) var<uniform> ssaoMixFactor: f32;
  #endif
`}

  @fragment
  fn ${Ws}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    let encodedN = textureLoad(normalTexture, pixelCoords, 0).rg;
    let metallic = textureLoad(normalTexture, pixelCoords, 0).b;
    let roughness = textureLoad(normalTexture, pixelCoords, 0).a;
    let viewSpaceNormal = decodeNormal(encodedN);
    
    let albedo = textureLoad(colorTexture, pixelCoords, 0).xyz;
    let depth = textureLoad(depthTexture, pixelCoords, 0);
    
    let aoPixelCoords = vec2i(floor(coord.xy));
    let ao = textureLoad(aoTexture, aoPixelCoords, 0).r;
    // return vec4f(ao, ao, ao, 1);

    // return vec4f(viewSpaceNormal, 1.0);
    

    var material = Material();
    material.albedo = albedo;
    material.roughness = roughness;
    // return vec4f(vec3f(1 - metallic), 1);
    material.metallic = metallic;
    // material.ambientOcclusion = select(1.0, ao, pixelCoords.x > i32(textureDimensions(normalTexture).x / 2));

    #if ${s===V.DirectionalAmbientLighting}
    material.ambientOcclusion = mix(1.0, ao, ssaoMixFactor);
    #endif
    
    let viewSpacePos = calcViewSpacePos(camera, coord.xy, depth);
    
    let V = normalize(-viewSpacePos);

    #if ${s===V.DirectionalAmbientLighting}
    let worldSpacePos = calcWorldPos(camera, coord.xy, depth);
    let shadowLayerIdx = ShadowLayerIdxCalculate(worldSpacePos, camera, shadowCascades);
    let r = select(0.0, 1.0, shadowLayerIdx == 0);
    let g = select(0.0, 1.0, shadowLayerIdx == 1);
    let b = select(0.0, 1.0, shadowLayerIdx == 2);
    if (debugLightsInfo.debugShadowCascadeLayer == 1) {
      material.albedo = vec3f(r, g, b);
    }
    // TODO: Directional light is expected to be at index 0
    // Write a better mechanism for quering it
    let lightPosition = (camera.viewMatrix * (vec4f(lightsBuffer[0].position, 0))).xyz;
    // let shadow = 1.0;
    let shadow = ShadowCalculate(
      worldSpacePos,
      viewSpaceNormal,
      lightPosition,
      camera,
      SHADOW_MAP_SIZE,
      SHADOW_MAP_SIZE,
      shadowCascades,
      shadowDepthTexture,
      shadowMapSampler
    );
    #else
    let shadow = 1.0;
    #endif

    let opacity = 1.0;

    var color = PBRLighting(
      material,
      in.instanceId,
      viewSpacePos,
      viewSpaceNormal,
      V,
      shadow,
      opacity,
      #if ${s===V.PointLightsNonCulledLighting}
      cameraCulledPointLight.position,
      cameraCulledPointLight.radius,
      cameraCulledPointLight.color,
      cameraCulledPointLight.intensity,
      #elif ${s==V.DirectionalAmbientLighting}
      diffuseIBLTexture,
      specularIBLTexture,
      bdrfLutTexture,
      envTexSampler
      #endif
    );

    #if ${s===V.PointLightsLighting}
    let debugColor = vec4f(1.0, 0.0, 0.0, 1.0);
    return mix(color, debugColor, debugLightsInfo.debugLights);
    #else
    return color;
    #endif
  }
`;var e},lo=class lo extends Te{constructor(e,t,r){super(e,t,r),this.gbufferCommonBindGroupLayoutEntries=[],this.gbufferTexturesBindGroupEntries=[],this._debugLightsMask=!1,this._debugShadowCascadeLayer=!1,this.gbufferCommonBindGroupLayoutEntries.push({binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:4,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}),e!==V.PointLightsLighting&&e!==V.DirectionalAmbientLighting&&e!==V.PointLightsStencilMask||(this.gbufferCommonBindGroupLayoutEntries.push({binding:5,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:6,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}})),this.gbufferCommonBindGroupLayout=v.device.createBindGroupLayout({label:"GBuffer Textures Bind Group",entries:this.gbufferCommonBindGroupLayoutEntries}),this.debugLightsBuffer=v.device.createBuffer({label:"Debug Lights GPUBuffer",size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),Y.addBufferBytes(this.debugLightsBuffer),new Float32Array(this.debugLightsBuffer.getMappedRange()).set(new Float32Array([0,0])),this.debugLightsBuffer.unmap(),this.gbufferTexturesBindGroupEntries.push({binding:0,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:1,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:2,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:3,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:4,resource:{buffer:null}}),e!==V.DirectionalAmbientLighting&&e!==V.PointLightsLighting&&e!==V.PointLightsStencilMask||(this.gbufferTexturesBindGroupEntries.push({binding:5,resource:{buffer:null}}),this.gbufferTexturesBindGroupEntries.push({binding:6,resource:{buffer:this.debugLightsBuffer}}))}set debugLightsMask(e){this._debugLightsMask=e,this.updateLightSettingsBuffer()}set debugShadowCascadeLayer(e){this._debugShadowCascadeLayer=e,this.updateLightSettingsBuffer()}updateLightSettingsBuffer(){v.device.queue.writeBuffer(this.debugLightsBuffer,0,new Float32Array([this._debugLightsMask?1:0,this._debugShadowCascadeLayer?1:0]))}updateGbufferBindGroupEntryAt(e,t){return this.gbufferTexturesBindGroupEntries[e].resource=t,this}recreateGBufferTexturesBindGroup(){this.gbufferTexturesBindGroup=v.device.createBindGroup({label:"G-Buffer Textures Input Bind Group",layout:this.gbufferCommonBindGroupLayout,entries:this.gbufferTexturesBindGroupEntries})}};lo.RENDER_TARGETS=[{format:"rgba16float",blend:{color:{srcFactor:"one",dstFactor:"one",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one",operation:"add"}}}];let gr=lo;class Yi extends gr{constructor(e,t,r){super(V.DirectionalAmbientLighting,t,r),this.shadowCascadesBuffer=e,this.dirLightShadowBindGroupEntries=[],this.shadowSampler=Je.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear",compare:"less"}),this.envSampler=Je.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear"}),this.ssaoMixBuffer=v.device.createBuffer({label:"Ambient SSAO Mix Factor Buffer",usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,size:1*Float32Array.BYTES_PER_ELEMENT,mappedAtCreation:!0}),Y.addBufferBytes(this.ssaoMixBuffer),new Float32Array(this.ssaoMixBuffer.getMappedRange()).set([1]),this.ssaoMixBuffer.unmap();const n=[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"comparison"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth",viewDimension:"2d-array"}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"cube"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"cube"}},{binding:5,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"2d"}},{binding:6,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:7,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}];this.dirLightShadowBindGroupLayout=v.device.createBindGroupLayout({label:"Direcional Light Shadow Bind Group Layout",entries:n});const i=v.device.createPipelineLayout({label:"Dir Light PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout,this.dirLightShadowBindGroupLayout]});this.dirLightShadowBindGroupEntries=[{binding:0,resource:{buffer:this.shadowCascadesBuffer}},{binding:1,resource:this.shadowSampler},{binding:2,resource:Be.dummyTexture.createView({})},{binding:3,resource:Be.dummyCubeTexture.createView({dimension:"cube"})},{binding:4,resource:Be.dummyCubeTexture.createView({dimension:"cube"})},{binding:5,resource:Be.dummyTexture.createView({})},{binding:6,resource:this.envSampler},{binding:7,resource:{buffer:this.ssaoMixBuffer}}];const o={label:"Directional Light Render PSO",layout:i,vertex:{module:J.createShaderModule(zt,"Fullscreen Vertex Shader Module"),entryPoint:_t},fragment:{module:J.createShaderModule(Xi(V.DirectionalAmbientLighting),"Directional Light Pass Shader Module"),entryPoint:Ws,targets:Yi.RENDER_TARGETS},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1}};this.renderPSO=J.createRenderPipeline(o),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:t,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"GBuffer Result Texture"})),Y.addTextureBytes(this.outTextures[0]),this.outTextureView=this.outTextures[0].createView()}set ssaoMixFactor(e){v.device.queue.writeBuffer(this.ssaoMixBuffer,0,new Float32Array([e]))}setDiffuseIBLTexture(e){return this.dirLightShadowBindGroupEntries[3].resource=e.createView({dimension:"cube"}),this.recreateDirLightShadowBindGroup(),this}setSpecularIBLTexture(e){return this.dirLightShadowBindGroupEntries[4].resource=e.createView({dimension:"cube"}),this.recreateDirLightShadowBindGroup(),this}setBDRFLutTexture(e){return this.dirLightShadowBindGroupEntries[5].resource=e.createView({dimension:"2d"}),this.recreateDirLightShadowBindGroup(),this}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextureView,loadOp:"clear",clearValue:[0,0,0,1],storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Directional + Ambient Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!1,view:this.inputTextureViews[3],stencilLoadOp:"load",stencilStoreOp:"store"}}),this.renderPassDescriptor}recreateDirLightShadowBindGroup(){this.dirLightShadowBindGroup=v.device.createBindGroup({label:"Directional Ambient LightingSystem G-Buffer Directional Shadow Input Bind Group",layout:this.dirLightShadowBindGroupLayout,entries:this.dirLightShadowBindGroupEntries})}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(r[2].createView({aspect:"all"})),this.inputTextureViews.push(r[3].createView()),this.inputTextureViews.push(r[4].createView({dimension:"2d-array"})),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[2]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).updateGbufferBindGroupEntryAt(5,{buffer:t.lightingManager.gpuBuffer}).recreateGBufferTexturesBindGroup(),this.dirLightShadowBindGroupEntries[2].resource=this.inputTextureViews[5],this.recreateDirLightShadowBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Directional + Ambient LightingSystem"),v.bindRenderPSO(this.renderPSO),n.setBindGroup(0,this.gbufferTexturesBindGroup),n.setBindGroup(1,this.dirLightShadowBindGroup),n.draw(3),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}}class Up extends Te{constructor(e,t){super(V.Deferred,e,t),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Normal + Metallic + Roughness + GBuffer Texture"})),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"bgra8unorm",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Color + Reflectance GBuffer Texture"})),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rg16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Velocity GBuffer Texture"})),this.outTextures.push(v.device.createTexture({dimension:"2d",format:v.depthStencilFormat,mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Depth + Stencil GBuffer Texture"}));for(const r of this.outTextures)Y.addTextureBytes(r)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextures[ut.NormalMetallicRoughness].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"},{view:this.outTextures[ut.ColorReflectance].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"},{view:this.outTextures[ut.Velocity].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:e,depthStencilAttachment:{view:this.outTextures[3].createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1,stencilLoadOp:"clear",stencilStoreOp:"store",stencilClearValue:0},label:"GBuffer Render Pass"}),this.renderPassDescriptor}render(e,t,r){const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.ENABLE_DEBUG_GROUPS&&i.pushDebugGroup("Render G-Buffer"),i.setBindGroup(ue.CameraPlusOptionalLights,this.cameraBindGroup),i.setStencilReference(128),t.renderOpaqueNodes(i,this.camera),v.ENABLE_DEBUG_GROUPS&&i.popDebugGroup(),i.end(),this.postRender(e),this.outTextures}}const Oc="copyDepth",kp=`

  @group(0) @binding(0) var sourceDepth: texture_depth_2d;
  @group(0) @binding(1) var destDepth: texture_storage_2d<r32float, write>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${Oc}(
    @builtin(global_invocation_id) pos : vec3u
  ) {
    let texSize = textureDimensions(sourceDepth);
    
    if (any(pos.xy > texSize)) {
      return;
    }

    let src = textureLoad(sourceDepth, pos.xy, 0);
    textureStore(destDepth, pos.xy, vec4f(src));
  }

`,St=class St extends Te{constructor(e,t){super(V.CopyDepthForHiZ,e,t);const r=[{binding:0,texture:{sampleType:"depth"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"r32float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Hi-Z Copy Depth Bind Group Layout",entries:r}),this.computePSO=J.createComputePipeline({label:"Hi-Z Copy Depth Compute PSO",layout:v.device.createPipelineLayout({label:"Hi-Z Copy Depth Compute PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:Oc,module:J.createShaderModule(kp,"Hi-Z Depth Copy Compute Shader Module"),constants:{WORKGROUP_SIZE_X:St.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:St.COMPUTE_WORKGROUP_SIZE_Y}}}),this.outTextures.push(v.device.createTexture({label:"Hi-Z Depth Texture",size:{width:e,height:t},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING,format:"r32float",mipLevelCount:Pt(e,t)})),Y.addTextureBytes(this.outTextures[0])}createComputePassDescriptor(){return this.computePassDescriptor||(this.computePassDescriptor={label:"Copy Hi-Z Depth Compute Pass"}),this.computePassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView({aspect:"depth-only"}));const u=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.outTextures[0].createView({baseMipLevel:0,mipLevelCount:1})}];this.bindGroup=v.device.createBindGroup({label:"Hi-Z Depth Copy Bind Group",layout:this.bindGroupLayout,entries:u})}const n=e.beginComputePass(this.createComputePassDescriptor());n.setPipeline(this.computePSO),n.setBindGroup(0,this.bindGroup);const i=Math.ceil(this.outTextures[0].width/St.COMPUTE_WORKGROUP_SIZE_X),o=Math.ceil(this.outTextures[0].height/St.COMPUTE_WORKGROUP_SIZE_Y);return n.dispatchWorkgroups(i,o,1),n.end(),this.postRender(e),this.outTextures}};St.COMPUTE_WORKGROUP_SIZE_X=8,St.COMPUTE_WORKGROUP_SIZE_Y=8;let Wi=St;const Ic="computeHiZMips",Np=`
  @group(0) @binding(0) var prevMipLevel: texture_2d<f32>;
  @group(0) @binding(1) var nextMipLevel: texture_storage_2d<r32float, write>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;  

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${Ic}(@builtin(global_invocation_id) pos : vec3u) {
    let texSize = textureDimensions(prevMipLevel);
    if (any(pos.xy > texSize)) {
      return;
    }

    let depthDim = vec2f(textureDimensions(prevMipLevel).xy);
    let outDepthDim = vec2f(textureDimensions(nextMipLevel).xy);

    let ratio = depthDim / outDepthDim;

    let vReadCoord = vec2u(pos.x << 1, pos.y << 1);
    let vWriteCoord = pos.xy;

    let depthSamples = vec4f(
      textureLoad(prevMipLevel, vReadCoord, 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(1, 0), 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(0, 1), 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(1, 1), 0).r
    );

    var minDepth = min(
      depthSamples.x,
      min(
        depthSamples.y,
        min(depthSamples.z, depthSamples.w)
      )
    );

    let needExtraSampleX = ratio.x > 2.01;
    let needExtraSampleY = ratio.y > 2.01;

    minDepth = select(
      minDepth,
      min(
        minDepth,
        min(
          textureLoad(prevMipLevel, vReadCoord + vec2u(2, 0), 0).r,
          textureLoad(prevMipLevel, vReadCoord + vec2u(2, 1), 0).r
        )
      ),
      needExtraSampleX
    );
    minDepth = select(
      minDepth,
      min(
        minDepth,
        min(
          textureLoad(prevMipLevel, vReadCoord + vec2u(0, 2), 0).r,
          textureLoad(prevMipLevel, vReadCoord + vec2u(1, 2), 0).r
        )
      ),
      needExtraSampleY
    );
    minDepth = select(
      minDepth,
      min(
        minDepth,
        textureLoad(prevMipLevel, vReadCoord + vec2u(2, 2), 0).r
      ),
      needExtraSampleX && needExtraSampleY
    );
    
    textureStore(nextMipLevel, pos.xy, vec4f(minDepth));

  }
`,it=class it extends Te{constructor(e,t){super(V.HiZ,e,t),this.mipTexSizes=[],this.mipTexViews=[];const r=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"unfilterable-float"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"r32float",viewDimension:"2d"}}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Hi-Z Bind Group Layout",entries:r}),this.computePSO=J.createComputePipeline({label:"Hi-Z Compute PSO",layout:v.device.createPipelineLayout({label:"Hi-Z Compute PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:Ic,module:J.createShaderModule(Np,"Compute Hi-Z Shader Module"),constants:{WORKGROUP_SIZE_X:it.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:it.COMPUTE_WORKGROUP_SIZE_Y}}})}createComputePassDescriptor(){return this.computePassDescriptor||(this.computePassDescriptor={label:"Hi-Z Depth Mip Compute Pass"}),this.computePassDescriptor}render(e,t,r){const n=r[0].mipLevelCount,i=r[0].width,o=r[0].height;if(!this.mipTexSizes.length){this.mipTexSizes.push(Se.create(i,o));for(let b=1;b<n;b++){const d=this.mipTexSizes[b-1],x=Se.divScalar(d,2);this.mipTexSizes.push(x)}}const u={baseMipLevel:0,mipLevelCount:1,dimension:"2d",format:r[0].format};if(!this.mipTexViews.length)for(let b=0;b<n;b++)u.label=`Hi-Z Depth Mip Level ${b}`,u.baseMipLevel=b,this.mipTexViews.push(r[0].createView(u));const l=[{binding:0,resource:null},{binding:1,resource:null}],m=e.beginComputePass(this.createComputePassDescriptor());m.setPipeline(this.computePSO);for(let b=1;b<n;b++){const d=this.mipTexSizes[b][0],x=this.mipTexSizes[b][1],g=(d+it.COMPUTE_WORKGROUP_SIZE_X-1)/it.COMPUTE_WORKGROUP_SIZE_X,_=(x+it.COMPUTE_WORKGROUP_SIZE_Y-1)/it.COMPUTE_WORKGROUP_SIZE_Y;l[0].resource=this.mipTexViews[b-1],l[1].resource=this.mipTexViews[b];const w=v.device.createBindGroup({layout:this.bindGroupLayout,entries:l});m.setBindGroup(0,w),m.dispatchWorkgroups(g,_,1)}return m.end(),this.postRender(e),r}};it.COMPUTE_WORKGROUP_SIZE_X=8,it.COMPUTE_WORKGROUP_SIZE_Y=8;let $i=it;const $s="pointLightVertex",qi=s=>At`

  ${W.VertexInput}
  ${W.VertexOutput}
  ${W.Camera}
  ${W.Light}

  #if ${s===V.PointLightsStencilMask}
  @group(0) @binding(0) var<uniform> camera: Camera;
  @group(0) @binding(1) var<storage, read> lightsBuffer: array<Light>;
  #else
  @group(0) @binding(0) var normalTexture: texture_2d<f32>;
  @group(0) @binding(1) var colorTexture: texture_2d<f32>;
  @group(0) @binding(2) var depthTexture: texture_depth_2d;
  @group(0) @binding(3) var aoTexture: texture_2d<f32>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  #endif

  #if ${s===V.PointLightsLighting||s===V.DirectionalAmbientLighting}
  @group(0) @binding(5) var<storage, read> lightsBuffer: array<Light>;
  @group(0) @binding(6) var<uniform> debugLights: f32;
  #endif

  #if ${s===V.PointLightsNonCulledLighting}

  @group(1) @binding(0) var<uniform> cameraCulledPointLight: Light;

  #endif

  @vertex
  fn ${$s}(
    @builtin(instance_index) instanceId: u32,
    in: VertexInput
  ) -> VertexOutput {
    #if ${s===V.PointLightsNonCulledLighting}
      let light = cameraCulledPointLight;
      let trueInstanceId = 0u;
    #else
      let trueInstanceId = instanceId;
      let light = lightsBuffer[trueInstanceId];
    #endif

    var position = in.position;
    position *= vec4f(vec3f(light.radius), 1.0);
    position += vec4f(light.position, 0.0);
    let pos = camera.projectionViewMatrix * position;

    var out: VertexOutput;
    out.position = pos;
    out.instanceId = trueInstanceId;
    return out;
  }
`;class Vp extends gr{setCamera(e){return this.camera=e,this.lightsMaskBindGroupEntries[0].resource={buffer:e.gpuBuffer},this}setLightsBuffer(e){return this.lightsMaskBindGroupEntries[1].resource={buffer:e},this}updateLightsMaskBindGroup(){return this.lightsMaskBindGroup=v.device.createBindGroup({layout:this.lightsMaskBindGroupLayout,entries:this.lightsMaskBindGroupEntries}),this}constructor(e,t){super(V.PointLightsStencilMask,e,t),this.lightsMaskBindGroupEntries=[{binding:0,resource:null},{binding:1,resource:null}];const r=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}];this.lightsMaskBindGroupLayout=v.device.createBindGroupLayout({label:"Light Masking Bind Group",entries:r});const n={label:"Point Light Mask PSO",layout:v.device.createPipelineLayout({label:"Point Lights Mask Render PSO Layout",bindGroupLayouts:[this.lightsMaskBindGroupLayout]}),vertex:{module:J.createShaderModule(qi(V.PointLightsStencilMask),"Point Light Mask Pass Vertex Shader"),entryPoint:$s,buffers:_e.defaultLayout,constants:{}},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal",stencilReadMask:0,stencilWriteMask:255,stencilBack:{compare:"always",depthFailOp:"increment-wrap",failOp:"keep",passOp:"keep"},stencilFront:{compare:"always",depthFailOp:"decrement-wrap",failOp:"keep",passOp:"keep"}},primitive:{cullMode:"none"}};this.renderPSO=J.createRenderPipeline(n)}createRenderPassDescriptor(){return this.renderPassDescriptor||(this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Point Lights Mask Stencil Pass",colorAttachments:[],depthStencilAttachment:{view:this.inputTextureViews[0],depthLoadOp:"load",depthStoreOp:"store",stencilLoadOp:"clear",stencilStoreOp:"store",stencilClearValue:0}})),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||this.inputTextureViews.push(r[0].createView());const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Point Lights Stencil Mask"),v.bindRenderPSO(this.renderPSO),n.setStencilReference(128),n.setBindGroup(0,this.lightsMaskBindGroup),n.setVertexBuffer(0,nt.pointLightSphereGeometry.vertexBuffers[0]),n.setIndexBuffer(nt.pointLightSphereGeometry.indexBuffer,Ae.INDEX_FORMAT),n.drawIndexed(nt.pointLightSphereGeometry.indexCount,t.lightingManager.pointLightsCount,0,0,1),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),[r[0]]}}const Yt=class Yt extends gr{constructor(e,t){super(V.PointLightsNonCulledLighting,e,t);const r=v.device.createPipelineLayout({label:"Render Non-Instanced Non-Culled Point Lights PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout,dt.bindGroupLayout]}),n={label:Yt.FRONT_FACE_RENDER_PSO_LABEL,layout:r,vertex:{module:J.createShaderModule(qi(V.PointLightsNonCulledLighting),"Non-Instanced Non-Culled Point Lights Vertex Shader"),entryPoint:$s,buffers:_e.defaultLayout},fragment:{module:J.createShaderModule(Xi(V.PointLightsNonCulledLighting)),entryPoint:Ws,targets:Yt.RENDER_TARGETS},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1},primitive:{cullMode:"back"}};this.frontFaceCullRenderPSO=J.createRenderPipeline(n),n.label=Yt.BACK_FACE_RENDER_PSO_LABEL,n.primitive.cullMode="front",this.backFaceCullRenderPSO=J.createRenderPipeline(n)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[5],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Non-Instanced Non-Culled Point Lights Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!0,view:this.inputTextureViews[2]}}),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView({aspect:"all"})),this.inputTextureViews.push(r[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(r[3].createView()),this.inputTextureViews.push(r[4].createView()),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[3]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).recreateGBufferTexturesBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor()),i=nt.pointLightSphereGeometry.indexBuffer,o=nt.pointLightSphereGeometry.vertexBuffers[0],u=nt.pointLightSphereGeometry.indexCount;n.setIndexBuffer(i,Ae.INDEX_FORMAT),n.setVertexBuffer(0,o),n.setBindGroup(0,this.gbufferTexturesBindGroup);let l=!1,m=!1;for(const b of t.lightingManager.cameraFaceCulledPointLights)D.dist(b.position,this.camera.position)>b.radius+.1?(l||n.setPipeline(this.frontFaceCullRenderPSO),l=!0,m=!1):(m||n.setPipeline(this.backFaceCullRenderPSO),l=!1,m=!0),n.setBindGroup(1,b.bindGroup),n.drawIndexed(u);return n.end(),this.postRender(e),[r[4]]}};Yt.FRONT_FACE_RENDER_PSO_LABEL="Render Non-Instanced Non-Culled Point Lights Front Face PSO Descriptor",Yt.BACK_FACE_RENDER_PSO_LABEL="Render Non-Instanced Non-Culled Point Lights Back Face PSO Descriptor";let Qi=Yt;class Zi extends gr{constructor(e,t){super(V.PointLightsLighting,e,t);const r={compare:"less",failOp:"keep",depthFailOp:"keep",passOp:"keep"},n={label:"Point Light Render PSO",layout:v.device.createPipelineLayout({label:"Render Lights PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout]}),vertex:{module:J.createShaderModule(qi(V.PointLightsLighting),"Point Light Render Pass Vertex Shader"),entryPoint:$s,buffers:_e.defaultLayout,constants:{}},fragment:{module:J.createShaderModule(Xi(V.PointLightsLighting),"Point Light Render Pass Fragment Shader"),entryPoint:Ws,targets:Zi.RENDER_TARGETS},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal",stencilReadMask:255,stencilWriteMask:0,stencilBack:r,stencilFront:r},primitive:{cullMode:"back"}};this.renderPSO=J.createRenderPipeline(n)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[5],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Point Lights Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!1,view:this.inputTextureViews[2],stencilLoadOp:"load",stencilStoreOp:"store"}}),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView({aspect:"all"})),this.inputTextureViews.push(r[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(r[3].createView()),this.inputTextureViews.push(r[4].createView()),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[3]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).updateGbufferBindGroupEntryAt(5,{buffer:t.lightingManager.gpuBuffer}).recreateGBufferTexturesBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Point LightingSystem"),v.bindRenderPSO(this.renderPSO),n.setBindGroup(0,this.gbufferTexturesBindGroup),n.setVertexBuffer(0,nt.pointLightSphereGeometry.vertexBuffers[0]),n.setIndexBuffer(nt.pointLightSphereGeometry.indexBuffer,Ae.INDEX_FORMAT),n.drawIndexed(nt.pointLightSphereGeometry.indexCount,t.lightingManager.pointLightsCount,0,0,1),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),[r[4]]}}const Fc="main",Et=class Et extends Te{constructor(e,t){super(V.Reflection,e,t),this._maxIterations=150,this._debugMissedIntersections=!1,this._isHiZ=!0;const r=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:3,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"unfilterable-float"}},{binding:4,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}];var n;this.bindGroupLayout=v.device.createBindGroupLayout({label:"Reflection Pass ComputePSO Bind Group Layout",entries:r}),this.computePSO=J.createComputePipeline({label:"Reflection Pass Compute PSO",layout:v.device.createPipelineLayout({label:"Reflection PASS ComputePSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:Fc,module:J.createShaderModule((n="rgba16float",`
  ${W.Camera}

  struct SSRSettings {
    isHiZ: i32,
    maxIterations: i32,
    debugMissedIntersections: i32
  };

  @group(0) @binding(0) var sceneTexture: texture_2d<f32>;
  @group(0) @binding(1) var normalMetallicRoughnessTexture: texture_2d<f32>;
  @group(0) @binding(2) var albedoReflectanceTexture: texture_2d<f32>;
  @group(0) @binding(3) var depthTexture: texture_2d<f32>;
  @group(0) @binding(4) var outTexture: texture_storage_2d<${n}, write>;
  @group(0) @binding(5) var<uniform> camera: Camera;
  @group(0) @binding(6) var<uniform> settings: SSRSettings;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  ${kr}

  const MAX_THICKNESS = 0.001;

  fn ComputePosAndReflection(
    tid: vec2u,
    viewNormal: vec3f,
    projectionMatrix: mat4x4f,
    inverseProjectionMatrix: mat4x4f,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    outSamplePosInTexSpace: ptr<function, vec3f>,
    outReflDirInTexSpace: ptr<function, vec3f>,
    outMaxDistance: ptr<function, f32>
  ) {
    let sampleDepth = textureLoad(depthTexture, tid, 0).r;
    var samplePosClipSpace = vec4f(
      ((f32(tid.x) + 0.5) / f32(viewportWidth)) * 2 - 1.0,
      ((f32(tid.y) + 0.5) / f32(viewportHeight)) * 2 - 1.0,
      sampleDepth,
      1
    );
    samplePosClipSpace.y *= -1;
    var samplePosViewSpace = inverseProjectionMatrix * samplePosClipSpace;
    samplePosViewSpace /= samplePosViewSpace.w;
    let vCamToSampleViewSpace = normalize(samplePosViewSpace.xyz);
    let vReflectionViewSpace = vec4f(reflect(vCamToSampleViewSpace.xyz, viewNormal.xyz), 0.0);

    var vReflectionEndPosViewSpace = samplePosViewSpace + vReflectionViewSpace * 1000;
    // vReflectionEndPosViewSpace /= select(1.0, vReflectionEndPosViewSpace.z, vReflectionEndPosViewSpace.z > 0.0);
    var vReflectionEndPosClipSpace = projectionMatrix * vec4f(vReflectionEndPosViewSpace.xyz, 1.0);
    vReflectionEndPosClipSpace /= vReflectionEndPosClipSpace.w;

    let vReflectionDir = normalize((vReflectionEndPosClipSpace - samplePosClipSpace).xyz);

    // transform to texture space
    (*outSamplePosInTexSpace) = vec3f(
      samplePosClipSpace.xy * vec2f(0.5, -0.5) + vec2f(0.5, 0.5),
      samplePosClipSpace.z
    );

    (*outReflDirInTexSpace) = vec3f(
      vReflectionDir.xy * vec2f(0.5, -0.5),
      vReflectionDir.z
    );

    (*outMaxDistance) = select(-outSamplePosInTexSpace.x / outReflDirInTexSpace.x, (1 - outSamplePosInTexSpace.x) / outReflDirInTexSpace.x, outReflDirInTexSpace.x >= 0);
    (*outMaxDistance) = min(*outMaxDistance, select((1 - outSamplePosInTexSpace.y) / outReflDirInTexSpace.y, -outSamplePosInTexSpace.y / outReflDirInTexSpace.y, outReflDirInTexSpace.y < 0));
    (*outMaxDistance) = min(*outMaxDistance, select((1 - outSamplePosInTexSpace.z) / outReflDirInTexSpace.z, -outSamplePosInTexSpace.z / outReflDirInTexSpace.z, outReflDirInTexSpace.z < 0));
  }

  @must_use
  fn FindIntersectionLinear(
    samplePosInTexSpace: vec3f,
    reflDirInTexSpace: vec3f,
    maxTraceDistance: f32,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    intersection: ptr<function, vec3f>
  ) -> f32 {
    let vReflectionEndPosTexSpace = samplePosInTexSpace + reflDirInTexSpace * maxTraceDistance;
    var dp = vReflectionEndPosTexSpace.xyz - samplePosInTexSpace.xyz;
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let sampleScreenPos = vec2i(samplePosInTexSpace.xy * viewSize);
    let endPosScreenPos = vec2i(vReflectionEndPosTexSpace.xy * viewSize);
    let dp2 = endPosScreenPos - sampleScreenPos;
    let maxDist = max(abs(dp2.x), abs(dp2.y));
    dp /= f32(maxDist);

    var rayPosTexSpace = vec4f(samplePosInTexSpace.xyz + dp, 0);
    let rayDirTexSpace = vec4f(dp.xyz, 0);
    let rayPosStartTexSpace = rayPosTexSpace;

    var hitIndex = -1;
    for (var i = 0; i < maxDist && i < settings.maxIterations; i += 4) {
      let rayPosTexSpace0 = rayPosTexSpace + rayDirTexSpace * 0;
      let rayPosTexSpace1 = rayPosTexSpace + rayDirTexSpace * 1;
      let rayPosTexSpace2 = rayPosTexSpace + rayDirTexSpace * 2;
      let rayPosTexSpace3 = rayPosTexSpace + rayDirTexSpace * 3;

      let depth0 = textureLoad(depthTexture, vec2u(rayPosTexSpace0.xy * viewSize), 0).r;
      let depth1 = textureLoad(depthTexture, vec2u(rayPosTexSpace1.xy * viewSize), 0).r;
      let depth2 = textureLoad(depthTexture, vec2u(rayPosTexSpace2.xy * viewSize), 0).r;
      let depth3 = textureLoad(depthTexture, vec2u(rayPosTexSpace3.xy * viewSize), 0).r;

      var thickness = 0.0;

      thickness = rayPosTexSpace0.z - depth0;
      hitIndex = select(hitIndex, i + 0, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace1.z - depth1;
      hitIndex = select(hitIndex, i + 1, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace2.z - depth2;
      hitIndex = select(hitIndex, i + 2, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace3.z - depth3;
      hitIndex = select(hitIndex, i + 3, thickness >= 0 && thickness < MAX_THICKNESS);

      if (hitIndex != -1) {
        break;
      }

      rayPosTexSpace = rayPosTexSpace3 + rayDirTexSpace;
    }

    let intersected = hitIndex >= 0;
    (*intersection) = rayPosStartTexSpace.xyz + rayDirTexSpace.xyz * f32(hitIndex);

    return select(0.0, 1.0, intersected);
  }

  @must_use
  fn getCellCount(mipLevel: i32, depthTexture: texture_2d<f32>) -> vec2f {
    return vec2f(textureDimensions(depthTexture, mipLevel));
  }

  @must_use
  fn getCell(pos: vec2f, cell_count: vec2f) -> vec2f {
    return vec2f(floor(pos * cell_count));
  }

  @must_use
  fn intersectDepthPlane(o: vec3f, d: vec3f, z: f32) -> vec3f {
	  return o + d * z;
  }

  @must_use
  fn intersectCellBoundary(
    o: vec3f,
    d: vec3f,
    cell: vec2f,
    cellCount: vec2f,
    crossStep: vec2f,
    crossOffset: vec2f
  ) -> vec3f {
    var intersection = vec3f(0.0);
    
    let index = cell + crossStep;
    var boundary = index / cellCount;
    boundary += crossOffset;
    
    var delta = boundary - o.xy;
    delta /= d.xy;
    let t = min(delta.x, delta.y);
    
    intersection = intersectDepthPlane(o, d, t);
    
    return intersection;
  }

  @must_use
  fn getMinimumDepthPlane(
    p: vec2f,
    mipLevel: i32,
    depthTexture: texture_2d<f32>
  ) -> f32 {
    return textureLoad(depthTexture, vec2u(p), mipLevel).r;
  }

  @must_use
  fn crossedCellBoundary(oldCellIndex: vec2f, newCellIndex: vec2f) -> bool {
	  return (oldCellIndex.x != newCellIndex.x) || (oldCellIndex.y != newCellIndex.y);
  }

  @must_use
  fn FindIntersectionHiZ(
    samplePosInTexSpace: vec3f,
    reflDirInTexSpace: vec3f,
    maxTraceDistance: f32,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    intersection: ptr<function, vec3f>
  ) -> f32 {
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let maxLevel = textureNumLevels(depthTexture) - 1;

    var crossStep = vec2f(
      select(-1.0, 1.0, reflDirInTexSpace.x >= 0),
      select(-1.0, 1.0, reflDirInTexSpace.y >= 0)
    );
    let crossOffset = crossStep / viewSize / 128.0;
    crossStep = saturate(crossStep);
    
    var ray = samplePosInTexSpace.xyz;
    let minZ = ray.z;
    let maxZ = ray.z + reflDirInTexSpace.z * maxTraceDistance;
    let deltaZ = (maxZ - minZ);

    let o = ray;
    let d = reflDirInTexSpace * maxTraceDistance;

    let startLevel = 2;
    let stopLevel = 0;

    let startCellCount = getCellCount(startLevel, depthTexture);
	
    let rayCell = getCell(ray.xy, startCellCount);
    ray = intersectCellBoundary(
      o,
      d,
      rayCell,
      startCellCount,
      crossStep,
      crossOffset * 64
    );

    var level = startLevel;
    var iter = 0;
    let isBackwardRay = reflDirInTexSpace.z < 0;
    let rayDir = select(1.0, -1.0, isBackwardRay);

    while(level >= stopLevel && ray.z * rayDir <= maxZ * rayDir && iter < settings.maxIterations) {
      let cellCount = getCellCount(level, depthTexture);
      let oldCellIdx = getCell(ray.xy, cellCount);
      let cellMinZ = getMinimumDepthPlane((oldCellIdx + 0.5), level, depthTexture);
      let tmpRay = select(
        ray,
        intersectDepthPlane(o, d, (cellMinZ - minZ) / deltaZ),
        (cellMinZ > ray.z) && !isBackwardRay
      );
      let newCellIdx = getCell(tmpRay.xy, cellCount);
      
      let thickness = select(0, (ray.z - cellMinZ), level == 0);
      let crossed = (isBackwardRay && (cellMinZ > ray.z)) ||
                    (thickness > (MAX_THICKNESS)) ||
                    crossedCellBoundary(oldCellIdx, newCellIdx);
      ray = select(
        tmpRay,
        intersectCellBoundary(o, d, oldCellIdx, cellCount, crossStep, crossOffset),
        crossed
      );
      level = select(
        level - 1,
        min(i32(maxLevel), level + 1),
        crossed
      );
      
      iter++;
    }

    let intersected = (level < stopLevel);
    (*intersection) = ray;
	
    let intensity = select(0.0, 1.0, intersected);
    
    return intensity;
  }

  @must_use
  fn ComputeReflectionColor(
    intensity: f32,
    intersection: vec3f,
    viewportWidth: u32,
    viewportHeight: u32,
    sceneTexture: texture_2d<f32>
  ) -> vec4f {
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let texCoords = vec2u(intersection.xy * viewSize);
    let ssrColor = textureLoad(sceneTexture, texCoords, 0);
    return ssrColor;
  }

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${Fc}(@builtin(global_invocation_id) globalInvocationId : vec3u,) {
    let pos = globalInvocationId.xy;

    let encodedN = textureLoad(normalMetallicRoughnessTexture, pos, 0).rg;
    let N = decodeNormal(encodedN);
    let sceneColor = textureLoad(sceneTexture, pos, 0);
    let reflectanceMask = textureLoad(albedoReflectanceTexture, pos, 0).a;

    var reflectionColor = vec4f(0);
    var intensity = 0.0;

    let isReflectance = reflectanceMask != 0;
    if (isReflectance) {
      var samplePosInTexSpace = vec3f(0);
      var reflDirInTexSpace = vec3f(0);
      var maxTraceDistance = 0.0;

      ComputePosAndReflection(
        pos.xy,
        N,
        camera.projectionMatrix,
        camera.inverseProjectionMatrix,
        camera.viewportWidth,
        camera.viewportHeight,
        depthTexture,
        &samplePosInTexSpace,
        &reflDirInTexSpace,
        &maxTraceDistance
      );

      var intersection = vec3f(0);

      if (settings.isHiZ == 1) {
        intensity = FindIntersectionHiZ(
          samplePosInTexSpace,
          reflDirInTexSpace,
          maxTraceDistance,
          camera.viewportWidth,
          camera.viewportHeight,
          depthTexture,
          &intersection
        );
      } else {
        intensity = FindIntersectionLinear(
          samplePosInTexSpace,
          reflDirInTexSpace,
          maxTraceDistance,
          camera.viewportWidth,
          camera.viewportHeight,
          depthTexture,
          &intersection
        );
      }

      reflectionColor = ComputeReflectionColor(
        intensity,
        intersection,
        camera.viewportWidth,
        camera.viewportHeight,
        sceneTexture
      );
    }

    let combinedColor = sceneColor + reflectionColor;
    let finalColor = select(
      combinedColor,
      mix(
        select(combinedColor, vec4f(0, 1, 0, 1), isReflectance),
        combinedColor,
        intensity
      ),
      settings.debugMissedIntersections == 1
    );

    textureStore(outTexture, pos, finalColor);
    
  }
`)),constants:{WORKGROUP_SIZE_X:Et.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:Et.COMPUTE_WORKGROUP_SIZE_Y}}}),this.settingsBuffer=v.device.createBuffer({label:"SSR Settings Buffer",size:4*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),Y.addBufferBytes(this.settingsBuffer),new Int32Array(this.settingsBuffer.getMappedRange()).set(new Int32Array([this._isHiZ?1:0,this._maxIterations,this._debugMissedIntersections?1:0])),this.settingsBuffer.unmap(),this.outTextures.push(v.device.createTexture({label:"Reflection Texture",size:{width:e,height:t,depthOrArrayLayers:1},format:"rgba16float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC})),Y.addTextureBytes(this.outTextures[0])}set maxIterations(e){this._maxIterations=e,this.updateSettingsBuffer()}set debugMissedIntersections(e){this._debugMissedIntersections=e,this.updateSettingsBuffer()}set isHiZ(e){this._isHiZ=e,this.updateSettingsBuffer()}updateSettingsBuffer(){v.device.queue.writeBuffer(this.settingsBuffer,0,new Int32Array([this._isHiZ?1:0,this._maxIterations,this._debugMissedIntersections?1:0]))}destroy(){super.destroy(),Y.removeBufferBytes(this.settingsBuffer),this.settingsBuffer.destroy()}setCamera(e){return this.camera=e,this}createComputePassDescriptor(){return this.computePassDescriptor||(this.computePassDescriptor={label:"Reflection Compute Pass Encoder"}),this.computePassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView()),this.inputTextureViews.push(r[3].createView());const u=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:this.inputTextureViews[2]},{binding:3,resource:this.inputTextureViews[3]},{binding:4,resource:this.outTextures[0].createView()},{binding:5,resource:{buffer:this.camera.gpuBuffer}},{binding:6,resource:{buffer:this.settingsBuffer}}];this.bindGroup=v.device.createBindGroup({label:"Compute Reflections Bind Group",entries:u,layout:this.bindGroupLayout})}const n=e.beginComputePass(this.createComputePassDescriptor());v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Reflection Compute Pass"),n.setPipeline(this.computePSO),n.setBindGroup(0,this.bindGroup);const i=Math.ceil(this.outTextures[0].width/Et.COMPUTE_WORKGROUP_SIZE_X),o=Math.ceil(this.outTextures[0].height/Et.COMPUTE_WORKGROUP_SIZE_Y);return n.dispatchWorkgroups(i,o,1),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}};Et.COMPUTE_WORKGROUP_SIZE_X=8,Et.COMPUTE_WORKGROUP_SIZE_Y=8;let eo=Et;const Dc="fragBlurSSAO",Hp=`
  ${W.Camera}
  ${W.VertexOutput}

  @group(0) @binding(0) var ssaoTexture: texture_2d<f32>;

  @fragment
  fn ${Dc}(in: VertexOutput) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    var result = 0.0;
    for (var y = -2; y < 2; y++) {
      for (var x = -2; x < 2; x++) {
        let offset = pixelCoords + vec2i(x, y);
        result += textureLoad(ssaoTexture, offset, 0).r;
      }
    }
    return vec4f(result / 16.0, 0, 0, 1);
  }
`;class Jp extends Te{constructor(e,t){super(V.SSAOBlur,e,t);const r=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"SSAO Blur Input Bind Group",entries:r}),this.renderPSO=J.createRenderPipeline({label:"SSAO Blur RenderPSO",layout:v.device.createPipelineLayout({label:"SSAO Blur RenderPSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),vertex:{module:J.createShaderModule(zt),entryPoint:_t},fragment:{module:J.createShaderModule(Hp),entryPoint:Dc,targets:[{format:"r16float"}]}}),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"r16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,label:"SSAO Blurred Texture"})),Y.addTextureBytes(this.outTextures[0]),this.outTextureView=this.outTextures[0].createView()}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{loadOp:"load",storeOp:"store",view:this.outTextureView}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"SSAO Blur Render Pass Descriptor",colorAttachments:e}),this.renderPassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView());const i=[{binding:0,resource:this.inputTextureViews[0]}];this.bindGroup=v.device.createBindGroup({label:"SSAO Blur Bind Group",entries:i,layout:this.bindGroupLayout})}const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin SSAO Blur"),n.setBindGroup(0,this.bindGroup),n.setPipeline(this.renderPSO),n.draw(3),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}}const Uc="fragSSAO",zp=`
  ${W.Camera}
  ${W.VertexOutput}
  ${W.MathHelpers}

  ${kr}

  struct Settings {
    kernelSize: u32,
    radius: f32,
    strength: f32
  };

  @group(0) @binding(0) var normalMetallicRoughnessTex: texture_2d<f32>;
  @group(0) @binding(1) var depthTexture: texture_depth_2d;
  @group(0) @binding(2) var noiseTexture: texture_2d<f32>;
  @group(0) @binding(3) var<storage, read> kernelBuffer: array<vec4f>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  @group(0) @binding(5) var<uniform> settings: Settings; 

  @fragment
  fn ${Uc}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    let encodedN = textureLoad(normalMetallicRoughnessTex, pixelCoords, 0).rg;
    let viewNormal = decodeNormal(encodedN); 
    let centerDepth = textureLoad(depthTexture, pixelCoords, 0);
    let viewSpacePos = calcViewSpacePos(camera, coord.xy, centerDepth);

    let noiseScale = vec2i(textureDimensions(noiseTexture).xy);
    let sampleCoords = pixelCoords % noiseScale;
    var randomVec = textureLoad(noiseTexture, sampleCoords, 0).rgb;
    randomVec = (camera.viewMatrix * vec4f(randomVec, 0)).xyz;

    let viewTangent = normalize(randomVec - viewNormal * dot(randomVec, viewNormal));
    let viewBitangent = cross(viewNormal, viewTangent);
    let TBN = mat3x3f(viewTangent, viewBitangent, viewNormal);

    let kernelSize = settings.kernelSize;
    let radius = settings.radius;

    var occlusion = 0.0;

    let screenSize = vec2i(textureDimensions(depthTexture).xy);

    for (var i = 0u; i < kernelSize; i++) {
      var viewSamplePos = TBN * kernelBuffer[i].xyz;
      viewSamplePos = viewSpacePos + viewSamplePos * radius;

      let viewSampleDir = normalize(viewSamplePos - viewSpacePos);
      let NdotS = max(dot(viewNormal, viewSampleDir), 0.0);

      let clipPos = camera.projectionMatrix * vec4f(viewSamplePos, 1.0);
      let ndcPos = clipPos.xy / clipPos.w;

      let screenCoord = vec2i(vec2f(ndcPos.x * 0.5 + 0.5, -ndcPos.y * 0.5 + 0.5) * vec2f(screenSize));

      var sampleDepth = textureLoad(depthTexture, screenCoord, 0);
      sampleDepth = calcViewSpacePos(camera, vec2f(screenCoord), sampleDepth).z;
      
      let rangeCheck = smoothstep(0.0, 1.0, radius / abs(viewSpacePos.z - sampleDepth));

      occlusion += select(0.0, 1.0, sampleDepth > viewSamplePos.z) * rangeCheck * NdotS;
    }

    occlusion = 1 - (occlusion / f32(kernelSize));
    let finalOcclusion = pow(occlusion, settings.strength);

    return vec4f(finalOcclusion);
  }
`,ho=class ho extends Te{constructor(e,t){super(V.SSAO,e,t),this.gbufferTexturesBindGroupEntries=[],this.startKernelSize=8,this._kernelSize=128,this._radius=.5,this._strength=2;const r=this.kernelSize,n=new Float32Array(4*r);for(let u=0;u<r;u++){const l=Br.create(2*Math.random()-1,2*Math.random()-1,Math.random(),0),m=u/r;Br.scale(l,Do(.1,1,m*m),l),n.set(l,4*u)}this.kernelBuffer=v.device.createBuffer({label:"SSAO Kernel Buffer",mappedAtCreation:!0,size:4*r*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE}),Y.addBufferBytes(this.kernelBuffer),new Float32Array(this.kernelBuffer.getMappedRange()).set(n),this.kernelBuffer.unmap(),this.settingsBuffer=v.device.createBuffer({label:"SSAO Settings GPU Buffer",size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM,mappedAtCreation:!0});const i=this.settingsBuffer.getMappedRange();new Uint32Array(i).set([this.startKernelSize]),new Float32Array(i).set([this.radius,this.strength],1),Y.addBufferBytes(this.settingsBuffer),this.settingsBuffer.unmap();const o=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}];this.gbufferCommonBindGroupLayout=v.device.createBindGroupLayout({label:"SSAO Input Bind Group",entries:o}),this.renderPSO=J.createRenderPipeline({label:"SSAO RenderPSO",layout:v.device.createPipelineLayout({label:"SSAO RenderPSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout]}),vertex:{module:J.createShaderModule(zt),entryPoint:_t},fragment:{module:J.createShaderModule(zp),entryPoint:Uc,targets:[{format:"r16float"}]}}),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"r16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,label:"SSAO Texture"})),this.outTextureView=this.outTextures[0].createView(),Y.addTextureBytes(this.outTextures[0]),this.loadBlueNoiseTexture()}get kernelSize(){return this._kernelSize}set kernelSize(e){this._kernelSize=e,this.updateSettingsBufferKernelSize()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateSettingsBufferRadius()}get strength(){return this._strength}set strength(e){this._strength=e,this.updateSettingsBufferStrength()}updateSettingsBufferKernelSize(){v.device.queue.writeBuffer(this.settingsBuffer,0,new Uint32Array([this.kernelSize]))}updateSettingsBufferRadius(){v.device.queue.writeBuffer(this.settingsBuffer,Uint32Array.BYTES_PER_ELEMENT,new Float32Array([this.radius]))}updateSettingsBufferStrength(){v.device.queue.writeBuffer(this.settingsBuffer,Uint32Array.BYTES_PER_ELEMENT+Float32Array.BYTES_PER_ELEMENT,new Float32Array([this.strength]))}destroy(){var e;super.destroy(),this.noiseTexture&&Y.removeTextureBytes(this.noiseTexture),Y.removeBufferBytes(this.kernelBuffer),(e=this.noiseTexture)==null||e.destroy(),this.kernelBuffer.destroy()}async loadBlueNoiseTexture(){const e=await fetch("data:image/png;base64,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"),t=await e.blob(),r=await createImageBitmap(t);this.noiseTexture=v.device.createTexture({label:"Blue Noise Texture",format:"rgba32float",size:{width:r.width,height:r.height},usage:GPUTextureUsage.TEXTURE_BINDING}),v.device.queue.copyExternalImageToTexture({source:r},{texture:this.noiseTexture},{width:r.width,height:r.height}),r.close()}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{loadOp:"load",storeOp:"store",view:this.outTextureView}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"SSAO Render Pass Descriptor",colorAttachments:e}),this.renderPassDescriptor}render(e,t,r){var o;this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView({aspect:"depth-only"})),this.gbufferTexturesBindGroupEntries=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:((o=this.noiseTexture)==null?void 0:o.createView())||Be.dummyTexture.createView()},{binding:3,resource:{buffer:this.kernelBuffer}},{binding:4,resource:{buffer:this.camera.gpuBuffer}},{binding:5,resource:{buffer:this.settingsBuffer}}],this.gbufferTexturesBindGroup=v.device.createBindGroup({layout:this.gbufferCommonBindGroupLayout,entries:this.gbufferTexturesBindGroupEntries}));const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.ENABLE_DEBUG_GROUPS&&i.pushDebugGroup("Begin SSAO"),i.setBindGroup(0,this.gbufferTexturesBindGroup),v.bindRenderPSO(this.renderPSO),i.draw(3),v.ENABLE_DEBUG_GROUPS&&i.popDebugGroup(),i.end(),this.postRender(e),this.outTextures}};ho.SSAO_SCALE_FACTOR=.5;let to=ho;class jp extends Te{constructor(e,t){super(V.Skybox,e,t)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[0],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Skybox render Pass",colorAttachments:e,depthStencilAttachment:{stencilReadOnly:!0,view:this.inputTextureViews[1],depthLoadOp:"load",depthStoreOp:"store"}}),this.renderPassDescriptor}render(e,t,r){var i;this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()));const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Skybox"),n.setBindGroup(ue.CameraPlusOptionalLights,this.cameraBindGroup),(i=t.skybox)==null||i.render(n),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),r}}const kc="main",Kp=`

  @group(0) @binding(0) var colorTexture: texture_2d<f32>;
  @group(0) @binding(1) var velocityTexture: texture_2d<f32>;
  @group(0) @binding(2) var historyTexture: texture_2d<f32>;
  @group(0) @binding(3) var<uniform> historyMixFactor: f32;

  @fragment
  fn ${kc}(@builtin(position) coord: vec4f) -> @location(0) vec4f {
    let pixelCoords = vec2i(floor(coord.xy));
    let currColor = textureLoad(colorTexture, pixelCoords, 0).xyz;
    let velocity = textureLoad(velocityTexture, pixelCoords, 0).xy;
    let prevousPixelPos = vec2i(floor(coord.xy - velocity));
    
    var history = textureLoad(historyTexture, prevousPixelPos, 0).xyz;

    let nearColor0 = textureLoad(colorTexture, pixelCoords + vec2i(1, 0), 0).xyz;
    let nearColor1 = textureLoad(colorTexture, pixelCoords + vec2i(0, 1), 0).xyz;
    let nearColor2 = textureLoad(colorTexture, pixelCoords + vec2i(-1, 0), 0).xyz;
    let nearColor3 = textureLoad(colorTexture, pixelCoords + vec2i(0, -1), 0).xyz;
    
    let boxMin = min(currColor, min(nearColor0, min(nearColor1, min(nearColor2, nearColor3))));
    let boxMax = max(currColor, max(nearColor0, max(nearColor1, max(nearColor2, nearColor3))));;
    
    history = clamp(history, boxMin, boxMax);

    var color = vec4f(mix(currColor, history, historyMixFactor), 1.0);

    return color;
  }
`,jr=class jr extends Te{constructor(e,t){super(V.TAAResolve,e,t),this.historyReset=!1;const r=J.createShaderModule(zt),n=J.createShaderModule(Kp),i=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{}}];this.texturesBindGroupLayout=v.device.createBindGroupLayout({label:"TAA Resolve Input Textures Bind Group",entries:i});const o={layout:v.device.createPipelineLayout({bindGroupLayouts:[this.texturesBindGroupLayout]}),vertex:{module:r,entryPoint:_t},fragment:{module:n,entryPoint:kc,targets:[{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back"}};this.renderPSO=J.createRenderPipeline(o),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC,label:"TAA Resolve Texture"})),this.outTextureView=this.outTextures[0].createView(),Y.addTextureBytes(this.outTextures[0]),this.sourceCopyTextureInfo={texture:this.outTextures[0],mipLevel:0,origin:{x:0,y:0,z:0}},this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,label:"TAA Resolve Texture"})),this.historyTextureView=this.outTextures[1].createView(),Y.addTextureBytes(this.outTextures[1]),this.destCopyTextureInfo={texture:this.outTextures[1],mipLevel:0,origin:{x:0,y:0,z:0}},this.copyTextureExtend={width:e,height:t,depthOrArrayLayers:1},this.historyMixFactorBuffer=v.device.createBuffer({label:"TAA History Mix Factor Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),new Float32Array(this.historyMixFactorBuffer.getMappedRange()).set([jr.HISTORY_MIX_FACTOR]),Y.addBufferBytes(this.historyMixFactorBuffer),this.historyMixFactorBuffer.unmap()}destroy(){Y.removeBufferBytes(this.historyMixFactorBuffer),this.historyMixFactorBuffer.destroy()}resetHistory(){this.historyReset=!0,v.device.queue.writeBuffer(this.historyMixFactorBuffer,0,new Float32Array([0]))}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextureView,loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"TAA Resolve Pass",colorAttachments:e}),this.renderPassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView());const o=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:this.historyTextureView},{binding:3,resource:{buffer:this.historyMixFactorBuffer}}];this.textureBindGroup=v.device.createBindGroup({layout:this.texturesBindGroupLayout,entries:o})}const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.bindRenderPSO(this.renderPSO),i.setBindGroup(0,this.textureBindGroup),i.draw(3),i.end(),e.copyTextureToTexture(this.sourceCopyTextureInfo,this.destCopyTextureInfo,this.copyTextureExtend),this.postRender(e),this.historyReset&&(v.device.queue.onSubmittedWorkDone().then(()=>{v.device.queue.writeBuffer(this.historyMixFactorBuffer,0,new Float32Array([jr.HISTORY_MIX_FACTOR]))}),this.historyReset=!1),this.outTextures}};jr.HISTORY_MIX_FACTOR=.9;let ro=jr;class Xp extends Te{constructor(e,t){super(V.Transparent,e,t)}setCamera(e){return this.camera=e,this}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[0],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Transparent Render Pass",colorAttachments:e,depthStencilAttachment:{view:this.inputTextureViews[1],depthLoadOp:"load",depthStoreOp:"store",stencilReadOnly:!0}}),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()));const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Render Transparent Nodes"),this.cameraBindGroup=v.device.createBindGroup({label:"Camera Bind Group for: Transparent Pass",layout:J.defaultCameraPlusLightsBindGroupLayout,entries:[{binding:0,resource:{buffer:this.camera.gpuBuffer}},{binding:1,resource:{buffer:t.lightingManager.gpuBuffer}}]}),n.setBindGroup(ue.CameraPlusOptionalLights,this.cameraBindGroup),t.lightingManager.render(n),t.renderDebugMeshes(n),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),r}}const Vr="deferredPBRFrag",qs=({hasPBRTextures:s=!1,isInstanced:e=!1}={})=>At`
  ${W.Camera}
  ${W.VertexOutput}
  ${W.GBufferOutput}
  ${W.ModelUniform}
  ${W.InstanceInput}

  @group(${ue.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(${ue.Model}) @binding(0) var<uniform> model: ModelUniform;
  
  @group(${ue.PBRTextures}) @binding(${as.Default}) var texSampler: sampler;
  @group(${ue.PBRTextures}) @binding(${me.Albedo}) var albedoTexture: texture_2d<f32>;
  @group(${ue.PBRTextures}) @binding(${me.Normal}) var normalTexture: texture_2d<f32>;
  @group(${ue.PBRTextures}) @binding(${me.MetallicRoughness}) var metallicRoughnessTexture: texture_2d<f32>;

  #if ${e}
  @group(${ue.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
  #endif

  ${kr}

  @fragment
  fn ${Vr}(in: VertexOutput) -> GBufferOutput  {
    let uv = in.uv;
    
    var viewSpaceN = normalize(in.viewNormal);
    let viewSpaceT = normalize(in.viewTangent);
    let viewSpaceB = normalize(in.viewBitangent);
    let viewSpaceTBN = mat3x3f(viewSpaceT, viewSpaceB, viewSpaceN);

    // var textureNormal = textureSampleLevel(normalTexture, texSampler, uv, 5.0).rgb * 2 - 1;
    let textureNormal = textureSample(normalTexture, texSampler, uv).rgb * 2 - 1;
    
    if (${s}) {
      viewSpaceN = normalize(viewSpaceTBN * textureNormal);
    }

    var color = model.baseColor;
    if (${s}) {
      let texColor = textureSample(albedoTexture, texSampler, uv);
      if (texColor.a < 0.2) {
        discard;
      }
      color = texColor.rgb;
    }

    var out: GBufferOutput;

    #if ${e}
      var metallic = instanceInputs[in.instanceId].metallic;
      var roughness = instanceInputs[in.instanceId].roughness;
    #else
      var metallic = model.metallic;
      var roughness = model.roughness;
    #endif


    if (${s}) {
      let metallicRoughness = textureSample(metallicRoughnessTexture, texSampler, uv).rgb;
      metallic = metallicRoughness.b;
      roughness = metallicRoughness.g;
    }

    out.normalMetallicRoughness = vec4f(
      encodeNormal(viewSpaceN),
      metallic,
      roughness
    );
    
    out.color = vec4f(color, f32(model.isReflective));
    
    var oldPos = in.prevFrameClipPos;
    var newPos = in.currFrameClipPos;
    
    oldPos /= oldPos.w;
    oldPos.x = (oldPos.x+1)/2.0;
    oldPos.y = (oldPos.y+1)/2.0;
    oldPos.y = 1 - oldPos.y;
    
    newPos /= newPos.w;
    newPos.x = (newPos.x+1)/2.0;
    newPos.y = (newPos.y+1)/2.0;
    newPos.y = 1 - newPos.y;

    out.velocity = vec4f((newPos - oldPos).xy, 0, 1);
  
    return out;
  }
`,Nc="forwardPBRFrag",Yp=({hasPBRTextures:s=!1,isInstanced:e=!1}={})=>At`
  ${W.Camera}
  ${W.VertexOutput}
  ${W.GBufferOutput}
  ${W.ModelUniform}
  ${W.Material}
  ${W.InstanceInput}
  ${W.CommonHelpers}
  ${W.Light}

  @group(${ue.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(${ue.CameraPlusOptionalLights}) @binding(1) var<storage, read> lightsBuffer: array<Light>;

  @group(${ue.Model}) @binding(0) var<uniform> model: ModelUniform;

  @group(${ue.PBRTextures}) @binding(${as.Default}) var texSampler: sampler;
  @group(${ue.PBRTextures}) @binding(${me.Albedo}) var albedoTexture: texture_2d<f32>;
  @group(${ue.PBRTextures}) @binding(${me.Normal}) var normalTexture: texture_2d<f32>;
  @group(${ue.PBRTextures}) @binding(${me.MetallicRoughness}) var metallicRoughnessTexture: texture_2d<f32>;

  #if ${e}
  @group(${ue.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
  #endif

  ${Lc({isDeferred:!1,hasIBL:!1})}

  @fragment
  fn ${Nc}(in: VertexOutput) -> @location(0) vec4f {
    let uv = in.uv;

    var N = normalize(in.viewNormal);
    let T = normalize(in.viewTangent);
    let B = normalize(in.viewBitangent);
    let TBN = mat3x3f(T, B, N);
    let textureNormal = textureSample(normalTexture, texSampler, uv).rgb * 2 - 1;
    if (${s}) {
      N = normalize(TBN * textureNormal);
    }

    #if ${e}
      var metallic = instanceInputs[in.instanceId].metallic;
      var roughness = instanceInputs[in.instanceId].roughness;
    #else
      var metallic = model.metallic;
      var roughness = model.roughness;
    #endif

    if (${s}) {
      let metallicRoughness = textureSample(metallicRoughnessTexture, texSampler, uv).rgb;
      metallic = metallicRoughness.b;
      roughness = metallicRoughness.g;
    }

    let modelTexColor = textureSample(albedoTexture, texSampler, uv).rgb;
    var color = vec4f(model.baseColor, 1);
    if (${s}) {
      color = textureSample(albedoTexture, texSampler, uv);
    }

    // if (color.a < 0.01) {
    //   discard;
    // }

    var material = Material();
    material.albedo = color.rgb;
    material.roughness = roughness;
    // return vec4f(vec3f(1 - metallic), 1);
    material.metallic = metallic;
    material.ambientOcclusion = 1.0;

    let V = normalize(camera.position - in.worldPosition);

    return PBRLighting(
      material,
      0,
      in.worldPosition,
      N,
      V,
      1,
      color.a
    );
  }
`,ft="vertexMain",Bt=({isInstanced:s,isShadow:e}={isInstanced:!1,isShadow:!1})=>At`
    ${W.VertexInput}
    ${W.VertexOutput}
    ${W.ModelUniform}
    ${W.Camera}
    ${W.InstanceInput}

    @group(${ue.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
    @group(${ue.Model}) @binding(0) var<uniform> model: ModelUniform;
    
    @group(${ue.PBRTextures}) @binding(${me.Albedo}) var albedoTexture: texture_2d<f32>;
    @group(${ue.PBRTextures}) @binding(${me.Normal}) var normalTexture: texture_2d<f32>;

    #if ${s}
      @group(${ue.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
    #endif

    @vertex
    fn ${ft}(
      @builtin(instance_index) instanceId: u32,
      in: VertexInput
    ) -> VertexOutput {
      var position = in.position;

      var worldMatrix: mat4x4f;

      #if ${!e}
      var prevWorldMatrix: mat4x4f;
      #endif

      #if ${s}
        worldMatrix = instanceInputs[instanceId].worldMatrix * model.worldMatrix;
        #if ${!e}
          prevWorldMatrix = instanceInputs[instanceId].worldMatrix * model.prevFrameWorldMatrix;
        #endif
      #else
        worldMatrix = model.worldMatrix;
        #if ${!e}
          prevWorldMatrix = model.prevFrameWorldMatrix;
        #endif
      #endif
      
      var out: VertexOutput;
      let worldPosition = worldMatrix * in.position;
      #if ${e}
        out.position = camera.projectionViewMatrix * worldPosition;
      #else
        out.position = camera.projectionViewMatrix * worldPosition;
        out.worldPosition = worldPosition.xyz;

        // var jitterOffset = camera.jitterOffset;
        // jitterOffset.x = ((jitterOffset.x - 0.5) / f32(camera.viewportWidth)) * 2;
        // jitterOffset.y = ((jitterOffset.y - 0.5) / f32(camera.viewportHeight)) * 2;

        out.position += vec4f(camera.jitterOffset * out.position.w, 0, 0);

        out.currFrameClipPos = out.position;
        out.prevFrameClipPos = camera.prevFrameProjectionViewMatrix * prevWorldMatrix * in.position;
        
        let viewSpaceNormMatrix = mat3x3f(
          camera.viewMatrix[0].xyz,
          camera.viewMatrix[1].xyz,
          camera.viewMatrix[2].xyz
        ) * model.normalMatrix;

        let viewTangent = normalize(viewSpaceNormMatrix * in.tangent.xyz);
        let viewNormal = normalize(viewSpaceNormMatrix * in.normal);
        let viewBitangent = normalize(cross(viewNormal, viewTangent)) * in.tangent.w;

        out.viewTangent = viewTangent;
        out.viewBitangent = viewBitangent;
        out.viewNormal = viewNormal;
        out.instanceId = instanceId;
        out.uv = in.uv;
      #endif

      return out;
    }
  `;let Qs,Zs,en,so,no,io,oo,ao;const Vc=Object.freeze({get defaultGLTFTransparentPBRMaterial(){return ao||(ao=new ht({debugLabel:"Forward Pass Default PBR Material",vertexShaderSrc:Bt(),vertexShaderEntryFn:ft,vertexBuffers:_e.defaultGLTFLayout,fragmentShaderSrc:Yp({hasPBRTextures:!0}),fragmentShaderEntryFn:Nc,targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}],bindGroupLayouts:[J.defaultCameraPlusLightsBindGroupLayout,J.defaultModelBindGroupLayout,J.defaultModelMaterialBindGroupLayout],depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less"},primitive:{cullMode:"none"}}),ao)},get defaultDeferredPBRMaterial(){if(Qs)return Qs;const s={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return Qs=new ht({debugLabel:"Deferred Pass Default PBR Material",vertexShaderSrc:Bt(),vertexShaderEntryFn:ft,vertexBuffers:_e.defaultLayout,fragmentShaderSrc:qs(),fragmentShaderEntryFn:Vr,constants:{},targets:Jt,depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:s,stencilFront:s}}),Qs},get defaultGLTFDeferredPBRMaterial(){if(Zs)return Zs;const s={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return Zs=new ht({debugLabel:"Deferred Pass Default PBR Material",vertexShaderSrc:Bt(),vertexShaderEntryFn:ft,vertexBuffers:_e.defaultGLTFLayout,fragmentShaderSrc:qs(),fragmentShaderEntryFn:Vr,constants:{},targets:Jt,depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:s,stencilFront:s}}),Zs},get defaultGLTFTexturedDeferredMaterial(){if(en)return en;const s={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return en=new ht({debugLabel:"Default Textured Deferred PBR",vertexShaderSrc:Bt(),vertexShaderEntryFn:ft,vertexBuffers:_e.defaultGLTFLayout,fragmentShaderSrc:qs({hasPBRTextures:!0}),fragmentShaderEntryFn:Vr,constants:{},targets:Jt,depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:s,stencilFront:s}}),en},get defaultDeferredInstancedMaterial(){return so||(so=new ht({debugLabel:"Material",vertexShaderSrc:Bt({isInstanced:!0}),vertexShaderEntryFn:ft,fragmentShaderSrc:qs(),fragmentShaderEntryFn:Vr,bindGroupLayouts:[J.defaultCameraBindGroupLayout,J.defaultModelBindGroupLayout,J.instancesBindGroupLayout],targets:Jt}),so)},get defaultShadowMaterial(){return io||(io=new ht({debugLabel:"Default Shadow Material",vertexShaderSrc:Bt(),vertexShaderEntryFn:ft,vertexBuffers:_e.defaultLayout}),io)},get defaultGLTFShadowMaterial(){return no||(no=new ht({debugLabel:"Default Shadow Material",vertexShaderSrc:Bt({isShadow:!0}),vertexShaderEntryFn:ft,vertexBuffers:_e.defaultGLTFLayout,primitive:{cullMode:"front"},depthStencilState:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}}),no)},get defaultInstancedShadowMaterial(){return oo||(oo=new ht({debugLabel:"Default Shadow Material",vertexShaderSrc:Bt({isInstanced:!0}),vertexShaderEntryFn:ft,bindGroupLayouts:[J.defaultCameraBindGroupLayout,J.defaultModelBindGroupLayout,J.defaultModelMaterialBindGroupLayout,J.instancesBindGroupLayout],depthStencilState:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}}),oo)}}),cn=class cn extends v{constructor(){super(),this.scene=new op,this.cpuAverage=new cs,this.gpuAverage=new cs,this.fpsDisplayAverage=new cs,this.resizeCounter=0,this.enableAnimation=!0,this.mainCamera=new kn(70,1,.1,100),this.mainCamera.shouldJitter=!0,this.mainCamera.setPositionAsVec3(_c),this.mainCamera.setLookAt(0,2,0),this.mainCamera.updateViewMatrix(),this.mainCameraCtrl=new En(this.mainCamera,document.body,v.$canvas),this.mainCameraCtrl.startTick(),this.debugCamera=new kn(70,1,.1,100),this.debugCamera.setPosition(6,12,1),this.debugCamera.setLookAt(0,7,0),this.debugCamera.updateViewMatrix();const e=new bd(yp,!0).getPoints(240);this.lightingManager=new Ni(e),this.scene.lightingManager=this.lightingManager,this.texturesDebugContainer=new Di,this.timingDebugContainer=new Ui,this.scene.skybox=new Lp;const t=new sp(pl);this.scene.addChild(t),t.setPositionY(2).updateWorldMatrix(),Promise.all([Be.load6SeparateHDRFacesAsCubeMapTexture(gp,512,!0,"Skybox Faces"),t.load()]).then(([r])=>{this.envDiffuseTexture=Oi.encode(r),this.envSpecularTexture=Ii.encode(r,256),this.envBdrfLutTexture=Li.encode(),Ht.generateMipsForCubeTexture(this.envDiffuseTexture),this.scene.skybox.setTexture(this.envDiffuseTexture),this.renderPassComposer.getPass(V.DirectionalAmbientLighting).setDiffuseIBLTexture(this.envDiffuseTexture).setSpecularIBLTexture(this.envSpecularTexture).setBDRFLutTexture(this.envBdrfLutTexture),Y.removeTextureBytes(r),r.destroy(),t.setMaterial(Vc.defaultGLTFTexturedDeferredMaterial).setMaterial(Vc.defaultGLTFShadowMaterial,V.Shadow),setTimeout(()=>{document.getElementById("loader").classList.toggle("faded"),new es({durationMS:1500,delayMS:100,easeName:"sine_InOut",onUpdate:n=>{const i=D.lerp(xc,bp,n),o=Do(0,2,n);this.sunPositionX=i[0],this.sunPositionY=i[1],this.sunPositionZ=i[2],this.sunIntensity=o},onComplete:()=>{new es({durationMS:500,delayMS:200,easeName:"quad_Out",onUpdate:n=>{this.lightingManager.fireParticlesRevealFactor=n},onComplete:()=>{document.getElementById("logo").classList.toggle("faded"),this.mainCameraCtrl.revealTouchControls(),this.onIntroAnimComplete&&this.onIntroAnimComplete()}}).start()}}).start(),new es({durationMS:1800,easeName:"quad_Out",onUpdate:n=>{this.mainCamera.setPositionAsVec3(D.lerp(_c,xp,n)).updateViewMatrix()},onComplete:()=>{}}).start(),this.renderPassComposer.getPass(V.Blit).revealWithAnimation(800)},500)})}set sunPositionX(e){this.lightingManager.sunPositionX=e}set sunPositionY(e){this.lightingManager.sunPositionY=e}set sunPositionZ(e){this.lightingManager.sunPositionZ=e}set sunIntensity(e){this.lightingManager.sunIntensity=e}set ssaoEnabled(e){this.renderPassComposer.getPass(V.DirectionalAmbientLighting).ssaoMixFactor=e?1:0}set ssaoKernelSize(e){this.renderPassComposer.getPass(V.SSAO).kernelSize=e}set ssaoRadius(e){this.renderPassComposer.getPass(V.SSAO).radius=e}set ssaoStrength(e){this.renderPassComposer.getPass(V.SSAO).strength=e}set enableTAA(e){this.mainCamera.shouldJitter=e;const t=this.renderPassComposer.getPass(V.TAAResolve),r=this.renderPassComposer.getPass(V.BloomDownsample),n=this.renderPassComposer.getPass(V.Blit);t.enabled=e,e&&t.resetHistory(),r.resetInputs().addInputTexture(e?Fr:Dr),n.resetInputs().addInputTextures([Ur,e?Fr:Dr])}set debugGBuffer(e){e?(this.texturesDebugContainer.scrollIntoGbufferSection(),this.texturesDebugContainer.reveal()):this.texturesDebugContainer.hide()}set debugShadowMap(e){e?(this.texturesDebugContainer.scrollToShadowSection(),this.texturesDebugContainer.reveal()):this.texturesDebugContainer.hide()}set shadowMapSize(e){const t=this.renderPassComposer.getPass(V.Shadow);this.renderPassComposer.getPass(V.DirectionalAmbientLighting).resetInputs().addInputTextures([rt,xt,Ce,pr,Ir]),t.shadowMapSize=e}set debugShadowCascadeIndex(e){this.renderPassComposer.getPass(V.DirectionalAmbientLighting).debugShadowCascadeLayer=e}set debugLightsMask(e){this.renderPassComposer.getPass(V.PointLightsLighting).debugLightsMask=e}set render2ndFloorPoints(e){this.lightingManager.render2ndFloorParticles=e}set ssrIsHiZ(e){this.renderPassComposer.getPass(V.Reflection).isHiZ=e,this.renderPassComposer.getPass(V.HiZ).enabled=e}set ssrMaxIterations(e){this.renderPassComposer.getPass(V.Reflection).maxIterations=e}set debugMissedSSR(e){this.renderPassComposer.getPass(V.Reflection).debugMissedIntersections=e}set ssrEnabled(e){this.renderPassComposer.getPass(V.Reflection).enabled=e,this.renderPassComposer.getPass(V.TAAResolve).clearInputTextures().addInputTextures([e?Dr:Xe,zs])}set bloomEnabled(e){this.renderPassComposer.getPass(V.BloomDownsample).enabled=e,this.renderPassComposer.getPass(V.BloomUpsample).enabled=e,this.renderPassComposer.getPass(V.Blit).bloomEnabled=e}set bloomFilterRadius(e){this.renderPassComposer.getPass(V.BloomUpsample).bloomFilterRadius=e}set debugBoundingBoxes(e){this.renderPassComposer.getPass(V.DebugBounds).enabled=e}set debugMovementCurve(e){this.curveMoveLine.visible=e}toggleStatsVisibility(){this.timingDebugContainer.toggleVisibility()}recreateRenderComposer(e,t){var h;(h=this.renderPassComposer)==null||h.destroy(),this.renderPassComposer=new yd,this.renderPassComposer.setScene(this.scene);const r=new Ys(this.lightingManager.mainDirLight,e,t).addOutputTexture(Ir).setCamera(this.mainCamera),n=new Up(e,t).setCamera(this.mainCamera).addOutputTextures([rt,xt,zs,Ce]),i=new to(e,t).setCamera(this.mainCamera).addInputTextures([rt,Ce]).addOutputTexture(bc),o=new Jp(e,t).addInputTexture(bc).addOutputTexture(pr),u=new Yi(r.shadowCascadesBuffer,e,t).setCamera(this.mainCamera).addInputTextures([rt,xt,Ce,pr,Ir]).addOutputTexture(Xe);this.envDiffuseTexture&&u.setDiffuseIBLTexture(this.envDiffuseTexture),this.envSpecularTexture&&u.setSpecularIBLTexture(this.envSpecularTexture),this.envBdrfLutTexture&&u.setBDRFLutTexture(this.envBdrfLutTexture);const l=new Qi(e,t).setCamera(this.mainCamera).addInputTextures([rt,xt,Ce,pr,Xe]).addOutputTexture(Xe),m=new Vp(e,t).setCamera(this.mainCamera).addInputTextures([Ce]).addOutputTexture(Ce).setLightsBuffer(this.lightingManager.gpuBuffer).updateLightsMaskBindGroup(),b=new Zi(e,t).setCamera(this.mainCamera).addInputTextures([rt,xt,Ce,pr,Xe]).addOutputTexture(Xe),d=new Xp(e,t).setCamera(this.mainCamera).addInputTextures([Xe,Ce]).addOutputTextures([Xe,Ce]),x=new jp(e,t).setCamera(this.mainCamera).addInputTextures([Xe,Ce]).addOutputTextures([Xe,Ce]),g=new Wi(e,t).addInputTexture(Ce).addOutputTexture(js),_=new $i(e,t).addInputTexture(js).addOutputTexture(js),w=new eo(e,t).setCamera(this.mainCamera).addInputTextures([Xe,rt,xt,js]).addOutputTexture(Dr),f=new ro(e,t).addInputTextures([Dr,zs]).addOutputTexture(Fr),p=new Ki(e,t).addInputTexture(Fr).addOutputTexture(Ur),a=new Dp(e,t).addInputTexture(Ur).addOutputTexture(Ur),c=new ji(e,t,this.resizeCounter>0).addInputTextures([Ur,Fr]);this.renderPassComposer.addPass(r).addPass(n).addPass(i).addPass(o).addPass(u).addPass(l).addPass(m).addPass(b).addPass(d).addPass(x).addPass(g).addPass(_).addPass(w).addPass(f).addPass(p).addPass(a).addPass(c)}resize(e,t){this.debugCamera.onResize(e,t),this.mainCamera.onResize(e,t),this.recreateRenderComposer(e,t),this.resizeCounter++}async renderFrame(e){const t=.001*(e-v.elapsedTimeMs),r=t-v.prevTimeMs;v.prevTimeMs=t,v.elapsedTimeMs+=this.enableAnimation?r:0,v.deltaTimeMs=this.enableAnimation?Math.min(r,.5):0;const n=performance.now();this.debugCamera.onFrameStart(),this.mainCamera.onFrameStart();const i=v.device.createCommandEncoder({label:"Frame Command Encoder"});this.lightingManager.update(i),this.renderPassComposer.render(i),this.texturesDebugContainer.setTextureGBufferSection($.Albedo,this.renderPassComposer.getTexture(xt)).setTextureGBufferSection($.Normal,this.renderPassComposer.getTexture(rt)).setTextureGBufferSection($.Metallic,this.renderPassComposer.getTexture(rt)).setTextureGBufferSection($.Roughness,this.renderPassComposer.getTexture(rt)).setTextureGBufferSection($.AO,this.renderPassComposer.getTexture(pr)).setTextureGBufferSection($.Reflectance,this.renderPassComposer.getTexture(xt)).setTextureGBufferSection($.Depth,this.renderPassComposer.getTexture(Ce)).setTextureGBufferSection($.Velocity,this.renderPassComposer.getTexture(zs)).setTextureShadowSection($.ShadowDepthCascade0,this.renderPassComposer.getTexture(Ir)).setTextureShadowSection($.ShadowDepthCascade1,this.renderPassComposer.getTexture(Ir)).render(i),v.device.queue.submit([i.finish()]),this.renderPassComposer.onFrameEnd(),this.mainCamera.onFrameEnd(),this.debugCamera.onFrameEnd();const o=performance.now()-n;if(v.supportsGPUTimestampQuery){const[b,d]=await Promise.all([this.renderPassComposer.getPass(V.Shadow).getTimingResult(),this.renderPassComposer.getPass(V.Blit).getTimingResult()]),x=b.timings,g=(d.timings[1]-x[0])/1e6;this.gpuAverage.addSample(g)}this.cpuAverage.addSample(o),this.fpsDisplayAverage.addSample(1/r);const u=this.cpuAverage.get(),l=this.fpsDisplayAverage.get(),m=this.gpuAverage.get();this.timingDebugContainer.setDisplayValue(se.CPUTotal,u!==0?`${u.toFixed(1)}ms`:"N/A").setDisplayValue(se.GPUTotal,m>0?`${m.toFixed(1)}ms`:"N/A").setDisplayValue(se.FPS,l!==0?`${l.toFixed(1)}ms`:"N/A").setDisplayValue(se.VRAM,Y.getFormattedSize()).setDisplayValue(se.VisibleMeshes,`${this.scene.visibleNodesCount} / ${this.scene.nodesCount}`).setDisplayValue(se.LightsCount,this.lightingManager.lightsCount.toString()),v.frameIndex++}};cn.initialize=async e=>{if(!navigator.gpu)return;const t=await navigator.gpu.requestAdapter();v.$canvas=e,v.canvasContext=e.getContext("webgpu"),v.pixelFormat=navigator.gpu.getPreferredCanvasFormat();const r=[],n=t.features.has("timestamp-query");return n&&r.push("timestamp-query"),v.device=await t.requestDevice({requiredFeatures:r}),v.supportsGPUTimestampQuery=n,v.canvasContext.configure({device:v.device,format:v.pixelFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT}),new cn};let Xt=cn;const Hr=document.getElementById("c"),ce=await Xt.initialize(Hr);ce===void 0&&document.getElementById("no-webgpu-wrapper").style.setProperty("display","block");const ae={"Play Animation":!0,"Performance Stats":!1,"Enable TAA":!0,"Debug G-Buffer":!1,"Debug Shadow Map":!1,"Debug Shadow Cascades":!1,"Shadow Map Size":2048,"Debug Point Lights Mask":!1,"Render 2nd Floor Points":!0,"Enable SSR":!0,"SSR Method":"hi-z","SSR Max Iterations":30,"Debug No Info Rays":!1,"Sun Intensity":2,"Sun Position X":.1,"Sun Position Y":100,"Sun Position Z":.1,"Debug Skybox":!0,"Enable Bloom":!0,"Bloom Filter Radius":.0035,"Enable SSAO":!0,"SSAO Kernel Size":8,"SSAO Radius":.2,"SSAO Strength":3};function Hc(){const s=innerWidth,e=innerHeight;Hr.width=s,Hr.height=e,Hr.style.setProperty("width",`${s}px`),Hr.style.setProperty("height",`${e}px`),ce.resize(s,e)}function Jc(){document.getElementById("logo").classList.toggle("faded"),document.getElementById("timings-debug-container").classList.toggle("faded")}ce.onIntroAnimComplete=function(){const s=new ul({width:270});s.close(),s.add(ae,"Play Animation").onChange(l=>{ce.enableAnimation=l}),s.add(ae,"Performance Stats").onChange(()=>{ce.toggleStatsVisibility()}),s.add(ae,"Debug G-Buffer").onChange(l=>{ce.debugGBuffer=l,Jc(),l&&ae["Debug Shadow Map"]&&(ae["Debug Shadow Map"]=!1)}).listen();const e=s.addFolder("Lighting");e.open(),e.add(ae,"Sun Intensity",0,100).onChange(l=>{ce.sunIntensity=l}),e.add(ae,"Sun Position X",-60,60,.5).onChange(l=>{ce.sunPositionZ=l}),e.add(ae,"Sun Position Z",-150,150,.5).onChange(l=>{ce.sunPositionX=l});const t=s.addFolder("Shadow");t.open(),t.add(ae,"Debug Shadow Map").onChange(l=>{ce.debugShadowMap=l,Jc(),l&&ae["Debug G-Buffer"]&&(ae["Debug G-Buffer"]=!1)}).listen(),t.add(ae,"Shadow Map Size",[512,1024,2048,4096]).onChange(l=>{ce.shadowMapSize=parseInt(l)}),t.add(ae,"Debug Shadow Cascades").onChange(l=>{ce.debugShadowCascadeIndex=l});let r=ae["Enable Bloom"];e.add(ae,"Debug Point Lights Mask").onChange(l=>{l?(r=ae["Enable Bloom"],ae["Enable Bloom"]=!1,ce.bloomEnabled=!1):r&&(ae["Enable Bloom"]=!0,ce.bloomEnabled=!0),ce.debugLightsMask=l}),e.add(ae,"Render 2nd Floor Points").onChange(l=>{ce.render2ndFloorPoints=l});const n=s.addFolder("Screen space Ambient Occlusion");n.open(),n.add(ae,"Enable SSAO").onChange(l=>{ce.ssaoEnabled=l}),n.add(ae,"SSAO Kernel Size",8,128,1).onChange(l=>{ce.ssaoKernelSize=l}),n.add(ae,"SSAO Radius",0,1).onChange(l=>{ce.ssaoRadius=l}),n.add(ae,"SSAO Strength",0,5).onChange(l=>{ce.ssaoStrength=l});const i=s.addFolder("Screen space Reflections");i.open(),i.add(ae,"Enable SSR").onChange(l=>{ce.ssrEnabled=l}),i.add(ae,"SSR Method",["hi-z","linear"]).onChange(l=>{ce.ssrIsHiZ=l==="hi-z"}),i.add(ae,"SSR Max Iterations",0,1500,1).onChange(l=>{ce.ssrMaxIterations=l}),i.add(ae,"Debug No Info Rays").onChange(l=>{ce.debugMissedSSR=l});const o=s.addFolder("Bloom");o.open(),o.add(ae,"Enable Bloom").onChange(l=>{ce.bloomEnabled=l}).listen(),o.add(ae,"Bloom Filter Radius",.001,.005,5e-4).onChange(l=>{ce.bloomFilterRadius=l});const u=s.addFolder("Anti-Aliasing");u.open(),u.add(ae,"Enable TAA").onChange(l=>{ce.enableTAA=l})},requestAnimationFrame(function s(){const e=performance.now();ce.renderFrame(e),requestAnimationFrame(s)}),window.addEventListener("resize",Hc),Hc()})();
