var tm=Object.defineProperty;var rm=(Ue,Ye,qe)=>Ye in Ue?tm(Ue,Ye,{enumerable:!0,configurable:!0,writable:!0,value:qe}):Ue[Ye]=qe;var ee=(Ue,Ye,qe)=>rm(Ue,typeof Ye!="symbol"?Ye+"":Ye,qe);(async()=>{var Yc,qc;function Ue(s,e){var t=s.__state.conversionName.toString(),r=Math.round(s.r),n=Math.round(s.g),i=Math.round(s.b),o=s.a,c=Math.round(s.h),d=s.s.toFixed(1),g=s.v.toFixed(1);if(e||t==="THREE_CHAR_HEX"||t==="SIX_CHAR_HEX"){for(var b=s.hex.toString(16);b.length<6;)b="0"+b;return"#"+b}return t==="CSS_RGB"?"rgb("+r+","+n+","+i+")":t==="CSS_RGBA"?"rgba("+r+","+n+","+i+","+o+")":t==="HEX"?"0x"+s.hex.toString(16):t==="RGB_ARRAY"?"["+r+","+n+","+i+"]":t==="RGBA_ARRAY"?"["+r+","+n+","+i+","+o+"]":t==="RGB_OBJ"?"{r:"+r+",g:"+n+",b:"+i+"}":t==="RGBA_OBJ"?"{r:"+r+",g:"+n+",b:"+i+",a:"+o+"}":t==="HSV_OBJ"?"{h:"+c+",s:"+d+",v:"+g+"}":t==="HSVA_OBJ"?"{h:"+c+",s:"+d+",v:"+g+",a:"+o+"}":"unknown format"}(function(){const s=document.createElement("link").relList;if(!(s&&s.supports&&s.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const r=function(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}(t);fetch(t.href,r)}})();var Ye=Array.prototype.forEach,qe=Array.prototype.slice,N={BREAK:{},extend:function(s){return this.each(qe.call(arguments,1),function(e){(this.isObject(e)?Object.keys(e):[]).forEach((function(t){this.isUndefined(e[t])||(s[t]=e[t])}).bind(this))},this),s},defaults:function(s){return this.each(qe.call(arguments,1),function(e){(this.isObject(e)?Object.keys(e):[]).forEach((function(t){this.isUndefined(s[t])&&(s[t]=e[t])}).bind(this))},this),s},compose:function(){var s=qe.call(arguments);return function(){for(var e=qe.call(arguments),t=s.length-1;t>=0;t--)e=[s[t].apply(this,e)];return e[0]}},each:function(s,e,t){if(s){if(Ye&&s.forEach&&s.forEach===Ye)s.forEach(e,t);else if(s.length===s.length+0){var r,n=void 0;for(n=0,r=s.length;n<r;n++)if(n in s&&e.call(t,s[n],n)===this.BREAK)return}else for(var i in s)if(e.call(t,s[i],i)===this.BREAK)return}},defer:function(s){setTimeout(s,0)},debounce:function(s,e,t){var r=void 0;return function(){var n=this,i=arguments,o=t||!r;clearTimeout(r),r=setTimeout(function(){r=null,t||s.apply(n,i)},e),o&&s.apply(n,i)}},toArray:function(s){return s.toArray?s.toArray():qe.call(s)},isUndefined:function(s){return s===void 0},isNull:function(s){return s===null},isNaN:function(s){function e(t){return s.apply(this,arguments)}return e.toString=function(){return s.toString()},e}(function(s){return isNaN(s)}),isArray:Array.isArray||function(s){return s.constructor===Array},isObject:function(s){return s===Object(s)},isNumber:function(s){return s===s+0},isString:function(s){return s===s+""},isBoolean:function(s){return s===!1||s===!0},isFunction:function(s){return s instanceof Function}},tl=[{litmus:N.isString,conversions:{THREE_CHAR_HEX:{read:function(s){var e=s.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return e!==null&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString(),0)}},write:Ue},SIX_CHAR_HEX:{read:function(s){var e=s.match(/^#([A-F0-9]{6})$/i);return e!==null&&{space:"HEX",hex:parseInt("0x"+e[1].toString(),0)}},write:Ue},CSS_RGB:{read:function(s){var e=s.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e!==null&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:Ue},CSS_RGBA:{read:function(s){var e=s.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e!==null&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:Ue}}},{litmus:N.isNumber,conversions:{HEX:{read:function(s){return{space:"HEX",hex:s,conversionName:"HEX"}},write:function(s){return s.hex}}}},{litmus:N.isArray,conversions:{RGB_ARRAY:{read:function(s){return s.length===3&&{space:"RGB",r:s[0],g:s[1],b:s[2]}},write:function(s){return[s.r,s.g,s.b]}},RGBA_ARRAY:{read:function(s){return s.length===4&&{space:"RGB",r:s[0],g:s[1],b:s[2],a:s[3]}},write:function(s){return[s.r,s.g,s.b,s.a]}}}},{litmus:N.isObject,conversions:{RGBA_OBJ:{read:function(s){return!!(N.isNumber(s.r)&&N.isNumber(s.g)&&N.isNumber(s.b)&&N.isNumber(s.a))&&{space:"RGB",r:s.r,g:s.g,b:s.b,a:s.a}},write:function(s){return{r:s.r,g:s.g,b:s.b,a:s.a}}},RGB_OBJ:{read:function(s){return!!(N.isNumber(s.r)&&N.isNumber(s.g)&&N.isNumber(s.b))&&{space:"RGB",r:s.r,g:s.g,b:s.b}},write:function(s){return{r:s.r,g:s.g,b:s.b}}},HSVA_OBJ:{read:function(s){return!!(N.isNumber(s.h)&&N.isNumber(s.s)&&N.isNumber(s.v)&&N.isNumber(s.a))&&{space:"HSV",h:s.h,s:s.s,v:s.v,a:s.a}},write:function(s){return{h:s.h,s:s.s,v:s.v,a:s.a}}},HSV_OBJ:{read:function(s){return!!(N.isNumber(s.h)&&N.isNumber(s.s)&&N.isNumber(s.v))&&{space:"HSV",h:s.h,s:s.s,v:s.v}},write:function(s){return{h:s.h,s:s.s,v:s.v}}}}}],_r=void 0,Yr=void 0,Bn=function(){Yr=!1;var s=arguments.length>1?N.toArray(arguments):arguments[0];return N.each(tl,function(e){if(e.litmus(s))return N.each(e.conversions,function(t,r){if(_r=t.read(s),Yr===!1&&_r!==!1)return Yr=_r,_r.conversionName=r,_r.conversion=t,N.BREAK}),N.BREAK}),Yr},yo=void 0,qr={hsv_to_rgb:function(s,e,t){var r=Math.floor(s/60)%6,n=s/60-Math.floor(s/60),i=t*(1-e),o=t*(1-n*e),c=t*(1-(1-n)*e),d=[[t,c,i],[o,t,i],[i,t,c],[i,o,t],[c,i,t],[t,i,o]][r];return{r:255*d[0],g:255*d[1],b:255*d[2]}},rgb_to_hsv:function(s,e,t){var r=Math.min(s,e,t),n=Math.max(s,e,t),i=n-r,o=void 0;return n===0?{h:NaN,s:0,v:0}:(o=s===n?(e-t)/i:e===n?2+(t-s)/i:4+(s-e)/i,(o/=6)<0&&(o+=1),{h:360*o,s:i/n,v:n/255})},rgb_to_hex:function(s,e,t){var r=this.hex_with_component(0,2,s);return r=this.hex_with_component(r,1,e),r=this.hex_with_component(r,0,t)},component_from_hex:function(s,e){return s>>8*e&255},hex_with_component:function(s,e,t){return t<<(yo=8*e)|s&~(255<<yo)}},rl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(s){return typeof s}:function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},je=function(s,e){if(!(s instanceof e))throw new TypeError("Cannot call a class as a function")},Je=function(){function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}}(),pt=function s(e,t,r){e===null&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,t);if(n===void 0){var i=Object.getPrototypeOf(e);return i===null?void 0:s(i,t,r)}if("value"in n)return n.value;var o=n.get;return o!==void 0?o.call(r):void 0},mt=function(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(s,e):s.__proto__=e)},gt=function(s,e){if(!s)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||typeof e!="object"&&typeof e!="function"?s:e},ge=function(){function s(){if(je(this,s),this.__state=Bn.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return Je(s,[{key:"toString",value:function(){return Ue(this)}},{key:"toHexString",value:function(){return Ue(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),s}();function An(s,e,t){Object.defineProperty(s,e,{get:function(){return this.__state.space==="RGB"||ge.recalculateRGB(this,e,t),this.__state[e]},set:function(r){this.__state.space!=="RGB"&&(ge.recalculateRGB(this,e,t),this.__state.space="RGB"),this.__state[e]=r}})}function vn(s,e){Object.defineProperty(s,e,{get:function(){return this.__state.space==="HSV"||ge.recalculateHSV(this),this.__state[e]},set:function(t){this.__state.space!=="HSV"&&(ge.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=t}})}ge.recalculateRGB=function(s,e,t){if(s.__state.space==="HEX")s.__state[e]=qr.component_from_hex(s.__state.hex,t);else{if(s.__state.space!=="HSV")throw new Error("Corrupted color state");N.extend(s.__state,qr.hsv_to_rgb(s.__state.h,s.__state.s,s.__state.v))}},ge.recalculateHSV=function(s){var e=qr.rgb_to_hsv(s.r,s.g,s.b);N.extend(s.__state,{s:e.s,v:e.v}),N.isNaN(e.h)?N.isUndefined(s.__state.h)&&(s.__state.h=0):s.__state.h=e.h},ge.COMPONENTS=["r","g","b","h","s","v","hex","a"],An(ge.prototype,"r",2),An(ge.prototype,"g",1),An(ge.prototype,"b",0),vn(ge.prototype,"h"),vn(ge.prototype,"s"),vn(ge.prototype,"v"),Object.defineProperty(ge.prototype,"a",{get:function(){return this.__state.a},set:function(s){this.__state.a=s}}),Object.defineProperty(ge.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=qr.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(s){this.__state.space="HEX",this.__state.hex=s}});var Mt=function(){function s(e,t){je(this,s),this.initialValue=e[t],this.domElement=document.createElement("div"),this.object=e,this.property=t,this.__onChange=void 0,this.__onFinishChange=void 0}return Je(s,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),s}(),bo={};N.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(s,e){N.each(s,function(t){bo[t]=e})});var sl=/(\d+(\.\d+)?)px/;function Qe(s){if(s==="0"||N.isUndefined(s))return 0;var e=s.match(sl);return N.isNull(e)?0:parseFloat(e[1])}var I={makeSelectable:function(s,e){s!==void 0&&s.style!==void 0&&(s.onselectstart=e?function(){return!1}:function(){},s.style.MozUserSelect=e?"auto":"none",s.style.KhtmlUserSelect=e?"auto":"none",s.unselectable=e?"on":"off")},makeFullscreen:function(s,e,t){var r=t,n=e;N.isUndefined(n)&&(n=!0),N.isUndefined(r)&&(r=!0),s.style.position="absolute",n&&(s.style.left=0,s.style.right=0),r&&(s.style.top=0,s.style.bottom=0)},fakeEvent:function(s,e,t,r){var n=t||{},i=bo[e];if(!i)throw new Error("Event type "+e+" not supported.");var o=document.createEvent(i);switch(i){case"MouseEvents":var c=n.x||n.clientX||0,d=n.y||n.clientY||0;o.initMouseEvent(e,n.bubbles||!1,n.cancelable||!0,window,n.clickCount||1,0,0,c,d,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var g=o.initKeyboardEvent||o.initKeyEvent;N.defaults(n,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),g(e,n.bubbles||!1,n.cancelable,window,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.keyCode,n.charCode);break;default:o.initEvent(e,n.bubbles||!1,n.cancelable||!0)}N.defaults(o,r),s.dispatchEvent(o)},bind:function(s,e,t,r){var n=r||!1;return s.addEventListener?s.addEventListener(e,t,n):s.attachEvent&&s.attachEvent("on"+e,t),I},unbind:function(s,e,t,r){var n=r||!1;return s.removeEventListener?s.removeEventListener(e,t,n):s.detachEvent&&s.detachEvent("on"+e,t),I},addClass:function(s,e){if(s.className===void 0)s.className=e;else if(s.className!==e){var t=s.className.split(/ +/);t.indexOf(e)===-1&&(t.push(e),s.className=t.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return I},removeClass:function(s,e){if(e)if(s.className===e)s.removeAttribute("class");else{var t=s.className.split(/ +/),r=t.indexOf(e);r!==-1&&(t.splice(r,1),s.className=t.join(" "))}else s.className=void 0;return I},hasClass:function(s,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(s.className)||!1},getWidth:function(s){var e=getComputedStyle(s);return Qe(e["border-left-width"])+Qe(e["border-right-width"])+Qe(e["padding-left"])+Qe(e["padding-right"])+Qe(e.width)},getHeight:function(s){var e=getComputedStyle(s);return Qe(e["border-top-width"])+Qe(e["border-bottom-width"])+Qe(e["padding-top"])+Qe(e["padding-bottom"])+Qe(e.height)},getOffset:function(s){var e=s,t={left:0,top:0};if(e.offsetParent)do t.left+=e.offsetLeft,t.top+=e.offsetTop,e=e.offsetParent;while(e);return t},isActive:function(s){return s===document.activeElement&&(s.type||s.href)}},xo=function(){function s(e,t){je(this,s);var r=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),n=r;return r.__prev=r.getValue(),r.__checkbox=document.createElement("input"),r.__checkbox.setAttribute("type","checkbox"),I.bind(r.__checkbox,"change",function(){n.setValue(!n.__prev)},!1),r.domElement.appendChild(r.__checkbox),r.updateDisplay(),r}return mt(s,Mt),Je(s,[{key:"setValue",value:function(e){var t=pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),t}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}(),nl=function(){function s(e,t,r){je(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),i=r,o=n;if(n.__select=document.createElement("select"),N.isArray(i)){var c={};N.each(i,function(d){c[d]=d}),i=c}return N.each(i,function(d,g){var b=document.createElement("option");b.innerHTML=g,b.setAttribute("value",d),o.__select.appendChild(b)}),n.updateDisplay(),I.bind(n.__select,"change",function(){var d=this.options[this.selectedIndex].value;o.setValue(d)}),n.domElement.appendChild(n.__select),n}return mt(s,Mt),Je(s,[{key:"setValue",value:function(e){var t=pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),t}},{key:"updateDisplay",value:function(){return I.isActive(this.__select)?this:(this.__select.value=this.getValue(),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this))}}]),s}(),il=function(){function s(e,t){je(this,s);var r=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),n=r;function i(){n.setValue(n.__input.value)}return r.__input=document.createElement("input"),r.__input.setAttribute("type","text"),I.bind(r.__input,"keyup",i),I.bind(r.__input,"change",i),I.bind(r.__input,"blur",function(){n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())}),I.bind(r.__input,"keydown",function(o){o.keyCode===13&&this.blur()}),r.updateDisplay(),r.domElement.appendChild(r.__input),r}return mt(s,Mt),Je(s,[{key:"updateDisplay",value:function(){return I.isActive(this.__input)||(this.__input.value=this.getValue()),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}();function _o(s){var e=s.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var Bo=function(){function s(e,t,r){je(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),i=r||{};return n.__min=i.min,n.__max=i.max,n.__step=i.step,N.isUndefined(n.__step)?n.initialValue===0?n.__impliedStep=1:n.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(n.initialValue))/Math.LN10))/10:n.__impliedStep=n.__step,n.__precision=_o(n.__impliedStep),n}return mt(s,Mt),Je(s,[{key:"setValue",value:function(e){var t=e;return this.__min!==void 0&&t<this.__min?t=this.__min:this.__max!==void 0&&t>this.__max&&(t=this.__max),this.__step!==void 0&&t%this.__step!=0&&(t=Math.round(t/this.__step)*this.__step),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"setValue",this).call(this,t)}},{key:"min",value:function(e){return this.__min=e,this}},{key:"max",value:function(e){return this.__max=e,this}},{key:"step",value:function(e){return this.__step=e,this.__impliedStep=e,this.__precision=_o(e),this}}]),s}(),Qr=function(){function s(e,t,r){je(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t,r));n.__truncationSuspended=!1;var i=n,o=void 0;function c(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}function d(b){var l=o-b.clientY;i.setValue(i.getValue()+l*i.__impliedStep),o=b.clientY}function g(){I.unbind(window,"mousemove",d),I.unbind(window,"mouseup",g),c()}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),I.bind(n.__input,"change",function(){var b=parseFloat(i.__input.value);N.isNaN(b)||i.setValue(b)}),I.bind(n.__input,"blur",function(){c()}),I.bind(n.__input,"mousedown",function(b){I.bind(window,"mousemove",d),I.bind(window,"mouseup",g),o=b.clientY}),I.bind(n.__input,"keydown",function(b){b.keyCode===13&&(i.__truncationSuspended=!0,this.blur(),i.__truncationSuspended=!1,c())}),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return mt(s,Bo),Je(s,[{key:"updateDisplay",value:function(){var e,t,r;return this.__input.value=this.__truncationSuspended?this.getValue():(e=this.getValue(),t=this.__precision,r=Math.pow(10,t),Math.round(e*r)/r),pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}();function Ao(s,e,t,r,n){return r+(s-e)/(t-e)*(n-r)}var wn=function(){function s(e,t,r,n,i){je(this,s);var o=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t,{min:r,max:n,step:i})),c=o;function d(x){x.preventDefault();var m=c.__background.getBoundingClientRect();return c.setValue(Ao(x.clientX,m.left,m.right,c.__min,c.__max)),!1}function g(){I.unbind(window,"mousemove",d),I.unbind(window,"mouseup",g),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}function b(x){var m=x.touches[0].clientX,_=c.__background.getBoundingClientRect();c.setValue(Ao(m,_.left,_.right,c.__min,c.__max))}function l(){I.unbind(window,"touchmove",b),I.unbind(window,"touchend",l),c.__onFinishChange&&c.__onFinishChange.call(c,c.getValue())}return o.__background=document.createElement("div"),o.__foreground=document.createElement("div"),I.bind(o.__background,"mousedown",function(x){document.activeElement.blur(),I.bind(window,"mousemove",d),I.bind(window,"mouseup",g),d(x)}),I.bind(o.__background,"touchstart",function(x){x.touches.length===1&&(I.bind(window,"touchmove",b),I.bind(window,"touchend",l),b(x))}),I.addClass(o.__background,"slider"),I.addClass(o.__foreground,"slider-fg"),o.updateDisplay(),o.__background.appendChild(o.__foreground),o.domElement.appendChild(o.__background),o}return mt(s,Bo),Je(s,[{key:"updateDisplay",value:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",pt(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"updateDisplay",this).call(this)}}]),s}(),vo=function(){function s(e,t,r){je(this,s);var n=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t)),i=n;return n.__button=document.createElement("div"),n.__button.innerHTML=r===void 0?"Fire":r,I.bind(n.__button,"click",function(o){return o.preventDefault(),i.fire(),!1}),I.addClass(n.__button,"button"),n.domElement.appendChild(n.__button),n}return mt(s,Mt),Je(s,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),s}(),Cn=function(){function s(e,t){je(this,s);var r=gt(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e,t));r.__color=new ge(r.getValue()),r.__temp=new ge(0);var n=r;r.domElement=document.createElement("div"),I.makeSelectable(r.domElement,!1),r.__selector=document.createElement("div"),r.__selector.className="selector",r.__saturation_field=document.createElement("div"),r.__saturation_field.className="saturation-field",r.__field_knob=document.createElement("div"),r.__field_knob.className="field-knob",r.__field_knob_border="2px solid ",r.__hue_knob=document.createElement("div"),r.__hue_knob.className="hue-knob",r.__hue_field=document.createElement("div"),r.__hue_field.className="hue-field",r.__input=document.createElement("input"),r.__input.type="text",r.__input_textShadow="0 1px 1px ",I.bind(r.__input,"keydown",function(w){w.keyCode===13&&l.call(this)}),I.bind(r.__input,"blur",l),I.bind(r.__selector,"mousedown",function(){I.addClass(this,"drag").bind(window,"mouseup",function(){I.removeClass(n.__selector,"drag")})}),I.bind(r.__selector,"touchstart",function(){I.addClass(this,"drag").bind(window,"touchend",function(){I.removeClass(n.__selector,"drag")})});var i,o=document.createElement("div");function c(w){m(w),I.bind(window,"mousemove",m),I.bind(window,"touchmove",m),I.bind(window,"mouseup",g),I.bind(window,"touchend",g)}function d(w){_(w),I.bind(window,"mousemove",_),I.bind(window,"touchmove",_),I.bind(window,"mouseup",b),I.bind(window,"touchend",b)}function g(){I.unbind(window,"mousemove",m),I.unbind(window,"touchmove",m),I.unbind(window,"mouseup",g),I.unbind(window,"touchend",g),x()}function b(){I.unbind(window,"mousemove",_),I.unbind(window,"touchmove",_),I.unbind(window,"mouseup",b),I.unbind(window,"touchend",b),x()}function l(){var w=Bn(this.value);w!==!1?(n.__color.__state=w,n.setValue(n.__color.toOriginal())):this.value=n.__color.toString()}function x(){n.__onFinishChange&&n.__onFinishChange.call(n,n.__color.toOriginal())}function m(w){w.type.indexOf("touch")===-1&&w.preventDefault();var f=n.__saturation_field.getBoundingClientRect(),p=w.touches&&w.touches[0]||w,a=p.clientX,u=p.clientY,h=(a-f.left)/(f.right-f.left),y=1-(u-f.top)/(f.bottom-f.top);return y>1?y=1:y<0&&(y=0),h>1?h=1:h<0&&(h=0),n.__color.v=y,n.__color.s=h,n.setValue(n.__color.toOriginal()),!1}function _(w){w.type.indexOf("touch")===-1&&w.preventDefault();var f=n.__hue_field.getBoundingClientRect(),p=1-((w.touches&&w.touches[0]||w).clientY-f.top)/(f.bottom-f.top);return p>1?p=1:p<0&&(p=0),n.__color.h=360*p,n.setValue(n.__color.toOriginal()),!1}return N.extend(r.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),N.extend(r.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:r.__field_knob_border+(r.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),N.extend(r.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),N.extend(r.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),N.extend(o.style,{width:"100%",height:"100%",background:"none"}),wo(o,"top","rgba(0,0,0,0)","#000"),N.extend(r.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(i=r.__hue_field).style.background="",i.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",i.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",N.extend(r.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:r.__input_textShadow+"rgba(0,0,0,0.7)"}),I.bind(r.__saturation_field,"mousedown",c),I.bind(r.__saturation_field,"touchstart",c),I.bind(r.__field_knob,"mousedown",c),I.bind(r.__field_knob,"touchstart",c),I.bind(r.__hue_field,"mousedown",d),I.bind(r.__hue_field,"touchstart",d),r.__saturation_field.appendChild(o),r.__selector.appendChild(r.__field_knob),r.__selector.appendChild(r.__saturation_field),r.__selector.appendChild(r.__hue_field),r.__hue_field.appendChild(r.__hue_knob),r.domElement.appendChild(r.__input),r.domElement.appendChild(r.__selector),r.updateDisplay(),r}return mt(s,Mt),Je(s,[{key:"updateDisplay",value:function(){var e=Bn(this.getValue());if(e!==!1){var t=!1;N.each(ge.COMPONENTS,function(i){if(!N.isUndefined(e[i])&&!N.isUndefined(this.__color.__state[i])&&e[i]!==this.__color.__state[i])return t=!0,{}},this),t&&N.extend(this.__color.__state,e)}N.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var r=this.__color.v<.5||this.__color.s>.5?255:0,n=255-r;N.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+r+","+r+","+r+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,wo(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),N.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+r+","+r+","+r+")",textShadow:this.__input_textShadow+"rgba("+n+","+n+","+n+",.7)"})}}]),s}(),ol=["-moz-","-o-","-webkit-","-ms-",""];function wo(s,e,t,r){s.style.background="",N.each(ol,function(n){s.style.cssText+="background: "+n+"linear-gradient("+e+", "+t+" 0%, "+r+" 100%); "})}var al=function(s,e){var t=e||document,r=document.createElement("style");r.type="text/css",r.innerHTML=s;var n=t.getElementsByTagName("head")[0];try{n.appendChild(r)}catch{}},ul=function(s,e){var t=s[e];return N.isArray(arguments[2])||N.isObject(arguments[2])?new nl(s,e,arguments[2]):N.isNumber(t)?N.isNumber(arguments[2])&&N.isNumber(arguments[3])?N.isNumber(arguments[4])?new wn(s,e,arguments[2],arguments[3],arguments[4]):new wn(s,e,arguments[2],arguments[3]):N.isNumber(arguments[4])?new Qr(s,e,{min:arguments[2],max:arguments[3],step:arguments[4]}):new Qr(s,e,{min:arguments[2],max:arguments[3]}):N.isString(t)?new il(s,e):N.isFunction(t)?new vo(s,e,""):N.isBoolean(t)?new xo(s,e):null},cl=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(s){setTimeout(s,1e3/60)},ll=function(){function s(){je(this,s),this.backgroundElement=document.createElement("div"),N.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),I.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),N.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;I.bind(this.backgroundElement,"click",function(){e.hide()})}return Je(s,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),N.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var e=this,t=function r(){e.domElement.style.display="none",e.backgroundElement.style.display="none",I.unbind(e.domElement,"webkitTransitionEnd",r),I.unbind(e.domElement,"transitionend",r),I.unbind(e.domElement,"oTransitionEnd",r)};I.bind(this.domElement,"webkitTransitionEnd",t),I.bind(this.domElement,"transitionend",t),I.bind(this.domElement,"oTransitionEnd",t),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-I.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-I.getHeight(this.domElement)/2+"px"}}]),s}(),dl=function(s){if(typeof window<"u"){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=s,document.head.appendChild(e),s}}(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);al(dl);var Br="Default",Ar=function(){try{return!!window.localStorage}catch{return!1}}(),$r=void 0,Co=!0,qt=void 0,Tn=!1,To=[],ce=function s(e){var t=this,r=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),I.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],r=N.defaults(r,{closeOnTop:!1,autoPlace:!0,width:s.DEFAULT_WIDTH}),r=N.defaults(r,{resizable:r.autoPlace,hideable:r.autoPlace}),N.isUndefined(r.load)?r.load={preset:Br}:r.preset&&(r.load.preset=r.preset),N.isUndefined(r.parent)&&r.hideable&&To.push(this),r.resizable=N.isUndefined(r.parent)&&r.resizable,r.autoPlace&&N.isUndefined(r.scrollable)&&(r.scrollable=!0);var n,i=Ar&&localStorage.getItem(Qt(this,"isLocal"))==="true",o=void 0,c=void 0;if(Object.defineProperties(this,{parent:{get:function(){return r.parent}},scrollable:{get:function(){return r.scrollable}},autoPlace:{get:function(){return r.autoPlace}},closeOnTop:{get:function(){return r.closeOnTop}},preset:{get:function(){return t.parent?t.getRoot().preset:r.load.preset},set:function(b){t.parent?t.getRoot().preset=b:r.load.preset=b,function(l){for(var x=0;x<l.__preset_select.length;x++)l.__preset_select[x].value===l.preset&&(l.__preset_select.selectedIndex=x)}(this),t.revert()}},width:{get:function(){return r.width},set:function(b){r.width=b,Pn(t,b)}},name:{get:function(){return r.name},set:function(b){r.name=b,c&&(c.innerHTML=r.name)}},closed:{get:function(){return r.closed},set:function(b){r.closed=b,r.closed?I.addClass(t.__ul,s.CLASS_CLOSED):I.removeClass(t.__ul,s.CLASS_CLOSED),this.onResize(),t.__closeButton&&(t.__closeButton.innerHTML=b?s.TEXT_OPEN:s.TEXT_CLOSED)}},load:{get:function(){return r.load}},useLocalStorage:{get:function(){return i},set:function(b){Ar&&(i=b,b?I.bind(window,"unload",o):I.unbind(window,"unload",o),localStorage.setItem(Qt(t,"isLocal"),b))}}}),N.isUndefined(r.parent)){if(this.closed=r.closed||!1,I.addClass(this.domElement,s.CLASS_MAIN),I.makeSelectable(this.domElement,!1),Ar&&i){t.useLocalStorage=!0;var d=localStorage.getItem(Qt(this,"gui"));d&&(r.load=JSON.parse(d))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=s.TEXT_CLOSED,I.addClass(this.__closeButton,s.CLASS_CLOSE_BUTTON),r.closeOnTop?(I.addClass(this.__closeButton,s.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(I.addClass(this.__closeButton,s.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),I.bind(this.__closeButton,"click",function(){t.closed=!t.closed})}else{r.closed===void 0&&(r.closed=!0);var g=document.createTextNode(r.name);I.addClass(g,"controller-name"),c=Sn(t,g),I.addClass(this.__ul,s.CLASS_CLOSED),I.addClass(c,"title"),I.bind(c,"click",function(b){return b.preventDefault(),t.closed=!t.closed,!1}),r.closed||(this.closed=!1)}r.autoPlace&&(N.isUndefined(r.parent)&&(Co&&(qt=document.createElement("div"),I.addClass(qt,"dg"),I.addClass(qt,s.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(qt),Co=!1),qt.appendChild(this.domElement),I.addClass(this.domElement,s.CLASS_AUTO_PLACE)),this.parent||Pn(t,r.width)),this.__resizeHandler=function(){t.onResizeDebounced()},I.bind(window,"resize",this.__resizeHandler),I.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),I.bind(this.__ul,"transitionend",this.__resizeHandler),I.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),r.resizable&&hl(this),o=function(){Ar&&localStorage.getItem(Qt(t,"isLocal"))==="true"&&localStorage.setItem(Qt(t,"gui"),JSON.stringify(t.getSaveObject()))},this.saveToLocalStorageIfPossible=o,r.parent||((n=t.getRoot()).width+=1,N.defer(function(){n.width-=1}))};function Sn(s,e,t){var r=document.createElement("li");return e&&r.appendChild(e),t?s.__ul.insertBefore(r,t):s.__ul.appendChild(r),s.onResize(),r}function So(s){I.unbind(window,"resize",s.__resizeHandler),s.saveToLocalStorageIfPossible&&I.unbind(window,"unload",s.saveToLocalStorageIfPossible)}function En(s,e){var t=s.__preset_select[s.__preset_select.selectedIndex];t.innerHTML=e?t.value+"*":t.value}function Eo(s,e){var t=s.getRoot(),r=t.__rememberedObjects.indexOf(e.object);if(r!==-1){var n=t.__rememberedObjectIndecesToControllers[r];if(n===void 0&&(n={},t.__rememberedObjectIndecesToControllers[r]=n),n[e.property]=e,t.load&&t.load.remembered){var i=t.load.remembered,o=void 0;if(i[s.preset])o=i[s.preset];else{if(!i[Br])return;o=i[Br]}if(o[r]&&o[r][e.property]!==void 0){var c=o[r][e.property];e.initialValue=c,e.setValue(c)}}}}function vr(s,e,t,r){if(e[t]===void 0)throw new Error('Object "'+e+'" has no property "'+t+'"');var n=void 0;if(r.color)n=new Cn(e,t);else{var i=[e,t].concat(r.factoryArgs);n=ul.apply(s,i)}r.before instanceof Mt&&(r.before=r.before.__li),Eo(s,n),I.addClass(n.domElement,"c");var o=document.createElement("span");I.addClass(o,"property-name"),o.innerHTML=n.property;var c=document.createElement("div");c.appendChild(o),c.appendChild(n.domElement);var d=Sn(s,c,r.before);return I.addClass(d,ce.CLASS_CONTROLLER_ROW),n instanceof Cn?I.addClass(d,"color"):I.addClass(d,rl(n.getValue())),function(g,b,l){if(l.__li=b,l.__gui=g,N.extend(l,{options:function(_){if(arguments.length>1){var w=l.__li.nextElementSibling;return l.remove(),vr(g,l.object,l.property,{before:w,factoryArgs:[N.toArray(arguments)]})}if(N.isArray(_)||N.isObject(_)){var f=l.__li.nextElementSibling;return l.remove(),vr(g,l.object,l.property,{before:f,factoryArgs:[_]})}},name:function(_){return l.__li.firstElementChild.firstElementChild.innerHTML=_,l},listen:function(){return l.__gui.listen(l),l},remove:function(){return l.__gui.remove(l),l}}),l instanceof wn){var x=new Qr(l.object,l.property,{min:l.__min,max:l.__max,step:l.__step});N.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(_){var w=l[_],f=x[_];l[_]=x[_]=function(){var p=Array.prototype.slice.call(arguments);return f.apply(x,p),w.apply(l,p)}}),I.addClass(b,"has-slider"),l.domElement.insertBefore(x.domElement,l.domElement.firstElementChild)}else if(l instanceof Qr){var m=function(_){if(N.isNumber(l.__min)&&N.isNumber(l.__max)){var w=l.__li.firstElementChild.firstElementChild.innerHTML,f=l.__gui.__listening.indexOf(l)>-1;l.remove();var p=vr(g,l.object,l.property,{before:l.__li.nextElementSibling,factoryArgs:[l.__min,l.__max,l.__step]});return p.name(w),f&&p.listen(),p}return _};l.min=N.compose(m,l.min),l.max=N.compose(m,l.max)}else l instanceof xo?(I.bind(b,"click",function(){I.fakeEvent(l.__checkbox,"click")}),I.bind(l.__checkbox,"click",function(_){_.stopPropagation()})):l instanceof vo?(I.bind(b,"click",function(){I.fakeEvent(l.__button,"click")}),I.bind(b,"mouseover",function(){I.addClass(l.__button,"hover")}),I.bind(b,"mouseout",function(){I.removeClass(l.__button,"hover")})):l instanceof Cn&&(I.addClass(b,"color"),l.updateDisplay=N.compose(function(_){return b.style.borderLeftColor=l.__color.toString(),_},l.updateDisplay),l.updateDisplay());l.setValue=N.compose(function(_){return g.getRoot().__preset_select&&l.isModified()&&En(g.getRoot(),!0),_},l.setValue)}(s,d,n),s.__controllers.push(n),n}function Qt(s,e){return document.location.href+"."+e}function Mn(s,e,t){var r=document.createElement("option");r.innerHTML=e,r.value=e,s.__preset_select.appendChild(r),t&&(s.__preset_select.selectedIndex=s.__preset_select.length-1)}function Mo(s,e){e.style.display=s.useLocalStorage?"block":"none"}function hl(s){var e=void 0;function t(i){return i.preventDefault(),s.width+=e-i.clientX,s.onResize(),e=i.clientX,!1}function r(){I.removeClass(s.__closeButton,ce.CLASS_DRAG),I.unbind(window,"mousemove",t),I.unbind(window,"mouseup",r)}function n(i){return i.preventDefault(),e=i.clientX,I.addClass(s.__closeButton,ce.CLASS_DRAG),I.bind(window,"mousemove",t),I.bind(window,"mouseup",r),!1}s.__resize_handle=document.createElement("div"),N.extend(s.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),I.bind(s.__resize_handle,"mousedown",n),I.bind(s.__closeButton,"mousedown",n),s.domElement.insertBefore(s.__resize_handle,s.domElement.firstElementChild)}function Pn(s,e){s.domElement.style.width=e+"px",s.__save_row&&s.autoPlace&&(s.__save_row.style.width=e+"px"),s.__closeButton&&(s.__closeButton.style.width=e+"px")}function Zr(s,e){var t={};return N.each(s.__rememberedObjects,function(r,n){var i={},o=s.__rememberedObjectIndecesToControllers[n];N.each(o,function(c,d){i[d]=e?c.initialValue:c.getValue()}),t[n]=i}),t}function Po(s){s.length!==0&&cl.call(window,function(){Po(s)}),N.each(s,function(e){e.updateDisplay()})}ce.toggleHide=function(){Tn=!Tn,N.each(To,function(s){s.domElement.style.display=Tn?"none":""})},ce.CLASS_AUTO_PLACE="a",ce.CLASS_AUTO_PLACE_CONTAINER="ac",ce.CLASS_MAIN="main",ce.CLASS_CONTROLLER_ROW="cr",ce.CLASS_TOO_TALL="taller-than-window",ce.CLASS_CLOSED="closed",ce.CLASS_CLOSE_BUTTON="close-button",ce.CLASS_CLOSE_TOP="close-top",ce.CLASS_CLOSE_BOTTOM="close-bottom",ce.CLASS_DRAG="drag",ce.DEFAULT_WIDTH=245,ce.TEXT_CLOSED="Close Controls",ce.TEXT_OPEN="Open Controls",ce._keydownHandler=function(s){document.activeElement.type==="text"||s.which!==72&&s.keyCode!==72||ce.toggleHide()},I.bind(window,"keydown",ce._keydownHandler,!1),N.extend(ce.prototype,{add:function(s,e){return vr(this,s,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(s,e){return vr(this,s,e,{color:!0})},remove:function(s){this.__ul.removeChild(s.__li),this.__controllers.splice(this.__controllers.indexOf(s),1);var e=this;N.defer(function(){e.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&qt.removeChild(this.domElement);var s=this;N.each(this.__folders,function(e){s.removeFolder(e)}),I.unbind(window,"keydown",ce._keydownHandler,!1),So(this)},addFolder:function(s){if(this.__folders[s]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+s+'"');var e={name:s,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[s]&&(e.closed=this.load.folders[s].closed,e.load=this.load.folders[s]);var t=new ce(e);this.__folders[s]=t;var r=Sn(this,t.domElement);return I.addClass(r,"folder"),t},removeFolder:function(s){this.__ul.removeChild(s.domElement.parentElement),delete this.__folders[s.name],this.load&&this.load.folders&&this.load.folders[s.name]&&delete this.load.folders[s.name],So(s);var e=this;N.each(s.__folders,function(t){s.removeFolder(t)}),N.defer(function(){e.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var s=this.getRoot();if(s.scrollable){var e=I.getOffset(s.__ul).top,t=0;N.each(s.__ul.childNodes,function(r){s.autoPlace&&r===s.__save_row||(t+=I.getHeight(r))}),window.innerHeight-e-20<t?(I.addClass(s.domElement,ce.CLASS_TOO_TALL),s.__ul.style.height=window.innerHeight-e-20+"px"):(I.removeClass(s.domElement,ce.CLASS_TOO_TALL),s.__ul.style.height="auto")}s.__resize_handle&&N.defer(function(){s.__resize_handle.style.height=s.__ul.offsetHeight+"px"}),s.__closeButton&&(s.__closeButton.style.width=s.width+"px")},onResizeDebounced:N.debounce(function(){this.onResize()},50),remember:function(){if(N.isUndefined($r)&&(($r=new ll).domElement.innerHTML=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`),this.parent)throw new Error("You can only call remember on a top level GUI.");var s=this;N.each(Array.prototype.slice.call(arguments),function(e){s.__rememberedObjects.length===0&&function(t){var r=t.__save_row=document.createElement("li");I.addClass(t.domElement,"has-save"),t.__ul.insertBefore(r,t.__ul.firstChild),I.addClass(r,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;",I.addClass(n,"button gears");var i=document.createElement("span");i.innerHTML="Save",I.addClass(i,"button"),I.addClass(i,"save");var o=document.createElement("span");o.innerHTML="New",I.addClass(o,"button"),I.addClass(o,"save-as");var c=document.createElement("span");c.innerHTML="Revert",I.addClass(c,"button"),I.addClass(c,"revert");var d=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?N.each(t.load.remembered,function(x,m){Mn(t,m,m===t.preset)}):Mn(t,Br,!1),I.bind(d,"change",function(){for(var x=0;x<t.__preset_select.length;x++)t.__preset_select[x].innerHTML=t.__preset_select[x].value;t.preset=this.value}),r.appendChild(d),r.appendChild(n),r.appendChild(i),r.appendChild(o),r.appendChild(c),Ar){var g=document.getElementById("dg-local-explain"),b=document.getElementById("dg-local-storage");document.getElementById("dg-save-locally").style.display="block",localStorage.getItem(Qt(t,"isLocal"))==="true"&&b.setAttribute("checked","checked"),Mo(t,g),I.bind(b,"change",function(){t.useLocalStorage=!t.useLocalStorage,Mo(t,g)})}var l=document.getElementById("dg-new-constructor");I.bind(l,"keydown",function(x){!x.metaKey||x.which!==67&&x.keyCode!==67||$r.hide()}),I.bind(n,"click",function(){l.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),$r.show(),l.focus(),l.select()}),I.bind(i,"click",function(){t.save()}),I.bind(o,"click",function(){var x=prompt("Enter a new preset name.");x&&t.saveAs(x)}),I.bind(c,"click",function(){t.revert()})}(s),s.__rememberedObjects.indexOf(e)===-1&&s.__rememberedObjects.push(e)}),this.autoPlace&&Pn(this,this.width)},getRoot:function(){for(var s=this;s.parent;)s=s.parent;return s},getSaveObject:function(){var s=this.load;return s.closed=this.closed,this.__rememberedObjects.length>0&&(s.preset=this.preset,s.remembered||(s.remembered={}),s.remembered[this.preset]=Zr(this)),s.folders={},N.each(this.__folders,function(e,t){s.folders[t]=e.getSaveObject()}),s},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=Zr(this),En(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(s){this.load.remembered||(this.load.remembered={},this.load.remembered[Br]=Zr(this,!0)),this.load.remembered[s]=Zr(this),this.preset=s,Mn(this,s,!0),this.saveToLocalStorageIfPossible()},revert:function(s){N.each(this.__controllers,function(e){this.getRoot().load.remembered?Eo(s||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())},this),N.each(this.__folders,function(e){e.revert(e)}),s||En(this.getRoot(),!1)},listen:function(s){var e=this.__listening.length===0;this.__listening.push(s),e&&Po(this.__listening)},updateDisplay:function(){N.each(this.__controllers,function(s){s.updateDisplay()}),N.each(this.__folders,function(s){s.updateDisplay()})}});var fl=ce;const pl=(Go=Array,Ro=s=>s.fill(0),class extends Go{constructor(...s){super(...s),Ro(this)}});var Go,Ro;let ne=1e-6;const Lo=new Map;function Oo(s){let e=Lo.get(s);return e||(e=function(t){function r(a=0,u=0){const h=new t(2);return a!==void 0&&(h[0]=a,u!==void 0&&(h[1]=u)),h}function n(a,u,h){const y=h??new t(2);return y[0]=a[0]-u[0],y[1]=a[1]-u[1],y}function i(a,u,h,y){const B=y??new t(2);return B[0]=a[0]+h*(u[0]-a[0]),B[1]=a[1]+h*(u[1]-a[1]),B}function o(a,u,h){const y=h??new t(2);return y[0]=a[0]*u,y[1]=a[1]*u,y}function c(a,u){const h=u??new t(2);return h[0]=1/a[0],h[1]=1/a[1],h}function d(a,u){return a[0]*u[0]+a[1]*u[1]}function g(a){const u=a[0],h=a[1];return Math.sqrt(u*u+h*h)}function b(a){const u=a[0],h=a[1];return u*u+h*h}function l(a,u){const h=a[0]-u[0],y=a[1]-u[1];return Math.sqrt(h*h+y*y)}function x(a,u){const h=a[0]-u[0],y=a[1]-u[1];return h*h+y*y}function m(a,u){const h=u??new t(2),y=a[0],B=a[1],C=Math.sqrt(y*y+B*B);return C>1e-5?(h[0]=y/C,h[1]=B/C):(h[0]=0,h[1]=0),h}function _(a,u){const h=u??new t(2);return h[0]=a[0],h[1]=a[1],h}function w(a,u,h){const y=h??new t(2);return y[0]=a[0]*u[0],y[1]=a[1]*u[1],y}function f(a,u,h){const y=h??new t(2);return y[0]=a[0]/u[0],y[1]=a[1]/u[1],y}function p(a,u,h){const y=h??new t(2);return m(a,y),o(y,u,y)}return{create:r,fromValues:r,set:function(a,u,h){const y=h??new t(2);return y[0]=a,y[1]=u,y},ceil:function(a,u){const h=u??new t(2);return h[0]=Math.ceil(a[0]),h[1]=Math.ceil(a[1]),h},floor:function(a,u){const h=u??new t(2);return h[0]=Math.floor(a[0]),h[1]=Math.floor(a[1]),h},round:function(a,u){const h=u??new t(2);return h[0]=Math.round(a[0]),h[1]=Math.round(a[1]),h},clamp:function(a,u=0,h=1,y){const B=y??new t(2);return B[0]=Math.min(h,Math.max(u,a[0])),B[1]=Math.min(h,Math.max(u,a[1])),B},add:function(a,u,h){const y=h??new t(2);return y[0]=a[0]+u[0],y[1]=a[1]+u[1],y},addScaled:function(a,u,h,y){const B=y??new t(2);return B[0]=a[0]+u[0]*h,B[1]=a[1]+u[1]*h,B},angle:function(a,u){const h=a[0],y=a[1],B=u[0],C=u[1],G=Math.sqrt(h*h+y*y)*Math.sqrt(B*B+C*C),U=G&&d(a,u)/G;return Math.acos(U)},subtract:n,sub:n,equalsApproximately:function(a,u){return Math.abs(a[0]-u[0])<ne&&Math.abs(a[1]-u[1])<ne},equals:function(a,u){return a[0]===u[0]&&a[1]===u[1]},lerp:i,lerpV:function(a,u,h,y){const B=y??new t(2);return B[0]=a[0]+h[0]*(u[0]-a[0]),B[1]=a[1]+h[1]*(u[1]-a[1]),B},max:function(a,u,h){const y=h??new t(2);return y[0]=Math.max(a[0],u[0]),y[1]=Math.max(a[1],u[1]),y},min:function(a,u,h){const y=h??new t(2);return y[0]=Math.min(a[0],u[0]),y[1]=Math.min(a[1],u[1]),y},mulScalar:o,scale:o,divScalar:function(a,u,h){const y=h??new t(2);return y[0]=a[0]/u,y[1]=a[1]/u,y},inverse:c,invert:c,cross:function(a,u,h){const y=h??new t(3),B=a[0]*u[1]-a[1]*u[0];return y[0]=0,y[1]=0,y[2]=B,y},dot:d,length:g,len:g,lengthSq:b,lenSq:b,distance:l,dist:l,distanceSq:x,distSq:x,normalize:m,negate:function(a,u){const h=u??new t(2);return h[0]=-a[0],h[1]=-a[1],h},copy:_,clone:_,multiply:w,mul:w,divide:f,div:f,random:function(a=1,u){const h=u??new t(2),y=2*Math.random()*Math.PI;return h[0]=Math.cos(y)*a,h[1]=Math.sin(y)*a,h},zero:function(a){const u=a??new t(2);return u[0]=0,u[1]=0,u},transformMat4:function(a,u,h){const y=h??new t(2),B=a[0],C=a[1];return y[0]=B*u[0]+C*u[4]+u[12],y[1]=B*u[1]+C*u[5]+u[13],y},transformMat3:function(a,u,h){const y=h??new t(2),B=a[0],C=a[1];return y[0]=u[0]*B+u[4]*C+u[8],y[1]=u[1]*B+u[5]*C+u[9],y},rotate:function(a,u,h,y){const B=y??new t(2),C=a[0]-u[0],G=a[1]-u[1],U=Math.sin(h),k=Math.cos(h);return B[0]=C*k-G*U+u[0],B[1]=C*U+G*k+u[1],B},setLength:p,truncate:function(a,u,h){const y=h??new t(2);return g(a)>u?p(a,u,y):_(a,y)},midpoint:function(a,u,h){return i(a,u,.5,h??new t(2))}}}(s),Lo.set(s,e)),e}const Io=new Map;function es(s){let e=Io.get(s);return e||(e=function(t){function r(a,u,h){const y=new t(3);return a!==void 0&&(y[0]=a,u!==void 0&&(y[1]=u,h!==void 0&&(y[2]=h))),y}function n(a,u,h){const y=h??new t(3);return y[0]=a[0]-u[0],y[1]=a[1]-u[1],y[2]=a[2]-u[2],y}function i(a,u,h,y){const B=y??new t(3);return B[0]=a[0]+h*(u[0]-a[0]),B[1]=a[1]+h*(u[1]-a[1]),B[2]=a[2]+h*(u[2]-a[2]),B}function o(a,u,h){const y=h??new t(3);return y[0]=a[0]*u,y[1]=a[1]*u,y[2]=a[2]*u,y}function c(a,u){const h=u??new t(3);return h[0]=1/a[0],h[1]=1/a[1],h[2]=1/a[2],h}function d(a,u){return a[0]*u[0]+a[1]*u[1]+a[2]*u[2]}function g(a){const u=a[0],h=a[1],y=a[2];return Math.sqrt(u*u+h*h+y*y)}function b(a){const u=a[0],h=a[1],y=a[2];return u*u+h*h+y*y}function l(a,u){const h=a[0]-u[0],y=a[1]-u[1],B=a[2]-u[2];return Math.sqrt(h*h+y*y+B*B)}function x(a,u){const h=a[0]-u[0],y=a[1]-u[1],B=a[2]-u[2];return h*h+y*y+B*B}function m(a,u){const h=u??new t(3),y=a[0],B=a[1],C=a[2],G=Math.sqrt(y*y+B*B+C*C);return G>1e-5?(h[0]=y/G,h[1]=B/G,h[2]=C/G):(h[0]=0,h[1]=0,h[2]=0),h}function _(a,u){const h=u??new t(3);return h[0]=a[0],h[1]=a[1],h[2]=a[2],h}function w(a,u,h){const y=h??new t(3);return y[0]=a[0]*u[0],y[1]=a[1]*u[1],y[2]=a[2]*u[2],y}function f(a,u,h){const y=h??new t(3);return y[0]=a[0]/u[0],y[1]=a[1]/u[1],y[2]=a[2]/u[2],y}function p(a,u,h){const y=h??new t(3);return m(a,y),o(y,u,y)}return{create:r,fromValues:r,set:function(a,u,h,y){const B=y??new t(3);return B[0]=a,B[1]=u,B[2]=h,B},ceil:function(a,u){const h=u??new t(3);return h[0]=Math.ceil(a[0]),h[1]=Math.ceil(a[1]),h[2]=Math.ceil(a[2]),h},floor:function(a,u){const h=u??new t(3);return h[0]=Math.floor(a[0]),h[1]=Math.floor(a[1]),h[2]=Math.floor(a[2]),h},round:function(a,u){const h=u??new t(3);return h[0]=Math.round(a[0]),h[1]=Math.round(a[1]),h[2]=Math.round(a[2]),h},clamp:function(a,u=0,h=1,y){const B=y??new t(3);return B[0]=Math.min(h,Math.max(u,a[0])),B[1]=Math.min(h,Math.max(u,a[1])),B[2]=Math.min(h,Math.max(u,a[2])),B},add:function(a,u,h){const y=h??new t(3);return y[0]=a[0]+u[0],y[1]=a[1]+u[1],y[2]=a[2]+u[2],y},addScaled:function(a,u,h,y){const B=y??new t(3);return B[0]=a[0]+u[0]*h,B[1]=a[1]+u[1]*h,B[2]=a[2]+u[2]*h,B},angle:function(a,u){const h=a[0],y=a[1],B=a[2],C=u[0],G=u[1],U=u[2],k=Math.sqrt(h*h+y*y+B*B)*Math.sqrt(C*C+G*G+U*U),T=k&&d(a,u)/k;return Math.acos(T)},subtract:n,sub:n,equalsApproximately:function(a,u){return Math.abs(a[0]-u[0])<ne&&Math.abs(a[1]-u[1])<ne&&Math.abs(a[2]-u[2])<ne},equals:function(a,u){return a[0]===u[0]&&a[1]===u[1]&&a[2]===u[2]},lerp:i,lerpV:function(a,u,h,y){const B=y??new t(3);return B[0]=a[0]+h[0]*(u[0]-a[0]),B[1]=a[1]+h[1]*(u[1]-a[1]),B[2]=a[2]+h[2]*(u[2]-a[2]),B},max:function(a,u,h){const y=h??new t(3);return y[0]=Math.max(a[0],u[0]),y[1]=Math.max(a[1],u[1]),y[2]=Math.max(a[2],u[2]),y},min:function(a,u,h){const y=h??new t(3);return y[0]=Math.min(a[0],u[0]),y[1]=Math.min(a[1],u[1]),y[2]=Math.min(a[2],u[2]),y},mulScalar:o,scale:o,divScalar:function(a,u,h){const y=h??new t(3);return y[0]=a[0]/u,y[1]=a[1]/u,y[2]=a[2]/u,y},inverse:c,invert:c,cross:function(a,u,h){const y=h??new t(3),B=a[2]*u[0]-a[0]*u[2],C=a[0]*u[1]-a[1]*u[0];return y[0]=a[1]*u[2]-a[2]*u[1],y[1]=B,y[2]=C,y},dot:d,length:g,len:g,lengthSq:b,lenSq:b,distance:l,dist:l,distanceSq:x,distSq:x,normalize:m,negate:function(a,u){const h=u??new t(3);return h[0]=-a[0],h[1]=-a[1],h[2]=-a[2],h},copy:_,clone:_,multiply:w,mul:w,divide:f,div:f,random:function(a=1,u){const h=u??new t(3),y=2*Math.random()*Math.PI,B=2*Math.random()-1,C=Math.sqrt(1-B*B)*a;return h[0]=Math.cos(y)*C,h[1]=Math.sin(y)*C,h[2]=B*a,h},zero:function(a){const u=a??new t(3);return u[0]=0,u[1]=0,u[2]=0,u},transformMat4:function(a,u,h){const y=h??new t(3),B=a[0],C=a[1],G=a[2],U=u[3]*B+u[7]*C+u[11]*G+u[15]||1;return y[0]=(u[0]*B+u[4]*C+u[8]*G+u[12])/U,y[1]=(u[1]*B+u[5]*C+u[9]*G+u[13])/U,y[2]=(u[2]*B+u[6]*C+u[10]*G+u[14])/U,y},transformMat4Upper3x3:function(a,u,h){const y=h??new t(3),B=a[0],C=a[1],G=a[2];return y[0]=B*u[0]+C*u[4]+G*u[8],y[1]=B*u[1]+C*u[5]+G*u[9],y[2]=B*u[2]+C*u[6]+G*u[10],y},transformMat3:function(a,u,h){const y=h??new t(3),B=a[0],C=a[1],G=a[2];return y[0]=B*u[0]+C*u[4]+G*u[8],y[1]=B*u[1]+C*u[5]+G*u[9],y[2]=B*u[2]+C*u[6]+G*u[10],y},transformQuat:function(a,u,h){const y=h??new t(3),B=u[0],C=u[1],G=u[2],U=2*u[3],k=a[0],T=a[1],S=a[2],P=C*S-G*T,L=G*k-B*S,F=B*T-C*k;return y[0]=k+P*U+2*(C*F-G*L),y[1]=T+L*U+2*(G*P-B*F),y[2]=S+F*U+2*(B*L-C*P),y},getTranslation:function(a,u){const h=u??new t(3);return h[0]=a[12],h[1]=a[13],h[2]=a[14],h},getAxis:function(a,u,h){const y=h??new t(3),B=4*u;return y[0]=a[B+0],y[1]=a[B+1],y[2]=a[B+2],y},getScaling:function(a,u){const h=u??new t(3),y=a[0],B=a[1],C=a[2],G=a[4],U=a[5],k=a[6],T=a[8],S=a[9],P=a[10];return h[0]=Math.sqrt(y*y+B*B+C*C),h[1]=Math.sqrt(G*G+U*U+k*k),h[2]=Math.sqrt(T*T+S*S+P*P),h},rotateX:function(a,u,h,y){const B=y??new t(3),C=[],G=[];return C[0]=a[0]-u[0],C[1]=a[1]-u[1],C[2]=a[2]-u[2],G[0]=C[0],G[1]=C[1]*Math.cos(h)-C[2]*Math.sin(h),G[2]=C[1]*Math.sin(h)+C[2]*Math.cos(h),B[0]=G[0]+u[0],B[1]=G[1]+u[1],B[2]=G[2]+u[2],B},rotateY:function(a,u,h,y){const B=y??new t(3),C=[],G=[];return C[0]=a[0]-u[0],C[1]=a[1]-u[1],C[2]=a[2]-u[2],G[0]=C[2]*Math.sin(h)+C[0]*Math.cos(h),G[1]=C[1],G[2]=C[2]*Math.cos(h)-C[0]*Math.sin(h),B[0]=G[0]+u[0],B[1]=G[1]+u[1],B[2]=G[2]+u[2],B},rotateZ:function(a,u,h,y){const B=y??new t(3),C=[],G=[];return C[0]=a[0]-u[0],C[1]=a[1]-u[1],C[2]=a[2]-u[2],G[0]=C[0]*Math.cos(h)-C[1]*Math.sin(h),G[1]=C[0]*Math.sin(h)+C[1]*Math.cos(h),G[2]=C[2],B[0]=G[0]+u[0],B[1]=G[1]+u[1],B[2]=G[2]+u[2],B},setLength:p,truncate:function(a,u,h){const y=h??new t(3);return g(a)>u?p(a,u,y):_(a,y)},midpoint:function(a,u,h){return i(a,u,.5,h??new t(3))}}}(s),Io.set(s,e)),e}const Fo=new Map;function ml(s){let e=Fo.get(s);return e||(e=function(t){const r=Oo(t),n=es(t);function i(l,x){const m=x??new t(12);return m[0]=l[0],m[1]=l[1],m[2]=l[2],m[4]=l[4],m[5]=l[5],m[6]=l[6],m[8]=l[8],m[9]=l[9],m[10]=l[10],m}function o(l){const x=l??new t(12);return x[0]=1,x[1]=0,x[2]=0,x[4]=0,x[5]=1,x[6]=0,x[8]=0,x[9]=0,x[10]=1,x}function c(l,x){const m=x??new t(12),_=l[0],w=l[1],f=l[2],p=l[4],a=l[5],u=l[6],h=l[8],y=l[9],B=l[10],C=B*a-u*y,G=-B*p+u*h,U=y*p-a*h,k=1/(_*C+w*G+f*U);return m[0]=C*k,m[1]=(-B*w+f*y)*k,m[2]=(u*w-f*a)*k,m[4]=G*k,m[5]=(B*_-f*h)*k,m[6]=(-u*_+f*p)*k,m[8]=U*k,m[9]=(-y*_+w*h)*k,m[10]=(a*_-w*p)*k,m}function d(l,x,m){const _=m??new t(12),w=l[0],f=l[1],p=l[2],a=l[4],u=l[5],h=l[6],y=l[8],B=l[9],C=l[10],G=x[0],U=x[1],k=x[2],T=x[4],S=x[5],P=x[6],L=x[8],F=x[9],O=x[10];return _[0]=w*G+a*U+y*k,_[1]=f*G+u*U+B*k,_[2]=p*G+h*U+C*k,_[4]=w*T+a*S+y*P,_[5]=f*T+u*S+B*P,_[6]=p*T+h*S+C*P,_[8]=w*L+a*F+y*O,_[9]=f*L+u*F+B*O,_[10]=p*L+h*F+C*O,_}function g(l,x){const m=x??new t(12),_=Math.cos(l),w=Math.sin(l);return m[0]=_,m[1]=w,m[2]=0,m[4]=-w,m[5]=_,m[6]=0,m[8]=0,m[9]=0,m[10]=1,m}function b(l,x,m){const _=m??new t(12),w=l[0],f=l[1],p=l[2],a=l[4],u=l[5],h=l[6],y=Math.cos(x),B=Math.sin(x);return _[0]=y*w+B*a,_[1]=y*f+B*u,_[2]=y*p+B*h,_[4]=y*a-B*w,_[5]=y*u-B*f,_[6]=y*h-B*p,l!==_&&(_[8]=l[8],_[9]=l[9],_[10]=l[10]),_}return{clone:i,create:function(l,x,m,_,w,f,p,a,u){const h=new t(12);return h[3]=0,h[7]=0,h[11]=0,l!==void 0&&(h[0]=l,x!==void 0&&(h[1]=x,m!==void 0&&(h[2]=m,_!==void 0&&(h[4]=_,w!==void 0&&(h[5]=w,f!==void 0&&(h[6]=f,p!==void 0&&(h[8]=p,a!==void 0&&(h[9]=a,u!==void 0&&(h[10]=u))))))))),h},set:function(l,x,m,_,w,f,p,a,u,h){const y=h??new t(12);return y[0]=l,y[1]=x,y[2]=m,y[3]=0,y[4]=_,y[5]=w,y[6]=f,y[7]=0,y[8]=p,y[9]=a,y[10]=u,y[11]=0,y},fromMat4:function(l,x){const m=x??new t(12);return m[0]=l[0],m[1]=l[1],m[2]=l[2],m[3]=0,m[4]=l[4],m[5]=l[5],m[6]=l[6],m[7]=0,m[8]=l[8],m[9]=l[9],m[10]=l[10],m[11]=0,m},fromQuat:function(l,x){const m=x??new t(12),_=l[0],w=l[1],f=l[2],p=l[3],a=_+_,u=w+w,h=f+f,y=_*a,B=w*a,C=w*u,G=f*a,U=f*u,k=f*h,T=p*a,S=p*u,P=p*h;return m[0]=1-C-k,m[1]=B+P,m[2]=G-S,m[3]=0,m[4]=B-P,m[5]=1-y-k,m[6]=U+T,m[7]=0,m[8]=G+S,m[9]=U-T,m[10]=1-y-C,m[11]=0,m},negate:function(l,x){const m=x??new t(12);return m[0]=-l[0],m[1]=-l[1],m[2]=-l[2],m[4]=-l[4],m[5]=-l[5],m[6]=-l[6],m[8]=-l[8],m[9]=-l[9],m[10]=-l[10],m},copy:i,equalsApproximately:function(l,x){return Math.abs(l[0]-x[0])<ne&&Math.abs(l[1]-x[1])<ne&&Math.abs(l[2]-x[2])<ne&&Math.abs(l[4]-x[4])<ne&&Math.abs(l[5]-x[5])<ne&&Math.abs(l[6]-x[6])<ne&&Math.abs(l[8]-x[8])<ne&&Math.abs(l[9]-x[9])<ne&&Math.abs(l[10]-x[10])<ne},equals:function(l,x){return l[0]===x[0]&&l[1]===x[1]&&l[2]===x[2]&&l[4]===x[4]&&l[5]===x[5]&&l[6]===x[6]&&l[8]===x[8]&&l[9]===x[9]&&l[10]===x[10]},identity:o,transpose:function(l,x){const m=x??new t(12);if(m===l){let C;return C=l[1],l[1]=l[4],l[4]=C,C=l[2],l[2]=l[8],l[8]=C,C=l[6],l[6]=l[9],l[9]=C,m}const _=l[0],w=l[1],f=l[2],p=l[4],a=l[5],u=l[6],h=l[8],y=l[9],B=l[10];return m[0]=_,m[1]=p,m[2]=h,m[4]=w,m[5]=a,m[6]=y,m[8]=f,m[9]=u,m[10]=B,m},inverse:c,invert:c,determinant:function(l){const x=l[0],m=l[1],_=l[2],w=l[4],f=l[5],p=l[6],a=l[8],u=l[9],h=l[10];return x*(f*h-u*p)-w*(m*h-u*_)+a*(m*p-f*_)},mul:d,multiply:d,setTranslation:function(l,x,m){const _=m??o();return l!==_&&(_[0]=l[0],_[1]=l[1],_[2]=l[2],_[4]=l[4],_[5]=l[5],_[6]=l[6]),_[8]=x[0],_[9]=x[1],_[10]=1,_},getTranslation:function(l,x){const m=x??r.create();return m[0]=l[8],m[1]=l[9],m},getAxis:function(l,x,m){const _=m??r.create(),w=4*x;return _[0]=l[w+0],_[1]=l[w+1],_},setAxis:function(l,x,m,_){const w=_===l?l:i(l,_),f=4*m;return w[f+0]=x[0],w[f+1]=x[1],w},getScaling:function(l,x){const m=x??r.create(),_=l[0],w=l[1],f=l[4],p=l[5];return m[0]=Math.sqrt(_*_+w*w),m[1]=Math.sqrt(f*f+p*p),m},get3DScaling:function(l,x){const m=x??n.create(),_=l[0],w=l[1],f=l[2],p=l[4],a=l[5],u=l[6],h=l[8],y=l[9],B=l[10];return m[0]=Math.sqrt(_*_+w*w+f*f),m[1]=Math.sqrt(p*p+a*a+u*u),m[2]=Math.sqrt(h*h+y*y+B*B),m},translation:function(l,x){const m=x??new t(12);return m[0]=1,m[1]=0,m[2]=0,m[4]=0,m[5]=1,m[6]=0,m[8]=l[0],m[9]=l[1],m[10]=1,m},translate:function(l,x,m){const _=m??new t(12),w=x[0],f=x[1],p=l[0],a=l[1],u=l[2],h=l[4],y=l[5],B=l[6],C=l[8],G=l[9],U=l[10];return l!==_&&(_[0]=p,_[1]=a,_[2]=u,_[4]=h,_[5]=y,_[6]=B),_[8]=p*w+h*f+C,_[9]=a*w+y*f+G,_[10]=u*w+B*f+U,_},rotation:g,rotate:b,rotationX:function(l,x){const m=x??new t(12),_=Math.cos(l),w=Math.sin(l);return m[0]=1,m[1]=0,m[2]=0,m[4]=0,m[5]=_,m[6]=w,m[8]=0,m[9]=-w,m[10]=_,m},rotateX:function(l,x,m){const _=m??new t(12),w=l[4],f=l[5],p=l[6],a=l[8],u=l[9],h=l[10],y=Math.cos(x),B=Math.sin(x);return _[4]=y*w+B*a,_[5]=y*f+B*u,_[6]=y*p+B*h,_[8]=y*a-B*w,_[9]=y*u-B*f,_[10]=y*h-B*p,l!==_&&(_[0]=l[0],_[1]=l[1],_[2]=l[2]),_},rotationY:function(l,x){const m=x??new t(12),_=Math.cos(l),w=Math.sin(l);return m[0]=_,m[1]=0,m[2]=-w,m[4]=0,m[5]=1,m[6]=0,m[8]=w,m[9]=0,m[10]=_,m},rotateY:function(l,x,m){const _=m??new t(12),w=l[0],f=l[1],p=l[2],a=l[8],u=l[9],h=l[10],y=Math.cos(x),B=Math.sin(x);return _[0]=y*w-B*a,_[1]=y*f-B*u,_[2]=y*p-B*h,_[8]=y*a+B*w,_[9]=y*u+B*f,_[10]=y*h+B*p,l!==_&&(_[4]=l[4],_[5]=l[5],_[6]=l[6]),_},rotationZ:g,rotateZ:b,scaling:function(l,x){const m=x??new t(12);return m[0]=l[0],m[1]=0,m[2]=0,m[4]=0,m[5]=l[1],m[6]=0,m[8]=0,m[9]=0,m[10]=1,m},scale:function(l,x,m){const _=m??new t(12),w=x[0],f=x[1];return _[0]=w*l[0],_[1]=w*l[1],_[2]=w*l[2],_[4]=f*l[4],_[5]=f*l[5],_[6]=f*l[6],l!==_&&(_[8]=l[8],_[9]=l[9],_[10]=l[10]),_},uniformScaling:function(l,x){const m=x??new t(12);return m[0]=l,m[1]=0,m[2]=0,m[4]=0,m[5]=l,m[6]=0,m[8]=0,m[9]=0,m[10]=1,m},uniformScale:function(l,x,m){const _=m??new t(12);return _[0]=x*l[0],_[1]=x*l[1],_[2]=x*l[2],_[4]=x*l[4],_[5]=x*l[5],_[6]=x*l[6],l!==_&&(_[8]=l[8],_[9]=l[9],_[10]=l[10]),_},scaling3D:function(l,x){const m=x??new t(12);return m[0]=l[0],m[1]=0,m[2]=0,m[4]=0,m[5]=l[1],m[6]=0,m[8]=0,m[9]=0,m[10]=l[2],m},scale3D:function(l,x,m){const _=m??new t(12),w=x[0],f=x[1],p=x[2];return _[0]=w*l[0],_[1]=w*l[1],_[2]=w*l[2],_[4]=f*l[4],_[5]=f*l[5],_[6]=f*l[6],_[8]=p*l[8],_[9]=p*l[9],_[10]=p*l[10],_},uniformScaling3D:function(l,x){const m=x??new t(12);return m[0]=l,m[1]=0,m[2]=0,m[4]=0,m[5]=l,m[6]=0,m[8]=0,m[9]=0,m[10]=l,m},uniformScale3D:function(l,x,m){const _=m??new t(12);return _[0]=x*l[0],_[1]=x*l[1],_[2]=x*l[2],_[4]=x*l[4],_[5]=x*l[5],_[6]=x*l[6],_[8]=x*l[8],_[9]=x*l[9],_[10]=x*l[10],_}}}(s),Fo.set(s,e)),e}const Do=new Map;function gl(s){let e=Do.get(s);return e||(e=function(t){const r=es(t);function n(f,p){const a=p??new t(16);return a[0]=f[0],a[1]=f[1],a[2]=f[2],a[3]=f[3],a[4]=f[4],a[5]=f[5],a[6]=f[6],a[7]=f[7],a[8]=f[8],a[9]=f[9],a[10]=f[10],a[11]=f[11],a[12]=f[12],a[13]=f[13],a[14]=f[14],a[15]=f[15],a}const i=n;function o(f){const p=f??new t(16);return p[0]=1,p[1]=0,p[2]=0,p[3]=0,p[4]=0,p[5]=1,p[6]=0,p[7]=0,p[8]=0,p[9]=0,p[10]=1,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p}function c(f,p){const a=p??new t(16),u=f[0],h=f[1],y=f[2],B=f[3],C=f[4],G=f[5],U=f[6],k=f[7],T=f[8],S=f[9],P=f[10],L=f[11],F=f[12],O=f[13],H=f[14],K=f[15],X=P*K,z=H*L,J=U*K,Q=H*k,Z=U*L,te=P*k,re=y*K,he=H*B,fe=y*L,me=P*B,Ge=y*k,Re=U*B,Le=T*O,Oe=F*S,Ie=C*O,Fe=F*G,De=C*S,pn=T*G,mn=u*O,gn=F*h,yn=u*S,bn=T*h,xn=u*G,_n=C*h,Qc=X*G+Q*S+Z*O-(z*G+J*S+te*O),$c=z*h+re*S+me*O-(X*h+he*S+fe*O),Zc=J*h+he*G+Ge*O-(Q*h+re*G+Re*O),el=te*h+fe*G+Re*S-(Z*h+me*G+Ge*S),Ae=1/(u*Qc+C*$c+T*Zc+F*el);return a[0]=Ae*Qc,a[1]=Ae*$c,a[2]=Ae*Zc,a[3]=Ae*el,a[4]=Ae*(z*C+J*T+te*F-(X*C+Q*T+Z*F)),a[5]=Ae*(X*u+he*T+fe*F-(z*u+re*T+me*F)),a[6]=Ae*(Q*u+re*C+Re*F-(J*u+he*C+Ge*F)),a[7]=Ae*(Z*u+me*C+Ge*T-(te*u+fe*C+Re*T)),a[8]=Ae*(Le*k+Fe*L+De*K-(Oe*k+Ie*L+pn*K)),a[9]=Ae*(Oe*B+mn*L+bn*K-(Le*B+gn*L+yn*K)),a[10]=Ae*(Ie*B+gn*k+xn*K-(Fe*B+mn*k+_n*K)),a[11]=Ae*(pn*B+yn*k+_n*L-(De*B+bn*k+xn*L)),a[12]=Ae*(Ie*P+pn*H+Oe*U-(De*H+Le*U+Fe*P)),a[13]=Ae*(yn*H+Le*y+gn*P-(mn*P+bn*H+Oe*y)),a[14]=Ae*(mn*U+_n*H+Fe*y-(xn*H+Ie*y+gn*U)),a[15]=Ae*(xn*P+De*y+bn*U-(yn*U+_n*P+pn*y)),a}const d=c;function g(f,p,a){const u=a??new t(16),h=f[0],y=f[1],B=f[2],C=f[3],G=f[4],U=f[5],k=f[6],T=f[7],S=f[8],P=f[9],L=f[10],F=f[11],O=f[12],H=f[13],K=f[14],X=f[15],z=p[0],J=p[1],Q=p[2],Z=p[3],te=p[4],re=p[5],he=p[6],fe=p[7],me=p[8],Ge=p[9],Re=p[10],Le=p[11],Oe=p[12],Ie=p[13],Fe=p[14],De=p[15];return u[0]=h*z+G*J+S*Q+O*Z,u[1]=y*z+U*J+P*Q+H*Z,u[2]=B*z+k*J+L*Q+K*Z,u[3]=C*z+T*J+F*Q+X*Z,u[4]=h*te+G*re+S*he+O*fe,u[5]=y*te+U*re+P*he+H*fe,u[6]=B*te+k*re+L*he+K*fe,u[7]=C*te+T*re+F*he+X*fe,u[8]=h*me+G*Ge+S*Re+O*Le,u[9]=y*me+U*Ge+P*Re+H*Le,u[10]=B*me+k*Ge+L*Re+K*Le,u[11]=C*me+T*Ge+F*Re+X*Le,u[12]=h*Oe+G*Ie+S*Fe+O*De,u[13]=y*Oe+U*Ie+P*Fe+H*De,u[14]=B*Oe+k*Ie+L*Fe+K*De,u[15]=C*Oe+T*Ie+F*Fe+X*De,u}const b=g,l=r.create(),x=r.create(),m=r.create();function _(f,p,a){const u=a??new t(16);let h=f[0],y=f[1],B=f[2];const C=Math.sqrt(h*h+y*y+B*B);h/=C,y/=C,B/=C;const G=h*h,U=y*y,k=B*B,T=Math.cos(p),S=Math.sin(p),P=1-T;return u[0]=G+(1-G)*T,u[1]=h*y*P+B*S,u[2]=h*B*P-y*S,u[3]=0,u[4]=h*y*P-B*S,u[5]=U+(1-U)*T,u[6]=y*B*P+h*S,u[7]=0,u[8]=h*B*P+y*S,u[9]=y*B*P-h*S,u[10]=k+(1-k)*T,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u}function w(f,p,a,u){const h=u??new t(16);let y=p[0],B=p[1],C=p[2];const G=Math.sqrt(y*y+B*B+C*C);y/=G,B/=G,C/=G;const U=y*y,k=B*B,T=C*C,S=Math.cos(a),P=Math.sin(a),L=1-S,F=U+(1-U)*S,O=y*B*L+C*P,H=y*C*L-B*P,K=y*B*L-C*P,X=k+(1-k)*S,z=B*C*L+y*P,J=y*C*L+B*P,Q=B*C*L-y*P,Z=T+(1-T)*S,te=f[0],re=f[1],he=f[2],fe=f[3],me=f[4],Ge=f[5],Re=f[6],Le=f[7],Oe=f[8],Ie=f[9],Fe=f[10],De=f[11];return h[0]=F*te+O*me+H*Oe,h[1]=F*re+O*Ge+H*Ie,h[2]=F*he+O*Re+H*Fe,h[3]=F*fe+O*Le+H*De,h[4]=K*te+X*me+z*Oe,h[5]=K*re+X*Ge+z*Ie,h[6]=K*he+X*Re+z*Fe,h[7]=K*fe+X*Le+z*De,h[8]=J*te+Q*me+Z*Oe,h[9]=J*re+Q*Ge+Z*Ie,h[10]=J*he+Q*Re+Z*Fe,h[11]=J*fe+Q*Le+Z*De,f!==h&&(h[12]=f[12],h[13]=f[13],h[14]=f[14],h[15]=f[15]),h}return{create:function(f,p,a,u,h,y,B,C,G,U,k,T,S,P,L,F){const O=new t(16);return f!==void 0&&(O[0]=f,p!==void 0&&(O[1]=p,a!==void 0&&(O[2]=a,u!==void 0&&(O[3]=u,h!==void 0&&(O[4]=h,y!==void 0&&(O[5]=y,B!==void 0&&(O[6]=B,C!==void 0&&(O[7]=C,G!==void 0&&(O[8]=G,U!==void 0&&(O[9]=U,k!==void 0&&(O[10]=k,T!==void 0&&(O[11]=T,S!==void 0&&(O[12]=S,P!==void 0&&(O[13]=P,L!==void 0&&(O[14]=L,F!==void 0&&(O[15]=F)))))))))))))))),O},set:function(f,p,a,u,h,y,B,C,G,U,k,T,S,P,L,F,O){const H=O??new t(16);return H[0]=f,H[1]=p,H[2]=a,H[3]=u,H[4]=h,H[5]=y,H[6]=B,H[7]=C,H[8]=G,H[9]=U,H[10]=k,H[11]=T,H[12]=S,H[13]=P,H[14]=L,H[15]=F,H},fromMat3:function(f,p){const a=p??new t(16);return a[0]=f[0],a[1]=f[1],a[2]=f[2],a[3]=0,a[4]=f[4],a[5]=f[5],a[6]=f[6],a[7]=0,a[8]=f[8],a[9]=f[9],a[10]=f[10],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},fromQuat:function(f,p){const a=p??new t(16),u=f[0],h=f[1],y=f[2],B=f[3],C=u+u,G=h+h,U=y+y,k=u*C,T=h*C,S=h*G,P=y*C,L=y*G,F=y*U,O=B*C,H=B*G,K=B*U;return a[0]=1-S-F,a[1]=T+K,a[2]=P-H,a[3]=0,a[4]=T-K,a[5]=1-k-F,a[6]=L+O,a[7]=0,a[8]=P+H,a[9]=L-O,a[10]=1-k-S,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},negate:function(f,p){const a=p??new t(16);return a[0]=-f[0],a[1]=-f[1],a[2]=-f[2],a[3]=-f[3],a[4]=-f[4],a[5]=-f[5],a[6]=-f[6],a[7]=-f[7],a[8]=-f[8],a[9]=-f[9],a[10]=-f[10],a[11]=-f[11],a[12]=-f[12],a[13]=-f[13],a[14]=-f[14],a[15]=-f[15],a},copy:n,clone:i,equalsApproximately:function(f,p){return Math.abs(f[0]-p[0])<ne&&Math.abs(f[1]-p[1])<ne&&Math.abs(f[2]-p[2])<ne&&Math.abs(f[3]-p[3])<ne&&Math.abs(f[4]-p[4])<ne&&Math.abs(f[5]-p[5])<ne&&Math.abs(f[6]-p[6])<ne&&Math.abs(f[7]-p[7])<ne&&Math.abs(f[8]-p[8])<ne&&Math.abs(f[9]-p[9])<ne&&Math.abs(f[10]-p[10])<ne&&Math.abs(f[11]-p[11])<ne&&Math.abs(f[12]-p[12])<ne&&Math.abs(f[13]-p[13])<ne&&Math.abs(f[14]-p[14])<ne&&Math.abs(f[15]-p[15])<ne},equals:function(f,p){return f[0]===p[0]&&f[1]===p[1]&&f[2]===p[2]&&f[3]===p[3]&&f[4]===p[4]&&f[5]===p[5]&&f[6]===p[6]&&f[7]===p[7]&&f[8]===p[8]&&f[9]===p[9]&&f[10]===p[10]&&f[11]===p[11]&&f[12]===p[12]&&f[13]===p[13]&&f[14]===p[14]&&f[15]===p[15]},identity:o,transpose:function(f,p){const a=p??new t(16);if(a===f){let X;return X=f[1],f[1]=f[4],f[4]=X,X=f[2],f[2]=f[8],f[8]=X,X=f[3],f[3]=f[12],f[12]=X,X=f[6],f[6]=f[9],f[9]=X,X=f[7],f[7]=f[13],f[13]=X,X=f[11],f[11]=f[14],f[14]=X,a}const u=f[0],h=f[1],y=f[2],B=f[3],C=f[4],G=f[5],U=f[6],k=f[7],T=f[8],S=f[9],P=f[10],L=f[11],F=f[12],O=f[13],H=f[14],K=f[15];return a[0]=u,a[1]=C,a[2]=T,a[3]=F,a[4]=h,a[5]=G,a[6]=S,a[7]=O,a[8]=y,a[9]=U,a[10]=P,a[11]=H,a[12]=B,a[13]=k,a[14]=L,a[15]=K,a},inverse:c,determinant:function(f){const p=f[0],a=f[1],u=f[2],h=f[3],y=f[4],B=f[5],C=f[6],G=f[7],U=f[8],k=f[9],T=f[10],S=f[11],P=f[12],L=f[13],F=f[14],O=f[15],H=T*O,K=F*S,X=C*O,z=F*G,J=C*S,Q=T*G,Z=u*O,te=F*h,re=u*S,he=T*h,fe=u*G,me=C*h;return p*(H*B+z*k+J*L-(K*B+X*k+Q*L))+y*(K*a+Z*k+he*L-(H*a+te*k+re*L))+U*(X*a+te*B+fe*L-(z*a+Z*B+me*L))+P*(Q*a+re*B+me*k-(J*a+he*B+fe*k))},invert:d,multiply:g,mul:b,setTranslation:function(f,p,a){const u=a??o();return f!==u&&(u[0]=f[0],u[1]=f[1],u[2]=f[2],u[3]=f[3],u[4]=f[4],u[5]=f[5],u[6]=f[6],u[7]=f[7],u[8]=f[8],u[9]=f[9],u[10]=f[10],u[11]=f[11]),u[12]=p[0],u[13]=p[1],u[14]=p[2],u[15]=1,u},getTranslation:function(f,p){const a=p??r.create();return a[0]=f[12],a[1]=f[13],a[2]=f[14],a},getAxis:function(f,p,a){const u=a??r.create(),h=4*p;return u[0]=f[h+0],u[1]=f[h+1],u[2]=f[h+2],u},setAxis:function(f,p,a,u){const h=u===f?u:n(f,u),y=4*a;return h[y+0]=p[0],h[y+1]=p[1],h[y+2]=p[2],h},getScaling:function(f,p){const a=p??r.create(),u=f[0],h=f[1],y=f[2],B=f[4],C=f[5],G=f[6],U=f[8],k=f[9],T=f[10];return a[0]=Math.sqrt(u*u+h*h+y*y),a[1]=Math.sqrt(B*B+C*C+G*G),a[2]=Math.sqrt(U*U+k*k+T*T),a},perspective:function(f,p,a,u,h){const y=h??new t(16),B=Math.tan(.5*Math.PI-.5*f);if(y[0]=B/p,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=B,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,Number.isFinite(u)){const C=1/(a-u);y[10]=u*C,y[14]=u*a*C}else y[10]=-1,y[14]=-a;return y},perspectiveReverseZ:function(f,p,a,u=1/0,h){const y=h??new t(16),B=1/Math.tan(.5*f);if(y[0]=B/p,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=B,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[11]=-1,y[12]=0,y[13]=0,y[15]=0,u===1/0)y[10]=0,y[14]=a;else{const C=1/(u-a);y[10]=a*C,y[14]=u*a*C}return y},ortho:function(f,p,a,u,h,y,B){const C=B??new t(16);return C[0]=2/(p-f),C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2/(u-a),C[6]=0,C[7]=0,C[8]=0,C[9]=0,C[10]=1/(h-y),C[11]=0,C[12]=(p+f)/(f-p),C[13]=(u+a)/(a-u),C[14]=h/(h-y),C[15]=1,C},frustum:function(f,p,a,u,h,y,B){const C=B??new t(16),G=p-f,U=u-a,k=h-y;return C[0]=2*h/G,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2*h/U,C[6]=0,C[7]=0,C[8]=(f+p)/G,C[9]=(u+a)/U,C[10]=y/k,C[11]=-1,C[12]=0,C[13]=0,C[14]=h*y/k,C[15]=0,C},frustumReverseZ:function(f,p,a,u,h,y=1/0,B){const C=B??new t(16),G=p-f,U=u-a;if(C[0]=2*h/G,C[1]=0,C[2]=0,C[3]=0,C[4]=0,C[5]=2*h/U,C[6]=0,C[7]=0,C[8]=(f+p)/G,C[9]=(u+a)/U,C[11]=-1,C[12]=0,C[13]=0,C[15]=0,y===1/0)C[10]=0,C[14]=h;else{const k=1/(y-h);C[10]=h*k,C[14]=y*h*k}return C},aim:function(f,p,a,u){const h=u??new t(16);return r.normalize(r.subtract(p,f,m),m),r.normalize(r.cross(a,m,l),l),r.normalize(r.cross(m,l,x),x),h[0]=l[0],h[1]=l[1],h[2]=l[2],h[3]=0,h[4]=x[0],h[5]=x[1],h[6]=x[2],h[7]=0,h[8]=m[0],h[9]=m[1],h[10]=m[2],h[11]=0,h[12]=f[0],h[13]=f[1],h[14]=f[2],h[15]=1,h},cameraAim:function(f,p,a,u){const h=u??new t(16);return r.normalize(r.subtract(f,p,m),m),r.normalize(r.cross(a,m,l),l),r.normalize(r.cross(m,l,x),x),h[0]=l[0],h[1]=l[1],h[2]=l[2],h[3]=0,h[4]=x[0],h[5]=x[1],h[6]=x[2],h[7]=0,h[8]=m[0],h[9]=m[1],h[10]=m[2],h[11]=0,h[12]=f[0],h[13]=f[1],h[14]=f[2],h[15]=1,h},lookAt:function(f,p,a,u){const h=u??new t(16);return r.normalize(r.subtract(f,p,m),m),r.normalize(r.cross(a,m,l),l),r.normalize(r.cross(m,l,x),x),h[0]=l[0],h[1]=x[0],h[2]=m[0],h[3]=0,h[4]=l[1],h[5]=x[1],h[6]=m[1],h[7]=0,h[8]=l[2],h[9]=x[2],h[10]=m[2],h[11]=0,h[12]=-(l[0]*f[0]+l[1]*f[1]+l[2]*f[2]),h[13]=-(x[0]*f[0]+x[1]*f[1]+x[2]*f[2]),h[14]=-(m[0]*f[0]+m[1]*f[1]+m[2]*f[2]),h[15]=1,h},translation:function(f,p){const a=p??new t(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=f[0],a[13]=f[1],a[14]=f[2],a[15]=1,a},translate:function(f,p,a){const u=a??new t(16),h=p[0],y=p[1],B=p[2],C=f[0],G=f[1],U=f[2],k=f[3],T=f[4],S=f[5],P=f[6],L=f[7],F=f[8],O=f[9],H=f[10],K=f[11],X=f[12],z=f[13],J=f[14],Q=f[15];return f!==u&&(u[0]=C,u[1]=G,u[2]=U,u[3]=k,u[4]=T,u[5]=S,u[6]=P,u[7]=L,u[8]=F,u[9]=O,u[10]=H,u[11]=K),u[12]=C*h+T*y+F*B+X,u[13]=G*h+S*y+O*B+z,u[14]=U*h+P*y+H*B+J,u[15]=k*h+L*y+K*B+Q,u},rotationX:function(f,p){const a=p??new t(16),u=Math.cos(f),h=Math.sin(f);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=u,a[6]=h,a[7]=0,a[8]=0,a[9]=-h,a[10]=u,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},rotateX:function(f,p,a){const u=a??new t(16),h=f[4],y=f[5],B=f[6],C=f[7],G=f[8],U=f[9],k=f[10],T=f[11],S=Math.cos(p),P=Math.sin(p);return u[4]=S*h+P*G,u[5]=S*y+P*U,u[6]=S*B+P*k,u[7]=S*C+P*T,u[8]=S*G-P*h,u[9]=S*U-P*y,u[10]=S*k-P*B,u[11]=S*T-P*C,f!==u&&(u[0]=f[0],u[1]=f[1],u[2]=f[2],u[3]=f[3],u[12]=f[12],u[13]=f[13],u[14]=f[14],u[15]=f[15]),u},rotationY:function(f,p){const a=p??new t(16),u=Math.cos(f),h=Math.sin(f);return a[0]=u,a[1]=0,a[2]=-h,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=h,a[9]=0,a[10]=u,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},rotateY:function(f,p,a){const u=a??new t(16),h=f[0],y=f[1],B=f[2],C=f[3],G=f[8],U=f[9],k=f[10],T=f[11],S=Math.cos(p),P=Math.sin(p);return u[0]=S*h-P*G,u[1]=S*y-P*U,u[2]=S*B-P*k,u[3]=S*C-P*T,u[8]=S*G+P*h,u[9]=S*U+P*y,u[10]=S*k+P*B,u[11]=S*T+P*C,f!==u&&(u[4]=f[4],u[5]=f[5],u[6]=f[6],u[7]=f[7],u[12]=f[12],u[13]=f[13],u[14]=f[14],u[15]=f[15]),u},rotationZ:function(f,p){const a=p??new t(16),u=Math.cos(f),h=Math.sin(f);return a[0]=u,a[1]=h,a[2]=0,a[3]=0,a[4]=-h,a[5]=u,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},rotateZ:function(f,p,a){const u=a??new t(16),h=f[0],y=f[1],B=f[2],C=f[3],G=f[4],U=f[5],k=f[6],T=f[7],S=Math.cos(p),P=Math.sin(p);return u[0]=S*h+P*G,u[1]=S*y+P*U,u[2]=S*B+P*k,u[3]=S*C+P*T,u[4]=S*G-P*h,u[5]=S*U-P*y,u[6]=S*k-P*B,u[7]=S*T-P*C,f!==u&&(u[8]=f[8],u[9]=f[9],u[10]=f[10],u[11]=f[11],u[12]=f[12],u[13]=f[13],u[14]=f[14],u[15]=f[15]),u},axisRotation:_,rotation:_,axisRotate:w,rotate:w,scaling:function(f,p){const a=p??new t(16);return a[0]=f[0],a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f[1],a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=f[2],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},scale:function(f,p,a){const u=a??new t(16),h=p[0],y=p[1],B=p[2];return u[0]=h*f[0],u[1]=h*f[1],u[2]=h*f[2],u[3]=h*f[3],u[4]=y*f[4],u[5]=y*f[5],u[6]=y*f[6],u[7]=y*f[7],u[8]=B*f[8],u[9]=B*f[9],u[10]=B*f[10],u[11]=B*f[11],f!==u&&(u[12]=f[12],u[13]=f[13],u[14]=f[14],u[15]=f[15]),u},uniformScaling:function(f,p){const a=p??new t(16);return a[0]=f,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=f,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},uniformScale:function(f,p,a){const u=a??new t(16);return u[0]=p*f[0],u[1]=p*f[1],u[2]=p*f[2],u[3]=p*f[3],u[4]=p*f[4],u[5]=p*f[5],u[6]=p*f[6],u[7]=p*f[7],u[8]=p*f[8],u[9]=p*f[9],u[10]=p*f[10],u[11]=p*f[11],f!==u&&(u[12]=f[12],u[13]=f[13],u[14]=f[14],u[15]=f[15]),u}}}(s),Do.set(s,e)),e}const Uo=new Map;function yl(s){let e=Uo.get(s);return e||(e=function(t){const r=es(t);function n(T,S,P,L){const F=new t(4);return T!==void 0&&(F[0]=T,S!==void 0&&(F[1]=S,P!==void 0&&(F[2]=P,L!==void 0&&(F[3]=L)))),F}const i=n;function o(T,S,P){const L=P??new t(4),F=.5*S,O=Math.sin(F);return L[0]=O*T[0],L[1]=O*T[1],L[2]=O*T[2],L[3]=Math.cos(F),L}function c(T,S,P){const L=P??new t(4),F=T[0],O=T[1],H=T[2],K=T[3],X=S[0],z=S[1],J=S[2],Q=S[3];return L[0]=F*Q+K*X+O*J-H*z,L[1]=O*Q+K*z+H*X-F*J,L[2]=H*Q+K*J+F*z-O*X,L[3]=K*Q-F*X-O*z-H*J,L}const d=c;function g(T,S,P,L){const F=L??new t(4),O=T[0],H=T[1],K=T[2],X=T[3];let z,J,Q=S[0],Z=S[1],te=S[2],re=S[3],he=O*Q+H*Z+K*te+X*re;if(he<0&&(he=-he,Q=-Q,Z=-Z,te=-te,re=-re),1-he>ne){const fe=Math.acos(he),me=Math.sin(fe);z=Math.sin((1-P)*fe)/me,J=Math.sin(P*fe)/me}else z=1-P,J=P;return F[0]=z*O+J*Q,F[1]=z*H+J*Z,F[2]=z*K+J*te,F[3]=z*X+J*re,F}function b(T,S){const P=S??new t(4);return P[0]=T[0],P[1]=T[1],P[2]=T[2],P[3]=T[3],P}const l=b;function x(T,S,P){const L=P??new t(4);return L[0]=T[0]-S[0],L[1]=T[1]-S[1],L[2]=T[2]-S[2],L[3]=T[3]-S[3],L}const m=x;function _(T,S,P){const L=P??new t(4);return L[0]=T[0]*S,L[1]=T[1]*S,L[2]=T[2]*S,L[3]=T[3]*S,L}const w=_;function f(T,S){return T[0]*S[0]+T[1]*S[1]+T[2]*S[2]+T[3]*S[3]}function p(T){const S=T[0],P=T[1],L=T[2],F=T[3];return Math.sqrt(S*S+P*P+L*L+F*F)}const a=p;function u(T){const S=T[0],P=T[1],L=T[2],F=T[3];return S*S+P*P+L*L+F*F}const h=u;function y(T,S){const P=S??new t(4),L=T[0],F=T[1],O=T[2],H=T[3],K=Math.sqrt(L*L+F*F+O*O+H*H);return K>1e-5?(P[0]=L/K,P[1]=F/K,P[2]=O/K,P[3]=H/K):(P[0]=0,P[1]=0,P[2]=0,P[3]=1),P}const B=r.create(),C=r.create(),G=r.create(),U=new t(4),k=new t(4);return{create:n,fromValues:i,set:function(T,S,P,L,F){const O=F??new t(4);return O[0]=T,O[1]=S,O[2]=P,O[3]=L,O},fromAxisAngle:o,toAxisAngle:function(T,S){const P=S??r.create(3),L=2*Math.acos(T[3]),F=Math.sin(.5*L);return F>ne?(P[0]=T[0]/F,P[1]=T[1]/F,P[2]=T[2]/F):(P[0]=1,P[1]=0,P[2]=0),{angle:L,axis:P}},angle:function(T,S){const P=f(T,S);return Math.acos(2*P*P-1)},multiply:c,mul:d,rotateX:function(T,S,P){const L=P??new t(4),F=.5*S,O=T[0],H=T[1],K=T[2],X=T[3],z=Math.sin(F),J=Math.cos(F);return L[0]=O*J+X*z,L[1]=H*J+K*z,L[2]=K*J-H*z,L[3]=X*J-O*z,L},rotateY:function(T,S,P){const L=P??new t(4),F=.5*S,O=T[0],H=T[1],K=T[2],X=T[3],z=Math.sin(F),J=Math.cos(F);return L[0]=O*J-K*z,L[1]=H*J+X*z,L[2]=K*J+O*z,L[3]=X*J-H*z,L},rotateZ:function(T,S,P){const L=P??new t(4),F=.5*S,O=T[0],H=T[1],K=T[2],X=T[3],z=Math.sin(F),J=Math.cos(F);return L[0]=O*J+H*z,L[1]=H*J-O*z,L[2]=K*J+X*z,L[3]=X*J-K*z,L},slerp:g,inverse:function(T,S){const P=S??new t(4),L=T[0],F=T[1],O=T[2],H=T[3],K=L*L+F*F+O*O+H*H,X=K?1/K:0;return P[0]=-L*X,P[1]=-F*X,P[2]=-O*X,P[3]=H*X,P},conjugate:function(T,S){const P=S??new t(4);return P[0]=-T[0],P[1]=-T[1],P[2]=-T[2],P[3]=T[3],P},fromMat:function(T,S){const P=S??new t(4),L=T[0]+T[5]+T[10];if(L>0){const F=Math.sqrt(L+1);P[3]=.5*F;const O=.5/F;P[0]=(T[6]-T[9])*O,P[1]=(T[8]-T[2])*O,P[2]=(T[1]-T[4])*O}else{let F=0;T[5]>T[0]&&(F=1),T[10]>T[4*F+F]&&(F=2);const O=(F+1)%3,H=(F+2)%3,K=Math.sqrt(T[4*F+F]-T[4*O+O]-T[4*H+H]+1);P[F]=.5*K;const X=.5/K;P[3]=(T[4*O+H]-T[4*H+O])*X,P[O]=(T[4*O+F]+T[4*F+O])*X,P[H]=(T[4*H+F]+T[4*F+H])*X}return P},fromEuler:function(T,S,P,L,F){const O=F??new t(4),H=.5*T,K=.5*S,X=.5*P,z=Math.sin(H),J=Math.cos(H),Q=Math.sin(K),Z=Math.cos(K),te=Math.sin(X),re=Math.cos(X);switch(L){case"xyz":O[0]=z*Z*re+J*Q*te,O[1]=J*Q*re-z*Z*te,O[2]=J*Z*te+z*Q*re,O[3]=J*Z*re-z*Q*te;break;case"xzy":O[0]=z*Z*re-J*Q*te,O[1]=J*Q*re-z*Z*te,O[2]=J*Z*te+z*Q*re,O[3]=J*Z*re+z*Q*te;break;case"yxz":O[0]=z*Z*re+J*Q*te,O[1]=J*Q*re-z*Z*te,O[2]=J*Z*te-z*Q*re,O[3]=J*Z*re+z*Q*te;break;case"yzx":O[0]=z*Z*re+J*Q*te,O[1]=J*Q*re+z*Z*te,O[2]=J*Z*te-z*Q*re,O[3]=J*Z*re-z*Q*te;break;case"zxy":O[0]=z*Z*re-J*Q*te,O[1]=J*Q*re+z*Z*te,O[2]=J*Z*te+z*Q*re,O[3]=J*Z*re-z*Q*te;break;case"zyx":O[0]=z*Z*re-J*Q*te,O[1]=J*Q*re+z*Z*te,O[2]=J*Z*te-z*Q*re,O[3]=J*Z*re+z*Q*te;break;default:throw new Error(`Unknown rotation order: ${L}`)}return O},copy:b,clone:l,add:function(T,S,P){const L=P??new t(4);return L[0]=T[0]+S[0],L[1]=T[1]+S[1],L[2]=T[2]+S[2],L[3]=T[3]+S[3],L},subtract:x,sub:m,mulScalar:_,scale:w,divScalar:function(T,S,P){const L=P??new t(4);return L[0]=T[0]/S,L[1]=T[1]/S,L[2]=T[2]/S,L[3]=T[3]/S,L},dot:f,lerp:function(T,S,P,L){const F=L??new t(4);return F[0]=T[0]+P*(S[0]-T[0]),F[1]=T[1]+P*(S[1]-T[1]),F[2]=T[2]+P*(S[2]-T[2]),F[3]=T[3]+P*(S[3]-T[3]),F},length:p,len:a,lengthSq:u,lenSq:h,normalize:y,equalsApproximately:function(T,S){return Math.abs(T[0]-S[0])<ne&&Math.abs(T[1]-S[1])<ne&&Math.abs(T[2]-S[2])<ne&&Math.abs(T[3]-S[3])<ne},equals:function(T,S){return T[0]===S[0]&&T[1]===S[1]&&T[2]===S[2]&&T[3]===S[3]},identity:function(T){const S=T??new t(4);return S[0]=0,S[1]=0,S[2]=0,S[3]=1,S},rotationTo:function(T,S,P){const L=P??new t(4),F=r.dot(T,S);return F<-.999999?(r.cross(C,T,B),r.len(B)<1e-6&&r.cross(G,T,B),r.normalize(B,B),o(B,Math.PI,L),L):F>.999999?(L[0]=0,L[1]=0,L[2]=0,L[3]=1,L):(r.cross(T,S,B),L[0]=B[0],L[1]=B[1],L[2]=B[2],L[3]=1+F,y(L,L))},sqlerp:function(T,S,P,L,F,O){const H=O??new t(4);return g(T,L,F,U),g(S,P,F,k),g(U,k,2*F*(1-F),H),H}}}(s),Uo.set(s,e)),e}const ko=new Map;function bl(s){let e=ko.get(s);return e||(e=function(t){function r(p,a,u,h){const y=new t(4);return p!==void 0&&(y[0]=p,a!==void 0&&(y[1]=a,u!==void 0&&(y[2]=u,h!==void 0&&(y[3]=h)))),y}function n(p,a,u){const h=u??new t(4);return h[0]=p[0]-a[0],h[1]=p[1]-a[1],h[2]=p[2]-a[2],h[3]=p[3]-a[3],h}function i(p,a,u,h){const y=h??new t(4);return y[0]=p[0]+u*(a[0]-p[0]),y[1]=p[1]+u*(a[1]-p[1]),y[2]=p[2]+u*(a[2]-p[2]),y[3]=p[3]+u*(a[3]-p[3]),y}function o(p,a,u){const h=u??new t(4);return h[0]=p[0]*a,h[1]=p[1]*a,h[2]=p[2]*a,h[3]=p[3]*a,h}function c(p,a){const u=a??new t(4);return u[0]=1/p[0],u[1]=1/p[1],u[2]=1/p[2],u[3]=1/p[3],u}function d(p){const a=p[0],u=p[1],h=p[2],y=p[3];return Math.sqrt(a*a+u*u+h*h+y*y)}function g(p){const a=p[0],u=p[1],h=p[2],y=p[3];return a*a+u*u+h*h+y*y}function b(p,a){const u=p[0]-a[0],h=p[1]-a[1],y=p[2]-a[2],B=p[3]-a[3];return Math.sqrt(u*u+h*h+y*y+B*B)}function l(p,a){const u=p[0]-a[0],h=p[1]-a[1],y=p[2]-a[2],B=p[3]-a[3];return u*u+h*h+y*y+B*B}function x(p,a){const u=a??new t(4),h=p[0],y=p[1],B=p[2],C=p[3],G=Math.sqrt(h*h+y*y+B*B+C*C);return G>1e-5?(u[0]=h/G,u[1]=y/G,u[2]=B/G,u[3]=C/G):(u[0]=0,u[1]=0,u[2]=0,u[3]=0),u}function m(p,a){const u=a??new t(4);return u[0]=p[0],u[1]=p[1],u[2]=p[2],u[3]=p[3],u}function _(p,a,u){const h=u??new t(4);return h[0]=p[0]*a[0],h[1]=p[1]*a[1],h[2]=p[2]*a[2],h[3]=p[3]*a[3],h}function w(p,a,u){const h=u??new t(4);return h[0]=p[0]/a[0],h[1]=p[1]/a[1],h[2]=p[2]/a[2],h[3]=p[3]/a[3],h}function f(p,a,u){const h=u??new t(4);return x(p,h),o(h,a,h)}return{create:r,fromValues:r,set:function(p,a,u,h,y){const B=y??new t(4);return B[0]=p,B[1]=a,B[2]=u,B[3]=h,B},ceil:function(p,a){const u=a??new t(4);return u[0]=Math.ceil(p[0]),u[1]=Math.ceil(p[1]),u[2]=Math.ceil(p[2]),u[3]=Math.ceil(p[3]),u},floor:function(p,a){const u=a??new t(4);return u[0]=Math.floor(p[0]),u[1]=Math.floor(p[1]),u[2]=Math.floor(p[2]),u[3]=Math.floor(p[3]),u},round:function(p,a){const u=a??new t(4);return u[0]=Math.round(p[0]),u[1]=Math.round(p[1]),u[2]=Math.round(p[2]),u[3]=Math.round(p[3]),u},clamp:function(p,a=0,u=1,h){const y=h??new t(4);return y[0]=Math.min(u,Math.max(a,p[0])),y[1]=Math.min(u,Math.max(a,p[1])),y[2]=Math.min(u,Math.max(a,p[2])),y[3]=Math.min(u,Math.max(a,p[3])),y},add:function(p,a,u){const h=u??new t(4);return h[0]=p[0]+a[0],h[1]=p[1]+a[1],h[2]=p[2]+a[2],h[3]=p[3]+a[3],h},addScaled:function(p,a,u,h){const y=h??new t(4);return y[0]=p[0]+a[0]*u,y[1]=p[1]+a[1]*u,y[2]=p[2]+a[2]*u,y[3]=p[3]+a[3]*u,y},subtract:n,sub:n,equalsApproximately:function(p,a){return Math.abs(p[0]-a[0])<ne&&Math.abs(p[1]-a[1])<ne&&Math.abs(p[2]-a[2])<ne&&Math.abs(p[3]-a[3])<ne},equals:function(p,a){return p[0]===a[0]&&p[1]===a[1]&&p[2]===a[2]&&p[3]===a[3]},lerp:i,lerpV:function(p,a,u,h){const y=h??new t(4);return y[0]=p[0]+u[0]*(a[0]-p[0]),y[1]=p[1]+u[1]*(a[1]-p[1]),y[2]=p[2]+u[2]*(a[2]-p[2]),y[3]=p[3]+u[3]*(a[3]-p[3]),y},max:function(p,a,u){const h=u??new t(4);return h[0]=Math.max(p[0],a[0]),h[1]=Math.max(p[1],a[1]),h[2]=Math.max(p[2],a[2]),h[3]=Math.max(p[3],a[3]),h},min:function(p,a,u){const h=u??new t(4);return h[0]=Math.min(p[0],a[0]),h[1]=Math.min(p[1],a[1]),h[2]=Math.min(p[2],a[2]),h[3]=Math.min(p[3],a[3]),h},mulScalar:o,scale:o,divScalar:function(p,a,u){const h=u??new t(4);return h[0]=p[0]/a,h[1]=p[1]/a,h[2]=p[2]/a,h[3]=p[3]/a,h},inverse:c,invert:c,dot:function(p,a){return p[0]*a[0]+p[1]*a[1]+p[2]*a[2]+p[3]*a[3]},length:d,len:d,lengthSq:g,lenSq:g,distance:b,dist:b,distanceSq:l,distSq:l,normalize:x,negate:function(p,a){const u=a??new t(4);return u[0]=-p[0],u[1]=-p[1],u[2]=-p[2],u[3]=-p[3],u},copy:m,clone:m,multiply:_,mul:_,divide:w,div:w,zero:function(p){const a=p??new t(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},transformMat4:function(p,a,u){const h=u??new t(4),y=p[0],B=p[1],C=p[2],G=p[3];return h[0]=a[0]*y+a[4]*B+a[8]*C+a[12]*G,h[1]=a[1]*y+a[5]*B+a[9]*C+a[13]*G,h[2]=a[2]*y+a[6]*B+a[10]*C+a[14]*G,h[3]=a[3]*y+a[7]*B+a[11]*C+a[15]*G,h},setLength:f,truncate:function(p,a,u){const h=u??new t(4);return d(p)>a?f(p,a,h):m(p,h)},midpoint:function(p,a,u){return i(p,a,.5,u??new t(4))}}}(s),ko.set(s,e)),e}function Gn(s,e,t,r,n,i){return{mat3:ml(s),mat4:gl(e),quat:yl(t),vec2:Oo(r),vec3:es(n),vec4:bl(i)}}const{mat3:ts,mat4:$,quat:rs,vec2:Ce,vec3:D,vec4:wr}=Gn(Float32Array,Float32Array,Float32Array,Float32Array,Float32Array,Float32Array);Gn(Float64Array,Float64Array,Float64Array,Float64Array,Float64Array,Float64Array),Gn(pl,Array,Array,Array,Array,Array);const xl=""+new URL("Sponza-Eg7MFCLQ.gltf",import.meta.url).href;class $e{constructor(){throw new Error(`${this.constructor.name} is non-instantiable`)}}class $t extends $e{static linear(e){return e}static quad_In(e){return e*e}static quad_Out(e){return e*(2-e)}static quad_InOut(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}static cubic_In(e){return e*e*e}static cubic_Out(e){return--e*e*e+1}static cubic_InOut(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}static quart_In(e){return e*e*e*e}static quart_Out(e){return 1- --e*e*e*e}static quart_InOut(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}static quint_In(e){return e*e*e*e*e}static quint_Out(e){return--e*e*e*e*e+1}static quint_InOut(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}static sine_In(e){return 1-Math.cos(e*Math.PI/2)}static sine_Out(e){return Math.sin(e*Math.PI/2)}static sine_InOut(e){return .5*(1-Math.cos(Math.PI*e))}static exp_In(e){return e===0?0:Math.pow(1024,e-1)}static exp_Out(e){return e===1?1:1-Math.pow(2,-10*e)}static exp_InOut(e){return e===0||e===1?e:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}static circ_In(e){return 1-Math.sqrt(1-e*e)}static circ_Out(e){return Math.sqrt(1- --e*e)}static circ_InOut(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}static elastic_In(e){return e===0||e===1?e:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)}static elastic_Out(e){return e===0||e===1?e:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1}static elastic_InOut(e){return e===0||e===1?e:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}static back_In(e){return e*e*(2.70158*e-1.70158)}static back_Out(e){return--e*e*(2.70158*e+1.70158)+1}static back_InOut(e){const t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}static bounce_In(e){return 1-$t.bounce_Out(1-e)}static bounce_Out(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}static bounce_InOut(e){return e<.5?.5*$t.bounce_In(2*e):.5*$t.bounce_Out(2*e-1)+.5}}class ss{constructor({durationMS:e,delayMS:t=0,easeName:r="linear",onUpdate:n,onComplete:i=()=>{}}){this.startMS=0,this.update=()=>{this.rafID=window.requestAnimationFrame(this.update);let o=(performance.now()-this.startMS)/this.durationMS;o<0?o=0:o>1&&(o=1);const c=this.easeFunc(o);this.onUpdate(c,o),o>=1&&(this.onComplete(),this.stop())},this.durationMS=e,this.delayMS=t,this.easeFunc=$t[r],this.onUpdate=n,this.onComplete=i}start(){const e=()=>{this.startMS=performance.now(),this.rafID=window.requestAnimationFrame(this.update),clearTimeout(this.delayID)};return this.delayMS?this.delayID=window.setTimeout(e,this.delayMS):e(),this}stop(){return window.clearTimeout(this.delayID),window.cancelAnimationFrame(this.rafID),this.rafID=-1,this}setEase(e){return this.easeFunc=$t[e],this}}const Te=D.create(),_l=87,Bl=83,Al=65,vl=68,wl=69,Cl=81;class Tl{constructor(e,t=document.body,r=t){this.camera=e,this.keyboardDomElement=t,this.mouseDomElement=r,this.angles=Ce.create(0,.5*-Math.PI),this.viewMat=$.create(),this.rotMat=$.identity(),this.lastX=0,this.lastY=0,this.presedKeys=new Array(128),this.rafId=-1,this.speed=20,this.update=n=>{const i=.001*this.speed;D.set(0,0,0,Te),(this.presedKeys[_l]||this.presedKeys[38])&&(Te[2]-=i),(this.presedKeys[Bl]||this.presedKeys[40])&&(Te[2]+=i),(this.presedKeys[Al]||this.presedKeys[37])&&(Te[0]-=i),(this.presedKeys[vl]||this.presedKeys[39])&&(Te[0]+=i),this.presedKeys[wl]&&(Te[1]+=i),this.presedKeys[Cl]&&(Te[1]-=i),Te[0]===0&&Te[1]===0&&Te[2]===0||(D.transformMat4(Te,this.rotMat,Te),D.add(this.position,Te,this.position));const o=this.viewMat;$.identity(o),$.rotateX(o,this.angles[0],o),$.rotateY(o,this.angles[1],o),$.translate(o,D.negate(this.position),o),this.camera.setPosition(this.position[0],this.position[1],this.position[2]),this.camera.updateViewMatrixWithMat(o),this.rafId=requestAnimationFrame(this.update)},this.onMouseDown=n=>{this.lastX=n.pageX,this.lastY=n.pageY,this.mouseDomElement.addEventListener("mousemove",this.onMouseMove)},this.onMouseUp=()=>{this.mouseDomElement.removeEventListener("mousemove",this.onMouseMove)},this.onMouseMove=n=>{const i=n.pageX-this.lastX,o=n.pageY-this.lastY;this.lastX=n.pageX,this.lastY=n.pageY,this.rotateView(.0075*i,.005*o)},this.onKeyDown=n=>{this.presedKeys[n.keyCode]=!0},this.onKeyUp=n=>{this.presedKeys[n.keyCode]=!1},this.position=e.position,t.addEventListener("keydown",this.onKeyDown),t.addEventListener("keyup",this.onKeyUp),r.addEventListener("mousedown",this.onMouseDown),r.addEventListener("mouseup",this.onMouseUp),this.rotateView(.0075,.005)}startTick(){this.rafId=requestAnimationFrame(this.update)}endTick(){cancelAnimationFrame(this.rafId)}rotateView(e,t){if(e||t){for(this.angles[1]+=e;this.angles[1]<0;)this.angles[1]+=2*Math.PI;for(;this.angles[1]>=2*Math.PI;)this.angles[1]-=2*Math.PI;this.angles[0]+=t,this.angles[0]<.5*-Math.PI&&(this.angles[0]=.5*-Math.PI),this.angles[0]>.5*Math.PI&&(this.angles[0]=.5*Math.PI),$.identity(this.rotMat),$.rotateY(this.rotMat,-this.angles[1],this.rotMat),$.rotateX(this.rotMat,-this.angles[0],this.rotMat)}}}const No=(s,e,t)=>s+t*(e-s),Pt=(s,e)=>{const t=Math.max(s,e);return 1+Math.log2(t)|0},Sl=$.identity(),El=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],Ml=[[0,1,0],[0,1,0],[0,0,-1],[0,0,1],[0,1,0],[0,1,0]],Vo=new Float32Array(1),Pl=new Int32Array(Vo.buffer),ns=s=>{Vo[0]=s;const e=Pl[0];let t=e>>16&32768,r=e>>12&2047;const n=e>>23&255;return n<103?t:n>142?(t|=31744,t|=(n==255?0:1)&&8388607&e,t):n<113?(r|=2048,t|=(r>>114-n)+(r>>113-n&1),t):(t|=n-112<<10|r>>1,t+=1&r,t)},Rn=(s,e)=>((s+e-1)/e|0)*e,Ho=s=>s&&typeof s.length=="number"&&s.buffer instanceof ArrayBuffer&&typeof s.byteLength=="number",ie={i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array},bool:{numElements:0,align:1,size:0,type:"bool",View:Uint32Array}},Zt={...ie,"atomic<i32>":ie.i32,"atomic<u32>":ie.u32,"vec2<i32>":ie.vec2i,"vec2<u32>":ie.vec2u,"vec2<f32>":ie.vec2f,"vec2<f16>":ie.vec2h,"vec3<i32>":ie.vec3i,"vec3<u32>":ie.vec3u,"vec3<f32>":ie.vec3f,"vec3<f16>":ie.vec3h,"vec4<i32>":ie.vec4i,"vec4<u32>":ie.vec4u,"vec4<f32>":ie.vec4f,"vec4<f16>":ie.vec4h,"mat2x2<f32>":ie.mat2x2f,"mat2x2<f16>":ie.mat2x2h,"mat3x2<f32>":ie.mat3x2f,"mat3x2<f16>":ie.mat3x2h,"mat4x2<f32>":ie.mat4x2f,"mat4x2<f16>":ie.mat4x2h,"mat2x3<f32>":ie.mat2x3f,"mat2x3<f16>":ie.mat2x3h,"mat3x3<f32>":ie.mat3x3f,"mat3x3<f16>":ie.mat3x3h,"mat4x3<f32>":ie.mat4x3f,"mat4x3<f16>":ie.mat4x3h,"mat2x4<f32>":ie.mat2x4f,"mat2x4<f16>":ie.mat2x4h,"mat3x4<f32>":ie.mat3x4f,"mat3x4<f16>":ie.mat3x4h,"mat4x4<f32>":ie.mat4x4f,"mat4x4<f16>":ie.mat4x4h},Gl=(jo=Zt,Object.keys(jo));var jo;function Jo(s,e,t,r){const{size:n,type:i}=s;try{const{View:o,align:c}=Zt[i],d=r!==void 0,g=d?Rn(n,c):n,b=g/o.BYTES_PER_ELEMENT;return new o(e,t,b*(d?r===0?(e.byteLength-t)/g:r:1))}catch{throw new Error(`unknown type: ${i}`)}}function Rl(s,e,t){const r=t||0,n=new ArrayBuffer(function(o){const c=o;if(c.elementType)return c.size;{const d=o,g=c.numElements||1;if(d.fields)return o.size*g;{const b=o,{align:l}=Zt[b.type];return g>1?Rn(o.size,l)*g:o.size}}}(s)),i=(o,c)=>{const d=o,g=d.elementType;if(g){if(function(l){return!l.fields&&!l.elementType}(g)&&Zt[g.type].flatten)return Jo(g,n,c,d.numElements);{const{size:l}=zo(o),x=d.numElements===0?(n.byteLength-c)/l:d.numElements;return b=m=>i(g,c+l*m),new Array(x).fill(0).map((m,_)=>b(_))}}if(typeof o=="string")throw Error("unreachable");{const l=o.fields;if(l){const x={};for(const[m,{type:_,offset:w}]of Object.entries(l))x[m]=i(_,c+w);return x}return Jo(o,n,c)}var b};return{views:i(s,r),arrayBuffer:n}}function Ln(s,e){if(s!==void 0)if(Ho(e)){const t=e;if(t.length===1&&typeof s=="number")t[0]=s;else if(Array.isArray(s[0])||Ho(s[0])){const r=s[0].length,n=r===3?4:r;for(let i=0;i<s.length;++i){const o=i*n;t.set(s[i],o)}}else t.set(s)}else if(Array.isArray(e)){const t=e;s.forEach((r,n)=>{Ln(r,t[n])})}else{const t=e;for(const[r,n]of Object.entries(s)){const i=t[r];i&&Ln(n,i)}}}function yt(s,e,t=0){const r=s,n=Rl(r.group===void 0?s:r.typeDefinition,0,t);return{...n,set(i){Ln(i,n.views)}}}function On(s){const e=s.elementType;if(e)return On(e);const t=s.fields;if(t)return Object.values(t).reduce((i,{type:o})=>Math.max(i,On(o)),0);const{type:r}=s,{align:n}=Zt[r];return n}function zo(s){const e=s.elementType;if(e){const r=e.size,n=On(e);return{unalignedSize:r,align:n,size:Rn(r,n)}}const t=s.fields;if(t){const r=Object.values(t).pop();if(r.type.size===0)return zo(r.type)}return{size:0,unalignedSize:0,align:1}}(function(s=[],e){const t=new Set;for(const r of Gl){const n=Zt[r];t.has(n)||(t.add(n),n.flatten=s.includes(r)?e:!e)}})();class Ll{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}let ot=class{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(s){throw new Error("Cannot evaluate node")}evaluateString(s){return this.evaluate(s).toString()}search(s){}searchBlock(s,e){if(s){e(is.instance);for(const t of s)t instanceof Array?this.searchBlock(t,e):t.search(e);e(os.instance)}}};class is extends ot{}is.instance=new is;class os extends ot{}os.instance=new os;class de extends ot{constructor(){super()}}let In=class extends de{constructor(s,e,t,r,n,i){super(),this.calls=new Set,this.name=s,this.args=e,this.returnType=t,this.body=r,this.startLine=n,this.endLine=i}get astNodeType(){return"function"}search(s){this.searchBlock(this.body,s)}};class Ol extends de{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Il extends de{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Fl extends de{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Dl extends de{constructor(e,t,r,n){super(),this.init=e,this.condition=t,this.increment=r,this.body=n}get astNodeType(){return"for"}search(e){var t,r,n;(t=this.init)===null||t===void 0||t.search(e),(r=this.condition)===null||r===void 0||r.search(e),(n=this.increment)===null||n===void 0||n.search(e),this.searchBlock(this.body,e)}}class Gt extends de{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Ko extends de{constructor(e,t,r){super(),this.name=e,this.type=t,this.value=r}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Fn extends de{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Xo extends de{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var er,Cr,R,E,ye;(function(s){s.increment="++",s.decrement="--"})(er||(er={})),function(s){s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return s[t]}}(er||(er={}));class Ul extends de{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(function(s){s.assign="=",s.addAssign="+=",s.subtractAssin="-=",s.multiplyAssign="*=",s.divideAssign="/=",s.moduloAssign="%=",s.andAssign="&=",s.orAssign="|=",s.xorAssign="^=",s.shiftLeftAssign="<<=",s.shiftRightAssign=">>="})(Cr||(Cr={})),function(s){s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}}(Cr||(Cr={}));class kl extends de{constructor(e,t,r){super(),this.operator=e,this.variable=t,this.value=r}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Wo extends de{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}search(e){for(const t of this.args)t.search(e);e(this)}}class Nl extends de{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class Vl extends de{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"body"}}class Hl extends de{constructor(e,t,r,n){super(),this.condition=e,this.body=t,this.elseif=r,this.else=n}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class jl extends de{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Jl extends de{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class zl extends de{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Kl extends de{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class Yo extends de{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Xl extends de{constructor(){super()}get astNodeType(){return"discard"}}class Wl extends de{constructor(){super()}get astNodeType(){return"break"}}class Yl extends de{constructor(){super()}get astNodeType(){return"continue"}}class Rt extends de{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class Lt extends Rt{constructor(e,t,r,n){super(e),this.members=t,this.startLine=r,this.endLine=n}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}}class qo extends Rt{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"template"}}class ql extends Rt{constructor(e,t,r,n){super(e),this.storage=t,this.type=r,this.access=n}get astNodeType(){return"pointer"}}class Qo extends Rt{constructor(e,t,r,n){super(e),this.attributes=t,this.format=r,this.count=n}get astNodeType(){return"array"}get isArray(){return!0}}class Tr extends Rt{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"sampler"}}class ze extends ot{constructor(){super()}}class $o extends ze{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class tr extends ze{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){e(this);for(const t of this.args)t.search(e)}}class Zo extends ze{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return 180*this.args[0].evaluate(e)/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}search(e){for(const t of this.args)t.search(e);e(this)}}class Dn extends ze{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}evaluate(e){const t=e.constants.get(this.name);if(!t)throw new Error("Cannot evaluate node");return t.evaluate(e)}}class ea extends ze{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}evaluate(e){var t,r;if(this.initializer instanceof tr){const n=(t=this.postfix)===null||t===void 0?void 0:t.evaluateString(e),i=(r=this.initializer.type)===null||r===void 0?void 0:r.name,o=e.structs.get(i),c=o==null?void 0:o.getMemberIndex(n);if(c!=-1)return this.initializer.args[c].evaluate(e);console.log(c)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class ta extends ze{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class Ql extends ze{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class $l extends ze{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}search(e){this.searchBlock(this.args,e)}}class ra extends ze{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class Zl extends ze{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class sa extends ze{constructor(){super()}}class ed extends sa{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class Ze extends sa{constructor(e,t,r){super(),this.operator=e,this.left=t,this.right=r}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class na extends ot{constructor(){super()}}class td extends na{constructor(e,t){super(),this.selector=e,this.body=t}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class rd extends na{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class sd extends ot{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"argument"}}class nd extends ot{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class id extends ot{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"member"}}class ia extends ot{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}(function(s){s[s.token=0]="token",s[s.keyword=1]="keyword",s[s.reserved=2]="reserved"})(E||(E={}));class M{constructor(e,t,r){this.name=e,this.type=t,this.rule=r}toString(){return this.name}}class A{}R=A,A.none=new M("",E.reserved,""),A.eof=new M("EOF",E.token,""),A.reserved={asm:new M("asm",E.reserved,"asm"),bf16:new M("bf16",E.reserved,"bf16"),do:new M("do",E.reserved,"do"),enum:new M("enum",E.reserved,"enum"),f16:new M("f16",E.reserved,"f16"),f64:new M("f64",E.reserved,"f64"),handle:new M("handle",E.reserved,"handle"),i8:new M("i8",E.reserved,"i8"),i16:new M("i16",E.reserved,"i16"),i64:new M("i64",E.reserved,"i64"),mat:new M("mat",E.reserved,"mat"),premerge:new M("premerge",E.reserved,"premerge"),regardless:new M("regardless",E.reserved,"regardless"),typedef:new M("typedef",E.reserved,"typedef"),u8:new M("u8",E.reserved,"u8"),u16:new M("u16",E.reserved,"u16"),u64:new M("u64",E.reserved,"u64"),unless:new M("unless",E.reserved,"unless"),using:new M("using",E.reserved,"using"),vec:new M("vec",E.reserved,"vec"),void:new M("void",E.reserved,"void")},A.keywords={array:new M("array",E.keyword,"array"),atomic:new M("atomic",E.keyword,"atomic"),bool:new M("bool",E.keyword,"bool"),f32:new M("f32",E.keyword,"f32"),i32:new M("i32",E.keyword,"i32"),mat2x2:new M("mat2x2",E.keyword,"mat2x2"),mat2x3:new M("mat2x3",E.keyword,"mat2x3"),mat2x4:new M("mat2x4",E.keyword,"mat2x4"),mat3x2:new M("mat3x2",E.keyword,"mat3x2"),mat3x3:new M("mat3x3",E.keyword,"mat3x3"),mat3x4:new M("mat3x4",E.keyword,"mat3x4"),mat4x2:new M("mat4x2",E.keyword,"mat4x2"),mat4x3:new M("mat4x3",E.keyword,"mat4x3"),mat4x4:new M("mat4x4",E.keyword,"mat4x4"),ptr:new M("ptr",E.keyword,"ptr"),sampler:new M("sampler",E.keyword,"sampler"),sampler_comparison:new M("sampler_comparison",E.keyword,"sampler_comparison"),struct:new M("struct",E.keyword,"struct"),texture_1d:new M("texture_1d",E.keyword,"texture_1d"),texture_2d:new M("texture_2d",E.keyword,"texture_2d"),texture_2d_array:new M("texture_2d_array",E.keyword,"texture_2d_array"),texture_3d:new M("texture_3d",E.keyword,"texture_3d"),texture_cube:new M("texture_cube",E.keyword,"texture_cube"),texture_cube_array:new M("texture_cube_array",E.keyword,"texture_cube_array"),texture_multisampled_2d:new M("texture_multisampled_2d",E.keyword,"texture_multisampled_2d"),texture_storage_1d:new M("texture_storage_1d",E.keyword,"texture_storage_1d"),texture_storage_2d:new M("texture_storage_2d",E.keyword,"texture_storage_2d"),texture_storage_2d_array:new M("texture_storage_2d_array",E.keyword,"texture_storage_2d_array"),texture_storage_3d:new M("texture_storage_3d",E.keyword,"texture_storage_3d"),texture_depth_2d:new M("texture_depth_2d",E.keyword,"texture_depth_2d"),texture_depth_2d_array:new M("texture_depth_2d_array",E.keyword,"texture_depth_2d_array"),texture_depth_cube:new M("texture_depth_cube",E.keyword,"texture_depth_cube"),texture_depth_cube_array:new M("texture_depth_cube_array",E.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new M("texture_depth_multisampled_2d",E.keyword,"texture_depth_multisampled_2d"),texture_external:new M("texture_external",E.keyword,"texture_external"),u32:new M("u32",E.keyword,"u32"),vec2:new M("vec2",E.keyword,"vec2"),vec3:new M("vec3",E.keyword,"vec3"),vec4:new M("vec4",E.keyword,"vec4"),bitcast:new M("bitcast",E.keyword,"bitcast"),block:new M("block",E.keyword,"block"),break:new M("break",E.keyword,"break"),case:new M("case",E.keyword,"case"),continue:new M("continue",E.keyword,"continue"),continuing:new M("continuing",E.keyword,"continuing"),default:new M("default",E.keyword,"default"),diagnostic:new M("diagnostic",E.keyword,"diagnostic"),discard:new M("discard",E.keyword,"discard"),else:new M("else",E.keyword,"else"),enable:new M("enable",E.keyword,"enable"),fallthrough:new M("fallthrough",E.keyword,"fallthrough"),false:new M("false",E.keyword,"false"),fn:new M("fn",E.keyword,"fn"),for:new M("for",E.keyword,"for"),function:new M("function",E.keyword,"function"),if:new M("if",E.keyword,"if"),let:new M("let",E.keyword,"let"),const:new M("const",E.keyword,"const"),loop:new M("loop",E.keyword,"loop"),while:new M("while",E.keyword,"while"),private:new M("private",E.keyword,"private"),read:new M("read",E.keyword,"read"),read_write:new M("read_write",E.keyword,"read_write"),return:new M("return",E.keyword,"return"),requires:new M("requires",E.keyword,"requires"),storage:new M("storage",E.keyword,"storage"),switch:new M("switch",E.keyword,"switch"),true:new M("true",E.keyword,"true"),alias:new M("alias",E.keyword,"alias"),type:new M("type",E.keyword,"type"),uniform:new M("uniform",E.keyword,"uniform"),var:new M("var",E.keyword,"var"),override:new M("override",E.keyword,"override"),workgroup:new M("workgroup",E.keyword,"workgroup"),write:new M("write",E.keyword,"write"),r8unorm:new M("r8unorm",E.keyword,"r8unorm"),r8snorm:new M("r8snorm",E.keyword,"r8snorm"),r8uint:new M("r8uint",E.keyword,"r8uint"),r8sint:new M("r8sint",E.keyword,"r8sint"),r16uint:new M("r16uint",E.keyword,"r16uint"),r16sint:new M("r16sint",E.keyword,"r16sint"),r16float:new M("r16float",E.keyword,"r16float"),rg8unorm:new M("rg8unorm",E.keyword,"rg8unorm"),rg8snorm:new M("rg8snorm",E.keyword,"rg8snorm"),rg8uint:new M("rg8uint",E.keyword,"rg8uint"),rg8sint:new M("rg8sint",E.keyword,"rg8sint"),r32uint:new M("r32uint",E.keyword,"r32uint"),r32sint:new M("r32sint",E.keyword,"r32sint"),r32float:new M("r32float",E.keyword,"r32float"),rg16uint:new M("rg16uint",E.keyword,"rg16uint"),rg16sint:new M("rg16sint",E.keyword,"rg16sint"),rg16float:new M("rg16float",E.keyword,"rg16float"),rgba8unorm:new M("rgba8unorm",E.keyword,"rgba8unorm"),rgba8unorm_srgb:new M("rgba8unorm_srgb",E.keyword,"rgba8unorm_srgb"),rgba8snorm:new M("rgba8snorm",E.keyword,"rgba8snorm"),rgba8uint:new M("rgba8uint",E.keyword,"rgba8uint"),rgba8sint:new M("rgba8sint",E.keyword,"rgba8sint"),bgra8unorm:new M("bgra8unorm",E.keyword,"bgra8unorm"),bgra8unorm_srgb:new M("bgra8unorm_srgb",E.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new M("rgb10a2unorm",E.keyword,"rgb10a2unorm"),rg11b10float:new M("rg11b10float",E.keyword,"rg11b10float"),rg32uint:new M("rg32uint",E.keyword,"rg32uint"),rg32sint:new M("rg32sint",E.keyword,"rg32sint"),rg32float:new M("rg32float",E.keyword,"rg32float"),rgba16uint:new M("rgba16uint",E.keyword,"rgba16uint"),rgba16sint:new M("rgba16sint",E.keyword,"rgba16sint"),rgba16float:new M("rgba16float",E.keyword,"rgba16float"),rgba32uint:new M("rgba32uint",E.keyword,"rgba32uint"),rgba32sint:new M("rgba32sint",E.keyword,"rgba32sint"),rgba32float:new M("rgba32float",E.keyword,"rgba32float"),static_assert:new M("static_assert",E.keyword,"static_assert")},A.tokens={decimal_float_literal:new M("decimal_float_literal",E.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new M("hex_float_literal",E.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new M("int_literal",E.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new M("uint_literal",E.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new M("ident",E.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new M("and",E.token,"&"),and_and:new M("and_and",E.token,"&&"),arrow:new M("arrow ",E.token,"->"),attr:new M("attr",E.token,"@"),attr_left:new M("attr_left",E.token,"[["),attr_right:new M("attr_right",E.token,"]]"),forward_slash:new M("forward_slash",E.token,"/"),bang:new M("bang",E.token,"!"),bracket_left:new M("bracket_left",E.token,"["),bracket_right:new M("bracket_right",E.token,"]"),brace_left:new M("brace_left",E.token,"{"),brace_right:new M("brace_right",E.token,"}"),colon:new M("colon",E.token,":"),comma:new M("comma",E.token,","),equal:new M("equal",E.token,"="),equal_equal:new M("equal_equal",E.token,"=="),not_equal:new M("not_equal",E.token,"!="),greater_than:new M("greater_than",E.token,">"),greater_than_equal:new M("greater_than_equal",E.token,">="),shift_right:new M("shift_right",E.token,">>"),less_than:new M("less_than",E.token,"<"),less_than_equal:new M("less_than_equal",E.token,"<="),shift_left:new M("shift_left",E.token,"<<"),modulo:new M("modulo",E.token,"%"),minus:new M("minus",E.token,"-"),minus_minus:new M("minus_minus",E.token,"--"),period:new M("period",E.token,"."),plus:new M("plus",E.token,"+"),plus_plus:new M("plus_plus",E.token,"++"),or:new M("or",E.token,"|"),or_or:new M("or_or",E.token,"||"),paren_left:new M("paren_left",E.token,"("),paren_right:new M("paren_right",E.token,")"),semicolon:new M("semicolon",E.token,";"),star:new M("star",E.token,"*"),tilde:new M("tilde",E.token,"~"),underscore:new M("underscore",E.token,"_"),xor:new M("xor",E.token,"^"),plus_equal:new M("plus_equal",E.token,"+="),minus_equal:new M("minus_equal",E.token,"-="),times_equal:new M("times_equal",E.token,"*="),division_equal:new M("division_equal",E.token,"/="),modulo_equal:new M("modulo_equal",E.token,"%="),and_equal:new M("and_equal",E.token,"&="),or_equal:new M("or_equal",E.token,"|="),xor_equal:new M("xor_equal",E.token,"^="),shift_right_equal:new M("shift_right_equal",E.token,">>="),shift_left_equal:new M("shift_left_equal",E.token,"<<=")},A.simpleTokens={"@":R.tokens.attr,"{":R.tokens.brace_left,"}":R.tokens.brace_right,":":R.tokens.colon,",":R.tokens.comma,"(":R.tokens.paren_left,")":R.tokens.paren_right,";":R.tokens.semicolon},A.literalTokens={"&":R.tokens.and,"&&":R.tokens.and_and,"->":R.tokens.arrow,"[[":R.tokens.attr_left,"]]":R.tokens.attr_right,"/":R.tokens.forward_slash,"!":R.tokens.bang,"[":R.tokens.bracket_left,"]":R.tokens.bracket_right,"=":R.tokens.equal,"==":R.tokens.equal_equal,"!=":R.tokens.not_equal,">":R.tokens.greater_than,">=":R.tokens.greater_than_equal,">>":R.tokens.shift_right,"<":R.tokens.less_than,"<=":R.tokens.less_than_equal,"<<":R.tokens.shift_left,"%":R.tokens.modulo,"-":R.tokens.minus,"--":R.tokens.minus_minus,".":R.tokens.period,"+":R.tokens.plus,"++":R.tokens.plus_plus,"|":R.tokens.or,"||":R.tokens.or_or,"*":R.tokens.star,"~":R.tokens.tilde,_:R.tokens.underscore,"^":R.tokens.xor,"+=":R.tokens.plus_equal,"-=":R.tokens.minus_equal,"*=":R.tokens.times_equal,"/=":R.tokens.division_equal,"%=":R.tokens.modulo_equal,"&=":R.tokens.and_equal,"|=":R.tokens.or_equal,"^=":R.tokens.xor_equal,">>=":R.tokens.shift_right_equal,"<<=":R.tokens.shift_left_equal},A.regexTokens={decimal_float_literal:R.tokens.decimal_float_literal,hex_float_literal:R.tokens.hex_float_literal,int_literal:R.tokens.int_literal,uint_literal:R.tokens.uint_literal,ident:R.tokens.ident},A.storage_class=[R.keywords.function,R.keywords.private,R.keywords.workgroup,R.keywords.uniform,R.keywords.storage],A.access_mode=[R.keywords.read,R.keywords.write,R.keywords.read_write],A.sampler_type=[R.keywords.sampler,R.keywords.sampler_comparison],A.sampled_texture_type=[R.keywords.texture_1d,R.keywords.texture_2d,R.keywords.texture_2d_array,R.keywords.texture_3d,R.keywords.texture_cube,R.keywords.texture_cube_array],A.multisampled_texture_type=[R.keywords.texture_multisampled_2d],A.storage_texture_type=[R.keywords.texture_storage_1d,R.keywords.texture_storage_2d,R.keywords.texture_storage_2d_array,R.keywords.texture_storage_3d],A.depth_texture_type=[R.keywords.texture_depth_2d,R.keywords.texture_depth_2d_array,R.keywords.texture_depth_cube,R.keywords.texture_depth_cube_array,R.keywords.texture_depth_multisampled_2d],A.texture_external_type=[R.keywords.texture_external],A.any_texture_type=[...R.sampled_texture_type,...R.multisampled_texture_type,...R.storage_texture_type,...R.depth_texture_type,...R.texture_external_type],A.texel_format=[R.keywords.r8unorm,R.keywords.r8snorm,R.keywords.r8uint,R.keywords.r8sint,R.keywords.r16uint,R.keywords.r16sint,R.keywords.r16float,R.keywords.rg8unorm,R.keywords.rg8snorm,R.keywords.rg8uint,R.keywords.rg8sint,R.keywords.r32uint,R.keywords.r32sint,R.keywords.r32float,R.keywords.rg16uint,R.keywords.rg16sint,R.keywords.rg16float,R.keywords.rgba8unorm,R.keywords.rgba8unorm_srgb,R.keywords.rgba8snorm,R.keywords.rgba8uint,R.keywords.rgba8sint,R.keywords.bgra8unorm,R.keywords.bgra8unorm_srgb,R.keywords.rgb10a2unorm,R.keywords.rg11b10float,R.keywords.rg32uint,R.keywords.rg32sint,R.keywords.rg32float,R.keywords.rgba16uint,R.keywords.rgba16sint,R.keywords.rgba16float,R.keywords.rgba32uint,R.keywords.rgba32sint,R.keywords.rgba32float],A.const_literal=[R.tokens.int_literal,R.tokens.uint_literal,R.tokens.decimal_float_literal,R.tokens.hex_float_literal,R.keywords.true,R.keywords.false],A.literal_or_ident=[R.tokens.ident,R.tokens.int_literal,R.tokens.uint_literal,R.tokens.decimal_float_literal,R.tokens.hex_float_literal],A.element_count_expression=[R.tokens.int_literal,R.tokens.uint_literal,R.tokens.ident],A.template_types=[R.keywords.vec2,R.keywords.vec3,R.keywords.vec4,R.keywords.mat2x2,R.keywords.mat2x3,R.keywords.mat2x4,R.keywords.mat3x2,R.keywords.mat3x3,R.keywords.mat3x4,R.keywords.mat4x2,R.keywords.mat4x3,R.keywords.mat4x4,R.keywords.atomic,R.keywords.bitcast,...R.any_texture_type],A.attribute_name=[R.tokens.ident,R.keywords.block,R.keywords.diagnostic],A.assignment_operators=[R.tokens.equal,R.tokens.plus_equal,R.tokens.minus_equal,R.tokens.times_equal,R.tokens.division_equal,R.tokens.modulo_equal,R.tokens.and_equal,R.tokens.or_equal,R.tokens.xor_equal,R.tokens.shift_right_equal,R.tokens.shift_left_equal],A.increment_operators=[R.tokens.plus_plus,R.tokens.minus_minus];class oa{constructor(e,t,r){this.type=e,this.lexeme=t,this.line=r}toString(){return this.lexeme}isTemplateType(){return A.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==A.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class od{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new oa(A.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const t=A.simpleTokens[e];if(t)return this._addToken(t),!0;let r=A.none;const n=this._isAlpha(e),i=e==="_";if(this._isAlphaNumeric(e)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)e+=this._advance(),o=this._peekAhead()}if(n){const o=A.keywords[e];if(o)return this._addToken(o),!0}if(n||i)return this._addToken(A.tokens.ident),!0;for(;;){let o=this._findType(e);const c=this._peekAhead();if(e==">"&&(c==">"||c=="=")){let d=!1,g=this._tokens.length-1;for(let b=0;b<5&&g>=0;++b,--g)if(this._tokens[g].type===A.tokens.less_than){g>0&&this._tokens[g-1].isArrayOrTemplateType()&&(d=!0);break}if(d)return this._addToken(o),!0}if(o===A.none){let d=e,g=0;const b=2;for(let l=0;l<b;++l)if(d+=this._peekAhead(l),o=this._findType(d),o!==A.none){g=l;break}if(o===A.none)return r!==A.none&&(this._current--,this._addToken(r),!0);e=d,this._current+=g+1}if(r=o,this._isAtEnd())break;e+=this._advance()}return r!==A.none&&(this._addToken(r),!0)}_findType(e){for(const r in A.regexTokens){const n=A.regexTokens[r];if(this._match(e,n.rule))return n}return A.literalTokens[e]||A.none}_match(e,t){const r=t.exec(e);return r&&r.index==0&&r[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e=="_"||e>="0"&&e<="9"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new oa(e,t,this._line))}}class ad{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new Ll,this._deferArrayCountEval=[]}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;t.push(r)}if(this._deferArrayCountEval.length>0){for(const r of this._deferArrayCountEval){const n=r.arrayType,i=r.countNode;if(i instanceof Dn){const o=i.name,c=this._context.constants.get(o);if(c)try{const d=c.evaluate(this._context);n.count=d}catch{}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e)if(typeof e=="string"){const t=new od(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,t){return{token:e,message:t,toString:function(){return`${t}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==A.eof}_match(e){if(e instanceof M)return!!this._check(e)&&(this._advance(),!0);for(let t=0,r=e.length;t<r;++t){const n=e[t];if(this._check(n))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),t)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const r=t.type;return e.indexOf(r)!=-1}return t.type==e}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(A.tokens.semicolon)&&!this._isAtEnd(););if(this._match(A.keywords.alias)){const t=this._type_alias();return this._consume(A.tokens.semicolon,"Expected ';'"),t}if(this._match(A.keywords.diagnostic)){const t=this._diagnostic();return this._consume(A.tokens.semicolon,"Expected ';'"),t}if(this._match(A.keywords.requires)){const t=this._requires_directive();return this._consume(A.tokens.semicolon,"Expected ';'"),t}if(this._match(A.keywords.enable)){const t=this._enable_directive();return this._consume(A.tokens.semicolon,"Expected ';'"),t}const e=this._attribute();if(this._check(A.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(A.tokens.semicolon,"Expected ';'."),t}if(this._check(A.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(A.tokens.semicolon,"Expected ';'."),t}if(this._check(A.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(A.tokens.semicolon,"Expected ';'."),t}if(this._check(A.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(A.tokens.semicolon,"Expected ';'."),t}if(this._check(A.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),t}if(this._check(A.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),t}return null}_function_decl(){if(!this._match(A.keywords.fn))return null;const e=this._currentLine,t=this._consume(A.tokens.ident,"Expected function name.").toString();this._consume(A.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(A.tokens.paren_right))do{if(this._check(A.tokens.paren_right))break;const c=this._attribute(),d=this._consume(A.tokens.ident,"Expected argument name.").toString();this._consume(A.tokens.colon,"Expected ':' for argument type.");const g=this._attribute(),b=this._type_decl();b!=null&&(b.attributes=g,r.push(new sd(d,b,c)))}while(this._match(A.tokens.comma));this._consume(A.tokens.paren_right,"Expected ')' after function arguments.");let n=null;if(this._match(A.tokens.arrow)){const c=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=c)}const i=this._compound_statement(),o=this._currentLine;return new In(t,r,n,i,e,o)}_compound_statement(){const e=[];for(this._consume(A.tokens.brace_left,"Expected '{' for block.");!this._check(A.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(A.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(A.tokens.semicolon)&&!this._isAtEnd(););if(this._check(A.tokens.attr)&&this._attribute(),this._check(A.keywords.if))return this._if_statement();if(this._check(A.keywords.switch))return this._switch_statement();if(this._check(A.keywords.loop))return this._loop_statement();if(this._check(A.keywords.for))return this._for_statement();if(this._check(A.keywords.while))return this._while_statement();if(this._check(A.keywords.continuing))return this._continuing_statement();if(this._check(A.keywords.static_assert))return this._static_assert_statement();if(this._check(A.tokens.brace_left))return this._compound_statement();let e=null;return e=this._check(A.keywords.return)?this._return_statement():this._check([A.keywords.var,A.keywords.let,A.keywords.const])?this._variable_statement():this._match(A.keywords.discard)?new Xl:this._match(A.keywords.break)?new Wl:this._match(A.keywords.continue)?new Yl:this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),e!=null&&this._consume(A.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(A.keywords.static_assert))return null;const e=this._optional_paren_expression();return new Ol(e)}_while_statement(){if(!this._match(A.keywords.while))return null;const e=this._optional_paren_expression();this._check(A.tokens.attr)&&this._attribute();const t=this._compound_statement();return new Il(e,t)}_continuing_statement(){if(!this._match(A.keywords.continuing))return null;const e=this._compound_statement();return new Fl(e)}_for_statement(){if(!this._match(A.keywords.for))return null;this._consume(A.tokens.paren_left,"Expected '('.");const e=this._check(A.tokens.semicolon)?null:this._for_init();this._consume(A.tokens.semicolon,"Expected ';'.");const t=this._check(A.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(A.tokens.semicolon,"Expected ';'.");const r=this._check(A.tokens.paren_right)?null:this._for_increment();this._consume(A.tokens.paren_right,"Expected ')'."),this._check(A.tokens.attr)&&this._attribute();const n=this._compound_statement();return new Dl(e,t,r,n)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(A.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(A.tokens.equal)&&(t=this._short_circuit_or_expression()),new Gt(e.name,e.type,e.storage,e.access,t)}if(this._match(A.keywords.let)){const e=this._consume(A.tokens.ident,"Expected name for let.").toString();let t=null;if(this._match(A.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}this._consume(A.tokens.equal,"Expected '=' for let.");const r=this._short_circuit_or_expression();return new Fn(e,t,null,null,r)}if(this._match(A.keywords.const)){const e=this._consume(A.tokens.ident,"Expected name for const.").toString();let t=null;if(this._match(A.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}this._consume(A.tokens.equal,"Expected '=' for const.");const r=this._short_circuit_or_expression();return new Xo(e,t,null,null,r)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(A.increment_operators))return this._current=e,null;const r=this._consume(A.increment_operators,"Expected increment operator");return new Ul(r.type===A.tokens.plus_plus?er.increment:er.decrement,t)}_assignment_statement(){let e=null;if(this._check(A.tokens.brace_right))return null;let t=this._match(A.tokens.underscore);if(t||(e=this._unary_expression()),!t&&e==null)return null;const r=this._consume(A.assignment_operators,"Expected assignment operator."),n=this._short_circuit_or_expression();return new kl(Cr.parse(r.lexeme),e,n)}_func_call_statement(){if(!this._check(A.tokens.ident))return null;const e=this._current,t=this._consume(A.tokens.ident,"Expected function name."),r=this._argument_expression_list();return r===null?(this._current=e,null):new Wo(t.lexeme,r)}_loop_statement(){if(!this._match(A.keywords.loop))return null;this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Expected '{' for loop.");const e=[];let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let n of t)e.push(n);else e.push(t);t=this._statement()}let r=null;return this._match(A.keywords.continuing)&&(r=this._compound_statement()),this._consume(A.tokens.brace_right,"Expected '}' for loop."),new Nl(e,r)}_switch_statement(){if(!this._match(A.keywords.switch))return null;const e=this._optional_paren_expression();this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Expected '{' for switch.");const t=this._switch_body();if(t==null||t.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(A.tokens.brace_right,"Expected '}' for switch."),new Vl(e,t)}_switch_body(){const e=[];if(this._match(A.keywords.case)){const t=this._case_selectors();this._match(A.tokens.colon),this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Exected '{' for switch case.");const r=this._case_body();this._consume(A.tokens.brace_right,"Exected '}' for switch case."),e.push(new td(t,r))}if(this._match(A.keywords.default)){this._match(A.tokens.colon),this._check(A.tokens.attr)&&this._attribute(),this._consume(A.tokens.brace_left,"Exected '{' for switch default.");const t=this._case_body();this._consume(A.tokens.brace_right,"Exected '}' for switch default."),e.push(new rd(t))}if(this._check([A.keywords.default,A.keywords.case])){const t=this._switch_body();e.push(t[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(A.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(A.keywords.fallthrough))return this._consume(A.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(A.keywords.if))return null;const e=this._optional_paren_expression();this._check(A.tokens.attr)&&this._attribute();const t=this._compound_statement();let r=[];this._match_elseif()&&(this._check(A.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let n=null;return this._match(A.keywords.else)&&(this._check(A.tokens.attr)&&this._attribute(),n=this._compound_statement()),new Hl(e,t,r,n)}_match_elseif(){return this._tokens[this._current].type===A.keywords.else&&this._tokens[this._current+1].type===A.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),r=this._compound_statement();return e.push(new nd(t,r)),this._match_elseif()&&(this._check(A.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(A.keywords.return))return null;const e=this._short_circuit_or_expression();return new jl(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(A.tokens.or_or);)e=new Ze(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(A.tokens.and_and);)e=new Ze(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(A.tokens.or);)e=new Ze(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(A.tokens.xor);)e=new Ze(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(A.tokens.and);)e=new Ze(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([A.tokens.equal_equal,A.tokens.not_equal])?new Ze(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([A.tokens.less_than,A.tokens.greater_than,A.tokens.less_than_equal,A.tokens.greater_than_equal]);)e=new Ze(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([A.tokens.shift_left,A.tokens.shift_right]);)e=new Ze(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([A.tokens.plus,A.tokens.minus]);)e=new Ze(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([A.tokens.star,A.tokens.forward_slash,A.tokens.modulo]);)e=new Ze(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([A.tokens.minus,A.tokens.bang,A.tokens.tilde,A.tokens.star,A.tokens.and])?new ed(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(A.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(A.tokens.bracket_right,"Expected ']'.");const t=new Zl(e),r=this._postfix_expression();return r&&(t.postfix=r),t}if(this._match(A.tokens.period)){const e=this._consume(A.tokens.ident,"Expected member name."),t=this._postfix_expression(),r=new $o(e.lexeme);return t&&(r.postfix=t),r}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(A.tokens.ident)){const r=this._previous().toString();if(this._check(A.tokens.paren_left)){const n=this._argument_expression_list(),i=this._getStruct(r);return i!=null?new tr(i,n):new Zo(r,n)}if(this._context.constants.has(r)){const n=this._context.constants.get(r);return new ea(r,n.value)}return new Dn(r)}if(this._match(A.const_literal))return new ta(parseFloat(this._previous().toString()));if(this._check(A.tokens.paren_left))return this._paren_expression();if(this._match(A.keywords.bitcast)){this._consume(A.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(A.tokens.greater_than,"Expected '>'.");const n=this._paren_expression();return new Ql(r,n)}const e=this._type_decl(),t=this._argument_expression_list();return new $l(e,t)}_argument_expression_list(){if(!this._match(A.tokens.paren_left))return null;const e=[];do{if(this._check(A.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(A.tokens.comma));return this._consume(A.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(A.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(A.tokens.paren_right),new ra([e])}_paren_expression(){this._consume(A.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(A.tokens.paren_right,"Expected ')'."),new ra([e])}_struct_decl(){if(!this._match(A.keywords.struct))return null;const e=this._currentLine,t=this._consume(A.tokens.ident,"Expected name for struct.").toString();this._consume(A.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(A.tokens.brace_right);){const o=this._attribute(),c=this._consume(A.tokens.ident,"Expected variable name.").toString();this._consume(A.tokens.colon,"Expected ':' for struct member type.");const d=this._attribute(),g=this._type_decl();g!=null&&(g.attributes=d),this._check(A.tokens.brace_right)?this._match(A.tokens.comma):this._consume(A.tokens.comma,"Expected ',' for struct member."),r.push(new id(c,g,o))}this._consume(A.tokens.brace_right,"Expected '}' after struct body.");const n=this._currentLine,i=new Lt(t,r,e,n);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(A.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(A.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(A.keywords.const))return null;const e=this._consume(A.tokens.ident,"Expected variable name");let t=null;if(this._match(A.tokens.colon)){const i=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=i)}let r=null;if(this._match(A.tokens.equal)){const i=this._short_circuit_or_expression();if(i instanceof tr)r=i;else if(i instanceof ea&&i.initializer instanceof tr)r=i.initializer;else try{const o=i.evaluate(this._context);r=new ta(o)}catch{r=i}}const n=new Xo(e.toString(),t,"","",r);return this._context.constants.set(n.name,n),n}_global_let_decl(){if(!this._match(A.keywords.let))return null;const e=this._consume(A.tokens.ident,"Expected variable name");let t=null;if(this._match(A.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}let r=null;return this._match(A.tokens.equal)&&(r=this._const_expression()),new Fn(e.toString(),t,"","",r)}_const_expression(){if(this._match(A.const_literal))return new $o(this._previous().toString());const e=this._type_decl();this._consume(A.tokens.paren_left,"Expected '('.");let t=[];for(;!this._check(A.tokens.paren_right)&&(t.push(this._const_expression()),this._check(A.tokens.comma));)this._advance();return this._consume(A.tokens.paren_right,"Expected ')'."),new tr(e,t)}_variable_decl(){if(!this._match(A.keywords.var))return null;let e="",t="";this._match(A.tokens.less_than)&&(e=this._consume(A.storage_class,"Expected storage_class.").toString(),this._match(A.tokens.comma)&&(t=this._consume(A.access_mode,"Expected access_mode.").toString()),this._consume(A.tokens.greater_than,"Expected '>'."));const r=this._consume(A.tokens.ident,"Expected variable name");let n=null;if(this._match(A.tokens.colon)){const i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}return new Gt(r.toString(),n,e,t,null)}_override_decl(){if(!this._match(A.keywords.override))return null;const e=this._consume(A.tokens.ident,"Expected variable name");let t=null;if(this._match(A.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}return new Ko(e.toString(),t,null)}_diagnostic(){this._consume(A.tokens.paren_left,"Expected '('");const e=this._consume(A.tokens.ident,"Expected severity control name.");this._consume(A.tokens.comma,"Expected ','");const t=this._consume(A.tokens.ident,"Expected diagnostic rule name.");return this._consume(A.tokens.paren_right,"Expected ')'"),new Kl(e.toString(),t.toString())}_enable_directive(){const e=this._consume(A.tokens.ident,"identity expected.");return new Jl(e.toString())}_requires_directive(){const e=[this._consume(A.tokens.ident,"identity expected.").toString()];for(;this._match(A.tokens.comma);){const t=this._consume(A.tokens.ident,"identity expected.");e.push(t.toString())}return new zl(e)}_type_alias(){const e=this._consume(A.tokens.ident,"identity expected.");this._consume(A.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const r=new Yo(e.toString(),t);return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([A.tokens.ident,...A.texel_format,A.keywords.bool,A.keywords.f32,A.keywords.i32,A.keywords.u32])){const r=this._advance(),n=r.toString();return this._context.structs.has(n)?this._context.structs.get(n):this._context.aliases.has(n)?this._context.aliases.get(n).type:new Rt(r.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(A.template_types)){let r=this._advance().toString(),n=null,i=null;return this._match(A.tokens.less_than)&&(n=this._type_decl(),i=null,this._match(A.tokens.comma)&&(i=this._consume(A.access_mode,"Expected access_mode for pointer").toString()),this._consume(A.tokens.greater_than,"Expected '>' for type.")),new qo(r,n,i)}if(this._match(A.keywords.ptr)){let r=this._previous().toString();this._consume(A.tokens.less_than,"Expected '<' for pointer.");const n=this._consume(A.storage_class,"Expected storage_class for pointer");this._consume(A.tokens.comma,"Expected ',' for pointer.");const i=this._type_decl();let o=null;return this._match(A.tokens.comma)&&(o=this._consume(A.access_mode,"Expected access_mode for pointer").toString()),this._consume(A.tokens.greater_than,"Expected '>' for pointer."),new ql(r,n.toString(),i,o)}const t=this._attribute();if(this._match(A.keywords.array)){let r=null,n=-1;const i=this._previous();let o=null;if(this._match(A.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let d="";if(this._match(A.tokens.comma)){o=this._shift_expression();try{d=o.evaluate(this._context).toString(),o=null}catch{d="1"}}this._consume(A.tokens.greater_than,"Expected '>' for array."),n=d?parseInt(d):0}const c=new Qo(i.toString(),t,r,n);return o&&this._deferArrayCountEval.push({arrayType:c,countNode:o}),c}return null}_texture_sampler_types(){if(this._match(A.sampler_type))return new Tr(this._previous().toString(),null,null);if(this._match(A.depth_texture_type))return new Tr(this._previous().toString(),null,null);if(this._match(A.sampled_texture_type)||this._match(A.multisampled_texture_type)){const e=this._previous();this._consume(A.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(A.tokens.greater_than,"Expected '>' for sampler type."),new Tr(e.toString(),t,null)}if(this._match(A.storage_texture_type)){const e=this._previous();this._consume(A.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(A.texel_format,"Invalid texel format.").toString();this._consume(A.tokens.comma,"Expected ',' after texel format.");const r=this._consume(A.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(A.tokens.greater_than,"Expected '>' for sampler type."),new Tr(e.toString(),t,r)}return null}_attribute(){let e=[];for(;this._match(A.tokens.attr);){const t=this._consume(A.attribute_name,"Expected attribute name"),r=new ia(t.toString(),null);if(this._match(A.tokens.paren_left)){if(r.value=this._consume(A.literal_or_ident,"Expected attribute value").toString(),this._check(A.tokens.comma)){this._advance();do{const n=this._consume(A.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(n)}while(this._match(A.tokens.comma))}this._consume(A.tokens.paren_right,"Expected ')'")}e.push(r)}for(;this._match(A.tokens.attr_left);){if(!this._check(A.tokens.attr_right))do{const t=this._consume(A.attribute_name,"Expected attribute name"),r=new ia(t.toString(),null);if(this._match(A.tokens.paren_left)){if(r.value=[this._consume(A.literal_or_ident,"Expected attribute value").toString()],this._check(A.tokens.comma)){this._advance();do{const n=this._consume(A.literal_or_ident,"Expected attribute value").toString();r.value.push(n)}while(this._match(A.tokens.comma))}this._consume(A.tokens.paren_right,"Expected ')'")}e.push(r)}while(this._match(A.tokens.comma));this._consume(A.tokens.attr_right,"Expected ']]' after attribute declarations")}return e.length==0?null:e}}class rr{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class aa{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class as extends rr{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Un extends rr{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class ua extends rr{constructor(e,t,r,n){super(e,r),this.format=t,this.access=n}get isTemplate(){return!0}}(function(s){s[s.Uniform=0]="Uniform",s[s.Storage=1]="Storage",s[s.Texture=2]="Texture",s[s.Sampler=3]="Sampler",s[s.StorageTexture=4]="StorageTexture"})(ye||(ye={}));class us{constructor(e,t,r,n,i,o,c){this.name=e,this.type=t,this.group=r,this.binding=n,this.attributes=i,this.resourceType=o,this.access=c}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class ud{constructor(e,t){this.name=e,this.type=t}}class cs{constructor(e,t){this.align=e,this.size=t}}class cd{constructor(e,t,r,n){this.name=e,this.type=t,this.locationType=r,this.location=n,this.interpolation=null}}class ca{constructor(e,t,r,n){this.name=e,this.type=t,this.locationType=r,this.location=n}}class ld{constructor(e,t=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t}}class dd{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class hd{constructor(e,t,r,n){this.name=e,this.type=t,this.attributes=r,this.id=n}}class fd{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class at{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new dd,this.functions=[],this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}update(e){const t=new ad().parse(e);for(const r of t)r instanceof In&&this._functions.set(r.name,new fd(r));for(const r of t)if(r instanceof Lt){const n=this._getTypeInfo(r,null);n instanceof as&&this.structs.push(n)}for(const r of t)if(r instanceof Yo)this.aliases.push(this._getAliasInfo(r));else if(r instanceof Ko){const n=r,i=this._getAttributeNum(n.attributes,"id",0),o=n.type!=null?this._getTypeInfo(n.type,n.attributes):null;this.overrides.push(new hd(n.name,o,n.attributes,i))}else if(this._isUniformVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),d=new us(n.name,c,i,o,n.attributes,ye.Uniform,n.access);this.uniforms.push(d)}else if(this._isStorageVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),d=this._isStorageTexture(c),g=new us(n.name,c,i,o,n.attributes,d?ye.StorageTexture:ye.Storage,n.access);this.storage.push(g)}else if(this._isTextureVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),d=this._isStorageTexture(c),g=new us(n.name,c,i,o,n.attributes,d?ye.StorageTexture:ye.Texture,n.access);d?this.storage.push(g):this.textures.push(g)}else if(this._isSamplerVar(r)){const n=r,i=this._getAttributeNum(n.attributes,"group",0),o=this._getAttributeNum(n.attributes,"binding",0),c=this._getTypeInfo(n.type,n.attributes),d=new us(n.name,c,i,o,n.attributes,ye.Sampler,n.access);this.samplers.push(d)}else if(r instanceof In){const n=this._getAttribute(r,"vertex"),i=this._getAttribute(r,"fragment"),o=this._getAttribute(r,"compute"),c=n||i||o,d=new ld(r.name,c==null?void 0:c.name);d.startLine=r.startLine,d.endLine=r.endLine,this.functions.push(d),this._functions.get(r.name).info=d,c&&(this._functions.get(r.name).inUse=!0,d.inUse=!0,d.resources=this._findResources(r,!!c),d.inputs=this._getInputs(r.args),d.outputs=this._getOutputs(r.returnType),this.entry[c.name].push(d))}for(const r of this._functions.values())r.info&&(r.info.inUse=r.inUse,this._addCalls(r.node,r.info.calls));for(const r of this.uniforms)this._markStructsInUse(r.type);for(const r of this.storage)this._markStructsInUse(r.type)}_markStructsInUse(e){if(e.isStruct){e.inUse=!0;for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var r;for(const n of e.calls){const i=(r=this._functions.get(n.name))===null||r===void 0?void 0:r.info;i&&t.add(i)}}findResource(e,t){for(const r of this.uniforms)if(r.group==e&&r.binding==t)return r;for(const r of this.storage)if(r.group==e&&r.binding==t)return r;for(const r of this.textures)if(r.group==e&&r.binding==t)return r;for(const r of this.samplers)if(r.group==e&&r.binding==t)return r;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this._getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const r=[],n=this,i=[];return e.search(o=>{if(o instanceof is)i.push({});else if(o instanceof os)i.pop();else if(o instanceof Gt){const c=o;t&&c.type!==null&&this._markStructsFromAST(c.type),i.length>0&&(i[i.length-1][c.name]=c)}else if(o instanceof tr){const c=o;t&&c.type!==null&&this._markStructsFromAST(c.type)}else if(o instanceof Fn){const c=o;t&&c.type!==null&&this._markStructsFromAST(c.type),i.length>0&&(i[i.length-1][c.name]=c)}else if(o instanceof Dn){const c=o;if(i.length>0&&i[i.length-1][c.name])return;const d=n._findResource(c.name);d&&r.push(d)}else if(o instanceof Zo){const c=o,d=n._functions.get(c.name);d&&(t&&(d.inUse=!0),e.calls.add(d.node),d.resources===null&&(d.resources=n._findResources(d.node,t)),r.push(...d.resources))}else if(o instanceof Wo){const c=o,d=n._functions.get(c.name);d&&(t&&(d.inUse=!0),e.calls.add(d.node),d.resources===null&&(d.resources=n._findResources(d.node,t)),r.push(...d.resources))}}),[...new Map(r.map(o=>[o.name,o])).values()]}getBindGroups(){const e=[];function t(r,n){r>=e.length&&(e.length=r+1),e[r]===void 0&&(e[r]=[]),n>=e[r].length&&(e[r].length=n+1)}for(const r of this.uniforms)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.storage)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.textures)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.samplers)t(r.group,r.binding),e[r.group][r.binding]=r;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Lt)this._getStructOutputs(e,t);else{const r=this._getOutputInfo(e);r!==null&&t.push(r)}return t}_getStructOutputs(e,t){for(const r of e.members)if(r.type instanceof Lt)this._getStructOutputs(r.type,t);else{const n=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(n!==null){const i=this._getTypeInfo(r.type,r.type.attributes),o=this._parseInt(n.value),c=new ca(r.name,i,n.name,o);t.push(c)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getTypeInfo(e,e.attributes),n=this._parseInt(t.value);return new ca("",r,t.name,n)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const r of e)if(r.type instanceof Lt)this._getStructInputs(r.type,t);else{const n=this._getInputInfo(r);n!==null&&t.push(n)}return t}_getStructInputs(e,t){for(const r of e.members)if(r.type instanceof Lt)this._getStructInputs(r.type,t);else{const n=this._getInputInfo(r);n!==null&&t.push(n)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getAttribute(e,"interpolation"),n=this._getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),o=new cd(e.name,n,t.name,i);return r!==null&&(o.interpolation=this._parseString(r.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new ud(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,t){if(this._types.has(e))return this._types.get(e);if(e instanceof Qo){const n=e,i=this._getTypeInfo(n.format,n.attributes),o=new Un(n.name,t);return o.format=i,o.count=n.count,this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof Lt){const n=e,i=new as(n.name,t);i.startLine=n.startLine,i.endLine=n.endLine;for(const o of n.members){const c=this._getTypeInfo(o.type,o.attributes);i.members.push(new aa(o.name,c,o.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Tr){const n=e,i=n.format instanceof Rt,o=n.format?i?this._getTypeInfo(n.format,null):new rr(n.format,null):null,c=new ua(n.name,o,t,n.access);return this._types.set(e,c),this._updateTypeInfo(c),c}if(e instanceof qo){const n=e,i=n.format?this._getTypeInfo(n.format,null):null,o=new ua(n.name,i,t,n.access);return this._types.set(e,o),this._updateTypeInfo(o),o}const r=new rr(e.name,t);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var t,r;const n=this._getTypeSize(e);if(e.size=(t=n==null?void 0:n.size)!==null&&t!==void 0?t:0,e instanceof Un){const i=this._getTypeSize(e.format);e.stride=(r=i==null?void 0:i.size)!==null&&r!==void 0?r:0,this._updateTypeInfo(e.format)}e instanceof as&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let r=0,n=0,i=0,o=0;for(let c=0,d=e.members.length;c<d;++c){const g=e.members[c],b=this._getTypeSize(g);if(!b)continue;(t=this._getAlias(g.type.name))!==null&&t!==void 0||g.type;const l=b.align,x=b.size;r=this._roundUp(l,r+n),n=x,i=r,o=Math.max(o,l),g.offset=r,g.size=x,this._updateTypeInfo(g.type)}e.size=this._roundUp(o,i+n),e.align=o}_getTypeSize(e){var t;if(e==null)return null;const r=this._getAttributeNum(e.attributes,"size",0),n=this._getAttributeNum(e.attributes,"align",0);if(e instanceof aa&&(e=e.type),e instanceof rr){const i=this._getAlias(e.name);i!==null&&(e=i)}{const i=at._typeInfo[e.name];if(i!==void 0){const o=e.format==="f16"?2:1;return new cs(Math.max(n,i.align/o),Math.max(r,i.size/o))}}{const i=at._typeInfo[e.name.substring(0,e.name.length-1)];if(i){const o=e.name[e.name.length-1]==="h"?2:1;return new cs(Math.max(n,i.align/o),Math.max(r,i.size/o))}}if(e instanceof Un){let i=e,o=8,c=8;const d=this._getTypeSize(i.format);return d!==null&&(c=d.size,o=d.align),c=i.count*this._getAttributeNum((t=e==null?void 0:e.attributes)!==null&&t!==void 0?t:null,"stride",this._roundUp(o,c)),r&&(c=r),new cs(Math.max(n,o),Math.max(r,c))}if(e instanceof as){let i=0,o=0,c=0,d=0,g=0;for(const b of e.members){const l=this._getTypeSize(b.type);l!==null&&(i=Math.max(l.align,i),c=this._roundUp(l.align,c+d),d=l.size,g=c)}return o=this._roundUp(i,g+d),new cs(Math.max(n,i),Math.max(r,o))}return null}_isUniformVar(e){return e instanceof Gt&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Gt&&e.storage=="storage"}_isTextureVar(e){return e instanceof Gt&&e.type!==null&&at._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Gt&&e.type!==null&&at._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const r=e;if(!r||!r.attributes)return null;const n=r.attributes;for(let i of n)if(i.name==t)return i;return null}_getAttributeNum(e,t,r){if(e===null)return r;for(let n of e)if(n.name==t){let i=n!==null&&n.value!==null?n.value:r;return i instanceof Array&&(i=i[0]),typeof i=="number"?i:typeof i=="string"?parseInt(i):r}return r}_roundUp(e,t){return Math.ceil(t/e)*e}}function sr(s,e){return Object.fromEntries(e.map(t=>{const r=function(n,i,o){switch(i.resourceType){case ye.Uniform:case ye.Storage:case ye.StorageTexture:return Vn(n,i.type,o);default:return{size:0,type:i.type.name}}}(s,t,0);return[t.name,{typeDefinition:r,group:t.group,binding:t.binding,size:r.size}]}))}function la(s,e,t){return{fields:Object.fromEntries(e.members.map(r=>[r.name,{offset:r.offset,type:Vn(s,r.type,0)}])),size:e.size,offset:t}}function pd(s){var e;if(s.name.includes("depth"))return"depth";switch((e=s.format)==null?void 0:e.name){case"f32":return"float";case"i32":return"sint";case"u32":return"uint";default:throw new Error("unknown texture sample type")}}function da(s){return s.name.includes("2d_array")?"2d-array":s.name.includes("cube_array")?"cube-array":s.name.includes("3d")?"3d":s.name.includes("1d")?"1d":s.name.includes("cube")?"cube":"2d"}function md(s){switch(s.access){case"read":return"read-only";case"write":return"write-only";case"read_write":return"read-write";default:throw new Error("unknonw storage texture access")}}function gd(s){return s.name.endsWith("_comparison")?"comparison":"filtering"}function yd(s,e){const{binding:t,access:r,type:n}=s;switch(s.resourceType){case ye.Uniform:return{binding:t,visibility:e,buffer:{...s.size&&{minBindingSize:s.size}}};case ye.Storage:return{binding:t,visibility:e,buffer:{type:r===""||r==="read"?"read-only-storage":"storage",...s.size&&{minBindingSize:s.size}}};case ye.Texture:{if(n.name==="texture_external")return{binding:t,visibility:e,externalTexture:{}};const i=n.name.includes("multisampled");return{binding:t,visibility:e,texture:{sampleType:pd(n),viewDimension:da(n),multisampled:i}}}case ye.Sampler:return{binding:t,visibility:e,sampler:{type:gd(n)}};case ye.StorageTexture:return{binding:t,visibility:e,storageTexture:{access:md(n),format:n.format.name,viewDimension:da(n)}};default:throw new Error("unknown resource type")}}function kn(s,e){const t={};for(const r of s)t[r.name]={stage:e,resources:r.resources.map(n=>{const{name:i,group:o}=n;return{name:i,group:o,entry:yd(n,e)}})};return t}function Ot(s){const e=new at(s),t=Object.fromEntries(e.structs.map(c=>[c.name,la(e,c,0)])),r=sr(e,e.uniforms),n=sr(e,e.storage.filter(c=>c.resourceType===ye.Storage)),i=sr(e,e.storage.filter(c=>c.resourceType===ye.StorageTexture)),o=sr(e,e.textures.filter(c=>c.type.name!=="texture_external"));return{externalTextures:sr(e,e.textures.filter(c=>c.type.name==="texture_external")),samplers:sr(e,e.samplers),structs:t,storages:n,storageTextures:i,textures:o,uniforms:r,entryPoints:{...kn(e.entry.vertex,GPUShaderStage.VERTEX),...kn(e.entry.fragment,GPUShaderStage.FRAGMENT),...kn(e.entry.compute,GPUShaderStage.COMPUTE)}}}function Nn(s,e=""){if(!s)throw new Error(e)}function Vn(s,e,t){if(e.isArray){Nn(!e.isStruct,"struct array is invalid"),Nn(!e.isStruct,"template array is invalid");const r=e;return{size:r.size,elementType:Vn(s,r.format,t),numElements:r.count}}if(e.isStruct)return Nn(!e.isTemplate,"template struct is invalid"),la(s,e,t);{const r=e,n=e.isTemplate?`${r.name}<${r.format.name}>`:e.name;return{size:e.size,type:n}}}at._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},at._textureTypes=A.any_texture_type.map(s=>s.name),at._samplerTypes=A.sampler_type.map(s=>s.name);const bd=new Map([[Int8Array,{formats:["sint8","snorm8"],defaultForType:1}],[Uint8Array,{formats:["uint8","unorm8"],defaultForType:1}],[Int16Array,{formats:["sint16","snorm16"],defaultForType:1}],[Uint16Array,{formats:["uint16","unorm16"],defaultForType:1}],[Int32Array,{formats:["sint32","snorm32"],defaultForType:0}],[Uint32Array,{formats:["uint32","unorm32"],defaultForType:0}],[Float32Array,{formats:["float32","float32"],defaultForType:0}]]);new Map([...bd.entries()].map(([s,{formats:[e,t]}])=>[[e,s],[t,s]]).flat());const vt=class vt{static getActiveRenderPassType(){return this.activeRenderPassType}static setActiveRenderPass(e,t){this.activeRenderPassType=e,this.activeRenderPassEncoder=t,this.currentlyBoundRenderPSO=null}static bindRenderPSO(e){var t;e!==this.currentlyBoundRenderPSO&&(this.currentlyBoundRenderPSO=e,(t=this.activeRenderPassEncoder)==null||t.setPipeline(e))}};vt.ENABLE_DEBUG_GROUPS=!1,vt.elapsedTimeMs=0,vt.deltaTimeMs=0,vt.frameIndex=0,vt.depthStencilFormat="depth24plus-stencil8",vt.prevTimeMs=0;let v=vt;class xd{constructor(e,t){this.normal=e,this.d=t}normalize(){const e=D.len(this.normal);D.normalize(this.normal,this.normal),this.d/=e}checkIfBBoxIsInside(e){const t=this.normal[0]>=0?e.maxX:e.minX,r=this.normal[1]>=0?e.maxY:e.minY,n=this.normal[2]>=0?e.maxZ:e.minZ;return this.normal[0]*t+this.normal[1]*r+this.normal[2]*n+this.d>=0}}let ha={};const fa=new WeakMap,pa={metric:[{from:0,to:1e3,unit:"B",long:"bytes"},{from:1e3,to:1e6,unit:"kB",long:"kilobytes"},{from:1e6,to:1e9,unit:"MB",long:"megabytes"},{from:1e9,to:1e12,unit:"GB",long:"gigabytes"},{from:1e12,to:1e15,unit:"TB",long:"terabytes"},{from:1e15,to:1e18,unit:"PB",long:"petabytes"},{from:1e18,to:1e21,unit:"EB",long:"exabytes"},{from:1e21,to:1e24,unit:"ZB",long:"zettabytes"},{from:1e24,to:1e27,unit:"YB",long:"yottabytes"}],metric_octet:[{from:0,to:1e3,unit:"o",long:"octets"},{from:1e3,to:1e6,unit:"ko",long:"kilooctets"},{from:1e6,to:1e9,unit:"Mo",long:"megaoctets"},{from:1e9,to:1e12,unit:"Go",long:"gigaoctets"},{from:1e12,to:1e15,unit:"To",long:"teraoctets"},{from:1e15,to:1e18,unit:"Po",long:"petaoctets"},{from:1e18,to:1e21,unit:"Eo",long:"exaoctets"},{from:1e21,to:1e24,unit:"Zo",long:"zettaoctets"},{from:1e24,to:1e27,unit:"Yo",long:"yottaoctets"}],iec:[{from:0,to:Math.pow(1024,1),unit:"B",long:"bytes"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"KiB",long:"kibibytes"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"MiB",long:"mebibytes"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"GiB",long:"gibibytes"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"TiB",long:"tebibytes"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"PiB",long:"pebibytes"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"EiB",long:"exbibytes"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"ZiB",long:"zebibytes"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"YiB",long:"yobibytes"}],iec_octet:[{from:0,to:Math.pow(1024,1),unit:"o",long:"octets"},{from:Math.pow(1024,1),to:Math.pow(1024,2),unit:"Kio",long:"kibioctets"},{from:Math.pow(1024,2),to:Math.pow(1024,3),unit:"Mio",long:"mebioctets"},{from:Math.pow(1024,3),to:Math.pow(1024,4),unit:"Gio",long:"gibioctets"},{from:Math.pow(1024,4),to:Math.pow(1024,5),unit:"Tio",long:"tebioctets"},{from:Math.pow(1024,5),to:Math.pow(1024,6),unit:"Pio",long:"pebioctets"},{from:Math.pow(1024,6),to:Math.pow(1024,7),unit:"Eio",long:"exbioctets"},{from:Math.pow(1024,7),to:Math.pow(1024,8),unit:"Zio",long:"zebioctets"},{from:Math.pow(1024,8),to:Math.pow(1024,9),unit:"Yio",long:"yobioctets"}]};class _d{constructor(e,t){t=Object.assign({units:"metric",precision:1,locale:void 0},ha,t),fa.set(this,t),Object.assign(pa,t.customUnits);const r=e<0?"-":"";e=Math.abs(e);const n=pa[t.units];if(!n)throw new Error(`Invalid units specified: ${t.units}`);{const i=n.find(o=>e>=o.from&&e<o.to);if(i){const o=new Intl.NumberFormat(t.locale,{style:"decimal",maximumFractionDigits:t.precision}),c=i.from===0?r+o.format(e):r+o.format(e/i.from);this.value=c,this.unit=i.unit,this.long=i.long}else this.value=r+e,this.unit="",this.long=""}}toString(){const e=fa.get(this);return e.toStringFn?e.toStringFn.bind(this)():`${this.value} ${this.unit}`}}function ma(s,e){return new _d(s,e)}ma.defaultOptions=function(s){ha=s};const ga=new Map([["r16float",Uint16Array.BYTES_PER_ELEMENT],["rg16float",2*Uint16Array.BYTES_PER_ELEMENT],["rgba16float",4*Uint16Array.BYTES_PER_ELEMENT],["r32float",Float32Array.BYTES_PER_ELEMENT],["rg32float",2*Float32Array.BYTES_PER_ELEMENT],["rgba32float",4*Float32Array.BYTES_PER_ELEMENT],["bgra8unorm",4*Uint8Array.BYTES_PER_ELEMENT],["rgba8unorm",4*Uint8Array.BYTES_PER_ELEMENT],["depth24plus",3],["depth32float",Float32Array.BYTES_PER_ELEMENT],["depth24plus-stencil8",Float32Array.BYTES_PER_ELEMENT]]),fo=class fo extends $e{static get formattedSize(){return this.getFormattedSize()}static getFormattedSize(){return ma(this.bytesAllocated).toString()}static addBytes(e){this.bytesAllocated+=e}static removeBytes(e){this.bytesAllocated-=e,this.bytesAllocated<0&&console.warn("Bytes allocated less than 0!")}static addBufferBytes(e){this.addBytes(e.size)}static removeBufferBytes(e){this.removeBytes(e.size)}static addTextureBytes(e){const t=ga.get(e.format);if(t)for(let r=0;r<e.depthOrArrayLayers;r++)for(let n=0;n<e.mipLevelCount;n++){const i=t*Math.ceil(e.width/Math.pow(2,n))*Math.ceil(e.height/Math.pow(2,n));this.addBytes(i)}else console.warn(`No byte size per pixel info for ${e.format}`)}static removeTextureBytes(e){const t=ga.get(e.format);if(t)for(let r=0;r<e.depthOrArrayLayers;r++)for(let n=0;n<e.mipLevelCount;n++){const i=t*Math.ceil(e.width/Math.pow(2,n))*Math.ceil(e.height/Math.pow(2,n));this.removeBytes(i)}else console.warn(`No byte size per pixel info for ${e.format}`)}};fo.bytesAllocated=0;let W=fo;class nr{constructor(){this._position=D.fromValues(0,0,0),this._rotation=D.fromValues(0,0,0),this._scale=D.fromValues(1,1,1),this._worldPosition=D.create(),this.translateMatrix=$.identity(),this.scaleMatrix=$.identity(),this.rotationMatrix=$.identity(),this.cachedMatrix=$.create(),this.worldMatrix=$.identity(),this.normalMatrix=ts.create(),this.quaternion=rs.create(),this.prevFrameModelMatrix=$.create(),this.matrixNeedsUpdate=!0,this.id=crypto.randomUUID(),this.label="Object",this.children=[],this._visible=!0}get visible(){return this._visible}set visible(e){this.onVisibilityChange(e),this._visible=e}get modelMatrix(){return this.worldMatrix}setCustomMatrix(e){this._customMatrix=e,this.matrixNeedsUpdate=!0}setCustomMatrixFromTRS(e,t,r){const n=$.scaling(r),i=$.fromQuat(t),o=$.translation(e);$.mul(n,i,n),$.mul(n,o),this.setCustomMatrix(n)}updateNormalMatrix(){ts.fromMat4(this.worldMatrix,this.normalMatrix),ts.inverse(this.normalMatrix,this.normalMatrix),ts.transpose(this.normalMatrix,this.normalMatrix)}updateWorldMatrix(){var t;const e=((t=this.parent)==null?void 0:t.worldMatrix)??Sl;return this.matrixNeedsUpdate?(this._customMatrix?$.copy(this._customMatrix,this.cachedMatrix):($.identity(this.scaleMatrix),$.scale(this.scaleMatrix,this.scale,this.scaleMatrix),this.quaternion=rs.fromEuler(this.rotation[0],this.rotation[1],this.rotation[2],"xyz"),$.fromQuat(this.quaternion,this.rotationMatrix),$.identity(this.translateMatrix),$.translate(this.translateMatrix,this.position,this.translateMatrix),$.mul(this.scaleMatrix,this.rotationMatrix,this.cachedMatrix),$.mul(this.translateMatrix,this.cachedMatrix,this.cachedMatrix)),$.mul(e,this.cachedMatrix,this.worldMatrix),$.copy(this.worldMatrix,this.prevFrameModelMatrix),this.updateNormalMatrix(),this.matrixNeedsUpdate=!1,!0):($.mul(e,this.cachedMatrix,this.worldMatrix),$.copy(this.worldMatrix,this.prevFrameModelMatrix),this.updateNormalMatrix(),!1)}onVisibilityChange(e){}addChild(e){e.parent=this,this.children.push(e),e.updateWorldMatrix(),this.onChildAdd(e)}removeChild(e){this.children=this.children.filter(({id:t})=>t!=e.id),e.parent=null,this.onChildRemove(e)}onChildAdd(e){var t;(t=this.parent)==null||t.onChildAdd(e)}onChildRemove(e){var t;(t=this.parent)==null||t.onChildRemove(e)}traverse(e,t=!0){if(e(this),t)for(const r of this.children)r.traverse(e,t)}findChild(e){if(e(this))return this;for(const t of this.children)if(t.findChild(e))return t}findChildByLabel(e){return this.findChild(({label:t})=>e===t)}findChildById(e){return this.findChild(({id:t})=>e===t)}preRender(e){}onRender(e){}postRender(e){}render(e){this.visible&&(this.preRender(e),this.onRender(e),this.postRender(e))}get worldPosition(){return this.getWorldPosition()}getWorldPosition(){return this._worldPosition[0]=this.worldMatrix[12],this._worldPosition[1]=this.worldMatrix[13],this._worldPosition[2]=this.worldMatrix[14],this._worldPosition}setPositionAsVec3(e){return D.clone(e,this._position),this.matrixNeedsUpdate=!0,this}setPosition(e,t,r){return this._position[0]=e,this._position[1]=t,this._position[2]=r,this.matrixNeedsUpdate=!0,this}setPositionX(e){return this._position[0]=e,this.matrixNeedsUpdate=!0,this}setPositionY(e){return this._position[1]=e,this.matrixNeedsUpdate=!0,this}setPositionZ(e){return this._position[2]=e,this.matrixNeedsUpdate=!0,this}get position(){return this.getPosition()}getPosition(){return this._position}getPositionX(){return this._position[0]}getPositionY(){return this._position[1]}getPositionZ(){return this._position[2]}setRotation(e,t,r){return this._rotation[0]=e,this._rotation[1]=t,this._rotation[2]=r,this.matrixNeedsUpdate=!0,this}setRotationX(e){return this._rotation[0]=e,this.matrixNeedsUpdate=!0,this}setRotationY(e){return this._rotation[1]=e,this.matrixNeedsUpdate=!0,this}setRotationZ(e){return this._rotation[2]=e,this.matrixNeedsUpdate=!0,this}get rotation(){return this.getRotation()}getRotation(){return this._rotation}getRotationX(){return this._rotation[0]}getRotationY(){return this._rotation[1]}getRotationZ(){return this._rotation[2]}setScale(e,t,r){return this._scale[0]=e,this._scale[1]=t,this._scale[2]=r,this.matrixNeedsUpdate=!0,this}setScaleX(e){return this._scale[0]=e,this.matrixNeedsUpdate=!0,this}setScaleY(e){return this._scale[1]=e,this.matrixNeedsUpdate=!0,this}setScaleZ(e){return this._scale[2]=e,this.matrixNeedsUpdate=!0,this}get scale(){return this.getScale()}getScale(){return this._scale}getScaleX(){return this._scale[0]}getScaleY(){return this._scale[1]}getScaleZ(){return this._scale[2]}}const ke=Object.freeze({get Position(){return 0},get Normal(){return 1},get TexCoord(){return 2},get Tangent(){return 3}}),ae=Object.freeze({get CameraPlusOptionalLights(){return 0},get Model(){return 1},get PBRTextures(){return 2},get InstanceInputs(){return 3}}),ut=Object.freeze({get NormalMetallicRoughness(){return 0},get ColorReflectance(){return 1},get Velocity(){return 2}}),ls=Object.freeze({get Default(){return 0}}),pe=Object.freeze({get Albedo(){return 1},get Normal(){return 2},get MetallicRoughness(){return 3},get AO(){return 4}}),Y=Object.freeze({get VertexInput(){return`

      struct VertexInput {
        @location(${ke.Position}) position: vec4f,
        @location(${ke.Normal}) normal: vec3f,
        @location(${ke.TexCoord}) uv: vec2f,
        @location(${ke.Tangent}) tangent: vec4f,
      };

    `},get VertexOutput(){return`
    
      struct VertexOutput {
        @builtin(position) position: vec4f,
        @location(0) worldPosition: vec3f,
        @location(1) viewNormal: vec3f,
        @location(2) uv: vec2f,
        @location(3) viewTangent: vec3f,
        @location(4) viewBitangent: vec3f,
        @location(5) currFrameClipPos: vec4f,
        @location(6) prevFrameClipPos: vec4f,
        @location(7) @interpolate(flat) instanceId: u32,
      };

    `},get InstanceInput(){return`
      struct InstanceInput {
        worldMatrix: mat4x4f,
        metallic: f32,
        roughness: f32,
      };
    `},get ModelUniform(){return`

      struct ModelUniform {
        worldMatrix: mat4x4f,
        prevFrameWorldMatrix: mat4x4f,
        normalMatrix: mat3x3f,
        baseColor: vec3f,
        isReflective: u32,
        metallic: f32,
        roughness: f32,
      };

    `},get Camera(){return`

      struct Camera {
        position: vec3f,
        projectionMatrix: mat4x4f,
        viewMatrix: mat4x4f,
        projectionViewMatrix: mat4x4f,
        inverseProjectionViewMatrix: mat4x4f,
        inverseViewMatrix: mat4x4f,
        inverseProjectionMatrix: mat4x4f,
        prevFrameProjectionViewMatrix: mat4x4f,
        viewportWidth: u32,
        viewportHeight: u32,
        jitterOffset: vec2f,
      };

      @must_use
      fn calcWorldPos(
        camera: Camera,
        coord: vec2f,
        depth: f32
      ) -> vec3f {
        let ndcX = coord.x / f32(camera.viewportWidth) * 2.0 - 1.0;
        let ndcY = (1.0 - coord.y / f32(camera.viewportHeight)) * 2.0 - 1.0;
        let clipPos = vec4f(ndcX, ndcY, depth, 1.0);

        let worldSpacePos = camera.inverseProjectionViewMatrix * clipPos;
        return worldSpacePos.xyz / worldSpacePos.w;
      }

      @must_use
      fn calcViewSpacePos(
        camera: Camera,
        coord: vec2f,
        depth: f32
      ) -> vec3f {
        let ndcX = coord.x / f32(camera.viewportWidth) * 2.0 - 1.0;
        let ndcY = (1.0 - coord.y / f32(camera.viewportHeight)) * 2.0 - 1.0;
        let clipPos = vec4f(ndcX, ndcY, depth, 1.0);

        let viewSpacePos = camera.inverseProjectionMatrix * clipPos;
        return viewSpacePos.xyz / viewSpacePos.w;
      }

    `},get GBufferOutput(){return`

      struct GBufferOutput {
        @location(${ut.NormalMetallicRoughness}) normalMetallicRoughness: vec4f,
        @location(${ut.ColorReflectance}) color: vec4f,
        @location(${ut.Velocity}) velocity: vec4f,
      };
      
    `},get AABB(){return`
      struct AABB {
        min: vec3f,
        max: vec3f,
      };
    `},get Particle(){return`
      struct Particle {
        radius: f32,
        position: vec3f,
        origPosition: vec3f,
        velocity: vec3f,
        lifeSpeed: f32,
        life: f32
      };
    `},get Light(){return`

      struct Light {
        lightType: u32, // 0 - Directional Light, 1 - Point Light, 2 - Ambient Light
        intensity: f32,
        radius: f32,
        position: vec3f,
        color: vec3f,
      };

    `},get Material(){return`
    
      struct Material {
        metallic: f32,
        albedo: vec3f,
        roughness: f32,
        ambientOcclusion: f32,
      };

    `},get ShadowCascade(){return`
      struct ShadowCascade {
        projViewMatrix: mat4x4<f32>,
        distance: f32,
      };
    `},get CommonHelpers(){return`

      const WORLD_UP = vec3f(0.0, 1.0, 0.0);
      const WORLD_FORWARD = vec3f(0.0, 0.0, 1.0);
      const PI: f32 = 3.1415;
      const TWO_PI: f32 = 6.2831;
      const HALF_PI: f32 = 1.5707;
      const DELTA_PHI: f32 = 0.01745;
      const DELTA_THETA: f32 = 0.01745;
    
      const CUBE_NORMALS: array<vec3<f32>, 6> = array<vec3<f32>, 6>(
        vec3<f32>(1.0, 0.0, 0.0),
        vec3<f32>(-1.0, 0.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, -1.0, 0.0),
        vec3<f32>(0.0, 0.0, 1.0),
        vec3<f32>(0.0, 0.0, -1.0)
      );
      
      const CUBE_UPS: array<vec3<f32>, 6> = array<vec3<f32>, 6>(
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 0.0, -1.0),
        vec3<f32>(0.0, 0.0, 1.0),
        vec3<f32>(0.0, 1.0, 0.0),
        vec3<f32>(0.0, 1.0, 0.0)
      );
      
      const CUBE_ROTATIONS: array<vec4<f32>, 6> = array<vec4<f32>, 6>(
        vec4<f32>(0.0, 1.0, 0.0, HALF_PI),
        vec4<f32>(0.0, 1.0, 0.0, -HALF_PI),
        vec4<f32>(1.0, 0.0, 0.0, -HALF_PI),
        vec4<f32>(1.0, 0.0, 0.0, HALF_PI),
        vec4<f32>(0.0, 0.0, 1.0, 0.0),
        vec4<f32>(0.0, 1.0, 0.0, PI)
      );
    `},get MathHelpers(){return`

      @must_use
      fn rotateAxisAngle(inAxis: vec3f, angle: f32) -> mat3x3f {
        let axis = normalize(inAxis);
        let s = sin(angle);
        let c = cos(angle);
        let oc = 1.0 - c;
    
        return mat3x3f(
          oc * axis.x * axis.x + c, oc * axis.x * axis.y - axis.z * s, oc * axis.z * axis.x + axis.y * s,
          oc * axis.x * axis.y + axis.z * s, oc * axis.y * axis.y + c, oc * axis.y * axis.z - axis.x * s,
          oc * axis.z * axis.x - axis.y * s, oc * axis.y * axis.z + axis.x * s, oc * axis.z * axis.z + c
        );
      }
      
    `}}),ya=[[.5,.333333],[.25,.666667],[.75,.111111],[.125,.444444],[.625,.777778],[.375,.222222],[.875,.555556],[.0625,.888889],[.5625,.037037],[.3125,.37037],[.8125,.703704],[.1875,.148148],[.6875,.481481],[.4375,.814815],[.9375,.259259],[.03125,.592593]],on=class on extends nr{constructor(){super(),this.lookAt=D.fromValues(0,0,0),this.hasChangedSinceLastFrame=!0,this.projectionMatrix=$.create(),this.inverseProjectionMatrix=$.create(),this.viewMatrix=$.create(),this.inverseViewMatrix=$.create(),this.projectionViewMatrix=$.create(),this.inverseProjectionViewMatrix=$.create(),this._shouldJitter=!1,this._shouldJitterChanged=!1,this.prevFrameProjectionViewMatrix=$.create(),this.frameCounter=0,this.frustumPlanes=[],this.hamiltonSequence=new Array(16).fill([]).map(()=>new Array(2).fill(0));const e=Ot(Y.Camera);this.bufferUniformValues=yt(e.structs.Camera),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,projectionMatrix:this.projectionMatrix,projectionViewMatrix:this.projectionViewMatrix}),this.gpuBuffer=v.device.createBuffer({size:this.bufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,label:"Camera GPUBuffer"}),W.addBufferBytes(this.gpuBuffer);for(let t=0;t<6;t++)this.frustumPlanes.push(new xd(D.create(),0))}get shouldJitter(){return this._shouldJitter}set shouldJitter(e){this._shouldJitter=e,this._shouldJitterChanged=!0}set x(e){this.position[0]=e,this.bufferUniformValues.set({position:this.position})}get x(){return this.position[0]}set y(e){this.position[1]=e,this.bufferUniformValues.set({position:this.position})}get y(){return this.position[1]}set z(e){this.position[2]=e,this.bufferUniformValues.set({position:this.position})}get z(){return this.position[2]}get frustumCornersWorldSpace(){const e=this.inverseProjectionViewMatrix,t=[];for(let r=0;r<2;r++)for(let n=0;n<2;n++)for(let i=0;i<2;i++){const o=2*r-1,c=2*n-1,d=i,g=1,b=wr.create(o,c,d,g);wr.transformMat4(b,e,b),b[0]/=b[3],b[1]/=b[3],b[2]/=b[3],t.push(b)}return t}cullMeshes(e,t){let r=0;for(let n=0;n<e.length;n++){const i=e[n].worldBoundingBox;let o=0;for(const c of this.frustumPlanes)c.checkIfBBoxIsInside(i)&&o++;o===6&&(t[r]=e[n],r++)}return r}setLookAt(e,t,r){this.lookAt[0]=e,this.lookAt[1]=t,this.lookAt[2]=r}setLookAtVec3(e){this.lookAt=e}updateViewMatrix(){return $.lookAt(this.position,this.lookAt,on.UP_VECTOR,this.viewMatrix),$.inverse(this.viewMatrix,this.inverseViewMatrix),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,inverseViewMatrix:this.inverseViewMatrix}),this.updateProjectionViewMatrix(),this}updateViewMatrixWithMat(e){return this.viewMatrix=e,$.inverse(this.viewMatrix,this.inverseViewMatrix),this.bufferUniformValues.set({viewMatrix:this.viewMatrix,inverseViewMatrix:this.inverseViewMatrix}),this.updateProjectionViewMatrix(),this}updateProjectionMatrix(){return $.inverse(this.projectionMatrix,this.inverseProjectionMatrix),this.bufferUniformValues.set({projectionMatrix:this.projectionMatrix,inverseProjectionMatrix:this.inverseProjectionMatrix}),this.updateProjectionViewMatrix(),this}updateProjectionViewMatrix(){return $.mul(this.projectionMatrix,this.viewMatrix,this.projectionViewMatrix),$.inverse(this.projectionViewMatrix,this.inverseProjectionViewMatrix),this.bufferUniformValues.set({projectionViewMatrix:this.projectionViewMatrix,inverseProjectionViewMatrix:this.inverseProjectionViewMatrix,prevFrameProjectionViewMatrix:this.prevFrameProjectionViewMatrix}),this.updateFrustumPlanes(),this}onResize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.bufferUniformValues.set({viewportWidth:e,viewportHeight:t});for(let r=0;r<16;r++)this.hamiltonSequence[r][0]=(ya[r][0]-.5)/this.viewportWidth*2,this.hamiltonSequence[r][1]=(ya[r][1]-.5)/this.viewportHeight*2}onFrameStart(){const e=this.hamiltonSequence[this.frameCounter%16];this._shouldJitterChanged&&(this._shouldJitter||this.bufferUniformValues.set({jitterOffset:[0,0]}),this._shouldJitterChanged=!1),this._shouldJitter&&this.bufferUniformValues.set({jitterOffset:e}),v.device.queue.writeBuffer(this.gpuBuffer,0,this.bufferUniformValues.arrayBuffer)}onFrameEnd(){$.copy(this.projectionViewMatrix,this.prevFrameProjectionViewMatrix),this.frameCounter++,this.hasChangedSinceLastFrame=!1}updateFrustumPlanes(){const e=this.projectionViewMatrix;this.frustumPlanes[0].normal[0]=e[3]+e[0],this.frustumPlanes[0].normal[1]=e[7]+e[4],this.frustumPlanes[0].normal[2]=e[11]+e[8],this.frustumPlanes[0].d=e[15]+e[12],this.frustumPlanes[1].normal[0]=e[3]-e[0],this.frustumPlanes[1].normal[1]=e[7]-e[4],this.frustumPlanes[1].normal[2]=e[11]-e[8],this.frustumPlanes[1].d=e[15]-e[12],this.frustumPlanes[2].normal[0]=e[3]+e[1],this.frustumPlanes[2].normal[1]=e[7]+e[5],this.frustumPlanes[2].normal[2]=e[11]+e[9],this.frustumPlanes[2].d=e[15]+e[13],this.frustumPlanes[3].normal[0]=e[3]-e[1],this.frustumPlanes[3].normal[1]=e[7]-e[5],this.frustumPlanes[3].normal[2]=e[11]-e[9],this.frustumPlanes[3].d=e[15]-e[13],this.frustumPlanes[4].normal[0]=e[3]+e[2],this.frustumPlanes[4].normal[1]=e[7]+e[6],this.frustumPlanes[4].normal[2]=e[11]+e[10],this.frustumPlanes[4].d=e[15]+e[14],this.frustumPlanes[5].normal[0]=e[3]-e[2],this.frustumPlanes[5].normal[1]=e[7]-e[6],this.frustumPlanes[5].normal[2]=e[11]-e[10],this.frustumPlanes[5].d=e[15]-e[14];for(const t of this.frustumPlanes)t.normalize()}};on.UP_VECTOR=D.fromValues(0,1,0);let ds=on;class Hn extends ds{constructor(e,t,r,n){super(),this.fieldOfView=e,this.aspect=t,this.fieldOfView=e*Math.PI/180,this.aspect=t,this.near=r,this.far=n,this.updateProjectionMatrix()}onResize(e,t){super.onResize(e,t),this.aspect=e/t,this.updateProjectionMatrix()}updateProjectionMatrix(){return $.perspective(this.fieldOfView,this.aspect,this.near,this.far,this.projectionMatrix),super.updateProjectionMatrix(),this.updateProjectionViewMatrix(),this}}var V=(s=>(s[s.Deferred=0]="Deferred",s[s.DirectionalAmbientLighting=1]="DirectionalAmbientLighting",s[s.PointLightsNonCulledLighting=2]="PointLightsNonCulledLighting",s[s.PointLightsStencilMask=3]="PointLightsStencilMask",s[s.PointLightsLighting=4]="PointLightsLighting",s[s.SSAO=5]="SSAO",s[s.SSAOBlur=6]="SSAOBlur",s[s.Skybox=7]="Skybox",s[s.Transparent=8]="Transparent",s[s.Shadow=9]="Shadow",s[s.MomentsShadow=10]="MomentsShadow",s[s.BlurMomentsShadow=11]="BlurMomentsShadow",s[s.EnvironmentCube=12]="EnvironmentCube",s[s.TAAResolve=13]="TAAResolve",s[s.CopyDepthForHiZ=14]="CopyDepthForHiZ",s[s.HiZ=15]="HiZ",s[s.Reflection=16]="Reflection",s[s.BloomDownsample=17]="BloomDownsample",s[s.BloomUpsample=18]="BloomUpsample",s[s.DebugBounds=19]="DebugBounds",s[s.Blit=20]="Blit",s))(V||{}),se=(s=>(s[s.CPUTotal=0]="CPUTotal",s[s.GPUTotal=1]="GPUTotal",s[s.FPS=2]="FPS",s[s.VRAM=3]="VRAM",s[s.VisibleMeshes=4]="VisibleMeshes",s[s.LightsCount=5]="LightsCount",s[s.DeferredRenderPass=6]="DeferredRenderPass",s[s.DirectionalAmbientLightingRenderPass=7]="DirectionalAmbientLightingRenderPass",s[s.PointLightsStencilMask=8]="PointLightsStencilMask",s[s.PointLightsLighting=9]="PointLightsLighting",s[s.SSAORenderPass=10]="SSAORenderPass",s[s.TransparentRenderPass=11]="TransparentRenderPass",s[s.ShadowRenderPass=12]="ShadowRenderPass",s[s.TAAResolveRenderPass=13]="TAAResolveRenderPass",s[s.ReflectionRenderPass=14]="ReflectionRenderPass",s[s.BlitRenderPass=15]="BlitRenderPass",s))(se||{}),It=(s=>(s[s.Directional=0]="Directional",s[s.Point=1]="Point",s[s.Ambient=2]="Ambient",s))(It||{});const Bd=new Map([[It.Directional,0],[It.Point,1],[It.Ambient,2]]);V.Deferred,V.DirectionalAmbientLighting,V.SSAO,V.Transparent,V.Shadow,V.TAAResolve,V.Reflection,V.Blit;const Ad=[se.CPUTotal,se.GPUTotal,se.FPS,se.VRAM,se.VisibleMeshes,se.LightsCount],Sr=new Map([[V.Deferred,"G-Buffer Render Pass"],[V.DirectionalAmbientLighting,"Directional + Ambient Render Pass"],[V.PointLightsStencilMask,"Point Lights Stencil Mask Pass"],[V.PointLightsLighting,"Point Lights LightingSystem"],[V.SSAO,"SSAO Render Pass"],[V.SSAOBlur,"SSAO Blur Render Pass"],[V.Skybox,"Skybox Render Pass"],[V.Transparent,"Transparent Render Pass"],[V.Shadow,"Shadow Render Pass"],[V.EnvironmentCube,"Environment Cube Pass"],[V.TAAResolve,"TAA Resolve Render Pass"],[V.CopyDepthForHiZ,"Copy Depth for Hi-Z Render Pass"],[V.HiZ,"Hi-Z Depth Render Pass"],[V.Reflection,"SSR Render Pass"],[V.DebugBounds,"Debug Bounds Render Pass"],[V.Blit,"Blit Render Pass"]]);class vd{constructor(){this.passes=[],this.textureCache=new Map}destroy(){for(const e of this.passes)e.destroy();this.textureCache.clear()}setScene(e){this.scene=e}addPass(e){if(!this.passes.some(({type:t})=>t===e.type))return this.passes.push(e),this;{const t=Sr.get(e.type);console.warn(`RenderPass ${t} has already been added`)}}removePass(e){this.passes=this.passes.filter(({type:t})=>t!==e)}getPass(e){return this.passes.find(({type:t})=>t===e)}setTexture(e,t){this.textureCache.set(e,t)}getTexture(e){return this.textureCache.get(e)}async render(e){for(const t of this.passes){if(!t.enabled)continue;const r=t.inputTextureNames.map(i=>this.textureCache.get(i)),n=t.render(e,this.scene,r);t.outputTextureNames.forEach((i,o)=>{this.textureCache.set(i,n[o])})}}onFrameEnd(){for(const e of this.passes)e.onFrameEnd()}}class jn{constructor(){this.c0=0,this.c1=0,this.c2=0,this.c3=0}set(e,t,r,n){this.c0=e,this.c1=r,this.c2=-3*e+3*t-2*r-n,this.c3=2*e-2*t+r+n}initCatmullRom(e,t,r,n,i){this.set(t,r,i*(r-e),i*(n-t))}initNonuniformCatmullRom(e,t,r,n,i,o,c){let d=(t-e)/i-(r-e)/(i+o)+(r-t)/o,g=(r-t)/o-(n-t)/(o+c)+(n-r)/c;d*=o,g*=o,this.set(t,r,d,g)}calc(e){const t=e*e,r=t*e;return this.c0+this.c1*e+this.c2*t+this.c3*r}}const ba=new jn,xa=new jn,_a=new jn,bt=D.create();class wd{constructor(e=[],t=!1,r=.5){this.points=e,this.closed=t,this.tension=r}getPoint(e,t=D.create()){const r=t,n=this.points.length,i=(n-(this.closed?0:1))*e;let o,c,d=Math.floor(i),g=i-d;this.closed?d+=d>0?0:(Math.floor(Math.abs(d)/n)+1)*n:g===0&&d===n-1&&(d=n-2,g=1),this.closed||d>0?o=this.points[(d-1)%n]:(D.sub(this.points[0],this.points[1],bt),D.add(bt,this.points[0],bt),o=bt);const b=this.points[d%n],l=this.points[(d+1)%n];this.closed||d+2<n?c=this.points[(d+2)%n]:(D.sub(this.points[n-1],this.points[n-2],bt),D.add(bt,this.points[n-1],bt),c=bt);const x=.25;let m=Math.pow(D.distSq(o,b),x),_=Math.pow(D.distSq(b,l),x),w=Math.pow(D.distSq(l,c),x);return _<1e-4&&(_=1),m<1e-4&&(m=_),w<1e-4&&(w=_),ba.initNonuniformCatmullRom(o[0],b[0],l[0],c[0],m,_,w),xa.initNonuniformCatmullRom(o[1],b[1],l[1],c[1],m,_,w),_a.initNonuniformCatmullRom(o[2],b[2],l[2],c[2],m,_,w),D.set(ba.calc(g),xa.calc(g),_a.calc(g),r),r}getPoints(e=5){const t=[];for(let r=0;r<e;r++)t.push(this.getPoint(r/e));return t}}class hs{constructor(e=200){this.numSamples=e,this.total=0,this.samples=[],this.cursor=0}addSample(e){this.total+=e-(this.samples[this.cursor]||0),this.samples[this.cursor]=e,this.cursor=(this.cursor+1)%this.numSamples}get(){return this.total/this.samples.length}}async function Ba(s,e,t,r){return r._parse(s,e,t,r)}function ct(s,e){if(!s)throw new Error(e||"loader assertion failed.")}const fs=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),Aa=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Aa&&parseFloat(Aa[1]);const ps=globalThis,ir=globalThis.process||{};function Jn(){return!(typeof process=="object"&&String(process)==="[object process]"&&!(process!=null&&process.browser))||function(){var e,t;if(typeof window<"u"&&((e=window.process)==null?void 0:e.type)==="renderer"||typeof process<"u"&&((t=process.versions)!=null&&t.electron))return!0;const s=typeof navigator<"u"&&navigator.userAgent;return!!(s&&s.indexOf("Electron")>=0)}()}const va="4.0.7";class Cd{constructor(e,t,r="sessionStorage"){this.storage=function(n){try{const i=window[n],o="__storage_test__";return i.setItem(o,o),i.removeItem(o),i}catch{return null}}(r),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}var ms;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(ms||(ms={}));function wa(s){return typeof s!="string"?s:(s=s.toUpperCase(),ms[s]||ms.WHITE)}function zn(s,e){if(!s)throw new Error("Assertion failed")}function or(){var e,t,r;let s;if(Jn()&&ps.performance)s=(t=(e=ps==null?void 0:ps.performance)==null?void 0:e.now)==null?void 0:t.call(e);else if("hrtime"in ir){const n=(r=ir==null?void 0:ir.hrtime)==null?void 0:r.call(ir);s=1e3*n[0]+n[1]/1e6}else s=Date.now();return s}const ar={debug:Jn()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Td={enabled:!0,level:0};function ur(){}const Ca={},Ta={once:!0};class Kn{constructor({id:e}={id:""}){this.VERSION=va,this._startTs=or(),this._deltaTs=or(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new Cd(`__probe-${this.id}__`,Td),this.timeStamp(`${this.id} started`),function(t,r=["constructor"]){const n=Object.getPrototypeOf(t),i=Object.getOwnPropertyNames(n),o=t;for(const c of i){const d=o[c];typeof d=="function"&&(r.find(g=>c===g)||(o[c]=d.bind(t)))}}(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((or()-this._startTs).toPrecision(10))}getDelta(){return Number((or()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,ar.warn,arguments,Ta)}error(e){return this._getLogFunction(0,e,ar.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,ar.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,ar.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,ar.debug||ar.info,arguments,Ta)}table(e,t,r){return t?this._getLogFunction(e,t,console.table||ur,r&&[r],{tag:Sd(t)}):ur}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||ur)}group(e,t,r={collapsed:!1}){const n=Ea({logLevel:e,message:t,opts:r}),{collapsed:i}=r;return n.method=(i?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t,r={}){return this.group(e,t,Object.assign({},r,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||ur)}withGroup(e,t,r){this.group(e,t)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Sa(e)}_getLogFunction(e,t,r,n,i){if(this._shouldLog(e)){i=Ea({logLevel:e,message:t,args:n,opts:i}),zn(r=r||i.method),i.total=this.getTotal(),i.delta=this.getDelta(),this._deltaTs=or();const o=i.tag||i.message;if(i.once&&o){if(Ca[o])return ur;Ca[o]=or()}return t=function(c,d,g){if(typeof d=="string"){const b=g.time?function(l,x=8){const m=Math.max(x-l.length,0);return`${" ".repeat(m)}${l}`}(function(l){let x;return x=l<10?`${l.toFixed(2)}ms`:l<100?`${l.toFixed(1)}ms`:l<1e3?`${l.toFixed(0)}ms`:`${(l/1e3).toFixed(2)}s`,x}(g.total)):"";d=function(l,x,m){return Jn||typeof l!="string"||(x&&(l=`\x1B[${wa(x)}m${l}\x1B[39m`),m&&(l=`\x1B[${wa(m)+10}m${l}\x1B[49m`)),l}(d=g.time?`${c}: ${b}  ${d}`:`${c}: ${d}`,g.color,g.background)}return d}(this.id,i.message,i),r.bind(console,t,...i.args)}return ur}}function Sa(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return zn(Number.isFinite(e)&&e>=0),e}function Ea(s){const{logLevel:e,message:t}=s;s.logLevel=Sa(e);const r=s.args?Array.from(s.args):[];for(;r.length&&r.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&r.unshift(t),s.message=e;break;case"object":Object.assign(s,e)}typeof s.message=="function"&&(s.message=s.message());const n=typeof s.message;return zn(n==="string"||n==="object"),Object.assign(s,{args:r},s.opts)}function Sd(s){for(const e in s)for(const t in s[e])return t||"untitled";return"empty"}Kn.VERSION=va;const Xn="4.3.2",Ed=Xn[0]>="0"&&Xn[0]<="9"?`v${Xn}`:"",Md=function(){const s=new Kn({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=s,globalThis.loaders.version=Ed,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=s,s}();function Pd(s,e){return Ma(s||{},e)}function Ma(s,e,t=0){if(t>3)return e;const r={...s};for(const[n,i]of Object.entries(e))i&&typeof i=="object"&&!Array.isArray(i)?r[n]=Ma(r[n]||{},e[n],t+1):r[n]=e[n];return r}const Gd=((Yc=globalThis._loadersgl_)!=null&&Yc.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version);function lt(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}const Ne=typeof process!="object"||String(process)!=="[object process]"||process.browser,Wn=typeof importScripts=="function",Rd=typeof window<"u"&&window.orientation!==void 0,Pa=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);Pa&&parseFloat(Pa[1]);class Ld{constructor(e,t){ee(this,"name");ee(this,"workerThread");ee(this,"isRunning",!0);ee(this,"result");ee(this,"_resolve",()=>{});ee(this,"_reject",()=>{});this.name=e,this.workerThread=t,this.result=new Promise((r,n)=>{this._resolve=r,this._reject=n})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){lt(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){lt(this.isRunning),this.isRunning=!1,this._reject(e)}}class Yn{terminate(){}}const qn=new Map;function Od(s){lt(s.source&&!s.url||!s.source&&s.url);let e=qn.get(s.source||s.url);return e||(s.url&&(e=function(t){if(!t.startsWith("http"))return t;return Ga((r=t,`try {
  importScripts('${r}');
} catch (error) {
  console.error(error);
  throw error;
}`));var r}(s.url),qn.set(s.url,e)),s.source&&(e=Ga(s.source),qn.set(s.source,e))),lt(e),e}function Ga(s){const e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function Ra(s,e=!0,t){const r=t||new Set;if(s){if(La(s))r.add(s);else if(La(s.buffer))r.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(const n in s)Ra(s[n],e,r)}}return t===void 0?Array.from(r):[]}function La(s){return!!s&&(s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas)}const Qn=()=>{};class $n{constructor(e){ee(this,"name");ee(this,"source");ee(this,"url");ee(this,"terminated",!1);ee(this,"worker");ee(this,"onMessage");ee(this,"onError");ee(this,"_loadableURL","");const{name:t,source:r,url:n}=e;lt(r||n),this.name=t,this.source=r,this.url=n,this.onMessage=Qn,this.onError=i=>console.log(i),this.worker=Ne?this._createBrowserWorker():this._createNodeWorker()}static isSupported(){return typeof Worker<"u"&&Ne||Yn!==void 0&&!Ne}destroy(){this.onMessage=Qn,this.onError=Qn,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||Ra(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=Od({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const t=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Yn(t,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new Yn(this.source,{eval:!0})}return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class Id{constructor(e){ee(this,"name","unnamed");ee(this,"source");ee(this,"url");ee(this,"maxConcurrency",1);ee(this,"maxMobileConcurrency",1);ee(this,"onDebug",()=>{});ee(this,"reuseWorkers",!0);ee(this,"props",{});ee(this,"jobQueue",[]);ee(this,"idleQueue",[]);ee(this,"count",0);ee(this,"isDestroyed",!1);this.source=e.source,this.url=e.url,this.setProps(e)}static isSupported(){return $n.isSupported()}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(n,i,o)=>n.done(o),r=(n,i)=>n.error(i)){const n=new Promise(i=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:i}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new Ld(t.name,e);e.onMessage=n=>t.onMessage(r,n.type,n.payload),e.onError=n=>t.onError(r,n),t.onStart(r);try{await r.result}catch(n){console.error(`Worker exception: ${n}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Ne||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new $n({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Rd?this.maxMobileConcurrency:this.maxConcurrency}}const Fd={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},wt=class wt{constructor(e){ee(this,"props");ee(this,"workerPools",new Map);this.props={...Fd},this.setProps(e),this.workerPools=new Map}static isSupported(){return $n.isSupported()}static getWorkerFarm(e={}){return wt._workerFarm=wt._workerFarm||new wt({}),wt._workerFarm.setProps(e),wt._workerFarm}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:n}=e;let i=this.workerPools.get(t);return i||(i=new Id({name:t,source:r,url:n}),i.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,i)),i}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};ee(wt,"_workerFarm");let gs=wt;const Zn={};async function Ft(s,e=null,t={},r=null){return e&&(s=function(n,i,o={},c=null){if(!o.useLocalLibraries&&n.startsWith("http"))return n;c=c||n;const d=o.modules||{};return d[c]?d[c]:Ne?o.CDN?(lt(o.CDN.startsWith("http")),`${o.CDN}/${i}@${Gd}/dist/libs/${c}`):Wn?`../src/libs/${c}`:`modules/${i}/src/libs/${c}`:`modules/${i}/dist/libs/${c}`}(s,e,t,r)),Zn[s]=Zn[s]||async function(n){if(n.endsWith("wasm"))return await async function(o){const{readFileAsArrayBuffer:c}=globalThis.loaders||{};return Ne||!c||o.startsWith("http")?await(await fetch(o)).arrayBuffer():await c(o)}(n);if(!Ne)try{const{requireFromFile:o}=globalThis.loaders||{};return await(o==null?void 0:o(n))}catch(o){return console.error(o),null}if(Wn)return importScripts(n);const i=await async function(o){const{readFileAsText:c}=globalThis.loaders||{};return Ne||!c||o.startsWith("http")?await(await fetch(o)).text():await c(o)}(n);return function(o,c){if(!Ne){const{requireFromString:g}=globalThis.loaders||{};return g==null?void 0:g(o,c)}if(Wn)return eval.call(globalThis,o),null;const d=document.createElement("script");d.id=c;try{d.appendChild(document.createTextNode(o))}catch{d.text=o}return document.body.appendChild(d),null}(i,n)}(s),await Zn[s]}async function Dd(s,e,t,r,n){const i=s.id,o=function(b,l={}){const x=l[b.id]||{},m=Ne?`${b.id}-worker.js`:`${b.id}-worker-node.js`;let _=x.workerUrl;if(_||b.id!=="compression"||(_=l.workerUrl),l._workerType==="test"&&(_=Ne?`modules/${b.module}/dist/${m}`:`modules/${b.module}/src/workers/${b.id}-worker-node.ts`),!_){let w=b.version;w==="latest"&&(w="latest");const f=w?`@${w}`:"";_=`https://unpkg.com/@loaders.gl/${b.module}${f}/dist/${m}`}return lt(_),_}(s,t),c=gs.getWorkerFarm(t).getWorkerPool({name:i,url:o});t=JSON.parse(JSON.stringify(t)),r=JSON.parse(JSON.stringify(r||{}));const d=await c.startJob("process-on-worker",Ud.bind(null,n));return d.postMessage("process",{input:e,options:t,context:r}),await(await d.result).result}async function Ud(s,e,t,r){switch(t){case"done":e.done(r);break;case"error":e.error(new Error(r.error));break;case"process":const{id:n,input:i,options:o}=r;try{const c=await s(i,o);e.postMessage("done",{id:n,result:c})}catch(c){const d=c instanceof Error?c.message:"unknown error";e.postMessage("error",{id:n,error:d})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function Oa(s,e,t){if(s.byteLength<=e+t)return"";const r=new DataView(s);let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(r.getUint8(e+i));return n}function kd(s){try{return JSON.parse(s)}catch{throw new Error(`Failed to parse JSON from data starting with "${function(t,r=5){return typeof t=="string"?t.slice(0,r):ArrayBuffer.isView(t)?Oa(t.buffer,t.byteOffset,r):t instanceof ArrayBuffer?Oa(t,0,r):""}(s)}"`)}}function Nd(...s){return function(e){const t=e.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),r=t.reduce((o,c)=>o+c.byteLength,0),n=new Uint8Array(r);let i=0;for(const o of t)n.set(o,i),i+=o.byteLength;return n.buffer}(s)}function Ia(s,e,t){const r=t!==void 0?new Uint8Array(s).subarray(e,e+t):new Uint8Array(s).subarray(e);return new Uint8Array(r).buffer}function Er(s,e){return ct(s>=0),ct(e>0),s+(e-1)&~(e-1)}function Vd(s,e,t){let r;if(s instanceof ArrayBuffer)r=new Uint8Array(s);else{const n=s.byteOffset,i=s.byteLength;r=new Uint8Array(s.buffer||s.arrayBuffer,n,i)}return e.set(r,t),t+Er(r.byteLength,4)}const Fa={};function Da(s){if((e=s)&&typeof e=="object"&&e.isBuffer)return s;var e;if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){const t=s;return new TextEncoder().encode(t).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function Ua(s){const e=s?s.lastIndexOf("/"):-1;return e>=0?s.substr(e+1):""}const Mr=s=>typeof s=="function",Pr=s=>s!==null&&typeof s=="object",ka=s=>Pr(s)&&s.constructor==={}.constructor,Dt=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json,Ut=s=>typeof Blob<"u"&&s instanceof Blob,Na=s=>(e=>typeof ReadableStream<"u"&&e instanceof ReadableStream||Pr(e)&&Mr(e.tee)&&Mr(e.cancel)&&Mr(e.getReader))(s)||(e=>Pr(e)&&Mr(e.read)&&Mr(e.pipe)&&(t=>typeof t=="boolean")(e.readable))(s);class Hd extends Error{constructor(t,r){super(t);ee(this,"reason");ee(this,"url");ee(this,"response");this.reason=r.reason,this.url=r.url,this.response=r.response}}const jd=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Jd=/^([-\w.]+\/[-\w.+]+)/;function Va(s,e){return s.toLowerCase()===e.toLowerCase()}function Ha(s){const e=jd.exec(s);return e?e[1]:""}const ja=/\?.*/;function ei(s){return s.replace(ja,"")}function ys(s){return Dt(s)?s.url:Ut(s)?s.name||"":typeof s=="string"?s:""}function ti(s){if(Dt(s)){const e=s,t=e.headers.get("content-type")||"",r=ei(e.url);return function(n){const i=Jd.exec(n);return i?i[1]:n}(t)||Ha(r)}return Ut(s)?s.type||"":typeof s=="string"?Ha(s):""}async function Ja(s){if(Dt(s))return s;const e={},t=function(c){return Dt(c)?c.headers["content-length"]||-1:Ut(c)?c.size:typeof c=="string"?c.length:c instanceof ArrayBuffer||ArrayBuffer.isView(c)?c.byteLength:-1}(s);t>=0&&(e["content-length"]=String(t));const r=ys(s),n=ti(s);n&&(e["content-type"]=n);const i=await async function(c){if(typeof c=="string")return`data:,${c.slice(0,5)}`;if(c instanceof Blob){const g=c.slice(0,5);return await new Promise(b=>{const l=new FileReader;l.onload=x=>{var m;return b((m=x==null?void 0:x.target)==null?void 0:m.result)},l.readAsDataURL(g)})}return c instanceof ArrayBuffer?`data:base64,${function(g){let b="";const l=new Uint8Array(g);for(let x=0;x<l.byteLength;x++)b+=String.fromCharCode(l[x]);return btoa(b)}(c.slice(0,5))}`:null}(s);i&&(e["x-first-bytes"]=i),typeof s=="string"&&(s=new TextEncoder().encode(s));const o=new Response(s,{headers:e});return Object.defineProperty(o,"url",{value:r}),o}async function zd(s){if(!s.ok)throw await async function(t){const r=function(o){if(o.length<50)return o;const c=o.slice(o.length-15);return`${o.substr(0,32)}...${c}`}(t.url);let n=`Failed to fetch resource (${t.status}) ${t.statusText}: ${r}`;n=n.length>100?`${n.slice(0,100)}...`:n;const i={reason:t.statusText,url:t.url,response:t};try{const o=t.headers.get("Content-Type");i.reason=!t.bodyUsed&&(o!=null&&o.includes("application/json"))?await t.json():await t.text()}catch{}return new Hd(n,i)}(s)}async function za(s,e){var t,r;if(typeof s=="string"){const n=function(i){for(const o in Fa)if(i.startsWith(o)){const c=Fa[o];i=i.replace(o,c)}return i.startsWith("http://")||i.startsWith("https://")||(i=`${i}`),i}(s);return function(i){return!function(o){return o.startsWith("http:")||o.startsWith("https:")}(i)&&!function(o){return o.startsWith("data:")}(i)}(n)&&((t=globalThis.loaders)!=null&&t.fetchNode)?(r=globalThis.loaders)==null?void 0:r.fetchNode(n,e):await fetch(n,e)}return await Ja(s)}const Ka=new Kn({id:"loaders.gl"});class Kd{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const Xa={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){ee(this,"console");this.console=console}log(...s){return this.console.log.bind(this.console,...s)}info(...s){return this.console.info.bind(this.console,...s)}warn(...s){return this.console.warn.bind(this.console,...s)}error(...s){return this.console.error.bind(this.console,...s)}},useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:fs,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},Xd={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Wa(){globalThis.loaders=globalThis.loaders||{};const{loaders:s}=globalThis;return s._state||(s._state={}),s._state}function Ya(){const s=Wa();return s.globalOptions=s.globalOptions||{...Xa},s.globalOptions}function Wd(s,e,t,r){return t=t||[],function(n,i){qa(n,null,Xa,Xd,i);for(const o of i){const c=n&&n[o.id]||{},d=o.options&&o.options[o.id]||{},g=o.deprecatedOptions&&o.deprecatedOptions[o.id]||{};qa(c,o.id,d,g,i)}}(s,t=Array.isArray(t)?t:[t]),function(n,i,o){const c=n.options||{},d={...c};return function(g,b){b&&!("baseUri"in g)&&(g.baseUri=b)}(d,o),d.log===null&&(d.log=new Kd),Qa(d,Ya()),Qa(d,i),d}(e,s,r)}function qa(s,e,t,r,n){const i=e||"Top level",o=e?`${e}.`:"";for(const c in s){const d=!e&&Pr(s[c]);if(!(c in t)&&!(c==="baseUri"&&!e)&&!(c==="workerUrl"&&e)){if(c in r)Ka.warn(`${i} loader option '${o}${c}' no longer supported, use '${r[c]}'`)();else if(!d){const g=Yd(c,n);Ka.warn(`${i} loader option '${o}${c}' not recognized. ${g}`)()}}}}function Yd(s,e){const t=s.toLowerCase();let r="";for(const n of e)for(const i in n.options){if(s===i)return`Did you mean '${n.id}.${i}'?`;const o=i.toLowerCase();(t.startsWith(o)||o.startsWith(t))&&(r=r||`Did you mean '${n.id}.${i}'?`)}return r}function Qa(s,e){for(const t in e)if(t in e){const r=e[t];ka(r)&&ka(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function ri(s){return s?(Array.isArray(s)&&(s=s[0]),Array.isArray(s==null?void 0:s.extensions)):!1}function $a(s){let e;return ct(s,"null loader"),ct(ri(s),"invalid loader"),Array.isArray(s)&&(e=s[1],s=s[0],s={...s,options:{...s.options,...e}}),(s!=null&&s.parseTextSync||s!=null&&s.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}function qd(){return(()=>{const s=Wa();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry})()}const Qd=/\.([^.]+)$/;function Za(s,e=[],t,r){if(!eu(s))return null;if(e&&!Array.isArray(e))return $a(e);let n=[];e&&(n=n.concat(e)),t!=null&&t.ignoreRegisteredLoaders||n.push(...qd()),function(o){for(const c of o)$a(c)}(n);const i=function(o,c,d,g){const b=ys(o),l=ti(o),x=ei(b)||(g==null?void 0:g.url);let m=null,_="";return d!=null&&d.mimeType&&(m=si(c,d==null?void 0:d.mimeType),_=`match forced by supplied MIME type ${d==null?void 0:d.mimeType}`),m=m||function(w,f){const p=f&&Qd.exec(f),a=p&&p[1];return a?function(u,h){h=h.toLowerCase();for(const y of u)for(const B of y.extensions)if(B.toLowerCase()===h)return y;return null}(w,a):null}(c,x),_=_||(m?`matched url ${x}`:""),m=m||si(c,l),_=_||(m?`matched MIME type ${l}`:""),m=m||function(w,f){if(!f)return null;for(const p of w)if(typeof f=="string"){if($d(f,p))return p}else if(ArrayBuffer.isView(f)){if(ru(f.buffer,f.byteOffset,p))return p}else if(f instanceof ArrayBuffer&&ru(f,0,p))return p;return null}(c,o),_=_||(m?`matched initial data ${su(o)}`:""),d!=null&&d.fallbackMimeType&&(m=m||si(c,d==null?void 0:d.fallbackMimeType),_=_||(m?`matched fallback MIME type ${l}`:"")),_&&Md.log(1,`selectLoader selected ${m==null?void 0:m.name}: ${_}.`),m}(s,n,t,r);if(!i&&!(t!=null&&t.nothrow))throw new Error(tu(s));return i}function eu(s){return!(s instanceof Response&&s.status===204)}function tu(s){const e=ys(s),t=ti(s);let r="No valid loader found (";r+=e?`${Ua(e)}, `:"no url provided, ",r+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const n=s?su(s):"";return r+=n?` first bytes: "${n}"`:"first bytes: not available",r+=")",r}function si(s,e){var t;for(const r of s)if((t=r.mimeTypes)!=null&&t.some(n=>Va(e,n))||Va(e,`application/x.${r.id}`))return r;return null}function $d(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(t=>s.startsWith(t))}function ru(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(r=>function(n,i,o,c){if(c instanceof ArrayBuffer)return function(d,g,b){if(b=b||d.byteLength,d.byteLength<b||g.byteLength<b)return!1;const l=new Uint8Array(d),x=new Uint8Array(g);for(let m=0;m<l.length;++m)if(l[m]!==x[m])return!1;return!0}(c,n,c.byteLength);switch(typeof c){case"function":return c(n);case"string":return c===ni(n,i,c.length);default:return!1}}(s,e,0,r))}function su(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?ni(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?ni(s,0,e):""}function ni(s,e,t){if(s.byteLength<e+t)return"";const r=new DataView(s);let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(r.getUint8(e+i));return n}const Zd=262144;function nu(s,e){return fs?async function*(t,r){const n=t.getReader();let i;try{for(;;){const o=i||n.read();r!=null&&r._streamReadAhead&&(i=n.read());const{done:c,value:d}=await o;if(c)return;yield Da(d)}}catch{n.releaseLock()}}(s,e):async function*(t){for await(const r of t)yield Da(r)}(s)}function eh(s,e){if(typeof s=="string")return function*(t,r){const n=(r==null?void 0:r.chunkSize)||262144;let i=0;const o=new TextEncoder;for(;i<t.length;){const c=Math.min(t.length-i,n),d=t.slice(i,i+c);i+=c,yield o.encode(d)}}(s,e);if(s instanceof ArrayBuffer)return function*(t,r={}){const{chunkSize:n=Zd}=r;let i=0;for(;i<t.byteLength;){const o=Math.min(t.byteLength-i,n),c=new ArrayBuffer(o),d=new Uint8Array(t,i,o);new Uint8Array(c).set(d),i+=o,yield c}}(s,e);if(Ut(s))return async function*(t,r){const n=(r==null?void 0:r.chunkSize)||1048576;let i=0;for(;i<t.size;){const o=i+n,c=await t.slice(i,o).arrayBuffer();i=o,yield c}}(s,e);if(Na(s))return nu(s,e);if(Dt(s))return nu(s.body,e);throw new Error("makeIterator")}const iu="Cannot convert supplied data type";async function th(s,e,t){const r=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||r)return function(i,o){if(o.text&&typeof i=="string")return i;var c;if((c=i)&&typeof c=="object"&&c.isBuffer&&(i=i.buffer),i instanceof ArrayBuffer){const d=i;return o.text&&!o.binary?new TextDecoder("utf8").decode(d):d}if(ArrayBuffer.isView(i)){if(o.text&&!o.binary)return new TextDecoder("utf8").decode(i);let d=i.buffer;const g=i.byteLength||i.length;return i.byteOffset===0&&g===d.byteLength||(d=d.slice(i.byteOffset,i.byteOffset+g)),d}throw new Error(iu)}(s,e);if(Ut(s)&&(s=await Ja(s)),Dt(s)){const i=s;return await zd(i),e.binary?await i.arrayBuffer():await i.text()}if(Na(s)&&(s=eh(s,t)),n=s,!!n&&typeof n[Symbol.iterator]=="function"||(i=>i&&typeof i[Symbol.asyncIterator]=="function")(s))return async function(i){const o=[];for await(const c of i)o.push(c);return Nd(...o)}(s);var n;throw new Error(iu)}function ou(s,e){const t=Ya(),r=s||t;return typeof r.fetch=="function"?r.fetch:Pr(r.fetch)?n=>za(n,r.fetch):e!=null&&e.fetch?e==null?void 0:e.fetch:za}function rh(s,e,t){if(t)return t;const r={fetch:ou(e,s),...s};if(r.url){const n=ei(r.url);r.baseUrl=n,r.queryString=function(i){const o=i.match(ja);return o&&o[0]}(r.url),r.filename=Ua(n),r.baseUrl=function(i){const o=i?i.lastIndexOf("/"):-1;return o>=0?i.substr(0,o):""}(n)}return Array.isArray(r.loaders)||(r.loaders=null),r}async function ii(s,e,t,r){!e||Array.isArray(e)||ri(e)||(r=void 0,t=e,e=void 0),t=t||{};const n=ys(s=await s),i=function(c,d){if(c&&!Array.isArray(c))return c;let g;if(c&&(g=Array.isArray(c)?c:[c]),d&&d.loaders){const b=Array.isArray(d.loaders)?d.loaders:[d.loaders];g=g?[...g,...b]:b}return g&&g.length?g:void 0}(e,r),o=await async function(c,d=[],g,b){if(!eu(c))return null;let l=Za(c,d,{...g,nothrow:!0},b);if(l)return l;if(Ut(c)&&(l=Za(c=await c.slice(0,10).arrayBuffer(),d,g,b)),!l&&!(g!=null&&g.nothrow))throw new Error(tu(c));return l}(s,i,t);return o?(r=rh({url:n,_parse:ii,loaders:i},t=Wd(t,o,i,n),r||null),await async function(c,d,g,b){if(function(x){lt(x,"no worker provided");const m=x.version}(c),g=Pd(c.options,g),Dt(d)){const x=d,{ok:m,redirected:_,status:w,statusText:f,type:p,url:a}=x,u=Object.fromEntries(x.headers.entries());b.response={headers:u,ok:m,redirected:_,status:w,statusText:f,type:p,url:a}}d=await th(d,c,g);const l=c;if(l.parseTextSync&&typeof d=="string")return l.parseTextSync(d,g,b);if(function(x,m){return!!gs.isSupported()&&!(!Ne&&!(m!=null&&m._nodeWorkers))&&x.worker&&(m==null?void 0:m.worker)}(c,g))return await Dd(c,d,g,b,ii);if(l.parseText&&typeof d=="string")return await l.parseText(d,g,b);if(l.parse)return await l.parse(d,g,b);throw lt(!l.parseSync),new Error(`${c.id} loader - no parser found and worker is disabled`)}(o,s,t,r)):null}function sh(s,e,t){const r=function(i){switch(i.constructor){case Int8Array:return"int8";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int16Array:return"int16";case Uint16Array:return"uint16";case Int32Array:return"int32";case Uint32Array:return"uint32";case Float32Array:return"float32";case Float64Array:return"float64";default:return"null"}}(e.value),n=t||function(i){const o={};return"byteOffset"in i&&(o.byteOffset=i.byteOffset.toString(10)),"byteStride"in i&&(o.byteStride=i.byteStride.toString(10)),"normalized"in i&&(o.normalized=i.normalized.toString()),o}(e);return{name:s,type:{type:"fixed-size-list",listSize:e.size,children:[{name:"value",type:r}]},nullable:!1,metadata:n}}const nh=(qc=globalThis.loaders)==null?void 0:qc.parseImageNode,oi=typeof Image<"u",ai=typeof ImageBitmap<"u",ih=!!nh,ui=!!fs||ih;function oh(s){const e=function(t){return typeof ImageBitmap<"u"&&t instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&t instanceof Image?"image":t&&typeof t=="object"&&t.data&&t.width&&t.height?"data":null}(s);if(!e)throw new Error("Not an image");return e}function au(s){switch(oh(s)){case"data":return s;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}const ah=/^data:image\/svg\+xml/,uh=/\.svg((\?|#).*)?$/;function ci(s){return s&&(ah.test(s)||uh.test(s))}function uu(s,e){if(ci(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function cu(s,e,t){const r=function(o,c){if(ci(c)){let d=new TextDecoder().decode(o);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(d=unescape(encodeURIComponent(d)))}catch(g){throw new Error(g.message)}return`data:image/svg+xml;base64,${btoa(d)}`}return uu(o,c)}(s,t),n=self.URL||self.webkitURL,i=typeof r!="string"&&n.createObjectURL(r);try{return await async function(o,c){const d=new Image;return d.src=o,c.image&&c.image.decode&&d.decode?(await d.decode(),d):await new Promise((g,b)=>{try{d.onload=()=>g(d),d.onerror=l=>{const x=l instanceof Error?l.message:"error";b(new Error(x))}}catch(l){b(l)}})}(i||r,e)}finally{i&&n.revokeObjectURL(i)}}const ch={};let lu=!0;async function lh(s,e,t){let r;ci(t)?r=await cu(s,e,t):r=uu(s,t);const n=e&&e.imagebitmap;return await async function(i,o=null){if(!function(c){for(const d in c||ch)return!1;return!0}(o)&&lu||(o=null),o)try{return await createImageBitmap(i,o)}catch(c){console.warn(c),lu=!1}return await createImageBitmap(i)}(r,n)}function dh(s){return function(e,t,r=0){const n=(i=t,[...i].map(o=>o.charCodeAt(0)));var i;for(let o=0;o<n.length;++o)if(n[o]!==e[o+r])return!1;return!0}(s,"ftyp",4)&&96&s[8]?function(e){switch((t=e,r=8,n=12,String.fromCharCode(...t.slice(r,n))).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}var t,r,n}(s):null}const et=!1,Gr=!0;function li(s){const e=Rr(s);return function(t){const r=Rr(t);return r.byteLength>=24&&r.getUint32(0,et)===2303741511?{mimeType:"image/png",width:r.getUint32(16,et),height:r.getUint32(20,et)}:null}(e)||function(t){const r=Rr(t);if(!(r.byteLength>=3&&r.getUint16(0,et)===65496&&r.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:o}=function(){const d=new Set([65499,65476,65484,65501,65534]);for(let b=65504;b<65520;++b)d.add(b);return{tableMarkers:d,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}();let c=2;for(;c+9<r.byteLength;){const d=r.getUint16(c,et);if(o.has(d))return{mimeType:"image/jpeg",height:r.getUint16(c+5,et),width:r.getUint16(c+7,et)};if(!i.has(d))return null;c+=2,c+=r.getUint16(c,et)}return null}(e)||function(t){const r=Rr(t);return r.byteLength>=10&&r.getUint32(0,et)===1195984440?{mimeType:"image/gif",width:r.getUint16(6,Gr),height:r.getUint16(8,Gr)}:null}(e)||function(t){const r=Rr(t);return r.byteLength>=14&&r.getUint16(0,et)===16973&&r.getUint32(2,Gr)===r.byteLength?{mimeType:"image/bmp",width:r.getUint32(18,Gr),height:r.getUint32(22,Gr)}:null}(e)||function(t){const r=new Uint8Array(t instanceof DataView?t.buffer:t),n=dh(r);return n?{mimeType:n.mimeType,width:0,height:0}:null}(e)}function Rr(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}const hh={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:"4.3.2",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:async function(s,e,t){const r=((e=e||{}).image||{}).type||"auto",{url:n}=t||{};let i;switch(function(o){switch(o){case"auto":case"data":return function(){if(ai)return"imagebitmap";if(oi)return"image";if(ui)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(c){switch(c){case"auto":return ai||oi||ui;case"imagebitmap":return ai;case"image":return oi;case"data":return ui;default:throw new Error(`@loaders.gl/images: image ${c} not supported in this environment`)}}(o),o}}(r)){case"imagebitmap":i=await lh(s,e,n);break;case"image":i=await cu(s,e,n);break;case"data":i=await async function(o){var g;const{mimeType:c}=li(o)||{},d=(g=globalThis.loaders)==null?void 0:g.parseImageNode;return ct(d),await d(o,c)}(s);break;default:ct(!1)}return r==="data"&&(i=au(i)),i},tests:[s=>!!li(new DataView(s))],options:{image:{type:"auto",decode:!0}}},di={};function fh(s){if(di[s]===void 0){const e=fs?function(t){switch(t){case"image/avif":case"image/webp":return function(r){try{return document.createElement("canvas").toDataURL(r).indexOf(`data:${r}`)===0}catch{return!1}}(t);default:return!0}}(s):function(t){var o,c;const r=["image/png","image/jpeg","image/gif"],n=((o=globalThis.loaders)==null?void 0:o.imageFormatsNode)||r;return!!((c=globalThis.loaders)==null?void 0:c.parseImageNode)&&n.includes(t)}(s);di[s]=e}return di[s]}function Se(s,e){if(!s)throw new Error(e||"assert failed: gltf")}const du={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},hu={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},fu=["SCALAR","VEC2","VEC3","VEC4"],ph=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],mh=new Map(ph),gh={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},yh={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},bh={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function pu(s){return fu[s-1]||fu[0]}function bs(s){const e=mh.get(s.constructor);if(!e)throw new Error("Illegal typed array");return e}function hi(s,e){const t=bh[s.componentType],r=gh[s.type],n=yh[s.componentType],i=s.count*r,o=s.count*r*n;return Se(o>=0&&o<=e.byteLength),{ArrayType:t,length:i,byteLength:o,componentByteSize:hu[s.componentType],numberOfComponentsInElement:du[s.type]}}class be{constructor(e){ee(this,"gltf");ee(this,"sourceBuffers");ee(this,"byteLength");this.gltf={json:(e==null?void 0:e.json)||{asset:{version:"2.0",generator:"loaders.gl"},buffers:[],extensions:{},extensionsRequired:[],extensionsUsed:[]},buffers:(e==null?void 0:e.buffers)||[],images:(e==null?void 0:e.images)||[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}hasExtension(e){const t=this.getUsedExtensions().find(n=>n===e),r=this.getRequiredExtensions().find(n=>n===e);return typeof t=="string"||typeof r=="string"}getExtension(e){const t=this.getUsedExtensions().find(n=>n===e),r=this.json.extensions||{};return t?r[e]:null}getRequiredExtension(e){return this.getRequiredExtensions().find(r=>r===e)?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(e,t){return(e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if(typeof t=="object")return t;const r=this.json[e]&&this.json[e][t];if(!r)throw new Error(`glTF file error: Could not find ${e}[${t}]`);return r}getTypedArrayForBufferView(e){const t=(e=this.getBufferView(e)).buffer,r=this.gltf.buffers[t];Se(r);const n=(e.byteOffset||0)+r.byteOffset;return new Uint8Array(r.arrayBuffer,n,e.byteLength)}getTypedArrayForAccessor(e){const t=this.getAccessor(e);return function(r,n,i){var a,u;const o=typeof i=="number"?(a=r.accessors)==null?void 0:a[i]:i;if(!o)throw new Error(`No gltf accessor ${JSON.stringify(i)}`);const c=(u=r.bufferViews)==null?void 0:u[o.bufferView||0];if(!c)throw new Error(`No gltf buffer view for accessor ${c}`);const{arrayBuffer:d,byteOffset:g}=n[c.buffer],b=(g||0)+(o.byteOffset||0)+(c.byteOffset||0),{ArrayType:l,length:x,componentByteSize:m,numberOfComponentsInElement:_}=hi(o,c),w=m*_,f=c.byteStride||w;if(c.byteStride===void 0||c.byteStride===w)return new l(d,b,x);const p=new l(x);for(let h=0;h<o.count;h++){const y=new l(d,b+h*f,_);p.set(y,h*_)}return p}(this.gltf.json,this.gltf.buffers,t)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),r=this.getBuffer(t.buffer).data,n=t.byteOffset||0;return new Uint8Array(r,n,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,r){return e.extensions=e.extensions||{},e.extensions[t]=r,this.registerUsedExtension(t),this}setObjectExtension(e,t,r){(e.extensions||{})[t]=r}removeObjectExtension(e,t){const r=(e==null?void 0:e.extensions)||{};if(r[t]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const n=this.json.extensionsRemoved;n.includes(t)||n.push(t)}delete r[t]}addExtension(e,t={}){return Se(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e,t={}){return Se(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find(t=>t===e)||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find(t=>t===e)||this.json.extensionsRequired.push(e)}removeExtension(e){var t;if((t=this.json.extensions)!=null&&t[e]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const r=this.json.extensionsRemoved;r.includes(e)||r.push(e)}this.json.extensions&&delete this.json.extensions[e],this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e)}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:r}=e;this.json.nodes=this.json.nodes||[];const n={mesh:t};return r&&(n.matrix=r),this.json.nodes.push(n),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:r,material:n,mode:i=4}=e,o={primitives:[{attributes:this._addAttributes(t),mode:i}]};if(r){const c=this._addIndices(r);o.primitives[0].indices=c}return Number.isFinite(n)&&(o.primitives[0].material=n),this.json.meshes=this.json.meshes||[],this.json.meshes.push(o),this.json.meshes.length-1}addPointCloud(e){const t={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(t),this.json.meshes.length-1}addImage(e,t){const r=li(e),n=t||(r==null?void 0:r.mimeType),i={bufferView:this.addBufferView(e),mimeType:n};return this.json.images=this.json.images||[],this.json.images.push(i),this.json.images.length-1}addBufferView(e,t=0,r=this.byteLength){const n=e.byteLength;Se(Number.isFinite(n)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const i={buffer:t,byteOffset:r,byteLength:n};return this.byteLength+=Er(n,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(i),this.json.bufferViews.length-1}addAccessor(e,t){const r={bufferView:e,type:pu(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(r),this.json.accessors.length-1}addBinaryBuffer(e,t={size:3}){const r=this.addBufferView(e);let n={min:t.min,max:t.max};n.min&&n.max||(n=this._getAccessorMinMax(e,t.size));const i={size:t.size,componentType:bs(e),count:Math.round(e.length/t.size),min:n.min,max:n.max};return this.addAccessor(r,Object.assign(i,t))}addTexture(e){const{imageIndex:t}=e,r={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(r),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var i,o;const e=this.byteLength,t=new ArrayBuffer(e),r=new Uint8Array(t);let n=0;for(const c of this.sourceBuffers||[])n=Vd(c,r,n);(o=(i=this.json)==null?void 0:i.buffers)!=null&&o[0]?this.json.buffers[0].byteLength=e:this.json.buffers=[{byteLength:e}],this.gltf.binary=t,this.sourceBuffers=[t],this.gltf.buffers=[{arrayBuffer:t,byteOffset:0,byteLength:t.byteLength}]}_removeStringFromArray(e,t){let r=!0;for(;r;){const n=e.indexOf(t);n>-1?e.splice(n,1):r=!1}}_addAttributes(e={}){const t={};for(const r in e){const n=e[r],i=this._getGltfAttributeName(r),o=this.addBinaryBuffer(n.value,n);t[i]=o}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const r={min:null,max:null};if(e.length<t)return r;r.min=[],r.max=[];const n=e.subarray(0,t);for(const i of n)r.min.push(i),r.max.push(i);for(let i=t;i<e.length;i+=t)for(let o=0;o<t;o++)r.min[0+o]=Math.min(r.min[0+o],e[i+o]),r.max[0+o]=Math.max(r.max[0+o],e[i+o]);return r}}function mu(s){return(s%1+1)%1}const gu={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16,BOOLEAN:1,STRING:1,ENUM:1},xh={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:BigInt64Array,UINT64:BigUint64Array,FLOAT32:Float32Array,FLOAT64:Float64Array},yu={INT8:1,UINT8:1,INT16:2,UINT16:2,INT32:4,UINT32:4,INT64:8,UINT64:8,FLOAT32:4,FLOAT64:8};function fi(s,e){return yu[e]*gu[s]}function xs(s,e,t,r){if(t!=="UINT8"&&t!=="UINT16"&&t!=="UINT32"&&t!=="UINT64")return null;const n=_s(s.getTypedArrayForBufferView(e),"SCALAR",t,r+1);return n instanceof BigInt64Array||n instanceof BigUint64Array?null:n}function _s(s,e,t,r=1){const n=xh[t],i=yu[t],o=r*gu[e],c=o*i;let d=s.buffer,g=s.byteOffset;return g%i!=0&&(d=new Uint8Array(d).slice(g,g+c).buffer,g=0),new n(d,g,o)}function pi(s,e,t){var g,b,l,x,m;const r=`TEXCOORD_${e.texCoord||0}`,n=t.attributes[r],i=s.getTypedArrayForAccessor(n),o=s.gltf.json,c=e.index,d=(b=(g=o.textures)==null?void 0:g[c])==null?void 0:b.source;if(d!==void 0){const _=(x=(l=o.images)==null?void 0:l[d])==null?void 0:x.mimeType,w=(m=s.gltf.images)==null?void 0:m[d];if(w&&w.width!==void 0){const f=[];for(let p=0;p<i.length;p+=2){const a=_h(w,_,i,p,e.channels);f.push(a)}return f}}return[]}function bu(s,e,t,r,n){if(!(t!=null&&t.length))return;const i=[];for(const b of t){let l=r.findIndex(x=>x===b);l===-1&&(l=r.push(b)-1),i.push(l)}const o=new Uint32Array(i),c=s.gltf.buffers.push({arrayBuffer:o.buffer,byteOffset:o.byteOffset,byteLength:o.byteLength})-1,d=s.addBufferView(o,c,0),g=s.addAccessor(d,{size:1,componentType:bs(o),count:o.length});n.attributes[e]=g}function _h(s,e,t,r,n=[0]){const i={r:{offset:0,shift:0},g:{offset:1,shift:8},b:{offset:2,shift:16},a:{offset:3,shift:24}},o=t[r],c=t[r+1];let d=1;!e||e.indexOf("image/jpeg")===-1&&e.indexOf("image/png")===-1||(d=4);const g=function(l,x,m,_=1){const w=m.width,f=mu(l)*(w-1),p=Math.round(f),a=m.height,u=mu(x)*(a-1),h=Math.round(u),y=m.components?m.components:_;return(h*w+p)*y}(o,c,s,d);let b=0;for(const l of n){const x=typeof l=="number"?Object.values(i)[l]:i[l],m=g+x.offset,_=au(s);if(_.data.length<=m)throw new Error(`${_.data.length} <= ${m}`);b|=_.data[m]<<x.shift}return b}function xu(s,e,t,r,n){const i=[];for(let o=0;o<e;o++){const c=t[o],d=t[o+1]-t[o];if(d+c>r)break;const g=c/n,b=d/n;i.push(s.slice(g,g+b))}return i}function _u(s,e,t){const r=[];for(let n=0;n<e;n++){const i=n*t;r.push(s.slice(i,i+t))}return r}function Bu(s,e,t,r){if(t)throw new Error("Not implemented - arrayOffsets for strings is specified");if(r){const n=[],i=new TextDecoder("utf8");let o=0;for(let c=0;c<s;c++){const d=r[c+1]-r[c];if(d+o<=e.length){const g=e.subarray(o,d+o),b=i.decode(g);n.push(b),o+=d}}return n}return[]}const cr="EXT_mesh_features",Bh=cr;function Ah(s,e,t){var i,o,c;if(!((i=t==null?void 0:t.gltf)!=null&&i.loadBuffers))return;const r=(o=e.extensions)==null?void 0:o[cr],n=r==null?void 0:r.featureIds;if(n)for(const d of n){let g;if(d.attribute!==void 0){const b=`_FEATURE_ID_${d.attribute}`,l=e.attributes[b];g=s.getTypedArrayForAccessor(l)}else g=d.texture!==void 0&&((c=t==null?void 0:t.gltf)!=null&&c.loadImages)?pi(s,d.texture,e):[];d.data=g}}function vh(s,e){var n;const t=(n=e.extensions)==null?void 0:n[cr];if(!t)return;const r=t.featureIds;r.forEach((i,o)=>{if(i.data){const{accessorKey:c,index:d}=function(x){const m="_FEATURE_ID_",_=Object.keys(x).filter(p=>p.indexOf(m)===0);let w=-1;for(const p of _){const a=Number(p.substring(m.length));a>w&&(w=a)}return w++,{accessorKey:`${m}${w}`,index:w}}(e.attributes),g=new Uint32Array(i.data);r[o]={featureCount:g.length,propertyTable:i.propertyTable,attribute:d},s.gltf.buffers.push({arrayBuffer:g.buffer,byteOffset:g.byteOffset,byteLength:g.byteLength});const b=s.addBufferView(g),l=s.addAccessor(b,{size:1,componentType:bs(g),count:g.length});e.attributes[c]=l}})}const wh=Object.freeze(Object.defineProperty({__proto__:null,createExtMeshFeatures:function(s,e,t,r){e.extensions||(e.extensions={});let n=e.extensions[cr];n||(n={featureIds:[]},e.extensions[cr]=n);const{featureIds:i}=n,o={featureCount:t.length,propertyTable:r,data:t};i.push(o),s.addObjectExtension(e,cr,n)},decode:async function(s,e){(function(t,r){const n=t.gltf.json;if(n.meshes)for(const i of n.meshes)for(const o of i.primitives)Ah(t,o,r)})(new be(s),e)},encode:function(s,e){const t=new be(s);return function(r){const n=r.gltf.json.meshes;if(n)for(const i of n)for(const o of i.primitives)vh(r,o)}(t),t.createBinaryChunk(),t.gltf},name:Bh},Symbol.toStringTag,{value:"Module"})),lr="EXT_structural_metadata",Ch=lr;function Th(s,e){for(const t of s)if(t.class===e)return t;return null}function Sh(s,e,t,r){var o;if(!e)return;const n=(o=t.extensions)==null?void 0:o[lr],i=n==null?void 0:n.propertyTextures;if(i)for(const c of i)Eh(s,e[c],t,r)}function Eh(s,e,t,r){var i;if(!e.properties)return;r.dataAttributeNames||(r.dataAttributeNames=[]);const n=e.class;for(const o in e.properties){const c=`${n}_${o}`,d=(i=e.properties)==null?void 0:i[o];if(!d)continue;d.data||(d.data=[]);const g=d.data,b=pi(s,d,t);b!==null&&(bu(s,c,b,g,t),d.data=g,r.dataAttributeNames.push(c))}}function Mh(s,e,t){var i,o;const r=(i=e.classes)==null?void 0:i[t.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${t.class}`);const n=t.count;for(const c in r.properties){const d=r.properties[c],g=(o=t.properties)==null?void 0:o[c];if(g){const b=Ph(s,e,d,n,g);g.data=b}}}function Ph(s,e,t,r,n){let i=[];const o=n.values,c=s.getTypedArrayForBufferView(o),d=function(b,l,x,m){return l.array&&l.count===void 0&&x.arrayOffsets!==void 0?xs(b,x.arrayOffsets,x.arrayOffsetType||"UINT32",m):null}(s,t,n,r),g=function(b,l,x){return l.stringOffsets!==void 0?xs(b,l.stringOffsets,l.stringOffsetType||"UINT32",x):null}(s,n,r);switch(t.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":case"MAT2":case"MAT3":case"MAT4":i=function(b,l,x,m){const _=b.array,w=b.count,f=fi(b.type,b.componentType),p=x.byteLength/f;let a;return a=b.componentType?_s(x,b.type,b.componentType,p):x,_?m?xu(a,l,m,x.length,f):w?_u(a,l,w):[]:a}(t,r,c,d);break;case"BOOLEAN":throw new Error(`Not implemented - classProperty.type=${t.type}`);case"STRING":i=Bu(r,c,d,g);break;case"ENUM":i=function(b,l,x,m,_){var y;const w=l.enumType;if(!w)throw new Error("Incorrect data in the EXT_structural_metadata extension: classProperty.enumType is not set for type ENUM");const f=(y=b.enums)==null?void 0:y[w];if(!f)throw new Error(`Incorrect data in the EXT_structural_metadata extension: schema.enums does't contain ${w}`);const p=f.valueType||"UINT16",a=fi(l.type,p),u=m.byteLength/a;let h=_s(m,l.type,p,u);if(h||(h=m),l.array){if(_)return function(C){const{valuesData:G,numberOfElements:U,arrayOffsets:k,valuesDataBytesLength:T,elementSize:S,enumEntry:P}=C,L=[];for(let F=0;F<U;F++){const O=k[F],H=k[F+1]-k[F];if(H+O>T)break;const K=mi(G,O/S,H/S,P);L.push(K)}return L}({valuesData:h,numberOfElements:x,arrayOffsets:_,valuesDataBytesLength:m.length,elementSize:a,enumEntry:f});const B=l.count;return B?function(C,G,U,k){const T=[];for(let S=0;S<G;S++){const P=mi(C,U*S,U,k);T.push(P)}return T}(h,x,B,f):[]}return mi(h,0,x,f)}(e,t,r,c,d);break;default:throw new Error(`Unknown classProperty type ${t.type}`)}return i}function mi(s,e,t,r){const n=[];for(let i=0;i<t;i++)if(s instanceof BigInt64Array||s instanceof BigUint64Array)n.push("");else{const o=Gh(r,s[e+i]);o?n.push(o.name):n.push("")}return n}function Gh(s,e){for(const t of s.values)if(t.value===e)return t;return null}function Rh(s,e,t){for(const r in s.properties){const n=s.properties[r].data;if(n){const i=e.properties[r];if(i){const o=Lh(n,i,t);s.properties[r]=o}}}}function Lh(s,e,t){const r={values:0};if(e.type==="STRING"){const{stringData:n,stringOffsets:i}=function(o){const c=new TextEncoder,d=[];let g=0;for(const _ of o){const w=c.encode(_);g+=w.length,d.push(w)}const b=new Uint8Array(g),l=[];let x=0;for(const _ of d)b.set(_,x),l.push(x),x+=_.length;l.push(x);const m=new Uint32Array(l);return{stringData:b,stringOffsets:m}}(s);r.stringOffsets=gi(i,t),r.values=gi(n,t)}else if(e.type==="SCALAR"&&e.componentType){const n=function(i,o){const c=[];for(const g of i)c.push(Number(g));const d=Oh[o];if(!d)throw new Error("Illegal component type");return new d(c)}(s,e.componentType);r.values=gi(n,t)}return r}const Oh={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:Int32Array,UINT64:Uint32Array,FLOAT32:Float32Array,FLOAT64:Float64Array};function gi(s,e){return e.gltf.buffers.push({arrayBuffer:s.buffer,byteOffset:s.byteOffset,byteLength:s.byteLength}),e.addBufferView(s)}const Ih=Object.freeze(Object.defineProperty({__proto__:null,createExtStructuralMetadata:function(s,e,t="schemaClassId"){let r=s.getExtension(lr);r||(r=s.addExtension(lr)),r.schema=function(i,o,c){const d=c??{id:"schema_id"},g={properties:{}};for(const b of i){const l={type:b.elementType,componentType:b.componentType};g.properties[b.name]=l}return d.classes={},d.classes[o]=g,d}(e,t,r.schema);const n=function(i,o,c){var l;const d={class:o,count:0};let g=0;const b=(l=c.classes)==null?void 0:l[o];for(const x of i){if(g===0&&(g=x.values.length),g!==x.values.length&&x.values.length)throw new Error("Illegal values in attributes");(b==null?void 0:b.properties[x.name])&&(d.properties||(d.properties={}),d.properties[x.name]={values:0,data:x.values})}return d.count=g,d}(e,t,r.schema);return r.propertyTables||(r.propertyTables=[]),r.propertyTables.push(n)-1},decode:async function(s,e){(function(t,r){var i,o;if(!((i=r.gltf)!=null&&i.loadBuffers))return;const n=t.getExtension(lr);n&&((o=r.gltf)!=null&&o.loadImages&&function(c,d){const g=d.propertyTextures,b=c.gltf.json;if(g&&b.meshes)for(const l of b.meshes)for(const x of l.primitives)Sh(c,g,x,d)}(t,n),function(c,d){const g=d.schema;if(!g)return;const b=g.classes,l=d.propertyTables;if(b&&l)for(const x in b){const m=Th(l,x);m&&Mh(c,g,m)}}(t,n))})(new be(s),e)},encode:function(s,e){const t=new be(s);return function(r){var i,o;const n=r.getExtension(lr);if(n&&n.propertyTables)for(const c of n.propertyTables){const d=c.class,g=(o=(i=n.schema)==null?void 0:i.classes)==null?void 0:o[d];c.properties&&g&&Rh(c,g,r)}}(t),t.createBinaryChunk(),t.gltf},name:Ch},Symbol.toStringTag,{value:"Module"})),Au="EXT_feature_metadata",Fh=Au;function Dh(s,e){for(const t in s){const r=s[t];if(r.class===e)return r}return null}function Uh(s,e){for(const t in s){const r=s[t];if(r.class===e)return r}return null}function kh(s,e,t){var i,o;if(!t.class)return;const r=(i=e.classes)==null?void 0:i[t.class];if(!r)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${t.class}`);const n=t.count;for(const c in r.properties){const d=r.properties[c],g=(o=t.properties)==null?void 0:o[c];if(g){const b=Vh(s,e,d,n,g);g.data=b}}}function Nh(s,e,t){var n;const r=e.class;for(const i in t.properties){const o=(n=e==null?void 0:e.properties)==null?void 0:n[i];if(o){const c=Hh(s,o,r);o.data=c}}}function Vh(s,e,t,r,n){let i=[];const o=n.bufferView,c=s.getTypedArrayForBufferView(o),d=function(b,l,x,m){return l.type==="ARRAY"&&l.componentCount===void 0&&x.arrayOffsetBufferView!==void 0?xs(b,x.arrayOffsetBufferView,x.offsetType||"UINT32",m):null}(s,t,n,r),g=function(b,l,x,m){return x.stringOffsetBufferView!==void 0?xs(b,x.stringOffsetBufferView,x.offsetType||"UINT32",m):null}(s,0,n,r);return t.type==="STRING"||t.componentType==="STRING"?i=Bu(r,c,d,g):function(b){const l=["UINT8","INT16","UINT16","INT32","UINT32","INT64","UINT64","FLOAT32","FLOAT64"];return l.includes(b.type)||b.componentType!==void 0&&l.includes(b.componentType)}(t)&&(i=function(b,l,x,m){const _=b.type==="ARRAY",w=b.componentCount,f="SCALAR",p=b.componentType||b.type,a=fi(f,p),u=x.byteLength/a,h=_s(x,f,p,u);return _?m?xu(h,l,m,x.length,a):w?_u(h,l,w):[]:h}(t,r,c,d)),i}function Hh(s,e,t){const r=s.gltf.json;if(!r.meshes)return[];const n=[];for(const i of r.meshes)for(const o of i.primitives)jh(s,t,e,n,o);return n}function jh(s,e,t,r,n){const i=pi(s,{channels:t.channels,...t.texture},n);i&&bu(s,e,i,r,n)}const Jh=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e){(function(t,r){var i,o;if(!((i=r.gltf)!=null&&i.loadBuffers))return;const n=t.getExtension(Au);n&&((o=r.gltf)!=null&&o.loadImages&&function(c,d){const g=d.schema;if(!g)return;const b=g.classes,{featureTextures:l}=d;if(b&&l)for(const x in b){const m=b[x],_=Uh(l,x);_&&Nh(c,_,m)}}(t,n),function(c,d){const g=d.schema;if(!g)return;const b=g.classes,l=d.featureTables;if(b&&l)for(const x in b){const m=Dh(l,x);m&&kh(c,g,m)}}(t,n))})(new be(s),e)},name:Fh},Symbol.toStringTag,{value:"Module"})),zh="basis_transcoder.js",Kh="basis_transcoder.wasm",Xh="basis_encoder.js",Wh="basis_encoder.wasm";let vu,yi;async function wu(s){var r;var e;return e=s.modules,globalThis.loaders||(globalThis.loaders={}),(r=globalThis.loaders).modules||(r.modules={}),Object.assign(globalThis.loaders.modules,e),function(n){var o,c;return((c=(o=globalThis.loaders)==null?void 0:o.modules)==null?void 0:c[n])||null}("basis")||(vu||(vu=async function(n){let i=null,o=null;return[i,o]=await Promise.all([await Ft(zh,"textures",n),await Ft(Kh,"textures",n)]),i=i||globalThis.BASIS,await function(c,d){const g={};return d&&(g.wasmBinary=d),new Promise(b=>{c(g).then(l=>{const{BasisFile:x,initializeBasis:m}=l;m(),b({BasisFile:x})})})}(i,o)}(s)),await vu)}async function Cu(s){const e=s.modules||{};return e.basisEncoder?e.basisEncoder:(yi=yi||async function(t){let r=null,n=null;return[r,n]=await Promise.all([await Ft(Xh,"textures",t),await Ft(Wh,"textures",t)]),r=r||globalThis.BASIS,await function(i,o){const c={};return o&&(c.wasmBinary=o),new Promise(d=>{i(c).then(g=>{const{BasisFile:b,KTX2File:l,initializeBasis:x,BasisEncoder:m}=g;x(),d({BasisFile:b,KTX2File:l,BasisEncoder:m})})})}(r,n)}(s),await yi)}const Yh=["","WEBKIT_","MOZ_"],Tu={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let Bs=null;function qh(s){if(!Bs){s=s||function(){try{return document.createElement("canvas").getContext("webgl")}catch{return null}}()||void 0,Bs=new Set;for(const e of Yh)for(const t in Tu)if(s&&s.getExtension(`${e}${t}`)){const r=Tu[t];Bs.add(r)}}return Bs}const Ee=[171,75,84,88,32,50,48,187,13,10,26,10],Qh={etc1:{basisFormat:0,compressed:!0,format:36196},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:33776},bc3:{basisFormat:3,compressed:!0,format:33779},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:35840},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:35842},"astc-4x4":{basisFormat:10,compressed:!0,format:37808},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};function bi(s,e,t){const r=new s(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("Failed to start basis transcoding");const n=r.getNumImages(),i=[];for(let o=0;o<n;o++){const c=r.getNumLevels(o),d=[];for(let g=0;g<c;g++)d.push($h(r,o,g,t));i.push(d)}return i}finally{r.close(),r.delete()}}function $h(s,e,t,r){const n=s.getImageWidth(e,t),i=s.getImageHeight(e,t),o=s.getHasAlpha(),{compressed:c,format:d,basisFormat:g}=Eu(r,o),b=s.getImageTranscodedSizeInBytes(e,t,g),l=new Uint8Array(b);if(!s.transcodeImage(l,e,t,g,0,0))throw new Error("failed to start Basis transcoding");return{width:n,height:i,data:l,compressed:c,format:d,hasAlpha:o}}function Su(s,e,t){const r=new s(new Uint8Array(e));try{if(!r.startTranscoding())throw new Error("failed to start KTX2 transcoding");const n=r.getLevels(),i=[];for(let o=0;o<n;o++)i.push(Zh(r,o,t));return[i]}finally{r.close(),r.delete()}}function Zh(s,e,t){const{alphaFlag:r,height:n,width:i}=s.getImageLevelInfo(e,0,0),{compressed:o,format:c,basisFormat:d}=Eu(t,r),g=s.getImageTranscodedSizeInBytes(e,0,0,d),b=new Uint8Array(g);if(!s.transcodeImage(b,e,0,0,d,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:i,height:n,data:b,compressed:o,levelSize:g,hasAlpha:r,format:c}}function Eu(s,e){let t=s&&s.basis&&s.basis.format;return t==="auto"&&(t=Mu()),typeof t=="object"&&(t=e?t.alpha:t.noAlpha),t=t.toLowerCase(),Qh[t]}function Mu(){const s=qh();return s.has("astc")?"astc-4x4":s.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:s.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:s.has("etc1")?"etc1":s.has("etc2")?"etc2":"rgb565"}const ef={dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:"4.3.2",worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}},parse:async function(s,e){if(e.basis.containerFormat==="auto"){if(function(r){const n=new Uint8Array(r);return!(n.byteLength<Ee.length||n[0]!==Ee[0]||n[1]!==Ee[1]||n[2]!==Ee[2]||n[3]!==Ee[3]||n[4]!==Ee[4]||n[5]!==Ee[5]||n[6]!==Ee[6]||n[7]!==Ee[7]||n[8]!==Ee[8]||n[9]!==Ee[9]||n[10]!==Ee[10]||n[11]!==Ee[11])}(s))return Su((await Cu(e)).KTX2File,s,e);const{BasisFile:t}=await wu(e);return bi(t,s,e)}if(e.basis.module==="encoder"){const t=await Cu(e);return e.basis.containerFormat==="ktx2"?Su(t.KTX2File,s,e):bi(t.BasisFile,s,e)}{const{BasisFile:t}=await wu(e);return bi(t,s,e)}}},dr=!0,Pu=1735152710,tf=1313821514,rf=5130562;function sf(s,e,t=0,r={}){const n=new DataView(e),i=function(d,g=0){return`${String.fromCharCode(d.getUint8(g+0))}${String.fromCharCode(d.getUint8(g+1))}${String.fromCharCode(d.getUint8(g+2))}${String.fromCharCode(d.getUint8(g+3))}`}(n,t+0),o=n.getUint32(t+4,dr),c=n.getUint32(t+8,dr);switch(Object.assign(s,{header:{byteOffset:t,byteLength:c,hasBinChunk:!1},type:i,version:o,json:{},binChunks:[]}),t+=12,s.version){case 1:return function(d,g,b){ct(d.header.byteLength>20);const l=g.getUint32(b+0,dr),x=g.getUint32(b+4,dr);return b+=8,ct(x===0),xi(d,g,b,l),b+=l,b+=_i(d,g,b,d.header.byteLength),b}(s,n,t);case 2:return function(d,g,b,l){return ct(d.header.byteLength>20),function(x,m,_,w){for(;_+8<=x.header.byteLength;){const f=m.getUint32(_+0,dr),p=m.getUint32(_+4,dr);switch(_+=8,p){case tf:xi(x,m,_,f);break;case rf:_i(x,m,_,f);break;case 0:w.strict||xi(x,m,_,f);break;case 1:w.strict||_i(x,m,_,f)}_+=Er(f,4)}}(d,g,b,l),b+d.header.byteLength}(s,n,t,{});default:throw new Error(`Invalid GLB version ${s.version}. Only supports version 1 and 2.`)}}function xi(s,e,t,r){const n=new Uint8Array(e.buffer,t,r),i=new TextDecoder("utf8").decode(n);return s.json=JSON.parse(i),Er(r,4)}function _i(s,e,t,r){return s.header.hasBinChunk=!0,s.binChunks.push({byteOffset:t,byteLength:r,arrayBuffer:e.buffer}),Er(r,4)}function Gu(s,e){if(s.startsWith("data:")||s.startsWith("http:")||s.startsWith("https:"))return s;const t=e.baseUri||e.uri;if(!t)throw new Error(`'baseUri' must be provided to resolve relative url ${s}`);return t.substr(0,t.lastIndexOf("/")+1)+s}const nf="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",of="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",af=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),uf=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),cf={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},lf={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function df(s,e,t,r,n,i="NONE"){const o=await async function(){return Bi||(Bi=async function(){let c=nf;WebAssembly.validate(af)&&(c=of,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const d=await WebAssembly.instantiate(function(g){const b=new Uint8Array(g.length);for(let x=0;x<g.length;++x){const m=g.charCodeAt(x);b[x]=m>96?m-71:m>64?m-65:m>47?m+4:m>46?63:62}let l=0;for(let x=0;x<g.length;++x)b[l++]=b[x]<60?uf[b[x]]:64*(b[x]-60)+b[++x];return b.buffer.slice(0,l)}(c),{});return await d.instance.exports.__wasm_call_ctors(),d.instance}()),Bi}();(function(c,d,g,b,l,x,m){const _=c.exports.sbrk,w=b+3&-4,f=_(w*l),p=_(x.length),a=new Uint8Array(c.exports.memory.buffer);a.set(x,p);const u=d(f,b,l,p,x.length);if(u===0&&m&&m(f,w,l),g.set(a.subarray(f,f+b*l)),_(f-_(0)),u!==0)throw new Error(`Malformed buffer data: ${u}`)})(o,o.exports[lf[n]],s,e,t,r,o.exports[cf[i||"NONE"]])}let Bi;const As="EXT_meshopt_compression",hf=As;async function ff(s,e){const t=s.getObjectExtension(e,As);if(t){const{byteOffset:r=0,byteLength:n=0,byteStride:i,count:o,mode:c,filter:d="NONE",buffer:g}=t,b=s.gltf.buffers[g],l=new Uint8Array(b.arrayBuffer,b.byteOffset+r,n),x=new Uint8Array(s.gltf.buffers[e.buffer].arrayBuffer,e.byteOffset,e.byteLength);await df(x,o,i,l,c,d),s.removeObjectExtension(e,As)}}const pf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e){var n,i;const t=new be(s);if(!((n=e==null?void 0:e.gltf)!=null&&n.decompressMeshes)||!((i=e.gltf)!=null&&i.loadBuffers))return;const r=[];for(const o of s.json.bufferViews||[])r.push(ff(t,o));await Promise.all(r),t.removeExtension(As)},name:hf},Symbol.toStringTag,{value:"Module"})),hr="EXT_texture_webp",mf=Object.freeze(Object.defineProperty({__proto__:null,name:hr,preprocess:function(s,e){const t=new be(s);if(!fh("image/webp")){if(t.getRequiredExtensions().includes(hr))throw new Error(`gltf: Required extension ${hr} not supported by browser`);return}const{json:r}=t;for(const n of r.textures||[]){const i=t.getObjectExtension(n,hr);i&&(n.source=i.source),t.removeObjectExtension(n,hr)}t.removeExtension(hr)}},Symbol.toStringTag,{value:"Module"})),vs="KHR_texture_basisu",gf=Object.freeze(Object.defineProperty({__proto__:null,name:vs,preprocess:function(s,e){const t=new be(s),{json:r}=t;for(const n of r.textures||[]){const i=t.getObjectExtension(n,vs);i&&(n.source=i.source,t.removeObjectExtension(n,vs))}t.removeExtension(vs)}},Symbol.toStringTag,{value:"Module"})),yf={dataType:null,batchType:null,name:"Draco",id:"draco",module:"draco",version:"4.3.2",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:typeof WebAssembly=="object"?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};function Ru(s,e,t){return sh(s,e,t?Lu(t.metadata):void 0)}function Lu(s){Object.entries(s);const e={};for(const t in s)e[`${t}.string`]=JSON.stringify(s[t]);return e}const Ou={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},bf={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array};class xf{constructor(e){ee(this,"draco");ee(this,"decoder");ee(this,"metadataQuerier");this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,t={}){const r=new this.draco.DecoderBuffer;r.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const n=this.decoder.GetEncodedGeometryType(r),i=n===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let o;switch(n){case this.draco.TRIANGULAR_MESH:o=this.decoder.DecodeBufferToMesh(r,i);break;case this.draco.POINT_CLOUD:o=this.decoder.DecodeBufferToPointCloud(r,i);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!o.ok()||!i.ptr){const l=`DRACO decompression failed: ${o.error_msg()}`;throw new Error(l)}const c=this._getDracoLoaderData(i,n,t),d=this._getMeshData(i,c,t),g=function(l){let x=1/0,m=1/0,_=1/0,w=-1/0,f=-1/0,p=-1/0;const a=l.POSITION?l.POSITION.value:[],u=a&&a.length;for(let h=0;h<u;h+=3){const y=a[h],B=a[h+1],C=a[h+2];x=y<x?y:x,m=B<m?B:m,_=C<_?C:_,w=y>w?y:w,f=B>f?B:f,p=C>p?C:p}return[[x,m,_],[w,f,p]]}(d.attributes),b=function(l,x,m){const _=Lu(x.metadata),w=[],f=function(p){const a={};for(const u in p){const h=p[u];a[h.name||"undefined"]=h}return a}(x.attributes);for(const p in l){const a=Ru(p,l[p],f[p]);w.push(a)}if(m){const p=Ru("indices",m);w.push(p)}return{fields:w,metadata:_}}(d.attributes,c,d.indices);return{loader:"draco",loaderData:c,header:{vertexCount:i.num_points(),boundingBox:g},...d,schema:b}}finally{this.draco.destroy(r),i&&this.draco.destroy(i)}}_getDracoLoaderData(e,t,r){const n=this._getTopLevelMetadata(e),i=this._getDracoAttributes(e,r);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:n,attributes:i}}_getDracoAttributes(e,t){const r={};for(let n=0;n<e.num_attributes();n++){const i=this.decoder.GetAttribute(e,n),o=this._getAttributeMetadata(e,n);r[i.unique_id()]={unique_id:i.unique_id(),attribute_type:i.attribute_type(),data_type:i.data_type(),num_components:i.num_components(),byte_offset:i.byte_offset(),byte_stride:i.byte_stride(),normalized:i.normalized(),attribute_index:n,metadata:o};const c=this._getQuantizationTransform(i,t);c&&(r[i.unique_id()].quantization_transform=c);const d=this._getOctahedronTransform(i,t);d&&(r[i.unique_id()].octahedron_transform=d)}return r}_getMeshData(e,t,r){const n=this._getMeshAttributes(t,e,r);if(!n.POSITION)throw new Error("DRACO: No position attribute found.");return e instanceof this.draco.Mesh?r.topology==="triangle-strip"?{topology:"triangle-strip",mode:4,attributes:n,indices:{value:this._getTriangleStripIndices(e),size:1}}:{topology:"triangle-list",mode:5,attributes:n,indices:{value:this._getTriangleListIndices(e),size:1}}:{topology:"point-list",mode:0,attributes:n}}_getMeshAttributes(e,t,r){const n={};for(const i of Object.values(e.attributes)){const o=this._deduceAttributeName(i,r);i.name=o;const c=this._getAttributeValues(t,i);if(c){const{value:d,size:g}=c;n[o]={value:d,size:g,byteOffset:i.byte_offset,byteStride:i.byte_stride,normalized:i.normalized}}}return n}_getTriangleListIndices(e){const t=3*e.num_faces(),r=4*t,n=this.draco._malloc(r);try{return this.decoder.GetTrianglesUInt32Array(e,r,n),new Uint32Array(this.draco.HEAPF32.buffer,n,t).slice()}finally{this.draco._free(n)}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),function(r){const n=r.size(),i=new Int32Array(n);for(let o=0;o<n;o++)i[o]=r.GetValue(o);return i}(t)}finally{this.draco.destroy(t)}}_getAttributeValues(e,t){const r=bf[t.data_type];if(!r)return console.warn(`DRACO: Unsupported attribute type ${t.data_type}`),null;const n=t.num_components,i=e.num_points()*n,o=i*r.BYTES_PER_ELEMENT,c=function(b,l){switch(l){case Float32Array:return b.DT_FLOAT32;case Int8Array:return b.DT_INT8;case Int16Array:return b.DT_INT16;case Int32Array:return b.DT_INT32;case Uint8Array:return b.DT_UINT8;case Uint16Array:return b.DT_UINT16;case Uint32Array:return b.DT_UINT32;default:return b.DT_INVALID}}(this.draco,r);let d;const g=this.draco._malloc(o);try{const b=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,b,c,o,g),d=new r(this.draco.HEAPF32.buffer,g,i).slice()}finally{this.draco._free(g)}return{value:d,size:n}}_deduceAttributeName(e,t){const r=e.unique_id;for(const[o,c]of Object.entries(t.extraAttributes||{}))if(c===r)return o;const n=e.attribute_type;for(const o in Ou)if(this.draco[o]===n)return Ou[o];const i=t.attributeNameEntry||"name";return e.metadata[i]?e.metadata[i].string:`CUSTOM_ATTRIBUTE_${r}`}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const r=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(r)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const t={},r=this.metadataQuerier.NumEntries(e);for(let n=0;n<r;n++){const i=this.metadataQuerier.GetEntryName(e,n);t[i]=this._getDracoMetadataField(e,i)}return t}_getDracoMetadataField(e,t){const r=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,r);const n=function(i){const o=i.size(),c=new Int32Array(o);for(let d=0;d<o;d++)c[d]=i.GetValue(d);return c}(r);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:n}}finally{this.draco.destroy(r)}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:r=[]}=e,n=[...t,...r];for(const i of n)this.decoder.SkipAttributeTransform(this.draco[i])}_getQuantizationTransform(e,t){const{quantizedAttributes:r=[]}=t,n=e.attribute_type();if(r.map(i=>this.decoder[i]).includes(n)){const i=new this.draco.AttributeQuantizationTransform;try{if(i.InitFromAttribute(e))return{quantization_bits:i.quantization_bits(),range:i.range(),min_values:new Float32Array([1,2,3]).map(o=>i.min_value(o))}}finally{this.draco.destroy(i)}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:r=[]}=t,n=e.attribute_type();if(r.map(i=>this.decoder[i]).includes(n)){const i=new this.draco.AttributeQuantizationTransform;try{if(i.InitFromAttribute(e))return{quantization_bits:i.quantization_bits()}}finally{this.draco.destroy(i)}}return null}}const Ai="https://www.gstatic.com/draco/versioned/decoders/1.5.6",ws="draco_wasm_wrapper.js",Cs="draco_decoder.wasm",Ts="draco_decoder.js",Iu="draco_encoder.js",vi={[ws]:`${Ai}/${ws}`,[Cs]:`${Ai}/${Cs}`,[Ts]:`${Ai}/${Ts}`,[Iu]:`https://raw.githubusercontent.com/google/draco/1.4.1/javascript/${Iu}`};let wi;async function _f(s){const e=s.modules||{};return e.draco3d?wi||(wi=e.draco3d.createDecoderModule({}).then(t=>({draco:t}))):wi||(wi=async function(t){let r,n;return(t.draco&&t.draco.decoderType)==="js"?r=await Ft(vi[Ts],"draco",t,Ts):[r,n]=await Promise.all([await Ft(vi[ws],"draco",t,ws),await Ft(vi[Cs],"draco",t,Cs)]),r=r||globalThis.DracoDecoderModule,await function(i,o){const c={};return o&&(c.wasmBinary=o),new Promise(d=>{i({...c,onModuleLoaded:g=>d({draco:g})})})}(r,n)}(s)),await wi}const Bf={...yf,parse:async function(s,e){const{draco:t}=await _f(e),r=new xf(t);try{return r.parseSync(s,e==null?void 0:e.draco)}finally{r.destroy()}}};function Fu(s){const{buffer:e,size:t,count:r}=function(n){let i=n,o=1,c=0;return n&&n.value&&(i=n.value,o=n.size||1),i&&(ArrayBuffer.isView(i)||(i=function(d,g,b=!1){return d?Array.isArray(d)?new g(d):b&&!(d instanceof g)?new g(d):d:null}(i,Float32Array)),c=i.length/o),{buffer:i,size:o,count:c}}(s);return{value:e,size:t,byteOffset:0,count:r,type:pu(t),componentType:bs(e)}}const kt="KHR_draco_mesh_compression",Af=kt;async function vf(s,e,t,r){const n=s.getObjectExtension(e,kt);if(!n)return;const i=s.getTypedArrayForBufferView(n.bufferView),o=Ia(i.buffer,i.byteOffset),c={...t};delete c["3d-tiles"];const d=await Ba(o,Bf,c,r),g=function(b){const l={};for(const x in b){const m=b[x];if(x!=="indices"){const _=Fu(m);l[x]=_}}return l}(d.attributes);for(const[b,l]of Object.entries(g))if(b in e.attributes){const x=e.attributes[b],m=s.getAccessor(x);m!=null&&m.min&&(m!=null&&m.max)&&(l.min=m.min,l.max=m.max)}e.attributes=g,d.indices&&(e.indices=Fu(d.indices)),s.removeObjectExtension(e,kt),function(b){if(!b.attributes&&Object.keys(b.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}(e)}function wf(s,e,t=4,r,n){if(!r.DracoWriter)throw new Error("options.gltf.DracoWriter not provided")}function*Du(s){for(const e of s.json.meshes||[])for(const t of e.primitives)yield t}const Cf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e,t){var i;if(!((i=e==null?void 0:e.gltf)!=null&&i.decompressMeshes))return;const r=new be(s),n=[];for(const o of Du(r))r.getObjectExtension(o,kt)&&n.push(vf(r,o,e,t));await Promise.all(n),r.removeExtension(kt)},encode:function(s,e={}){const t=new be(s);for(const r of t.json.meshes||[])wf(),t.addRequiredExtension(kt)},name:Af,preprocess:function(s,e,t){const r=new be(s);for(const n of Du(r))r.getObjectExtension(n,kt)}},Symbol.toStringTag,{value:"Module"}));globalThis.mathgl=globalThis.mathgl||{config:{EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1}};const Ve=globalThis.mathgl.config;function Tf(s,{precision:e=Ve.precision}={}){return s=function(t){return Math.round(t/Ve.EPSILON)*Ve.EPSILON}(s),`${parseFloat(s.toPrecision(e))}`}function Ss(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Uu(s,e,t){const r=Ve.EPSILON;try{if(s===e)return!0;if(Ss(s)&&Ss(e)){if(s.length!==e.length)return!1;for(let n=0;n<s.length;++n)if(!Uu(s[n],e[n]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"&&Math.abs(s-e)<=Ve.EPSILON*Math.max(1,Math.abs(s),Math.abs(e))}finally{Ve.EPSILON=r}}class ku extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=e[r+t];return this.check()}toArray(e=[],t=0){for(let r=0;r<this.ELEMENTS;++r)e[t+r]=this[r];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Ss(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Ve)}formatString(e){let t="";for(let r=0;r<this.ELEMENTS;++r)t+=(r>0?", ":"")+Tf(this[r],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!Uu(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,r){if(r===void 0)return this.lerp(this,e,t);for(let n=0;n<this.ELEMENTS;++n){const i=e[n],o=typeof t=="number"?t:t[n];this[n]=i+r*(o-i)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),t[r]);return this.check()}add(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]+=t[r];return this.check()}subtract(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]-=t[r];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(Ve.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),t);return this.check()}get elements(){return this}}function Me(s){if(!Number.isFinite(s))throw new Error(`Invalid number ${JSON.stringify(s)}`);return s}function Sf(s,e,t=""){if(Ve.debug&&!function(r,n){if(r.length!==n)return!1;for(let i=0;i<r.length;++i)if(!Number.isFinite(r[i]))return!1;return!0}(s,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return s}function Nu(s,e){if(!s)throw new Error(`math.gl assertion ${e}`)}class Ef extends ku{get x(){return this[0]}set x(e){this[0]=Me(e)}get y(){return this[1]}set y(e){this[1]=Me(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let r=0;r<this.ELEMENTS;++r){const n=this[r]-e[r];t+=n*n}return Me(t)}dot(e){let t=0;for(let r=0;r<this.ELEMENTS;++r)t+=this[r]*e[r];return Me(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]*=t[r];return this.check()}divide(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]/=t[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return Nu(e>=0&&e<this.ELEMENTS,"index is out of range"),Me(this[e])}setComponent(e,t){return Nu(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}let Es=typeof Float32Array<"u"?Float32Array:Array;function Vu(s,e,t){const r=e[0],n=e[1],i=e[2];return s[0]=r*t[0]+n*t[3]+i*t[6],s[1]=r*t[1]+n*t[4]+i*t[7],s[2]=r*t[2]+n*t[5]+i*t[8],s}(function(){const s=function(){const e=new Es(2);return Es!=Float32Array&&(e[0]=0,e[1]=0),e}()})(),function(){const s=function(){const e=new Es(3);return Es!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}()}();const Ci=[0,0,0];let Ms;class Ti extends Ef{static get ZERO(){return Ms||(Ms=new Ti(0,0,0),Object.freeze(Ms)),Ms}constructor(e=0,t=0,r=0){super(-0,-0,-0),arguments.length===1&&Ss(e)?this.copy(e):(Ve.debug&&(Me(e),Me(t),Me(r)),this[0]=e,this[1]=t,this[2]=r)}set(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return Ve.debug&&(Me(e.x),Me(e.y),Me(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Me(e)}angle(e){return function(t,r){const n=t[0],i=t[1],o=t[2],c=r[0],d=r[1],g=r[2],b=Math.sqrt((n*n+i*i+o*o)*(c*c+d*d+g*g)),l=b&&function(x,m){return x[0]*m[0]+x[1]*m[1]+x[2]*m[2]}(t,r)/b;return Math.acos(Math.min(Math.max(l,-1),1))}(this,e)}cross(e){return function(t,r,n){const i=r[0],o=r[1],c=r[2],d=n[0],g=n[1],b=n[2];t[0]=o*b-c*g,t[1]=c*d-i*b,t[2]=i*g-o*d}(this,this,e),this.check()}rotateX({radians:e,origin:t=Ci}){return function(r,n,i,o){const c=[],d=[];c[0]=n[0]-i[0],c[1]=n[1]-i[1],c[2]=n[2]-i[2],d[0]=c[0],d[1]=c[1]*Math.cos(o)-c[2]*Math.sin(o),d[2]=c[1]*Math.sin(o)+c[2]*Math.cos(o),r[0]=d[0]+i[0],r[1]=d[1]+i[1],r[2]=d[2]+i[2]}(this,this,t,e),this.check()}rotateY({radians:e,origin:t=Ci}){return function(r,n,i,o){const c=[],d=[];c[0]=n[0]-i[0],c[1]=n[1]-i[1],c[2]=n[2]-i[2],d[0]=c[2]*Math.sin(o)+c[0]*Math.cos(o),d[1]=c[1],d[2]=c[2]*Math.cos(o)-c[0]*Math.sin(o),r[0]=d[0]+i[0],r[1]=d[1]+i[1],r[2]=d[2]+i[2]}(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=Ci}){return function(r,n,i,o){const c=[],d=[];c[0]=n[0]-i[0],c[1]=n[1]-i[1],c[2]=n[2]-i[2],d[0]=c[0]*Math.cos(o)-c[1]*Math.sin(o),d[1]=c[0]*Math.sin(o)+c[1]*Math.cos(o),d[2]=c[2],r[0]=d[0]+i[0],r[1]=d[1]+i[1],r[2]=d[2]+i[2]}(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return function(t,r,n){const i=r[0],o=r[1],c=r[2];let d=n[3]*i+n[7]*o+n[11]*c+n[15];d=d||1,t[0]=(n[0]*i+n[4]*o+n[8]*c+n[12])/d,t[1]=(n[1]*i+n[5]*o+n[9]*c+n[13])/d,t[2]=(n[2]*i+n[6]*o+n[10]*c+n[14])/d}(this,this,e),this.check()}transformAsVector(e){return function(t,r,n){const i=r[0],o=r[1],c=r[2],d=n[3]*i+n[7]*o+n[11]*c||1;t[0]=(n[0]*i+n[4]*o+n[8]*c)/d,t[1]=(n[1]*i+n[5]*o+n[9]*c)/d,t[2]=(n[2]*i+n[6]*o+n[10]*c)/d}(this,this,e),this.check()}transformByMatrix3(e){return Vu(this,this,e),this.check()}transformByMatrix2(e){return function(t,r,n){const i=r[0],o=r[1];t[0]=n[0]*i+n[2]*o,t[1]=n[1]*i+n[3]*o,t[2]=r[2]}(this,this,e),this.check()}transformByQuaternion(e){return function(t,r,n){const i=n[0],o=n[1],c=n[2],d=n[3],g=r[0],b=r[1],l=r[2];let x=o*l-c*b,m=c*g-i*l,_=i*b-o*g,w=o*_-c*m,f=c*x-i*_,p=i*m-o*x;const a=2*d;x*=a,m*=a,_*=a,w*=2,f*=2,p*=2,t[0]=g+x+w,t[1]=b+m+f,t[2]=l+_+p}(this,this,e),this.check()}}class Mf extends ku{toString(){let e="[";if(Ve.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let r=0;r<this.RANK;++r)e+=` ${this[r*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,r){return this[t*this.RANK+e]=Me(r),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const r=e*this.RANK;for(let n=0;n<this.RANK;++n)t[n]=this[r+n];return t}setColumn(e,t){const r=e*this.RANK;for(let n=0;n<this.RANK;++n)this[r+n]=t[n];return this}}function Hu(s,e,t){const r=e[0],n=e[1],i=e[2],o=e[3],c=e[4],d=e[5],g=e[6],b=e[7],l=e[8],x=t[0],m=t[1],_=t[2],w=t[3],f=t[4],p=t[5],a=t[6],u=t[7],h=t[8];return s[0]=x*r+m*o+_*g,s[1]=x*n+m*c+_*b,s[2]=x*i+m*d+_*l,s[3]=w*r+f*o+p*g,s[4]=w*n+f*c+p*b,s[5]=w*i+f*d+p*l,s[6]=a*r+u*o+h*g,s[7]=a*n+u*c+h*b,s[8]=a*i+u*d+h*l,s}function ju(s,e,t){const r=t[0],n=t[1];return s[0]=r*e[0],s[1]=r*e[1],s[2]=r*e[2],s[3]=n*e[3],s[4]=n*e[4],s[5]=n*e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s}var Si;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL1ROW0=3]="COL1ROW0",s[s.COL1ROW1=4]="COL1ROW1",s[s.COL1ROW2=5]="COL1ROW2",s[s.COL2ROW0=6]="COL2ROW0",s[s.COL2ROW1=7]="COL2ROW1",s[s.COL2ROW2=8]="COL2ROW2"})(Si||(Si={}));const Pf=Object.freeze([1,0,0,0,1,0,0,0,1]);class fr extends Mf{static get IDENTITY(){return function(){return Gs||(Gs=new fr,Object.freeze(Gs)),Gs}()}static get ZERO(){return function(){return Ps||(Ps=new fr([0,0,0,0,0,0,0,0,0]),Object.freeze(Ps)),Ps}()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return Si}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(Pf)}fromObject(e){return this.check()}fromQuaternion(e){return function(t,r){const n=r[0],i=r[1],o=r[2],c=r[3],d=n+n,g=i+i,b=o+o,l=n*d,x=i*d,m=i*g,_=o*d,w=o*g,f=o*b,p=c*d,a=c*g,u=c*b;t[0]=1-m-f,t[3]=x-u,t[6]=_+a,t[1]=x+u,t[4]=1-l-f,t[7]=w-p,t[2]=_-a,t[5]=w+p,t[8]=1-l-m}(this,e),this.check()}set(e,t,r,n,i,o,c,d,g){return this[0]=e,this[1]=t,this[2]=r,this[3]=n,this[4]=i,this[5]=o,this[6]=c,this[7]=d,this[8]=g,this.check()}setRowMajor(e,t,r,n,i,o,c,d,g){return this[0]=e,this[1]=n,this[2]=c,this[3]=t,this[4]=i,this[5]=d,this[6]=r,this[7]=o,this[8]=g,this.check()}determinant(){return function(e){const t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],c=e[5],d=e[6],g=e[7],b=e[8];return t*(b*o-c*g)+r*(-b*i+c*d)+n*(g*i-o*d)}(this)}transpose(){return function(e,t){if(e===t){const r=t[1],n=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(this,this),this.check()}invert(){return function(e,t){const r=t[0],n=t[1],i=t[2],o=t[3],c=t[4],d=t[5],g=t[6],b=t[7],l=t[8],x=l*c-d*b,m=-l*o+d*g,_=b*o-c*g;let w=r*x+n*m+i*_;w&&(w=1/w,e[0]=x*w,e[1]=(-l*n+i*b)*w,e[2]=(d*n-i*c)*w,e[3]=m*w,e[4]=(l*r-i*g)*w,e[5]=(-d*r+i*o)*w,e[6]=_*w,e[7]=(-b*r+n*g)*w,e[8]=(c*r-n*o)*w)}(this,this),this.check()}multiplyLeft(e){return Hu(this,e,this),this.check()}multiplyRight(e){return Hu(this,this,e),this.check()}rotate(e){return function(t,r,n){const i=r[0],o=r[1],c=r[2],d=r[3],g=r[4],b=r[5],l=r[6],x=r[7],m=r[8],_=Math.sin(n),w=Math.cos(n);t[0]=w*i+_*d,t[1]=w*o+_*g,t[2]=w*c+_*b,t[3]=w*d-_*i,t[4]=w*g-_*o,t[5]=w*b-_*c,t[6]=l,t[7]=x,t[8]=m}(this,this,e),this.check()}scale(e){return Array.isArray(e)?ju(this,this,e):ju(this,this,[e,e]),this.check()}translate(e){return function(t,r,n){const i=r[0],o=r[1],c=r[2],d=r[3],g=r[4],b=r[5],l=r[6],x=r[7],m=r[8],_=n[0],w=n[1];t[0]=i,t[1]=o,t[2]=c,t[3]=d,t[4]=g,t[5]=b,t[6]=_*i+w*d+l,t[7]=_*o+w*g+x,t[8]=_*c+w*b+m}(this,this,e),this.check()}transform(e,t){let r;switch(e.length){case 2:r=function(n,i,o){const c=i[0],d=i[1];return n[0]=o[0]*c+o[3]*d+o[6],n[1]=o[1]*c+o[4]*d+o[7],n}(t||[-0,-0],e,this);break;case 3:r=Vu(t||[-0,-0,-0],e,this);break;case 4:r=function(n,i,o){const c=i[0],d=i[1],g=i[2];return n[0]=o[0]*c+o[3]*d+o[6]*g,n[1]=o[1]*c+o[4]*d+o[7]*g,n[2]=o[2]*c+o[5]*d+o[8]*g,n[3]=i[3],n}(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Sf(r,e.length),r}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let Ps,Gs=null;const Rs="KHR_texture_transform",Gf=Rs,Ls=new Ti,Rf=new fr,Lf=new fr;function Of(s,e){var i,o,c,d;const t=(i=e.json.materials)==null?void 0:i[s],r=[(o=t==null?void 0:t.pbrMetallicRoughness)==null?void 0:o.baseColorTexture,t==null?void 0:t.emissiveTexture,t==null?void 0:t.normalTexture,t==null?void 0:t.occlusionTexture,(c=t==null?void 0:t.pbrMetallicRoughness)==null?void 0:c.metallicRoughnessTexture],n=[];for(const g of r)g&&((d=g==null?void 0:g.extensions)!=null&&d[Rs])&&If(e,s,g,n)}function If(s,e,t,r){const n=function(o,c){var x;const d=(x=o.extensions)==null?void 0:x[Rs],{texCoord:g=0}=o,{texCoord:b=g}=d;if(!(c.findIndex(([m,_])=>m===g&&_===b)!==-1)){const m=function(_){const{offset:w=[0,0],rotation:f=0,scale:p=[1,1]}=_,a=new fr().set(1,0,0,0,1,0,w[0],w[1],1),u=Rf.set(Math.cos(f),Math.sin(f),0,-Math.sin(f),Math.cos(f),0,0,0,1),h=Lf.set(p[0],0,0,0,p[1],0,0,0,1);return a.multiplyRight(u).multiplyRight(h)}(d);return g!==b&&(o.texCoord=b),c.push([g,b]),{originalTexCoord:g,texCoord:b,matrix:m}}return null}(t,r);if(!n)return;const i=s.json.meshes||[];for(const o of i)for(const c of o.primitives){const d=c.material;Number.isFinite(d)&&e===d&&Ff(s,c,n)}}function Ff(s,e,t){var c,d;const{originalTexCoord:r,texCoord:n,matrix:i}=t,o=e.attributes[`TEXCOORD_${r}`];if(Number.isFinite(o)){const g=(c=s.json.accessors)==null?void 0:c[o];if(g&&g.bufferView){const b=(d=s.json.bufferViews)==null?void 0:d[g.bufferView];if(b){const{arrayBuffer:l,byteOffset:x}=s.buffers[b.buffer],m=(x||0)+(g.byteOffset||0)+(b.byteOffset||0),{ArrayType:_,length:w}=hi(g,b),f=hu[g.componentType],p=du[g.type],a=b.byteStride||f*p,u=new Float32Array(w);for(let h=0;h<g.count;h++){const y=new _(l,m+h*a,2);Ls.set(y[0],y[1],1),Ls.transformByMatrix3(i),u.set([Ls[0],Ls[1]],h*p)}r===n?function(h,y,B,C){h.componentType=5126,B.push({arrayBuffer:C.buffer,byteOffset:0,byteLength:C.buffer.byteLength}),y.buffer=B.length-1,y.byteLength=C.buffer.byteLength,y.byteOffset=0,delete y.byteStride}(g,b,s.buffers,u):function(h,y,B,C,G){C.buffers.push({arrayBuffer:G.buffer,byteOffset:0,byteLength:G.buffer.byteLength});const U=C.json.bufferViews;if(!U)return;U.push({buffer:C.buffers.length-1,byteLength:G.buffer.byteLength,byteOffset:0});const k=C.json.accessors;k&&(k.push({bufferView:(U==null?void 0:U.length)-1,byteOffset:0,componentType:5126,count:y.count,type:"VEC2"}),B.attributes[`TEXCOORD_${h}`]=k.length-1)}(n,g,e,s,u)}}}}const Df=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s,e){var r;if(!new be(s).hasExtension(Rs)||!((r=e.gltf)!=null&&r.loadBuffers))return;const t=s.json.materials||[];for(let n=0;n<t.length;n++)Of(n,s)},name:Gf},Symbol.toStringTag,{value:"Module"})),Nt="KHR_lights_punctual",Uf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s){const e=new be(s),{json:t}=e,r=e.getExtension(Nt);r&&(e.json.lights=r.lights,e.removeExtension(Nt));for(const n of t.nodes||[]){const i=e.getObjectExtension(n,Nt);i&&(n.light=i.light),e.removeObjectExtension(n,Nt)}},encode:async function(s){const e=new be(s),{json:t}=e;if(t.lights){const r=e.addExtension(Nt);Se(!r.lights),r.lights=t.lights,delete t.lights}if(e.json.lights){for(const r of e.json.lights){const n=r.node;e.addObjectExtension(n,Nt,r)}delete e.json.lights}},name:Nt},Symbol.toStringTag,{value:"Module"})),Lr="KHR_materials_unlit",kf=Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s){const e=new be(s),{json:t}=e;for(const r of t.materials||[])r.extensions&&r.extensions.KHR_materials_unlit&&(r.unlit=!0),e.removeObjectExtension(r,Lr);e.removeExtension(Lr)},encode:function(s){const e=new be(s),{json:t}=e;if(e.materials)for(const r of t.materials||[])r.unlit&&(delete r.unlit,e.addObjectExtension(r,Lr,{}),e.addExtension(Lr))},name:Lr},Symbol.toStringTag,{value:"Module"})),Or="KHR_techniques_webgl",Nf=Or;function Vf(s,e){const t=Object.assign({},s.values);return Object.keys(s.uniforms||{}).forEach(r=>{s.uniforms[r].value&&!(r in t)&&(t[r]=s.uniforms[r].value)}),Object.keys(t).forEach(r=>{typeof t[r]=="object"&&t[r].index!==void 0&&(t[r].texture=e.getTexture(t[r].index))}),t}const Ju=[Ih,wh,pf,mf,gf,Cf,Uf,kf,Object.freeze(Object.defineProperty({__proto__:null,decode:async function(s){const e=new be(s),{json:t}=e,r=e.getExtension(Or);if(r){const n=function(i,o){const{programs:c=[],shaders:d=[],techniques:g=[]}=i,b=new TextDecoder;return d.forEach(l=>{if(!Number.isFinite(l.bufferView))throw new Error("KHR_techniques_webgl: no shader code");l.code=b.decode(o.getTypedArrayForBufferView(l.bufferView))}),c.forEach(l=>{l.fragmentShader=d[l.fragmentShader],l.vertexShader=d[l.vertexShader]}),g.forEach(l=>{l.program=c[l.program]}),g}(r,e);for(const i of t.materials||[]){const o=e.getObjectExtension(i,Or);o&&(i.technique=Object.assign({},o,n[o.technique]),i.technique.values=Vf(i.technique,e)),e.removeObjectExtension(i,Or)}e.removeExtension(Or)}},encode:async function(s,e){},name:Nf},Symbol.toStringTag,{value:"Module"})),Df,Jh];function zu(s,e){var r;const t=((r=e==null?void 0:e.gltf)==null?void 0:r.excludeExtensions)||{};return!(s in t&&!t[s])}const Ei="KHR_binary_glTF",Ku={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},Hf={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class jf{constructor(){ee(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}});ee(this,"json")}normalize(e,t){this.json=e.json;const r=e.json;switch(r.asset&&r.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return void console.warn(`glTF: Unknown version ${r.asset.version}`)}if(!t.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(r),this._convertTopLevelObjectsToArrays(r),function(n){const i=new be(n),{json:o}=i;for(const c of o.images||[]){const d=i.getObjectExtension(c,Ei);d&&Object.assign(c,d),i.removeObjectExtension(c,Ei)}o.buffers&&o.buffers[0]&&delete o.buffers[0].uri,i.removeExtension(Ei)}(e),this._convertObjectIdsToArrayIndices(r),this._updateObjects(r),this._updateMaterial(r)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const t in Ku)this._convertTopLevelObjectToArray(e,t)}_convertTopLevelObjectToArray(e,t){const r=e[t];if(r&&!Array.isArray(r)){e[t]=[];for(const n in r){const i=r[n];i.id=i.id||n;const o=e[t].length;e[t].push(i),this.idToIndexMap[t][n]=o}}}_convertObjectIdsToArrayIndices(e){for(const t in Ku)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const t of e.textures)this._convertTextureIds(t);for(const t of e.meshes)this._convertMeshIds(t);for(const t of e.nodes)this._convertNodeIds(t);for(const t of e.scenes)this._convertSceneIds(t)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const t of e.primitives){const{attributes:r,indices:n,material:i}=t;for(const o in r)r[o]=this._convertIdToIndex(r[o],"accessor");n&&(t.indices=this._convertIdToIndex(n,"accessor")),i&&(t.material=this._convertIdToIndex(i,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map(t=>this._convertIdToIndex(t,"node"))),e.meshes&&(e.meshes=e.meshes.map(t=>this._convertIdToIndex(t,"mesh")))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map(t=>this._convertIdToIndex(t,"node")))}_convertIdsToIndices(e,t){e[t]||(console.warn(`gltf v1: json doesn't contain attribute ${t}`),e[t]=[]);for(const r of e[t])for(const n in r){const i=r[n],o=this._convertIdToIndex(i,n);r[n]=o}}_convertIdToIndex(e,t){const r=Hf[t];if(r in this.idToIndexMap){const n=this.idToIndexMap[r][e];if(!Number.isFinite(n))throw new Error(`gltf v1: failed to resolve ${t} with id ${e}`);return n}return e}_updateObjects(e){for(const t of this.json.buffers)delete t.type}_updateMaterial(e){var t,r,n;for(const i of e.materials){i.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const o=((t=i.values)==null?void 0:t.tex)||((r=i.values)==null?void 0:r.texture2d_0)||((n=i.values)==null?void 0:n.diffuseTex),c=e.textures.findIndex(d=>d.id===o);c!==-1&&(i.pbrMetallicRoughness.baseColorTexture={index:c})}}}async function Jf(s,e,t=0,r,n){var i,o,c;return function(d,g,b,l){if(l.uri&&(d.baseUri=l.uri),g instanceof ArrayBuffer&&!function(_,w=0,f={}){const p=new DataView(_),{magic:a=Pu}=f,u=p.getUint32(w,!1);return u===a||u===Pu}(g,b,l)&&(g=new TextDecoder().decode(g)),typeof g=="string")d.json=kd(g);else if(g instanceof ArrayBuffer){const _={};b=sf(_,g,b,l.glb),Se(_.type==="glTF",`Invalid GLB magic string ${_.type}`),d._glb=_,d.json=_.json}else Se(!1,"GLTF: must be ArrayBuffer or string");const x=d.json.buffers||[];if(d.buffers=new Array(x.length).fill(null),d._glb&&d._glb.header.hasBinChunk){const{binChunks:_}=d._glb;d.buffers[0]={arrayBuffer:_[0].arrayBuffer,byteOffset:_[0].byteOffset,byteLength:_[0].byteLength}}const m=d.json.images||[];d.images=new Array(m.length).fill({})}(s,e,t,r),function(d,g={}){new jf().normalize(d,g)}(s,{normalize:(i=r==null?void 0:r.gltf)==null?void 0:i.normalize}),function(d,g={},b){var x;const l=Ju.filter(m=>zu(m.name,g));for(const m of l)(x=m.preprocess)==null||x.call(m,d,g,b)}(s,r,n),(o=r==null?void 0:r.gltf)!=null&&o.loadBuffers&&s.json.buffers&&await async function(d,g,b){var x,m;const l=d.json.buffers||[];for(let _=0;_<l.length;++_){const w=l[_];if(w.uri){const{fetch:f}=b;Se(f);const p=Gu(w.uri,g),a=await((x=b==null?void 0:b.fetch)==null?void 0:x.call(b,p)),u=await((m=a==null?void 0:a.arrayBuffer)==null?void 0:m.call(a));d.buffers[_]={arrayBuffer:u,byteOffset:0,byteLength:u.byteLength},delete w.uri}else d.buffers[_]===null&&(d.buffers[_]={arrayBuffer:new ArrayBuffer(w.byteLength),byteOffset:0,byteLength:w.byteLength})}}(s,r,n),(c=r==null?void 0:r.gltf)!=null&&c.loadImages&&await async function(d,g,b){const l=function(_){const w=new Set,f=_.json.textures||[];for(const p of f)p.source!==void 0&&w.add(p.source);return Array.from(w).sort()}(d),x=d.json.images||[],m=[];for(const _ of l)m.push(zf(d,x[_],_,g,b));return await Promise.all(m)}(s,r,n),await async function(d,g={},b){var x;const l=Ju.filter(m=>zu(m.name,g));for(const m of l)await((x=m.decode)==null?void 0:x.call(m,d,g,b))}(s,r,n),s}async function zf(s,e,t,r,n){let i;if(e.uri&&!e.hasOwnProperty("bufferView")){const c=Gu(e.uri,r),{fetch:d}=n;i=await(await d(c)).arrayBuffer(),e.bufferView={data:i}}if(Number.isFinite(e.bufferView)){const c=function(d,g,b){const l=d.bufferViews[b];Se(l);const x=g[l.buffer];Se(x);const m=(l.byteOffset||0)+x.byteOffset;return new Uint8Array(x.arrayBuffer,m,l.byteLength)}(s.json,s.buffers,e.bufferView);i=Ia(c.buffer,c.byteOffset,c.byteLength)}Se(i,"glTF image has no data");let o=await Ba(i,[hh,ef],{...r,mimeType:e.mimeType,basis:r.basis||{format:Mu()}},n);o&&o[0]&&(o={compressed:!0,mipmaps:!1,width:o[0].width,height:o[0].height,data:o[0]}),s.images=s.images||[],s.images[t]=o}const Mi={dataType:null,batchType:null,name:"glTF",id:"gltf",module:"gltf",version:"4.3.2",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:async function(s,e={},t){(e={...Mi.options,...e}).gltf={...Mi.options.gltf,...e.gltf};const{byteOffset:r=0}=e;return await Jf({},s,r,e,t)},options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0},log:console}},Kf={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Xf={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},Xu=10240,Wu=10241,Yu=10242,qu=10243,Qu=10497,Wf=9729,Yf=9986,qf={magFilter:Xu,minFilter:Wu,wrapS:Yu,wrapT:qu},Qf={[Xu]:Wf,[Wu]:Yf,[Yu]:Qu,[qu]:Qu};class $f{constructor(){ee(this,"baseUri","");ee(this,"jsonUnprocessed");ee(this,"json");ee(this,"buffers",[]);ee(this,"images",[])}postProcess(e,t={}){const{json:r,buffers:n=[],images:i=[]}=e,{baseUri:o=""}=e;return Se(r),this.baseUri=o,this.buffers=n,this.images=i,this.jsonUnprocessed=r,this.json=this._resolveTree(e.json,t),this.json}_resolveTree(e,t={}){const r={...e};return this.json=r,e.bufferViews&&(r.bufferViews=e.bufferViews.map((n,i)=>this._resolveBufferView(n,i))),e.images&&(r.images=e.images.map((n,i)=>this._resolveImage(n,i))),e.samplers&&(r.samplers=e.samplers.map((n,i)=>this._resolveSampler(n,i))),e.textures&&(r.textures=e.textures.map((n,i)=>this._resolveTexture(n,i))),e.accessors&&(r.accessors=e.accessors.map((n,i)=>this._resolveAccessor(n,i))),e.materials&&(r.materials=e.materials.map((n,i)=>this._resolveMaterial(n,i))),e.meshes&&(r.meshes=e.meshes.map((n,i)=>this._resolveMesh(n,i))),e.nodes&&(r.nodes=e.nodes.map((n,i)=>this._resolveNode(n,i)),r.nodes=r.nodes.map((n,i)=>this._resolveNodeChildren(n))),e.skins&&(r.skins=e.skins.map((n,i)=>this._resolveSkin(n,i))),e.scenes&&(r.scenes=e.scenes.map((n,i)=>this._resolveScene(n,i))),typeof this.json.scene=="number"&&r.scenes&&(r.scene=r.scenes[this.json.scene]),r}getScene(e){return this._get(this.json.scenes,e)}getNode(e){return this._get(this.json.nodes,e)}getSkin(e){return this._get(this.json.skins,e)}getMesh(e){return this._get(this.json.meshes,e)}getMaterial(e){return this._get(this.json.materials,e)}getAccessor(e){return this._get(this.json.accessors,e)}getCamera(e){return this._get(this.json.cameras,e)}getTexture(e){return this._get(this.json.textures,e)}getSampler(e){return this._get(this.json.samplers,e)}getImage(e){return this._get(this.json.images,e)}getBufferView(e){return this._get(this.json.bufferViews,e)}getBuffer(e){return this._get(this.json.buffers,e)}_get(e,t){if(typeof t=="object")return t;const r=e&&e[t];return r||console.warn(`glTF file error: Could not find ${e}[${t}]`),r}_resolveScene(e,t){return{...e,id:e.id||`scene-${t}`,nodes:(e.nodes||[]).map(r=>this.getNode(r))}}_resolveNode(e,t){const r={...e,id:(e==null?void 0:e.id)||`node-${t}`};return e.mesh!==void 0&&(r.mesh=this.getMesh(e.mesh)),e.camera!==void 0&&(r.camera=this.getCamera(e.camera)),e.skin!==void 0&&(r.skin=this.getSkin(e.skin)),e.meshes!==void 0&&e.meshes.length&&(r.mesh=e.meshes.reduce((n,i)=>{const o=this.getMesh(i);return n.id=o.id,n.primitives=n.primitives.concat(o.primitives),n},{primitives:[]})),r}_resolveNodeChildren(e){return e.children&&(e.children=e.children.map(t=>this.getNode(t))),e}_resolveSkin(e,t){const r=typeof e.inverseBindMatrices=="number"?this.getAccessor(e.inverseBindMatrices):void 0;return{...e,id:e.id||`skin-${t}`,inverseBindMatrices:r}}_resolveMesh(e,t){const r={...e,id:e.id||`mesh-${t}`,primitives:[]};return e.primitives&&(r.primitives=e.primitives.map(n=>{const i={...n,attributes:{},indices:void 0,material:void 0},o=n.attributes;for(const c in o)i.attributes[c]=this.getAccessor(o[c]);return n.indices!==void 0&&(i.indices=this.getAccessor(n.indices)),n.material!==void 0&&(i.material=this.getMaterial(n.material)),i})),r}_resolveMaterial(e,t){const r={...e,id:e.id||`material-${t}`};if(r.normalTexture&&(r.normalTexture={...r.normalTexture},r.normalTexture.texture=this.getTexture(r.normalTexture.index)),r.occlusionTexture&&(r.occlusionTexture={...r.occlusionTexture},r.occlusionTexture.texture=this.getTexture(r.occlusionTexture.index)),r.emissiveTexture&&(r.emissiveTexture={...r.emissiveTexture},r.emissiveTexture.texture=this.getTexture(r.emissiveTexture.index)),r.emissiveFactor||(r.emissiveFactor=r.emissiveTexture?[1,1,1]:[0,0,0]),r.pbrMetallicRoughness){r.pbrMetallicRoughness={...r.pbrMetallicRoughness};const n=r.pbrMetallicRoughness;n.baseColorTexture&&(n.baseColorTexture={...n.baseColorTexture},n.baseColorTexture.texture=this.getTexture(n.baseColorTexture.index)),n.metallicRoughnessTexture&&(n.metallicRoughnessTexture={...n.metallicRoughnessTexture},n.metallicRoughnessTexture.texture=this.getTexture(n.metallicRoughnessTexture.index))}return r}_resolveAccessor(e,t){const r=(n=e.componentType,Xf[n]);var n;const i=(o=e.type,Kf[o]);var o;const c=r*i,d={...e,id:e.id||`accessor-${t}`,bytesPerComponent:r,components:i,bytesPerElement:c,value:void 0,bufferView:void 0,sparse:void 0};if(e.bufferView!==void 0&&(d.bufferView=this.getBufferView(e.bufferView)),d.bufferView){const g=d.bufferView.buffer,{ArrayType:b,byteLength:l}=hi(d,d.bufferView),x=(d.bufferView.byteOffset||0)+(d.byteOffset||0)+g.byteOffset;let m=g.arrayBuffer.slice(x,x+l);d.bufferView.byteStride&&(m=this._getValueFromInterleavedBuffer(g,x,d.bufferView.byteStride,d.bytesPerElement,d.count)),d.value=new b(m)}return d}_getValueFromInterleavedBuffer(e,t,r,n,i){const o=new Uint8Array(i*n);for(let c=0;c<i;c++){const d=t+c*r;o.set(new Uint8Array(e.arrayBuffer.slice(d,d+n)),c*n)}return o.buffer}_resolveTexture(e,t){return{...e,id:e.id||`texture-${t}`,sampler:typeof e.sampler=="number"?this.getSampler(e.sampler):{id:"default-sampler",parameters:Qf},source:typeof e.source=="number"?this.getImage(e.source):void 0}}_resolveSampler(e,t){const r={id:e.id||`sampler-${t}`,...e,parameters:{}};for(const n in r){const i=this._enumSamplerParameter(n);i!==void 0&&(r.parameters[i]=r[n])}return r}_enumSamplerParameter(e){return qf[e]}_resolveImage(e,t){const r={...e,id:e.id||`image-${t}`,image:null,bufferView:e.bufferView!==void 0?this.getBufferView(e.bufferView):void 0},n=this.images[t];return n&&(r.image=n),r}_resolveBufferView(e,t){const r=e.buffer,n=this.buffers[r].arrayBuffer;let i=this.buffers[r].byteOffset||0;return e.byteOffset&&(i+=e.byteOffset),{id:`bufferView-${t}`,...e,buffer:this.buffers[r],data:new Uint8Array(n,i,e.byteLength)}}_resolveCamera(e,t){const r={...e,id:e.id||`camera-${t}`};return r.perspective,r.orthographic,r}}let Os,Is,Pi,Gi;const an=class an extends $e{static get defaultGLTFLayout(){if(Is)return Is;const e=[{shaderLocation:ke.Position,format:"float32x3",offset:0}],t=[{shaderLocation:ke.Normal,format:"float32x3",offset:0}],r=[{shaderLocation:ke.TexCoord,format:"float32x2",offset:0}],n=[{shaderLocation:ke.Tangent,format:"float32x4",offset:0}];return Is=[{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:e},{arrayStride:3*Float32Array.BYTES_PER_ELEMENT,attributes:t},{arrayStride:2*Float32Array.BYTES_PER_ELEMENT,attributes:r},{arrayStride:4*Float32Array.BYTES_PER_ELEMENT,attributes:n}],Is}static get defaultLayout(){if(Os)return Os;const e=[{shaderLocation:ke.Position,offset:0,format:"float32x3"},{shaderLocation:ke.Normal,offset:3*Float32Array.BYTES_PER_ELEMENT,format:"float32x3"},{shaderLocation:ke.TexCoord,offset:6*Float32Array.BYTES_PER_ELEMENT,format:"float32x2"},{shaderLocation:ke.Tangent,offset:8*Float32Array.BYTES_PER_ELEMENT,format:"float32x4"}];return Os=[{arrayStride:an.itemsPerVertexDefaultLayout*Float32Array.BYTES_PER_ELEMENT,attributes:e}],Os}};an.itemsPerVertexDefaultLayout=12;let xe=an;class $u{constructor(){this.min=D.create(),this.max=D.create(),this._temp=D.create()}get minX(){return this.min[0]}get minY(){return this.min[1]}get minZ(){return this.min[2]}get maxX(){return this.max[0]}get maxY(){return this.max[1]}get maxZ(){return this.max[2]}getArea(){const e=this.max[0]-this.min[0],t=this.max[1]-this.min[1],r=this.max[2]-this.min[2];return 2*(e*e+t*t+r*r)}setMinAABB(e,t,r){this.min[0]=e,this.min[1]=t,this.min[2]=r}setMinAABBfromGLTF(e){this.setMinAABB(e[0],e[1],e[2])}setMaxAABB(e,t,r){this.max[0]=e,this.max[1]=t,this.max[2]=r}setMaxAABBfromGLTF(e){this.setMaxAABB(e[0],e[1],e[2])}get boundingBoxCenter(){return this.getBoundingBoxCenter()}getBoundingBoxCenter(){return this._temp[0]=this.max[0]-this.min[0],this._temp[1]=this.max[1]-this.min[1],this._temp[2]=this.max[2]-this.min[2],this._temp}}class Fs{constructor(){this.faces=[],this.boundingBox=new $u,this.vertexBuffers=[],this.indexCount=0,this.vertexBufferOffsets=new Map,this.indexBufferOffsets=[0,0]}createBuffersWithTangentsManually(e,t,r,n,i){this.indexCount=e;const o=D.create(),c=D.create(),d=new Float32Array(xe.itemsPerVertexDefaultLayout*e),g=new Array(t.length).fill(null).map(h=>D.create()),b=new Array(t.length).fill(null).map(h=>D.create());for(const h of this.faces)a(h);let l=Number.POSITIVE_INFINITY,x=Number.POSITIVE_INFINITY,m=Number.POSITIVE_INFINITY,_=Number.NEGATIVE_INFINITY,w=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let h=0;h<i.length;h+=3){const y=i[h+0],B=i[h+1],C=i[h+2];p(y),p(B),p(C)}function p(h){const y=r[h],B=t[h],C=n[h],G=g[h];l=Math.min(l,B[0]),x=Math.min(x,B[1]),m=Math.min(m,B[2]),_=Math.max(_,B[0]),w=Math.max(w,B[1]),f=Math.max(f,B[2]);const U=D.normalize(D.sub(G,D.mulScalar(y,D.dot(y,G)))),k=D.normalize(D.cross(y,G)),T=D.dot(k,b[h])<0?-1:1,S=h*xe.itemsPerVertexDefaultLayout;d[S+0]=B[0],d[S+1]=B[1],d[S+2]=B[2],d[S+3]=y[0],d[S+4]=y[1],d[S+5]=y[2],d[S+6]=C[0],d[S+7]=C[1],d[S+8]=U[0],d[S+9]=U[1],d[S+10]=U[2],d[S+11]=T}function a(h){const y=D.sub(h.p1,h.p0),B=D.sub(h.p2,h.p0),C=Ce.sub(h.texCoord1,h.texCoord0),G=Ce.sub(h.texCoord2,h.texCoord0),U=1/(C[0]*G[1]-G[0]*C[1]);o[0]=U*(G[1]*y[0]-C[1]*B[0]),o[1]=U*(G[1]*y[1]-C[1]*B[1]),o[2]=U*(G[1]*y[2]-C[1]*B[2]),c[0]=U*(-G[0]*y[0]+C[0]*B[0]),c[1]=U*(-G[0]*y[1]+C[0]*B[1]),c[2]=U*(-G[0]*y[2]+C[0]*B[2]),D.normalize(o,o),D.normalize(c,c),D.add(g[h.indexV0],o,g[h.indexV0]),D.add(g[h.indexV1],o,g[h.indexV1]),D.add(g[h.indexV2],o,b[h.indexV2]),D.add(b[h.indexV0],c,b[h.indexV0]),D.add(b[h.indexV1],c,b[h.indexV1]),D.add(b[h.indexV2],c,b[h.indexV2])}this.boundingBox.setMinAABB(l,x,m),this.boundingBox.setMaxAABB(_,w,f);const u=v.device.createBuffer({mappedAtCreation:!0,size:e*xe.itemsPerVertexDefaultLayout*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX,label:"Mesh Interleaved Vertex GPUBuffer"});W.addBufferBytes(u),new Float32Array(u.getMappedRange()).set(d,0),u.unmap(),this.vertexBuffers.push(u),this.vertexBufferOffsets.set(u,[0,0]),this.indexBuffer=v.device.createBuffer({mappedAtCreation:!0,size:Uint16Array.BYTES_PER_ELEMENT*i.length,usage:GPUBufferUsage.INDEX,label:"Mesh Index GPUBuffer"}),W.addBufferBytes(this.indexBuffer),new Uint16Array(this.indexBuffer.getMappedRange()).set(i),this.indexBuffer.unmap(),this.indexBufferOffsets=[0,0]}}class Zf extends Fs{constructor(e,t){super(),this.gpuBuffers=t,this.firstIndex=0;const r=e.attributes.POSITION,n=e.attributes.NORMAL,i=e.attributes.TEXCOORD_0,o=e.attributes.TANGENT;if(!r)throw new Error("GLTF Mesh needs to have vertices array");[r,n,i,o].forEach(g=>{if(!g){const x=v.device.createBuffer({label:"Vertex Buffer Placeholder",size:1,usage:GPUBufferUsage.VERTEX});return this.vertexBufferOffsets.set(x,[0,1]),W.addBufferBytes(x),void this.vertexBuffers.push(x)}const b=g.bufferView,l=this.gpuBuffers.get(b.id);this.vertexBuffers.push(l),this.vertexBufferOffsets.set(l,[0,0])});const c=e.indices.bufferView,d=this.gpuBuffers.get(c.id);this.indexBufferOffsets[0]=e.indices.byteOffset,this.indexBufferOffsets[1]=e.indices.count*e.indices.bytesPerElement,this.indexCount=e.indices.count,this.indexBuffer=d}}const Zu=new Map,Vt=WebGLRenderingContext;class He extends $e{static get defaultNearestSampler(){return Pi||(Pi=this.createSampler({minFilter:"nearest",magFilter:"nearest"}),Pi)}static get defaultSampler(){return Gi||(Gi=this.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear",maxAnisotropy:4}),Gi)}static createSampler(e){const t=structuredClone(e);t.label&&delete t.label;const r=JSON.stringify(t);let n;return(n=Zu.get(r))||(n=v.device.createSampler(e),Zu.set(r,n)),n}static getSamplerFromGltfSamplerDef(e){function t(n){switch(n){case Vt.CLAMP_TO_EDGE:return"clamp-to-edge";case Vt.MIRRORED_REPEAT:return"mirror-repeat";default:return"repeat"}}const r={addressModeU:t(e.wrapS),addressModeV:t(e.wrapT)};switch(e.magFilter&&e.magFilter!=Vt.LINEAR||(r.magFilter="linear"),e.minFilter){case Vt.LINEAR:case Vt.LINEAR_MIPMAP_NEAREST:r.minFilter="linear";break;case Vt.NEAREST_MIPMAP_LINEAR:r.mipmapFilter="linear";break;case Vt.LINEAR_MIPMAP_LINEAR:default:r.minFilter="linear",r.mipmapFilter="linear"}return r.maxAnisotropy=16,this.createSampler(r)}}function Ri(s,e){if(s[3]!==0){var t=(r=1,n=s[3]-136,r*Math.pow(2,n));e[0]=s[0]*t,e[1]=s[1]*t,e[2]=s[2]*t}else e[0]=e[1]=e[2]=0;var r,n}function Li(s,e){var t=s[0],r=s[1],n=s[2],i=Math.max(t,Math.max(r,n));if(i<9999999999999999e-48)e[0]=e[1]=e[2]=e[3]=0;else{var o=function(b){var l={f:b=Number(b),e:0};if(b!==0&&Number.isFinite(b)){for(var x=Math.abs(b),m=Math.log2||function(f){return Math.log(f)*Math.LOG2E},_=Math.max(-1023,Math.floor(m(x))+1),w=x*Math.pow(2,-_);w>=1;)w*=.5,_++;for(;w<.5;)w*=2,_--;b<0&&(w=-w),l.f=w,l.e=_}return l}(i),c=o.f,d=o.e,g=c/i*256;e[0]=t*g,e[1]=r*g,e[2]=n*g,e[3]=d+128}}function ec(s,e,t){var r=[];return function(n,i,o,c,d){if(!(o<=0||i<=0||!d)){var g=`#?RADIANCE
# Written by hdr.js
FORMAT=32-bit_rle_rgbe
EXPOSURE=1.0

-Y `+o+" +X "+i+`
`;g.split("").forEach(function(x){var m=x.charCodeAt(0);n.push(m)});for(var b=new Uint8Array(4*i),l=0;l<o;l++)ep(n,i,c,b,d.subarray(c*i*l))}}(r,s,e,3,t),new Uint8Array(r)}function ep(s,e,t,r,n){var i,o=new Uint8Array([2,2,0,0]),c=new Uint8Array(4),d=new Float32Array(3);if(o[2]=(65280&e)>>8,o[3]=255&e,e<8||e>=32768)for(i=0;i<e;i++){switch(t){case 4:case 3:d[2]=n[i*t+2],d[1]=n[i*t+1],d[0]=n[i*t+0];break;default:d[0]=d[1]=d[2]=n[i*t+0]}Li(d,c),s.push(c[0],c[1],c[2],c[3])}else{var g=void 0,b=void 0;for(i=0;i<e;i++){switch(t){case 4:case 3:d[2]=n[i*t+2],d[1]=n[i*t+1],d[0]=n[i*t+0];break;default:d[0]=d[1]=d[2]=n[i*t+0]}Li(d,c),r[i+0*e]=c[0],r[i+1*e]=c[1],r[i+2*e]=c[2],r[i+3*e]=c[3]}for(s.push(o[0],o[1],o[2],o[3]),g=0;g<4;g++){var l=r.subarray(e*g);for(i=0;i<e;){for(b=i;b+2<e&&(l[b]!==l[b+1]||l[b]!==l[b+2]);)++b;for(b+2>=e&&(b=e);i<b;)(x=b-i)>128&&(x=128),tp(s,x,l.subarray(i)),i+=x;if(b+2<e){for(;b<e&&l[b]==l[i];)++b;for(;i<b;){var x;(x=b-i)>127&&(x=127),rp(s,x,l[i]),i+=x}}}}}}function tp(s,e,t){var r=255&e;if(!(e<=128))throw new Error("length is greater than 128");s.push(r);for(var n=0;n<e;n++)s.push(t[n])}function rp(s,e,t){var r=e+128&255;if(!(e+128<=255))throw new Error("length is greater than 128");s.push(r,t)}function tc(s,e){for(var t=e.length,r=0;r<t;r++)if(s[r]!==e.charCodeAt(r))return!1;return!0}var sp=10240,rc=1<<24;function sc(s){var e="",t=0;if(!function(T){var S=tc(T,`#?RADIANCE
`);return S||(S=tc(T,`#?RGBE
`)),S}(s))return"Corrupt HDR image.";for(;!e.match(/\n\n[^\n]+\n/g)&&t<sp;)e+=String.fromCharCode(s[t++]);var r=e.match(/FORMAT=(.*)$/m)[1];if(r!=="32-bit_rle_rgbe")return"Unsupported HDR format: "+r;var n=e.split(/\n/).reverse()[1].split(" ");if(n[0]!=="-Y"||n[2]!=="+X")return"Unsupported HDR format";var i,o,c=Number.parseFloat(n[3]),d=Number.parseFloat(n[1]);if(c>rc||d>rc)return"Very large image (corrupt?)";var g=s[t],b=s[t+1],l=s[t+2],x=g!==2||b!==2||!!(128&l),m=new Float32Array(c*d*3);if(c<8||c>=32768||x)for(o=0;o<d;++o)for(i=0;i<c;++i){var _=s.subarray(t,t+4);t+=4;var w=3*(o*c+i);Ri(_,m.subarray(w,w+3))}else for(var f,p,a,u=void 0,h=0;h<d;h++){if(f=s[t++],p=s[t++],a=s[t++],f!==2||p!==2||128&a)return"Invalid scanline";if(a<<=8,(a|=s[t++])!==c)return"invalid decoded scanline length";u||(u=new Uint8Array(4*c));for(var y=void 0,B=void 0,C=0;C<4;C++){var G=void 0;for(i=0;(G=c-i)>0;)if((y=s[t++])>128){if(B=s[t++],(y-=128)>G)return"bad RLE data in HDR";for(var U=0;U<y;U++)u[4*i+++C]=B}else{if(y>G)return"bad RLE data in HDR";for(U=0;U<y;U++)u[4*i+++C]=s[t++]}}for(var k=0;k<c;k++)Ri(u.subarray(4*k),m.subarray(3*(h*c+k)))}return{rgbFloat:m,width:c,height:d}}var np=Object.freeze({load:function(s){return new Promise(function(e,t){typeof XMLHttpRequest>"u"&&t("XMLHttpRequest is undefined, use HDRjs.read instead.");var r=new XMLHttpRequest;r.responseType="arraybuffer",r.onload=function(){if(r.status>=400)return t("Load successfully, but HTTP status code >= 400, status: "+r.status);var n=sc(new Uint8Array(r.response));typeof n=="string"?t(n):e(n)},r.onerror=function(n){t("Failed to load: "+s)},r.open("GET",s,!0),r.send()})},save:function(s,e,t,r){if(!(document!=null&&document.createElement)||!(URL!=null&&URL.createObjectURL))return console.warn("NO document.createElement or URL.createObjectURL"),!1;var n=ec(e,t,s),i=URL.createObjectURL(new Blob([n])),o=document.createElement("a");return o.href=i,o.download=r+".hdr",o.rel="noopener",setTimeout(function(){URL.revokeObjectURL(o.href)},4e4),setTimeout(function(){(function(c){try{c.dispatchEvent(new MouseEvent("click"))}catch{var d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),c.dispatchEvent(d)}})(o)},0),!0},read:sc,write:ec,float2rgbe:Li,rgbe2float:Ri});const nc="vertexMain",ic="fragmentMain",oc=`
  ${Y.VertexInput}
  ${Y.VertexOutput}

  @group(0) @binding(0) var<uniform> projViewMatrix: mat4x4f;
  @group(0) @binding(1) var inTexture: texture_2d<f32>;
  @group(0) @binding(2) var inSampler: sampler;

  const invAtan = vec2(0.1591, 0.3183);
  fn SampleSphericalMap(v: vec3f) -> vec2f {
    var uv = vec2f(atan(v.z / v.x), asin(v.y));
    uv *= invAtan;
    uv += 0.5;
    return uv;
  }


  @vertex
  fn ${nc}(in: VertexInput) -> VertexOutput {
    var out: VertexOutput;
    out.position = projViewMatrix * in.position;
    // hijack
    out.viewNormal = in.position.xyz;
    return out;
  }

  @fragment
  fn ${ic}(in: VertexOutput) -> @location(0) vec4f {
    let uv = SampleSphericalMap(normalize(in.normal.rgb)); // make sure to normalize localPos
    let color = textureSample(inTexture, inSampler, uv).rgb;
    return vec4f(color, 1);
  }
`;let Ds,Us,ks,Ns,Vs;const Oi=new Map([]),j={get defaultCameraPlusLightsBindGroupLayout(){if(Us)return Us;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}];return Us=v.device.createBindGroupLayout({label:"Camera + Lights GPUBindGroupLayout",entries:s}),Us},get defaultCameraBindGroupLayout(){if(Ds)return Ds;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return Ds=v.device.createBindGroupLayout({label:"Camera GPUBindGroupLayout",entries:s}),Ds},get defaultModelBindGroupLayout(){if(ks)return ks;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return ks=v.device.createBindGroupLayout({label:"Model GPUBindGroupLayout",entries:s}),ks},get defaultModelMaterialBindGroupLayout(){if(Ns)return Ns;const s=[{binding:ls.Default,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:pe.Albedo,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:pe.Normal,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:pe.MetallicRoughness,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}];return Ns=v.device.createBindGroupLayout({label:"Model Textures GPUBindGroupLayout",entries:s}),Ns},get instancesBindGroupLayout(){if(Vs)return Vs;const s=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}];return Vs=v.device.createBindGroupLayout({label:"Instance Models GPUBindGroupLayout",entries:s}),Vs},createShaderModule:(s,e=`Shader Module #${Oi.size}`)=>{let t;return(t=Oi.get(s))||(t=v.device.createShaderModule({label:e,code:s}),Oi.set(s,t)),t},createRenderPipeline:s=>v.device.createRenderPipeline(s),createComputePipeline:s=>v.device.createComputePipeline(s)};class pr{constructor(e,t,r,n,i,o,c,d,g,b,l,x){this.indexV0=e,this.indexV1=t,this.indexV2=r,this.p0=n,this.p1=i,this.p2=o,this.n0=c,this.n1=d,this.v2=g,this.texCoord0=b,this.texCoord1=l,this.texCoord2=x,this.centroid=D.create(),this.computeCetroid()}computeCetroid(){this.centroid[0]=(this.p0[0]+this.p1[0]+this.p2[0])/3,this.centroid[1]=(this.p0[1]+this.p1[1]+this.p2[1])/3,this.centroid[2]=(this.p0[2]+this.p1[2]+this.p2[2])/3}getArea(){const e=D.sub(this.p2,this.p1),t=D.sub(this.p0,this.p1);return .5*D.len(D.cross(e,t))}}class ac extends Fs{constructor(e=1,t=1,r=1,n=1,i=1,o=1){super(),this.width=e,this.height=t,this.depth=r,this.widthSegments=n,this.heightSegments=i,this.depthSegments=o,n=Math.floor(n),i=Math.floor(i),o=Math.floor(o);const c=[],d=[],g=[],b=[];let l=0;function x(m,_,w,f,p,a,u,h,y,B){const C=a/y,G=u/B,U=a/2,k=u/2,T=h/2,S=y+1,P=B+1;let L=0;const F=D.create();for(let O=0;O<P;O++){const H=O*G-k;for(let K=0;K<S;K++){const X=K*C-U;F[m]=X*f,F[_]=H*p,F[w]=T,d.push(D.clone(F)),F[m]=0,F[_]=0,F[w]=h>0?1:-1,g.push(D.clone(F)),b.push(Ce.create(K/y,1-O/B)),L+=1}}for(let O=0;O<B;O++)for(let H=0;H<y;H++){const K=l+H+S*O,X=l+H+S*(O+1),z=l+(H+1)+S*(O+1),J=l+(H+1)+S*O;c.push(K,X,J);const Q=new pr(K,X,J,d[K],d[X],d[J],g[K],g[X],g[J],b[K],b[X],b[J]);this.faces.push(Q),c.push(X,z,J);const Z=new pr(X,z,J,d[X],d[z],d[J],g[X],g[z],g[J],b[X],b[z],b[J]);this.faces.push(Z)}l+=L}x.call(this,2,1,0,-1,-1,r,t,e,o,i),x.call(this,2,1,0,1,-1,r,t,-e,o,i),x.call(this,0,2,1,1,1,e,r,t,n,o),x.call(this,0,2,1,1,-1,e,r,-t,n,o),x.call(this,0,1,2,1,-1,e,t,r,n,i),x.call(this,0,1,2,-1,-1,e,t,-r,n,i),this.createBuffersWithTangentsManually(c.length,d,g,b,new Uint16Array(c))}}class ip{constructor(){this.isReflective=!0,this.metallic=.1,this.roughness=.8,this._baseColor=D.create()}get color(){return this._baseColor}set color(e){this.setColor(e[0],e[1],e[2])}setColorR(e){this._baseColor[0]=e}setColorG(e){this._baseColor[1]=e}setColorB(e){this._baseColor[2]=e}setColor(e,t,r){this._baseColor[0]=e,this._baseColor[1]=t,this._baseColor[2]=r}}const un=class un extends nr{constructor(e){super(),this.materialProps=new ip,this.firstIndex=0,this.baseVertex=0,this.firstInstance=0,this.instanceCount=1,this.isOpaque=!0,this.modelMaterialBindGroupEntries=[],this.uploadModelBufferToGPU=!0,this.materials=new Map,this.textures=new Map,this._worldBoundingBox=new $u,this._sampler=He.defaultSampler,this.geometry=e;const t=Ot(Y.ModelUniform);this.bufferUniformValues=yt(t.structs.ModelUniform),this.modelBuffer=v.device.createBuffer({label:`${this.label} Model GPUBuffer`,size:this.bufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),W.addBufferBytes(this.modelBuffer);const r=[{binding:0,resource:{buffer:this.modelBuffer}}];this.modelBindGroup=v.device.createBindGroup({layout:j.defaultModelBindGroupLayout,entries:r}),this.modelMaterialBindGroupEntries=[{binding:ls.Default,resource:this.sampler},{binding:pe.Albedo,resource:Be.dummyTexture.createView()},{binding:pe.Normal,resource:Be.dummyTexture.createView()},{binding:pe.MetallicRoughness,resource:Be.dummyTexture.createView()}],this.texturesBindGroup=v.device.createBindGroup({label:"Model Textures Bind Group",layout:j.defaultModelMaterialBindGroupLayout,entries:this.modelMaterialBindGroupEntries}),this.setTexture(Be.dummyTexture,pe.Albedo),this.setTexture(Be.dummyTexture,pe.Normal),this.setTexture(Be.dummyTexture,pe.MetallicRoughness)}get worldBoundingBox(){return D.transformMat4(this.geometry.boundingBox.min,this.modelMatrix,this._worldBoundingBox.min),D.transformMat4(this.geometry.boundingBox.max,this.modelMatrix,this._worldBoundingBox.max),this._worldBoundingBox}get boundingBox(){return this.geometry.boundingBox}set boundingBox(e){this.geometry.boundingBox=e}get sampler(){return this.getSampler()}set sampler(e){this.setSampler(e),this.modelMaterialBindGroupEntries[0].resource=e,this.updateTexturesBindGroup()}getSampler(){return this._sampler}setSampler(e){this._sampler=e}setTexture(e,t=1){this.textures.set(t,e),this.modelMaterialBindGroupEntries[t].resource=e.createView(),this.updateTexturesBindGroup()}getTexture(e){return this.textures.get(e)}get material(){return this.materials.get(v.getActiveRenderPassType())}updateTexturesBindGroup(){this.texturesBindGroup=v.device.createBindGroup({label:"Model Textures Bind Group",layout:j.defaultModelMaterialBindGroupLayout,entries:this.modelMaterialBindGroupEntries})}setMaterial(e,t){const r=t??V.Deferred;this.materials.set(r,e)}getMaterial(e){const t=e??V.Deferred;return this.materials.get(t)}updateWorldMatrix(){const e=super.updateWorldMatrix();return this.uploadModelBufferToGPU=e,e}preRender(e){v.ENABLE_DEBUG_GROUPS&&e.pushDebugGroup(`Render ${this.label}`),this.uploadModelBufferToGPU&&(this.bufferUniformValues.set({worldMatrix:this.modelMatrix,prevFrameWorldMatrix:this.prevFrameModelMatrix,normalMatrix:this.normalMatrix,isReflective:this.materialProps.isReflective?1:0,baseColor:this.materialProps.color,metallic:this.materialProps.metallic,roughness:this.materialProps.roughness}),this.uploadModelBufferToGPU=!1,v.device.queue.writeBuffer(this.modelBuffer,0,this.bufferUniformValues.arrayBuffer)),e.setIndexBuffer(this.geometry.indexBuffer,un.INDEX_FORMAT,this.geometry.indexBufferOffsets[0]);for(let t=0;t<this.geometry.vertexBuffers.length;t++){const r=this.geometry.vertexBufferOffsets.get(this.geometry.vertexBuffers[t]);e.setVertexBuffer(t,this.geometry.vertexBuffers[t],r[0])}e.setBindGroup(ae.Model,this.modelBindGroup),e.setBindGroup(ae.PBRTextures,this.texturesBindGroup)}onRender(e){this.material.bind(),e.drawIndexed(this.geometry.indexCount,this.instanceCount,this.firstIndex,this.baseVertex,this.firstInstance)}postRender(e){v.ENABLE_DEBUG_GROUPS&&e.popDebugGroup()}render(e){this.material&&super.render(e)}};un.INDEX_FORMAT="uint16";let _e=un;const uc="main",op=`
  @group(0) @binding(0) var inTexture: texture_2d<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var<uniform> inOutTextureScaleFactor: u32;

  @compute @workgroup_size(8, 8)
  fn ${uc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(inTexture, 0).xy;
    if (any(id.xy > texSize.xy)) {
      return;
    }

    let inColor = textureLoad(inTexture, id.xy * inOutTextureScaleFactor, 0);
    textureStore(outTexture, id.xy, inColor);
  }
`,Ii="computeMipMap",cc=(s="rgba8unorm")=>`
  @group(0) @binding(0) var prevMipLevel: texture_2d<f32>;
  @group(0) @binding(1) var nextMipLevel: texture_storage_2d<${s}, write>;

  @compute @workgroup_size(8, 8)
  fn ${Ii}(@builtin(global_invocation_id) id: vec3u) {
    let offset = vec2<u32>(0, 1);
    let color = (
        textureLoad(prevMipLevel, 2 * id.xy + offset.xx, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.xy, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.yx, 0) +
        textureLoad(prevMipLevel, 2 * id.xy + offset.yy, 0)
    ) * 0.25;
    textureStore(nextMipLevel, id.xy, color);
  }
`;function lc(s,e,t){const r=[{binding:0,resource:e[s-1]},{binding:1,resource:e[s]}];return v.device.createBindGroup({label:"Mip Generator Input Bind Group",layout:t,entries:r})}const xr=class xr extends $e{static copyTextureView(e,t,r,n,i,o,c={viewDimension:"2d",sampleType:"unfilterable-float"},d={access:"write-only",format:"rgba16float",viewDimension:"2d"}){const g=v.device.createBuffer({label:"Copy Texture View Compute Tex Scale Factor Buffer",size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM,mappedAtCreation:!0});W.addBufferBytes(g);const b=n/i;new Uint32Array(g.getMappedRange()).set(new Uint32Array([b])),g.unmap();const l=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:c},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:d},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{}}],x=v.device.createBindGroupLayout({label:"Copy Texture View Compute Bind Group Layout",entries:l}),m=[{binding:0,resource:t},{binding:1,resource:r},{binding:2,resource:{buffer:g}}],_=v.device.createBindGroup({layout:x,entries:m}),w=v.device.createPipelineLayout({label:"Copy Texture View Compute PSO Layout",bindGroupLayouts:[x]}),f=j.createComputePipeline({label:"Copy Texture View Compute PSO",layout:w,compute:{module:j.createShaderModule(op),entryPoint:uc}});e.setPipeline(f),e.setBindGroup(0,_),e.dispatchWorkgroups(Math.ceil(i/8),Math.ceil(o/8),1)}};xr.generateMipsForCubeTexture=e=>{if(e.depthOrArrayLayers!=6)return void console.error("Need a cube texture");const t=Pt(e.width,e.height),r={baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1,dimension:"2d",format:e.format},n=[],i=[];for(let l=0;l<6;l++){const x=[],m=[Ce.create(e.width,e.height)];for(let _=0;_<t;_++){const w=`MIP Level ${_}`;if(r.label=w,r.baseArrayLayer=l,r.baseMipLevel=_,x.push(e.createView(r)),_>0){const f=m[_-1],p=Ce.divScalar(f,2);m.push(p)}}n.push(x),i.push(m)}const o=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:e.format,viewDimension:"2d"}}],c=v.device.createBindGroupLayout({label:"Mip Generator CubeTexture Input Bind Group Layout",entries:o}),d=j.createComputePipeline({label:"Compute Mip ComputePSO",layout:v.device.createPipelineLayout({label:"Compute Mip ComputePSO CubeTexture Layout",bindGroupLayouts:[c]}),compute:{entryPoint:Ii,module:j.createShaderModule(cc(e.format))}}),g=v.device.createCommandEncoder({label:"Mip Generate Command Encoder}"}),b=g.beginComputePass();b.setPipeline(d);for(let l=0;l<6;l++){const x=i[l],m=n[l];for(let _=1;_<x.length;_++){const f=(x[_][0]+8-1)/8,p=(x[_][1]+8-1)/8,a=lc(_,m,c);b.setBindGroup(0,a),b.dispatchWorkgroups(f,p,1)}}b.end(),v.device.queue.submit([g.finish()])},xr.generateMipsFor2DTextureWithRenderPSO=()=>{},xr.generateMipsFor2DTextureWithComputePSO=(e,t="Mipmapped 2D Texture")=>{const r=Pt(e.width,e.height),n={aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1,dimension:"2d",format:e.format},i=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{viewDimension:"2d"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:e.format,viewDimension:"2d"}}],o=v.device.createBindGroupLayout({label:"Mip Generator Input Bind Group Layout",entries:i}),c=j.createComputePipeline({label:"Compute Mip ComputePSO",layout:v.device.createPipelineLayout({label:"Compute Mip ComputePSO Layout",bindGroupLayouts:[o]}),compute:{entryPoint:Ii,module:j.createShaderModule(cc())}}),d=[],g=[Ce.create(e.width,e.height)];for(let x=0;x<r;x++){const m=`MIP Level ${x}`;if(n.label=m,n.baseMipLevel=x,d.push(e.createView(n)),x>0){const _=g[x-1],w=Ce.divScalar(_,2);g.push(w)}}const b=v.device.createCommandEncoder({label:`Mip Generate Command Encoder for ${t}`}),l=b.beginComputePass();l.setPipeline(c);for(let x=1;x<g.length;x++){const _=(g[x][0]+8-1)/8,w=(g[x][1]+8-1)/8,f=lc(x,d,o);l.setBindGroup(0,f),l.dispatchWorkgroups(_,w,1)}l.end(),v.device.queue.submit([b.finish()])},xr.createHDRTexture=(e,t=GPUTextureUsage.TEXTURE_BINDING,r="HDR Texture")=>{const n=v.device.createTexture({label:r,format:"rgba16float",size:{width:e.width,height:e.height,depthOrArrayLayers:1},usage:t});return v.device.queue.writeTexture({texture:n,mipLevel:0},e.rgbaHalfFloat,{offset:0,bytesPerRow:e.width*Uint16Array.BYTES_PER_ELEMENT*4},{width:e.width,height:e.height,depthOrArrayLayers:1}),n};let Ht=xr,ap=0;const Kr=class Kr extends $e{static createEmptyCubeTexture(e,t="Cube Texture "+ap++,r=!1,n="rgba16float",i=GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST){const o={label:t,dimension:"2d",size:{width:e,height:e,depthOrArrayLayers:6},usage:i,format:n};return r&&(o.mipLevelCount=Pt(e,e)),v.device.createTexture(o)}};Kr.cubeTextureFromIndividualHDRTextures=(e,t="Environment Cube Texture From Individual HDR Textures",r=512,n=!1)=>{const i=Kr.createEmptyCubeTexture(r,t,n),o=v.device.createCommandEncoder();v.ENABLE_DEBUG_GROUPS&&o.pushDebugGroup("Texture View Copy");const c=o.beginComputePass(),d=r;for(let g=0;g<6;g++)Ht.copyTextureView(c,e[g].createView({}),i.createView({baseArrayLayer:g,arrayLayerCount:1,baseMipLevel:0,mipLevelCount:1,dimension:"2d"}),r,d,d);return c.end(),v.ENABLE_DEBUG_GROUPS&&o.popDebugGroup(),v.device.queue.submit([o.finish()]),n&&Ht.generateMipsForCubeTexture(i),i},Kr.cubeTextureFromHDR=(e,t=512)=>{const r=v.device.createTexture({label:"Environment Cube Texture",dimension:"2d",size:{width:t,height:t,depthOrArrayLayers:6},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING,format:"rgba8unorm"}),n=new Hn(.5*Math.PI,1,.1,10);n.updateProjectionMatrix();const i=v.device.createBuffer({label:"HDR -> CubeMap Camera ProjView Matrix Buffer",size:16*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM});W.addBufferBytes(i);const o=[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,texture:{sampleType:"unfilterable-float"},visibility:GPUShaderStage.FRAGMENT},{binding:2,sampler:{type:"non-filtering"},visibility:GPUShaderStage.FRAGMENT}],c=v.device.createBindGroupLayout({label:"Environment Probe Camera Bind Group Layout",entries:o}),d=[{binding:0,resource:{buffer:i}},{binding:1,resource:e.createView()},{binding:2,resource:He.createSampler({})}],g=v.device.createBindGroup({label:"Environment Probe Camera Bind Group",layout:c,entries:d}),b=v.device.createCommandEncoder({label:"HDR Environment to Cube Map Command Encoder"}),l=[{loadOp:"load",storeOp:"store",view:null}],x=j.createRenderPipeline({label:"HDR To CubeMap Render PSO",layout:v.device.createPipelineLayout({bindGroupLayouts:[c]}),vertex:{module:j.createShaderModule(oc),entryPoint:nc,buffers:xe.defaultLayout},fragment:{module:j.createShaderModule(oc),entryPoint:ic,targets:[{format:"rgba8unorm"}]},primitive:{cullMode:"none"}}),m=new ac;for(let _=0;_<6;_++){l[0].view=r.createView({dimension:"2d",baseArrayLayer:_,arrayLayerCount:1});const w=D.add(n.position,El[_]),f=$.lookAt(n.position,w,Ml[_]),p=$.mul(n.projectionMatrix,f);v.device.queue.writeBuffer(i,0,p);const a={label:`Draw Face ${_} Render Pass`,colorAttachments:l},u=b.beginRenderPass(a);u.setPipeline(x),u.setBindGroup(0,g),u.setIndexBuffer(m.indexBuffer,_e.INDEX_FORMAT),u.setVertexBuffer(0,m.vertexBuffer),u.drawIndexed(m.indexCount),u.end()}return v.device.queue.submit([b.finish()]),r};let Ir=Kr;const up=new Uint8Array([0,32,8,40,2,34,10,42,48,16,56,24,50,18,58,26,12,44,4,36,14,46,6,38,60,28,52,20,62,30,54,22,3,35,11,43,1,33,9,41,51,19,59,27,49,17,57,25,15,47,7,39,13,45,5,37,63,31,55,23,61,29,53,21]),dc=new Uint8Array([255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255,255,204,255,204,255,204,255,204,204,255,204,255,204,255,204,255]);let Hs,Fr,js;const Ct=class Ct extends $e{static get dummyTexture(){return Hs||(Hs=v.device.createTexture({label:"Default Dummy 8x8 Texture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:1},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),v.device.queue.writeTexture({texture:Hs,mipLevel:0},dc,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:1}),Hs)}static get dummyCubeTexture(){if(Fr)return Fr;Fr=v.device.createTexture({label:"Default Dummy 8x8 Cube Texture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:6},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});for(let e=0;e<6;e++)v.device.queue.writeTexture({texture:Fr,mipLevel:0,origin:{x:0,y:0,z:e}},dc,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:0});return Fr}static get bayerDitherPatternTexture(){return js||(js=v.device.createTexture({label:"Bayer ordered dithered GPUTexture",dimension:"2d",size:{width:8,height:8,depthOrArrayLayers:1},format:"r8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),v.device.queue.writeTexture({texture:js,mipLevel:0},up,{offset:0,bytesPerRow:8},{width:8,height:8,depthOrArrayLayers:1}),js)}};Ct.loadHDRImage=async e=>{const t=await np.load(e),r=t.width*t.height,n={width:t.width,height:t.height,rgbaHalfFloat:new Uint16Array(t.width*t.height*4)};for(let i=0;i<r;i++){const o=t.rgbFloat[3*i+0],c=t.rgbFloat[3*i+1],d=t.rgbFloat[3*i+2];n.rgbaHalfFloat[4*i+0]=ns(o),n.rgbaHalfFloat[4*i+1]=ns(c),n.rgbaHalfFloat[4*i+2]=ns(d),n.rgbaHalfFloat[4*i+3]=ns(1)}return n},Ct.loadHDRTexture=async(e,t=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC,r=`HDR Texture ${e}`)=>{const n=await Ct.loadHDRImage(e),i=await Ht.createHDRTexture(n,t,r);return W.addTextureBytes(i),i},Ct.load6SeparateHDRFacesAsCubeMapTexture=async(e,t,r,n=null)=>{if(e.length!==6)return void console.error("Need 6 separate urls for 6 separate environment textures");const i=await Promise.all(e.map(c=>Ct.loadHDRTexture(c))),o=Ir.cubeTextureFromIndividualHDRTextures(i,n,t,r);return W.addTextureBytes(o),o},Ct.loadTextureFromData=async(e,t="rgba8unorm",r=!0,n=!1,i=!1,o="Bitmap Texture")=>{const c=new Blob([e],{type:"image/png"}),d=await createImageBitmap(c,{colorSpaceConversion:"none"});let g=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT;r&&(g|=GPUTextureUsage.STORAGE_BINDING);const b={label:o,dimension:"2d",size:{width:d.width,height:d.height,depthOrArrayLayers:1},format:t,usage:g};r&&(b.mipLevelCount=Pt(d.width,d.height));const l=v.device.createTexture(b);if(v.device.queue.copyExternalImageToTexture({source:d,flipY:n},{texture:l},{width:d.width,height:d.height}),!r)return W.addTextureBytes(l),l;Ht.generateMipsFor2DTextureWithComputePSO(l),W.addTextureBytes(l);const x=document.createElement("canvas"),m=x.getContext("2d");return x.width=l.width/2,x.height=l.height/2,m.drawImage(d,0,0),i&&(x.style.setProperty("position","fixed"),x.style.setProperty("z-index","99"),x.style.setProperty("left","2rem"),x.style.setProperty("bottom","2rem"),x.style.setProperty("width",.1*l.width+"px"),x.style.setProperty("height",.1*l.height+"px"),x.dataset.debugLabel=`${o.toLowerCase()}`,document.body.appendChild(x)),d.close(),l};let Be=Ct;class cp extends nr{constructor(e){super(),this.url=e,this.nodeMaterialIds=new Map([]),this.gpuSamplers=new Map,this.gpuTextures=new Map,this.gpuBuffers=new Map,this.updateWorldMatrix()}setMaterial(e,t=V.Deferred){return this.traverse(r=>{r instanceof _e&&r.setMaterial(e,t)}),this}setIsReflective(e){return this.traverse(t=>{t instanceof _e&&(t.materialProps.isReflective=e)}),this}setTextureForAll(e,t=1){return this.traverse(r=>{r instanceof _e&&r.setTexture(e,t)}),this}setSampler(e){return this.traverse(t=>{t instanceof _e&&t.setSampler(e)}),this}setTextureFor(e,t,r=1){const n=this.findChildByLabel(e);if(n instanceof _e)return n.setTexture(t,r),this;console.error("Found child is not instance of a Drawable")}async load(){const e=[],t=async function(c,d,g){let b,l;Array.isArray(d)||ri(d)?(b=d,l=g):(b=[],l=d);const x=ou(l);let m=c;return typeof c=="string"&&(m=await x(c)),Ut(c)&&(m=await x(c)),Array.isArray(b),await ii(m,b,l)}(this.url,Mi);e.push(t);const r=(n=await t,new $f().postProcess(n,i));var n,i;const o=this.initGPUTexturesFrom(r.textures);return e.push(o),this.initGPUSamplersFrom(r.samplers),this.initGPUBuffersFrom(r.bufferViews),this.initMaterialsFrom(r.materials),this.initNodesFrom(r),Promise.all(e)}async initMaterialsFrom(e){for(const t of e){if(t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture){const r=await this.gpuTextures.get(t.pbrMetallicRoughness.baseColorTexture.texture.id),n=this.nodeMaterialIds.get(t.id);for(const i of n)i.setTexture(r,pe.Albedo);if(t.pbrMetallicRoughness.metallicRoughnessTexture){const i=await this.gpuTextures.get(t.pbrMetallicRoughness.metallicRoughnessTexture.texture.id),o=this.nodeMaterialIds.get(t.id);for(const c of o)c.setTexture(i,pe.MetallicRoughness)}}if(t.normalTexture){const r=await this.gpuTextures.get(t.normalTexture.texture.id),n=this.nodeMaterialIds.get(t.id);for(const i of n)i.setTexture(r,pe.Normal)}}}async initGPUTexturesFrom(e){const t=[];for(const r of e){const n=Be.loadTextureFromData(r.source.bufferView.data,"rgba8unorm",!0,!1,!1,`GLTF Texture: ${r.id}`);t.push(n),this.gpuTextures.set(r.id,n)}return Promise.all(t)}initGPUSamplersFrom(e){for(const t of e){const r=He.getSamplerFromGltfSamplerDef(t);this.gpuSamplers.set(t.id,r)}}initGPUBuffersFrom(e){for(const t of e){let r=0;t.target===34963&&(r|=GPUBufferUsage.INDEX),t.target===34962&&(r|=GPUBufferUsage.VERTEX);const n=4*Math.ceil(t.byteLength/4),i=v.device.createBuffer({label:t.id,mappedAtCreation:!0,size:n,usage:r});W.addBufferBytes(i),new Uint8Array(i.getMappedRange()).set(new Uint8Array(t.buffer.arrayBuffer,t.byteOffset,t.byteLength)),i.unmap(),this.gpuBuffers.set(t.id,i)}}initNodesFrom(e){var t,r,n,i;for(const o of e.nodes)if(o.mesh)for(const c of o.mesh.primitives){const d=new Zf(c,this.gpuBuffers),g=new _e(d),b=D.create(),l=D.create(1,1,1),x=rs.identity(),m=this.nodeMaterialIds.get(c.material.id)||[];m.push(g),this.nodeMaterialIds.set(c.material.id,m),c.material.pbrMetallicRoughness.baseColorTexture&&c.material.pbrMetallicRoughness.baseColorTexture.texture.source.uri.includes("5823059166183034438")?g.materialProps.isReflective=!0:g.materialProps.isReflective=!1,g.label=o.name??o.id;const _=(r=(t=c.attributes)==null?void 0:t.POSITION)==null?void 0:r.min;_&&g.boundingBox.setMinAABBfromGLTF(_);const w=(i=(n=c.attributes)==null?void 0:n.POSITION)==null?void 0:i.max;w&&g.boundingBox.setMaxAABBfromGLTF(w),o.translation&&D.set(o.translation[0],o.translation[1],o.translation[2],b),o.scale&&D.set(o.scale[0],o.scale[1],o.scale[2],l),o.rotation&&rs.set(o.rotation[0],o.rotation[1],o.rotation[2],o.rotation[3],x),g.setCustomMatrixFromTRS(b,x,l),g.sampler=this.gpuSamplers.get("sampler-0"),this.addChild(g)}}}const hc="vertexMain",fc="fragmentMain",lp=`
  ${Y.Camera}

  @group(${ae.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;

  @group(1) @binding(0) var<storage, read> linePointPositions: array<vec4f>;

  @vertex
  fn ${hc}(
    @builtin(vertex_index) vertexId: u32,
  ) -> @builtin(position) vec4f {
    let position = linePointPositions[vertexId];
    return camera.projectionViewMatrix * position;
  }

  @fragment
  fn ${fc}() -> @location(0) vec4f {
    return vec4f(vec3f(1), 1);
  }
`;class dp extends nr{constructor(e){super(),this.points=e,this.pointsGPUBuffer=v.device.createBuffer({label:"Line Points GPU Buffer",size:4*e.length*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0}),W.addBufferBytes(this.pointsGPUBuffer);const t=new Float32Array(this.pointsGPUBuffer.getMappedRange());for(let c=0;c<e.length;c++)t[4*c+0]=e[c][0],t[4*c+1]=e[c][1],t[4*c+2]=e[c][2],t[4*c+3]=1;this.pointsGPUBuffer.unmap();const r=[{binding:0,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.VERTEX}],n=v.device.createBindGroupLayout({label:"ParticlesMoveCurve Debug Bind Group Layout",entries:r}),i=[{binding:0,resource:{buffer:this.pointsGPUBuffer}}];this.bindGroup=v.device.createBindGroup({label:"ParticlesMoveCurve Debug Bind Group",layout:n,entries:i});const o=j.createShaderModule(lp,"ParticlesMoveCurve Debug Shader Module");this.renderPSO=j.createRenderPipeline({label:"ParticlesMoveCurve Debug Render PSO",layout:v.device.createPipelineLayout({label:"ParticlesMoveCurve Debug Render PSO Layout",bindGroupLayouts:[j.defaultCameraPlusLightsBindGroupLayout,n]}),vertex:{entryPoint:hc,module:o},fragment:{entryPoint:fc,module:o,targets:[{format:"rgba16float"}]},depthStencil:{format:v.depthStencilFormat,depthCompare:"less",depthWriteEnabled:!0},primitive:{topology:"line-strip"}})}render(e){this.visible&&(v.ENABLE_DEBUG_GROUPS&&e.pushDebugGroup(`Render Debug Line: ${this.label}`),e.setPipeline(this.renderPSO),e.setBindGroup(1,this.bindGroup),e.draw(this.points.length),v.ENABLE_DEBUG_GROUPS&&e.popDebugGroup())}}class hp extends nr{constructor(){super(...arguments),this.debugMeshes=[],this.opaqueMeshes=[],this.transparentMeshes=[],this.culledOpaqueMeshes=[],this.culledTransparentMeshes=[],this.nonCulledTransparentCount=0,this.nonCulledOpaqueCount=0,this.onGraphChangedCallbacks=[]}get nodesCount(){return this.opaqueMeshes.length+this.transparentMeshes.length}get visibleNodesCount(){return this.nonCulledOpaqueCount+this.nonCulledTransparentCount}addOnGraphChangedCallback(e){this.onGraphChangedCallbacks.push(e)}renderDebugMeshes(e){for(const t of this.debugMeshes)t.render(e)}renderOpaqueNodes(e,t){if(!t){for(const n of this.opaqueMeshes)n.render(e);return}const r=t.cullMeshes(this.opaqueMeshes,this.culledOpaqueMeshes);this.nonCulledOpaqueCount=r;for(let n=0;n<r;n++)this.culledOpaqueMeshes[n].render(e)}renderTransparentNodes(e,t){if(!t){for(const n of this.transparentMeshes)n.render(e);return}const r=t.cullMeshes(this.transparentMeshes,this.culledTransparentMeshes);this.nonCulledTransparentCount=r;for(let n=0;n<r;n++)this.culledTransparentMeshes[n].render(e)}onChildAdd(e){e instanceof _e&&(e.isOpaque?(this.opaqueMeshes.push(e),this.culledOpaqueMeshes.push(e)):(this.transparentMeshes.push(e),this.culledTransparentMeshes.push(e))),e instanceof dp&&this.debugMeshes.push(e);for(const t of this.onGraphChangedCallbacks)t()}onChildRemove(e){super.onChildRemove(e);const t=({id:r})=>r!==e.id;e instanceof _e&&(e.isOpaque?(this.opaqueMeshes=this.opaqueMeshes.filter(t),this.culledOpaqueMeshes=this.culledOpaqueMeshes.filter(t)):(this.transparentMeshes=this.transparentMeshes.filter(t),this.culledTransparentMeshes=this.culledTransparentMeshes.filter(t)));for(const r of this.onGraphChangedCallbacks)r()}}const pc=`
  // Van Der Corpus sequence
  // @see http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html
  fn vdcSequence(inBits: u32) -> f32 {
    var bits = inBits;
    bits = (bits << 16u) | (bits >> 16u);
    bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
    bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
    bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
    bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
    return f32(bits) * 2.3283064365386963e-10; // / 0x100000000
  }

  // Hammersley sequence
  // @see http://holger.dammertz.org/stuff/notes_HammersleyOnHemisphere.html
  fn hammersley(i: u32, N: u32) -> vec2f {
    return vec2f(f32(i) / f32(N), vdcSequence(i));
  }

  // Based on Karis 2014
  // GGX NDF via importance sampling
  fn importanceSampleGGX(Xi: vec2f, N: vec3f, roughness: f32) -> vec3f {
    let alpha = roughness * roughness;
    let alpha2 = alpha * alpha;

    let phi = TWO_PI * Xi.x;
    let cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (alpha2 - 1.0) * Xi.y));
    let sinTheta = sqrt(1.0 - cosTheta * cosTheta);

    // from spherical coordinates to cartesian coordinates
    let H = vec3f(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);

    // from tangent-space vector to world-space sample vector
    
    let up = select(WORLD_UP, WORLD_FORWARD, abs(N.z) < 0.999);
    let tangent = normalize(cross(up, N));
    let bitangent = cross(N, tangent);

    return tangent * H.x + bitangent * H.y + N * H.z;
  }

  fn GTR2(NdotH: f32, a: f32) -> f32 {
    let a2 = a * a;
    let t = 1.0 + (a2 - 1.0) * NdotH * NdotH;
    return step(0.0, NdotH) * a2 / (PI * t * t);
  }

  fn distributionGGX(NdotH: f32, roughness: f32) -> f32 {
    return GTR2(NdotH, roughness * roughness);
  }

  fn visibilitySmithGGXCorrelated(NdotV: f32, NdotL: f32, roughness: f32) -> f32 {
    let a2 = roughness * roughness;
    let oneMinusA2 = 1.0 - a2;
    let ggxv = NdotL * sqrt(NdotV * NdotV * oneMinusA2 + a2);
    let ggxl = NdotV * sqrt(NdotL * NdotL * oneMinusA2 + a2);
  
    let ggx = ggxv + ggxl;
    if (ggx > 0.0) {
        return 0.5 / ggx;
    }
    return 0.0;
  }
`,mc="main",fp=`
  ${Y.CommonHelpers}

  @group(0) @binding(0) var outTexture: texture_storage_2d<rgba16float, write>;

  const SAMPLE_COUNT = 1024u;

  ${pc}

  // https://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf
  // Karis 2014
  @must_use
  fn integrate(NdotV: f32, roughness: f32) -> vec2f {
    var V = vec3f(0.0);
    V.x = sqrt(1.0 - NdotV * NdotV); // sin
    V.y = 0.0;
    V.z = NdotV; // cos

    // N points straight upwards for this integration
    let N = vec3f(0.0, 0.0, 1.0);

    var A = 0.0;
    var B = 0.0;

    for (var i = 0u; i < SAMPLE_COUNT; i++) {
      let Xi = hammersley(i, SAMPLE_COUNT);
      let H = importanceSampleGGX(Xi, N, roughness);
      let L = 2.0 * dot(V, H) * H - V;

      let NdotL = saturate(L.z);
      let NdotH = saturate(H.z);
      let VdotH = saturate(dot(V, H));
      
      if (NdotL > 0.0) {
        let V_pdf = visibilitySmithGGXCorrelated(NdotV, NdotL, roughness) * VdotH * NdotL / NdotH;
        let Fc = pow(1.0 - VdotH, 5.0);
        A += (1.0 - Fc) * V_pdf;
        B += Fc * V_pdf;
      }
    }

    return 4.0 * vec2f(A, B) / f32(SAMPLE_COUNT);
  }

  @compute @workgroup_size(8, 8)
  fn ${mc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy) - 1.0;
    let uv = vec2f(id.xy) / size;

    let result = vec4f(integrate(uv.x, uv.y), 0, 0);
    textureStore(outTexture, id.xy, result);
  }
`;let Js;const gc=[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}}],cn=class cn extends $e{static get computePSO(){if(Js)return Js;const e=v.device.createBindGroupLayout({label:"BDRF Lut Compute PSO Bind Group Layout",entries:gc});return Js=v.device.createComputePipeline({label:"BDRF LUT Generate Compute PSO",compute:{module:j.createShaderModule(fp),entryPoint:mc},layout:v.device.createPipelineLayout({label:"BDRF LUT Generation Compute PSO Layout",bindGroupLayouts:[e]})}),Js}};cn.encode=(e=512)=>{const t=v.device.createTexture({label:"BDRF LUT Texture",size:{width:e,height:e,depthOrArrayLayers:1},format:"rgba16float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_DST,mipLevelCount:1}),r=v.device.createCommandEncoder({label:"BDRF LUT Generate Command Encoder"});v.ENABLE_DEBUG_GROUPS&&r.pushDebugGroup("BDRF LUT Generation");const n=r.beginComputePass({label:"BDRF LUT Generate Compute Pass"}),i=v.device.createBindGroupLayout({label:"BDRF Lut Compute PSO Bind Group Layout",entries:gc}),o=[{binding:0,resource:t.createView()}],c=v.device.createBindGroup({label:"BDRF LUT Generate Input Bind Group",layout:i,entries:o}),d=(e+8-1)/8,g=(e+8-1)/8;return n.setPipeline(cn.computePSO),n.setBindGroup(0,c),n.dispatchWorkgroups(d,g,1),n.end(),v.ENABLE_DEBUG_GROUPS&&r.popDebugGroup(),v.device.queue.submit([r.finish()]),W.addTextureBytes(t),t};let Fi=cn;const yc="main",pp=`
  ${Y.CommonHelpers}
  ${Y.MathHelpers}

  @group(0) @binding(0) var inTexture: texture_cube<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var cubeSampler: sampler;
  @group(0) @binding(3) var<uniform> face: u32;

  @compute @workgroup_size(8, 8)
  fn ${yc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy);
    let uv = vec2f(id.xy) / size;
    
    var ruv = 2.0 * uv - 1.0;
    ruv.y = ruv.y * -1;
    
    var irradiance = vec3f(0.0);
    let rotation = CUBE_ROTATIONS[face];
    let N = normalize(vec3f(ruv, 1.0) * rotateAxisAngle(rotation.xyz, rotation.w));
    var UP = select(WORLD_UP, WORLD_FORWARD, abs(N.z) < 0.999);
    let RIGHT = normalize(cross(UP, N));
    UP = cross(RIGHT, N);

    var sampleCount = 0u;

    for (var phi: f32 = 0.0; phi < TWO_PI; phi += DELTA_PHI) {
      let sinPhi = sin(phi);
      let cosPhi = cos(phi);
      for (var theta: f32 = 0.0; theta < HALF_PI; theta += DELTA_THETA) {
        let sinTheta = sin(theta);
        let cosTheta = cos(theta);

        let tempVec = cosPhi * RIGHT + sinPhi * UP;
        let sampleVector = cosTheta * N + sinTheta * tempVec;

        irradiance += textureSampleLevel(inTexture, cubeSampler, sampleVector, 2).rgb * cos(theta) * sin(theta);
        sampleCount++;
      }
    }
    
    irradiance = PI * irradiance / f32(sampleCount);
    textureStore(outTexture, id.xy, vec4f(irradiance, 1.0));
  }
`;let zs;const bc=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{},visibility:GPUShaderStage.COMPUTE}],ln=class ln extends $e{static get computePSO(){if(zs)return zs;const e=v.device.createBindGroupLayout({label:"Diffuse IBL Compute PSO Bind Group Layout",entries:bc});return zs=j.createComputePipeline({label:"Diffuse IBL Compute PSO",compute:{module:j.createShaderModule(pp),entryPoint:yc},layout:v.device.createPipelineLayout({label:"Diffuse IBL Compute PSO Layout",bindGroupLayouts:[e]})}),zs}};ln.encode=(e,t=32)=>{if(e.depthOrArrayLayers!==6)return void console.error("Need cube texture as a source for IBL Diffuse");if(e.format!=="rgba16float")return void console.error("Only rgba16float cube textures supported for Diffuse IBL for now");const r=Ir.createEmptyCubeTexture(t,"Diffuse IBL Texture",!0),n=v.device.createBindGroupLayout({label:"Diffuse IBL Compute PSO Bind Group Layout",entries:bc}),i=[{binding:0,resource:null},{binding:1,resource:null},{binding:2,resource:He.createSampler({addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"})},{binding:3,resource:{buffer:null}}],o=v.device.createCommandEncoder({label:"Diffuse IBL Command Encoder"}),c=o.beginComputePass({label:"Diffuse IBL Compute Pass"});v.ENABLE_DEBUG_GROUPS&&c.pushDebugGroup("Begin Diffuse IBL"),c.setPipeline(ln.computePSO);const d=e.createView({dimension:"cube"});for(let g=0;g<6;g++){const b=v.device.createBuffer({label:"Diffuse IBL Face GPUBuffer",size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0});W.addBufferBytes(b),new Uint32Array(b.getMappedRange()).set(new Uint32Array([g])),b.unmap();const l=r.createView({format:r.format,dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:g,arrayLayerCount:1});i[0].resource=d,i[1].resource=l,i[3].resource={buffer:b};const x=v.device.createBindGroup({layout:n,entries:i}),m=8,_=(r.width+m-1)/m,w=(r.height+m-1)/m;c.setBindGroup(0,x),c.dispatchWorkgroups(_,w,1)}return v.ENABLE_DEBUG_GROUPS&&c.popDebugGroup(),c.end(),v.device.queue.submit([o.finish()]),W.addTextureBytes(r),r};let Di=ln;const xc="main",mp=`
  ${Y.CommonHelpers}
  ${Y.MathHelpers}

  @group(0) @binding(0) var inTexture: texture_cube<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var cubeSampler: sampler;
  @group(0) @binding(3) var<uniform> face: u32;
  @group(0) @binding(4) var<uniform> roughness: f32;

  const SAMPLE_COUNT: u32 = 1024;

  ${pc}

  @compute @workgroup_size(8, 8)
  fn ${xc}(@builtin(global_invocation_id) id: vec3u) {
    let texSize = textureDimensions(outTexture).xy;
    if (any(id.xy >= texSize)) {
      return;
    }

    let size = vec2f(texSize.xy);
    let uv = vec2f(id.xy) / size;
    
    var ruv = 2.0 * uv - 1.0;
    ruv.y = ruv.y * -1;

    let rotation = CUBE_ROTATIONS[face];
    let N = normalize(vec3f(ruv, 1.0) * rotateAxisAngle(rotation.xyz, rotation.w));

    let R = N;
    let V = R;

    var prefilteredColor = vec3f(0.0);
    var totalWeight = 0.0;

    for (var i = 0u; i < SAMPLE_COUNT; i++) {
      // generates a sample vector that's biased towards the preferred alignment direction (importance sampling).
      let Xi = hammersley(i, SAMPLE_COUNT);
      let H = importanceSampleGGX(Xi, N, roughness);
      let L = normalize(2.0 * dot(V, H) * H - V);

      let NdotL = max(dot(N, L), 0.0);

      if (NdotL > 0.0) {
        // sample from the environment's mip level based on roughness/pdf

        let NdotH = max(dot(N, H), 0.0);
        let HdotV = max(dot(H, V), 0.0);
        let D = distributionGGX(NdotH, roughness);
        let pdf = max((D * NdotH / (4.0 * HdotV)) + 0.0001, 0.0001);

        let resolution = f32(textureDimensions(inTexture).x); // resolution of source cubemap (per face)
        let saTexel = 4.0 * PI / (6.0 * resolution * resolution);
        let saSample = 1.0 / (f32(SAMPLE_COUNT) * pdf + 0.0001);

        let mipLevel = select(0.5 * log2(saSample / saTexel), 0.0, roughness == 0.0);

        prefilteredColor += textureSampleLevel(inTexture, cubeSampler, L, mipLevel).rgb * NdotL;
        totalWeight += NdotL;
      }
    }

    prefilteredColor = prefilteredColor / totalWeight;
    textureStore(outTexture, id.xy, vec4f(prefilteredColor, 1.0));
  }
`;let Ks;const _c=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE},{binding:3,buffer:{},visibility:GPUShaderStage.COMPUTE},{binding:4,buffer:{},visibility:GPUShaderStage.COMPUTE}],dn=class dn extends $e{static get computePSO(){if(Ks)return Ks;const e=v.device.createBindGroupLayout({label:"Specular IBL Compute PSO Bind Group Layout",entries:_c});return Ks=j.createComputePipeline({label:"Specular IBL Compute PSO",compute:{module:j.createShaderModule(mp),entryPoint:xc},layout:v.device.createPipelineLayout({label:"Specular IBL Compute PSO",bindGroupLayouts:[e]})}),Ks}};dn.encode=(e,t=128)=>{if(e.depthOrArrayLayers!==6)return void console.error("Need cube texture as a source of IBL Specular");if(e.format!=="rgba16float")return void console.error("Only rgba16float cube textures supported for Specular IBL for now");const r=Ir.createEmptyCubeTexture(t,"Specular IBL Texture",!0),n=e.createView({dimension:"cube"}),i=r.mipLevelCount,o=[{binding:0,resource:n},{binding:1,resource:null},{binding:2,resource:He.createSampler({minFilter:"linear",magFilter:"linear"})},{binding:3,resource:{buffer:null}},{binding:4,resource:{buffer:null}}],c=v.device.createCommandEncoder({label:"Specular IBL Command Encoder"});v.ENABLE_DEBUG_GROUPS&&c.pushDebugGroup("Begin Specular IBL Generation");const d=c.beginComputePass({label:"Specular IBL Compute Pass"});d.setPipeline(dn.computePSO);const g=v.device.createBindGroupLayout({label:"Specular IBL Compute PSO Bind Group Layout",entries:_c});let b=t;for(let l=0;l<i;l++){const x=l/(i-1),m=v.device.createBuffer({label:"Roughness Buffer",mappedAtCreation:!0,size:Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});W.addBufferBytes(m),new Float32Array(m.getMappedRange()).set(new Float32Array([x])),m.unmap(),o[4].resource={buffer:m};for(let _=0;_<6;_++){const w=v.device.createBuffer({label:"Face Buffer",mappedAtCreation:!0,size:Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});W.addBufferBytes(w),new Uint32Array(w.getMappedRange()).set(new Uint32Array([_])),w.unmap(),o[1].resource=r.createView({format:r.format,dimension:"2d",baseMipLevel:l,mipLevelCount:1,baseArrayLayer:_,arrayLayerCount:1}),o[3].resource={buffer:w};const f=v.device.createBindGroup({layout:g,entries:o}),p=8,a=(b+p-1)/p,u=(b+p-1)/p;d.setBindGroup(0,f),d.dispatchWorkgroups(a,u,1)}b/=2}return d.end(),v.ENABLE_DEBUG_GROUPS&&c.popDebugGroup(),v.device.queue.submit([c.finish()]),W.addTextureBytes(r),r};let Ui=dn;var q=(s=>(s[s.Normal=0]="Normal",s[s.AO=1]="AO",s[s.Metallic=2]="Metallic",s[s.Roughness=3]="Roughness",s[s.Reflectance=4]="Reflectance",s[s.Albedo=5]="Albedo",s[s.Depth=6]="Depth",s[s.Velocity=7]="Velocity",s[s.ShadowDepthCascade0=8]="ShadowDepthCascade0",s[s.ShadowDepthCascade1=9]="ShadowDepthCascade1",s[s.BDRF=10]="BDRF",s))(q||{});const gp=""+new URL("nx-DA81WUUi.hdr",import.meta.url).href,yp=""+new URL("ny-BiQjxcWx.hdr",import.meta.url).href,bp=""+new URL("nz-BP-ItiR-.hdr",import.meta.url).href,xp=""+new URL("px-DYiCDBPi.hdr",import.meta.url).href,_p=""+new URL("py-CfjHNeO0.hdr",import.meta.url).href,Bp=""+new URL("pz-DN7hTcVy.hdr",import.meta.url).href,tt="normal+metallic+roughness texture",xt="albedo+reflectance texture",Xs="velocity texture",ve="depth texture",Dr="directional light depth texture",Bc="ssao texture",mr="ssao blur texture",Ke="lighting texture",Ur="taa resolve texture",Ws="hi-z depth texture",kr="computed reflections texture",Nr="bloom downscale texture",jt=new Array(3);jt[ut.NormalMetallicRoughness]={format:"rgba16float"},jt[ut.ColorReflectance]={format:"bgra8unorm"},jt[ut.Velocity]={format:"rg16float"};const Ap=[gp,yp,bp,xp,_p,Bp],Ac=D.create(1,20,10),vp=D.create(.1,20,.1),vc=D.create(9.5,3.4,-.35),wp=D.create(9.3,3.4,-.35),Cp=[D.create(5.5,7.5,3.25),D.create(4,6.5,.5),D.create(2.5,6.5,3.25),D.create(1,7.5,.5),D.create(-.5,7.5,3.25),D.create(-2,6.5,.5),D.create(-3.5,6.5,3.25),D.create(-5,7.5,.5),D.create(-6.5,7.5,3.25),D.create(-7.75,6.5,.5),D.create(-10.5,7.5,-.125),D.create(-7.75,7.5,-1),D.create(-6.5,6.5,-4),D.create(-5,6.5,-1),D.create(-3.5,7.5,-4),D.create(-2,7.5,-1),D.create(-.5,6.5,-4),D.create(1,6.5,-1),D.create(2.5,7.5,-4),D.create(4,7.5,-1),D.create(5.5,6.5,-4),D.create(6.5,6.5,-1),D.create(9,6.5,-1),D.create(9.5,7.5,-.125),D.create(9,6.5,.7),D.create(6,6.5,1),D.create(6,7.5,3.25)],_t="fullscreenVertex",Jt=`
  ${Y.VertexOutput}

  const pos = array(
    vec2(-1.0, -1.0), vec2(3, -1.0), vec2(-1.0, 3),
  );
  const uv = array(
    vec2(0.0, 0.0), vec2(2.0, 0.0), vec2(0.0, 2.0)
  );

  @vertex
  fn ${_t}(
    @builtin(vertex_index) vertexId: u32,
    @builtin(instance_index) instanceId: u32,
  ) -> VertexOutput {
    var out: VertexOutput;
    out.position = vec4f(pos[vertexId], 0.0, 1.0);
    out.uv = uv[vertexId];
    out.instanceId = instanceId;
    return out;
  }
`,Tp=/#([^\s]*)(\s*)/gm;class wc{constructor(e){ee(this,"elseIsValid",!0);ee(this,"branches",[]);this.pushBranch("if",e)}pushBranch(e,t){if(!this.elseIsValid)throw new Error(`#${e} not preceeded by an #if or #elif`);this.elseIsValid=e==="if"||e==="elif",this.branches.push({expression:!!t,string:""})}appendStringToCurrentBranch(...e){for(const t of e)this.branches[this.branches.length-1].string+=t}resolve(){for(const e of this.branches)if(e.expression)return e.string;return""}}function Bt(s,...e){const t=[];let r=new wc(!0);r.elseIsValid=!1;const n=(i,o)=>{if(i.index+i[0].length!=o.length)throw new Error(`#${i[1]} must be immediately followed by a template expression (ie: \${value})`)};for(let i=0;i<s.length;++i){const o=s[i],c=o.matchAll(Tp);let d=0,g=!1;for(const b of c){switch(r.appendStringToCurrentBranch(o.substring(d,b.index)),b[1]){case"if":n(b,o),g=!0,t.push(r),r=new wc(e[i]);break;case"elif":n(b,o),g=!0,r.pushBranch(b[1],e[i]);break;case"else":r.pushBranch(b[1],!0),r.appendStringToCurrentBranch(b[2]);break;case"endif":if(!t.length)throw new Error(`#${b[1]} not preceeded by an #if`);const l=r.resolve();r=t.pop(),r.appendStringToCurrentBranch(l,b[2]);break;default:r.appendStringToCurrentBranch(b[0])}d=b.index+b[0].length}d!=o.length&&r.appendStringToCurrentBranch(o.substring(d,o.length)),!g&&e.length>i&&r.appendStringToCurrentBranch(e[i])}if(t.length)throw new Error("Mismatched #if/#endif count");return r.resolve()}const Vr=`
  fn encodeNormal(n: vec3f) -> vec2f {
    // return n.xy* 0.5 + 0.5;
    let p = sqrt(n.z * 8 + 8);
    return n.xy / p + 0.5;
  }
 
  fn decodeNormal(enc: vec2f) -> vec3f {
    
    let fenc = enc * 4 - 2;
    let f = dot(fenc, fenc);
    let g = sqrt(1 - f / 4);
    
    return vec3f(
      fenc * g,
      1 - f / 2
    );
  }
`,Cc="fragmentShaderDebugTexture",Sp=new Map([[q.Albedo,"Albedo"],[q.Normal,"View-Space Normal"],[q.AO,"Screen-Space AO"],[q.Metallic,"Metallic"],[q.Roughness,"Roughness"],[q.Reflectance,"Reflectance"],[q.Depth,"Depth"],[q.Velocity,"Velocity"],[q.ShadowDepthCascade0,"Cascade #1"],[q.ShadowDepthCascade1,"Cascade #2"]]);class rt{constructor(e){this.type=e,this.$rootEl=document.createElement("div"),this.$headline=document.createElement("h4"),this.$canvas=document.createElement("canvas"),this.$rootEl.classList.add("debug-canvas-wrapper"),this.$canvas.classList.add("debug-canvas"),this.$headline.innerText=Sp.get(e),this.$rootEl.appendChild(this.$headline),this.$rootEl.appendChild(this.$canvas),this.ctx=this.$canvas.getContext("webgpu"),this.ctx.configure({device:v.device,format:v.pixelFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT});const t=[{format:v.pixelFormat}];var r;this.samplerTextureBindGroupLayoutEntries=[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:this.isDepthTexture?"depth":"float"}}],this.samplerTextureBindGroupLayout=v.device.createBindGroupLayout({label:"TextureDebugMesh Sampler + Texture GPUBindGroupLayout",entries:this.samplerTextureBindGroupLayoutEntries}),this.renderPSO=j.createRenderPipeline({label:`Debug Canvas ${e} Render PSO`,vertex:{module:j.createShaderModule(Jt),entryPoint:_t},fragment:{module:j.createShaderModule((r=this.type,Bt`
  ${Y.VertexOutput}

  ${Vr}

  @group(0) @binding(0) var mySampler: sampler;

  #if ${r===q.Depth||r===q.ShadowDepthCascade0||r===q.ShadowDepthCascade1}
    @group(0) @binding(1) var myTexture: texture_depth_2d;
  #else
    @group(0) @binding(1) var myTexture: texture_2d<f32>;
  #endif

  @fragment
  fn ${Cc}(in: VertexOutput) -> @location(0) vec4<f32> {
    var uv = in.uv;
    uv.y = 1.0 - uv.y;
    var color: vec4f;
    #if ${r===q.Normal}
    color = vec4f(decodeNormal(textureSample(myTexture, mySampler, uv).rg), 1.0);
    // color = vec4f(textureSample(myTexture, mySampler, uv).rgb, 1.0);
    #elif ${r===q.Metallic}
    color = vec4f(textureSample(myTexture, mySampler, uv).bbb, 1.0);
    #elif ${r===q.Roughness}
    color = vec4f(textureSample(myTexture, mySampler, uv).aaa, 1.0);
    #elif ${r===q.Reflectance}
    color = vec4f(textureSample(myTexture, mySampler, uv).a, 0.0, 0.0, 1.0);
    #elif ${r===q.Depth}
    let depth = textureSample(myTexture, mySampler, uv);

    let near: f32 = 0.1; // Example near plane
    let far: f32 = 20.0; // Example far plane

    // Linearize the depth (from clip space depth to linear depth)
    let depth_linear = near * far / (far - depth * (far - near));

    // Normalize the linear depth to [0, 1] (NDC space)
    let depth_ndc = (depth_linear - near) / (far - near);
    color = vec4f(vec3f(depth_ndc), 1);

    #elif ${r===q.ShadowDepthCascade0||r===q.ShadowDepthCascade1}
    let depth = textureSample(myTexture, mySampler, uv);

    let near: f32 = 0.1; // Example near plane
    let far: f32 = 1.0; // Example far plane

    // Linearize the depth (from clip space depth to linear depth)
    let depth_linear = near * far / (far - depth * (far - near));

    // Normalize the linear depth to [0, 1] (NDC space)
    let depth_ndc = (depth_linear - near) / (far - near);
    color = vec4f(vec3f(depth_ndc), 1);
    #elif ${r===q.Velocity}
    color = vec4f(textureSample(myTexture, mySampler, uv).rg * 100, 0, 1);
    #elif ${r===q.BDRF}
    color = vec4f(textureSample(myTexture, mySampler, in.uv).rg, 0, 1);
    #elif ${r===q.Albedo}
    color = vec4f(textureSample(myTexture, mySampler, uv).rgb, 1);
    #elif ${r===q.AO}
    color = vec4f(textureSample(myTexture, mySampler, uv).rrr, 1);
    #else
    color = textureSample(myTexture, mySampler, uv);
    #endif
    return color;
  }
`)),entryPoint:Cc,targets:t},layout:v.device.createPipelineLayout({label:`Debug Canvas ${e} Render PSO Layout`,bindGroupLayouts:[this.samplerTextureBindGroupLayout]})}),this.renderPassDescriptor={label:`Debug Canvas ${e} Render Pass Descriptor`,colorAttachments:[{loadOp:"load",storeOp:"store",view:null}]}}get isDepthTexture(){return this.type===q.Depth||this.type===q.ShadowDepthCascade0||this.type===q.ShadowDepthCascade1}appendTo(e){e.appendChild(this.$rootEl)}setTexture(e,t=e.width,r=e.height){this.debugTexture=e,this.$canvas.width=t,this.$canvas.height=r;let n=0;this.type===q.ShadowDepthCascade0?n=0:this.type===q.ShadowDepthCascade1&&(n=1);const i=[{binding:0,resource:He.createSampler({magFilter:"linear",minFilter:"linear"})},{binding:1,resource:e.createView({aspect:this.isDepthTexture?"depth-only":"all",baseArrayLayer:n,dimension:"2d"})}];this.samplerTextureBindGroup=v.device.createBindGroup({layout:this.samplerTextureBindGroupLayout,entries:i})}render(e){if(!this.debugTexture)return;this.renderPassDescriptor.colorAttachments[0].view=this.ctx.getCurrentTexture().createView();const t=e.beginRenderPass(this.renderPassDescriptor);v.ENABLE_DEBUG_GROUPS&&t.pushDebugGroup(`Display Debug Texture ${this.type}`),t.setPipeline(this.renderPSO),t.setBindGroup(0,this.samplerTextureBindGroup),t.draw(3),v.ENABLE_DEBUG_GROUPS&&t.popDebugGroup(),t.end()}}var ki=(s=>(s[s.GBuffer=0]="GBuffer",s[s.Shadow=1]="Shadow",s))(ki||{});const Ep=new Map([[0,"G-Buffer Debug"],[1,"Shadows Debug"]]);class Ys{constructor(e){this.canvases=new Map,this.$root=Ys.createRootElement(),this.$main=document.createElement("div"),this.$main.classList.add("section");const t=document.createElement("h2");t.textContent=Ep.get(e),t.classList.add("section-headline"),this.$root.appendChild(t),this.$root.appendChild(this.$main)}static createRootElement(){const e=document.createElement("div");return e.classList.add("texture-debug-wrapper"),e}appendTo(e){e.appendChild(this.$root)}setTextureFor(e,t,r=.2*t.width,n=.2*t.height){return this.canvases.get(e).setTexture(t,r,n),this}render(e){for(const t of this.canvases.values())t.render(e)}}class Mp extends Ys{constructor(){super(ki.GBuffer);const e=new rt(q.Albedo);e.appendTo(this.$main),this.canvases.set(q.Albedo,e);const t=new rt(q.Normal);t.appendTo(this.$main),this.canvases.set(q.Normal,t);const r=new rt(q.Metallic);r.appendTo(this.$main),this.canvases.set(q.Metallic,r);const n=new rt(q.Roughness);n.appendTo(this.$main),this.canvases.set(q.Roughness,n);const i=new rt(q.AO);i.appendTo(this.$main),this.canvases.set(q.AO,i);const o=new rt(q.Reflectance);o.appendTo(this.$main),this.canvases.set(q.Reflectance,o);const c=new rt(q.Depth);c.appendTo(this.$main),this.canvases.set(q.Depth,c);const d=new rt(q.Velocity);d.appendTo(this.$main),this.canvases.set(q.Velocity,d)}}class Pp extends Ys{constructor(){super(ki.Shadow);const e=new rt(q.ShadowDepthCascade0);e.appendTo(this.$main),this.canvases.set(q.ShadowDepthCascade0,e);const t=new rt(q.ShadowDepthCascade1);t.appendTo(this.$main),this.canvases.set(q.ShadowDepthCascade1,t)}}const hn=class hn{constructor(){this.open=!1,this.$root=document.createElement("div"),this.$root.id=hn.ROOT_EL_ID,document.body.appendChild(this.$root),this.gbufferDebugSection=new Mp,this.gbufferDebugSection.appendTo(this.$root),this.shadowDebugSection=new Pp,this.shadowDebugSection.appendTo(this.$root)}reveal(){this.open=!0,this.$root.classList.add("open")}hide(){this.open=!1,this.$root.classList.remove("open")}scrollToShadowSection(){this.shadowDebugSection.$root.scrollIntoView({block:"start",inline:"nearest"})}scrollIntoGbufferSection(){this.gbufferDebugSection.$root.scrollIntoView({block:"start",inline:"nearest"})}setTextureGBufferSection(e,t,r=.2*t.width,n=.2*t.height){return this.open?(this.gbufferDebugSection.setTextureFor(e,t,r,n),this):this}setTextureShadowSection(e,t,r=.2*t.width,n=.2*t.height){return this.open?(this.shadowDebugSection.setTextureFor(e,t,r,n),this):this}render(e){this.open&&(this.gbufferDebugSection.render(e),this.shadowDebugSection.render(e))}};hn.ROOT_EL_ID="webgpu-debug-root";let Ni=hn;const Gp=new Map([[se.CPUTotal,"cpu-total"],[se.GPUTotal,"gpu-total"],[se.FPS,"fps"],[se.VRAM,"vram"],[se.VisibleMeshes,"culled-meshes"],[se.LightsCount,"lights-count"],[se.DeferredRenderPass,"deferred"],[se.DirectionalAmbientLightingRenderPass,"directional-ambient-light"],[se.PointLightsStencilMask,"point-lights-stencil-mask"],[se.PointLightsLighting,"point-lights-lighting"],[se.SSAORenderPass,"ssao"],[se.TransparentRenderPass,"transparent"],[se.ShadowRenderPass,"shadow"],[se.TAAResolveRenderPass,"taa-resolve"],[se.ReflectionRenderPass,"reflection"],[se.BlitRenderPass,"blit"]]),Rp=new Map([[se.CPUTotal,"CPU"],[se.GPUTotal,"GPU"],[se.FPS,"FPS"],[se.VRAM,"VRAM Usage"],[se.VisibleMeshes,"Visible Meshes"],[se.LightsCount,"Lights Count"],[se.DeferredRenderPass,"G-Buffer Render Pass"],[se.DirectionalAmbientLightingRenderPass,"Directional + Ambient Render Pass"],[se.PointLightsStencilMask,"Point Lights Stencil Mask Pass"],[se.PointLightsLighting,"Point Lights Render Pass"],[se.SSAORenderPass,"SSAO Render Pass"],[se.TransparentRenderPass,"Transparent Render Pass"],[se.ShadowRenderPass,"Directional Shadow Render Pass"],[se.TAAResolveRenderPass,"TAA Resolve Render Pass"],[se.ReflectionRenderPass,"Reflection Render Pass"],[se.BlitRenderPass,"Blit Render Pass"]]),po=class po{constructor(){this.$renderPassTimingDisplayEls=new Map,this.$root=document.createElement("div"),this.$root.id="timings-debug-container",this.$root.classList.add("fadable","hidden"),document.body.appendChild(this.$root);for(const e of Ad){const t=Gp.get(e),r=document.createElement("div");r.id=`${t}-debug-timing`,r.classList.add("timing-container"),this.$root.appendChild(r);const n=document.createElement("div");n.classList.add("timing-label"),n.innerText=`${Rp.get(e)}:`,r.appendChild(n);const i=document.createElement("div");i.classList.add("timing-value"),r.appendChild(i);const o={root:r,label:n,value:i};this.$renderPassTimingDisplayEls.set(e,o)}}toggleVisibility(){this.$root.classList.toggle("hidden")}setDisplayValue(e,t){return this.$renderPassTimingDisplayEls.get(e).value.innerText=t,this}};po.NOT_AVAILABLE_STR="N/A";let Vi=po;const Lp=yt(Ot(Y.Light).structs.Light);class gr extends nr{constructor(e){super(),this.lightType=e,this._color=D.create(1,1,0),this._intensity=1;const t=Ot(Y.Light);this.lightsStorageView=yt(t.structs.Light),this.lightsStorageView.set({color:this._color,position:this.position,lightType:Bd.get(e),intensity:1})}static get STRUCT_BYTE_SIZE(){return Lp.arrayBuffer.byteLength}get intensity(){return this._intensity}set intensity(e){this._intensity=e,this.lightsStorageView.set({intensity:e})}get color(){return this.getColor()}set color(e){this.setColor(e[0],e[1],e[2])}setColor(e,t,r){this._color[0]=e,this._color[1]=t,this._color[2]=r,this.lightsStorageView.set({color:this._color})}setColorAsVec3(e){D.copy(e,this._color),this.lightsStorageView.set({color:this._color})}getColor(){return this._color}setPosition(e,t,r){return super.setPosition(e,t,r),this.lightsStorageView.set({position:this.position}),this}setPositionAsVec3(e){return super.setPositionAsVec3(e),this.lightsStorageView.set({position:this.position}),this}setPositionX(e){return super.setPositionX(e),this.lightsStorageView.set({position:this.position}),this}setPositionY(e){return super.setPositionY(e),this.lightsStorageView.set({position:this.position}),this}setPositionZ(e){return super.setPositionZ(e),this.lightsStorageView.set({position:this.position}),this}}class Hi extends gr{constructor(){super(It.Directional)}}class zt extends gr{get radius(){return this._radius}set radius(e){this._radius=e,this.lightsStorageView.set({radius:e})}constructor(){super(It.Point),this.intensity=1,this.radius=1}}class dt extends zt{static get bindGroupLayout(){if(this._bindGroupLayout)return this._bindGroupLayout;const e=[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{}}];return this._bindGroupLayout=v.device.createBindGroupLayout({label:"Camera Face Culled Point Light Bind Group Layout",entries:e}),this._bindGroupLayout}updateGPUBuffer(){v.device.queue.writeBuffer(this.gpuBuffer,0,this.lightsStorageView.arrayBuffer)}constructor(){super(),this.gpuBuffer=v.device.createBuffer({label:"Camera Face Culled Point Light GPU Buffer",size:gr.STRUCT_BYTE_SIZE,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),W.addBufferBytes(this.gpuBuffer),this.lightsStorageView.set({type:1,intensity:1,radius:1,color:D.create(1,1,1),position:D.create(0,1,0)}),this.updateGPUBuffer();const e=[{binding:0,resource:{buffer:this.gpuBuffer}}];this.bindGroup=v.device.createBindGroup({label:"Camera Face Culled Point Light Bind Group",entries:e,layout:dt.bindGroupLayout})}}class Op{constructor(){this.pointLights=[],this.cameraFaceCulledPointLights=[],this.directionalLights=[],this.allLights=[]}get lightsCount(){return this.allLights.length}get pointLightsCount(){return this.pointLights.length}get directionalLightsCount(){return this.directionalLights.length}updateGPUBuffer(){if(!this.allLights.length)return void console.warn("No lights, skip creating GPUBuffer");this.gpuBuffer&&(W.removeBufferBytes(this.gpuBuffer),this.gpuBuffer.destroy()),this.gpuBuffer=v.device.createBuffer({label:"Lights GPU Buffer",size:gr.STRUCT_BYTE_SIZE*this.allLights.length,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.STORAGE}),W.addBufferBytes(this.gpuBuffer);let e=0;for(let t=0;t<this.directionalLights.length;t++)v.device.queue.writeBuffer(this.gpuBuffer,e*gr.STRUCT_BYTE_SIZE,this.directionalLights[t].lightsStorageView.arrayBuffer),e++;for(let t=0;t<this.pointLights.length;t++)v.device.queue.writeBuffer(this.gpuBuffer,e*gr.STRUCT_BYTE_SIZE,this.pointLights[t].lightsStorageView.arrayBuffer),e++;return this}addLight(e){return e instanceof dt?this.cameraFaceCulledPointLights.push(e):e instanceof zt?this.pointLights.push(e):e instanceof Hi&&this.directionalLights.push(e),this.allLights.push(e),this}removeLight(e){const t=r=>r.id!==e.id;return e instanceof dt?this.cameraFaceCulledPointLights=this.cameraFaceCulledPointLights.filter(t):e instanceof zt?this.pointLights=this.pointLights.filter(t):e instanceof Hi&&(this.directionalLights=this.directionalLights.filter(t)),this.allLights=this.allLights.filter(t),this}render(e){throw new Error("Needs implementation")}}const Kt=yt(Ot(Y.Particle).structs.Particle),We=class We{constructor({radius:e,position:t,velocity:r,lifeSpeed:n,life:i}={radius:1,position:D.create(0,3,0),velocity:D.create(0,1,0),lifeSpeed:1,life:0}){this.radius=e,this.position=t,this.origPosition=t,this.velocity=r,this.lifeSpeed=n,this.life=i}};We.STRUCT_BYTE_SIZE=Kt.arrayBuffer.byteLength,We.STRUCT_FLOATS_COUNT=We.STRUCT_BYTE_SIZE/Float32Array.BYTES_PER_ELEMENT,We.RADIUS_OFFSET=Kt.views.radius.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.POSITION_OFFSET=Kt.views.position.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.ORIG_POSITION_OFFSET=Kt.views.origPosition.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.VELOCITY_OFFSET=Kt.views.velocity.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.LIFE_OFFSET=Kt.views.life.byteOffset/Float32Array.BYTES_PER_ELEMENT,We.LIFE_SPEED_OFFSET=Kt.views.lifeSpeed.byteOffset/Float32Array.BYTES_PER_ELEMENT;let Xe=We;const Tc="vertexMain",Sc="fragMain",Ip=`
  ${Y.Particle}
  ${Y.Light}
  ${Y.Camera}

  struct VertexOut {
    @builtin(position) position: vec4f,
    @location(0) uv: vec2f,
    @location(1) @interpolate(flat) instanceId: u32,
  };

  @group(0) @binding(0) var<uniform> camera: Camera;

  @group(1) @binding(0) var<storage, read> particles: array<Particle>;
  @group(1) @binding(1) var<storage, read> lights: array<Light>;

  override ANIMATED_PARTICLES_OFFSET_START: u32;
  override CURVE_PARTICLES_OFFSET: u32;

  const positions = array<vec2f, 4>(
    vec2f(-1.0, -1.0), 
    vec2f(1.0, -1.0),  
    vec2f(-1.0, 1.0),   
    vec2f(1.0, 1.0),   
  );

  const uvs = array<vec2f, 4>(
    vec2f(0.0, 1.0),
    vec2f(1.0, 1.0),
    vec2f(0.0, 0.0),
    vec2f(1.0, 0.0),
  );

  @vertex
  fn ${Tc}(
    @builtin(vertex_index) vertexId: u32,
    @builtin(instance_index) instanceId: u32,
  ) -> VertexOut {
    let p = particles[instanceId];
    let particlePosition = p.position;
    let particleRadius = select(p.radius - p.radius * p.life, p.radius, instanceId >= CURVE_PARTICLES_OFFSET);
    // let particleRadius = p.radius;
    let uv = uvs[vertexId];
    var out: VertexOut;
    out.position = camera.projectionViewMatrix * vec4f(particlePosition, 1);
    let aspect = f32(camera.viewportWidth) / f32(camera.viewportHeight);
    out.position += vec4f(positions[vertexId].xy * vec2f(particleRadius, particleRadius * aspect), 0, 0);
    out.instanceId = instanceId;
    out.uv = uv;
    return out;
  }

  @fragment
  fn ${Sc}(
    in: VertexOut
  ) -> @location(0) vec4f {
    let light = &lights[in.instanceId + ANIMATED_PARTICLES_OFFSET_START];
    let d = distance(in.uv, vec2f(0.5));
    let mask = 1.0 - smoothstep(0.2, 0.5, d);
    if (mask < 0.2) {
      discard;
    }
    let lightColor = light.color;
    return vec4f(light.color * mask * 0.8, 1);
  }
`,Ec="updatePointLights",Fp=`
  ${Y.Particle}
  ${Y.Light}

  struct SimSettings {
    time: f32,
    timeDelta: f32,
  };

  @group(0) @binding(0) var<storage, read_write> particles: array<Particle>;
  @group(0) @binding(1) var<storage, read_write> lights: array<Light>;
  @group(0) @binding(2) var<uniform> simSettings: SimSettings;
  @group(0) @binding(3) var<storage, read> linePointPositions: array<vec4f>;
  @group(0) @binding(4) var<uniform> fireParticlesRevealFactor: f32;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;
  override ANIMATED_PARTICLES_OFFSET_START: u32;
  override FIREWORK_PARTICLES_OFFSET: u32;
  override FIREWORK_PARTICLES_COUNT: u32;
  override CURVE_PARTICLES_OFFSET: u32;
  override CURVE_PARTICLES_COUNT: u32;
  override CURVE_POSITIONS_COUNT: u32;
  
  @must_use
  fn noise(p: vec3f) -> f32 {
    return fract(
      sin(dot(p, vec3f(12.9898, 78.233, 45.164))) * 43758.5453
    );
  }

  @must_use
  fn random(seed: f32) -> f32 {
    return fract(sin(seed * 12.9898) * 43758.5453);
  }

  // Curl noise for more natural 3D fluid-like motion
  fn curlNoise(p: vec3<f32>) -> vec3<f32> {
    let eps = 0.1;
    
    let nx = noise(p + vec3<f32>(eps, 0.0, 0.0));
    let ny = noise(p + vec3<f32>(0.0, eps, 0.0));
    let nz = noise(p + vec3<f32>(0.0, 0.0, eps));
    
    let x = ny - noise(p - vec3<f32>(eps, 0.0, 0.0));
    let y = nz - noise(p - vec3<f32>(0.0, eps, 0.0));
    let z = nx - noise(p - vec3<f32>(0.0, 0.0, eps));
    
    return vec3<f32>(x, y, z) / (2.0 * eps);
  }

  fn interpolateLinePoint(t: f32) -> vec3f {
    let totalCount = CURVE_POSITIONS_COUNT;
    let segmentLength = 1.0 / f32(totalCount - 1u);
    let baseIndex = u32(t / segmentLength);
    let localT = fract(t / segmentLength);
    let safeIndex = min(baseIndex, totalCount - 2u);
    let start = linePointPositions[safeIndex];
    let end = linePointPositions[safeIndex + 1u];
    return mix(start, end, localT).xyz;
  }

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)
  fn ${Ec}(
    @builtin(global_invocation_id) tid : vec3u
  ) {
    let idx = tid.x;
    let particle = &particles[idx];
    let light = &lights[idx + ANIMATED_PARTICLES_OFFSET_START];

    particle.life += particle.lifeSpeed * simSettings.timeDelta;

    if (particle.life >= 1) {
      particle.position = particle.origPosition;
      particle.life = 0;
    }

    if (idx >= FIREWORK_PARTICLES_OFFSET && idx < FIREWORK_PARTICLES_COUNT) {
      let turbulence = curlNoise(
        particle.position * 0.05 + 
        vec3<f32>(0.0, simSettings.time * 0.05, 0.0)
      ) * 0.2;
      particle.position += (particle.velocity + turbulence) * simSettings.timeDelta;
      light.intensity = saturate((1 - particle.life) * fireParticlesRevealFactor);
      particle.radius = 0.025 * fireParticlesRevealFactor;
      // light.radius *= fireParticlesRevealFactor;
      // light.intensity *= fireParticlesRevealFactor;
    }

    if (idx >= CURVE_PARTICLES_OFFSET && idx < CURVE_PARTICLES_OFFSET + CURVE_PARTICLES_COUNT) {
      particle.position = interpolateLinePoint(particle.life) + particle.velocity;  
    }

    if (idx >= CURVE_PARTICLES_OFFSET + CURVE_PARTICLES_COUNT) {
      particle.position = vec3f(
        particle.life * 15 - 7.5,
        cos(particle.life + particle.life * particle.velocity.y * 30) * 1.2 + 3.5,
        sin(particle.life + particle.life * particle.velocity.y * 30) * 1.075 + particle.velocity.x
      );
      let fadeIn = smoothstep(0.0, 0.1, particle.life);
      let fadeOut = 1.0 - smoothstep(0.9, 1.0, particle.life);
      light.intensity = 0.5 * fadeIn * fadeOut;
      light.radius = 1 * fadeIn * fadeOut;
    }
    light.position = particle.position;

  }
`,qs=[D.create(3.9,3,.9),D.create(3.9,3,-1.5),D.create(-4.95,3,.9),D.create(-4.95,3,-1.5)],Dp=[D.create(3.9,3,1.15),D.create(3.9,3,-1.75),D.create(-4.95,3,1.15),D.create(-4.95,3,-1.75)],Hr=D.scale(D.create(1,.01,.01),10),le=class le extends Op{constructor(e){super(),this.particles=[],this.mainFireLights=[],this.particlesSimSettingsArr=new Float32Array(2).fill(0),this.render2ndFloorParticles=!0;const t=new Hi;t.setPositionAsVec3(Ac),t.setColor(.2156,.2627,.3333),t.intensity=0,this.addLight(t),this.mainDirLight=t;const r=new dt;r.radius=0,r.intensity=0,r.setPositionAsVec3(qs[0]),r.setColorAsVec3(Hr),r.updateGPUBuffer(),this.addLight(r),this.mainFireLights.push(r);const n=new dt;n.radius=0,n.intensity=0,n.setPositionAsVec3(qs[1]),n.setColorAsVec3(Hr),n.updateGPUBuffer(),this.addLight(n),this.mainFireLights.push(n);const i=new dt;i.intensity=0,i.radius=0,i.setPositionAsVec3(qs[2]),i.setColorAsVec3(Hr),i.updateGPUBuffer(),this.addLight(i),this.mainFireLights.push(i);const o=new dt;o.intensity=0,o.radius=0,o.setPositionAsVec3(qs[3]),o.setColorAsVec3(Hr),o.updateGPUBuffer(),this.addLight(o),this.mainFireLights.push(o);for(let p=0;p<le.PARTICLES_PER_FIRE;p++)for(let a=0;a<4;a++){const u=new zt,h=D.add(Dp[a],D.create(.1*(2*Math.random()-1),0,.1*(2*Math.random()-1)));u.radius=.5,u.intensity=.1,u.setPositionAsVec3(h),u.setColorAsVec3(Hr),this.addParticleLight(u,.025)}const c=v.device.createBuffer({label:"Lighting System Curve Points GPU Buffer",size:4*e.length*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0});W.addBufferBytes(c);const d=new Float32Array(c.getMappedRange());for(let p=0;p<e.length;p++)d[4*p+0]=e[p][0],d[4*p+1]=e[p][1],d[4*p+2]=e[p][2],d[4*p+3]=1;c.unmap();const g=D.create();for(let p=0;p<le.PARTICLES_PER_CURVE;p++){const a=new zt;a.setColor(3*Math.random()+1,3*Math.random()+1,3*Math.random()+1),a.setPositionAsVec3(g),a.radius=2,a.intensity=1;const u=p/le.PARTICLES_PER_CURVE;this.addParticleLight(a,.02,u,.01,D.random(.5))}this.particlesLength=this.particles.length;for(let p=0;p<le.PARTICLES_PER_CORRIDOR;p++){const a=new zt;a.setColor(3*Math.random()+1,3*Math.random()+1,3*Math.random()+1),a.setPositionAsVec3(g),a.radius=1,this.addParticleLight(a,.02,p/le.PARTICLES_PER_CORRIDOR,.01,D.create(3.125,1,0))}for(let p=0;p<le.PARTICLES_PER_CORRIDOR;p++){const a=new zt;a.setColor(3*Math.random()+1,3*Math.random()+1,3*Math.random()+1),a.setPositionAsVec3(g),a.radius=1,this.addParticleLight(a,.02,p/le.PARTICLES_PER_CORRIDOR,.01,D.create(-3.775,-1,0))}console.log(this.lightsCount),this.updateGPUBuffer(),this.updateParticlesBuffer(),this.particleSimSettingsBuffer=v.device.createBuffer({label:"Particles Update Sim Settings",size:2*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),W.addBufferBytes(this.particleSimSettingsBuffer),this.fireParticlesRevealBuffer=v.device.createBuffer({label:"Fire Particles Reveal Factor Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),W.addBufferBytes(this.fireParticlesRevealBuffer),new Float32Array(this.fireParticlesRevealBuffer.getMappedRange()).set([0]),this.fireParticlesRevealBuffer.unmap();const b=[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{}}],l=v.device.createBindGroupLayout({label:"Lights Compute Bind Group Layout",entries:b}),x=[{binding:0,resource:{buffer:this.particlesGPUBuffer}},{binding:1,resource:{buffer:this.gpuBuffer}},{binding:2,resource:{buffer:this.particleSimSettingsBuffer}},{binding:3,resource:{buffer:c}},{binding:4,resource:{buffer:this.fireParticlesRevealBuffer}}];this.computeBindGroup=v.device.createBindGroup({label:"Lights Compute Bind Group",entries:x,layout:l});const m=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}],_=v.device.createBindGroupLayout({label:"Lights Render Bind Group Layout",entries:m}),w=[{binding:0,resource:{buffer:this.particlesGPUBuffer}},{binding:1,resource:{buffer:this.gpuBuffer}}];this.renderBindGroup=v.device.createBindGroup({label:"Lights Render Bind Group",entries:w,layout:_}),this.computePSO=j.createComputePipeline({label:"Update Lights Compute PSO",layout:v.device.createPipelineLayout({label:"Lights Compute PSO Layout",bindGroupLayouts:[l]}),compute:{entryPoint:Ec,module:j.createShaderModule(Fp,"Update Lights Shader Module"),constants:{WORKGROUP_SIZE_X:le.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:le.COMPUTE_WORKGROUP_SIZE_Y,ANIMATED_PARTICLES_OFFSET_START:1,FIREWORK_PARTICLES_OFFSET:0,FIREWORK_PARTICLES_COUNT:4*le.PARTICLES_PER_FIRE,CURVE_PARTICLES_OFFSET:4*le.PARTICLES_PER_FIRE,CURVE_PARTICLES_COUNT:le.PARTICLES_PER_CURVE,CURVE_POSITIONS_COUNT:e.length}}});const f=j.createShaderModule(Ip,"Render Lights Shader Module");this.renderPSO=j.createRenderPipeline({label:"Render Lights PSO",layout:v.device.createPipelineLayout({label:"Lights Render PSO Layout",bindGroupLayouts:[j.defaultCameraPlusLightsBindGroupLayout,_]}),vertex:{entryPoint:Tc,module:f,constants:{CURVE_PARTICLES_OFFSET:4*le.PARTICLES_PER_FIRE}},fragment:{entryPoint:Sc,module:f,targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{operation:"add",srcFactor:"one",dstFactor:"one"}}}],constants:{ANIMATED_PARTICLES_OFFSET_START:1}},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less"}}),this.particleIndexBuffer=v.device.createBuffer({label:"Particle Index Buffer",size:6*Uint16Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.INDEX,mappedAtCreation:!0}),W.addBufferBytes(this.particleIndexBuffer),new Uint16Array(this.particleIndexBuffer.getMappedRange()).set([0,1,3,0,2,3]),this.particleIndexBuffer.unmap()}uploadMainDirLightToGPU(){v.device.queue.writeBuffer(this.gpuBuffer,0,this.mainDirLight.lightsStorageView.arrayBuffer)}set sunIntensity(e){this.mainDirLight.intensity=e,this.uploadMainDirLightToGPU()}set sunPositionX(e){this.mainDirLight.setPositionX(e),this.uploadMainDirLightToGPU()}set sunPositionY(e){this.mainDirLight.setPositionY(e),this.uploadMainDirLightToGPU()}set sunPositionZ(e){this.mainDirLight.setPositionZ(e),this.uploadMainDirLightToGPU()}addParticleLight(e,t=.05,r=0,n=1.5*Math.random()+.35,i=D.create(0,.5,0)){super.addLight(e);const o=new Xe({radius:t,position:e.position,velocity:i,lifeSpeed:n,life:r});return this.particles.push(o),this}updateParticlesBuffer(){this.particlesGPUBuffer&&(W.removeBufferBytes(this.particlesGPUBuffer),this.particlesGPUBuffer.destroy()),this.particlesGPUBuffer=v.device.createBuffer({label:"Light Particles GPU Buffer",size:Xe.STRUCT_BYTE_SIZE*this.particles.length,mappedAtCreation:!0,usage:GPUBufferUsage.STORAGE}),W.addBufferBytes(this.particlesGPUBuffer);const e=new Float32Array(this.particlesGPUBuffer.getMappedRange());for(let t=0;t<this.particles.length;t++){const r=t*Xe.STRUCT_FLOATS_COUNT,n=r+Xe.POSITION_OFFSET,i=r+Xe.ORIG_POSITION_OFFSET,o=r+Xe.VELOCITY_OFFSET,c=r+Xe.LIFE_OFFSET,d=r+Xe.LIFE_SPEED_OFFSET,g=r+Xe.RADIUS_OFFSET;e[n+0]=this.particles[t].position[0],e[n+1]=this.particles[t].position[1],e[n+2]=this.particles[t].position[2],e[i+0]=this.particles[t].origPosition[0],e[i+1]=this.particles[t].origPosition[1],e[i+2]=this.particles[t].origPosition[2],e[o+0]=this.particles[t].velocity[0],e[o+1]=this.particles[t].velocity[1],e[o+2]=this.particles[t].velocity[2],e[c]=this.particles[t].life,e[d]=this.particles[t].lifeSpeed,e[g]=this.particles[t].radius}this.particlesGPUBuffer.unmap(),this.particles=null}set fireParticlesRevealFactor(e){this.updateFireParticlesRevealBuffer(e);for(const t of this.mainFireLights)t.radius=le.MAIN_FIRE_LIGHT_RADIUS*e,t.intensity=le.MAIN_FIRE_LIGHT_INTENSITY*e,t.updateGPUBuffer()}updateFireParticlesRevealBuffer(e){v.device.queue.writeBuffer(this.fireParticlesRevealBuffer,0,new Float32Array([e]))}update(e){this.particlesSimSettingsArr[0]=v.elapsedTimeMs,this.particlesSimSettingsArr[1]=v.deltaTimeMs,v.device.queue.writeBuffer(this.particleSimSettingsBuffer,0,this.particlesSimSettingsArr);const t=e.beginComputePass({label:"Update Lights Compute Encoder"});t.setPipeline(this.computePSO),t.setBindGroup(0,this.computeBindGroup);const r=Math.ceil(this.allLights.length/le.COMPUTE_WORKGROUP_SIZE_X);t.dispatchWorkgroups(r,1,1),t.end()}render(e){e.setPipeline(this.renderPSO),e.setBindGroup(1,this.renderBindGroup),e.setIndexBuffer(this.particleIndexBuffer,_e.INDEX_FORMAT),e.drawIndexed(6,this.render2ndFloorParticles?this.particlesLength:4*le.PARTICLES_PER_FIRE)}};le.COMPUTE_WORKGROUP_SIZE_X=8,le.COMPUTE_WORKGROUP_SIZE_Y=1,le.MAIN_FIRE_LIGHT_RADIUS=3,le.MAIN_FIRE_LIGHT_INTENSITY=.3,le.PARTICLES_PER_FIRE=64,le.PARTICLES_PER_CURVE=150,le.PARTICLES_PER_CORRIDOR=32;let ji=le;class ht{constructor({vertexShaderSrc:e,vertexShaderEntryFn:t,vertexBuffers:r=xe.defaultLayout,fragmentShaderSrc:n,fragmentShaderEntryFn:i,bindGroupLayouts:o=[j.defaultCameraBindGroupLayout,j.defaultModelBindGroupLayout,j.defaultModelMaterialBindGroupLayout],constants:c={},targets:d=[],depthStencilState:g={format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"},primitive:b={cullMode:"back",topology:"triangle-list"},debugLabel:l}){const x={label:l,layout:v.device.createPipelineLayout({bindGroupLayouts:o}),vertex:{module:j.createShaderModule(e,`${l} material vertex shader module`),entryPoint:t,buffers:r}};if(i&&n&&d.length){const m=j.createShaderModule(n,`${l} material fragment shader module`);x.fragment={module:m,entryPoint:i,targets:d,constants:c}}g&&(x.depthStencil=g),b&&(x.primitive=b),this.renderPSO=j.createRenderPipeline(x)}bind(){v.bindRenderPSO(this.renderPSO)}}const Mc="vertexMain",Pc="fragmentMain",Gc=`
  ${Y.VertexInput}
  ${Y.VertexOutput}
  ${Y.GBufferOutput}
  ${Y.Camera}
  ${Y.ModelUniform}

  @group(${ae.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(1) @binding(0) var inTexture: texture_cube<f32>;
  @group(1) @binding(1) var inSampler: sampler;
  @group(1) @binding(2) var bayerDitherTexture: texture_2d<f32>;
  @group(1) @binding(3) var bayerDitherSampler: sampler;

  @vertex
  fn ${Mc}(in: VertexInput) -> VertexOutput {
    var out: VertexOutput;

    var viewMatrix = camera.viewMatrix;
    viewMatrix[3] = vec4f(0, 0, 0, 1);
    let projViewMatrix = camera.projectionMatrix * viewMatrix;
    let position = in.position;
    out.position = (projViewMatrix * position).xyww;
    // hijack to compute uvs for frag shader
    out.viewNormal = 0.5 * (in.position.xyz + vec3(1.0, 1.0, 1.0));
    out.uv = in.uv;
    return out;
  }

  @fragment
  fn ${Pc}(in: VertexOutput) -> @location(0) vec4f {
    var cubemapVec = in.viewNormal - vec3(0.5);
    var color = textureSampleLevel(inTexture, inSampler, cubemapVec, 4); //7.8);
    let o = textureSample(bayerDitherTexture, bayerDitherSampler, in.position.xy / 8.0).r / 32.0 - (1.0 / 128.0);
    color.r += o;
    color.g += o;
    color.b += o;
    return vec4f(color.rgb, 1.0);
  }
`;class Up extends Fs{constructor(e=1,t=1,r=1,n=1){super(),this.width=e,this.height=t,this.widthSegments=r,this.heightSegments=n;const i=.5*e,o=.5*t,c=r+1,d=n+1,g=Math.floor(r),b=Math.floor(n),l=e/r,x=t/n,m=[],_=[],w=[],f=[];for(let p=0;p<d;p++){const a=p*x-o;for(let u=0;u<c;u++){const h=u*l-i;_.push(D.create(h,-a,0)),w.push(D.create(0,0,1)),f.push(Ce.create(u/g,1-p/b))}}for(let p=0;p<b;p++)for(let a=0;a<g;a++){const u=a+c*p,h=a+c*(p+1),y=a+1+c*(p+1),B=a+1+c*p;m.push(u,h,B);const C=new pr(u,h,B,_[u],_[h],_[B],w[u],w[h],w[B],f[u],f[h],f[B]);this.faces.push(C),m.push(h,y,B);const G=new pr(h,y,B,_[h],_[y],_[B],w[h],w[y],w[B],f[h],f[y],f[B]);this.faces.push(G)}this.createBuffersWithTangentsManually(m.length,_,w,f,new Uint16Array(m))}}class Rc extends Fs{constructor(e=1,t=32,r=16,n=0,i=2*Math.PI,o=0,c=Math.PI){super(),this.radius=e,this.widthSegments=t,this.heightSegments=r,this.phiStart=n,this.phiLength=i,this.thetaStart=o,this.thetaLength=c,t=Math.max(3,Math.floor(t)),r=Math.max(2,Math.floor(r));const d=Math.min(o+c,Math.PI);let g=0;const b=[],l=D.create(),x=D.create(),m=Ce.create(),_=[],w=[],f=[],p=[];for(let a=0;a<=r;a++){const u=[],h=a/r;let y=0;a===0&&o===0?y=.5/t:a===r&&d===Math.PI&&(y=-.5/t);for(let B=0;B<=t;B++){const C=B/t;l[0]=-e*Math.cos(n+C*i)*Math.sin(o+h*c),l[1]=e*Math.cos(o+h*c),l[2]=e*Math.sin(n+C*i)*Math.sin(o+h*c),_.push(D.clone(l)),D.copy(l,x),D.normalize(x,x),w.push(D.clone(x)),m[0]=C+y,m[1]=1-h,f.push(Ce.clone(m)),u.push(g++)}b.push(u)}for(let a=0;a<r;a++)for(let u=0;u<t;u++){const h=b[a][u+1],y=b[a][u],B=b[a+1][u],C=b[a+1][u+1];if(a!==0||o>0){p.push(h,y,C);const K=_[h],X=_[y],z=_[C],J=w[h],Q=w[y],Z=w[C],te=f[h],re=f[y],he=f[C],fe=new pr(h,y,C,K,X,z,J,Q,Z,te,re,he);this.faces.push(fe)}(a!==r-1||d<Math.PI)&&p.push(y,B,C);const G=_[y],U=_[B],k=_[C],T=w[y],S=w[B],P=w[C],L=f[y],F=f[B],O=f[C],H=new pr(y,B,C,G,U,k,T,S,P,L,F,O);this.faces.push(H)}this.createBuffersWithTangentsManually(p.length,_,w,f,new Uint16Array(p))}}let Ji,zi,Ki,Xi;const st=Object.freeze({get defaultPlaneGeometry(){return Ji||(Ji=new Up,Ji)},get unitCubeGeometry(){return zi||(zi=new ac,zi)},get unitSphereGeometry(){return Ki||(Ki=new Rc,Ki)},get pointLightSphereGeometry(){return Xi||(Xi=new Rc(1,9,9),Xi)}});class kp extends _e{set texture(e){this.setTexture(e)}setTexture(e){if(e.depthOrArrayLayers!==6)return;this._texture=e;const t=[{binding:0,resource:e.createView({dimension:"cube"})},{binding:1,resource:He.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear"})},{binding:2,resource:Be.bayerDitherPatternTexture.createView()},{binding:3,resource:He.createSampler({addressModeU:"repeat",addressModeV:"repeat",minFilter:"linear"})}];this.texSamplerBindGroup=v.device.createBindGroup({label:"Skybox Sampler + Texture Bind Group",layout:this.texSamplerBindGroupLayout,entries:t})}constructor(){super(st.unitCubeGeometry),this.label="Skybox";const e=[{binding:0,texture:{viewDimension:"cube",sampleType:"float"},visibility:GPUShaderStage.FRAGMENT},{binding:1,sampler:{type:"filtering"},visibility:GPUShaderStage.FRAGMENT},{binding:2,texture:{sampleType:"float"},visibility:GPUShaderStage.FRAGMENT},{binding:3,sampler:{},visibility:GPUShaderStage.FRAGMENT}];this.texSamplerBindGroupLayout=v.device.createBindGroupLayout({label:"Skybox Sampler + Texture Bind Group Layout",entries:e});const t=new ht({debugLabel:"Skybox Material",vertexShaderSrc:Gc,vertexShaderEntryFn:Mc,fragmentShaderSrc:Gc,fragmentShaderEntryFn:Pc,targets:[{format:"rgba16float"}],bindGroupLayouts:[j.defaultCameraBindGroupLayout,this.texSamplerBindGroupLayout],depthStencilState:{format:v.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal"},primitive:{cullMode:"front"}});this.setMaterial(t,V.Skybox)}preRender(e){super.preRender(e),this._texture&&e.setBindGroup(1,this.texSamplerBindGroup)}render(e){this._texture&&super.render(e)}}class we{constructor(e,t,r){if(this.type=e,this.width=t,this.height=r,this.enabled=!0,this.inputTextureNames=[],this.outputTextureNames=[],this.outTextures=[],this.inputTextureViews=[],this.resultBuffers=[],this.state="free",this.gpuTimingAverage=new hs,this.name=Sr.get(e),v.supportsGPUTimestampQuery){const n=Sr.get(e);this.querySet=v.device.createQuerySet({label:`Timestamp Query for Render Pass: ${n}`,type:"timestamp",count:2}),this.resolveBuffer=v.device.createBuffer({label:`Timestamp Query Resolve GPUBuffer for Render Pass: ${n}`,size:16,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),W.addBufferBytes(this.resolveBuffer)}}destroy(){var e;for(const t of this.outTextures)W.removeTextureBytes(t),t.destroy();this.inputTextureViews.length=0,(e=this.querySet)==null||e.destroy(),this.resolveBuffer&&(W.removeBufferBytes(this.resolveBuffer),this.resolveBuffer.destroy()),this.inputTextureNames.length=0,this.inputTextureViews.length=0;for(const t of this.resultBuffers)W.removeBufferBytes(t),t.destroy()}resetInputs(){return this.inputTextureNames.length=0,this.inputTextureViews.length=0,this}clearInputTextures(){return this.inputTextureNames.length=0,this.inputTextureViews.length=0,this}clearOutputTextures(){return this.outputTextureNames.length=0,this}addInputTexture(e){return this.inputTextureNames.push(e),this}addInputTextures(e){return this.inputTextureNames.push(...e),this}addOutputTexture(e){return this.outputTextureNames.push(e),this}addOutputTextures(e){return this.outputTextureNames.push(...e),this}createRenderPassDescriptor(){throw new Error("Needs implementation")}createComputePassDescriptor(){throw new Error("Needs implementation")}augmentRenderPassDescriptorWithTimestampQuery(e){return v.supportsGPUTimestampQuery&&(e.timestampWrites={querySet:this.querySet,beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}),e}resolveTiming(e){if(!v.supportsGPUTimestampQuery)return;this.state="wait for result";const t=this.resultBuffers.pop();t?this.resultBuffer=t:(this.resultBuffer=v.device.createBuffer({label:`Timestamp Query Result Buffer for render pass: ${this.name}`,size:this.resolveBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),W.addBufferBytes(this.resultBuffer)),e.resolveQuerySet(this.querySet,0,this.querySet.count,this.resolveBuffer,0),e.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,this.resultBuffer.size)}async getStartAndEndTimings(){if(!v.supportsGPUTimestampQuery)return[0,0];const e=this.resultBuffer;this.state="free",await e.mapAsync(GPUMapMode.READ);const t=new BigInt64Array(e.getMappedRange()),r=[Number(t[0]),Number(t[1])];return e.unmap(),this.resultBuffers.push(e),r}async getTimingResult(){if(!v.supportsGPUTimestampQuery)return{avgValue:0,timings:[0,0]};const e=await this.getStartAndEndTimings(),t=(e[1]-e[0])/1e6;return this.gpuTimingAverage.addSample(t),{timings:e,avgValue:this.gpuTimingAverage.get()}}setDebugCamera(e){this.debugCamera=e}toggleDebugCamera(e){this.cameraBindGroup=v.device.createBindGroup({label:`Camera Bind Group for: ${Sr.get(this.type)}`,layout:j.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:e?this.debugCamera.gpuBuffer:this.camera.gpuBuffer}}]})}setCamera(e){return this.camera=e,this.cameraBindGroup=v.device.createBindGroup({label:`Camera Bind Group for: ${Sr.get(this.type)}`,layout:j.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:e.gpuBuffer}}]}),this}postRender(e){this.resolveTiming(e)}onFrameEnd(){}render(e,t,r){throw new Error("Needs implementation")}}const Lc="blit",Np=`
  @group(0) @binding(0) var bloomTexture: texture_2d<f32>;
  @group(0) @binding(1) var sceneTexture: texture_2d<f32>;
  @group(0) @binding(2) var<uniform> bloomMixFactor: f32;
  @group(0) @binding(3) var<uniform> time: f32;
  @group(0) @binding(4) var<uniform> revealFactor: f32;

  @must_use
  fn ACESFilm(x: vec3f) -> vec3f {
    let v = x;
    let a = 2.51f;
    let b = 0.03f;
    let c = 2.43f;
    let d = 0.59f;
    let e = 0.14f;
    return saturate((v * (a * x + b)) / (x * (c * x + d) + e));
  }

  fn rand (co: vec2f) -> f32 {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
  }
  
  fn transition(p: vec2f, progress: f32, fromColor: vec3f, toColor: vec3f) -> vec3f {
    let size = vec2(10.0);
    let smoothness = 0.5;
    let r = rand(floor(size * p));
    let m = smoothstep(0.0, -smoothness, r - (progress * (1.0 + smoothness)));
    return mix(fromColor, toColor, m);
  }

  @fragment
  fn ${Lc}(@builtin(position) coord : vec4f) -> @location(0) vec4f {
    var bloomColor = textureLoad(bloomTexture, vec2i(floor(coord.xy)), 0).xyz;
    var color = textureLoad(sceneTexture, vec2i(floor(coord.xy)), 0).xyz;

    let texSize = vec2f(textureDimensions(sceneTexture));
    // bloomColor = select(color, bloomColor, bloomColor.r > 0.);

    color = mix(color, bloomColor, bloomMixFactor);
    // color = mix(color, bloomColor, 1);

    color = ACESFilm(color.rgb);
    color = pow(color, vec3f(1.0 / 2.2));

    let uv = coord.xy / texSize;
    let aspect = texSize.x / texSize.y;
    let timeFactor = 1.0;
    let noise = vec3f(rand(vec2f(uv.x + time * timeFactor, uv.y * aspect + time * timeFactor))) * 0.1;
    color = transition(uv, revealFactor, noise, color);
    return vec4f(vec3(color), 1.0);
  }
`,Xr=class Xr extends we{destroy(){W.removeBufferBytes(this.bloomMixFactorBuffer),W.removeBufferBytes(this.timeBuffer),W.removeBufferBytes(this.revealFactorBuffer),this.bloomMixFactorBuffer.destroy(),this.timeBuffer.destroy(),this.revealFactorBuffer.destroy()}set bloomEnabled(e){v.device.queue.writeBuffer(this.bloomMixFactorBuffer,0,new Float32Array([e?Xr.BLOOM_MIX_FACTOR:0]))}revealWithAnimation(e=500,t="quad_Out"){new ss({durationMS:e,easeName:t,onUpdate:r=>{this.updateRevealFactor(r)}}).start()}updateRevealFactor(e){v.device.queue.writeBuffer(this.revealFactorBuffer,0,new Float32Array([e]))}constructor(e,t,r=!1){super(V.Blit,e,t);const n=j.createShaderModule(Jt),i=j.createShaderModule(Np),o=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{}}];this.texturesBindGroupLayout=v.device.createBindGroupLayout({label:"GBuffer Textures Bind Group",entries:o});const c={layout:v.device.createPipelineLayout({bindGroupLayouts:[this.texturesBindGroupLayout]}),vertex:{module:n,entryPoint:_t},fragment:{module:i,entryPoint:Lc,targets:[{format:"bgra8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back"}};this.renderPSO=j.createRenderPipeline(c),this.bloomMixFactorBuffer=v.device.createBuffer({label:"Bloom Mix Factor GPU Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),W.addBufferBytes(this.bloomMixFactorBuffer),new Float32Array(this.bloomMixFactorBuffer.getMappedRange()).set([Xr.BLOOM_MIX_FACTOR]),this.bloomMixFactorBuffer.unmap(),this.timeBuffer=v.device.createBuffer({label:"Bloom Elapsed Time Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),W.addBufferBytes(this.timeBuffer),this.revealFactorBuffer=v.device.createBuffer({label:"Blit Loading Reveal Factor Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),W.addBufferBytes(this.revealFactorBuffer),new Float32Array(this.revealFactorBuffer.getMappedRange()).set([r?1:0]),this.revealFactorBuffer.unmap()}createRenderPassDescriptor(){return this.renderPassDescriptor?this.renderPassDescriptor:(this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:[{view:null,loadOp:"load",storeOp:"store"}],label:"Blit Pass"}),this.renderPassDescriptor)}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView());const o=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:{buffer:this.bloomMixFactorBuffer}},{binding:3,resource:{buffer:this.timeBuffer}},{binding:4,resource:{buffer:this.revealFactorBuffer}}];this.textureBindGroup=v.device.createBindGroup({layout:this.texturesBindGroupLayout,entries:o})}v.device.queue.writeBuffer(this.timeBuffer,0,new Float32Array([v.elapsedTimeMs]));const n=this.createRenderPassDescriptor();n.colorAttachments[0].view=v.canvasContext.getCurrentTexture().createView();const i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.bindRenderPSO(this.renderPSO),i.setBindGroup(0,this.textureBindGroup),i.draw(6),i.end(),this.postRender(e),[]}};Xr.BLOOM_MIX_FACTOR=.035;let Wi=Xr;const Oc="main",Vp=`
  @group(0) @binding(0) var srcTexture: texture_2d<f32>;
  @group(0) @binding(1) var outTexture: texture_storage_2d<rgba16float, write>;
  @group(0) @binding(2) var srcSampler: sampler;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${Oc}(
    @builtin(global_invocation_id) tid : vec3u,
  ) {
    let outTexSize = textureDimensions(outTexture);

    if (any(tid.xy >= outTexSize)) {
      return;
    }

    let srcTexSize = vec2f(textureDimensions(srcTexture));
    
    let texelSize = vec2f(1.0) / srcTexSize;
    let x = texelSize.x;
    let y = texelSize.y;

    let texCoords = vec2f((f32(tid.x) + 0.5) / f32(outTexSize.x), (f32(tid.y) + 0.5) / f32(outTexSize.y));

    // Take 13 samples around current texel:
    // a - b - c
    // - j - k -
    // d - e - f
    // - l - m -
    // g - h - i
    // === ('e' is the current texel) ===
    let a = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y + 2 * y), 0).rgb;
    let b = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y + 2 * y), 0).rgb;
    let c = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y + 2 * y), 0).rgb;

    let d = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y), 0).rgb;
    let e = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y), 0).rgb;
    let f = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y), 0).rgb;

    let g = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - 2 * x, texCoords.y - 2 * y), 0).rgb;
    let h = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x,         texCoords.y - 2 * y), 0).rgb;
    let i = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + 2 * x, texCoords.y - 2 * y), 0).rgb;

    let j = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - x, texCoords.y + y), 0).rgb;
    let k = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + x, texCoords.y + y), 0).rgb;
    let l = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x - x, texCoords.y - y), 0).rgb;
    let m = textureSampleLevel(srcTexture, srcSampler, vec2(texCoords.x + x, texCoords.y - y), 0).rgb;

    // Apply weighted distribution:
    // 0.5 + 0.125 + 0.125 + 0.125 + 0.125 = 1
    // a,b,d,e * 0.125
    // b,c,e,f * 0.125
    // d,e,g,h * 0.125
    // e,f,h,i * 0.125
    // j,k,l,m * 0.5
    // This shows 5 square areas that are being sampled. But some of them overlap,
    // so to have an energy preserving downsample we need to make some adjustments.
    // The weights are the distributed, so that the sum of j,k,l,m (e.g.)
    // contribute 0.5 to the final color output. The code below is written
    // to effectively yield this sum. We get:
    // 0.125*5 + 0.03125*4 + 0.0625*4 = 1
    var downsample = e * 0.125;
    downsample += (a + c + g + i) * 0.03125;
    downsample += (b + d + f + h) * 0.0625;
    downsample += (j + k + l + m) * 0.125;
    
    textureStore(outTexture, tid.xy, vec4f(downsample, 1.0));
    // textureStore(outTexture, tid.xy, vec4f(texCoords, 0.0, 1.0));
  }
`,Tt=class Tt extends we{constructor(e,t){super(V.BloomDownsample,e,t),this.mipLevelCount=Pt(e,t),this.outTextures.push(v.device.createTexture({label:"Bloom Downscale Texture",size:{width:e,height:t},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST,format:"rgba16float",mipLevelCount:this.mipLevelCount})),W.addTextureBytes(this.outTextures[0]),this.sampler=He.createSampler({label:"Bloom Downscale Sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"});const r=[{binding:0,texture:{},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{format:"rgba16float"},visibility:GPUShaderStage.COMPUTE},{binding:2,sampler:{},visibility:GPUShaderStage.COMPUTE}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Bloom Downscale Bind Group Layout",entries:r}),this.computePSO=j.createComputePipeline({label:"Bloom Downscale Render PSO",layout:v.device.createPipelineLayout({label:"Bloom Downscale Render PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:Oc,module:j.createShaderModule(Vp),constants:{WORKGROUP_SIZE_X:Tt.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:Tt.COMPUTE_WORKGROUP_SIZE_Y}}})}render(e,t,r){e.copyTextureToTexture({texture:r[0],mipLevel:0},{texture:this.outTextures[0],mipLevel:0},{width:this.width,height:this.height});const n=[{binding:0,resource:null},{binding:1,resource:null},{binding:2,resource:this.sampler}],i=e.beginComputePass({label:"Bloom Downscale Compute Pass"});i.setPipeline(this.computePSO);for(let o=1;o<this.mipLevelCount;o++){n[0].resource=this.outTextures[0].createView({baseMipLevel:o-1,mipLevelCount:1}),n[1].resource=this.outTextures[0].createView({baseMipLevel:o,mipLevelCount:1});const c=v.device.createBindGroup({label:`Bloom Downscale Bind Group for Mip ${o}`,entries:n,layout:this.bindGroupLayout});i.setBindGroup(0,c);const d=this.outTextures[0].width/Math.pow(2,o),g=this.outTextures[0].height/Math.pow(2,o),b=Math.ceil(d/Tt.COMPUTE_WORKGROUP_SIZE_X),l=Math.ceil(g/Tt.COMPUTE_WORKGROUP_SIZE_Y);i.dispatchWorkgroups(b,l,1)}return i.end(),this.postRender(e),this.outTextures}};Tt.COMPUTE_WORKGROUP_SIZE_X=8,Tt.COMPUTE_WORKGROUP_SIZE_Y=8;let Yi=Tt;const Ic="main",Hp=`
  ${Y.VertexOutput}

  @group(0) @binding(0) var srcTexture: texture_2d<f32>;
  @group(0) @binding(1) var srcSampler: sampler;
  @group(0) @binding(2) var<uniform> filterRadius: f32;

  @fragment
  fn ${Ic}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let srcSize = vec2f(textureDimensions(srcTexture));
    let aspect = srcSize.x / srcSize.y;

    let x = filterRadius;
    let y = filterRadius * aspect;

    let texCoord = vec2f(in.uv.x, 1 - in.uv.y);

    let a = textureSample(srcTexture, srcSampler, vec2f(texCoord.x - x, texCoord.y + y)).rgb;
    let b = textureSample(srcTexture, srcSampler, vec2f(texCoord.x,     texCoord.y + y)).rgb;
    let c = textureSample(srcTexture, srcSampler, vec2f(texCoord.x + x, texCoord.y + y)).rgb;

    let d = textureSample(srcTexture, srcSampler, vec2f(texCoord.x - x, texCoord.y)).rgb;
    let e = textureSample(srcTexture, srcSampler, vec2f(texCoord.x,     texCoord.y)).rgb;
    let f = textureSample(srcTexture, srcSampler, vec2f(texCoord.x + x, texCoord.y)).rgb;

    let g = textureSample(srcTexture, srcSampler, vec2(texCoord.x - x, texCoord.y - y)).rgb;
    let h = textureSample(srcTexture, srcSampler, vec2(texCoord.x,     texCoord.y - y)).rgb;
    let i = textureSample(srcTexture, srcSampler, vec2(texCoord.x + x, texCoord.y - y)).rgb;

    var upsample = e * 4.0;
    upsample += (b + d + f + h) * 2.0;
    upsample += (a + c + g + i);
    upsample *= 1.0 / 16.0;

    return vec4f(upsample, 1.0);
  }
`;class jp extends we{destroy(){W.removeBufferBytes(this.filterRadiusBuffer),this.filterRadiusBuffer.destroy()}set bloomFilterRadius(e){v.device.queue.writeBuffer(this.filterRadiusBuffer,0,new Float32Array([e]))}constructor(e,t){super(V.BloomUpsample,e,t),this.sampler=He.createSampler({label:"Bloom Downscale Sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"linear",magFilter:"linear"}),this.filterRadiusBuffer=v.device.createBuffer({label:"Bloom Upscale Filter Radius GPU Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),W.addBufferBytes(this.filterRadiusBuffer),new Float32Array(this.filterRadiusBuffer.getMappedRange()).set([.0035]),this.filterRadiusBuffer.unmap();const r=[{binding:0,texture:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Bloom Upscale Bind Group Layout",entries:r}),this.renderPSO=j.createRenderPipeline({label:"Bloom Upscale Render PSO",layout:v.device.createPipelineLayout({label:"Bloom Upscale Render PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),vertex:{entryPoint:_t,module:j.createShaderModule(Jt)},fragment:{entryPoint:Ic,module:j.createShaderModule(Hp),targets:[{format:"rgba16float",blend:{color:{operation:"add",srcFactor:"one",dstFactor:"one"},alpha:{operation:"add",srcFactor:"one",dstFactor:"one"}}}]}})}render(e,t,r){const n=[{binding:0,resource:null},{binding:1,resource:this.sampler},{binding:2,resource:{buffer:this.filterRadiusBuffer}}],i={colorAttachments:[{loadOp:"load",storeOp:"store",view:null}]};for(let o=Math.ceil(.5*Pt(r[0].width,r[0].height))-1;o>0;o--){i.label=`Bloom Upscale Mip Level ${o}`,i.colorAttachments[0].view=r[0].createView({baseMipLevel:o-1,mipLevelCount:1});const c=e.beginRenderPass(i);c.setPipeline(this.renderPSO),n[0].resource=r[0].createView({baseMipLevel:o,mipLevelCount:1});const d=v.device.createBindGroup({label:`Bloom Upscale Bind Group for Mip ${o}`,entries:n,layout:this.bindGroupLayout});c.setBindGroup(0,d),c.draw(3),c.end()}return this.postRender(e),r}}const Fc=s=>Bt`
  @must_use
  fn DistributionGGX(viewSpaceNormal: vec3f, H: vec3f, roughness: f32) -> f32 {
    let a = roughness*roughness;
    let a2 = a*a;
    let NdotH = max(dot(viewSpaceNormal, H), 0.0);
    let NdotH2 = NdotH*NdotH;

    let nom   = a2;
    var denom = (NdotH2 * (a2 - 1.0) + 1.0);
    denom = PI * denom * denom + 0.0001;

    return nom / denom;
}

  @must_use
  fn GeometrySchlickGGX(NdotV: f32, roughness: f32) -> f32 {
    let r = (roughness + 1.0);
    let k = (r * r) / 8;

    let nom   = NdotV;
    let denom = NdotV * (1.0 - k) + k + 0.0001;
    return nom / denom;
  }

  @must_use
  fn GeometrySmith(viewSpaceNormal: vec3f, V: vec3f, L: vec3f, roughness: f32) -> f32 {
    let NdotV = max(dot(viewSpaceNormal, V), 0.0);
    let NdotL = max(dot(viewSpaceNormal, L), 0.0);
    let ggx2 = GeometrySchlickGGX(NdotV, roughness);
    let ggx1 = GeometrySchlickGGX(NdotL, roughness);
    return ggx1 * ggx2;
  }

  @must_use
  fn FresnelSchlick(cosTheta: f32, F0: vec3f) -> vec3f {
    return F0 + (1.0 - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);
  }

  @must_use
  fn FresnelSchlickRoughness(cosTheta: f32, F0: vec3f, roughness: f32) -> vec3f {
    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(clamp(1.0 - cosTheta, 0.0, 1.0), 5.0);
  }

  @must_use
  fn PBRLighting(
    material: Material,
    instanceId: u32,
    viewSpacePos: vec3f,
    viewSpaceNormal: vec3f,
    V: vec3f,
    shadow: f32,
    opacity: f32,
    #if ${s===V.PointLightsNonCulledLighting}
      lightPosition: vec3f,
      lightRadius: f32,
      lightColor: vec3f,
      lightIntensity: f32,
    #elif ${s===V.DirectionalAmbientLighting}
      diffuseIBLTexture: texture_cube<f32>,
      specularIBLTexture: texture_cube<f32>,
      bdrfLutTexture: texture_2d<f32>,
      envTexSampler: sampler,
    #endif
  ) -> vec4f {
    let albedo = material.albedo;
    let F0 = mix(vec3f(0.04), albedo, material.metallic);
    
    var Lo = vec3f(0.0);
    let albedoOverPi = albedo / PI;

    let roughness = material.roughness;
    let roughnessSq = roughness * roughness;
    let roughnessQuad = roughnessSq * roughnessSq;

    let metallic = material.metallic;

    #if ${s===V.DirectionalAmbientLighting}
    let light = &lightsBuffer[instanceId];
    // let isPointLight = light.lightType == ${It.Point};
    let lightViewSpacePos = (camera.viewMatrix * vec4f(light.position, 0.0)).xyz;
    
    let lightColor = light.color;
    let lightIntensity = light.intensity;
    let L = normalize(lightViewSpacePos);
    let attenuation = 1.0;

    // return vec4f(vec3f(shadow), 1.0)

    #elif ${s===V.PointLightsLighting}
    let light = &lightsBuffer[instanceId];
    let lightColor = light.color;
    let lightIntensity = light.intensity;
    let lightViewSpacePos = (camera.viewMatrix * vec4f(light.position, 1.0)).xyz;
    let dist = lightViewSpacePos.xyz - viewSpacePos.xyz;
    let d = length(dist);
    var attenuation = 1 - smoothstep(0.0, light.radius, d);
    attenuation *= attenuation;
    let L = normalize(dist);
    #elif ${s===V.PointLightsNonCulledLighting}
    let lightViewSpacePos = (camera.viewMatrix * vec4f(lightPosition, 1)).xyz;
    let dist = lightViewSpacePos.xyz - viewSpacePos.xyz;
    let d = length(dist);
    var attenuation = 1 - smoothstep(0.0, lightRadius, d);
    attenuation *= attenuation;
    let L = normalize(dist);
    #endif

    
    let H = normalize(V + L);
    
    let radiance = lightColor * attenuation * lightIntensity;

    let NDF = DistributionGGX(viewSpaceNormal, H, roughnessQuad);
    let G = GeometrySmith(viewSpaceNormal, V, L, roughness);
    var F = FresnelSchlick(max(dot(H, V), 0.0), F0);

    let numerator = NDF * G * F;
    // let denominator = 4.0 * (NdotV * NdotL, 0.0001); // + 0.0001 to prevent divide by zero
    let denominator = 4.0 * max(dot(viewSpaceNormal, V), 0.0) * max(dot(viewSpaceNormal, L), 0.0) + 0.0001; // + 0.0001 to prevent divide by zero

    var specular = numerator / denominator;

      // kS is equal to Fresnel
    var kS = F;
    // for energy conservation, the diffuse and specular light can't
    // be above 1.0 (unless the surface emits light); to preserve this
    // relationship the diffuse component (kD) should equal 1.0 - kS.
    var kD = vec3f(1.0 - kS);
    // multiply kD by the inverse metalness such that only non-metals
    // have diffuse lighting, or a linear blend if partly metal (pure metals
    // have no diffuse light).
    kD *= 1.0 - metallic;

    let NdotL = max(dot(viewSpaceNormal, L), 0.0); 

    // add to outgoing radiance Lo
    Lo += (kD * albedoOverPi + specular) * radiance * NdotL * shadow; // * light.opacity;  // note that we already multiplied the BRDF by the Fresnel
  
    #if ${s===V.DirectionalAmbientLighting}
      let worldSpaceNorm = (camera.inverseViewMatrix * vec4f(viewSpaceNormal, 0)).xyz;
      let worldSpaceV = (camera.inverseViewMatrix * vec4f(V, 0)).xyz;
      let irradiance = textureSampleLevel(diffuseIBLTexture, envTexSampler, worldSpaceNorm, 0).rgb;
      kS = FresnelSchlickRoughness(max(dot(viewSpaceNormal, V), 0.0), F0, roughness); 
      kD = 1.0 - kS;
      kD *= 1.0 - metallic;
      // let ambientIBL = kD * irradiance;
      // let ambientFactor = 0.2;

      let R = reflect(-worldSpaceV, worldSpaceNorm);
      let MAX_REFLECTION_LOD = 8.0;
      let prefilteredColor = vec3f(
        textureSampleLevel(
          specularIBLTexture,
          envTexSampler,
          R,
          material.roughness * MAX_REFLECTION_LOD
        ).rgb
      );

      let uv = vec2f(max(dot(worldSpaceNorm, worldSpaceV), 0.0), roughness);
      let envBDRF = textureSample(bdrfLutTexture, envTexSampler, uv).rg;
      specular = prefilteredColor * (F * envBDRF.x + envBDRF.y);
      // specular = mix(specular, specular * 0.2, 1 - shadow);

      let diffuse = irradiance * albedo;
      let ambient = (kD * diffuse + specular * metallic) * material.ambientOcclusion;

      // let ambient = vec3f(0.03) * albedo * material.ambientOcclusion;
      
      var color = ambient + Lo;
    #else
      var color = Lo;
    #endif

    return vec4f(color, opacity);
  }
`,Pe=class Pe extends we{constructor(e,t,r){super(V.Shadow,t,r),this.sceneDirectionalLight=e,this.type=V.Shadow,this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:[],depthStencilAttachment:{view:null,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"},label:"Shadow Render Pass Cascade #0"}),this.outTextures.push(v.device.createTexture({label:"Directional Shadow Depth Texture",format:"depth32float",size:{width:Pe.TEXTURE_SIZE,height:Pe.TEXTURE_SIZE,depthOrArrayLayers:Pe.TEXTURE_CASCADES_COUNT},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING})),W.addTextureBytes(this.outTextures[0]),this.shadowTextureCascade0=this.outTextures[0].createView({baseArrayLayer:0,arrayLayerCount:1,dimension:"2d"}),this.shadowTextureCascade1=this.outTextures[0].createView({baseArrayLayer:1,arrayLayerCount:1,dimension:"2d"});const n=Ot(Y.Camera);this.shadowCameraCascade0BufferUniformValues=yt(n.structs.Camera),this.shadowCameraCascade1BufferUniformValues=yt(n.structs.Camera),this.shadowCameraCascade0GPUBuffer=v.device.createBuffer({label:"Shadow Camera GPU Buffer Cascade #0",size:this.shadowCameraCascade0BufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),W.addBufferBytes(this.shadowCameraCascade0GPUBuffer),this.shadowCameraCascade1GPUBuffer=v.device.createBuffer({label:"Shadow Camera GPU Buffer Cascade #1",size:this.shadowCameraCascade1BufferUniformValues.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),W.addBufferBytes(this.shadowCameraCascade1GPUBuffer),this.shadowCameraCascade0BindGroup=v.device.createBindGroup({label:"Shadow Camera Bind Group Cascade #0",layout:j.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:this.shadowCameraCascade0GPUBuffer}}]}),this.shadowCameraCascade1BindGroup=v.device.createBindGroup({label:"Shadow Camera Bind Group Cascade #1",layout:j.defaultCameraBindGroupLayout,entries:[{binding:0,resource:{buffer:this.shadowCameraCascade1GPUBuffer}}]});const i=Ot(Y.ShadowCascade);this.shadowCascadeView=yt(i.structs.ShadowCascade),this.shadowCascadesBuffer=v.device.createBuffer({label:"Directional Shadow Cascade ProjView Matrices",size:Pe.TEXTURE_CASCADES_COUNT*this.shadowCascadeView.arrayBuffer.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),W.addBufferBytes(this.shadowCascadesBuffer)}set shadowMapSize(e){const t=this.outTextures[0];this.outTextures[0]=v.device.createTexture({label:"Directional Shadow Depth Texture",format:"depth32float",size:{width:e,height:e,depthOrArrayLayers:Pe.TEXTURE_CASCADES_COUNT},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),this.shadowTextureCascade0=this.outTextures[0].createView({baseArrayLayer:0,arrayLayerCount:1,dimension:"2d"}),this.shadowTextureCascade1=this.outTextures[0].createView({baseArrayLayer:1,arrayLayerCount:1,dimension:"2d"}),W.addTextureBytes(this.outTextures[0]),v.device.queue.onSubmittedWorkDone().then(()=>{W.removeTextureBytes(t),t.destroy()})}destroy(){super.destroy(),W.removeBufferBytes(this.shadowCascadesBuffer),W.removeBufferBytes(this.shadowCameraCascade0GPUBuffer),W.removeBufferBytes(this.shadowCameraCascade1GPUBuffer),this.shadowCascadesBuffer.destroy(),this.shadowCameraCascade0GPUBuffer.destroy(),this.shadowCameraCascade1GPUBuffer.destroy()}setCamera(e){return this.camera=e,this}getLightSpaceMatrix(){const e=this.camera.frustumCornersWorldSpace,t=D.create(0,0,0);for(let f=0;f<e.length;f++){const p=e[f];D.add(t,p,t)}D.divScalar(t,e.length,t);const r=D.create(),n=D.create();D.normalize(this.sceneDirectionalLight.position,n),D.add(t,n,r);const i=$.create();$.lookAt(r,t,ds.UP_VECTOR,i);let o=Number.MAX_VALUE,c=-o,d=Number.MAX_VALUE,g=-d,b=Number.MAX_VALUE,l=-b;for(let f=0;f<e.length;f++){const p=e[f],a=wr.create();D.transformMat4(p,i,a),o=Math.min(o,a[0]),c=Math.max(c,a[0]),d=Math.min(d,a[1]),g=Math.max(g,a[1]),b=Math.min(b,a[2]),l=Math.max(l,a[2])}const x=-b;b=-l,l=x;const m=(l-b)/2;b-=5*m,l+=5*m;const _=$.create();$.ortho(o,c,d,g,b,l,_);const w=$.create();return $.mul(_,i,w),w}render(e,t,r){const n=this.camera.near,i=this.camera.far;this.camera.near=.1,this.camera.far=Pe.TEXTURE_CASCADE_FAR_DISTANCES[0],this.camera.updateProjectionMatrix();const o=this.getLightSpaceMatrix();this.shadowCascadeView.set({projViewMatrix:o,distance:this.camera.far}),v.device.queue.writeBuffer(this.shadowCascadesBuffer,0,this.shadowCascadeView.arrayBuffer),this.shadowCameraCascade0BufferUniformValues.set({projectionViewMatrix:o}),v.device.queue.writeBuffer(this.shadowCameraCascade0GPUBuffer,0,this.shadowCameraCascade0BufferUniformValues.arrayBuffer),this.renderPassDescriptor.depthStencilAttachment.view=this.shadowTextureCascade0,this.renderPassDescriptor.label="Shadow Render Pass Cascade #0";const c=e.beginRenderPass(this.renderPassDescriptor);v.setActiveRenderPass(this.type,c),c.setBindGroup(ae.CameraPlusOptionalLights,this.shadowCameraCascade0BindGroup),v.ENABLE_DEBUG_GROUPS&&c.pushDebugGroup("Render Shadow Cascade #0"),t.renderOpaqueNodes(c),t.renderTransparentNodes(c),v.ENABLE_DEBUG_GROUPS&&c.popDebugGroup(),c.end(),this.camera.near=Pe.TEXTURE_CASCADE_FAR_DISTANCES[0],this.camera.far=Pe.TEXTURE_CASCADE_FAR_DISTANCES[1],this.camera.updateProjectionMatrix();const d=this.getLightSpaceMatrix();this.shadowCascadeView.set({projViewMatrix:d,distance:this.camera.far}),v.device.queue.writeBuffer(this.shadowCascadesBuffer,1*this.shadowCascadeView.arrayBuffer.byteLength,this.shadowCascadeView.arrayBuffer),this.shadowCameraCascade1BufferUniformValues.set({projectionViewMatrix:d}),v.device.queue.writeBuffer(this.shadowCameraCascade1GPUBuffer,0,this.shadowCameraCascade1BufferUniformValues.arrayBuffer),this.renderPassDescriptor.depthStencilAttachment.view=this.shadowTextureCascade1,this.renderPassDescriptor.label="Shadow Render Pass Cascade #1";const g=e.beginRenderPass(this.renderPassDescriptor);return v.setActiveRenderPass(this.type,g),v.ENABLE_DEBUG_GROUPS&&g.pushDebugGroup("Render Shadow Cascade #1"),g.setBindGroup(ae.CameraPlusOptionalLights,this.shadowCameraCascade1BindGroup),t.renderOpaqueNodes(g),t.renderTransparentNodes(g),v.ENABLE_DEBUG_GROUPS&&g.popDebugGroup(),g.end(),this.camera.near=n,this.camera.far=i,this.camera.updateProjectionMatrix(),this.postRender(e),this.outTextures}};Pe.TEXTURE_SIZE=4098,Pe.TEXTURE_CASCADES_COUNT=2,Pe.TEXTURE_CASCADE_FAR_DISTANCES=[6,17,200];let Qs=Pe;const $s="integrateMain",qi=s=>{return Bt`
  ${Y.VertexOutput}
  ${Y.Light}
  ${Y.Camera}
  ${Y.Material}
  ${Y.ShadowCascade}
  ${Y.CommonHelpers}
  ${Y.MathHelpers}

  ${Fc(s)}
  ${`

  @must_use
  fn ShadowLayerIdxCalculate(
    worldPos: vec3f,
    camera: Camera,
    shadowCascades: array<ShadowCascade, 2>
  ) -> i32 {
  let fragPosViewSpace = camera.viewMatrix * vec4f(worldPos, 1.0);
  let depthValue = abs(fragPosViewSpace.z);

  var layer: i32 = -1;
  let cascadesCount: i32 = 2;
    for (var i: i32 = 0; i < cascadesCount; i++) {
      if (depthValue < shadowCascades[i].distance) {
        layer = i;
        break;
      }
    }

    if (layer == -1) {
      layer = 1;
    }
    return layer;
  }

  fn ShadowCalculate(
    worldPos: vec3f,
    N: vec3f,
    lightPosition: vec3f,
    camera: Camera,
    shadowTextureWidth: f32,
    shadowTextureHeight: f32,
    shadowCascades: array<ShadowCascade, 2>,
    shadowDepthTexture: texture_depth_2d_array,
    shadowDepthSampler: sampler_comparison
  ) -> f32 {

    let layer = ShadowLayerIdxCalculate(
      worldPos,
      camera,
      shadowCascades
    );
    let fragPosLightSpace = shadowCascades[layer].projViewMatrix * vec4f(worldPos, 1.0);

    // perform perspective divide
    var projCoords = fragPosLightSpace.xyz / fragPosLightSpace.w;
    projCoords.x = projCoords.x * 0.5 + 0.5;
    projCoords.y = projCoords.y * 0.5 + 0.5;
    projCoords.y = 1 -  projCoords.y;
    let uv = projCoords.xy;

    var shadow = 0.0;

    let texelSize = 1 / vec2f(shadowTextureWidth, shadowTextureHeight);

    for (var y = -2; y <= 2; y++) {
      for (var x = -2; x <= 2; x++) {
        let uv = projCoords.xy + vec2f(f32(x), f32(y)) * texelSize;
        let pcfDepth = textureSampleCompareLevel(
          shadowDepthTexture,
          shadowDepthSampler,
          uv,
          layer,
          projCoords.z
        );
        shadow += pcfDepth;
      }
    }

    shadow /= 16;

    return shadow;
  }
`}
  ${Vr}

  struct LightSettings {
    debugLights: f32,
    debugShadowCascadeLayer: f32
  };

  #if ${s===V.DirectionalAmbientLighting}
  const SHADOW_MAP_SIZE: f32 = ${Qs.TEXTURE_SIZE};
  #endif

  ${e=s,Bt`
  @group(0) @binding(0) var normalTexture: texture_2d<f32>;
  @group(0) @binding(1) var colorTexture: texture_2d<f32>;
  @group(0) @binding(2) var depthTexture: texture_depth_2d;
  @group(0) @binding(3) var aoTexture: texture_2d<f32>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  
  #if ${e===V.PointLightsLighting||e===V.PointLightsStencilMask||e===V.DirectionalAmbientLighting}
  @group(0) @binding(5) var<storage, read> lightsBuffer: array<Light>;
  @group(0) @binding(6) var<uniform> debugLightsInfo: LightSettings;
  #endif

  #if ${e===V.PointLightsNonCulledLighting}
  @group(1) @binding(0) var<uniform> cameraCulledPointLight: Light;
  #endif

  #if ${e===V.DirectionalAmbientLighting}
  @group(1) @binding(0) var<storage, read> shadowCascades: array<ShadowCascade, 2>;
  @group(1) @binding(1) var shadowMapSampler: sampler_comparison;
  @group(1) @binding(2) var shadowDepthTexture: texture_depth_2d_array;
  @group(1) @binding(3) var diffuseIBLTexture: texture_cube<f32>;
  @group(1) @binding(4) var specularIBLTexture: texture_cube<f32>;
  @group(1) @binding(5) var bdrfLutTexture: texture_2d<f32>;
  @group(1) @binding(6) var envTexSampler: sampler;
  @group(1) @binding(7) var<uniform> ssaoMixFactor: f32;
  #endif
`}

  @fragment
  fn ${$s}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    let encodedN = textureLoad(normalTexture, pixelCoords, 0).rg;
    let metallic = textureLoad(normalTexture, pixelCoords, 0).b;
    let roughness = textureLoad(normalTexture, pixelCoords, 0).a;
    let viewSpaceNormal = decodeNormal(encodedN);
    
    let albedo = textureLoad(colorTexture, pixelCoords, 0).xyz;
    let depth = textureLoad(depthTexture, pixelCoords, 0);
    
    let aoPixelCoords = vec2i(floor(coord.xy));
    let ao = textureLoad(aoTexture, aoPixelCoords, 0).r;
    // return vec4f(ao, ao, ao, 1);

    // return vec4f(viewSpaceNormal, 1.0);
    

    var material = Material();
    material.albedo = albedo;
    material.roughness = roughness;
    // return vec4f(vec3f(1 - metallic), 1);
    material.metallic = metallic;
    // material.ambientOcclusion = select(1.0, ao, pixelCoords.x > i32(textureDimensions(normalTexture).x / 2));

    #if ${s===V.DirectionalAmbientLighting}
    material.ambientOcclusion = mix(1.0, ao, ssaoMixFactor);
    #endif
    
    let viewSpacePos = calcViewSpacePos(camera, coord.xy, depth);
    
    let V = normalize(-viewSpacePos);

    #if ${s===V.DirectionalAmbientLighting}
    let worldSpacePos = calcWorldPos(camera, coord.xy, depth);
    let shadowLayerIdx = ShadowLayerIdxCalculate(worldSpacePos, camera, shadowCascades);
    let r = select(0.0, 1.0, shadowLayerIdx == 0);
    let g = select(0.0, 1.0, shadowLayerIdx == 1);
    let b = select(0.0, 1.0, shadowLayerIdx == 2);
    if (debugLightsInfo.debugShadowCascadeLayer == 1) {
      material.albedo = vec3f(r, g, b);
    }
    // TODO: Directional light is expected to be at index 0
    // Write a better mechanism for quering it
    let lightPosition = (camera.viewMatrix * (vec4f(lightsBuffer[0].position, 0))).xyz;
    // let shadow = 1.0;
    let shadow = ShadowCalculate(
      worldSpacePos,
      viewSpaceNormal,
      lightPosition,
      camera,
      SHADOW_MAP_SIZE,
      SHADOW_MAP_SIZE,
      shadowCascades,
      shadowDepthTexture,
      shadowMapSampler
    );
    #else
    let shadow = 1.0;
    #endif

    let opacity = 1.0;

    var color = PBRLighting(
      material,
      in.instanceId,
      viewSpacePos,
      viewSpaceNormal,
      V,
      shadow,
      opacity,
      #if ${s===V.PointLightsNonCulledLighting}
      cameraCulledPointLight.position,
      cameraCulledPointLight.radius,
      cameraCulledPointLight.color,
      cameraCulledPointLight.intensity,
      #elif ${s==V.DirectionalAmbientLighting}
      diffuseIBLTexture,
      specularIBLTexture,
      bdrfLutTexture,
      envTexSampler
      #endif
    );

    #if ${s===V.PointLightsLighting}
    let debugColor = vec4f(1.0, 0.0, 0.0, 1.0);
    return mix(color, debugColor, debugLightsInfo.debugLights);
    #else
    return color;
    #endif
  }
`;var e},mo=class mo extends we{constructor(e,t,r){super(e,t,r),this.gbufferCommonBindGroupLayoutEntries=[],this.gbufferTexturesBindGroupEntries=[],this._debugLightsMask=!1,this._debugShadowCascadeLayer=!1,this.gbufferCommonBindGroupLayoutEntries.push({binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:4,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}),e!==V.PointLightsLighting&&e!==V.DirectionalAmbientLighting&&e!==V.PointLightsStencilMask||(this.gbufferCommonBindGroupLayoutEntries.push({binding:5,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}),this.gbufferCommonBindGroupLayoutEntries.push({binding:6,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}})),this.gbufferCommonBindGroupLayout=v.device.createBindGroupLayout({label:"GBuffer Textures Bind Group",entries:this.gbufferCommonBindGroupLayoutEntries}),this.debugLightsBuffer=v.device.createBuffer({label:"Debug Lights GPUBuffer",size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),W.addBufferBytes(this.debugLightsBuffer),new Float32Array(this.debugLightsBuffer.getMappedRange()).set(new Float32Array([0,0])),this.debugLightsBuffer.unmap(),this.gbufferTexturesBindGroupEntries.push({binding:0,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:1,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:2,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:3,resource:null}),this.gbufferTexturesBindGroupEntries.push({binding:4,resource:{buffer:null}}),e!==V.DirectionalAmbientLighting&&e!==V.PointLightsLighting&&e!==V.PointLightsStencilMask||(this.gbufferTexturesBindGroupEntries.push({binding:5,resource:{buffer:null}}),this.gbufferTexturesBindGroupEntries.push({binding:6,resource:{buffer:this.debugLightsBuffer}}))}set debugLightsMask(e){this._debugLightsMask=e,this.updateLightSettingsBuffer()}set debugShadowCascadeLayer(e){this._debugShadowCascadeLayer=e,this.updateLightSettingsBuffer()}updateLightSettingsBuffer(){v.device.queue.writeBuffer(this.debugLightsBuffer,0,new Float32Array([this._debugLightsMask?1:0,this._debugShadowCascadeLayer?1:0]))}updateGbufferBindGroupEntryAt(e,t){return this.gbufferTexturesBindGroupEntries[e].resource=t,this}recreateGBufferTexturesBindGroup(){this.gbufferTexturesBindGroup=v.device.createBindGroup({label:"G-Buffer Textures Input Bind Group",layout:this.gbufferCommonBindGroupLayout,entries:this.gbufferTexturesBindGroupEntries})}};mo.RENDER_TARGETS=[{format:"rgba16float",blend:{color:{srcFactor:"one",dstFactor:"one",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one",operation:"add"}}}];let yr=mo;class Qi extends yr{constructor(e,t,r){super(V.DirectionalAmbientLighting,t,r),this.shadowCascadesBuffer=e,this.dirLightShadowBindGroupEntries=[],this.shadowSampler=He.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear",compare:"less"}),this.envSampler=He.createSampler({minFilter:"linear",magFilter:"linear",mipmapFilter:"linear"}),this.ssaoMixBuffer=v.device.createBuffer({label:"Ambient SSAO Mix Factor Buffer",usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,size:1*Float32Array.BYTES_PER_ELEMENT,mappedAtCreation:!0}),W.addBufferBytes(this.ssaoMixBuffer),new Float32Array(this.ssaoMixBuffer.getMappedRange()).set([1]),this.ssaoMixBuffer.unmap();const n=[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"comparison"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth",viewDimension:"2d-array"}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"cube"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"cube"}},{binding:5,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"2d"}},{binding:6,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:7,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}];this.dirLightShadowBindGroupLayout=v.device.createBindGroupLayout({label:"Direcional Light Shadow Bind Group Layout",entries:n});const i=v.device.createPipelineLayout({label:"Dir Light PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout,this.dirLightShadowBindGroupLayout]});this.dirLightShadowBindGroupEntries=[{binding:0,resource:{buffer:this.shadowCascadesBuffer}},{binding:1,resource:this.shadowSampler},{binding:2,resource:Be.dummyTexture.createView({})},{binding:3,resource:Be.dummyCubeTexture.createView({dimension:"cube"})},{binding:4,resource:Be.dummyCubeTexture.createView({dimension:"cube"})},{binding:5,resource:Be.dummyTexture.createView({})},{binding:6,resource:this.envSampler},{binding:7,resource:{buffer:this.ssaoMixBuffer}}];const o={label:"Directional Light Render PSO",layout:i,vertex:{module:j.createShaderModule(Jt,"Fullscreen Vertex Shader Module"),entryPoint:_t},fragment:{module:j.createShaderModule(qi(V.DirectionalAmbientLighting),"Directional Light Pass Shader Module"),entryPoint:$s,targets:Qi.RENDER_TARGETS},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1}};this.renderPSO=j.createRenderPipeline(o),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:t,height:r,depthOrArrayLayers:1},usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"GBuffer Result Texture"})),W.addTextureBytes(this.outTextures[0]),this.outTextureView=this.outTextures[0].createView()}set ssaoMixFactor(e){v.device.queue.writeBuffer(this.ssaoMixBuffer,0,new Float32Array([e]))}setDiffuseIBLTexture(e){return this.dirLightShadowBindGroupEntries[3].resource=e.createView({dimension:"cube"}),this.recreateDirLightShadowBindGroup(),this}setSpecularIBLTexture(e){return this.dirLightShadowBindGroupEntries[4].resource=e.createView({dimension:"cube"}),this.recreateDirLightShadowBindGroup(),this}setBDRFLutTexture(e){return this.dirLightShadowBindGroupEntries[5].resource=e.createView({dimension:"2d"}),this.recreateDirLightShadowBindGroup(),this}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextureView,loadOp:"clear",clearValue:[0,0,0,1],storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Directional + Ambient Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!1,view:this.inputTextureViews[3],stencilLoadOp:"load",stencilStoreOp:"store"}}),this.renderPassDescriptor}recreateDirLightShadowBindGroup(){this.dirLightShadowBindGroup=v.device.createBindGroup({label:"Directional Ambient LightingSystem G-Buffer Directional Shadow Input Bind Group",layout:this.dirLightShadowBindGroupLayout,entries:this.dirLightShadowBindGroupEntries})}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(r[2].createView({aspect:"all"})),this.inputTextureViews.push(r[3].createView()),this.inputTextureViews.push(r[4].createView({dimension:"2d-array"})),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[2]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).updateGbufferBindGroupEntryAt(5,{buffer:t.lightingManager.gpuBuffer}).recreateGBufferTexturesBindGroup(),this.dirLightShadowBindGroupEntries[2].resource=this.inputTextureViews[5],this.recreateDirLightShadowBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Directional + Ambient LightingSystem"),v.bindRenderPSO(this.renderPSO),n.setBindGroup(0,this.gbufferTexturesBindGroup),n.setBindGroup(1,this.dirLightShadowBindGroup),n.draw(3),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}}class Jp extends we{constructor(e,t){super(V.Deferred,e,t),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Normal + Metallic + Roughness + GBuffer Texture"})),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"bgra8unorm",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Color + Reflectance GBuffer Texture"})),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rg16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Velocity GBuffer Texture"})),this.outTextures.push(v.device.createTexture({dimension:"2d",format:v.depthStencilFormat,mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,label:"Depth + Stencil GBuffer Texture"}));for(const r of this.outTextures)W.addTextureBytes(r)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextures[ut.NormalMetallicRoughness].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"},{view:this.outTextures[ut.ColorReflectance].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"},{view:this.outTextures[ut.Velocity].createView(),loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({colorAttachments:e,depthStencilAttachment:{view:this.outTextures[3].createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1,stencilLoadOp:"clear",stencilStoreOp:"store",stencilClearValue:0},label:"GBuffer Render Pass"}),this.renderPassDescriptor}render(e,t,r){const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.ENABLE_DEBUG_GROUPS&&i.pushDebugGroup("Render G-Buffer"),i.setBindGroup(ae.CameraPlusOptionalLights,this.cameraBindGroup),i.setStencilReference(128),t.renderOpaqueNodes(i,this.camera),v.ENABLE_DEBUG_GROUPS&&i.popDebugGroup(),i.end(),this.postRender(e),this.outTextures}}const Dc="copyDepth",zp=`

  @group(0) @binding(0) var sourceDepth: texture_depth_2d;
  @group(0) @binding(1) var destDepth: texture_storage_2d<r32float, write>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${Dc}(
    @builtin(global_invocation_id) pos : vec3u
  ) {
    let texSize = textureDimensions(sourceDepth);
    
    if (any(pos.xy > texSize)) {
      return;
    }

    let src = textureLoad(sourceDepth, pos.xy, 0);
    textureStore(destDepth, pos.xy, vec4f(src));
  }

`,St=class St extends we{constructor(e,t){super(V.CopyDepthForHiZ,e,t);const r=[{binding:0,texture:{sampleType:"depth"},visibility:GPUShaderStage.COMPUTE},{binding:1,storageTexture:{access:"write-only",format:"r32float",viewDimension:"2d"},visibility:GPUShaderStage.COMPUTE}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Hi-Z Copy Depth Bind Group Layout",entries:r}),this.computePSO=j.createComputePipeline({label:"Hi-Z Copy Depth Compute PSO",layout:v.device.createPipelineLayout({label:"Hi-Z Copy Depth Compute PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:Dc,module:j.createShaderModule(zp,"Hi-Z Depth Copy Compute Shader Module"),constants:{WORKGROUP_SIZE_X:St.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:St.COMPUTE_WORKGROUP_SIZE_Y}}}),this.outTextures.push(v.device.createTexture({label:"Hi-Z Depth Texture",size:{width:e,height:t},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING,format:"r32float",mipLevelCount:Pt(e,t)})),W.addTextureBytes(this.outTextures[0])}createComputePassDescriptor(){return this.computePassDescriptor||(this.computePassDescriptor={label:"Copy Hi-Z Depth Compute Pass"}),this.computePassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView({aspect:"depth-only"}));const c=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.outTextures[0].createView({baseMipLevel:0,mipLevelCount:1})}];this.bindGroup=v.device.createBindGroup({label:"Hi-Z Depth Copy Bind Group",layout:this.bindGroupLayout,entries:c})}const n=e.beginComputePass(this.createComputePassDescriptor());n.setPipeline(this.computePSO),n.setBindGroup(0,this.bindGroup);const i=Math.ceil(this.outTextures[0].width/St.COMPUTE_WORKGROUP_SIZE_X),o=Math.ceil(this.outTextures[0].height/St.COMPUTE_WORKGROUP_SIZE_Y);return n.dispatchWorkgroups(i,o,1),n.end(),this.postRender(e),this.outTextures}};St.COMPUTE_WORKGROUP_SIZE_X=8,St.COMPUTE_WORKGROUP_SIZE_Y=8;let $i=St;const Uc="computeHiZMips",Kp=`
  @group(0) @binding(0) var prevMipLevel: texture_2d<f32>;
  @group(0) @binding(1) var nextMipLevel: texture_storage_2d<r32float, write>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;  

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${Uc}(@builtin(global_invocation_id) pos : vec3u) {
    let texSize = textureDimensions(prevMipLevel);
    if (any(pos.xy > texSize)) {
      return;
    }

    let depthDim = vec2f(textureDimensions(prevMipLevel).xy);
    let outDepthDim = vec2f(textureDimensions(nextMipLevel).xy);

    let ratio = depthDim / outDepthDim;

    let vReadCoord = vec2u(pos.x << 1, pos.y << 1);
    let vWriteCoord = pos.xy;

    let depthSamples = vec4f(
      textureLoad(prevMipLevel, vReadCoord, 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(1, 0), 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(0, 1), 0).r,
      textureLoad(prevMipLevel, vReadCoord + vec2u(1, 1), 0).r
    );

    var minDepth = min(
      depthSamples.x,
      min(
        depthSamples.y,
        min(depthSamples.z, depthSamples.w)
      )
    );

    let needExtraSampleX = ratio.x > 2.01;
    let needExtraSampleY = ratio.y > 2.01;

    minDepth = select(
      minDepth,
      min(
        minDepth,
        min(
          textureLoad(prevMipLevel, vReadCoord + vec2u(2, 0), 0).r,
          textureLoad(prevMipLevel, vReadCoord + vec2u(2, 1), 0).r
        )
      ),
      needExtraSampleX
    );
    minDepth = select(
      minDepth,
      min(
        minDepth,
        min(
          textureLoad(prevMipLevel, vReadCoord + vec2u(0, 2), 0).r,
          textureLoad(prevMipLevel, vReadCoord + vec2u(1, 2), 0).r
        )
      ),
      needExtraSampleY
    );
    minDepth = select(
      minDepth,
      min(
        minDepth,
        textureLoad(prevMipLevel, vReadCoord + vec2u(2, 2), 0).r
      ),
      needExtraSampleX && needExtraSampleY
    );
    
    textureStore(nextMipLevel, pos.xy, vec4f(minDepth));

  }
`,it=class it extends we{constructor(e,t){super(V.HiZ,e,t),this.mipTexSizes=[],this.mipTexViews=[];const r=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"unfilterable-float"}},{binding:1,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"r32float",viewDimension:"2d"}}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"Hi-Z Bind Group Layout",entries:r}),this.computePSO=j.createComputePipeline({label:"Hi-Z Compute PSO",layout:v.device.createPipelineLayout({label:"Hi-Z Compute PSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:Uc,module:j.createShaderModule(Kp,"Compute Hi-Z Shader Module"),constants:{WORKGROUP_SIZE_X:it.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:it.COMPUTE_WORKGROUP_SIZE_Y}}})}createComputePassDescriptor(){return this.computePassDescriptor||(this.computePassDescriptor={label:"Hi-Z Depth Mip Compute Pass"}),this.computePassDescriptor}render(e,t,r){const n=r[0].mipLevelCount,i=r[0].width,o=r[0].height;if(!this.mipTexSizes.length){this.mipTexSizes.push(Ce.create(i,o));for(let b=1;b<n;b++){const l=this.mipTexSizes[b-1],x=Ce.divScalar(l,2);this.mipTexSizes.push(x)}}const c={baseMipLevel:0,mipLevelCount:1,dimension:"2d",format:r[0].format};if(!this.mipTexViews.length)for(let b=0;b<n;b++)c.label=`Hi-Z Depth Mip Level ${b}`,c.baseMipLevel=b,this.mipTexViews.push(r[0].createView(c));const d=[{binding:0,resource:null},{binding:1,resource:null}],g=e.beginComputePass(this.createComputePassDescriptor());g.setPipeline(this.computePSO);for(let b=1;b<n;b++){const l=this.mipTexSizes[b][0],x=this.mipTexSizes[b][1],m=(l+it.COMPUTE_WORKGROUP_SIZE_X-1)/it.COMPUTE_WORKGROUP_SIZE_X,_=(x+it.COMPUTE_WORKGROUP_SIZE_Y-1)/it.COMPUTE_WORKGROUP_SIZE_Y;d[0].resource=this.mipTexViews[b-1],d[1].resource=this.mipTexViews[b];const w=v.device.createBindGroup({layout:this.bindGroupLayout,entries:d});g.setBindGroup(0,w),g.dispatchWorkgroups(m,_,1)}return g.end(),this.postRender(e),r}};it.COMPUTE_WORKGROUP_SIZE_X=8,it.COMPUTE_WORKGROUP_SIZE_Y=8;let Zi=it;const Zs="pointLightVertex",eo=s=>Bt`

  ${Y.VertexInput}
  ${Y.VertexOutput}
  ${Y.Camera}
  ${Y.Light}

  #if ${s===V.PointLightsStencilMask}
  @group(0) @binding(0) var<uniform> camera: Camera;
  @group(0) @binding(1) var<storage, read> lightsBuffer: array<Light>;
  #else
  @group(0) @binding(0) var normalTexture: texture_2d<f32>;
  @group(0) @binding(1) var colorTexture: texture_2d<f32>;
  @group(0) @binding(2) var depthTexture: texture_depth_2d;
  @group(0) @binding(3) var aoTexture: texture_2d<f32>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  #endif

  #if ${s===V.PointLightsLighting||s===V.DirectionalAmbientLighting}
  @group(0) @binding(5) var<storage, read> lightsBuffer: array<Light>;
  @group(0) @binding(6) var<uniform> debugLights: f32;
  #endif

  #if ${s===V.PointLightsNonCulledLighting}

  @group(1) @binding(0) var<uniform> cameraCulledPointLight: Light;

  #endif

  @vertex
  fn ${Zs}(
    @builtin(instance_index) instanceId: u32,
    in: VertexInput
  ) -> VertexOutput {
    #if ${s===V.PointLightsNonCulledLighting}
      let light = cameraCulledPointLight;
      let trueInstanceId = 0u;
    #else
      let trueInstanceId = instanceId;
      let light = lightsBuffer[trueInstanceId];
    #endif

    var position = in.position;
    position *= vec4f(vec3f(light.radius), 1.0);
    position += vec4f(light.position, 0.0);
    let pos = camera.projectionViewMatrix * position;

    var out: VertexOutput;
    out.position = pos;
    out.instanceId = trueInstanceId;
    return out;
  }
`;class Xp extends yr{setCamera(e){return this.camera=e,this.lightsMaskBindGroupEntries[0].resource={buffer:e.gpuBuffer},this}setLightsBuffer(e){return this.lightsMaskBindGroupEntries[1].resource={buffer:e},this}updateLightsMaskBindGroup(){return this.lightsMaskBindGroup=v.device.createBindGroup({layout:this.lightsMaskBindGroupLayout,entries:this.lightsMaskBindGroupEntries}),this}constructor(e,t){super(V.PointLightsStencilMask,e,t),this.lightsMaskBindGroupEntries=[{binding:0,resource:null},{binding:1,resource:null}];const r=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}];this.lightsMaskBindGroupLayout=v.device.createBindGroupLayout({label:"Light Masking Bind Group",entries:r});const n={label:"Point Light Mask PSO",layout:v.device.createPipelineLayout({label:"Point Lights Mask Render PSO Layout",bindGroupLayouts:[this.lightsMaskBindGroupLayout]}),vertex:{module:j.createShaderModule(eo(V.PointLightsStencilMask),"Point Light Mask Pass Vertex Shader"),entryPoint:Zs,buffers:xe.defaultLayout,constants:{}},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal",stencilReadMask:0,stencilWriteMask:255,stencilBack:{compare:"always",depthFailOp:"increment-wrap",failOp:"keep",passOp:"keep"},stencilFront:{compare:"always",depthFailOp:"decrement-wrap",failOp:"keep",passOp:"keep"}},primitive:{cullMode:"none"}};this.renderPSO=j.createRenderPipeline(n)}createRenderPassDescriptor(){return this.renderPassDescriptor||(this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Point Lights Mask Stencil Pass",colorAttachments:[],depthStencilAttachment:{view:this.inputTextureViews[0],depthLoadOp:"load",depthStoreOp:"store",stencilLoadOp:"clear",stencilStoreOp:"store",stencilClearValue:0}})),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||this.inputTextureViews.push(r[0].createView());const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Point Lights Stencil Mask"),v.bindRenderPSO(this.renderPSO),n.setStencilReference(128),n.setBindGroup(0,this.lightsMaskBindGroup),n.setVertexBuffer(0,st.pointLightSphereGeometry.vertexBuffers[0]),n.setIndexBuffer(st.pointLightSphereGeometry.indexBuffer,_e.INDEX_FORMAT),n.drawIndexed(st.pointLightSphereGeometry.indexCount,t.lightingManager.pointLightsCount,0,0,1),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),[r[0]]}}const Yt=class Yt extends yr{constructor(e,t){super(V.PointLightsNonCulledLighting,e,t);const r=v.device.createPipelineLayout({label:"Render Non-Instanced Non-Culled Point Lights PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout,dt.bindGroupLayout]}),n={label:Yt.FRONT_FACE_RENDER_PSO_LABEL,layout:r,vertex:{module:j.createShaderModule(eo(V.PointLightsNonCulledLighting),"Non-Instanced Non-Culled Point Lights Vertex Shader"),entryPoint:Zs,buffers:xe.defaultLayout},fragment:{module:j.createShaderModule(qi(V.PointLightsNonCulledLighting)),entryPoint:$s,targets:Yt.RENDER_TARGETS},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1},primitive:{cullMode:"back"}};this.frontFaceCullRenderPSO=j.createRenderPipeline(n),n.label=Yt.BACK_FACE_RENDER_PSO_LABEL,n.primitive.cullMode="front",this.backFaceCullRenderPSO=j.createRenderPipeline(n)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[5],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Non-Instanced Non-Culled Point Lights Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!0,view:this.inputTextureViews[2]}}),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView({aspect:"all"})),this.inputTextureViews.push(r[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(r[3].createView()),this.inputTextureViews.push(r[4].createView()),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[3]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).recreateGBufferTexturesBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor()),i=st.pointLightSphereGeometry.indexBuffer,o=st.pointLightSphereGeometry.vertexBuffers[0],c=st.pointLightSphereGeometry.indexCount;n.setIndexBuffer(i,_e.INDEX_FORMAT),n.setVertexBuffer(0,o),n.setBindGroup(0,this.gbufferTexturesBindGroup);let d=!1,g=!1;for(const b of t.lightingManager.cameraFaceCulledPointLights)D.dist(b.position,this.camera.position)>b.radius+.1?(d||n.setPipeline(this.frontFaceCullRenderPSO),d=!0,g=!1):(g||n.setPipeline(this.backFaceCullRenderPSO),d=!1,g=!0),n.setBindGroup(1,b.bindGroup),n.drawIndexed(c);return n.end(),this.postRender(e),[r[4]]}};Yt.FRONT_FACE_RENDER_PSO_LABEL="Render Non-Instanced Non-Culled Point Lights Front Face PSO Descriptor",Yt.BACK_FACE_RENDER_PSO_LABEL="Render Non-Instanced Non-Culled Point Lights Back Face PSO Descriptor";let to=Yt;class ro extends yr{constructor(e,t){super(V.PointLightsLighting,e,t);const r={compare:"less",failOp:"keep",depthFailOp:"keep",passOp:"keep"},n={label:"Point Light Render PSO",layout:v.device.createPipelineLayout({label:"Render Lights PSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout]}),vertex:{module:j.createShaderModule(eo(V.PointLightsLighting),"Point Light Render Pass Vertex Shader"),entryPoint:Zs,buffers:xe.defaultLayout,constants:{}},fragment:{module:j.createShaderModule(qi(V.PointLightsLighting),"Point Light Render Pass Fragment Shader"),entryPoint:$s,targets:ro.RENDER_TARGETS},depthStencil:{format:v.depthStencilFormat,depthWriteEnabled:!1,depthCompare:"less-equal",stencilReadMask:255,stencilWriteMask:0,stencilBack:r,stencilFront:r},primitive:{cullMode:"back"}};this.renderPSO=j.createRenderPipeline(n)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[5],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Point Lights Render Pass",colorAttachments:e,depthStencilAttachment:{depthReadOnly:!0,stencilReadOnly:!1,view:this.inputTextureViews[2],stencilLoadOp:"load",stencilStoreOp:"store"}}),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView({aspect:"all"})),this.inputTextureViews.push(r[2].createView({aspect:"depth-only"})),this.inputTextureViews.push(r[3].createView()),this.inputTextureViews.push(r[4].createView()),this.updateGbufferBindGroupEntryAt(0,this.inputTextureViews[0]).updateGbufferBindGroupEntryAt(1,this.inputTextureViews[1]).updateGbufferBindGroupEntryAt(2,this.inputTextureViews[3]).updateGbufferBindGroupEntryAt(3,this.inputTextureViews[4]).updateGbufferBindGroupEntryAt(4,{buffer:this.camera.gpuBuffer}).updateGbufferBindGroupEntryAt(5,{buffer:t.lightingManager.gpuBuffer}).recreateGBufferTexturesBindGroup());const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Point LightingSystem"),v.bindRenderPSO(this.renderPSO),n.setBindGroup(0,this.gbufferTexturesBindGroup),n.setVertexBuffer(0,st.pointLightSphereGeometry.vertexBuffers[0]),n.setIndexBuffer(st.pointLightSphereGeometry.indexBuffer,_e.INDEX_FORMAT),n.drawIndexed(st.pointLightSphereGeometry.indexCount,t.lightingManager.pointLightsCount,0,0,1),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),[r[4]]}}const kc="main",Et=class Et extends we{constructor(e,t){super(V.Reflection,e,t),this._maxIterations=150,this._debugMissedIntersections=!1,this._isHiZ=!0;const r=[{binding:0,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:2,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:3,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"unfilterable-float"}},{binding:4,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba16float",viewDimension:"2d"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}];var n;this.bindGroupLayout=v.device.createBindGroupLayout({label:"Reflection Pass ComputePSO Bind Group Layout",entries:r}),this.computePSO=j.createComputePipeline({label:"Reflection Pass Compute PSO",layout:v.device.createPipelineLayout({label:"Reflection PASS ComputePSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),compute:{entryPoint:kc,module:j.createShaderModule((n="rgba16float",`
  ${Y.Camera}

  struct SSRSettings {
    isHiZ: i32,
    maxIterations: i32,
    debugMissedIntersections: i32
  };

  @group(0) @binding(0) var sceneTexture: texture_2d<f32>;
  @group(0) @binding(1) var normalMetallicRoughnessTexture: texture_2d<f32>;
  @group(0) @binding(2) var albedoReflectanceTexture: texture_2d<f32>;
  @group(0) @binding(3) var depthTexture: texture_2d<f32>;
  @group(0) @binding(4) var outTexture: texture_storage_2d<${n}, write>;
  @group(0) @binding(5) var<uniform> camera: Camera;
  @group(0) @binding(6) var<uniform> settings: SSRSettings;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;

  ${Vr}

  const MAX_THICKNESS = 0.001;

  fn ComputePosAndReflection(
    tid: vec2u,
    viewNormal: vec3f,
    projectionMatrix: mat4x4f,
    inverseProjectionMatrix: mat4x4f,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    outSamplePosInTexSpace: ptr<function, vec3f>,
    outReflDirInTexSpace: ptr<function, vec3f>,
    outMaxDistance: ptr<function, f32>
  ) {
    let sampleDepth = textureLoad(depthTexture, tid, 0).r;
    var samplePosClipSpace = vec4f(
      ((f32(tid.x) + 0.5) / f32(viewportWidth)) * 2 - 1.0,
      ((f32(tid.y) + 0.5) / f32(viewportHeight)) * 2 - 1.0,
      sampleDepth,
      1
    );
    samplePosClipSpace.y *= -1;
    var samplePosViewSpace = inverseProjectionMatrix * samplePosClipSpace;
    samplePosViewSpace /= samplePosViewSpace.w;
    let vCamToSampleViewSpace = normalize(samplePosViewSpace.xyz);
    let vReflectionViewSpace = vec4f(reflect(vCamToSampleViewSpace.xyz, viewNormal.xyz), 0.0);

    var vReflectionEndPosViewSpace = samplePosViewSpace + vReflectionViewSpace * 1000;
    // vReflectionEndPosViewSpace /= select(1.0, vReflectionEndPosViewSpace.z, vReflectionEndPosViewSpace.z > 0.0);
    var vReflectionEndPosClipSpace = projectionMatrix * vec4f(vReflectionEndPosViewSpace.xyz, 1.0);
    vReflectionEndPosClipSpace /= vReflectionEndPosClipSpace.w;

    let vReflectionDir = normalize((vReflectionEndPosClipSpace - samplePosClipSpace).xyz);

    // transform to texture space
    (*outSamplePosInTexSpace) = vec3f(
      samplePosClipSpace.xy * vec2f(0.5, -0.5) + vec2f(0.5, 0.5),
      samplePosClipSpace.z
    );

    (*outReflDirInTexSpace) = vec3f(
      vReflectionDir.xy * vec2f(0.5, -0.5),
      vReflectionDir.z
    );

    (*outMaxDistance) = select(-outSamplePosInTexSpace.x / outReflDirInTexSpace.x, (1 - outSamplePosInTexSpace.x) / outReflDirInTexSpace.x, outReflDirInTexSpace.x >= 0);
    (*outMaxDistance) = min(*outMaxDistance, select((1 - outSamplePosInTexSpace.y) / outReflDirInTexSpace.y, -outSamplePosInTexSpace.y / outReflDirInTexSpace.y, outReflDirInTexSpace.y < 0));
    (*outMaxDistance) = min(*outMaxDistance, select((1 - outSamplePosInTexSpace.z) / outReflDirInTexSpace.z, -outSamplePosInTexSpace.z / outReflDirInTexSpace.z, outReflDirInTexSpace.z < 0));
  }

  @must_use
  fn FindIntersectionLinear(
    samplePosInTexSpace: vec3f,
    reflDirInTexSpace: vec3f,
    maxTraceDistance: f32,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    intersection: ptr<function, vec3f>
  ) -> f32 {
    let vReflectionEndPosTexSpace = samplePosInTexSpace + reflDirInTexSpace * maxTraceDistance;
    var dp = vReflectionEndPosTexSpace.xyz - samplePosInTexSpace.xyz;
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let sampleScreenPos = vec2i(samplePosInTexSpace.xy * viewSize);
    let endPosScreenPos = vec2i(vReflectionEndPosTexSpace.xy * viewSize);
    let dp2 = endPosScreenPos - sampleScreenPos;
    let maxDist = max(abs(dp2.x), abs(dp2.y));
    dp /= f32(maxDist);

    var rayPosTexSpace = vec4f(samplePosInTexSpace.xyz + dp, 0);
    let rayDirTexSpace = vec4f(dp.xyz, 0);
    let rayPosStartTexSpace = rayPosTexSpace;

    var hitIndex = -1;
    for (var i = 0; i < maxDist && i < settings.maxIterations; i += 4) {
      let rayPosTexSpace0 = rayPosTexSpace + rayDirTexSpace * 0;
      let rayPosTexSpace1 = rayPosTexSpace + rayDirTexSpace * 1;
      let rayPosTexSpace2 = rayPosTexSpace + rayDirTexSpace * 2;
      let rayPosTexSpace3 = rayPosTexSpace + rayDirTexSpace * 3;

      let depth0 = textureLoad(depthTexture, vec2u(rayPosTexSpace0.xy * viewSize), 0).r;
      let depth1 = textureLoad(depthTexture, vec2u(rayPosTexSpace1.xy * viewSize), 0).r;
      let depth2 = textureLoad(depthTexture, vec2u(rayPosTexSpace2.xy * viewSize), 0).r;
      let depth3 = textureLoad(depthTexture, vec2u(rayPosTexSpace3.xy * viewSize), 0).r;

      var thickness = 0.0;

      thickness = rayPosTexSpace0.z - depth0;
      hitIndex = select(hitIndex, i + 0, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace1.z - depth1;
      hitIndex = select(hitIndex, i + 1, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace2.z - depth2;
      hitIndex = select(hitIndex, i + 2, thickness >= 0 && thickness < MAX_THICKNESS);

      thickness = rayPosTexSpace3.z - depth3;
      hitIndex = select(hitIndex, i + 3, thickness >= 0 && thickness < MAX_THICKNESS);

      if (hitIndex != -1) {
        break;
      }

      rayPosTexSpace = rayPosTexSpace3 + rayDirTexSpace;
    }

    let intersected = hitIndex >= 0;
    (*intersection) = rayPosStartTexSpace.xyz + rayDirTexSpace.xyz * f32(hitIndex);

    return select(0.0, 1.0, intersected);
  }

  @must_use
  fn getCellCount(mipLevel: i32, depthTexture: texture_2d<f32>) -> vec2f {
    return vec2f(textureDimensions(depthTexture, mipLevel));
  }

  @must_use
  fn getCell(pos: vec2f, cell_count: vec2f) -> vec2f {
    return vec2f(floor(pos * cell_count));
  }

  @must_use
  fn intersectDepthPlane(o: vec3f, d: vec3f, z: f32) -> vec3f {
	  return o + d * z;
  }

  @must_use
  fn intersectCellBoundary(
    o: vec3f,
    d: vec3f,
    cell: vec2f,
    cellCount: vec2f,
    crossStep: vec2f,
    crossOffset: vec2f
  ) -> vec3f {
    var intersection = vec3f(0.0);
    
    let index = cell + crossStep;
    var boundary = index / cellCount;
    boundary += crossOffset;
    
    var delta = boundary - o.xy;
    delta /= d.xy;
    let t = min(delta.x, delta.y);
    
    intersection = intersectDepthPlane(o, d, t);
    
    return intersection;
  }

  @must_use
  fn getMinimumDepthPlane(
    p: vec2f,
    mipLevel: i32,
    depthTexture: texture_2d<f32>
  ) -> f32 {
    return textureLoad(depthTexture, vec2u(p), mipLevel).r;
  }

  @must_use
  fn crossedCellBoundary(oldCellIndex: vec2f, newCellIndex: vec2f) -> bool {
	  return (oldCellIndex.x != newCellIndex.x) || (oldCellIndex.y != newCellIndex.y);
  }

  @must_use
  fn FindIntersectionHiZ(
    samplePosInTexSpace: vec3f,
    reflDirInTexSpace: vec3f,
    maxTraceDistance: f32,
    viewportWidth: u32,
    viewportHeight: u32,
    depthTexture: texture_2d<f32>,
    intersection: ptr<function, vec3f>
  ) -> f32 {
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let maxLevel = textureNumLevels(depthTexture) - 1;

    var crossStep = vec2f(
      select(-1.0, 1.0, reflDirInTexSpace.x >= 0),
      select(-1.0, 1.0, reflDirInTexSpace.y >= 0)
    );
    let crossOffset = crossStep / viewSize / 128.0;
    crossStep = saturate(crossStep);
    
    var ray = samplePosInTexSpace.xyz;
    let minZ = ray.z;
    let maxZ = ray.z + reflDirInTexSpace.z * maxTraceDistance;
    let deltaZ = (maxZ - minZ);

    let o = ray;
    let d = reflDirInTexSpace * maxTraceDistance;

    let startLevel = 2;
    let stopLevel = 0;

    let startCellCount = getCellCount(startLevel, depthTexture);
	
    let rayCell = getCell(ray.xy, startCellCount);
    ray = intersectCellBoundary(
      o,
      d,
      rayCell,
      startCellCount,
      crossStep,
      crossOffset * 64
    );

    var level = startLevel;
    var iter = 0;
    let isBackwardRay = reflDirInTexSpace.z < 0;
    let rayDir = select(1.0, -1.0, isBackwardRay);

    while(level >= stopLevel && ray.z * rayDir <= maxZ * rayDir && iter < settings.maxIterations) {
      let cellCount = getCellCount(level, depthTexture);
      let oldCellIdx = getCell(ray.xy, cellCount);
      let cellMinZ = getMinimumDepthPlane((oldCellIdx + 0.5), level, depthTexture);
      let tmpRay = select(
        ray,
        intersectDepthPlane(o, d, (cellMinZ - minZ) / deltaZ),
        (cellMinZ > ray.z) && !isBackwardRay
      );
      let newCellIdx = getCell(tmpRay.xy, cellCount);
      
      let thickness = select(0, (ray.z - cellMinZ), level == 0);
      let crossed = (isBackwardRay && (cellMinZ > ray.z)) ||
                    (thickness > (MAX_THICKNESS)) ||
                    crossedCellBoundary(oldCellIdx, newCellIdx);
      ray = select(
        tmpRay,
        intersectCellBoundary(o, d, oldCellIdx, cellCount, crossStep, crossOffset),
        crossed
      );
      level = select(
        level - 1,
        min(i32(maxLevel), level + 1),
        crossed
      );
      
      iter++;
    }

    let intersected = (level < stopLevel);
    (*intersection) = ray;
	
    let intensity = select(0.0, 1.0, intersected);
    
    return intensity;
  }

  @must_use
  fn ComputeReflectionColor(
    intensity: f32,
    intersection: vec3f,
    viewportWidth: u32,
    viewportHeight: u32,
    sceneTexture: texture_2d<f32>
  ) -> vec4f {
    let viewSize = vec2f(f32(viewportWidth), f32(viewportHeight));
    let texCoords = vec2u(intersection.xy * viewSize);
    let ssrColor = textureLoad(sceneTexture, texCoords, 0);
    return ssrColor;
  }

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn ${kc}(@builtin(global_invocation_id) globalInvocationId : vec3u,) {
    let pos = globalInvocationId.xy;

    let encodedN = textureLoad(normalMetallicRoughnessTexture, pos, 0).rg;
    let N = decodeNormal(encodedN);
    let sceneColor = textureLoad(sceneTexture, pos, 0);
    let reflectanceMask = textureLoad(albedoReflectanceTexture, pos, 0).a;

    var reflectionColor = vec4f(0);
    var intensity = 0.0;

    let isReflectance = reflectanceMask != 0;
    if (isReflectance) {
      var samplePosInTexSpace = vec3f(0);
      var reflDirInTexSpace = vec3f(0);
      var maxTraceDistance = 0.0;

      ComputePosAndReflection(
        pos.xy,
        N,
        camera.projectionMatrix,
        camera.inverseProjectionMatrix,
        camera.viewportWidth,
        camera.viewportHeight,
        depthTexture,
        &samplePosInTexSpace,
        &reflDirInTexSpace,
        &maxTraceDistance
      );

      var intersection = vec3f(0);

      if (settings.isHiZ == 1) {
        intensity = FindIntersectionHiZ(
          samplePosInTexSpace,
          reflDirInTexSpace,
          maxTraceDistance,
          camera.viewportWidth,
          camera.viewportHeight,
          depthTexture,
          &intersection
        );
      } else {
        intensity = FindIntersectionLinear(
          samplePosInTexSpace,
          reflDirInTexSpace,
          maxTraceDistance,
          camera.viewportWidth,
          camera.viewportHeight,
          depthTexture,
          &intersection
        );
      }

      reflectionColor = ComputeReflectionColor(
        intensity,
        intersection,
        camera.viewportWidth,
        camera.viewportHeight,
        sceneTexture
      );
    }

    let combinedColor = sceneColor + reflectionColor;
    let finalColor = select(
      combinedColor,
      mix(
        select(combinedColor, vec4f(0, 1, 0, 1), isReflectance),
        combinedColor,
        intensity
      ),
      settings.debugMissedIntersections == 1
    );

    textureStore(outTexture, pos, finalColor);
    
  }
`)),constants:{WORKGROUP_SIZE_X:Et.COMPUTE_WORKGROUP_SIZE_X,WORKGROUP_SIZE_Y:Et.COMPUTE_WORKGROUP_SIZE_Y}}}),this.settingsBuffer=v.device.createBuffer({label:"SSR Settings Buffer",size:4*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),W.addBufferBytes(this.settingsBuffer),new Int32Array(this.settingsBuffer.getMappedRange()).set(new Int32Array([this._isHiZ?1:0,this._maxIterations,this._debugMissedIntersections?1:0])),this.settingsBuffer.unmap(),this.outTextures.push(v.device.createTexture({label:"Reflection Texture",size:{width:e,height:t,depthOrArrayLayers:1},format:"rgba16float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC})),W.addTextureBytes(this.outTextures[0])}set maxIterations(e){this._maxIterations=e,this.updateSettingsBuffer()}set debugMissedIntersections(e){this._debugMissedIntersections=e,this.updateSettingsBuffer()}set isHiZ(e){this._isHiZ=e,this.updateSettingsBuffer()}updateSettingsBuffer(){v.device.queue.writeBuffer(this.settingsBuffer,0,new Int32Array([this._isHiZ?1:0,this._maxIterations,this._debugMissedIntersections?1:0]))}destroy(){super.destroy(),W.removeBufferBytes(this.settingsBuffer),this.settingsBuffer.destroy()}setCamera(e){return this.camera=e,this}createComputePassDescriptor(){return this.computePassDescriptor||(this.computePassDescriptor={label:"Reflection Compute Pass Encoder"}),this.computePassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()),this.inputTextureViews.push(r[2].createView()),this.inputTextureViews.push(r[3].createView());const c=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:this.inputTextureViews[2]},{binding:3,resource:this.inputTextureViews[3]},{binding:4,resource:this.outTextures[0].createView()},{binding:5,resource:{buffer:this.camera.gpuBuffer}},{binding:6,resource:{buffer:this.settingsBuffer}}];this.bindGroup=v.device.createBindGroup({label:"Compute Reflections Bind Group",entries:c,layout:this.bindGroupLayout})}const n=e.beginComputePass(this.createComputePassDescriptor());v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Reflection Compute Pass"),n.setPipeline(this.computePSO),n.setBindGroup(0,this.bindGroup);const i=Math.ceil(this.outTextures[0].width/Et.COMPUTE_WORKGROUP_SIZE_X),o=Math.ceil(this.outTextures[0].height/Et.COMPUTE_WORKGROUP_SIZE_Y);return n.dispatchWorkgroups(i,o,1),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}};Et.COMPUTE_WORKGROUP_SIZE_X=8,Et.COMPUTE_WORKGROUP_SIZE_Y=8;let so=Et;const Nc="fragBlurSSAO",Wp=`
  ${Y.Camera}
  ${Y.VertexOutput}

  @group(0) @binding(0) var ssaoTexture: texture_2d<f32>;

  @fragment
  fn ${Nc}(in: VertexOutput) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    var result = 0.0;
    for (var y = -2; y < 2; y++) {
      for (var x = -2; x < 2; x++) {
        let offset = pixelCoords + vec2i(x, y);
        result += textureLoad(ssaoTexture, offset, 0).r;
      }
    }
    return vec4f(result / 16.0, 0, 0, 1);
  }
`;class Yp extends we{constructor(e,t){super(V.SSAOBlur,e,t);const r=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}}];this.bindGroupLayout=v.device.createBindGroupLayout({label:"SSAO Blur Input Bind Group",entries:r}),this.renderPSO=j.createRenderPipeline({label:"SSAO Blur RenderPSO",layout:v.device.createPipelineLayout({label:"SSAO Blur RenderPSO Layout",bindGroupLayouts:[this.bindGroupLayout]}),vertex:{module:j.createShaderModule(Jt),entryPoint:_t},fragment:{module:j.createShaderModule(Wp),entryPoint:Nc,targets:[{format:"r16float"}]}}),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"r16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,label:"SSAO Blurred Texture"})),W.addTextureBytes(this.outTextures[0]),this.outTextureView=this.outTextures[0].createView()}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{loadOp:"load",storeOp:"store",view:this.outTextureView}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"SSAO Blur Render Pass Descriptor",colorAttachments:e}),this.renderPassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView());const i=[{binding:0,resource:this.inputTextureViews[0]}];this.bindGroup=v.device.createBindGroup({label:"SSAO Blur Bind Group",entries:i,layout:this.bindGroupLayout})}const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin SSAO Blur"),n.setBindGroup(0,this.bindGroup),n.setPipeline(this.renderPSO),n.draw(3),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),this.outTextures}}const Vc="fragSSAO",qp=`
  ${Y.Camera}
  ${Y.VertexOutput}
  ${Y.MathHelpers}

  ${Vr}

  struct Settings {
    kernelSize: u32,
    radius: f32,
    strength: f32
  };

  @group(0) @binding(0) var normalMetallicRoughnessTex: texture_2d<f32>;
  @group(0) @binding(1) var depthTexture: texture_depth_2d;
  @group(0) @binding(2) var noiseTexture: texture_2d<f32>;
  @group(0) @binding(3) var<storage, read> kernelBuffer: array<vec4f>;
  @group(0) @binding(4) var<uniform> camera: Camera;
  @group(0) @binding(5) var<uniform> settings: Settings; 

  @fragment
  fn ${Vc}(
    in: VertexOutput
  ) -> @location(0) vec4f {
    let coord = in.position;
    let pixelCoords = vec2i(floor(coord.xy));
    let encodedN = textureLoad(normalMetallicRoughnessTex, pixelCoords, 0).rg;
    let viewNormal = decodeNormal(encodedN); 
    let centerDepth = textureLoad(depthTexture, pixelCoords, 0);
    let viewSpacePos = calcViewSpacePos(camera, coord.xy, centerDepth);

    let noiseScale = vec2i(textureDimensions(noiseTexture).xy);
    let sampleCoords = pixelCoords % noiseScale;
    var randomVec = textureLoad(noiseTexture, sampleCoords, 0).rgb;
    randomVec = (camera.viewMatrix * vec4f(randomVec, 0)).xyz;

    let viewTangent = normalize(randomVec - viewNormal * dot(randomVec, viewNormal));
    let viewBitangent = cross(viewNormal, viewTangent);
    let TBN = mat3x3f(viewTangent, viewBitangent, viewNormal);

    let kernelSize = settings.kernelSize;
    let radius = settings.radius;

    var occlusion = 0.0;

    let screenSize = vec2i(textureDimensions(depthTexture).xy);

    for (var i = 0u; i < kernelSize; i++) {
      var viewSamplePos = TBN * kernelBuffer[i].xyz;
      viewSamplePos = viewSpacePos + viewSamplePos * radius;

      let viewSampleDir = normalize(viewSamplePos - viewSpacePos);
      let NdotS = max(dot(viewNormal, viewSampleDir), 0.0);

      let clipPos = camera.projectionMatrix * vec4f(viewSamplePos, 1.0);
      let ndcPos = clipPos.xy / clipPos.w;

      let screenCoord = vec2i(vec2f(ndcPos.x * 0.5 + 0.5, -ndcPos.y * 0.5 + 0.5) * vec2f(screenSize));

      var sampleDepth = textureLoad(depthTexture, screenCoord, 0);
      sampleDepth = calcViewSpacePos(camera, vec2f(screenCoord), sampleDepth).z;
      
      let rangeCheck = smoothstep(0.0, 1.0, radius / abs(viewSpacePos.z - sampleDepth));

      occlusion += select(0.0, 1.0, sampleDepth > viewSamplePos.z) * rangeCheck * NdotS;
    }

    occlusion = 1 - (occlusion / f32(kernelSize));
    let finalOcclusion = pow(occlusion, settings.strength);

    return vec4f(finalOcclusion);
  }
`,go=class go extends we{constructor(e,t){super(V.SSAO,e,t),this.gbufferTexturesBindGroupEntries=[],this.startKernelSize=8,this._kernelSize=128,this._radius=.5,this._strength=2;const r=this.kernelSize,n=new Float32Array(4*r);for(let c=0;c<r;c++){const d=wr.create(2*Math.random()-1,2*Math.random()-1,Math.random(),0),g=c/r;wr.scale(d,No(.1,1,g*g),d),n.set(d,4*c)}this.kernelBuffer=v.device.createBuffer({label:"SSAO Kernel Buffer",mappedAtCreation:!0,size:4*r*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.STORAGE}),W.addBufferBytes(this.kernelBuffer),new Float32Array(this.kernelBuffer.getMappedRange()).set(n),this.kernelBuffer.unmap(),this.settingsBuffer=v.device.createBuffer({label:"SSAO Settings GPU Buffer",size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM,mappedAtCreation:!0});const i=this.settingsBuffer.getMappedRange();new Uint32Array(i).set([this.startKernelSize]),new Float32Array(i).set([this.radius,this.strength],1),W.addBufferBytes(this.settingsBuffer),this.settingsBuffer.unmap();const o=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"unfilterable-float"}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:5,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}];this.gbufferCommonBindGroupLayout=v.device.createBindGroupLayout({label:"SSAO Input Bind Group",entries:o}),this.renderPSO=j.createRenderPipeline({label:"SSAO RenderPSO",layout:v.device.createPipelineLayout({label:"SSAO RenderPSO Layout",bindGroupLayouts:[this.gbufferCommonBindGroupLayout]}),vertex:{module:j.createShaderModule(Jt),entryPoint:_t},fragment:{module:j.createShaderModule(qp),entryPoint:Vc,targets:[{format:"r16float"}]}}),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"r16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,label:"SSAO Texture"})),this.outTextureView=this.outTextures[0].createView(),W.addTextureBytes(this.outTextures[0]),this.loadBlueNoiseTexture()}get kernelSize(){return this._kernelSize}set kernelSize(e){this._kernelSize=e,this.updateSettingsBufferKernelSize()}get radius(){return this._radius}set radius(e){this._radius=e,this.updateSettingsBufferRadius()}get strength(){return this._strength}set strength(e){this._strength=e,this.updateSettingsBufferStrength()}updateSettingsBufferKernelSize(){v.device.queue.writeBuffer(this.settingsBuffer,0,new Uint32Array([this.kernelSize]))}updateSettingsBufferRadius(){v.device.queue.writeBuffer(this.settingsBuffer,Uint32Array.BYTES_PER_ELEMENT,new Float32Array([this.radius]))}updateSettingsBufferStrength(){v.device.queue.writeBuffer(this.settingsBuffer,Uint32Array.BYTES_PER_ELEMENT+Float32Array.BYTES_PER_ELEMENT,new Float32Array([this.strength]))}destroy(){var e;super.destroy(),this.noiseTexture&&W.removeTextureBytes(this.noiseTexture),W.removeBufferBytes(this.kernelBuffer),(e=this.noiseTexture)==null||e.destroy(),this.kernelBuffer.destroy()}async loadBlueNoiseTexture(){const e=await fetch("data:image/png;base64,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"),t=await e.blob(),r=await createImageBitmap(t);this.noiseTexture=v.device.createTexture({label:"Blue Noise Texture",format:"rgba32float",size:{width:r.width,height:r.height},usage:GPUTextureUsage.TEXTURE_BINDING}),v.device.queue.copyExternalImageToTexture({source:r},{texture:this.noiseTexture},{width:r.width,height:r.height}),r.close()}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{loadOp:"load",storeOp:"store",view:this.outTextureView}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"SSAO Render Pass Descriptor",colorAttachments:e}),this.renderPassDescriptor}render(e,t,r){var o;this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView({aspect:"depth-only"})),this.gbufferTexturesBindGroupEntries=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:((o=this.noiseTexture)==null?void 0:o.createView())||Be.dummyTexture.createView()},{binding:3,resource:{buffer:this.kernelBuffer}},{binding:4,resource:{buffer:this.camera.gpuBuffer}},{binding:5,resource:{buffer:this.settingsBuffer}}],this.gbufferTexturesBindGroup=v.device.createBindGroup({layout:this.gbufferCommonBindGroupLayout,entries:this.gbufferTexturesBindGroupEntries}));const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.ENABLE_DEBUG_GROUPS&&i.pushDebugGroup("Begin SSAO"),i.setBindGroup(0,this.gbufferTexturesBindGroup),v.bindRenderPSO(this.renderPSO),i.draw(3),v.ENABLE_DEBUG_GROUPS&&i.popDebugGroup(),i.end(),this.postRender(e),this.outTextures}};go.SSAO_SCALE_FACTOR=.5;let no=go;class Qp extends we{constructor(e,t){super(V.Skybox,e,t)}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[0],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Skybox render Pass",colorAttachments:e,depthStencilAttachment:{stencilReadOnly:!0,view:this.inputTextureViews[1],depthLoadOp:"load",depthStoreOp:"store"}}),this.renderPassDescriptor}render(e,t,r){var i;this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()));const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Begin Skybox"),n.setBindGroup(ae.CameraPlusOptionalLights,this.cameraBindGroup),(i=t.skybox)==null||i.render(n),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),r}}const Hc="main",$p=`

  @group(0) @binding(0) var colorTexture: texture_2d<f32>;
  @group(0) @binding(1) var velocityTexture: texture_2d<f32>;
  @group(0) @binding(2) var historyTexture: texture_2d<f32>;
  @group(0) @binding(3) var<uniform> historyMixFactor: f32;

  @fragment
  fn ${Hc}(@builtin(position) coord: vec4f) -> @location(0) vec4f {
    let pixelCoords = vec2i(floor(coord.xy));
    let currColor = textureLoad(colorTexture, pixelCoords, 0).xyz;
    let velocity = textureLoad(velocityTexture, pixelCoords, 0).xy;
    let prevousPixelPos = vec2i(floor(coord.xy - velocity));
    
    var history = textureLoad(historyTexture, prevousPixelPos, 0).xyz;

    let nearColor0 = textureLoad(colorTexture, pixelCoords + vec2i(1, 0), 0).xyz;
    let nearColor1 = textureLoad(colorTexture, pixelCoords + vec2i(0, 1), 0).xyz;
    let nearColor2 = textureLoad(colorTexture, pixelCoords + vec2i(-1, 0), 0).xyz;
    let nearColor3 = textureLoad(colorTexture, pixelCoords + vec2i(0, -1), 0).xyz;
    
    let boxMin = min(currColor, min(nearColor0, min(nearColor1, min(nearColor2, nearColor3))));
    let boxMax = max(currColor, max(nearColor0, max(nearColor1, max(nearColor2, nearColor3))));;
    
    history = clamp(history, boxMin, boxMax);

    var color = vec4f(mix(currColor, history, historyMixFactor), 1.0);

    return color;
  }
`,Wr=class Wr extends we{constructor(e,t){super(V.TAAResolve,e,t),this.historyReset=!1;const r=j.createShaderModule(Jt),n=j.createShaderModule($p),i=[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,buffer:{}}];this.texturesBindGroupLayout=v.device.createBindGroupLayout({label:"TAA Resolve Input Textures Bind Group",entries:i});const o={layout:v.device.createPipelineLayout({bindGroupLayouts:[this.texturesBindGroupLayout]}),vertex:{module:r,entryPoint:_t},fragment:{module:n,entryPoint:Hc,targets:[{format:"rgba16float"}]},primitive:{topology:"triangle-list",cullMode:"back"}};this.renderPSO=j.createRenderPipeline(o),this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.COPY_SRC,label:"TAA Resolve Texture"})),this.outTextureView=this.outTextures[0].createView(),W.addTextureBytes(this.outTextures[0]),this.sourceCopyTextureInfo={texture:this.outTextures[0],mipLevel:0,origin:{x:0,y:0,z:0}},this.outTextures.push(v.device.createTexture({dimension:"2d",format:"rgba16float",mipLevelCount:1,sampleCount:1,size:{width:e,height:t,depthOrArrayLayers:1},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,label:"TAA Resolve Texture"})),this.historyTextureView=this.outTextures[1].createView(),W.addTextureBytes(this.outTextures[1]),this.destCopyTextureInfo={texture:this.outTextures[1],mipLevel:0,origin:{x:0,y:0,z:0}},this.copyTextureExtend={width:e,height:t,depthOrArrayLayers:1},this.historyMixFactorBuffer=v.device.createBuffer({label:"TAA History Mix Factor Buffer",size:1*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),new Float32Array(this.historyMixFactorBuffer.getMappedRange()).set([Wr.HISTORY_MIX_FACTOR]),W.addBufferBytes(this.historyMixFactorBuffer),this.historyMixFactorBuffer.unmap()}destroy(){W.removeBufferBytes(this.historyMixFactorBuffer),this.historyMixFactorBuffer.destroy()}resetHistory(){this.historyReset=!0,v.device.queue.writeBuffer(this.historyMixFactorBuffer,0,new Float32Array([0]))}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.outTextureView,loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"TAA Resolve Pass",colorAttachments:e}),this.renderPassDescriptor}render(e,t,r){if(!this.inputTextureViews.length){this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView());const o=[{binding:0,resource:this.inputTextureViews[0]},{binding:1,resource:this.inputTextureViews[1]},{binding:2,resource:this.historyTextureView},{binding:3,resource:{buffer:this.historyMixFactorBuffer}}];this.textureBindGroup=v.device.createBindGroup({layout:this.texturesBindGroupLayout,entries:o})}const n=this.createRenderPassDescriptor(),i=e.beginRenderPass(n);return v.setActiveRenderPass(this.type,i),v.bindRenderPSO(this.renderPSO),i.setBindGroup(0,this.textureBindGroup),i.draw(3),i.end(),e.copyTextureToTexture(this.sourceCopyTextureInfo,this.destCopyTextureInfo,this.copyTextureExtend),this.postRender(e),this.historyReset&&(v.device.queue.onSubmittedWorkDone().then(()=>{v.device.queue.writeBuffer(this.historyMixFactorBuffer,0,new Float32Array([Wr.HISTORY_MIX_FACTOR]))}),this.historyReset=!1),this.outTextures}};Wr.HISTORY_MIX_FACTOR=.9;let io=Wr;class Zp extends we{constructor(e,t){super(V.Transparent,e,t)}setCamera(e){return this.camera=e,this}createRenderPassDescriptor(){if(this.renderPassDescriptor)return this.renderPassDescriptor;const e=[{view:this.inputTextureViews[0],loadOp:"load",storeOp:"store"}];return this.renderPassDescriptor=this.augmentRenderPassDescriptorWithTimestampQuery({label:"Transparent Render Pass",colorAttachments:e,depthStencilAttachment:{view:this.inputTextureViews[1],depthLoadOp:"load",depthStoreOp:"store",stencilReadOnly:!0}}),this.renderPassDescriptor}render(e,t,r){this.inputTextureViews.length||(this.inputTextureViews.push(r[0].createView()),this.inputTextureViews.push(r[1].createView()));const n=e.beginRenderPass(this.createRenderPassDescriptor());return v.setActiveRenderPass(this.type,n),v.ENABLE_DEBUG_GROUPS&&n.pushDebugGroup("Render Transparent Nodes"),this.cameraBindGroup=v.device.createBindGroup({label:"Camera Bind Group for: Transparent Pass",layout:j.defaultCameraPlusLightsBindGroupLayout,entries:[{binding:0,resource:{buffer:this.camera.gpuBuffer}},{binding:1,resource:{buffer:t.lightingManager.gpuBuffer}}]}),n.setBindGroup(ae.CameraPlusOptionalLights,this.cameraBindGroup),t.lightingManager.render(n),t.renderDebugMeshes(n),v.ENABLE_DEBUG_GROUPS&&n.popDebugGroup(),n.end(),this.postRender(e),r}}const jr="deferredPBRFrag",en=({hasPBRTextures:s=!1,isInstanced:e=!1}={})=>Bt`
  ${Y.Camera}
  ${Y.VertexOutput}
  ${Y.GBufferOutput}
  ${Y.ModelUniform}
  ${Y.InstanceInput}

  @group(${ae.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(${ae.Model}) @binding(0) var<uniform> model: ModelUniform;
  
  @group(${ae.PBRTextures}) @binding(${ls.Default}) var texSampler: sampler;
  @group(${ae.PBRTextures}) @binding(${pe.Albedo}) var albedoTexture: texture_2d<f32>;
  @group(${ae.PBRTextures}) @binding(${pe.Normal}) var normalTexture: texture_2d<f32>;
  @group(${ae.PBRTextures}) @binding(${pe.MetallicRoughness}) var metallicRoughnessTexture: texture_2d<f32>;

  #if ${e}
  @group(${ae.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
  #endif

  ${Vr}

  @fragment
  fn ${jr}(in: VertexOutput) -> GBufferOutput  {
    let uv = in.uv;
    
    var viewSpaceN = normalize(in.viewNormal);
    let viewSpaceT = normalize(in.viewTangent);
    let viewSpaceB = normalize(in.viewBitangent);
    let viewSpaceTBN = mat3x3f(viewSpaceT, viewSpaceB, viewSpaceN);

    // var textureNormal = textureSampleLevel(normalTexture, texSampler, uv, 5.0).rgb * 2 - 1;
    let textureNormal = textureSample(normalTexture, texSampler, uv).rgb * 2 - 1;
    
    if (${s}) {
      viewSpaceN = normalize(viewSpaceTBN * textureNormal);
    }

    var color = model.baseColor;
    if (${s}) {
      let texColor = textureSample(albedoTexture, texSampler, uv);
      if (texColor.a < 0.2) {
        discard;
      }
      color = texColor.rgb;
    }

    var out: GBufferOutput;

    #if ${e}
      var metallic = instanceInputs[in.instanceId].metallic;
      var roughness = instanceInputs[in.instanceId].roughness;
    #else
      var metallic = model.metallic;
      var roughness = model.roughness;
    #endif


    if (${s}) {
      let metallicRoughness = textureSample(metallicRoughnessTexture, texSampler, uv).rgb;
      metallic = metallicRoughness.b;
      roughness = metallicRoughness.g;
    }

    out.normalMetallicRoughness = vec4f(
      encodeNormal(viewSpaceN),
      metallic,
      roughness
    );
    
    out.color = vec4f(color, f32(model.isReflective));
    
    var oldPos = in.prevFrameClipPos;
    var newPos = in.currFrameClipPos;
    
    oldPos /= oldPos.w;
    oldPos.x = (oldPos.x+1)/2.0;
    oldPos.y = (oldPos.y+1)/2.0;
    oldPos.y = 1 - oldPos.y;
    
    newPos /= newPos.w;
    newPos.x = (newPos.x+1)/2.0;
    newPos.y = (newPos.y+1)/2.0;
    newPos.y = 1 - newPos.y;

    out.velocity = vec4f((newPos - oldPos).xy, 0, 1);
  
    return out;
  }
`,jc="forwardPBRFrag",em=({hasPBRTextures:s=!1,isInstanced:e=!1}={})=>Bt`
  ${Y.Camera}
  ${Y.VertexOutput}
  ${Y.GBufferOutput}
  ${Y.ModelUniform}
  ${Y.Material}
  ${Y.InstanceInput}
  ${Y.CommonHelpers}
  ${Y.Light}

  @group(${ae.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
  @group(${ae.CameraPlusOptionalLights}) @binding(1) var<storage, read> lightsBuffer: array<Light>;

  @group(${ae.Model}) @binding(0) var<uniform> model: ModelUniform;

  @group(${ae.PBRTextures}) @binding(${ls.Default}) var texSampler: sampler;
  @group(${ae.PBRTextures}) @binding(${pe.Albedo}) var albedoTexture: texture_2d<f32>;
  @group(${ae.PBRTextures}) @binding(${pe.Normal}) var normalTexture: texture_2d<f32>;
  @group(${ae.PBRTextures}) @binding(${pe.MetallicRoughness}) var metallicRoughnessTexture: texture_2d<f32>;

  #if ${e}
  @group(${ae.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
  #endif

  ${Fc({isDeferred:!1,hasIBL:!1})}

  @fragment
  fn ${jc}(in: VertexOutput) -> @location(0) vec4f {
    let uv = in.uv;

    var N = normalize(in.viewNormal);
    let T = normalize(in.viewTangent);
    let B = normalize(in.viewBitangent);
    let TBN = mat3x3f(T, B, N);
    let textureNormal = textureSample(normalTexture, texSampler, uv).rgb * 2 - 1;
    if (${s}) {
      N = normalize(TBN * textureNormal);
    }

    #if ${e}
      var metallic = instanceInputs[in.instanceId].metallic;
      var roughness = instanceInputs[in.instanceId].roughness;
    #else
      var metallic = model.metallic;
      var roughness = model.roughness;
    #endif

    if (${s}) {
      let metallicRoughness = textureSample(metallicRoughnessTexture, texSampler, uv).rgb;
      metallic = metallicRoughness.b;
      roughness = metallicRoughness.g;
    }

    let modelTexColor = textureSample(albedoTexture, texSampler, uv).rgb;
    var color = vec4f(model.baseColor, 1);
    if (${s}) {
      color = textureSample(albedoTexture, texSampler, uv);
    }

    // if (color.a < 0.01) {
    //   discard;
    // }

    var material = Material();
    material.albedo = color.rgb;
    material.roughness = roughness;
    // return vec4f(vec3f(1 - metallic), 1);
    material.metallic = metallic;
    material.ambientOcclusion = 1.0;

    let V = normalize(camera.position - in.worldPosition);

    return PBRLighting(
      material,
      0,
      in.worldPosition,
      N,
      V,
      1,
      color.a
    );
  }
`,ft="vertexMain",At=({isInstanced:s,isShadow:e}={isInstanced:!1,isShadow:!1})=>Bt`
    ${Y.VertexInput}
    ${Y.VertexOutput}
    ${Y.ModelUniform}
    ${Y.Camera}
    ${Y.InstanceInput}

    @group(${ae.CameraPlusOptionalLights}) @binding(0) var<uniform> camera: Camera;
    @group(${ae.Model}) @binding(0) var<uniform> model: ModelUniform;
    
    @group(${ae.PBRTextures}) @binding(${pe.Albedo}) var albedoTexture: texture_2d<f32>;
    @group(${ae.PBRTextures}) @binding(${pe.Normal}) var normalTexture: texture_2d<f32>;

    #if ${s}
      @group(${ae.InstanceInputs}) @binding(0) var<storage> instanceInputs: array<InstanceInput>;
    #endif

    @vertex
    fn ${ft}(
      @builtin(instance_index) instanceId: u32,
      in: VertexInput
    ) -> VertexOutput {
      var position = in.position;

      var worldMatrix: mat4x4f;

      #if ${!e}
      var prevWorldMatrix: mat4x4f;
      #endif

      #if ${s}
        worldMatrix = instanceInputs[instanceId].worldMatrix * model.worldMatrix;
        #if ${!e}
          prevWorldMatrix = instanceInputs[instanceId].worldMatrix * model.prevFrameWorldMatrix;
        #endif
      #else
        worldMatrix = model.worldMatrix;
        #if ${!e}
          prevWorldMatrix = model.prevFrameWorldMatrix;
        #endif
      #endif
      
      var out: VertexOutput;
      let worldPosition = worldMatrix * in.position;
      #if ${e}
        out.position = camera.projectionViewMatrix * worldPosition;
      #else
        out.position = camera.projectionViewMatrix * worldPosition;
        out.worldPosition = worldPosition.xyz;

        // var jitterOffset = camera.jitterOffset;
        // jitterOffset.x = ((jitterOffset.x - 0.5) / f32(camera.viewportWidth)) * 2;
        // jitterOffset.y = ((jitterOffset.y - 0.5) / f32(camera.viewportHeight)) * 2;

        out.position += vec4f(camera.jitterOffset * out.position.w, 0, 0);

        out.currFrameClipPos = out.position;
        out.prevFrameClipPos = camera.prevFrameProjectionViewMatrix * prevWorldMatrix * in.position;
        
        let viewSpaceNormMatrix = mat3x3f(
          camera.viewMatrix[0].xyz,
          camera.viewMatrix[1].xyz,
          camera.viewMatrix[2].xyz
        ) * model.normalMatrix;

        let viewTangent = normalize(viewSpaceNormMatrix * in.tangent.xyz);
        let viewNormal = normalize(viewSpaceNormMatrix * in.normal);
        let viewBitangent = normalize(cross(viewNormal, viewTangent)) * in.tangent.w;

        out.viewTangent = viewTangent;
        out.viewBitangent = viewBitangent;
        out.viewNormal = viewNormal;
        out.instanceId = instanceId;
        out.uv = in.uv;
      #endif

      return out;
    }
  `;let tn,rn,sn,oo,ao,uo,co,lo;const Jc=Object.freeze({get defaultGLTFTransparentPBRMaterial(){return lo||(lo=new ht({debugLabel:"Forward Pass Default PBR Material",vertexShaderSrc:At(),vertexShaderEntryFn:ft,vertexBuffers:xe.defaultGLTFLayout,fragmentShaderSrc:em({hasPBRTextures:!0}),fragmentShaderEntryFn:jc,targets:[{format:"rgba16float",blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}],bindGroupLayouts:[j.defaultCameraPlusLightsBindGroupLayout,j.defaultModelBindGroupLayout,j.defaultModelMaterialBindGroupLayout],depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less"},primitive:{cullMode:"none"}}),lo)},get defaultDeferredPBRMaterial(){if(tn)return tn;const s={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return tn=new ht({debugLabel:"Deferred Pass Default PBR Material",vertexShaderSrc:At(),vertexShaderEntryFn:ft,vertexBuffers:xe.defaultLayout,fragmentShaderSrc:en(),fragmentShaderEntryFn:jr,constants:{},targets:jt,depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:s,stencilFront:s}}),tn},get defaultGLTFDeferredPBRMaterial(){if(rn)return rn;const s={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return rn=new ht({debugLabel:"Deferred Pass Default PBR Material",vertexShaderSrc:At(),vertexShaderEntryFn:ft,vertexBuffers:xe.defaultGLTFLayout,fragmentShaderSrc:en(),fragmentShaderEntryFn:jr,constants:{},targets:jt,depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:s,stencilFront:s}}),rn},get defaultGLTFTexturedDeferredMaterial(){if(sn)return sn;const s={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};return sn=new ht({debugLabel:"Default Textured Deferred PBR",vertexShaderSrc:At(),vertexShaderEntryFn:ft,vertexBuffers:xe.defaultGLTFLayout,fragmentShaderSrc:en({hasPBRTextures:!0}),fragmentShaderEntryFn:jr,constants:{},targets:jt,depthStencilState:{format:Xt.depthStencilFormat,depthWriteEnabled:!0,depthCompare:"less",stencilReadMask:0,stencilWriteMask:255,stencilBack:s,stencilFront:s}}),sn},get defaultDeferredInstancedMaterial(){return oo||(oo=new ht({debugLabel:"Material",vertexShaderSrc:At({isInstanced:!0}),vertexShaderEntryFn:ft,fragmentShaderSrc:en(),fragmentShaderEntryFn:jr,bindGroupLayouts:[j.defaultCameraBindGroupLayout,j.defaultModelBindGroupLayout,j.instancesBindGroupLayout],targets:jt}),oo)},get defaultShadowMaterial(){return uo||(uo=new ht({debugLabel:"Default Shadow Material",vertexShaderSrc:At(),vertexShaderEntryFn:ft,vertexBuffers:xe.defaultLayout}),uo)},get defaultGLTFShadowMaterial(){return ao||(ao=new ht({debugLabel:"Default Shadow Material",vertexShaderSrc:At({isShadow:!0}),vertexShaderEntryFn:ft,vertexBuffers:xe.defaultGLTFLayout,primitive:{cullMode:"front"},depthStencilState:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}}),ao)},get defaultInstancedShadowMaterial(){return co||(co=new ht({debugLabel:"Default Shadow Material",vertexShaderSrc:At({isInstanced:!0}),vertexShaderEntryFn:ft,bindGroupLayouts:[j.defaultCameraBindGroupLayout,j.defaultModelBindGroupLayout,j.defaultModelMaterialBindGroupLayout,j.instancesBindGroupLayout],depthStencilState:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}}),co)}}),fn=class fn extends v{constructor(){super(),this.scene=new hp,this.cpuAverage=new hs,this.gpuAverage=new hs,this.fpsDisplayAverage=new hs,this.resizeCounter=0,this.enableAnimation=!0,this.mainCamera=new Hn(70,1,.1,100),this.mainCamera.shouldJitter=!0,this.mainCamera.setPositionAsVec3(vc),this.mainCamera.setLookAt(0,2,0),this.mainCamera.updateViewMatrix(),this.mainCameraCtrl=new Tl(this.mainCamera,document.body,v.$canvas),this.mainCameraCtrl.startTick(),this.debugCamera=new Hn(70,1,.1,100),this.debugCamera.setPosition(6,12,1),this.debugCamera.setLookAt(0,7,0),this.debugCamera.updateViewMatrix();const e=new wd(Cp,!0).getPoints(240);this.lightingManager=new ji(e),this.scene.lightingManager=this.lightingManager,this.texturesDebugContainer=new Ni,this.timingDebugContainer=new Vi,this.scene.skybox=new kp;const t=new cp(xl);this.scene.addChild(t),t.setPositionY(2).updateWorldMatrix(),Promise.all([Be.load6SeparateHDRFacesAsCubeMapTexture(Ap,512,!0,"Skybox Faces"),t.load()]).then(([r])=>{this.envDiffuseTexture=Di.encode(r),this.envSpecularTexture=Ui.encode(r,256),this.envBdrfLutTexture=Fi.encode(),Ht.generateMipsForCubeTexture(this.envDiffuseTexture),this.scene.skybox.setTexture(this.envDiffuseTexture),this.renderPassComposer.getPass(V.DirectionalAmbientLighting).setDiffuseIBLTexture(this.envDiffuseTexture).setSpecularIBLTexture(this.envSpecularTexture).setBDRFLutTexture(this.envBdrfLutTexture),W.removeTextureBytes(r),r.destroy(),t.setMaterial(Jc.defaultGLTFTexturedDeferredMaterial).setMaterial(Jc.defaultGLTFShadowMaterial,V.Shadow),setTimeout(()=>{new ss({durationMS:1500,delayMS:300,easeName:"circ_Out",onUpdate:n=>{const i=D.lerp(Ac,vp,n),o=No(0,2,n);this.sunPositionX=i[0],this.sunPositionY=i[1],this.sunPositionZ=i[2],this.sunIntensity=o},onComplete:()=>{new ss({durationMS:500,delayMS:0,easeName:"circ_In",onUpdate:n=>{this.lightingManager.fireParticlesRevealFactor=n}}).start()}}).start(),new ss({durationMS:1e3,easeName:"sine_Out",onUpdate:n=>{this.mainCamera.setPositionAsVec3(D.lerp(vc,wp,n)).updateViewMatrix()},onComplete:()=>{document.getElementById("logo").classList.toggle("faded")}}).start(),this.renderPassComposer.getPass(V.Blit).revealWithAnimation(800)},500)})}set sunPositionX(e){this.lightingManager.sunPositionX=e}set sunPositionY(e){this.lightingManager.sunPositionY=e}set sunPositionZ(e){this.lightingManager.sunPositionZ=e}set sunIntensity(e){this.lightingManager.sunIntensity=e}set ssaoEnabled(e){this.renderPassComposer.getPass(V.DirectionalAmbientLighting).ssaoMixFactor=e?1:0}set ssaoKernelSize(e){this.renderPassComposer.getPass(V.SSAO).kernelSize=e}set ssaoRadius(e){this.renderPassComposer.getPass(V.SSAO).radius=e}set ssaoStrength(e){this.renderPassComposer.getPass(V.SSAO).strength=e}set enableTAA(e){this.mainCamera.shouldJitter=e;const t=this.renderPassComposer.getPass(V.TAAResolve),r=this.renderPassComposer.getPass(V.BloomDownsample),n=this.renderPassComposer.getPass(V.Blit);t.enabled=e,e&&t.resetHistory(),r.resetInputs().addInputTexture(e?Ur:kr),n.resetInputs().addInputTextures([Nr,e?Ur:kr])}set debugGBuffer(e){e?(this.texturesDebugContainer.scrollIntoGbufferSection(),this.texturesDebugContainer.reveal()):this.texturesDebugContainer.hide()}set debugShadowMap(e){e?(this.texturesDebugContainer.scrollToShadowSection(),this.texturesDebugContainer.reveal()):this.texturesDebugContainer.hide()}set shadowMapSize(e){const t=this.renderPassComposer.getPass(V.Shadow);this.renderPassComposer.getPass(V.DirectionalAmbientLighting).resetInputs().addInputTextures([tt,xt,ve,mr,Dr]),t.shadowMapSize=e}set debugShadowCascadeIndex(e){this.renderPassComposer.getPass(V.DirectionalAmbientLighting).debugShadowCascadeLayer=e}set debugLightsMask(e){this.renderPassComposer.getPass(V.PointLightsLighting).debugLightsMask=e}set render2ndFloorPoints(e){this.lightingManager.render2ndFloorParticles=e}set ssrIsHiZ(e){this.renderPassComposer.getPass(V.Reflection).isHiZ=e,this.renderPassComposer.getPass(V.HiZ).enabled=e}set ssrMaxIterations(e){this.renderPassComposer.getPass(V.Reflection).maxIterations=e}set debugMissedSSR(e){this.renderPassComposer.getPass(V.Reflection).debugMissedIntersections=e}set ssrEnabled(e){this.renderPassComposer.getPass(V.Reflection).enabled=e,this.renderPassComposer.getPass(V.TAAResolve).clearInputTextures().addInputTextures([e?kr:Ke,Xs])}set bloomEnabled(e){this.renderPassComposer.getPass(V.BloomDownsample).enabled=e,this.renderPassComposer.getPass(V.BloomUpsample).enabled=e,this.renderPassComposer.getPass(V.Blit).bloomEnabled=e}set bloomFilterRadius(e){this.renderPassComposer.getPass(V.BloomUpsample).bloomFilterRadius=e}set debugBoundingBoxes(e){this.renderPassComposer.getPass(V.DebugBounds).enabled=e}set debugMovementCurve(e){this.curveMoveLine.visible=e}toggleStatsVisibility(){this.timingDebugContainer.toggleVisibility()}recreateRenderComposer(e,t){var h;(h=this.renderPassComposer)==null||h.destroy(),this.renderPassComposer=new vd,this.renderPassComposer.setScene(this.scene);const r=new Qs(this.lightingManager.mainDirLight,e,t).addOutputTexture(Dr).setCamera(this.mainCamera),n=new Jp(e,t).setCamera(this.mainCamera).addOutputTextures([tt,xt,Xs,ve]),i=new no(e,t).setCamera(this.mainCamera).addInputTextures([tt,ve]).addOutputTexture(Bc),o=new Yp(e,t).addInputTexture(Bc).addOutputTexture(mr),c=new Qi(r.shadowCascadesBuffer,e,t).setCamera(this.mainCamera).addInputTextures([tt,xt,ve,mr,Dr]).addOutputTexture(Ke);this.envDiffuseTexture&&c.setDiffuseIBLTexture(this.envDiffuseTexture),this.envSpecularTexture&&c.setSpecularIBLTexture(this.envSpecularTexture),this.envBdrfLutTexture&&c.setBDRFLutTexture(this.envBdrfLutTexture);const d=new to(e,t).setCamera(this.mainCamera).addInputTextures([tt,xt,ve,mr,Ke]).addOutputTexture(Ke),g=new Xp(e,t).setCamera(this.mainCamera).addInputTextures([ve]).addOutputTexture(ve).setLightsBuffer(this.lightingManager.gpuBuffer).updateLightsMaskBindGroup(),b=new ro(e,t).setCamera(this.mainCamera).addInputTextures([tt,xt,ve,mr,Ke]).addOutputTexture(Ke),l=new Zp(e,t).setCamera(this.mainCamera).addInputTextures([Ke,ve]).addOutputTextures([Ke,ve]),x=new Qp(e,t).setCamera(this.mainCamera).addInputTextures([Ke,ve]).addOutputTextures([Ke,ve]),m=new $i(e,t).addInputTexture(ve).addOutputTexture(Ws),_=new Zi(e,t).addInputTexture(Ws).addOutputTexture(Ws),w=new so(e,t).setCamera(this.mainCamera).addInputTextures([Ke,tt,xt,Ws]).addOutputTexture(kr),f=new io(e,t).addInputTextures([kr,Xs]).addOutputTexture(Ur),p=new Yi(e,t).addInputTexture(Ur).addOutputTexture(Nr),a=new jp(e,t).addInputTexture(Nr).addOutputTexture(Nr),u=new Wi(e,t,this.resizeCounter>0).addInputTextures([Nr,Ur]);this.renderPassComposer.addPass(r).addPass(n).addPass(i).addPass(o).addPass(c).addPass(d).addPass(g).addPass(b).addPass(l).addPass(x).addPass(m).addPass(_).addPass(w).addPass(f).addPass(p).addPass(a).addPass(u)}resize(e,t){this.debugCamera.onResize(e,t),this.mainCamera.onResize(e,t),this.recreateRenderComposer(e,t),this.resizeCounter++}async renderFrame(e){const t=.001*(e-v.elapsedTimeMs),r=t-v.prevTimeMs;v.prevTimeMs=t,v.elapsedTimeMs+=this.enableAnimation?r:0,v.deltaTimeMs=this.enableAnimation?Math.min(r,.5):0;const n=performance.now();this.debugCamera.onFrameStart(),this.mainCamera.onFrameStart();const i=v.device.createCommandEncoder({label:"Frame Command Encoder"});this.lightingManager.update(i),this.renderPassComposer.render(i),this.texturesDebugContainer.setTextureGBufferSection(q.Albedo,this.renderPassComposer.getTexture(xt)).setTextureGBufferSection(q.Normal,this.renderPassComposer.getTexture(tt)).setTextureGBufferSection(q.Metallic,this.renderPassComposer.getTexture(tt)).setTextureGBufferSection(q.Roughness,this.renderPassComposer.getTexture(tt)).setTextureGBufferSection(q.AO,this.renderPassComposer.getTexture(mr)).setTextureGBufferSection(q.Reflectance,this.renderPassComposer.getTexture(xt)).setTextureGBufferSection(q.Depth,this.renderPassComposer.getTexture(ve)).setTextureGBufferSection(q.Velocity,this.renderPassComposer.getTexture(Xs)).setTextureShadowSection(q.ShadowDepthCascade0,this.renderPassComposer.getTexture(Dr)).setTextureShadowSection(q.ShadowDepthCascade1,this.renderPassComposer.getTexture(Dr)).render(i),v.device.queue.submit([i.finish()]),this.renderPassComposer.onFrameEnd(),this.mainCamera.onFrameEnd(),this.debugCamera.onFrameEnd();const o=performance.now()-n;if(v.supportsGPUTimestampQuery){const[b,l]=await Promise.all([this.renderPassComposer.getPass(V.Shadow).getTimingResult(),this.renderPassComposer.getPass(V.Blit).getTimingResult()]),x=b.timings,m=(l.timings[1]-x[0])/1e6;this.gpuAverage.addSample(m)}this.cpuAverage.addSample(o),this.fpsDisplayAverage.addSample(1/r);const c=this.cpuAverage.get(),d=this.fpsDisplayAverage.get(),g=this.gpuAverage.get();this.timingDebugContainer.setDisplayValue(se.CPUTotal,c!==0?`${c.toFixed(1)}ms`:"N/A").setDisplayValue(se.GPUTotal,g>0?`${g.toFixed(1)}ms`:"N/A").setDisplayValue(se.FPS,d!==0?`${d.toFixed(1)}ms`:"N/A").setDisplayValue(se.VRAM,W.getFormattedSize()).setDisplayValue(se.VisibleMeshes,`${this.scene.visibleNodesCount} / ${this.scene.nodesCount}`).setDisplayValue(se.LightsCount,this.lightingManager.lightsCount.toString()),v.frameIndex++}};fn.initialize=async e=>{if(!navigator.gpu)return;const t=await navigator.gpu.requestAdapter();v.$canvas=e,v.canvasContext=e.getContext("webgpu"),v.pixelFormat=navigator.gpu.getPreferredCanvasFormat();const r=[],n=t.features.has("timestamp-query");return n&&r.push("timestamp-query"),v.device=await t.requestDevice({requiredFeatures:r}),v.supportsGPUTimestampQuery=n,v.canvasContext.configure({device:v.device,format:v.pixelFormat,usage:GPUTextureUsage.RENDER_ATTACHMENT}),new fn};let Xt=fn;const Wt=document.getElementById("c"),ue=await Xt.initialize(Wt);ue===void 0&&document.getElementById("no-webgpu-wrapper").style.setProperty("display","block");const oe={"Play Animation":!0,"Performance Stats":!1,"Enable TAA":!0,"Debug G-Buffer":!1,"Debug Shadow Map":!1,"Debug Shadow Cascades":!1,"Shadow Map Size":2048,"Debug Point Lights Mask":!1,"Render 2nd Floor Points":!0,"Enable SSR":!0,"SSR Method":"hi-z","SSR Max Iterations":30,"Debug No Info Rays":!1,"Sun Intensity":2,"Sun Position X":.1,"Sun Position Y":100,"Sun Position Z":.1,"Debug Skybox":!0,"Enable Bloom":!0,"Bloom Filter Radius":.0035,"Enable SSAO":!0,"SSAO Kernel Size":8,"SSAO Radius":.2,"SSAO Strength":3},nt=new fl({width:270});nt.close(),nt.add(oe,"Play Animation").onChange(s=>{ue.enableAnimation=s}),nt.add(oe,"Performance Stats").onChange(()=>{ue.toggleStatsVisibility()}),nt.add(oe,"Debug G-Buffer").onChange(s=>{ue.debugGBuffer=s,Wc(),s&&oe["Debug Shadow Map"]&&(oe["Debug Shadow Map"]=!1)}).listen();const br=nt.addFolder("Lighting");br.open(),br.add(oe,"Sun Intensity",0,100).onChange(s=>{ue.sunIntensity=s}),br.add(oe,"Sun Position X",-60,60,.5).onChange(s=>{ue.sunPositionZ=s}),br.add(oe,"Sun Position Z",-150,150,.5).onChange(s=>{ue.sunPositionX=s});const nn=nt.addFolder("Shadow");nn.open(),nn.add(oe,"Debug Shadow Map").onChange(s=>{ue.debugShadowMap=s,Wc(),s&&oe["Debug G-Buffer"]&&(oe["Debug G-Buffer"]=!1)}).listen(),nn.add(oe,"Shadow Map Size",[512,1024,2048,4096]).onChange(s=>{ue.shadowMapSize=parseInt(s)}),nn.add(oe,"Debug Shadow Cascades").onChange(s=>{ue.debugShadowCascadeIndex=s});let zc=oe["Enable Bloom"];br.add(oe,"Debug Point Lights Mask").onChange(s=>{s?(zc=oe["Enable Bloom"],oe["Enable Bloom"]=!1,ue.bloomEnabled=!1):zc&&(oe["Enable Bloom"]=!0,ue.bloomEnabled=!0),ue.debugLightsMask=s}),br.add(oe,"Render 2nd Floor Points").onChange(s=>{ue.render2ndFloorPoints=s});const Jr=nt.addFolder("Screen space Ambient Occlusion");Jr.open(),Jr.add(oe,"Enable SSAO").onChange(s=>{ue.ssaoEnabled=s}),Jr.add(oe,"SSAO Kernel Size",8,128,1).onChange(s=>{ue.ssaoKernelSize=s}),Jr.add(oe,"SSAO Radius",0,1).onChange(s=>{ue.ssaoRadius=s}),Jr.add(oe,"SSAO Strength",0,5).onChange(s=>{ue.ssaoStrength=s});const zr=nt.addFolder("Screen space Reflections");zr.open(),zr.add(oe,"Enable SSR").onChange(s=>{ue.ssrEnabled=s}),zr.add(oe,"SSR Method",["hi-z","linear"]).onChange(s=>{ue.ssrIsHiZ=s==="hi-z"}),zr.add(oe,"SSR Max Iterations",0,1500,1).onChange(s=>{ue.ssrMaxIterations=s}),zr.add(oe,"Debug No Info Rays").onChange(s=>{ue.debugMissedSSR=s});const ho=nt.addFolder("Bloom");ho.open(),ho.add(oe,"Enable Bloom").onChange(s=>{ue.bloomEnabled=s}).listen(),ho.add(oe,"Bloom Filter Radius",.001,.005,5e-4).onChange(s=>{ue.bloomFilterRadius=s});const Kc=nt.addFolder("Anti-Aliasing");function Xc(){const s=Math.min(innerWidth,1920),e=Math.min(innerHeight,1080);Wt.width=s,Wt.height=e,Wt.style.setProperty("left",.5*innerWidth-.5*s+"px"),Wt.style.setProperty("top",.5*innerHeight-.5*e+"px"),Wt.style.setProperty("width",`${s}px`),Wt.style.setProperty("height",`${e}px`),ue.resize(s,e)}function Wc(){document.getElementById("logo").classList.toggle("faded"),document.getElementById("timings-debug-container").classList.toggle("faded")}Kc.open(),Kc.add(oe,"Enable TAA").onChange(s=>{ue.enableTAA=s}),requestAnimationFrame(function s(){const e=performance.now();ue.renderFrame(e),requestAnimationFrame(s)}),window.addEventListener("resize",Xc),Xc()})();
